<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>樣品庫存管理系統</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- QR Code & Zipping Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="text/javascript" src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Modal Transitions */
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.6);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content-hidden {
            transform: scale(0.95) translateY(10px);
            opacity: 0;
        }
        .modal-content-visible {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Drawer Transitions */
        .drawer-backdrop {
            transition: opacity 0.3s ease;
        }
        .drawer-panel {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .drawer-hidden {
            pointer-events: none;
        }
        .drawer-hidden .drawer-backdrop {
            opacity: 0;
        }
        .drawer-hidden .drawer-panel {
            transform: translateX(100%);
        }
        .drawer-visible {
            pointer-events: auto;
        }
        .drawer-visible .drawer-backdrop {
            opacity: 1;
        }
        .drawer-visible .drawer-panel {
            transform: translateX(0);
        }

        /* Grid & List Styles */
        .slot-card {
            transition: all 0.2s ease;
        }
        .slot-occupied:hover {
            border-color: #6366f1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .slot-occupied.selected {
            border-color: #6366f1;
            background-color: #e0e7ff;
        }
        
        .table-row-hover:hover {
            background-color: #f1f5f9;
        }
        
        /* Tooltip */
        .custom-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            z-index: 50;
        }
        .has-tooltip:hover .custom-tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Custom Scan Overlay Animation */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ef4444;
            box-shadow: 0 0 4px #ef4444;
            top: 0;
            left: 0;
            animation: scan 2s infinite linear;
        }
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        /* Selection Action Bar Animation */
        .selection-bar-hidden {
            transform: translateY(100%);
        }
        .selection-bar-visible {
            transform: translateY(0);
        }
    </style>
</head>
<body class="text-slate-800 h-screen w-screen flex flex-col md:flex-row">

    <!-- Sidebar (Desktop) -->
    <aside class="hidden md:flex flex-col w-64 bg-slate-900 text-white border-r border-slate-800 z-20 shadow-xl">
        <div class="p-6 flex items-center gap-3 border-b border-slate-800">
            <div class="bg-indigo-500 p-2 rounded-lg">
                <i class="ph ph-cube text-xl text-white"></i>
            </div>
            <h1 class="text-lg font-bold tracking-wide">庫存管理系統</h1>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <button id="nav-inventory" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-indigo-600 text-white shadow-md transition-colors">
                <i class="ph ph-squares-four text-xl"></i>
                <span class="font-medium">庫存總覽</span>
            </button>
            <button id="nav-report" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
                <i class="ph ph-chart-bar text-xl"></i>
                <span class="font-medium">庫存報表</span>
            </button>
            <button id="nav-history" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
                <i class="ph ph-clock-counter-clockwise text-xl"></i>
                <span class="font-medium">歷史紀錄</span>
            </button>
            <button id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
                <i class="ph ph-gear text-xl"></i>
                <span class="font-medium">系統設定</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 px-4 py-2">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300" id="user-avatar">
                    U
                </div>
                <div>
                    <p class="text-sm font-medium text-white" id="current-user-display">使用者</p>
                    <p class="text-xs text-slate-500">已連線</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <!-- Top Bar -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-6 shadow-sm z-10 shrink-0 gap-2">
            <!-- Left: Mobile Logo / Desktop Title context -->
            <div class="flex items-center gap-2 md:gap-4 flex-1">
                <div class="md:hidden bg-indigo-600 p-1.5 rounded text-white shrink-0">
                    <i class="ph ph-cube text-lg"></i>
                </div>
                
                <div class="relative w-full max-w-[200px]">
                    <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                        <i class="ph ph-user text-slate-500"></i>
                    </div>
                    <select id="globalOperatorSelect" class="bg-indigo-50 border border-indigo-200 text-indigo-900 text-sm font-bold rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-8 p-2.5 shadow-sm cursor-pointer">
                        <option value="">請選擇操作人員...</option>
                    </select>
                </div>

                <div class="relative group w-full max-w-xs hidden md:block">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="ph ph-magnifying-glass text-slate-400"></i>
                    </div>
                    <input type="text" id="globalSearchInput" 
                        class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg leading-5 bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition duration-150 ease-in-out sm:text-sm" 
                        placeholder="搜尋...">
                </div>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-2 md:gap-3 shrink-0">
                <button class="md:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-lg" onclick="document.getElementById('mobileSearchPanel').classList.toggle('hidden')">
                    <i class="ph ph-magnifying-glass text-xl"></i>
                </button>

                <div class="bg-slate-100 rounded-lg p-1 flex items-center border border-slate-200 hidden sm:flex">
                    <button id="view-list-btn" class="p-1.5 rounded-md text-slate-600 hover:text-indigo-600 hover:bg-white shadow-sm transition-all active-view-btn bg-white text-indigo-600" title="清單模式">
                        <i class="ph ph-list-dashes text-lg"></i>
                    </button>
                    <button id="view-grid-btn" class="p-1.5 rounded-md text-slate-500 hover:text-indigo-600 hover:bg-white transition-all" title="圖形模式">
                        <i class="ph ph-squares-four text-lg"></i>
                    </button>
                </div>

                <div class="h-6 w-px bg-slate-200 mx-1 hidden sm:block"></div>

                <button id="topScanBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg shadow-sm transition-colors flex items-center gap-2">
                    <i class="ph ph-qr-code text-lg"></i>
                    <span class="hidden md:inline font-medium text-sm">掃描</span>
                </button>

                <button id="topAddBtn" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 p-2 rounded-lg shadow-sm transition-colors flex items-center gap-2">
                    <i class="ph ph-plus text-lg"></i>
                    <span class="hidden md:inline font-medium text-sm">新增</span>
                </button>

                <button id="cartDrawerBtn" class="relative p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                    <i class="ph ph-shopping-cart text-xl"></i>
                    <span id="cart-badge" class="absolute top-1 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white opacity-0 transition-opacity">0</span>
                </button>
            </div>
        </header>

        <!-- Mobile Search Panel -->
        <div id="mobileSearchPanel" class="hidden md:hidden bg-white p-4 border-b border-slate-200 absolute top-16 left-0 right-0 z-10 shadow-md">
            <input type="text" id="mobileSearchInput" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="搜尋樣品...">
        </div>

        <!-- Main Workspace -->
        <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 no-scrollbar" id="main-scroll-area">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">庫存總覽</h2>
                    <p class="text-slate-500 text-sm mt-1">管理與追蹤您的所有樣品</p>
                </div>
                
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <select id="cabinetFilter" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-48 p-2.5">
                        <option value="all">所有櫃位</option>
                    </select>
                </div>
            </div>

            <!-- Loader -->
            <div id="loader" class="flex flex-col items-center justify-center py-20 text-slate-500">
                <i class="ph ph-spinner animate-spin text-4xl text-indigo-600 mb-3"></i>
                <p>正在同步資料庫...</p>
            </div>

            <!-- Content Area -->
            <div id="content-area" class="hidden pb-20"> <!-- Added padding-bottom for selection bar -->
                <!-- List View Container -->
                <div id="view-list" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-600">
                            <thead class="bg-slate-50 text-slate-700 uppercase font-semibold border-b border-slate-200">
                                <tr>
                                    <th class="w-10 px-4 py-4 text-center">
                                        <input type="checkbox" id="selectAllInventory" class="rounded text-indigo-600 focus:ring-indigo-500 w-4 h-4 cursor-pointer">
                                    </th>
                                    <th class="px-6 py-4">樣品名稱</th>
                                    <th class="px-6 py-4">位置</th>
                                    <th class="px-6 py-4">線徑</th>
                                    <th class="px-6 py-4 hidden sm:table-cell">標準</th>
                                    <th class="px-6 py-4 hidden md:table-cell">製造商</th>
                                    <th class="px-6 py-4 hidden lg:table-cell">批號/配方</th>
                                    <th class="px-6 py-4 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y divide-slate-100">
                                <!-- Rows injected by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="list-empty-state" class="hidden p-10 text-center text-slate-500">
                        <i class="ph ph-magnifying-glass text-4xl mb-2 text-slate-300"></i>
                        <p>沒有符合條件的樣品</p>
                    </div>
                </div>

                <!-- Grid View Container -->
                <div id="view-grid" class="hidden space-y-8">
                    <!-- Grid content injected by JS -->
                </div>
            </div>

            <div class="h-20 md:hidden"></div>
        </main>

        <!-- Inventory Selection Action Bar (Floating at bottom) -->
        <div id="inventory-selection-bar" class="fixed bottom-16 md:bottom-0 left-0 md:left-64 right-0 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20 flex justify-between items-center p-4 selection-bar-hidden transition-transform duration-300 ease-in-out">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold">
                    已選取 <span id="inventory-selected-count">0</span> 項
                </div>
                <button id="inventory-clear-selection" class="text-sm text-slate-500 hover:text-slate-800 hover:underline">
                    取消全選
                </button>
            </div>
            <div class="flex items-center gap-2">
                <select id="inventoryBatchLabelSize" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2">
                    <option value="40x40">40x40mm (方形)</option>
                    <option value="80x50">80x50mm (矩形)</option>
                </select>
                <button id="inventory-batch-download-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm flex items-center gap-2 transition">
                    <i class="ph ph-download-simple text-lg"></i>
                    <span class="hidden sm:inline">下載 QR</span>
                </button>
            </div>
        </div>

        <!-- Bottom Navigation (Mobile Only) -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-30 pb-safe">
            <button class="flex flex-col items-center justify-center w-full h-full text-indigo-600">
                <i class="ph ph-squares-four text-2xl"></i>
                <span class="text-[10px] font-medium mt-1">庫存</span>
            </button>
            <button id="mobile-nav-report" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <i class="ph ph-chart-bar text-2xl"></i>
                <span class="text-[10px] font-medium mt-1">報表</span>
            </button>
            <button id="mobile-nav-add" class="flex flex-col items-center justify-center w-full h-full -mt-6">
                <div class="bg-indigo-600 rounded-full p-4 shadow-lg text-white transform hover:scale-105 transition">
                    <i class="ph ph-plus text-2xl"></i>
                </div>
            </button>
            <button id="mobile-nav-history" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <i class="ph ph-clock-counter-clockwise text-2xl"></i>
                <span class="text-[10px] font-medium mt-1">歷史</span>
            </button>
            <button id="mobile-nav-settings" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <i class="ph ph-gear text-2xl"></i>
                <span class="text-[10px] font-medium mt-1">設定</span>
            </button>
        </nav>
    </div>

    <!-- Drawer (Staging Area) -->
    <div id="stagingDrawer" class="fixed inset-0 z-40 drawer-hidden flex justify-end">
        <div class="drawer-backdrop absolute inset-0 bg-slate-900/50 backdrop-blur-sm" id="drawerBackdrop"></div>
        <div class="drawer-panel relative bg-white w-full max-w-md h-full shadow-2xl flex flex-col">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center bg-indigo-50">
                <div class="flex items-center gap-2">
                    <i class="ph ph-shopping-cart text-indigo-600 text-xl"></i>
                    <h3 class="font-bold text-lg text-slate-800">暫存區 (Staging)</h3>
                </div>
                <button id="closeDrawerBtn" class="text-slate-500 hover:text-slate-800 p-1 rounded-full hover:bg-indigo-100 transition">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50" id="staging-drawer-content">
                <div id="drawer-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                    <div class="bg-slate-100 p-4 rounded-full mb-3">
                        <i class="ph ph-basket text-4xl text-slate-300"></i>
                    </div>
                    <p>暫存區是空的</p>
                    <p class="text-xs mt-1 text-slate-400">從庫存中將樣品移入此處進行操作</p>
                </div>
                <div id="staging-list" class="space-y-3"></div>
            </div>
            <div id="drawer-footer" class="p-4 border-t border-slate-200 bg-white hidden">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm text-slate-500">已選取 <span id="staging-selected-count" class="font-bold text-slate-800">0</span> 項</span>
                    <button id="staging-select-all" class="text-xs text-indigo-600 font-medium hover:underline">全選</button>
                </div>
                
                <!-- Batch Action Grid -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button id="batch-return-btn" class="flex flex-col items-center justify-center py-2 px-1 rounded-lg bg-emerald-100 text-emerald-700 font-semibold hover:bg-emerald-200 transition text-[10px] md:text-xs">
                        <i class="ph ph-arrow-u-up-left text-lg mb-0.5"></i> 批次放回
                    </button>
                    <button id="batch-archive-btn" class="flex flex-col items-center justify-center py-2 px-1 rounded-lg bg-red-100 text-red-700 font-semibold hover:bg-red-200 transition text-[10px] md:text-xs">
                        <i class="ph ph-archive-box text-lg mb-0.5"></i> 批次歸檔
                    </button>
                </div>
                
                <!-- Batch Download QR Section -->
                <div class="flex gap-2">
                    <select id="stagingBatchLabelSize" class="bg-slate-50 border border-slate-300 text-slate-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2 flex-1">
                        <option value="40x40">40x40mm (方形)</option>
                        <option value="80x50">80x50mm (矩形)</option>
                    </select>
                    <button id="batch-qr-btn" class="flex-1 flex items-center justify-center gap-1 py-2 px-2 rounded-lg bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition text-xs border border-slate-200">
                        <i class="ph ph-download-simple text-lg"></i> 批次 QR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Modals -->
    
    <!-- 1. Add Sample Modal -->
    <div id="addSampleModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 modal-content modal-content-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-5 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800">新增樣品</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600"><i class="ph ph-x text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="add-sample-form" class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">樣品名稱 <span class="text-red-500">*</span></label>
                            <div class="flex gap-2">
                                <input type="text" id="sampleName" required class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="輸入或掃描">
                                <button type="button" id="scanInputQrBtn" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 transition">
                                    <i class="ph ph-qr-code text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">線徑 <span class="text-red-500">*</span></label>
                            <input type="text" id="wireDiameter" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">適用標準</label>
                            <input type="text" id="applicableStandard" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">存放位置</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <select id="storageCabinet" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"></select>
                            <select id="storageShelf" required disabled class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-100"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                        <div><label class="block mb-1 text-slate-500">製造商</label><input type="text" id="manufacturer" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div>
                        <div><label class="block mb-1 text-slate-500">配方代號</label><input type="text" id="formulaCode" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div>
                        <div><label class="block mb-1 text-slate-500">批號</label><input type="text" id="batchNo" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div>
                        <div><label class="block mb-1 text-slate-500">爐號</label><input type="text" id="furnaceNo" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div>
                        <div class="md:col-span-2"><label class="block mb-1 text-slate-500">製程明細</label><input type="text" id="processDetails" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div>
                    </div>
                    <div class="flex justify-end pt-2">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2.5 rounded-lg shadow-lg hover:bg-indigo-700 transition transform active:scale-95">確認存入</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-4 modal-content modal-content-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 id="qrScannerTitle" class="text-lg font-bold">掃描 QR Code</h3>
                <button class="close-scanner-btn text-slate-500"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div id="qr-reader" class="rounded-lg overflow-hidden w-full aspect-square bg-black flex items-center justify-center relative">
                 <div class="text-white text-sm z-10 absolute">相機啟動中...</div>
                 <div class="absolute inset-0 z-20 pointer-events-none flex items-center justify-center">
                    <div class="w-2/3 h-2/3 border-2 border-white/40 rounded-xl relative shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]">
                        <div class="absolute top-0 left-0 w-8 h-8 border-l-4 border-t-4 border-indigo-500 -mt-1 -ml-1 rounded-tl-sm"></div>
                        <div class="absolute top-0 right-0 w-8 h-8 border-r-4 border-t-4 border-indigo-500 -mt-1 -mr-1 rounded-tr-sm"></div>
                        <div class="absolute bottom-0 left-0 w-8 h-8 border-l-4 border-b-4 border-indigo-500 -mb-1 -ml-1 rounded-bl-sm"></div>
                        <div class="absolute bottom-0 right-0 w-8 h-8 border-r-4 border-b-4 border-indigo-500 -mb-1 -mr-1 rounded-br-sm"></div>
                        <div class="scan-line"></div>
                    </div>
                 </div>
            </div>
            <div class="text-center text-sm text-slate-500 mt-4 shrink-0">
                將 40x40mm 標籤置於框內
            </div>
        </div>
    </div>
    
    <!-- QR Display Modal -->
    <div id="qrDisplayModal" class="fixed inset-0 z-[70] flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6 modal-content modal-content-hidden flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">標籤預覽</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600"><i class="ph ph-x text-2xl"></i></button>
            </div>
            
            <div class="w-full mb-4">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">標籤規格</label>
                <select id="qrLabelSize" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50">
                    <option value="40x40">40x40mm (方形)</option>
                    <option value="80x50">80x50mm (矩形)</option>
                </select>
            </div>

            <div id="qrDisplayArea" class="mb-4 p-2 bg-slate-100 border border-slate-200 rounded-xl flex items-center justify-center overflow-hidden w-full h-64">
                <!-- Image injected here -->
            </div>
            
            <div class="w-full">
                <a id="qrDownloadLink" class="flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition cursor-pointer w-full shadow-lg">
                    <i class="ph ph-download-simple text-lg"></i> 下載圖片
                </a>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="notification-toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 md:bottom-10 md:left-auto md:right-10 md:translate-x-0 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl z-[70] transition-all duration-300 opacity-0 translate-y-10 flex items-center gap-3">
        <i class="ph ph-info text-indigo-400 text-lg"></i>
        <span id="notification-message" class="font-medium">Notification</span>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl mx-4 h-[80vh] flex flex-col modal-content modal-content-hidden">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">庫存報表</h3>
                <button class="close-modal-btn text-slate-500 hover:text-slate-700 p-2 rounded-full hover:bg-slate-100 transition">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>
            <div id="reportContent" class="flex-1 overflow-auto p-4"></div>
            <div class="p-4 border-t bg-slate-50 flex justify-end gap-2">
                <button id="downloadCsvBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">CSV</button>
                <button id="printReportBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">列印報表</button>
            </div>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl mx-4 h-[80vh] flex flex-col modal-content modal-content-hidden"><div class="p-4 border-b flex justify-between"><h3 class="font-bold">歷史紀錄</h3><button class="close-modal-btn"><i class="ph ph-x text-xl"></i></button></div><div class="p-4 flex gap-2 border-b overflow-x-auto" id="history-tabs-container"><!-- tabs --></div><div id="history-content-container" class="flex-1 overflow-auto p-4"></div></div></div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl mx-4 h-[80vh] flex flex-col modal-content modal-content-hidden">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">系統設定</h3>
                <button class="close-modal-btn text-slate-500 hover:text-slate-700"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-6 bg-slate-50">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <i class="ph ph-users text-indigo-500"></i> 人員管理
                    </h4>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="newPersonName" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="輸入人員姓名">
                        <button id="addPersonBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition font-medium">新增人員</button>
                    </div>
                    <div id="personList" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                        <i class="ph ph-lockers text-indigo-500"></i> 櫃位配置
                    </h4>
                    <div class="flex gap-2 mb-6 p-4 bg-slate-50 rounded-lg border border-slate-100">
                        <input type="text" id="newCabinetName" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="輸入新櫃子名稱 (例如: A櫃)">
                        <button id="addCabinetBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-emerald-700 transition font-medium">新增櫃子</button>
                    </div>
                    <div id="cabinetSettings" class="space-y-4"></div>
                </div>
            </div>
            <div class="p-4 border-t bg-white flex justify-end gap-3">
                <button id="closeSettingsBtn" class="px-5 py-2.5 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 transition font-medium">取消</button>
                <button id="saveSettingsBtn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition font-medium">儲存設定</button>
            </div>
        </div>
    </div>
    
    <!-- Action Modal -->
    <div id="actionModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-xl shadow-lg w-96 p-6 modal-content modal-content-hidden"><h3 id="actionModalTitle" class="font-bold text-lg mb-2">Title</h3><p id="actionModalMessage" class="text-slate-600 mb-4">Message</p><form id="actionForm"><input type="hidden" id="actionSampleId"><input type="hidden" id="actionType"><div id="remarksContainer" class="hidden mb-4"><label class="block text-xs text-slate-500 mb-1">備註</label><textarea id="actionRemarks" class="w-full border rounded p-2"></textarea></div><div class="flex justify-end gap-2"><button type="button" class="close-modal-btn px-4 py-2 bg-slate-100 rounded text-slate-600">取消</button><button type="submit" id="actionConfirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">確認</button></div></form></div></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-xl shadow-lg w-80 p-6 modal-content modal-content-hidden"><h3 id="confirmationTitle" class="font-bold text-lg mb-2">確認</h3><p id="confirmationMessage" class="text-slate-600 mb-4">Content</p><div class="flex justify-end gap-2"><button id="confirmCancelBtn" class="px-4 py-2 bg-slate-100 rounded">取消</button><button id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white rounded">確認</button></div></div></div>

    <!-- Detail Modal -->
    <div id="sampleDetailModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl mx-4 modal-content modal-content-hidden flex flex-col max-h-[90vh]"><div class="p-4 border-b flex justify-between"><h3 class="font-bold">詳細資訊</h3><button class="close-modal-btn"><i class="ph ph-x text-xl"></i></button></div><div id="sampleDetailContent" class="flex-1 overflow-auto p-6"></div><div id="sampleDetailFooter" class="p-4 border-t bg-slate-50 flex justify-end gap-2"></div></div></div>

    <!-- Edit Sample Modal -->
    <div id="editSampleModal" class="fixed inset-0 z-[55] flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 modal-content modal-content-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between"><h3 class="font-bold">修改樣品</h3><button class="close-modal-btn"><i class="ph ph-x text-xl"></i></button></div>
            <div class="flex-1 overflow-auto p-6">
                <form id="edit-sample-form" class="space-y-4">
                    <input type="hidden" id="editSampleId"><input type="hidden" id="editSampleCollection">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm">名稱</label><input type="text" id="editSampleName" class="w-full border rounded p-2"></div>
                        <div><label class="block text-sm">線徑</label><input type="text" id="editWireDiameter" class="w-full border rounded p-2"></div>
                    </div>
                    <div class="p-4 bg-amber-50 rounded-lg border border-amber-100">
                        <label class="block text-xs font-bold text-amber-700 uppercase tracking-wider mb-2">更改位置 (慎選)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <select id="editStorageCabinet" class="w-full px-3 py-2 border border-amber-200 rounded-lg text-sm bg-white"></select>
                            <select id="editStorageShelf" disabled class="w-full px-3 py-2 border border-amber-200 rounded-lg text-sm bg-slate-100"></select>
                        </div>
                    </div>
                    <div class="p-3 bg-slate-50 rounded text-sm grid grid-cols-2 gap-3">
                         <input type="text" id="editApplicableStandard" placeholder="標準" class="border rounded p-2">
                         <input type="text" id="editManufacturer" placeholder="製造商" class="border rounded p-2">
                         <input type="text" id="editFormulaCode" placeholder="配方" class="border rounded p-2">
                         <input type="text" id="editProcessDetails" placeholder="製程" class="border rounded p-2">
                         <input type="text" id="editFurnaceNo" placeholder="爐號" class="border rounded p-2">
                         <input type="text" id="editBatchNo" placeholder="批號" class="border rounded p-2">
                    </div>
                    <div class="flex justify-end pt-2"><button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded">儲存</button></div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, serverTimestamp, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDLS5yzP9yMeyhGJMePFCCUwpKpob6S84",
            authDomain: "rdspools-6dc53.firebaseapp.com",
            projectId: "rdspools-6dc53",
            storageBucket: "rdspools-6dc53.appspot.com",
            messagingSenderId: "1052447565403",
            appId: "1:1052447565403:web:23498fc330636ecb38817e",
            measurementId: "G-6DYX4YRN7D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Variables
        let currentViewMode = 'list'; // 'list' or 'grid'
        let systemConfig = {}, sampleInventory = [], stagingSamples = [], historyLog = [];
        let tempSystemConfig = {}; // Temporary config for settings
        let html5QrCode = null; 
        let isScannerRunning = false; 
        let selectedStagingIds = new Set(); 
        let selectedInventoryIds = new Set();
        let currentQrSample = null; // Track current sample for QR Modal

        // DOM Elements
        const viewListBtn = document.getElementById('view-list-btn');
        const viewGridBtn = document.getElementById('view-grid-btn');
        const viewListContainer = document.getElementById('view-list');
        const viewGridContainer = document.getElementById('view-grid');
        const listEmptyState = document.getElementById('list-empty-state');
        const loader = document.getElementById('loader');
        const contentArea = document.getElementById('content-area');
        const drawer = document.getElementById('stagingDrawer');
        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const globalSearchInput = document.getElementById('globalSearchInput');
        const mobileSearchInput = document.getElementById('mobileSearchInput');
        const cabinetFilter = document.getElementById('cabinetFilter');
        const cartBadge = document.getElementById('cart-badge');
        const globalOperatorSelect = document.getElementById('globalOperatorSelect');
        const inventorySelectionBar = document.getElementById('inventory-selection-bar');
        
        // Modals Map
        const modals = {
            addSample: document.getElementById('addSampleModal'),
            report: document.getElementById('reportModal'),
            history: document.getElementById('historyModal'),
            settings: document.getElementById('settingsModal'),
            qrScanner: document.getElementById('qrScannerModal'),
            qrDisplay: document.getElementById('qrDisplayModal'), // Added QR Modal
            action: document.getElementById('actionModal'),
            confirmation: document.getElementById('confirmationModal'),
            sampleDetail: document.getElementById('sampleDetailModal'),
            editSample: document.getElementById('editSampleModal')
        };

        // --- GLOBAL UTILS ---
        function openModal(modal) {
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            modal.querySelector('.modal-content').classList.remove('modal-content-hidden');
            modal.querySelector('.modal-content').classList.add('modal-content-visible');
        }

        function closeModal(modal) {
             if(modal.classList.contains('modal-backdrop')) {
                modal.querySelector('.modal-content').classList.add('modal-content-hidden');
                setTimeout(() => {
                    modal.classList.add('modal-hidden');
                    modal.classList.remove('modal-visible');
                }, 300);
             }
        }

        function showToast(msg) {
            const toast = document.getElementById('notification-toast');
            document.getElementById('notification-message').textContent = msg;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        async function logAction(action, person, sampleName, details) {
            await addDoc(collection(db, 'sampleSystem/data/history'), {
                action, person, sampleName, details, timestamp: serverTimestamp()
            });
        }

        function checkOperator() {
            const operator = globalOperatorSelect.value;
            if (!operator) {
                alert('請先於畫面最上方選擇「操作人員」才能進行此動作！');
                globalOperatorSelect.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
                setTimeout(() => globalOperatorSelect.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'), 1500);
                return false;
            }
            return true;
        }

        function updateGlobalOperatorOptions() {
            const currentVal = globalOperatorSelect.value;
            globalOperatorSelect.innerHTML = '<option value="">請選擇操作人員...</option>';
            (systemConfig.personnel || []).forEach(p => {
                globalOperatorSelect.innerHTML += `<option value="${p}">${p}</option>`;
            });
            if ((systemConfig.personnel || []).includes(currentVal)) {
                globalOperatorSelect.value = currentVal;
            }
        }

        // --- Helper: Sanitize Filename ---
        function sanitizeFilename(name) {
            // Replace invalid characters with underscore
            return name.replace(/[<>:"/\\|?*]/g, '_');
        }

        // --- Helper: Generate Label Image with Text ---
        // This function creates a full image with Name, QR, Wire Diameter, ID
        async function generateLabelImage(sample, format = '40x40') {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const qr = qrcode(0, 'M'); 
                qr.addData(sample.id);
                qr.make();
                const moduleCount = qr.getModuleCount();

                if (format === '80x50') {
                    // 80mm x 50mm @ ~300dpi -> 960px x 600px
                    const width = 960;
                    const height = 600;
                    canvas.width = width;
                    canvas.height = height;

                    // Background
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);

                    // 1. QR Code (Left 1/3: 0-320px)
                    // Center QR in 320x600 area
                    const qrZoneWidth = 320;
                    const targetQrSize = 260; // Slightly smaller to fit with padding
                    const cellSize = Math.floor(targetQrSize / moduleCount);
                    const qrSize = cellSize * moduleCount;
                    const qrMarginX = (qrZoneWidth - qrSize) / 2;
                    const qrMarginY = (height - qrSize) / 2;

                    ctx.fillStyle = '#000000';
                    for (let r = 0; r < moduleCount; r++) {
                        for (let c = 0; c < moduleCount; c++) {
                            if (qr.isDark(r, c)) {
                                ctx.fillRect(qrMarginX + c * cellSize, qrMarginY + r * cellSize, cellSize, cellSize);
                            }
                        }
                    }

                    // 2. Text Info (Right 2/3: 320-960px)
                    const rightZoneStart = 320;
                    const rightZoneWidth = width - rightZoneStart; // 640
                    const centerTextX = rightZoneStart + (rightZoneWidth / 2); // 640

                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#000000';

                    // Sample Name
                    ctx.font = 'bold 48px "Inter", "Noto Sans TC", sans-serif';
                    ctx.fillText(sample.sampleName, centerTextX, 100, rightZoneWidth - 40); // Add max width constraint

                    // Wire Diameter
                    ctx.font = 'bold 36px "Inter", "Noto Sans TC", sans-serif';
                    ctx.fillText(`線徑: ${sample.wireDiameter}`, centerTextX, 180, rightZoneWidth - 40);

                    // Standard
                    ctx.font = '32px "Inter", "Noto Sans TC", sans-serif';
                    ctx.fillText(`標準: ${sample.applicableStandard || '-'}`, centerTextX, 250, rightZoneWidth - 40);

                    // Manufacturer
                    ctx.font = '32px "Inter", "Noto Sans TC", sans-serif';
                    ctx.fillText(`廠商: ${sample.manufacturer || '-'}`, centerTextX, 320, rightZoneWidth - 40);

                    // ID (Bottom Right)
                    ctx.textAlign = 'right';
                    ctx.font = '24px monospace';
                    ctx.fillStyle = '#666666';
                    ctx.fillText(sample.id.substring(0, 8).toUpperCase(), width - 30, height - 30);

                } else {
                    // Default 40x40 (Existing logic)
                    const size = 480; 
                    canvas.width = size;
                    canvas.height = size;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, size, size);
                    
                    const targetQrSize = size * 0.55; 
                    const cellSize = Math.floor(targetQrSize / moduleCount);
                    const qrSize = cellSize * moduleCount;
                    const margin = (size - qrSize) / 2;
                    
                    ctx.fillStyle = '#000000';
                    ctx.textAlign = 'center';
                    
                    // 1. Draw Name (Top)
                    ctx.font = 'bold 36px "Inter", "Noto Sans TC", sans-serif';
                    ctx.fillText(sample.sampleName, size/2, 50, size - 40); 
                    
                    // 2. Draw QR Code (Middle)
                    for (let r = 0; r < moduleCount; r++) {
                        for (let c = 0; c < moduleCount; c++) {
                            if (qr.isDark(r, c)) {
                                ctx.fillRect(margin + c * cellSize, 70 + r * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                    
                    // 3. Draw Wire Diameter (Bottom Middle)
                    ctx.font = 'bold 36px "Inter", "Noto Sans TC", sans-serif';
                    ctx.fillText(`線徑: ${sample.wireDiameter}`, size/2, 70 + qrSize + 40);
                    
                    // 4. Draw ID (Bottom, Small)
                    ctx.font = '18px monospace';
                    ctx.fillStyle = '#666666';
                    ctx.fillText(sample.id.substring(0, 8).toUpperCase(), size/2, size - 15);
                }
                
                resolve(canvas.toDataURL('image/png'));
            });
        }

        // --- QR Code Logic ---
        
        // Refactored to update preview based on selection
        async function updateQrPreview(format) {
            if (!currentQrSample) return;
            const sample = currentQrSample;
            const qrArea = document.getElementById('qrDisplayArea');
            const dlLink = document.getElementById('qrDownloadLink');
            
            // Show loading
            qrArea.innerHTML = '<div class="flex items-center justify-center h-full"><i class="ph ph-spinner animate-spin text-3xl text-indigo-600"></i></div>';
            dlLink.classList.add('opacity-50', 'pointer-events-none');
            dlLink.textContent = '產生圖片中...';

            const fullLabelUrl = await generateLabelImage(sample, format);
            
            // Update preview
            qrArea.innerHTML = `<img src="${fullLabelUrl}" class="object-contain max-h-full mx-auto shadow-md" alt="Label Preview">`;
            
            // Update download link
            const cleanName = sanitizeFilename(sample.sampleName);
            const cleanWire = sanitizeFilename(sample.wireDiameter);
            const fileName = `${sample.id}_${cleanName}_${cleanWire}_${format}.png`;
            
            dlLink.href = fullLabelUrl;
            dlLink.download = fileName;
            
            dlLink.textContent = `下載圖片 (${format})`;
            dlLink.classList.remove('opacity-50', 'pointer-events-none');
            const icon = document.createElement('i');
            icon.className = 'ph ph-download-simple text-lg mr-2';
            dlLink.prepend(icon);
        }

        async function openQrModal(sample) {
            const modal = modals.qrDisplay;
            currentQrSample = sample;
            
            // Reset Select to 40x40 default
            const select = document.getElementById('qrLabelSize');
            select.value = '40x40';
            
            // Initial render
            await updateQrPreview('40x40');

            openModal(modal);
        }
        
        // Listen for format change in single modal
        document.getElementById('qrLabelSize').addEventListener('change', (e) => {
            updateQrPreview(e.target.value);
        });

        // --- Batch QR Download Function (Reusable) ---
        async function downloadBatchQrs(items, format = '40x40') {
            if(!items || items.length === 0) return alert("未選取任何項目");
            
            showToast(`正在打包 ${format} 圖片...`);
            
            try {
                const zip = new JSZip();
                const folder = zip.folder(`labels_${format}`);
                
                for (const s of items) {
                    const base64Url = await generateLabelImage(s, format);
                    const idx = base64Url.indexOf('base64,') + 'base64,'.length;
                    const content = base64Url.substring(idx);
                    
                    const cleanName = sanitizeFilename(s.sampleName);
                    const cleanWire = sanitizeFilename(s.wireDiameter);
                    const filename = `${s.id}_${cleanName}_${cleanWire}_${format}.png`; 
                    folder.file(filename, content, {base64: true});
                }
                
                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = `Batch_Labels_${format}_${new Date().getTime()}.zip`;
                a.click();
            } catch (error) {
                console.error("Batch QR Error:", error);
                alert("批次下載失敗，請稍後再試。");
            }
        }

        // Wrapper for Inventory Selection Batch Download
        function downloadSelectedInventoryQrs() {
            const items = sampleInventory.filter(s => selectedInventoryIds.has(s.id));
            const format = document.getElementById('inventoryBatchLabelSize').value;
            const btn = document.getElementById('inventory-batch-download-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin text-lg"></i> 處理中...';
            
            downloadBatchQrs(items, format).finally(() => {
                btn.innerHTML = originalContent;
            });
        }

        // Wrapper for Staging Batch Download
        function downloadStagingBatchQrs() {
            const items = stagingSamples.filter(s => selectedStagingIds.has(s.id));
            const format = document.getElementById('stagingBatchLabelSize').value;
            const btn = document.getElementById('batch-qr-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i>';
            
            downloadBatchQrs(items, format).finally(() => {
                btn.innerHTML = originalContent;
            });
        }

        // --- DIRECT QR SCANNER IMPLEMENTATION ---
        async function stopScanner() {
            if (html5QrCode && isScannerRunning) {
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                    isScannerRunning = false;
                } catch (err) {
                    console.error("Failed to stop scanner", err);
                    isScannerRunning = false;
                }
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            stopScanner().then(() => {
                closeModal(modals.qrScanner);
                handleScanResult(decodedText);
            });
        }

        function handleScanResult(text) {
            if (window.scannerMode === 'search') {
                globalSearchInput.value = text;
                mobileSearchInput.value = text;
                globalSearchInput.dispatchEvent(new Event('input'));
                showToast(`已搜尋: ${text}`);
            } else if (window.scannerMode === 'input') {
                const nameInput = document.getElementById('sampleName');
                if(nameInput) {
                    nameInput.value = text;
                    showToast(`已讀取: ${text}`);
                }
            }
        }

        window.startScanner = async function(mode) {
            if (isScannerRunning) {
                await stopScanner();
            }

            window.scannerMode = mode; 
            openModal(modals.qrScanner);
            
            setTimeout(() => {
                if (html5QrCode === null) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }
                
                const container = document.getElementById('qr-reader');
                const width = container ? container.clientWidth : 250;
                const boxSize = Math.floor(width * 0.65); 

                const config = { 
                    fps: 10, 
                    qrbox: { width: boxSize, height: boxSize },
                    aspectRatio: 1.0 
                };
                
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    config, 
                    onScanSuccess
                ).then(() => {
                    isScannerRunning = true;
                }).catch(err => {
                    console.error("Error starting scanner", err);
                    isScannerRunning = false;
                    
                    if (err.name === 'NotReadableError') {
                        alert("相機資源被佔用，請嘗試關閉視窗後重試，或重新整理網頁。");
                    } else if (err.name === 'NotAllowedError') {
                        alert("請允許相機權限以使用掃描功能。");
                    } else {
                        // Retry with user facing camera
                        html5QrCode.start(
                            { facingMode: "user" }, 
                            config, 
                            onScanSuccess
                        ).then(() => {
                             isScannerRunning = true;
                        }).catch(err2 => {
                            console.error("Failed fallback start", err2);
                            alert("無法啟動相機: " + err2.message);
                        });
                    }
                });
            }, 300);
        }

        document.querySelector('.close-scanner-btn').addEventListener('click', () => {
             stopScanner().then(() => {
                 closeModal(modals.qrScanner);
             });
        });


        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop'))));

            // --- Settings Listeners ---
            const navSettingsBtn = document.getElementById('nav-settings');
            if(navSettingsBtn) {
                navSettingsBtn.addEventListener('click', () => {
                     tempSystemConfig = JSON.parse(JSON.stringify(systemConfig));
                     renderSettingsUI(tempSystemConfig);
                     openModal(modals.settings);
                });
            }

            const addPersonBtn = document.getElementById('addPersonBtn');
            if(addPersonBtn) {
                addPersonBtn.addEventListener('click', () => {
                    const nameInput = document.getElementById('newPersonName');
                    const name = nameInput.value.trim();
                    if(name) {
                        if(!tempSystemConfig.personnel) tempSystemConfig.personnel = [];
                        if(!tempSystemConfig.personnel.includes(name)) {
                            tempSystemConfig.personnel.push(name);
                            renderSettingsUI(tempSystemConfig);
                            nameInput.value = '';
                        } else {
                            alert('人員已存在');
                        }
                    }
                });
            }

            const addCabinetBtn = document.getElementById('addCabinetBtn');
            if(addCabinetBtn) {
                addCabinetBtn.addEventListener('click', () => {
                    const cabInput = document.getElementById('newCabinetName');
                    const name = cabInput.value.trim();
                    if(name) {
                        if(!tempSystemConfig.storageLayout) tempSystemConfig.storageLayout = {};
                        if(!tempSystemConfig.storageLayout[name]) {
                            tempSystemConfig.storageLayout[name] = {};
                            renderSettingsUI(tempSystemConfig);
                            cabInput.value = '';
                        } else {
                            alert('櫃子名稱重複');
                        }
                    }
                });
            }

            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if(saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', async () => {
                    try {
                        await setDoc(doc(db, 'sampleSystem', 'config'), tempSystemConfig);
                        showToast('設定已儲存');
                        closeModal(modals.settings);
                    } catch(e) {
                        console.error(e);
                        alert('儲存失敗');
                    }
                });
            }
            
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            if(closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', () => closeModal(modals.settings));
            }

            const settingsModal = document.getElementById('settingsModal');
            if(settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if(!target) return;

                    if(target.classList.contains('delete-person-btn')) {
                        const p = target.dataset.person;
                        tempSystemConfig.personnel = tempSystemConfig.personnel.filter(x => x !== p);
                        renderSettingsUI(tempSystemConfig);
                    }
                    
                    if(target.classList.contains('delete-cabinet-btn')) {
                        const c = target.dataset.cabinet;
                        if(confirm(`確定刪除櫃子 ${c}？`)) {
                            delete tempSystemConfig.storageLayout[c];
                            renderSettingsUI(tempSystemConfig);
                        }
                    }

                    if(target.classList.contains('delete-shelf-btn')) {
                        const {cabinet, shelf} = target.dataset;
                        if(confirm(`確定刪除 ${shelf}？`)) {
                            delete tempSystemConfig.storageLayout[cabinet][shelf];
                            renderSettingsUI(tempSystemConfig);
                        }
                    }

                    if(target.classList.contains('add-shelf-btn')) {
                        const cabinet = target.dataset.cabinet;
                        const parent = target.parentElement;
                        const name = parent.querySelector('.new-shelf-name').value.trim();
                        if(name) {
                            tempSystemConfig.storageLayout[cabinet][name] = -1;
                            renderSettingsUI(tempSystemConfig);
                        } else {
                            alert('請輸入層名稱');
                        }
                    }
                });
            }
            
            // --- Report Logic ---
            function renderReportPreview(filter = 'all') {
                const content = document.getElementById('reportContent');
                let data = sampleInventory;
                if (filter !== 'all') {
                    data = data.filter(s => s.storageLocation.startsWith(filter));
                }
                data.sort((a,b) => a.storageLocation.localeCompare(b.storageLocation));

                if (data.length === 0) {
                    content.innerHTML = '<p class="text-center text-slate-500 py-8">無資料</p>';
                    return;
                }
                
                let html = `
                    <div class="mb-4">
                        <h2 class="text-xl font-bold">庫存清單</h2>
                        <p class="text-sm text-slate-500">時間: ${new Date().toLocaleString()} | 共 ${data.length} 筆資料</p>
                    </div>
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-2 border">位置</th>
                                <th class="p-2 border">名稱</th>
                                <th class="p-2 border">線徑</th>
                                <th class="p-2 border">標準</th>
                                <th class="p-2 border">廠商</th>
                                <th class="p-2 border">登錄者</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.forEach(s => {
                    html += `
                        <tr class="border-b">
                            <td class="p-2 border">${s.storageLocation}</td>
                            <td class="p-2 border font-medium">${s.sampleName}</td>
                            <td class="p-2 border">${s.wireDiameter}</td>
                            <td class="p-2 border">${s.applicableStandard||''}</td>
                            <td class="p-2 border">${s.manufacturer||''}</td>
                            <td class="p-2 border">${s.loggedBy}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                content.innerHTML = html;
            }

            document.getElementById('printReportBtn').addEventListener('click', () => {
                const content = document.getElementById('reportContent').innerHTML;
                const win = window.open('', '', 'height=600,width=800');
                win.document.write('<html><head><title>Print</title>');
                win.document.write('<script src="https://cdn-tailwindcss.vercel.app/"><\/script>'); 
                win.document.write('</head><body class="p-8">');
                win.document.write(content);
                win.document.write('<script>window.print();window.close();<\/script>');
                win.document.write('</body></html>');
                win.document.close();
            });

            document.getElementById('downloadCsvBtn').addEventListener('click', () => {
                let csv = "位置,名稱,線徑,標準,廠商,登錄者\n";
                sampleInventory.forEach(s => {
                    csv += `"${s.storageLocation}","${s.sampleName}","${s.wireDiameter}","${s.applicableStandard||''}","${s.manufacturer||''}","${s.loggedBy}"\n`;
                });
                const blob = new Blob([csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `inventory_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            });


            // --- View Toggle Logic ---
            function switchView(mode) {
                currentViewMode = mode;
                if (mode === 'list') {
                    viewListBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');
                    viewGridBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');
                    viewListContainer.classList.remove('hidden');
                    viewGridContainer.classList.add('hidden');
                } else {
                    viewGridBtn.classList.add('bg-white', 'text-indigo-600', 'shadow-sm');
                    viewListBtn.classList.remove('bg-white', 'text-indigo-600', 'shadow-sm');
                    viewGridContainer.classList.remove('hidden');
                    viewListContainer.classList.add('hidden');
                }
                renderInventory();
            }
            viewListBtn.addEventListener('click', () => switchView('list'));
            viewGridBtn.addEventListener('click', () => switchView('grid'));

            // --- Drawer Logic ---
            function toggleDrawer(show) {
                if (show) {
                    drawer.classList.remove('drawer-hidden');
                    drawer.classList.add('drawer-visible');
                    renderStagingDrawer();
                } else {
                    drawer.classList.remove('drawer-visible');
                    drawer.classList.add('drawer-hidden');
                }
            }
            document.getElementById('cartDrawerBtn').addEventListener('click', () => toggleDrawer(true));
            document.getElementById('closeDrawerBtn').addEventListener('click', () => toggleDrawer(false));
            drawerBackdrop.addEventListener('click', () => toggleDrawer(false));
            
            // --- Batch Action Listeners ---
            const batchQrBtn = document.getElementById('batch-qr-btn');
            if (batchQrBtn) {
                batchQrBtn.addEventListener('click', downloadStagingBatchQrs);
            }
            
            // Inventory Batch Action Listeners
            document.getElementById('inventory-batch-download-btn').addEventListener('click', downloadSelectedInventoryQrs);
            document.getElementById('inventory-clear-selection').addEventListener('click', () => {
                selectedInventoryIds.clear();
                updateInventorySelectionUI();
                renderInventory();
            });
            document.getElementById('selectAllInventory').addEventListener('change', (e) => {
                const checked = e.target.checked;
                const filtered = getFilteredInventory();
                if (checked) {
                    filtered.forEach(s => selectedInventoryIds.add(s.id));
                } else {
                    filtered.forEach(s => selectedInventoryIds.delete(s.id));
                }
                updateInventorySelectionUI();
                renderInventory();
            });

            // --- Navigation Logic ---
            function bindNav(id, modalKey) {
                const els = document.querySelectorAll(`#nav-${id}, #mobile-nav-${id}`);
                els.forEach(el => el.addEventListener('click', () => {
                    if (modalKey === 'inventory') {
                        document.getElementById('main-scroll-area').scrollTo({top: 0, behavior: 'smooth'});
                    } else if (modalKey === 'add') {
                        if (!checkOperator()) return;
                        const form = document.getElementById('add-sample-form');
                        form.reset();
                        updateAddFormSelects();
                        openModal(modals.addSample);
                    } else {
                         if(modalKey === 'settings') {
                             return; 
                         } else if (modalKey === 'history') {
                             renderAllHistoryTables();
                         } else if (modalKey === 'report') {
                            renderReportPreview('all');
                         }
                        openModal(modals[modalKey]);
                    }
                }));
            }
            bindNav('inventory', 'inventory');
            bindNav('report', 'report');
            bindNav('history', 'history');
            bindNav('settings', 'settings');
            
            document.getElementById('mobile-nav-add').addEventListener('click', () => {
                 if (!checkOperator()) return;
                 document.getElementById('add-sample-form').reset();
                 updateAddFormSelects();
                 openModal(modals.addSample);
            });
            document.getElementById('topAddBtn').addEventListener('click', () => {
                 if (!checkOperator()) return;
                 document.getElementById('add-sample-form').reset();
                 updateAddFormSelects();
                 openModal(modals.addSample);
            });
            
            document.getElementById('topScanBtn').addEventListener('click', () => startScanner('search'));
            
            const inputQrBtn = document.getElementById('scanInputQrBtn');
            if(inputQrBtn) {
                inputQrBtn.addEventListener('click', () => {
                    startScanner('input');
                });
            }


            // --- Core Rendering Functions ---

            function getFilteredInventory() {
                const query = (globalSearchInput.value || mobileSearchInput.value).toLowerCase().trim();
                const cabinet = cabinetFilter.value;
                
                return sampleInventory.filter(s => {
                    const matchText = Object.values(s).join(' ').toLowerCase().includes(query);
                    const matchCabinet = cabinet === 'all' || s.storageLocation.startsWith(cabinet);
                    return matchText && matchCabinet;
                });
            }

            function updateInventorySelectionUI() {
                const count = selectedInventoryIds.size;
                document.getElementById('inventory-selected-count').textContent = count;
                
                // Toggle Select All Checkbox State
                const selectAllCheckbox = document.getElementById('selectAllInventory');
                const filtered = getFilteredInventory();
                // Check if all current filtered items are selected
                const allSelected = filtered.length > 0 && filtered.every(s => selectedInventoryIds.has(s.id));
                selectAllCheckbox.checked = allSelected;

                if (count > 0) {
                    inventorySelectionBar.classList.remove('selection-bar-hidden');
                    inventorySelectionBar.classList.add('selection-bar-visible');
                } else {
                    inventorySelectionBar.classList.add('selection-bar-hidden');
                    inventorySelectionBar.classList.remove('selection-bar-visible');
                }
            }

            function renderInventory() {
                const data = getFilteredInventory();
                const tbody = document.getElementById('inventory-table-body');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    listEmptyState.classList.remove('hidden');
                } else {
                    listEmptyState.classList.add('hidden');
                    data.forEach(s => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-slate-100 hover:bg-slate-50 transition-colors group table-row-hover';
                        const shortLoc = s.storageLocation.replace('位置 ', '');
                        const isSelected = selectedInventoryIds.has(s.id);

                        tr.innerHTML = `
                            <td class="px-4 py-4 text-center">
                                <input type="checkbox" class="rounded text-indigo-600 focus:ring-indigo-500 w-4 h-4 cursor-pointer inventory-checkbox" data-id="${s.id}" ${isSelected ? 'checked' : ''}>
                            </td>
                            <td class="px-6 py-4 font-medium text-slate-900 group-hover:text-indigo-600 transition-colors cursor-pointer nav-detail" data-id="${s.id}">
                                ${s.sampleName}
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 rounded bg-slate-100 text-xs font-mono text-slate-600 border border-slate-200">${shortLoc}</span>
                            </td>
                            <td class="px-6 py-4 text-slate-500">${s.wireDiameter || '-'}</td>
                            <td class="px-6 py-4 hidden sm:table-cell text-slate-500">${s.applicableStandard || '-'}</td>
                            <td class="px-6 py-4 hidden md:table-cell text-slate-500">${s.manufacturer || '-'}</td>
                            <td class="px-6 py-4 hidden lg:table-cell text-xs text-slate-400">
                                <div>${s.batchNo ? '批:'+s.batchNo : ''}</div>
                                <div>${s.formulaCode ? '配:'+s.formulaCode : ''}</div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button class="text-slate-400 hover:text-indigo-600 p-1.5 rounded-full hover:bg-indigo-50 transition quick-stage-btn" title="移至暫存" data-id="${s.id}">
                                    <i class="ph ph-shopping-cart-simple text-xl"></i>
                                </button>
                            </td>
                        `;
                        
                        tr.querySelector('.inventory-checkbox').addEventListener('change', (e) => {
                            if (e.target.checked) selectedInventoryIds.add(s.id);
                            else selectedInventoryIds.delete(s.id);
                            updateInventorySelectionUI();
                        });

                        tr.querySelector('.nav-detail').addEventListener('click', () => showSampleDetails(s));
                        tr.querySelector('.quick-stage-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (!checkOperator()) return;
                            openActionModal('stage', s);
                        });
                        tbody.appendChild(tr);
                    });
                }

                if (currentViewMode === 'grid') {
                    renderGridView(data);
                }
            }

            function renderGridView(filteredData) {
                viewGridContainer.innerHTML = '';
                const layout = systemConfig.storageLayout || {};
                const cabinets = Object.keys(layout);
                const filteredSet = new Set(filteredData.map(s => s.id));
                const cabinetFilterVal = cabinetFilter.value;

                cabinets.forEach(cabinetName => {
                    if (cabinetFilterVal !== 'all' && cabinetName !== cabinetFilterVal) return;

                    const cabinetSection = document.createElement('div');
                    cabinetSection.className = 'bg-white rounded-xl shadow-sm border border-slate-200 p-4';
                    cabinetSection.innerHTML = `<h3 class="font-bold text-slate-700 text-lg mb-4 border-b border-slate-100 pb-2 flex items-center gap-2"><i class="ph ph-door text-indigo-500"></i> ${cabinetName}</h3>`;

                    const shelves = layout[cabinetName];
                    Object.keys(shelves).forEach(shelfName => {
                        const shelfDiv = document.createElement('div');
                        shelfDiv.className = 'mb-6';
                        shelfDiv.innerHTML = `<h4 class="text-sm font-semibold text-slate-500 mb-2 pl-1">${shelfName}</h4>`;
                        
                        const grid = document.createElement('div');
                        grid.className = 'grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-2';

                        const searchPrefix = `${cabinetName} - ${shelfName}`;
                        const itemsInShelf = sampleInventory.filter(s => s.storageLocation.startsWith(searchPrefix));
                        
                        itemsInShelf.forEach(sample => {
                             const isMatch = filteredSet.has(sample.id);
                             if(!isMatch) return;
                             
                             const isSelected = selectedInventoryIds.has(sample.id);

                             const cell = document.createElement('div');
                             cell.className = `aspect-square rounded-md border text-xs flex flex-col items-center justify-center p-1 cursor-pointer transition relative group has-tooltip bg-indigo-50 border-indigo-200 text-indigo-700 hover:bg-indigo-100 shadow-sm ${isSelected ? 'ring-2 ring-indigo-500 bg-indigo-100' : ''}`;
                             
                             cell.innerHTML = `
                                <input type="checkbox" class="absolute top-1 left-1 w-3 h-3 cursor-pointer grid-checkbox z-10" ${isSelected ? 'checked' : ''}>
                                <span class="font-bold truncate w-full text-center">${sample.sampleName}</span>
                                <span class="text-[9px] mt-0.5 text-slate-500 truncate w-full text-center">${sample.wireDiameter}</span>
                                <div class="custom-tooltip bg-slate-800 text-white text-xs p-2 rounded shadow-lg -mt-16 whitespace-nowrap z-50">
                                    ${sample.sampleName}<br>${sample.manufacturer || '-'}
                                </div>
                             `;
                             
                             // Handle checkbox click
                             const checkbox = cell.querySelector('.grid-checkbox');
                             checkbox.addEventListener('change', (e) => {
                                 e.stopPropagation(); // Stop firing cell click
                                 if (e.target.checked) selectedInventoryIds.add(sample.id);
                                 else selectedInventoryIds.delete(sample.id);
                                 updateInventorySelectionUI();
                                 // Re-render only grid isn't necessary for state but visual update
                                 if (e.target.checked) cell.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-100');
                                 else cell.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-100');
                             });

                             // Cell click opens detail
                             cell.addEventListener('click', (e) => {
                                 if(e.target !== checkbox) showSampleDetails(sample);
                             });
                             
                             grid.appendChild(cell);
                        });

                        const addBtn = document.createElement('div');
                        addBtn.className = `aspect-square rounded-md border border-dashed border-slate-300 flex items-center justify-center text-slate-400 hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50 cursor-pointer transition`;
                        addBtn.innerHTML = `<i class="ph ph-plus text-xl"></i>`;
                        addBtn.title = "在此架位新增";
                        addBtn.addEventListener('click', () => {
                            if (!checkOperator()) return;
                            const form = document.getElementById('add-sample-form');
                            form.reset();
                            updateAddFormSelects();
                            document.getElementById('storageCabinet').value = cabinetName;
                            document.getElementById('storageCabinet').dispatchEvent(new Event('change'));
                            document.getElementById('storageShelf').value = shelfName;
                            openModal(modals.addSample);
                        });
                        grid.appendChild(addBtn);

                        shelfDiv.appendChild(grid);
                        cabinetSection.appendChild(shelfDiv);
                    });
                    viewGridContainer.appendChild(cabinetSection);
                });
            }

            // --- Staging Drawer Rendering ---
            function renderStagingDrawer() {
                const list = document.getElementById('staging-list');
                const empty = document.getElementById('drawer-empty-state');
                const footer = document.getElementById('drawer-footer');
                const countBadge = document.getElementById('staging-selected-count');
                
                list.innerHTML = '';
                
                if (stagingSamples.length === 0) {
                    empty.classList.remove('hidden');
                    footer.classList.add('hidden');
                    list.classList.add('hidden');
                    cartBadge.style.opacity = '0';
                } else {
                    empty.classList.add('hidden');
                    footer.classList.remove('hidden');
                    list.classList.remove('hidden');
                    cartBadge.style.opacity = '1';
                    cartBadge.textContent = stagingSamples.length;

                    stagingSamples.forEach(s => {
                        const isSelected = selectedStagingIds.has(s.id);
                        const item = document.createElement('div');
                        item.className = `p-3 rounded-lg border transition flex gap-3 ${isSelected ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-indigo-300'}`;
                        
                        item.innerHTML = `
                            <div class="pt-1">
                                <input type="checkbox" class="rounded text-indigo-600 focus:ring-indigo-500 w-4 h-4 cursor-pointer staging-checkbox" ${isSelected ? 'checked' : ''}>
                            </div>
                            <div class="flex-1 min-w-0 cursor-pointer item-detail-trigger">
                                <h4 class="text-sm font-bold text-slate-800 truncate">${s.sampleName}</h4>
                                <p class="text-xs text-slate-500 truncate">原位: ${s.storageLocation}</p>
                                <div class="mt-1 flex gap-2">
                                    <button class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded border border-emerald-100 hover:bg-emerald-100 transition action-return-btn">放回</button>
                                    <button class="text-[10px] bg-red-50 text-red-600 px-2 py-0.5 rounded border border-red-100 hover:bg-red-100 transition action-archive-btn">歸檔</button>
                                </div>
                            </div>
                        `;

                        const checkbox = item.querySelector('.staging-checkbox');
                        const toggleSelect = () => {
                            if (selectedStagingIds.has(s.id)) selectedStagingIds.delete(s.id);
                            else selectedStagingIds.add(s.id);
                            renderStagingDrawer(); 
                        };
                        checkbox.addEventListener('change', toggleSelect);
                        item.querySelector('.item-detail-trigger').addEventListener('click', (e) => {
                             if(e.target.tagName !== 'BUTTON') showSampleDetails(s);
                        });

                        item.querySelector('.action-return-btn').addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            if(!checkOperator()) return;
                            openActionModal('return', s); 
                        });
                        item.querySelector('.action-archive-btn').addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            if(!checkOperator()) return;
                            openActionModal('finalize', s); 
                        });

                        list.appendChild(item);
                    });
                    
                    countBadge.textContent = selectedStagingIds.size;
                }
            }

            // --- Helper: Action Modal Opening ---
            function openActionModal(action, sample) {
                const modal = modals.action;
                const title = document.getElementById('actionModalTitle');
                const msg = document.getElementById('actionModalMessage');
                const btn = document.getElementById('actionConfirmBtn');
                const remarks = document.getElementById('remarksContainer');
                
                document.getElementById('actionSampleId').value = sample.id;
                document.getElementById('actionType').value = action;
                document.getElementById('actionForm').reset();
                
                remarks.classList.add('hidden');
                document.getElementById('actionRemarks').required = false;

                if (action === 'stage') {
                    title.textContent = '移至暫存區';
                    msg.textContent = `將 "${sample.sampleName}" 從庫存移至暫存區？`;
                    btn.className = "px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700";
                    btn.textContent = "移動";
                } else if (action === 'return') {
                    title.textContent = '放回原位';
                    msg.textContent = `將 "${sample.sampleName}" 放回 ${sample.storageLocation}？`;
                    btn.className = "px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700";
                    btn.textContent = "放回";
                } else if (action === 'finalize') {
                    title.textContent = '歸檔 (最終取出)';
                    msg.textContent = `將 "${sample.sampleName}" 永久歸檔？此操作無法復原。`;
                    remarks.classList.remove('hidden');
                    document.getElementById('actionRemarks').required = true;
                    btn.className = "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700";
                    btn.textContent = "歸檔";
                }
                openModal(modal);
            }

            // --- Form Handlers ---
            document.getElementById('actionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('actionSampleId').value;
                const type = document.getElementById('actionType').value;
                const person = globalOperatorSelect.value; // Use global
                const remark = document.getElementById('actionRemarks').value;
                
                if(!person) return alert('請先選擇操作人員');

                try {
                    closeModal(modals.action);
                    if (type === 'stage') {
                         const s = sampleInventory.find(x => x.id === id);
                         if(!s) throw new Error('Sample not found');
                         const {id: _, ...data} = s;
                         await setDoc(doc(db, 'sampleSystem/data/staging', id), data);
                         await deleteDoc(doc(db, 'sampleSystem/data/inventory', id));
                         await logAction('移至暫存', person, s.sampleName, s.storageLocation);
                         showToast(`已將 ${s.sampleName} 移至暫存`);
                    } else if (type === 'return') {
                        const s = stagingSamples.find(x => x.id === id);
                        const {id: _, ...data} = s;
                        await setDoc(doc(db, 'sampleSystem/data/inventory', id), data);
                        await deleteDoc(doc(db, 'sampleSystem/data/staging', id));
                        await logAction('放回儲位', person, s.sampleName, s.storageLocation);
                        showToast(`已放回 ${s.sampleName}`);
                    } else if (type === 'finalize') {
                        const s = stagingSamples.find(x => x.id === id);
                        const {id: _, ...data} = s;
                        await addDoc(collection(db, 'sampleSystem/data/archived'), {...data, archivedAt: serverTimestamp(), remarks: remark});
                        await deleteDoc(doc(db, 'sampleSystem/data/staging', id));
                        await logAction('最終取出', person, s.sampleName, `${s.storageLocation} (備註: ${remark})`);
                        showToast(`已歸檔 ${s.sampleName}`);
                    }
                } catch(err) {
                    console.error(err);
                    alert('操作失敗');
                }
            });

            // --- Helper: Sample Details ---
            window.showSampleDetails = function(sample) {
                const content = document.getElementById('sampleDetailContent');
                const footer = document.getElementById('sampleDetailFooter');
                
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 flex justify-between items-start">
                            <div>
                                <h4 class="text-xl font-bold text-slate-800">${sample.sampleName}</h4>
                                <p class="text-indigo-600 font-mono mt-1">${sample.storageLocation}</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-xs text-slate-400">ID</span>
                                <span class="text-xs font-mono text-slate-600">${sample.id.substring(0,8)}...</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">線徑</span><span class="font-medium">${sample.wireDiameter}</span></div>
                            <div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">標準</span><span class="font-medium">${sample.applicableStandard||'-'}</span></div>
                            <div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">製造商</span><span class="font-medium">${sample.manufacturer||'-'}</span></div>
                            <div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">配方</span><span class="font-medium">${sample.formulaCode||'-'}</span></div>
                            <div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">批號</span><span class="font-medium">${sample.batchNo||'-'}</span></div>
                            <div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">爐號</span><span class="font-medium">${sample.furnaceNo||'-'}</span></div>
                            <div class="col-span-2 p-3 border rounded-lg"><span class="block text-xs text-slate-400">製程</span><span class="font-medium">${sample.processDetails||'-'}</span></div>
                        </div>
                        <div class="text-xs text-slate-400 text-right pt-2">
                            登錄者: ${sample.loggedBy} (${sample.loggedAt?.toDate().toLocaleString()})
                        </div>
                    </div>
                `;
                
                footer.innerHTML = ''; // Clear existing
                
                // Create Close Button
                const closeBtn = document.createElement('button');
                closeBtn.type = 'button'; // Explicit type
                closeBtn.className = 'px-6 py-3 border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 active:bg-slate-100 transition duration-150 ease-in-out font-medium min-w-[80px]'; // Larger hit area, active state
                closeBtn.textContent = '關閉';
                closeBtn.addEventListener('click', () => {
                     closeModal(modals.sampleDetail);
                });
                
                // Create Actions Container
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-3'; // More gap
                
                // Create QR Button
                const qrBtn = document.createElement('button');
                qrBtn.type = 'button';
                qrBtn.className = 'px-6 py-3 bg-white border border-indigo-200 text-indigo-600 rounded-lg hover:bg-indigo-50 active:bg-indigo-100 transition duration-150 ease-in-out flex items-center gap-2 font-medium min-w-[100px] justify-center';
                qrBtn.innerHTML = '<i class="ph ph-qr-code text-lg"></i> QR Code';
                qrBtn.addEventListener('click', (e) => {
                    closeModal(modals.sampleDetail);
                    setTimeout(() => {
                        openQrModal(sample);
                    }, 50);
                });
                
                // Create Edit Button
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'px-6 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-900 active:bg-slate-950 transition duration-150 ease-in-out font-medium min-w-[80px]';
                editBtn.textContent = '修改';
                editBtn.addEventListener('click', () => {
                    if(!checkOperator()) return;
                    closeModal(modals.sampleDetail);
                    openEditSampleModal(sample);
                });

                actionsDiv.appendChild(qrBtn);
                actionsDiv.appendChild(editBtn);
                footer.appendChild(closeBtn);
                footer.appendChild(actionsDiv);

                openModal(modals.sampleDetail);
            };

            function openEditSampleModal(sample) {
                const modal = modals.editSample;
                const form = document.getElementById('edit-sample-form');
                
                document.getElementById('editSampleId').value = sample.id;
                document.getElementById('editSampleCollection').value = sampleInventory.find(x=>x.id===sample.id) ? 'inventory' : 'staging';
                
                document.getElementById('editSampleName').value = sample.sampleName;
                document.getElementById('editWireDiameter').value = sample.wireDiameter;
                document.getElementById('editApplicableStandard').value = sample.applicableStandard || '';
                document.getElementById('editManufacturer').value = sample.manufacturer || '';
                document.getElementById('editFormulaCode').value = sample.formulaCode || '';
                document.getElementById('editProcessDetails').value = sample.processDetails || '';
                document.getElementById('editFurnaceNo').value = sample.furnaceNo || '';
                document.getElementById('editBatchNo').value = sample.batchNo || '';

                const locationParts = sample.storageLocation.split(' - ');
                const currentCab = locationParts[0] || '';
                const currentShelf = locationParts[1] || '';

                const cabSelect = document.getElementById('editStorageCabinet');
                const shelfSelect = document.getElementById('editStorageShelf');

                cabSelect.innerHTML = '<option value="">選擇櫃子</option>';
                Object.keys(systemConfig.storageLayout || {}).forEach(k => {
                    cabSelect.innerHTML += `<option value="${k}" ${k === currentCab ? 'selected' : ''}>${k}</option>`;
                });

                const populateShelves = (cab) => {
                    shelfSelect.innerHTML = '<option value="">選擇層數</option>';
                    if(cab && systemConfig.storageLayout[cab]) {
                        shelfSelect.disabled = false;
                        shelfSelect.classList.remove('bg-slate-100');
                        shelfSelect.classList.add('bg-white');
                        Object.keys(systemConfig.storageLayout[cab]).forEach(s => {
                             shelfSelect.innerHTML += `<option value="${s}" ${s === currentShelf && cab === currentCab ? 'selected' : ''}>${s}</option>`;
                        });
                    } else {
                        shelfSelect.disabled = true;
                        shelfSelect.classList.add('bg-slate-100');
                        shelfSelect.classList.remove('bg-white');
                    }
                };

                populateShelves(currentCab);
                cabSelect.onchange = (e) => populateShelves(e.target.value);

                openModal(modal);
            }

            // --- Edit Submit ---
            document.getElementById('edit-sample-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('editSampleId').value;
                const coll = document.getElementById('editSampleCollection').value === 'inventory' ? 'sampleSystem/data/inventory' : 'sampleSystem/data/staging';
                const modifier = globalOperatorSelect.value;
                if(!modifier) return alert('請先選擇操作人員');

                const newCabinet = document.getElementById('editStorageCabinet').value;
                const newShelf = document.getElementById('editStorageShelf').value;
                
                let newLocation = null;
                if (newCabinet && newShelf) {
                    newLocation = `${newCabinet} - ${newShelf}`;
                } else {
                    if(!newCabinet || !newShelf) return alert('請選擇完整的存放位置');
                }

                const updateData = {
                    sampleName: document.getElementById('editSampleName').value,
                    wireDiameter: document.getElementById('editWireDiameter').value,
                    applicableStandard: document.getElementById('editApplicableStandard').value,
                    manufacturer: document.getElementById('editManufacturer').value,
                    formulaCode: document.getElementById('editFormulaCode').value,
                    processDetails: document.getElementById('editProcessDetails').value,
                    furnaceNo: document.getElementById('editFurnaceNo').value,
                    batchNo: document.getElementById('editBatchNo').value,
                    storageLocation: newLocation,
                    lastModifiedBy: modifier,
                    lastModifiedAt: serverTimestamp()
                };

                try {
                    await setDoc(doc(db, coll, id), updateData, {merge: true});
                    await logAction('資料修改', modifier, updateData.sampleName, `位置變更為: ${newLocation}`);
                    closeModal(modals.editSample);
                    showToast('資料已更新');
                } catch(err) {
                    console.error(err);
                    alert('更新失敗');
                }
            });

            // --- Misc Utils ---
            function updateAddFormSelects() {
                const cabSelect = document.getElementById('storageCabinet');
                cabSelect.innerHTML = '<option value="">選擇櫃子</option>';
                Object.keys(systemConfig.storageLayout || {}).forEach(k => cabSelect.innerHTML += `<option value="${k}">${k}</option>`);
            }

            document.getElementById('storageCabinet').addEventListener('change', (e) => {
                const cabinet = e.target.value;
                const shelfSelect = document.getElementById('storageShelf');
                
                shelfSelect.innerHTML = '<option value="">選擇層數</option>';
                shelfSelect.disabled = !cabinet;

                if(cabinet) {
                    const shelves = systemConfig.storageLayout[cabinet];
                    Object.keys(shelves).forEach(s => shelfSelect.innerHTML += `<option value="${s}">${s}</option>`);
                    shelfSelect.classList.remove('bg-slate-100');
                } else {
                    shelfSelect.classList.add('bg-slate-100');
                }
            });

            document.getElementById('add-sample-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const person = globalOperatorSelect.value;
                if(!person) return alert('請先選擇操作人員');

                const loc = `${form.storageCabinet.value} - ${form.storageShelf.value}`;
                
                const newData = {
                    sampleName: form.sampleName.value,
                    wireDiameter: form.wireDiameter.value,
                    applicableStandard: form.applicableStandard.value,
                    manufacturer: form.manufacturer.value,
                    formulaCode: form.formulaCode.value,
                    batchNo: form.batchNo.value,
                    furnaceNo: form.furnaceNo.value,
                    processDetails: form.processDetails.value,
                    loggedBy: person, 
                    storageLocation: loc,
                    loggedAt: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, 'sampleSystem/data/inventory'), newData);
                    await logAction('放入', person, newData.sampleName, loc);
                    closeModal(modals.addSample);
                    showToast('新增成功');
                } catch(err) {
                    console.error(err);
                    alert('新增失敗');
                }
            });

            // --- Firebase Listeners ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    document.getElementById('user-avatar').textContent = user.isAnonymous ? 'A' : 'U';
                    document.getElementById('current-user-display').textContent = user.isAnonymous ? '訪客人員' : '管理員';
                    
                    onSnapshot(doc(db, 'sampleSystem', 'config'), snap => {
                        systemConfig = snap.exists() ? snap.data() : { storageLayout: {}, personnel: [] };
                        cabinetFilter.innerHTML = '<option value="all">所有櫃位</option>';
                        Object.keys(systemConfig.storageLayout || {}).forEach(k => cabinetFilter.innerHTML += `<option value="${k}">${k}</option>`);
                        updateGlobalOperatorOptions();
                        renderInventory(); 
                    });

                    onSnapshot(query(collection(db, 'sampleSystem/data/inventory')), snap => {
                        sampleInventory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        loader.classList.add('hidden');
                        contentArea.classList.remove('hidden');
                        updateInventorySelectionUI(); // Maintain selection across updates
                        renderInventory();
                    });

                    onSnapshot(query(collection(db, 'sampleSystem/data/staging')), snap => {
                        stagingSamples = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        renderStagingDrawer();
                    });

                } else {
                    signInAnonymously(auth);
                }
            });

            globalSearchInput.addEventListener('input', renderInventory);
            mobileSearchInput.addEventListener('input', renderInventory);
            cabinetFilter.addEventListener('change', renderInventory);
        });

        // Expose simple functions for history/report placeholder
        window.renderAllHistoryTables = () => {
             const container = document.getElementById('history-content-container');
             if(historyLog.length === 0) {
                 container.innerHTML = '<p class="text-center text-slate-400 py-8">無歷史紀錄</p>';
                 return;
             }
             
             let html = '<div class="space-y-2">';
             historyLog.forEach(log => {
                 let colorClass = 'text-slate-600';
                 if(log.action.includes('放入')) colorClass = 'text-green-600';
                 else if(log.action.includes('移至暫存')) colorClass = 'text-amber-600';
                 else if(log.action.includes('歸檔')) colorClass = 'text-red-600';
                 
                 html += `
                    <div class="bg-white border border-slate-100 p-3 rounded-lg flex justify-between items-center text-sm">
                        <div>
                            <span class="font-bold ${colorClass} mr-2">${log.action}</span>
                            <span class="font-medium text-slate-800">${log.sampleName}</span>
                            <div class="text-xs text-slate-400 mt-1">${log.details || ''}</div>
                        </div>
                        <div class="text-right text-xs text-slate-500">
                            <div>${log.person}</div>
                            <div>${log.timestamp?.toDate().toLocaleString()}</div>
                        </div>
                    </div>
                 `;
             });
             html += '</div>';
             container.innerHTML = html;
        };
        
        window.renderSettingsUI = (config) => {
             const personListEl = document.getElementById('personList');
             personListEl.innerHTML = '';
             (config.personnel || []).forEach(person => {
                 const div = document.createElement('div');
                 div.className = 'flex justify-between items-center bg-slate-50 px-3 py-2 rounded-lg border border-slate-100';
                 div.innerHTML = `
                    <span class="text-slate-700 font-medium">${person}</span>
                    <button class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition delete-person-btn" data-person="${person}">
                        <i class="ph ph-trash"></i>
                    </button>
                 `;
                 personListEl.appendChild(div);
             });

             const cabinetSettingsEl = document.getElementById('cabinetSettings');
             cabinetSettingsEl.innerHTML = '';
             
             const layout = config.storageLayout || {};
             if (Object.keys(layout).length === 0) {
                 cabinetSettingsEl.innerHTML = '<p class="text-center text-slate-400 py-4">尚未設定任何櫃子</p>';
             }

             Object.entries(layout).forEach(([cabinetName, shelves]) => {
                 const cabDiv = document.createElement('div');
                 cabDiv.className = 'border border-slate-200 rounded-xl overflow-hidden mb-4';
                 
                 let headerHtml = `
                    <div class="bg-slate-100 p-4 flex justify-between items-center border-b border-slate-200">
                        <h5 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="ph ph-door-open text-slate-400"></i> ${cabinetName}
                        </h5>
                        <button class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg hover:bg-red-200 transition font-medium delete-cabinet-btn" data-cabinet="${cabinetName}">
                            刪除櫃子
                        </button>
                    </div>
                    <div class="p-4 bg-white space-y-3">
                 `;
                 
                 const shelfItems = Object.keys(shelves).map(shelfName => `
                    <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg border border-slate-100">
                        <span class="text-sm font-medium text-slate-700 flex-1 truncate" title="${shelfName}">${shelfName}</span>
                        <button class="text-slate-400 hover:text-red-500 p-1 delete-shelf-btn" data-cabinet="${cabinetName}" data-shelf="${shelfName}" title="刪除此層">
                            <i class="ph ph-x-circle text-lg"></i>
                        </button>
                    </div>
                 `).join('');
                 
                 headerHtml += shelfItems;
                 
                 headerHtml += `
                        <div class="flex gap-2 mt-4 pt-3 border-t border-slate-100">
                            <input type="text" placeholder="新層名稱 (如: 第1層)" class="flex-1 px-3 py-1.5 border border-slate-300 rounded text-sm new-shelf-name">
                            <input type="hidden" value="0" class="new-shelf-capacity">
                            <button class="bg-slate-800 text-white px-3 py-1.5 rounded text-sm hover:bg-slate-900 add-shelf-btn" data-cabinet="${cabinetName}">新增層</button>
                        </div>
                    </div>
                 `;
                 
                 cabDiv.innerHTML = headerHtml;
                 cabinetSettingsEl.appendChild(cabDiv);
             });
        };

    </script>
</body>
</html>