<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>樣品庫存管理系統 v2.9.18 (自訂版面)</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- QR Code & Zipping Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="text/javascript" src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-visible { opacity: 1; pointer-events: auto; }
        .modal-content-hidden { transform: scale(0.95) translateY(10px); opacity: 0; }
        .modal-content-visible { transform: scale(1) translateY(0); opacity: 1; }
        .drawer-backdrop { transition: opacity 0.3s ease; }
        .drawer-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer-hidden { pointer-events: none; }
        .drawer-hidden .drawer-backdrop { opacity: 0; }
        .drawer-hidden .drawer-panel { transform: translateX(100%); }
        .drawer-visible { pointer-events: auto; }
        .drawer-visible .drawer-backdrop { opacity: 1; }
        .drawer-visible .drawer-panel { transform: translateX(0); }
        .slot-card { transition: all 0.2s ease; }
        .slot-occupied:hover { border-color: #6366f1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .slot-occupied.selected { border-color: #6366f1; background-color: #e0e7ff; }
        .table-row-hover:hover { background-color: #f1f5f9; }
        .custom-tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; position: absolute; z-index: 50; }
        .has-tooltip:hover .custom-tooltip { visibility: visible; opacity: 1; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #ef4444; box-shadow: 0 0 4px #ef4444; top: 0; left: 0; animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .selection-bar-hidden { transform: translateY(100%); }
        .selection-bar-visible { transform: translateY(0); }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .scan-feedback { animation: fadeOut 1.5s forwards ease-out; }
        @keyframes fadeOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(1.1); } }
        .rfid-focus-ring { animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { border-color: rgba(168, 85, 247, 0.5); box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); } 70% { border-color: rgba(168, 85, 247, 0); box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); } 100% { border-color: rgba(168, 85, 247, 0); box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); } }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #f1f5f9; }
        
        /* Print Styles */
        @media print {
            @page { size: landscape; margin: 10mm; }
            body * { visibility: hidden; }
            #report-print-container, #report-print-container * { visibility: visible; }
            #report-print-container { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen w-screen flex flex-col md:flex-row">

    <input id="rfidHiddenInput" type="text" class="absolute opacity-0 -z-10 h-0 w-0" autocomplete="off">

    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-64 bg-slate-900 text-white border-r border-slate-800 z-20 shadow-xl">
        <div class="p-6 flex items-center gap-3 border-b border-slate-800">
            <div class="bg-indigo-500 p-2 rounded-lg"><i class="ph ph-cube text-xl text-white"></i></div>
            <h1 class="text-lg font-bold tracking-wide">庫存管理系統</h1>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <button id="nav-inventory" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-indigo-600 text-white shadow-md transition-colors"><i class="ph ph-squares-four text-xl"></i><span class="font-medium">庫存總覽</span></button>
            <button id="nav-rfid" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors"><i class="ph ph-wifi-high text-xl"></i><span class="font-medium">RFID 作業</span></button>
            <button id="nav-report" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors"><i class="ph ph-chart-bar text-xl"></i><span class="font-medium">庫存報表</span></button>
            <button id="nav-history" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors"><i class="ph ph-clock-counter-clockwise text-xl"></i><span class="font-medium">歷史紀錄</span></button>
            <button id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors"><i class="ph ph-gear text-xl"></i><span class="font-medium">系統設定</span></button>
        </nav>
        <div class="p-4 border-t border-slate-800"><div class="flex items-center gap-3 px-4 py-2"><div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300" id="user-avatar">U</div><div><p class="text-sm font-medium text-white" id="current-user-display">使用者</p><p class="text-xs text-slate-500">已連線</p></div></div></div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-6 shadow-sm z-10 shrink-0 gap-2">
            <div class="flex items-center gap-2 md:gap-4 flex-1">
                <div class="md:hidden bg-indigo-600 p-1.5 rounded text-white shrink-0"><i class="ph ph-cube text-lg"></i></div>
                <div class="relative w-full max-w-[200px]"><div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none"><i class="ph ph-user text-slate-500"></i></div><select id="globalOperatorSelect" class="bg-indigo-50 border border-indigo-200 text-indigo-900 text-sm font-bold rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-8 p-2.5 shadow-sm cursor-pointer"><option value="">請選擇操作人員...</option></select></div>
                
                <!-- Desktop Search Bar with Dropdown (Option A) -->
                <div id="top-search-bar" class="hidden md:flex items-center gap-2 w-full max-w-md">
                    <select id="globalSearchField" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-24 shrink-0 cursor-pointer shadow-sm">
                        <option value="sampleName" selected>品名</option>
                        <option value="all">全部</option>
                        <option value="wireDiameter">線徑</option>
                        <option value="manufacturer">廠商</option>
                        <option value="storageLocation">位置</option>
                        <option value="notes">備註</option>
                    </select>
                    <div class="relative w-full group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="ph ph-magnifying-glass text-slate-400"></i>
                        </div>
                        <input type="text" id="globalSearchInput" class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg leading-5 bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition duration-150 ease-in-out sm:text-sm shadow-sm" placeholder="搜尋...">
                    </div>
                </div>

            </div>
            <div class="flex items-center gap-2 md:gap-3 shrink-0">
                <button class="md:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-lg" onclick="document.getElementById('mobileSearchPanel').classList.toggle('hidden')"><i class="ph ph-magnifying-glass text-xl"></i></button>
                <div id="view-toggle-container" class="bg-slate-100 rounded-lg p-1 flex items-center border border-slate-200 hidden sm:flex"><button id="view-list-btn" class="p-1.5 rounded-md text-indigo-600 bg-white shadow-sm transition-all active-view-btn" title="清單模式"><i class="ph ph-list-dashes text-lg"></i></button><button id="view-grid-btn" class="p-1.5 rounded-md text-slate-500 hover:text-indigo-600 hover:bg-white transition-all" title="圖形模式"><i class="ph ph-squares-four text-lg"></i></button></div>
                <div class="h-6 w-px bg-slate-200 mx-1 hidden sm:block"></div>
                <button id="topActionScanBtn" class="bg-fuchsia-600 hover:bg-fuchsia-700 text-white p-2 rounded-lg shadow-sm transition-colors flex items-center gap-2"><i class="ph ph-arrows-left-right text-lg"></i><span class="hidden lg:inline font-medium text-sm">掃描異動</span></button>
                <button id="topScanBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg shadow-sm transition-colors flex items-center gap-2"><i class="ph ph-qr-code text-lg"></i><span class="hidden md:inline font-medium text-sm">搜尋</span></button>
                <button id="topAddBtn" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 p-2 rounded-lg shadow-sm transition-colors flex items-center gap-2"><i class="ph ph-plus text-lg"></i><span class="hidden md:inline font-medium text-sm">新增</span></button>
                <button id="cartDrawerBtn" class="relative p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2 border border-transparent hover:border-slate-200"><div class="relative"><i class="ph ph-tray text-xl"></i><span id="cart-badge" class="absolute -top-1.5 -right-1.5 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white opacity-0 transition-opacity">0</span></div><span class="hidden md:inline font-bold text-sm">暫存區</span></button>
            </div>
        </header>

        <!-- Mobile Search Panel with Dropdown -->
        <div id="mobileSearchPanel" class="hidden md:hidden bg-white p-4 border-b border-slate-200 absolute top-16 left-0 right-0 z-10 shadow-md flex gap-2">
            <select id="mobileSearchField" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-24 shrink-0">
                 <option value="sampleName" selected>品名</option>
                 <option value="all">全部</option>
                 <option value="wireDiameter">線徑</option>
                 <option value="manufacturer">廠商</option>
                 <option value="storageLocation">位置</option>
                 <option value="notes">備註</option>
            </select>
            <input type="text" id="mobileSearchInput" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="搜尋...">
        </div>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 no-scrollbar" id="main-scroll-area">
            <div id="page-header-inventory" class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"><div><h2 class="text-2xl font-bold text-slate-800">庫存總覽</h2><p class="text-slate-500 text-sm mt-1">管理與追蹤您的所有樣品</p></div><div class="flex items-center gap-3 w-full md:w-auto"><select id="cabinetFilter" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full md:w-48 p-2.5"><option value="all">所有櫃位</option></select></div></div>
            <div id="loader" class="flex flex-col items-center justify-center py-20 text-slate-500"><i class="ph ph-spinner animate-spin text-4xl text-indigo-600 mb-3"></i><p>正在同步資料庫...</p></div>

            <!-- Inventory View -->
            <div id="content-area-inventory" class="hidden pb-20"> 
                <div id="view-list" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm text-slate-600"><thead class="bg-slate-50 text-slate-700 uppercase font-semibold border-b border-slate-200"><tr><th class="w-10 px-4 py-4 text-center"><input type="checkbox" id="selectAllInventory" class="rounded text-indigo-600 focus:ring-indigo-500 w-4 h-4 cursor-pointer"></th><th class="px-6 py-4">樣品名稱</th><th class="px-6 py-4 sortable-header group" id="th-location">位置 <i class="ph ph-arrows-down-up inline-block ml-1 text-slate-400 group-hover:text-indigo-600"></i></th><th class="px-6 py-4">線徑</th><th class="px-6 py-4 hidden sm:table-cell">標準</th><th class="px-6 py-4 hidden md:table-cell">製造商</th><th class="px-6 py-4 hidden lg:table-cell">標籤狀態</th><th class="px-6 py-4 text-right">操作</th></tr></thead><tbody id="inventory-table-body" class="divide-y divide-slate-100"></tbody></table></div><div id="list-empty-state" class="hidden p-10 text-center text-slate-500"><i class="ph ph-magnifying-glass text-4xl mb-2 text-slate-300"></i><p>沒有符合條件的樣品</p></div></div>
                <div id="view-grid" class="hidden space-y-8"></div>
            </div>

            <!-- RFID View -->
            <div id="content-area-rfid" class="hidden h-full flex flex-col pb-20">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-wifi-high text-purple-600"></i> RFID 作業中心</h2><p class="text-slate-500 text-sm mt-1">請確保掃描槍已連接，點擊下方狀態卡以啟用掃描。</p></div><div class="bg-slate-200 p-1 rounded-lg flex text-sm font-medium"><button id="rfid-mode-search" class="px-4 py-1.5 rounded-md bg-white text-purple-700 shadow-sm transition-all" onclick="switchRfidMode('search')"><i class="ph ph-magnifying-glass"></i> 搜尋</button><button id="rfid-mode-bind" class="px-4 py-1.5 rounded-md text-slate-500 hover:text-purple-700 transition-all" onclick="switchRfidMode('bind')"><i class="ph ph-link"></i> 綁定</button><button id="rfid-mode-stocktake" class="px-4 py-1.5 rounded-md text-slate-500 hover:text-purple-700 transition-all" onclick="switchRfidMode('stocktake')"><i class="ph ph-clipboard-text"></i> 盤點</button></div></div>
                <div id="rfid-status-card" class="bg-white rounded-xl p-6 border-2 border-slate-200 cursor-pointer hover:border-purple-300 transition mb-6 shadow-sm flex items-center gap-4 relative overflow-hidden group"><div id="rfid-status-icon-bg" class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:scale-110 transition-transform"><i class="ph ph-barcode text-3xl"></i></div><div class="flex-1"><h3 id="rfid-status-title" class="text-lg font-bold text-slate-700">掃描器未就緒</h3><p id="rfid-status-desc" class="text-slate-500 text-sm">點擊此區域以啟用 RFID 接收模式</p></div><div class="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded border">HID Mode</div></div>
                <div id="rfid-view-search" class="flex-1 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50"><i class="ph ph-wifi-high text-6xl mb-4 opacity-20"></i><p class="text-lg font-medium">等待掃描...</p><p class="text-sm">直接掃描標籤以檢視樣品詳情</p></div>
                <div id="rfid-view-bind" class="hidden flex-1 flex flex-col md:flex-row gap-6 h-full overflow-hidden"><div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden"><div class="p-4 border-b border-slate-100 bg-slate-50"><h3 class="font-bold text-slate-700 mb-2">1. 選擇未綁定樣品</h3><input type="text" id="bind-search-input" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none" placeholder="搜尋名稱..."></div><div id="unbound-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div></div><div class="flex-1 bg-purple-50 rounded-xl border border-purple-100 flex flex-col items-center justify-center p-6 text-center"><div id="bind-step-2-inactive" class="opacity-50"><div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 mx-auto shadow-sm"><i class="ph ph-arrow-left text-3xl text-purple-300"></i></div><h3 class="font-bold text-purple-900 text-lg">2. 等待選擇</h3><p class="text-purple-600 text-sm mt-1">請先從左側選擇一個樣品</p></div><div id="bind-step-2-active" class="hidden w-full"><div class="bg-white p-6 rounded-xl shadow-lg border-2 border-purple-200 mb-6 max-w-sm mx-auto rfid-focus-ring"><h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-1">正在綁定</h4><h2 id="bind-target-name" class="text-2xl font-bold text-purple-700 mb-2">樣品名稱</h2><p id="bind-target-loc" class="text-slate-500 font-mono text-sm bg-slate-100 py-1 px-2 rounded inline-block">位置資訊</p></div><div class="animate-pulse"><i class="ph ph-wifi-high text-5xl text-purple-500 mb-2"></i><p class="font-bold text-purple-800">請掃描新的 RFID 標籤</p><button onclick="resetBindSelection()" class="mt-4 text-sm text-slate-400 hover:text-slate-600 underline">取消選取</button></div></div></div></div>
                <div id="rfid-view-stocktake" class="hidden flex-1 flex flex-col h-full overflow-hidden bg-white rounded-xl shadow-sm border border-slate-200"><div class="p-4 border-b border-slate-200 bg-slate-50 flex flex-wrap gap-4 items-end"><div class="flex-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">目標櫃位</label><div class="flex gap-2"><select id="stocktake-cabinet" class="w-full md:w-40 px-3 py-2 border border-slate-300 rounded-lg text-sm"></select><select id="stocktake-shelf" disabled class="w-full md:w-40 px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-100"></select></div></div><div class="flex gap-2"><button onclick="startStocktake()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 transition flex items-center gap-2"><i class="ph ph-play"></i> 開始盤點</button><button onclick="resetStocktake()" class="bg-white text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border border-slate-300 hover:bg-slate-50 transition">重置</button></div></div><div class="flex border-b border-slate-200 divide-x divide-slate-100 bg-white"><div class="flex-1 p-3 text-center"><div class="text-xs text-slate-500">應有數量</div><div id="st-count-expected" class="text-xl font-bold text-slate-800">0</div></div><div class="flex-1 p-3 text-center bg-green-50"><div class="text-xs text-green-600 font-bold">已掃描 (相符)</div><div id="st-count-scanned" class="text-xl font-bold text-green-700">0</div></div><div class="flex-1 p-3 text-center bg-red-50"><div class="text-xs text-red-600 font-bold">異常 (錯置/未知)</div><div id="st-count-error" class="text-xl font-bold text-red-700">0</div></div></div><div class="flex-1 overflow-y-auto p-0 bg-slate-50 relative"><div id="stocktake-list" class="divide-y divide-slate-200"><div class="p-8 text-center text-slate-400"><i class="ph ph-clipboard-text text-4xl mb-2 opacity-30"></i><p>請選擇櫃位並點擊「開始盤點」</p></div></div></div></div>
            </div>
        </main>

        <div id="inventory-selection-bar" class="fixed bottom-16 md:bottom-0 left-0 md:left-64 right-0 bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20 flex justify-between items-center p-4 selection-bar-hidden transition-transform duration-300 ease-in-out"><div class="flex items-center gap-3"><div class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold">已選取 <span id="inventory-selected-count">0</span> 項</div><button id="inventory-clear-selection" class="text-sm text-slate-500 hover:text-slate-800 hover:underline">取消全選</button></div><div class="flex items-center gap-2"><select id="inventoryBatchLabelSize" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2"><option value="40x40">40x40mm (方形)</option><option value="80x50">80x50mm (矩形)</option></select><button id="inventory-batch-download-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm flex items-center gap-2 transition"><i class="ph ph-download-simple text-lg"></i> <span class="hidden sm:inline">下載 QR</span></button></div></div>
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-30 pb-safe"><button id="mobile-nav-inventory" class="flex flex-col items-center justify-center w-full h-full text-indigo-600"><i class="ph ph-squares-four text-2xl"></i><span class="text-[10px] font-medium mt-1">庫存</span></button><button id="mobile-nav-rfid" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-purple-600"><i class="ph ph-wifi-high text-2xl"></i><span class="text-[10px] font-medium mt-1">RFID</span></button><button id="mobile-nav-add" class="flex flex-col items-center justify-center w-full h-full -mt-6"><div class="bg-indigo-600 rounded-full p-4 shadow-lg text-white transform hover:scale-105 transition"><i class="ph ph-plus text-2xl"></i></div></button><button id="mobile-nav-scan-action" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-fuchsia-600"><i class="ph ph-arrows-left-right text-2xl"></i><span class="text-[10px] font-medium mt-1">異動</span></button><button id="mobile-nav-settings" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600"><i class="ph ph-gear text-2xl"></i><span class="text-[10px] font-medium mt-1">設定</span></button></nav>
    </div>

    <!-- Drawer, Modals... -->
    <div id="stagingDrawer" class="fixed inset-0 z-40 drawer-hidden flex justify-end"><div class="drawer-backdrop absolute inset-0 bg-slate-900/50 backdrop-blur-sm" id="drawerBackdrop"></div><div class="drawer-panel relative bg-white w-full max-w-md h-full shadow-2xl flex flex-col"><div class="p-5 border-b border-slate-200 flex justify-between items-center bg-indigo-50"><div class="flex items-center gap-2"><i class="ph ph-tray text-indigo-600 text-xl"></i><h3 class="font-bold text-lg text-slate-800">暫存區 (Staging)</h3></div><button id="closeDrawerBtn" class="text-slate-500 hover:text-slate-800 p-1 rounded-full hover:bg-indigo-100 transition"><i class="ph ph-x text-xl"></i></button></div><div class="flex-1 overflow-y-auto p-4 bg-slate-50" id="staging-drawer-content"><div id="drawer-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400"><div class="bg-slate-100 p-4 rounded-full mb-3"><i class="ph ph-tray text-4xl text-slate-300"></i></div><p>暫存區是空的</p><p class="text-xs mt-1 text-slate-400">從庫存中將樣品移入此處進行操作</p></div><div id="staging-list" class="space-y-3"></div></div><div id="drawer-footer" class="p-4 border-t border-slate-200 bg-white hidden"><div class="flex justify-between items-center mb-3"><span class="text-sm text-slate-500">已選取 <span id="staging-selected-count" class="font-bold text-slate-800">0</span> 項</span><button id="staging-select-all" class="text-xs text-indigo-600 font-medium hover:underline">全選</button></div><div class="grid grid-cols-2 gap-2 mb-2"><button id="batch-return-btn" class="flex flex-col items-center justify-center py-2 px-1 rounded-lg bg-emerald-100 text-emerald-700 font-semibold hover:bg-emerald-200 transition text-[10px] md:text-xs"><i class="ph ph-arrow-u-up-left text-lg mb-0.5"></i> 批次放回</button><button id="batch-archive-btn" class="flex flex-col items-center justify-center py-2 px-1 rounded-lg bg-red-100 text-red-700 font-semibold hover:bg-red-200 transition text-[10px] md:text-xs"><i class="ph ph-archive-box text-lg mb-0.5"></i> 批次歸檔</button></div><div class="flex gap-2"><select id="stagingBatchLabelSize" class="bg-slate-50 border border-slate-300 text-slate-700 text-xs rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2 flex-1"><option value="40x40">40x40mm (方形)</option><option value="80x50">80x50mm (矩形)</option></select><button id="batch-qr-btn" class="flex-1 flex items-center justify-center gap-1 py-2 px-2 rounded-lg bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200 transition text-xs border border-slate-200"><i class="ph ph-download-simple text-lg"></i> 批次 QR</button></div></div></div></div>
    
    <!-- All Modals (Hidden by default) -->
    <div id="addSampleModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 modal-content modal-content-hidden flex flex-col max-h-[90vh]"><div class="flex justify-between items-center p-5 border-b border-slate-100"><h3 class="text-xl font-bold text-slate-800">新增樣品</h3><button class="close-modal-btn text-slate-400 hover:text-slate-600"><i class="ph ph-x text-2xl"></i></button></div><div class="p-6 overflow-y-auto"><form id="add-sample-form" class="space-y-5"><div class="grid grid-cols-1 md:grid-cols-2 gap-5"><div class="col-span-1 md:col-span-2"><label class="block text-sm font-medium text-slate-700 mb-1">樣品名稱 <span class="text-red-500">*</span></label><div class="flex gap-2"><input type="text" id="sampleName" required class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="輸入或掃描"><button type="button" id="scanInputQrBtn" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 transition"><i class="ph ph-qr-code text-xl"></i></button></div></div><div><label class="block text-sm font-medium text-slate-700 mb-1">線徑 <span class="text-red-500">*</span></label><input type="text" id="wireDiameter" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></div><div><label class="block text-sm font-medium text-slate-700 mb-1">適用標準</label><input type="text" id="applicableStandard" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></div></div><div class="p-4 bg-slate-50 rounded-lg border border-slate-100"><h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">存放位置</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><select id="storageCabinet" required class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"></select><select id="storageShelf" required disabled class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-100"></select></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm"><div><label class="block mb-1 text-slate-500">製造商</label><input type="text" id="manufacturer" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div><div><label class="block mb-1 text-slate-500">配方代號</label><input type="text" id="formulaCode" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div><div><label class="block mb-1 text-slate-500">批號</label><input type="text" id="batchNo" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div><div><label class="block mb-1 text-slate-500">爐號</label><input type="text" id="furnaceNo" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div><div class="md:col-span-2"><label class="block mb-1 text-slate-500">製程明細</label><input type="text" id="processDetails" class="w-full px-3 py-2 border border-slate-300 rounded-lg"></div><div class="md:col-span-3"><label class="block mb-1 text-slate-500">備註</label><textarea id="notes" class="w-full px-3 py-2 border border-slate-300 rounded-lg" rows="2"></textarea></div></div><div class="flex justify-end pt-2"><button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2.5 rounded-lg shadow-lg hover:bg-indigo-700 transition transform active:scale-95">確認存入</button></div></form></div></div></div>
    <div id="qrScannerModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-4 modal-content modal-content-hidden flex flex-col relative overflow-hidden"><div class="flex justify-between items-center mb-4 shrink-0"><h3 id="qrScannerTitle" class="text-lg font-bold">掃描 QR Code</h3><button class="close-scanner-btn text-slate-500"><i class="ph ph-x text-xl"></i></button></div><div class="relative w-full aspect-square rounded-lg overflow-hidden bg-black"><div id="qr-reader" class="w-full h-full"></div><div class="absolute inset-0 z-10 pointer-events-none flex items-center justify-center"><div class="w-2/3 h-2/3 border-2 border-white/40 rounded-xl relative shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]"><div class="absolute top-0 left-0 w-8 h-8 border-l-4 border-t-4 border-indigo-500 -mt-1 -ml-1 rounded-tl-sm"></div><div class="absolute top-0 right-0 w-8 h-8 border-r-4 border-t-4 border-indigo-500 -mt-1 -mr-1 rounded-tr-sm"></div><div class="absolute bottom-0 left-0 w-8 h-8 border-l-4 border-b-4 border-indigo-500 -mb-1 -ml-1 rounded-bl-sm"></div><div class="absolute bottom-0 right-0 w-8 h-8 border-r-4 border-b-4 border-indigo-500 -mb-1 -mr-1 rounded-br-sm"></div><div class="scan-line"></div></div></div><div id="scanFeedbackOverlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/70 hidden"><i class="ph ph-check-circle text-6xl text-green-500 mb-2"></i><p id="scanFeedbackText" class="text-white font-bold text-xl text-center px-4"></p></div></div><div class="mt-4 flex flex-col gap-3 shrink-0"><div id="continuousModeControl" class="flex items-center justify-between bg-slate-100 p-3 rounded-lg"><div class="flex flex-col"><span class="text-sm font-bold text-slate-800">連續掃描模式</span><span class="text-xs text-slate-500">掃描後自動執行，不跳出確認視窗</span></div><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="continuousModeToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300 ease-in-out"/><label for="continuousModeToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label></div></div><div class="text-center text-sm text-slate-500"><p id="scanInstructionText">將 40x40mm 標籤置於框內</p><div id="scanModeIndicator" class="mt-2 inline-block px-3 py-1 bg-slate-100 rounded-full text-xs font-mono">模式: 一般搜尋</div></div></div></div></div>
    <div id="qrDisplayModal" class="fixed inset-0 z-[70] flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6 modal-content modal-content-hidden flex flex-col items-center"><div class="w-full flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800">標籤預覽</h3><button class="close-modal-btn text-slate-400 hover:text-slate-600"><i class="ph ph-x text-2xl"></i></button></div><div class="w-full mb-4"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">標籤規格</label><select id="qrLabelSize" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50"><option value="40x40">40x40mm (方形)</option><option value="80x50">80x50mm (矩形)</option></select></div><div id="qrDisplayArea" class="mb-4 p-2 bg-slate-100 border border-slate-200 rounded-xl flex items-center justify-center overflow-hidden w-full h-64"></div><div class="w-full"><a id="qrDownloadLink" class="flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition cursor-pointer w-full shadow-lg"><i class="ph ph-download-simple text-lg"></i> 下載圖片</a></div></div></div>
    <div id="notification-toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 md:bottom-10 md:left-auto md:right-10 md:translate-x-0 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl z-[70] transition-all duration-300 opacity-0 translate-y-10 flex items-center gap-3"><i class="ph ph-info text-indigo-400 text-lg"></i><span id="notification-message" class="font-medium">Notification</span></div>
    <div id="reportModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl mx-4 h-[80vh] flex flex-col modal-content modal-content-hidden"><div class="p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg text-slate-800">庫存報表</h3><button class="close-modal-btn text-slate-500 hover:text-slate-700 p-2 rounded-full hover:bg-slate-100 transition"><i class="ph ph-x text-xl"></i></button></div><div id="reportContent" class="flex-1 overflow-auto p-4"></div><div class="p-4 border-t bg-slate-50 flex justify-end gap-2"><button id="downloadCsvBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">CSV</button><button id="printReportBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">列印報表</button></div></div></div>
    <div id="historyModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl mx-4 h-[80vh] flex flex-col modal-content modal-content-hidden"><div class="p-4 border-b flex justify-between"><h3 class="font-bold">歷史紀錄</h3><button class="close-modal-btn"><i class="ph ph-x text-xl"></i></button></div><div class="p-4 flex gap-2 border-b overflow-x-auto" id="history-tabs-container"><!-- tabs --></div><div id="history-content-container" class="flex-1 overflow-auto p-4"></div></div></div>
    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl mx-4 h-[80vh] flex flex-col modal-content modal-content-hidden"><div class="p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg text-slate-800">系統設定</h3><button class="close-modal-btn text-slate-500 hover:text-slate-700"><i class="ph ph-x text-xl"></i></button></div><div class="flex-1 overflow-auto p-6 bg-slate-50"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6"><h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph ph-users text-indigo-500"></i> 人員管理</h4><div class="flex gap-2 mb-4"><input type="text" id="newPersonName" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="輸入人員姓名"><button id="addPersonBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700 transition font-medium">新增人員</button></div><div id="personList" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="ph ph-lockers text-indigo-500"></i> 櫃位配置</h4><div class="flex gap-2 mb-6 p-4 bg-slate-50 rounded-lg border border-slate-100"><input type="text" id="newCabinetName" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="輸入新櫃子名稱 (例如: A櫃)"><button id="addCabinetBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-emerald-700 transition font-medium">新增櫃子</button></div><div id="cabinetSettings" class="space-y-4"></div></div></div><div class="p-4 border-t bg-white flex justify-end gap-3"><button id="closeSettingsBtn" class="px-5 py-2.5 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 transition font-medium">取消</button><button id="saveSettingsBtn" class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition font-medium">儲存設定</button></div></div></div>
    <div id="actionModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-xl shadow-lg w-96 p-6 modal-content modal-content-hidden"><h3 id="actionModalTitle" class="font-bold text-lg mb-2">Title</h3><p id="actionModalMessage" class="text-slate-600 mb-4">Message</p><form id="actionForm"><input type="hidden" id="actionSampleId"><input type="hidden" id="actionType"><div id="remarksContainer" class="hidden mb-4"><label class="block text-xs text-slate-500 mb-1">備註</label><textarea id="actionRemarks" class="w-full border rounded p-2"></textarea></div><div class="flex justify-end gap-2"><button type="button" class="close-modal-btn px-4 py-2 bg-slate-100 rounded text-slate-600">取消</button><button type="submit" id="actionConfirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">確認</button></div></form></div></div>
    <div id="confirmationModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-xl shadow-lg w-80 p-6 modal-content modal-content-hidden"><h3 id="confirmationTitle" class="font-bold text-lg mb-2">確認</h3><p id="confirmationMessage" class="text-slate-600 mb-4">Content</p><div class="flex justify-end gap-2"><button id="confirmCancelBtn" class="px-4 py-2 bg-slate-100 rounded">取消</button><button id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white rounded">確認</button></div></div></div>
    <div id="sampleDetailModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl mx-4 modal-content modal-content-hidden flex flex-col max-h-[90vh]"><div class="p-4 border-b flex justify-between"><h3 class="font-bold">詳細資訊</h3><button class="close-modal-btn"><i class="ph ph-x text-xl"></i></button></div><div id="sampleDetailContent" class="flex-1 overflow-auto p-6"></div><div id="sampleDetailFooter" class="p-4 border-t bg-slate-50 flex justify-end gap-2"></div></div></div>
    <div id="editSampleModal" class="fixed inset-0 z-[55] flex items-center justify-center modal-backdrop modal-hidden"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 modal-content modal-content-hidden flex flex-col max-h-[90vh]"><div class="p-4 border-b flex justify-between"><h3 class="font-bold">修改樣品</h3><button class="close-modal-btn"><i class="ph ph-x text-xl"></i></button></div><div class="flex-1 overflow-auto p-6"><form id="edit-sample-form" class="space-y-4"><input type="hidden" id="editSampleId"><input type="hidden" id="editSampleCollection"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm">名稱</label><input type="text" id="editSampleName" class="w-full border rounded p-2"></div><div><label class="block text-sm">線徑</label><input type="text" id="editWireDiameter" class="w-full border rounded p-2"></div></div><div class="p-4 bg-amber-50 rounded-lg border border-amber-100"><label class="block text-xs font-bold text-amber-700 uppercase tracking-wider mb-2">更改位置 (慎選)</label><div class="grid grid-cols-2 gap-3"><select id="editStorageCabinet" class="w-full px-3 py-2 border border-amber-200 rounded-lg text-sm bg-white"></select><select id="editStorageShelf" disabled class="w-full px-3 py-2 border border-amber-200 rounded-lg text-sm bg-slate-100"></select></div></div><div class="p-3 bg-slate-50 rounded text-sm grid grid-cols-2 gap-3"><input type="text" id="editApplicableStandard" placeholder="標準" class="border rounded p-2"><input type="text" id="editManufacturer" placeholder="製造商" class="border rounded p-2"><input type="text" id="editFormulaCode" placeholder="配方" class="border rounded p-2"><input type="text" id="editProcessDetails" placeholder="製程" class="border rounded p-2"><input type="text" id="editFurnaceNo" placeholder="爐號" class="border rounded p-2"><input type="text" id="editBatchNo" placeholder="批號" class="border rounded p-2"><textarea id="editNotes" placeholder="備註" class="col-span-2 border rounded p-2" rows="2"></textarea></div><div class="flex justify-end pt-2"><button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded">儲存</button></div></form></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, serverTimestamp, deleteDoc, query, writeBatch, getDoc, updateDoc, orderBy, limit, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCDLS5yzP9yMeyhGJMePFCCUwpKpob6S84", authDomain: "rdspools-6dc53.firebaseapp.com", projectId: "rdspools-6dc53", storageBucket: "rdspools-6dc53.appspot.com", messagingSenderId: "1052447565403", appId: "1:1052447565403:web:23498fc330636ecb38817e", measurementId: "G-6DYX4YRN7D" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Variables
        let currentPage = 'inventory'; 
        let currentViewMode = 'list';
        let systemConfig = {}, sampleInventory = [], stagingSamples = [], historyLog = [];
        let tempSystemConfig = {};
        let html5QrCode = null; 
        let isScannerRunning = false; 
        let selectedStagingIds = new Set(); 
        let selectedInventoryIds = new Set();
        let currentQrSample = null;
        let isContinuousProcessing = false;
        let lastScannedCode = null;
        let lastScanTime = 0;
        let rfidMode = 'search'; 
        let bindTargetId = null;
        let isRfidFocused = false;
        let stocktakeState = { active: false, targetLocation: null, isCabinetMode: false, expectedItems: [], scannedItems: new Set(), intruders: [] };
        let sortState = { column: 'storageLocation', direction: 'asc' };
        let pendingConfirmCallback = null;

        const dom = {
            contentInventory: document.getElementById('content-area-inventory'),
            contentRfid: document.getElementById('content-area-rfid'),
            navInv: document.getElementById('nav-inventory'),
            navRfid: document.getElementById('nav-rfid'),
            mobileNavInv: document.getElementById('mobile-nav-inventory'),
            mobileNavRfid: document.getElementById('mobile-nav-rfid'),
            rfidStatusCard: document.getElementById('rfid-status-card'),
            rfidStatusIconBg: document.getElementById('rfid-status-icon-bg'),
            rfidStatusTitle: document.getElementById('rfid-status-title'),
            rfidStatusDesc: document.getElementById('rfid-status-desc'),
            rfidViewSearch: document.getElementById('rfid-view-search'),
            rfidViewBind: document.getElementById('rfid-view-bind'),
            rfidViewStocktake: document.getElementById('rfid-view-stocktake'),
            rfidBtnSearch: document.getElementById('rfid-mode-search'),
            rfidBtnBind: document.getElementById('rfid-mode-bind'),
            rfidBtnStocktake: document.getElementById('rfid-mode-stocktake'),
            unboundList: document.getElementById('unbound-list'),
            bindSearchInput: document.getElementById('bind-search-input'),
            stCabinet: document.getElementById('stocktake-cabinet'),
            stShelf: document.getElementById('stocktake-shelf'),
            stCountExpected: document.getElementById('st-count-expected'),
            stCountScanned: document.getElementById('st-count-scanned'),
            stCountError: document.getElementById('st-count-error'),
            stList: document.getElementById('stocktake-list'),
            globalSearch: document.getElementById('globalSearchInput'),
            topSearchBar: document.getElementById('top-search-bar'),
            viewToggle: document.getElementById('view-toggle-container')
        };

        const modals = {
            addSample: document.getElementById('addSampleModal'),
            report: document.getElementById('reportModal'),
            history: document.getElementById('historyModal'),
            settings: document.getElementById('settingsModal'),
            qrScanner: document.getElementById('qrScannerModal'),
            qrDisplay: document.getElementById('qrDisplayModal'), 
            action: document.getElementById('actionModal'),
            confirmation: document.getElementById('confirmationModal'),
            sampleDetail: document.getElementById('sampleDetailModal'),
            editSample: document.getElementById('editSampleModal')
        };

        // --- All Function Definitions (Hoisted) ---

        // Utils
        function openModal(modal) {
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            modal.querySelector('.modal-content').classList.remove('modal-content-hidden');
            modal.querySelector('.modal-content').classList.add('modal-content-visible');
        }

        function closeModal(modal) {
             if(modal.classList.contains('modal-backdrop')) {
                modal.querySelector('.modal-content').classList.add('modal-content-hidden');
                setTimeout(() => {
                    modal.classList.add('modal-hidden');
                    modal.classList.remove('modal-visible');
                }, 300);
             }
        }
        // !!! CRITICAL FIX: Expose closeModal to window scope for inline HTML calls
        window.closeModal = closeModal;

        function openConfirmation(title, message, callback) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            pendingConfirmCallback = callback;
            openModal(modals.confirmation);
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('notification-toast');
            const msgEl = document.getElementById('notification-message');
            const iconEl = toast.querySelector('i');
            msgEl.textContent = msg;
            if (type === 'success') iconEl.className = 'ph ph-check-circle text-green-400 text-lg';
            else if (type === 'error') iconEl.className = 'ph ph-x-circle text-red-400 text-lg';
            else if (type === 'bind') iconEl.className = 'ph ph-link text-purple-400 text-lg';
            else iconEl.className = 'ph ph-info text-indigo-400 text-lg';
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        function playSound(type) {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'success') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                } else if (type === 'bind') { 
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
                    gain.gain.setValueAtTime(0.1, now); 
                    osc.start(now); osc.stop(now + 0.1);
                    setTimeout(() => {
                        const o2 = ctx.createOscillator(); const g2 = ctx.createGain();
                        o2.connect(g2); g2.connect(ctx.destination);
                        o2.frequency.setValueAtTime(1200, ctx.currentTime);
                        g2.gain.setValueAtTime(0.1, ctx.currentTime); g2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                        o2.start(); o2.stop(ctx.currentTime + 0.1);
                    }, 150);
                } else if (type === 'error') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now);
                    gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.3);
                } else {
                    osc.frequency.value = 1200; gain.gain.value = 0.1; osc.start(); osc.stop(ctx.currentTime + 0.15);
                }
            } catch (e) {}
        }

        async function logAction(action, person, sampleName, details) {
            await addDoc(collection(db, 'sampleSystem/data/history'), {
                action, person: person || "未知", sampleName, details, timestamp: serverTimestamp()
            });
        }

        function getCurrentOperator() { return document.getElementById('globalOperatorSelect').value || '未知'; }
        
        function updateGlobalOperatorOptions() {
            const sel = document.getElementById('globalOperatorSelect');
            if (!sel) return;
            const val = sel.value;
            sel.innerHTML = '<option value="">請選擇操作人員...</option>';
            (systemConfig.personnel || []).forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            if(val) sel.value = val;
        }

        function updateAddFormSelects() {
            const sel = document.getElementById('storageCabinet');
            if (!sel) return;
            sel.innerHTML = '<option value="">選擇櫃子</option>';
            Object.keys(systemConfig.storageLayout || {}).forEach(k => sel.innerHTML += `<option value="${k}">${k}</option>`);
        }

        function switchPage(page) {
            currentPage = page;
            const activeClass = "bg-indigo-600 text-white shadow-md";
            const inactiveClass = "text-slate-400 hover:text-white hover:bg-slate-800";
            const mobileActive = "text-indigo-600";
            const mobileInactive = "text-slate-400";
            const mobileActiveRfid = "text-purple-600";

            dom.navInv.className = `w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${page === 'inventory' ? activeClass : inactiveClass}`;
            dom.navRfid.className = `w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${page === 'rfid' ? 'bg-purple-600 text-white shadow-md' : inactiveClass}`;
            dom.mobileNavInv.className = `flex flex-col items-center justify-center w-full h-full ${page === 'inventory' ? mobileActive : mobileInactive}`;
            dom.mobileNavRfid.className = `flex flex-col items-center justify-center w-full h-full ${page === 'rfid' ? mobileActiveRfid : mobileInactive}`;

            const qrButtons = [ document.getElementById('topActionScanBtn'), document.getElementById('topScanBtn'), document.getElementById('mobile-nav-scan-action') ];

            if (page === 'inventory') {
                dom.contentInventory.classList.remove('hidden');
                dom.contentRfid.classList.add('hidden');
                // dom.topSearchBar.classList.remove('hidden'); // Logic changed for flex
                if(window.innerWidth >= 768) document.getElementById('top-search-bar').style.display = 'flex';
                dom.viewToggle.classList.remove('hidden');
                document.getElementById('page-header-inventory').classList.remove('hidden');
                qrButtons.forEach(btn => btn && btn.classList.remove('hidden'));
            } else {
                dom.contentInventory.classList.add('hidden');
                dom.contentRfid.classList.remove('hidden');
                // dom.topSearchBar.classList.add('hidden');
                document.getElementById('top-search-bar').style.display = 'none';
                dom.viewToggle.classList.add('hidden');
                document.getElementById('page-header-inventory').classList.add('hidden');
                qrButtons.forEach(btn => btn && btn.classList.add('hidden'));
                stopScanner();
                if (rfidMode === 'bind') renderRfidUnboundList();
                if (rfidMode === 'stocktake') initStocktakeUI();
                document.getElementById('rfidHiddenInput').focus();
            }
        }
        // !!! CRITICAL FIX: Expose switchPage
        window.switchPage = switchPage;

        function getFilteredInventory() {
            // Updated Search Logic for Option A
            
            // Determine active search input (Desktop or Mobile)
            let query = '';
            let field = 'sampleName';
            
            const desktopInput = document.getElementById('globalSearchInput');
            const desktopField = document.getElementById('globalSearchField');
            const mobileInput = document.getElementById('mobileSearchInput');
            const mobileField = document.getElementById('mobileSearchField');

            if (window.innerWidth < 768 && mobileInput && mobileInput.value.trim() !== '') {
                 query = mobileInput.value.toLowerCase().trim();
                 field = mobileField.value;
            } else if (desktopInput) {
                 query = desktopInput.value.toLowerCase().trim();
                 field = desktopField.value;
            }

            const cabFilter = document.getElementById('cabinetFilter');
            const cabinet = cabFilter ? cabFilter.value : 'all';

            let data = sampleInventory.filter(s => {
                let matchText = false;
                if (!query) {
                    matchText = true;
                } else if (field === 'all') {
                    // Full text search
                    matchText = Object.values(s).join(' ').toLowerCase().includes(query) || (s.epc && s.epc.toLowerCase().includes(query));
                } else {
                    // Specific field search
                    const val = s[field] ? String(s[field]).toLowerCase() : '';
                    matchText = val.includes(query);
                }
                
                const matchCabinet = cabinet === 'all' || (!cabinet) || s.storageLocation.startsWith(cabinet);
                return matchText && matchCabinet;
            });

            if (sortState.column === 'storageLocation') {
                data.sort((a, b) => {
                    const valA = a.storageLocation || '';
                    const valB = b.storageLocation || '';
                    return sortState.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                });
            }
            return data;
        }

        function updateSelectionBar() {
            const count = selectedInventoryIds.size;
            document.getElementById('inventory-selected-count').textContent = count;
            const bar = document.getElementById('inventory-selection-bar');
            if (count > 0) {
                bar.classList.remove('selection-bar-hidden');
                bar.classList.add('selection-bar-visible');
            } else {
                bar.classList.add('selection-bar-hidden');
                bar.classList.remove('selection-bar-visible');
            }
        }

        function renderInventory() {
            const data = getFilteredInventory();
            const tbody = document.getElementById('inventory-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            const emptyState = document.getElementById('list-empty-state');
            if (data.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
            } else {
                if(emptyState) emptyState.classList.add('hidden');
                data.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-slate-100 hover:bg-slate-50 transition-colors group table-row-hover';
                    const hasRfid = !!s.epc;
                    tr.innerHTML = `<td class="px-4 py-4 text-center"><input type="checkbox" class="rounded text-indigo-600 w-4 h-4 cursor-pointer inventory-checkbox" data-id="${s.id}" ${selectedInventoryIds.has(s.id) ? 'checked' : ''}></td><td class="px-6 py-4 font-medium text-slate-900 group-hover:text-indigo-600 cursor-pointer nav-detail">${s.sampleName}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded bg-slate-100 text-xs font-mono text-slate-600 border border-slate-200">${s.storageLocation.replace('位置 ', '')}</span></td><td class="px-6 py-4 text-slate-500">${s.wireDiameter || '-'}</td><td class="px-6 py-4 hidden sm:table-cell text-slate-500">${s.applicableStandard || '-'}</td><td class="px-6 py-4 hidden md:table-cell text-slate-500">${s.manufacturer || '-'}</td><td class="px-6 py-4 hidden lg:table-cell">${hasRfid ? '<span class="inline-flex items-center gap-1 bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100 text-xs font-bold"><i class="ph ph-wifi-high"></i> RFID</span>' : '<span class="inline-flex items-center gap-1 bg-slate-50 text-slate-400 px-2 py-1 rounded border border-slate-100 text-xs">無標籤</span>'}</td><td class="px-6 py-4 text-right"><button class="text-slate-400 hover:text-indigo-600 p-1.5 rounded-full hover:bg-indigo-50 transition quick-stage-btn" title="移至暫存" data-id="${s.id}"><i class="ph ph-tray text-xl"></i></button></td>`;
                    tr.querySelector('.nav-detail').addEventListener('click', () => showSampleDetails(s));
                    tr.querySelector('.quick-stage-btn').addEventListener('click', (e) => { e.stopPropagation(); openActionModal('stage', s); });
                    const cb = tr.querySelector('.inventory-checkbox');
                    cb.addEventListener('change', (e) => {
                        if (e.target.checked) selectedInventoryIds.add(s.id);
                        else selectedInventoryIds.delete(s.id);
                        updateSelectionBar();
                    });
                    tbody.appendChild(tr);
                });
            }
        }

        function renderStagingDrawer() {
            const list = document.getElementById('staging-list');
            const empty = document.getElementById('drawer-empty-state');
            const footer = document.getElementById('drawer-footer');
            const badge = document.getElementById('cart-badge');
            if (!list) return;
            list.innerHTML = '';
            if (stagingSamples.length === 0) {
                empty.classList.remove('hidden'); footer.classList.add('hidden'); list.classList.add('hidden');
                badge.style.opacity = '0';
            } else {
                empty.classList.add('hidden'); footer.classList.remove('hidden'); list.classList.remove('hidden');
                badge.style.opacity = '1'; badge.textContent = stagingSamples.length;
                stagingSamples.forEach(s => {
                    const div = document.createElement('div');
                    div.className = "p-3 rounded-lg border border-slate-200 bg-white hover:border-indigo-300 transition flex gap-3";
                    div.innerHTML = `<div class="pt-1"><input type="checkbox" class="rounded text-indigo-600 w-4 h-4 cursor-pointer"></div><div class="flex-1 min-w-0"><h4 class="text-sm font-bold text-slate-800 truncate">${s.sampleName}</h4><p class="text-xs text-slate-500 truncate">原位: ${s.storageLocation}</p><div class="mt-1 flex gap-2"><button class="text-[10px] bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded border border-emerald-100 hover:bg-emerald-100 action-return">放回</button><button class="text-[10px] bg-red-50 text-red-600 px-2 py-0.5 rounded border border-red-100 hover:bg-red-100 action-archive">歸檔</button></div></div>`;
                    div.querySelector('.action-return').onclick = () => openActionModal('return', s);
                    div.querySelector('.action-archive').onclick = () => openActionModal('finalize', s);
                    list.appendChild(div);
                });
                document.getElementById('staging-selected-count').textContent = '0';
            }
        }

        function renderSettingsUI(config) {
             const personListEl = document.getElementById('personList');
             personListEl.innerHTML = '';
             (config.personnel || []).forEach(person => {
                 const div = document.createElement('div');
                 div.className = 'flex justify-between items-center bg-slate-50 px-3 py-2 rounded-lg border border-slate-100';
                 div.innerHTML = `<span class="text-slate-700 font-medium">${person}</span><button class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 transition delete-person-btn" data-person="${person}"><i class="ph ph-trash"></i></button>`;
                 personListEl.appendChild(div);
             });
             const cabinetSettingsEl = document.getElementById('cabinetSettings');
             cabinetSettingsEl.innerHTML = '';
             const layout = config.storageLayout || {};
             if (Object.keys(layout).length === 0) cabinetSettingsEl.innerHTML = '<p class="text-center text-slate-400 py-4">尚未設定任何櫃子</p>';
             Object.entries(layout).forEach(([cabinetName, shelves]) => {
                 const cabDiv = document.createElement('div');
                 cabDiv.className = 'border border-slate-200 rounded-xl overflow-hidden mb-4';
                 let headerHtml = `<div class="bg-slate-100 p-4 flex justify-between items-center border-b border-slate-200"><h5 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph ph-door-open text-slate-400"></i> ${cabinetName}</h5><button class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded-lg hover:bg-red-200 transition font-medium delete-cabinet-btn" data-cabinet="${cabinetName}">刪除櫃子</button></div><div class="p-4 bg-white space-y-3">`;
                 const shelfItems = Object.keys(shelves).map(shelfName => `<div class="flex items-center gap-3 p-2 bg-slate-50 rounded-lg border border-slate-100"><span class="text-sm font-medium text-slate-700 flex-1 truncate">${shelfName}</span><button class="text-slate-400 hover:text-red-500 p-1 delete-shelf-btn" data-cabinet="${cabinetName}" data-shelf="${shelfName}"><i class="ph ph-x-circle text-lg"></i></button></div>`).join('');
                 headerHtml += shelfItems + `<div class="flex gap-2 mt-4 pt-3 border-t border-slate-100"><input type="text" placeholder="新層名稱" class="flex-1 px-3 py-1.5 border border-slate-300 rounded text-sm new-shelf-name"><button class="bg-slate-800 text-white px-3 py-1.5 rounded text-sm hover:bg-slate-900 add-shelf-btn" data-cabinet="${cabinetName}">新增層</button></div></div>`;
                 cabDiv.innerHTML = headerHtml;
                 cabinetSettingsEl.appendChild(cabDiv);
             });
        }

        function renderAllHistoryTables() {
             const container = document.getElementById('history-content-container');
             if(historyLog.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 py-8">無歷史紀錄</p>'; return; }
             let html = '<div class="space-y-2">';
             historyLog.forEach(log => {
                 let colorClass = 'text-slate-600';
                 if(log.action.includes('放入')) colorClass = 'text-green-600';
                 else if(log.action.includes('移至暫存')) colorClass = 'text-amber-600';
                 else if(log.action.includes('歸檔')) colorClass = 'text-red-600';
                 html += `<div class="bg-white border border-slate-100 p-3 rounded-lg flex justify-between items-center text-sm"><div><span class="font-bold ${colorClass} mr-2">${log.action}</span><span class="font-medium text-slate-800">${log.sampleName || '未知'}</span><div class="text-xs text-slate-400 mt-1">${log.details || ''}</div></div><div class="text-right text-xs text-slate-500"><div>${log.person}</div><div>${log.timestamp?.toDate().toLocaleString() || '-'}</div></div></div>`;
             });
             html += '</div>';
             container.innerHTML = html;
        }

        function renderReportPreview() {
            const content = document.getElementById('reportContent');
            const data = sampleInventory.sort((a,b) => (a.storageLocation||'').localeCompare(b.storageLocation||''));
            if (data.length === 0) { content.innerHTML = '<p class="text-center text-slate-500 py-8">無資料</p>'; return; }
            
            // Updated Report Headers (Removed EPC, Added Details)
            let html = `
                <div class="mb-4">
                    <h2 class="text-xl font-bold">庫存清單</h2>
                    <p class="text-sm text-slate-500">時間: ${new Date().toLocaleString()} | 共 ${data.length} 筆資料</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse min-w-[1000px]">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-2 border">位置</th>
                                <th class="p-2 border">名稱</th>
                                <th class="p-2 border">線徑</th>
                                <th class="p-2 border">標準</th>
                                <th class="p-2 border">製造商</th>
                                <th class="p-2 border">配方代號</th>
                                <th class="p-2 border">批號</th>
                                <th class="p-2 border">爐號</th>
                                <th class="p-2 border">製程明細</th>
                                <th class="p-2 border">備註</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            data.forEach(s => { 
                html += `
                    <tr class="border-b">
                        <td class="p-2 border whitespace-nowrap">${s.storageLocation}</td>
                        <td class="p-2 border font-medium whitespace-nowrap">${s.sampleName}</td>
                        <td class="p-2 border whitespace-nowrap">${s.wireDiameter}</td>
                        <td class="p-2 border whitespace-nowrap">${s.applicableStandard||''}</td>
                        <td class="p-2 border whitespace-nowrap">${s.manufacturer||''}</td>
                        <td class="p-2 border whitespace-nowrap">${s.formulaCode||''}</td>
                        <td class="p-2 border whitespace-nowrap">${s.batchNo||''}</td>
                        <td class="p-2 border whitespace-nowrap">${s.furnaceNo||''}</td>
                        <td class="p-2 border">${s.processDetails||''}</td>
                        <td class="p-2 border text-xs">${s.notes||''}</td>
                    </tr>`; 
            });
            html += '</tbody></table></div>';
            content.innerHTML = html;
        }

        // New function for downloading CSV
        function downloadReportCsv() {
            const data = sampleInventory.sort((a,b) => (a.storageLocation||'').localeCompare(b.storageLocation||''));
            if (data.length === 0) return showToast('無資料可下載', 'error');

            // BOM for Excel compatibility with UTF-8
            let csvContent = "\uFEFF";
            
            // Header
            csvContent += "位置,名稱,線徑,標準,製造商,配方代號,批號,爐號,製程明細,備註\n";

            data.forEach(s => {
                const row = [
                    s.storageLocation,
                    s.sampleName,
                    s.wireDiameter,
                    s.applicableStandard || '',
                    s.manufacturer || '',
                    s.formulaCode || '',
                    s.batchNo || '',
                    s.furnaceNo || '',
                    s.processDetails || '',
                    s.notes || ''
                ].map(item => `"${(item || '').toString().replace(/"/g, '""')}"`); // Quote and escape quotes
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `庫存報表_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // New function for printing report
        function printReport() {
            const content = document.getElementById('reportContent').innerHTML;
            if (!content || content.includes('無資料')) return showToast('無內容可列印', 'error');

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>庫存報表列印</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                @page { size: landscape; margin: 15mm; }
                body { font-family: "Noto Sans TC", sans-serif; -webkit-print-color-adjust: exact; }
                table { width: 100%; border-collapse: collapse; font-size: 10pt; }
                th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                thead { background-color: #f3f4f6; font-weight: bold; display: table-header-group; }
                tr { page-break-inside: avoid; }
                h2 { margin-bottom: 5px; }
                p { font-size: 9pt; color: #666; margin-top: 0; }
            `);
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function openActionModal(action, sample) {
            const modal = modals.action;
            const title = document.getElementById('actionModalTitle');
            const msg = document.getElementById('actionModalMessage');
            const btn = document.getElementById('actionConfirmBtn');
            const remarks = document.getElementById('remarksContainer');
            document.getElementById('actionSampleId').value = sample.id;
            document.getElementById('actionType').value = action;
            document.getElementById('actionForm').reset();
            remarks.classList.add('hidden');
            if (action === 'stage') {
                title.textContent = '移至暫存區'; msg.textContent = `將 "${sample.sampleName}" 從庫存移至暫存區？`; btn.textContent = "移動"; btn.className = "px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700";
            } else if (action === 'return') {
                title.textContent = '放回原位'; msg.textContent = `將 "${sample.sampleName}" 放回 ${sample.storageLocation}？`; btn.textContent = "放回"; btn.className = "px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700";
            } else if (action === 'finalize') {
                title.textContent = '歸檔 (最終取出)'; msg.textContent = `將 "${sample.sampleName}" 永久歸檔？`; remarks.classList.remove('hidden'); btn.textContent = "歸檔"; btn.className = "px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700";
            }
            openModal(modal);
        }

        // !!! CRITICAL FIX: Implement resetBindSelection and selectBindTarget logic
        function resetBindSelection() {
            bindTargetId = null;
            document.getElementById('bind-step-2-active').classList.add('hidden');
            document.getElementById('bind-step-2-inactive').classList.remove('hidden');
            renderRfidUnboundList();
        }
        window.resetBindSelection = resetBindSelection;

        function selectBindTarget(sample) {
            bindTargetId = sample.id;
            document.getElementById('bind-step-2-inactive').classList.add('hidden');
            document.getElementById('bind-step-2-active').classList.remove('hidden');
            document.getElementById('bind-target-name').textContent = sample.sampleName;
            document.getElementById('bind-target-loc').textContent = sample.storageLocation;
            renderRfidUnboundList();
        }

        function renderRfidUnboundList() {
            const list = dom.unboundList;
            list.innerHTML = '';
            const term = dom.bindSearchInput.value.toLowerCase();
            const unbound = sampleInventory.filter(s => !s.epc && s.sampleName.toLowerCase().includes(term));
            if (unbound.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">無符合的未綁定樣品</div>'; return; }
            unbound.forEach(s => {
                const isSelected = s.id === bindTargetId;
                const div = document.createElement('div');
                div.className = isSelected 
                    ? "p-3 rounded-lg border-2 border-purple-500 bg-purple-50 cursor-pointer transition flex justify-between items-center group shadow-sm text-left"
                    : "p-3 rounded-lg border border-slate-100 bg-white hover:border-purple-300 hover:bg-purple-50 cursor-pointer transition flex justify-between items-center group text-left";
                
                // Helper to join non-empty strings with separator
                const joinParts = (parts) => parts.filter(p => p && p.trim() !== '').join(' | ');

                const line2 = joinParts([s.wireDiameter ? `${s.wireDiameter}` : '', s.manufacturer]);
                
                const line3Parts = [];
                if(s.batchNo) line3Parts.push(`批:${s.batchNo}`);
                if(s.furnaceNo) line3Parts.push(`爐:${s.furnaceNo}`);
                if(s.formulaCode) line3Parts.push(`配:${s.formulaCode}`);
                const line3 = line3Parts.join(' | ');

                div.innerHTML = `
                    <div class="flex-1 min-w-0 pr-3">
                        <div class="font-bold text-slate-800 text-sm md:text-base mb-0.5 group-hover:text-purple-700 break-words">${s.sampleName}</div>
                        <div class="text-xs text-slate-600 mb-0.5 font-medium">${line2 || '<span class="text-slate-300">-</span>'}</div>
                        <div class="text-[10px] text-slate-500 mb-1 font-mono tracking-tight">${line3 || '<span class="opacity-0">-</span>'}</div>
                        <div class="text-xs text-slate-400 flex items-center gap-1"><i class="ph ph-map-pin"></i> ${s.storageLocation}</div>
                    </div>
                    <div class="shrink-0 pl-1">
                        <i class="ph ${isSelected ? 'ph-check-circle-fill text-purple-600 text-2xl' : 'ph-caret-right text-slate-300 group-hover:text-purple-400 text-xl'}"></i>
                    </div>`;
                div.onclick = () => selectBindTarget(s);
                list.appendChild(div);
            });
        }

        // Function to unbind RFID
        window.unbindRfid = function(sampleId) {
            const sample = sampleInventory.find(s => s.id === sampleId);
            if (!sample) return;

            openConfirmation('解除綁定', `確定要解除 "${sample.sampleName}" 的 RFID 綁定嗎？`, async () => {
                try {
                    await updateDoc(doc(db, 'sampleSystem/data/inventory', sampleId), { 
                        epc: deleteField(),
                        lastModifiedBy: getCurrentOperator(), 
                        lastModifiedAt: serverTimestamp() 
                    });
                    await logAction('解除綁定', getCurrentOperator(), sample.sampleName, `解除 EPC: ${sample.epc}`);
                    showToast('已解除綁定', 'success');
                    closeModal(modals.sampleDetail);
                    // Optionally reopen to show updated state, but closing is safer
                } catch(e) {
                    console.error(e);
                    showToast('解除綁定失敗', 'error');
                }
            });
        };

        function window_showSampleDetails(sample) {
             const content = document.getElementById('sampleDetailContent');
             const hasRfid = !!sample.epc;
             
             // Dynamic button: Bind or Unbind
             let rfidButtonHtml;
             if (hasRfid) {
                 rfidButtonHtml = `<button onclick="unbindRfid('${sample.id}')" class="px-4 py-3 bg-red-50 text-red-700 rounded-lg border border-red-200 flex items-center gap-2 font-medium hover:bg-red-100"><i class="ph ph-link-break"></i> 解除綁定</button>`;
             } else {
                 rfidButtonHtml = `<button onclick="closeModal(document.getElementById('sampleDetailModal')); switchPage('rfid'); switchRfidMode('bind'); setTimeout(() => { document.getElementById('bind-search-input').value='${sample.sampleName}'; }, 100);" class="px-4 py-3 bg-purple-50 text-purple-700 rounded-lg border border-purple-200 flex items-center gap-2 font-medium hover:bg-purple-100"><i class="ph ph-link"></i> 綁定 RFID</button>`;
             }
             
             // New Stage Button
             let stageButtonHtml = `<button onclick="closeModal(document.getElementById('sampleDetailModal')); setTimeout(() => openActionModal('stage', window.sampleInventory.find(s=>s.id==='${sample.id}')), 50);" class="px-4 py-3 bg-amber-50 text-amber-700 rounded-lg border border-amber-200 flex items-center gap-2 font-medium hover:bg-amber-100"><i class="ph ph-tray"></i> 移入暫存</button>`;


             content.innerHTML = `<div class="space-y-4"><div class="bg-slate-50 p-4 rounded-lg border border-slate-100 flex justify-between items-start"><div><h4 class="text-xl font-bold text-slate-800 flex items-center gap-2">${sample.sampleName} ${hasRfid ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full border border-purple-200">RFID</span>' : ''}</h4><p class="text-indigo-600 font-mono mt-1">${sample.storageLocation}</p></div></div><div class="grid grid-cols-2 gap-4 text-sm"><div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">線徑</span><span class="font-medium">${sample.wireDiameter}</span></div><div class="p-3 border rounded-lg"><span class="block text-xs text-slate-400">RFID EPC</span><span class="font-mono text-xs ${hasRfid ? 'text-purple-600 font-bold' : 'text-slate-300'}">${sample.epc || '尚未綁定'}</span></div><div class="p-3 border rounded-lg col-span-2 bg-yellow-50 border-yellow-100"><span class="block text-xs text-yellow-600 font-bold mb-1">備註</span><span class="text-slate-700">${sample.notes || '無備註'}</span></div></div>
             
             <div class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-100 text-sm grid grid-cols-2 gap-y-2 text-slate-600">
                <div><span class="text-slate-400 text-xs block">配方代號</span>${sample.formulaCode || '-'}</div>
                <div><span class="text-slate-400 text-xs block">批號</span>${sample.batchNo || '-'}</div>
                <div><span class="text-slate-400 text-xs block">爐號</span>${sample.furnaceNo || '-'}</div>
                <div><span class="text-slate-400 text-xs block">製造商</span>${sample.manufacturer || '-'}</div>
                <div class="col-span-2"><span class="text-slate-400 text-xs block">製程明細</span>${sample.processDetails || '-'}</div>
             </div>
             </div>`;
             
             const footer = document.getElementById('sampleDetailFooter');
             footer.innerHTML = `<button onclick="closeModal(document.getElementById('sampleDetailModal'))" class="px-6 py-3 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50 font-medium">關閉</button><div class="flex gap-2">${stageButtonHtml}${rfidButtonHtml}<button onclick="closeModal(document.getElementById('sampleDetailModal')); setTimeout(() => openQrModal(window.sampleInventory.find(s=>s.id==='${sample.id}')), 50);" class="px-4 py-3 bg-white border border-indigo-200 text-indigo-600 rounded-lg hover:bg-indigo-50 flex items-center gap-2 font-medium"><i class="ph ph-qr-code"></i> QR Code</button><button onclick="closeModal(document.getElementById('sampleDetailModal')); openEditSampleModal(window.sampleInventory.find(s=>s.id==='${sample.id}'));" class="px-4 py-3 bg-slate-800 text-white rounded-lg hover:bg-slate-900 font-medium">修改</button></div>`;
             openModal(modals.sampleDetail);
        }
        window.showSampleDetails = window_showSampleDetails;

        window.openEditSampleModal = (sample) => {
            const modal = modals.editSample;
            document.getElementById('editSampleId').value = sample.id;
            document.getElementById('editSampleName').value = sample.sampleName;
            document.getElementById('editWireDiameter').value = sample.wireDiameter;
            document.getElementById('editApplicableStandard').value = sample.applicableStandard || '';
            document.getElementById('editManufacturer').value = sample.manufacturer || '';
            document.getElementById('editFormulaCode').value = sample.formulaCode || '';
            document.getElementById('editProcessDetails').value = sample.processDetails || '';
            document.getElementById('editFurnaceNo').value = sample.furnaceNo || '';
            document.getElementById('editBatchNo').value = sample.batchNo || '';
            document.getElementById('editNotes').value = sample.notes || '';

            // --- START FIX: Populate Location Dropdowns ---
            const cabSelect = document.getElementById('editStorageCabinet');
            const shelfSelect = document.getElementById('editStorageShelf');
            
            // 1. Populate Cabinets
            cabSelect.innerHTML = '<option value="">選擇櫃子</option>';
            Object.keys(systemConfig.storageLayout || {}).forEach(k => {
                cabSelect.innerHTML += `<option value="${k}">${k}</option>`;
            });

            // 2. Parse and Set Current Location
            if (sample.storageLocation) {
                const parts = sample.storageLocation.split(' - ');
                if (parts.length >= 1) {
                    cabSelect.value = parts[0];
                    // Trigger population of shelves based on current cabinet
                    if (systemConfig.storageLayout[parts[0]]) {
                        shelfSelect.innerHTML = '<option value="">選擇層數</option>';
                        shelfSelect.disabled = false;
                        Object.keys(systemConfig.storageLayout[parts[0]]).forEach(s => {
                            shelfSelect.innerHTML += `<option value="${s}">${s}</option>`;
                        });
                        if (parts.length >= 2) {
                            shelfSelect.value = parts[1];
                        }
                    }
                }
            } else {
                shelfSelect.innerHTML = '<option value="">選擇層數</option>';
                shelfSelect.disabled = true;
            }
            // --- END FIX ---

            openModal(modal);
        };

        window.switchRfidMode = (mode) => {
            rfidMode = mode;
            bindTargetId = null;
            document.getElementById('bind-step-2-active').classList.add('hidden');
            document.getElementById('bind-step-2-inactive').classList.remove('hidden');
            const btnInactive = "px-4 py-1.5 rounded-md text-slate-500 hover:text-purple-700 transition-all";
            const btnActive = "px-4 py-1.5 rounded-md bg-white text-purple-700 shadow-sm transition-all";
            dom.rfidBtnSearch.className = mode === 'search' ? btnActive : btnInactive;
            dom.rfidBtnBind.className = mode === 'bind' ? btnActive : btnInactive;
            dom.rfidBtnStocktake.className = mode === 'stocktake' ? btnActive : btnInactive;
            dom.rfidViewSearch.classList.add('hidden');
            dom.rfidViewBind.classList.add('hidden');
            dom.rfidViewStocktake.classList.add('hidden');
            if (mode === 'search') dom.rfidViewSearch.classList.remove('hidden');
            else if (mode === 'bind') { dom.rfidViewBind.classList.remove('hidden'); renderRfidUnboundList(); }
            else if (mode === 'stocktake') { dom.rfidViewStocktake.classList.remove('hidden'); initStocktakeUI(); }
            document.getElementById('rfidHiddenInput').focus();
        };

        window.initStocktakeUI = () => {
            if (!systemConfig.storageLayout) return;
            dom.stCabinet.innerHTML = '<option value="">選擇櫃位</option>';
            Object.keys(systemConfig.storageLayout).forEach(c => { dom.stCabinet.innerHTML += `<option value="${c}">${c}</option>`; });
            dom.stShelf.innerHTML = '<option value="">選擇層板</option>';
            dom.stShelf.disabled = true;
        };

        window.startStocktake = () => {
            const cab = dom.stCabinet.value;
            const shelf = dom.stShelf.value;
            if (!cab || !shelf) return showToast('請先選擇櫃位與層板', 'error');
            const isCabinetMode = shelf === 'all';
            const locString = isCabinetMode ? `${cab}` : `${cab} - ${shelf}`;
            stocktakeState = { active: true, targetLocation: locString, isCabinetMode: isCabinetMode, expectedItems: sampleInventory.filter(s => s.storageLocation.startsWith(locString)), scannedItems: new Set(), intruders: [] };
            renderStocktakeResults();
            showToast(`開始盤點: ${isCabinetMode ? cab + " (全櫃)" : locString}`, 'success');
            document.getElementById('rfidHiddenInput').focus();
        };

        window.resetStocktake = () => {
            stocktakeState = { active: false, targetLocation: null, isCabinetMode: false, expectedItems: [], scannedItems: new Set(), intruders: [] };
            dom.stList.innerHTML = '<div class="p-8 text-center text-slate-400"><i class="ph ph-clipboard-text text-4xl mb-2 opacity-30"></i><p>請選擇櫃位並點擊「開始盤點」</p></div>';
            dom.stCountExpected.textContent = '0'; dom.stCountScanned.textContent = '0'; dom.stCountError.textContent = '0';
        };

        window.fixStocktakeError = async (itemId) => {
            if (stocktakeState.isCabinetMode) return showToast("整櫃盤點模式下無法自動修正位置。", 'error');
            const item = stocktakeState.intruders.find(x => x.id === itemId);
            if (!item) return;
            
            openConfirmation('確認移動', `確定將 "${item.sampleName}" 移動至 "${stocktakeState.targetLocation}" 嗎？`, async () => {
                 try {
                    await updateDoc(doc(db, 'sampleSystem/data/inventory', itemId), { storageLocation: stocktakeState.targetLocation, lastModifiedBy: getCurrentOperator(), lastModifiedAt: serverTimestamp() });
                    await logAction('移位修正', getCurrentOperator(), item.sampleName, `盤點修正: ${item.storageLocation} -> ${stocktakeState.targetLocation}`);
                    stocktakeState.intruders = stocktakeState.intruders.filter(x => x.id !== itemId);
                    stocktakeState.scannedItems.add(itemId);
                    showToast("位置已修正", 'success');
                    renderStocktakeResults();
                } catch (e) { showToast("修正失敗", 'error'); }
            });
        };

        function renderStocktakeResults() {
            dom.stCountExpected.textContent = stocktakeState.expectedItems.length;
            dom.stCountScanned.textContent = stocktakeState.scannedItems.size;
            dom.stCountError.textContent = stocktakeState.intruders.length;
            dom.stList.innerHTML = '';
            stocktakeState.intruders.forEach(item => {
                const canFix = !stocktakeState.isCabinetMode; 
                const el = document.createElement('div');
                el.className = "p-3 bg-red-50 border-l-4 border-red-500 flex justify-between items-center group";
                el.innerHTML = `<div class="flex-1"><div class="font-bold text-red-800 flex items-center gap-2">${item.sampleName || '未知標籤'}<span class="text-xs font-normal text-red-600 border border-red-200 px-1 rounded bg-white">錯置</span></div><div class="text-xs text-red-600 mt-0.5">應在: ${item.storageLocation || '未知'}</div><div class="text-[10px] text-slate-400 font-mono">${item.id ? item.id.substring(0,8)+'...' : item.epc}</div></div>${canFix && item.id ? `<button onclick="fixStocktakeError('${item.id}')" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-200 hover:bg-red-200 hover:shadow-sm transition flex items-center gap-1"><i class="ph ph-map-pin"></i> 移至此處</button>` : ''}`;
                dom.stList.appendChild(el);
            });
            stocktakeState.expectedItems.forEach(item => {
                const isScanned = stocktakeState.scannedItems.has(item.id);
                const el = document.createElement('div');
                el.className = `p-3 border-b border-slate-100 flex justify-between items-center ${isScanned ? 'bg-green-50' : 'bg-white'}`;
                el.innerHTML = `<div class="${isScanned ? 'opacity-100' : 'opacity-60'}"><div class="font-bold text-slate-700">${item.sampleName}</div><div class="text-xs text-slate-500">${item.id.substring(0,8)}...</div></div>${isScanned ? '<span class="text-xs font-bold text-green-700 flex items-center gap-1"><i class="ph ph-check-circle-fill text-lg"></i> 已盤</span>' : '<span class="text-xs font-bold text-slate-400">未掃描</span>'}`;
                dom.stList.appendChild(el);
            });
        }

        async function handleRfidScan(epc) {
            // 1. STOCKTAKE MODE
            if (rfidMode === 'stocktake' && stocktakeState.active && currentPage === 'rfid') {
                let item = sampleInventory.find(s => s.epc === epc || s.id === epc);
                if (!item) { stocktakeState.intruders.push({ sampleName: `未知標籤 (${epc})`, storageLocation: '未知', epc: epc }); renderStocktakeResults(); playSound('error'); return; }
                let isMatch = false;
                if (stocktakeState.isCabinetMode) { isMatch = item.storageLocation && item.storageLocation.startsWith(stocktakeState.targetLocation); } 
                else { isMatch = item.storageLocation && item.storageLocation.startsWith(stocktakeState.targetLocation); }
                if (isMatch) {
                    if (!stocktakeState.scannedItems.has(item.id)) { stocktakeState.scannedItems.add(item.id); renderStocktakeResults(); playSound('success'); }
                } else {
                    if (!stocktakeState.intruders.find(x => x.id === item.id)) { stocktakeState.intruders.push(item); renderStocktakeResults(); playSound('error'); showToast(`錯置! ${item.sampleName}`, 'error'); }
                }
                return;
            }
            // 2. BIND MODE
            if (rfidMode === 'bind' && bindTargetId && currentPage === 'rfid') {
                const targetSample = sampleInventory.find(s => s.id === bindTargetId);
                if (!targetSample) return;
                const used = sampleInventory.find(s => s.epc === epc);
                if (used) { playSound('error'); showToast(`標籤 ${epc.slice(-6)} 已被 ${used.sampleName} 使用！`, 'error'); return; }
                try {
                    await updateDoc(doc(db, 'sampleSystem/data/inventory', bindTargetId), { epc: epc, lastModifiedBy: getCurrentOperator(), lastModifiedAt: serverTimestamp() });
                    await logAction('綁定', getCurrentOperator(), targetSample.sampleName, `綁定標籤: ${epc.slice(-6)}`);
                    playSound('bind'); showToast(`綁定成功！`, 'bind'); resetBindSelection(); renderRfidUnboundList();
                } catch (e) { showToast("綁定失敗", 'error'); }
                return;
            }
            // 3. SEARCH MODE
            let found = sampleInventory.find(s => s.epc === epc);
            if (!found) found = sampleInventory.find(s => s.id === epc);
            if (found) { playSound('success'); showToast(`已掃描: ${found.sampleName}`, 'success'); showSampleDetails(found); } 
            else { playSound('error'); showToast(`未知的標籤: ${epc.slice(-6)}`, 'error'); }
        }

        function setupRfidListeners() {
            const hiddenInput = document.getElementById('rfidHiddenInput');
            const updateStatus = (focused) => {
                isRfidFocused = focused;
                if (focused) {
                    dom.rfidStatusCard.className = "bg-white rounded-xl p-6 border-2 border-green-500 cursor-pointer shadow-md flex items-center gap-4 relative overflow-hidden group";
                    dom.rfidStatusIconBg.className = "w-16 h-16 rounded-full bg-green-100 flex items-center justify-center text-green-600";
                    dom.rfidStatusTitle.textContent = "掃描器已就緒"; dom.rfidStatusDesc.textContent = "系統正在監聽 RFID 訊號...";
                } else {
                    dom.rfidStatusCard.className = "bg-slate-50 rounded-xl p-6 border-2 border-slate-200 cursor-pointer hover:border-purple-300 transition mb-6 shadow-sm flex items-center gap-4 relative overflow-hidden group opacity-70";
                    dom.rfidStatusIconBg.className = "w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center text-slate-400";
                    dom.rfidStatusTitle.textContent = "掃描器未連線"; dom.rfidStatusDesc.textContent = "點擊此處以啟用掃描模式";
                }
            };
            const maintainFocus = () => {
                if (currentPage !== 'rfid') return;
                if (document.activeElement && ['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName) && document.activeElement !== hiddenInput) {
                    if(document.activeElement !== dom.bindSearchInput) updateStatus(false);
                    return;
                }
                hiddenInput.focus(); updateStatus(true);
            };
            document.addEventListener('click', (e) => { if (currentPage === 'rfid' && !['INPUT', 'SELECT', 'TEXTAREA', 'BUTTON'].includes(e.target.tagName)) maintainFocus(); });
            hiddenInput.addEventListener('blur', () => { if(currentPage === 'rfid') setTimeout(maintainFocus, 100); });
            hiddenInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); const epc = hiddenInput.value.trim(); hiddenInput.value = ''; if (epc) handleRfidScan(epc); }
            });
            dom.rfidStatusCard.addEventListener('click', () => { hiddenInput.focus(); updateStatus(true); });
            dom.bindSearchInput.addEventListener('input', renderRfidUnboundList);
        }

        async function stopScanner() { if (html5QrCode && isScannerRunning) { try { await html5QrCode.stop(); html5QrCode.clear(); isScannerRunning = false; } catch (err) {} } }
        
        window.startScanner = async function(mode) {
            if (isScannerRunning) await stopScanner();
            window.scannerMode = mode; openModal(modals.qrScanner);
            setTimeout(() => {
                if (html5QrCode === null) html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, (txt) => {
                     stopScanner().then(() => {
                         closeModal(modals.qrScanner);
                         // NEW LOGIC: Check if scanned text is an ID first
                         const matchedSample = sampleInventory.find(s => s.id === txt);
                         
                         if (matchedSample) {
                             // If ID matches, show details (RFID-like behavior)
                             showSampleDetails(matchedSample);
                             playSound('success');
                             showToast(`已掃描: ${matchedSample.sampleName}`, 'success');
                         } else {
                             // If not an ID, treat as search text
                             if (mode === 'search' || mode === 'action') {
                                 document.getElementById('globalSearchInput').value = txt;
                                 renderInventory();
                                 showToast(`已填入搜尋關鍵字: ${txt}`, 'info');
                             }
                         }
                     });
                }).catch(console.error);
            }, 300);
        }
        
        async function generateLabelImage(sample, format = '40x40') {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const qr = qrcode(0, 'M'); qr.addData(sample.id); qr.make(); const moduleCount = qr.getModuleCount();
                if (format === '80x50') {
                    // Create horizontal canvas first
                    const hCanvas = document.createElement('canvas');
                    const hCtx = hCanvas.getContext('2d');
                    const width = 960; 
                    const height = 600; 
                    hCanvas.width = width; 
                    hCanvas.height = height;
                    
                    // Draw background
                    hCtx.fillStyle = '#ffffff'; 
                    hCtx.fillRect(0, 0, width, height);

                    // 1. Top Row (Full Width Header) - Y Baseline ~ 80px
                    hCtx.font = 'bold 72px "Inter", "Noto Sans TC", sans-serif';
                    hCtx.fillStyle = '#000000';
                    
                    // Wire Diameter: Left Aligned
                    hCtx.textAlign = 'left';
                    hCtx.fillText(sample.wireDiameter, 30, 80);

                    // Sample Name: Right Aligned
                    hCtx.textAlign = 'right';
                    hCtx.fillText(sample.sampleName, 930, 80);

                    // --- Left Column (QR & ID) ---
                    // Zone: X=0 to 320. Y=120 to 600.
                    const qrZoneWidth = 320;
                    const targetQrSize = 260;
                    const cellSize = Math.floor(targetQrSize / moduleCount);
                    const qrMarginX = (qrZoneWidth - cellSize * moduleCount) / 2;
                    // Y Start: 120 (Below header)
                    // Let's place QR code relatively high in this zone to leave space for ID below
                    const qrMarginY = 150; 

                    // Draw QR
                    hCtx.fillStyle = '#000000'; 
                    for (let r = 0; r < moduleCount; r++) { 
                        for (let c = 0; c < moduleCount; c++) { 
                            if (qr.isDark(r, c)) hCtx.fillRect(qrMarginX + c * cellSize, qrMarginY + r * cellSize, cellSize, cellSize); 
                        } 
                    }

                    // System ID below QR
                    hCtx.textAlign = 'center';
                    hCtx.font = 'bold 24px monospace';
                    hCtx.fillStyle = '#666666';
                    // Center of left column is 160
                    hCtx.fillText(sample.id.substring(0, 8).toUpperCase(), 160, qrMarginY + cellSize * moduleCount + 40);


                    // --- Right Column (Details) ---
                    // Zone: X=340 to 960.
                    const leftAlignX = 360; // Padding from left of this col
                    hCtx.textAlign = 'left';
                    hCtx.fillStyle = '#000000';

                    // 1. Standard (AWS...) - Font 34px
                    hCtx.font = '34px "Inter", "Noto Sans TC", sans-serif';
                    hCtx.fillText(sample.applicableStandard || '', leftAlignX, 150);

                    // 2. List Items - Font 48px
                    hCtx.font = '48px "Inter", "Noto Sans TC", sans-serif';
                    let currentY = 220;
                    const lineHeight = 65;

                    hCtx.fillText(`配方: ${sample.formulaCode || ''}`, leftAlignX, currentY);
                    currentY += lineHeight;
                    hCtx.fillText(`製程: ${sample.processDetails || ''}`, leftAlignX, currentY);
                    currentY += lineHeight;
                    hCtx.fillText(`爐號: ${sample.furnaceNo || ''}`, leftAlignX, currentY);
                    currentY += lineHeight;
                    hCtx.fillText(`批號: ${sample.batchNo || ''}`, leftAlignX, currentY);
                    currentY += lineHeight;
                    
                    // Note logic: simple render
                    const noteText = sample.notes ? `備註: ${sample.notes}` : '備註:';
                    hCtx.fillText(noteText, leftAlignX, currentY);

                    // 3. Manufacturer (Bottom Right) - Replaces original ID position
                    hCtx.textAlign = 'right';
                    hCtx.font = '24px "Inter", "Noto Sans TC", sans-serif';
                    hCtx.fillStyle = '#666666';
                    hCtx.fillText(sample.manufacturer || '', 930, 580);

                    // Rotation Logic
                    const rCanvas = document.createElement('canvas');
                    rCanvas.width = height; // 600
                    rCanvas.height = width; // 960
                    const rCtx = rCanvas.getContext('2d');
                    
                    // Rotate 90 degrees clockwise
                    rCtx.translate(height, 0);
                    rCtx.rotate(90 * Math.PI / 180);
                    rCtx.drawImage(hCanvas, 0, 0);
                    
                    resolve(rCanvas.toDataURL('image/png'));
                } else {
                    const size = 480; canvas.width = size; canvas.height = size; ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, size, size);
                    const targetQrSize = size * 0.55; const cellSize = Math.floor(targetQrSize / moduleCount); const margin = (size - cellSize*moduleCount) / 2;
                    ctx.fillStyle = '#000000'; ctx.textAlign = 'center';
                    ctx.font = 'bold 36px "Inter", "Noto Sans TC", sans-serif'; ctx.fillText(sample.sampleName, size/2, 50); 
                    for (let r = 0; r < moduleCount; r++) { for (let c = 0; c < moduleCount; c++) { if (qr.isDark(r, c)) ctx.fillRect(margin + c * cellSize, 70 + r * cellSize, cellSize, cellSize); } }
                    ctx.font = 'bold 36px "Inter", "Noto Sans TC", sans-serif'; ctx.fillText(`線徑: ${sample.wireDiameter}`, size/2, 70 + cellSize*moduleCount + 40);
                    ctx.font = '18px monospace'; ctx.fillStyle = '#666666'; ctx.fillText(sample.id.substring(0, 8).toUpperCase(), size/2, size - 15);
                    resolve(canvas.toDataURL('image/png'));
                }
            });
        }
        
        async function updateQrPreview(format) {
            if (!currentQrSample) return;
            const sample = currentQrSample;
            const qrArea = document.getElementById('qrDisplayArea');
            const dlLink = document.getElementById('qrDownloadLink');
            qrArea.innerHTML = '<div class="flex items-center justify-center h-full"><i class="ph ph-spinner animate-spin text-3xl text-indigo-600"></i></div>';
            const fullLabelUrl = await generateLabelImage(sample, format);
            qrArea.innerHTML = `<img src="${fullLabelUrl}" class="object-contain max-h-full mx-auto shadow-md" alt="Label Preview">`;
            const cleanName = sample.sampleName.replace(/[<>:"/\\|?*]/g, '_');
            const fileName = `${sample.id}_${cleanName}_${format}.png`;
            dlLink.href = fullLabelUrl; dlLink.download = fileName;
        }

        async function openQrModal(sample) {
            const modal = modals.qrDisplay; currentQrSample = sample; document.getElementById('qrLabelSize').value = '40x40'; await updateQrPreview('40x40'); openModal(modal);
        }
        document.getElementById('qrLabelSize').addEventListener('change', (e) => updateQrPreview(e.target.value));

        // --- Initializers ---
        function safeAddListener(id, event, handler) { const el = document.getElementById(id); if (el) el.addEventListener(event, handler); }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop'))));
            const qrCloseBtn = document.querySelector('.close-scanner-btn');
            if (qrCloseBtn) qrCloseBtn.addEventListener('click', () => { stopScanner().then(() => closeModal(modals.qrScanner)); });

            document.getElementById('confirmActionBtn').addEventListener('click', () => {
                if (pendingConfirmCallback) pendingConfirmCallback();
                closeModal(modals.confirmation);
                pendingConfirmCallback = null;
            });
            document.getElementById('confirmCancelBtn').addEventListener('click', () => {
                closeModal(modals.confirmation);
                pendingConfirmCallback = null;
            });

            dom.navInv.addEventListener('click', () => switchPage('inventory'));
            dom.mobileNavInv.addEventListener('click', () => switchPage('inventory'));
            dom.navRfid.addEventListener('click', () => switchPage('rfid'));
            dom.mobileNavRfid.addEventListener('click', () => switchPage('rfid'));

            safeAddListener('view-list-btn', 'click', () => { currentViewMode = 'list'; document.getElementById('view-list').classList.remove('hidden'); document.getElementById('view-grid').classList.add('hidden'); renderInventory(); });
            safeAddListener('view-grid-btn', 'click', () => { currentViewMode = 'grid'; document.getElementById('view-grid').classList.remove('hidden'); document.getElementById('view-list').classList.add('hidden'); renderInventory(); });

            const thLocation = document.getElementById('th-location');
            if(thLocation) thLocation.addEventListener('click', () => { sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; renderInventory(); });

            safeAddListener('nav-report', 'click', () => { renderReportPreview(); openModal(modals.report); });
            
            // --- NEW: Report Button Listeners ---
            safeAddListener('downloadCsvBtn', 'click', downloadReportCsv);
            safeAddListener('printReportBtn', 'click', printReport);

            safeAddListener('nav-history', 'click', () => { renderAllHistoryTables(); openModal(modals.history); });
            
            safeAddListener('nav-settings', 'click', () => { tempSystemConfig = JSON.parse(JSON.stringify(systemConfig)); renderSettingsUI(tempSystemConfig); openModal(modals.settings); });
            safeAddListener('mobile-nav-settings', 'click', () => { tempSystemConfig = JSON.parse(JSON.stringify(systemConfig)); renderSettingsUI(tempSystemConfig); openModal(modals.settings); });

            safeAddListener('topAddBtn', 'click', () => { document.getElementById('add-sample-form').reset(); updateAddFormSelects(); openModal(modals.addSample); });
            safeAddListener('mobile-nav-add', 'click', () => { document.getElementById('add-sample-form').reset(); updateAddFormSelects(); openModal(modals.addSample); });

            safeAddListener('topActionScanBtn', 'click', () => startScanner('action'));
            safeAddListener('mobile-nav-scan-action', 'click', () => startScanner('action'));
            safeAddListener('topScanBtn', 'click', () => startScanner('search'));
            
            safeAddListener('cartDrawerBtn', 'click', () => { document.getElementById('stagingDrawer').classList.remove('drawer-hidden'); document.getElementById('stagingDrawer').classList.add('drawer-visible'); });
            safeAddListener('closeDrawerBtn', 'click', () => { document.getElementById('stagingDrawer').classList.remove('drawer-visible'); document.getElementById('stagingDrawer').classList.add('drawer-hidden'); });

            safeAddListener('addPersonBtn', 'click', () => { const name = document.getElementById('newPersonName').value.trim(); if(name && !tempSystemConfig.personnel.includes(name)) { tempSystemConfig.personnel.push(name); renderSettingsUI(tempSystemConfig); document.getElementById('newPersonName').value = ''; } });
            safeAddListener('addCabinetBtn', 'click', () => { const name = document.getElementById('newCabinetName').value.trim(); if(name && !tempSystemConfig.storageLayout[name]) { tempSystemConfig.storageLayout[name] = {}; renderSettingsUI(tempSystemConfig); document.getElementById('newCabinetName').value = ''; } });
            
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if(!target) return;
                    if(target.classList.contains('delete-person-btn')) { tempSystemConfig.personnel = tempSystemConfig.personnel.filter(x => x !== target.dataset.person); renderSettingsUI(tempSystemConfig); }
                    if(target.classList.contains('delete-cabinet-btn')) { 
                        openConfirmation('刪除櫃子', `確定要刪除 "${target.dataset.cabinet}" 嗎？這將會刪除該櫃位下的所有設定。`, () => {
                             delete tempSystemConfig.storageLayout[target.dataset.cabinet]; 
                             renderSettingsUI(tempSystemConfig); 
                        });
                    }
                    if(target.classList.contains('delete-shelf-btn')) { delete tempSystemConfig.storageLayout[target.dataset.cabinet][target.dataset.shelf]; renderSettingsUI(tempSystemConfig); }
                    if(target.classList.contains('add-shelf-btn')) { const name = target.parentElement.querySelector('.new-shelf-name').value.trim(); if(name) { tempSystemConfig.storageLayout[target.dataset.cabinet][name] = -1; renderSettingsUI(tempSystemConfig); } }
                });
            }
            
            safeAddListener('saveSettingsBtn', 'click', async () => { await setDoc(doc(db, 'sampleSystem', 'config'), tempSystemConfig); showToast('設定已儲存', 'success'); closeModal(modals.settings); });
            safeAddListener('closeSettingsBtn', 'click', () => closeModal(modals.settings));

            const storageCabinet = document.getElementById('storageCabinet');
            if (storageCabinet) { storageCabinet.addEventListener('change', (e) => { const cab = e.target.value; const shelfSel = document.getElementById('storageShelf'); shelfSel.innerHTML = '<option value="">選擇層數</option>'; if(cab && systemConfig.storageLayout[cab]) { shelfSel.disabled = false; Object.keys(systemConfig.storageLayout[cab]).forEach(s => shelfSel.innerHTML += `<option value="${s}">${s}</option>`); } else shelfSel.disabled = true; }); }
            
            // --- START FIX: Add Event Listener for Edit Cabinet ---
            const editStorageCabinet = document.getElementById('editStorageCabinet');
            if (editStorageCabinet) { 
                editStorageCabinet.addEventListener('change', (e) => { 
                    const cab = e.target.value; 
                    const shelfSel = document.getElementById('editStorageShelf'); 
                    shelfSel.innerHTML = '<option value="">選擇層數</option>'; 
                    if(cab && systemConfig.storageLayout[cab]) { 
                        shelfSel.disabled = false; 
                        Object.keys(systemConfig.storageLayout[cab]).forEach(s => 
                            shelfSel.innerHTML += `<option value="${s}">${s}</option>`
                        ); 
                    } else {
                        shelfSel.disabled = true; 
                    } 
                }); 
            }
            // --- END FIX ---

            const addSampleForm = document.getElementById('add-sample-form');
            if (addSampleForm) {
                addSampleForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); const form = e.target; const loc = `${form.storageCabinet.value} - ${form.storageShelf.value}`;
                    try {
                        await addDoc(collection(db, 'sampleSystem/data/inventory'), { sampleName: form.sampleName.value, wireDiameter: form.wireDiameter.value, applicableStandard: form.applicableStandard.value, manufacturer: form.manufacturer.value, formulaCode: form.formulaCode.value, batchNo: form.batchNo.value, furnaceNo: form.furnaceNo.value, processDetails: form.processDetails.value, notes: document.getElementById('notes').value, storageLocation: loc, loggedBy: getCurrentOperator(), loggedAt: serverTimestamp() });
                        await logAction('放入', getCurrentOperator(), form.sampleName.value, loc); showToast('新增成功', 'success'); closeModal(modals.addSample);
                    } catch(err) { console.error(err); showToast('失敗', 'error'); }
                });
            }
            
            const editSampleForm = document.getElementById('edit-sample-form');
            if (editSampleForm) {
                editSampleForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); const id = document.getElementById('editSampleId').value;
                    // --- START FIX: Get new location ---
                    const cab = document.getElementById('editStorageCabinet').value;
                    const shelf = document.getElementById('editStorageShelf').value;
                    const newLoc = (cab && shelf) ? `${cab} - ${shelf}` : null;
                    
                    const newData = { 
                        sampleName: document.getElementById('editSampleName').value, 
                        wireDiameter: document.getElementById('editWireDiameter').value, 
                        applicableStandard: document.getElementById('editApplicableStandard').value, 
                        manufacturer: document.getElementById('editManufacturer').value, 
                        formulaCode: document.getElementById('editFormulaCode').value, 
                        processDetails: document.getElementById('editProcessDetails').value, 
                        furnaceNo: document.getElementById('editFurnaceNo').value, 
                        batchNo: document.getElementById('editBatchNo').value, 
                        notes: document.getElementById('editNotes').value, 
                        lastModifiedBy: getCurrentOperator(), 
                        lastModifiedAt: serverTimestamp() 
                    };
                    if (newLoc) {
                        newData.storageLocation = newLoc;
                    }
                    // --- END FIX ---

                    try { await updateDoc(doc(db, 'sampleSystem/data/inventory', id), newData); showToast('更新成功', 'success'); closeModal(modals.editSample); } catch(e) { showToast('更新失敗', 'error'); }
                });
            }
            
            document.getElementById('actionForm').addEventListener('submit', async (e) => {
                e.preventDefault(); const id = document.getElementById('actionSampleId').value; const type = document.getElementById('actionType').value; const remark = document.getElementById('actionRemarks').value;
                closeModal(modals.action);
                try {
                    let s = sampleInventory.find(x => x.id === id); if (!s) s = stagingSamples.find(x => x.id === id);
                    if (type === 'stage') { const {id: _, ...data} = s; await setDoc(doc(db, 'sampleSystem/data/staging', id), data); await deleteDoc(doc(db, 'sampleSystem/data/inventory', id)); await logAction('移至暫存', getCurrentOperator(), s.sampleName, s.storageLocation); showToast('已移至暫存', 'success'); } 
                    else if (type === 'return') { const {id: _, ...data} = s; await setDoc(doc(db, 'sampleSystem/data/inventory', id), data); await deleteDoc(doc(db, 'sampleSystem/data/staging', id)); await logAction('放回儲位', getCurrentOperator(), s.sampleName, s.storageLocation); showToast('已放回庫存', 'success'); } 
                    else if (type === 'finalize') { const {id: _, ...data} = s; await addDoc(collection(db, 'sampleSystem/data/archived'), {...data, archivedAt: serverTimestamp(), remarks: remark}); await deleteDoc(doc(db, 'sampleSystem/data/staging', id)); await logAction('最終取出', getCurrentOperator(), s.sampleName, remark); showToast('已歸檔', 'success'); }
                } catch(e) { showToast('操作失敗', 'error'); }
            });

            dom.stCabinet.addEventListener('change', (e) => { const cab = e.target.value; dom.stShelf.innerHTML = '<option value="">選擇層板</option>'; if (cab && systemConfig.storageLayout[cab]) { dom.stShelf.disabled = false; dom.stShelf.innerHTML += '<option value="all" class="font-bold text-indigo-600">📦 整櫃盤點 (全部層架)</option>'; Object.keys(systemConfig.storageLayout[cab]).forEach(s => { dom.stShelf.innerHTML += `<option value="${s}">${s}</option>`; }); } else { dom.stShelf.disabled = true; } });

            // --- Fix: Select All Logic ---
            document.getElementById('selectAllInventory').addEventListener('change', (e) => {
                const visibleData = getFilteredInventory();
                if (e.target.checked) {
                    visibleData.forEach(s => selectedInventoryIds.add(s.id));
                } else {
                    visibleData.forEach(s => selectedInventoryIds.delete(s.id));
                }
                renderInventory();
                updateSelectionBar();
            });
            
            document.getElementById('inventory-clear-selection').addEventListener('click', () => {
                selectedInventoryIds.clear();
                document.getElementById('selectAllInventory').checked = false;
                renderInventory();
                updateSelectionBar();
            });

            // --- Fix: Cabinet Filter Logic ---
            const cabinetFilter = document.getElementById('cabinetFilter');
            if (cabinetFilter) {
                cabinetFilter.addEventListener('change', () => {
                   renderInventory(); 
                });
            }

            // --- Fix: Batch Download Logic (Enhanced for Single Item) ---
            document.getElementById('inventory-batch-download-btn').addEventListener('click', async () => {
                if (selectedInventoryIds.size === 0) return;
                
                const size = document.getElementById('inventoryBatchLabelSize').value; // '40x40' or '80x50'
                const btn = document.getElementById('inventory-batch-download-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> 處理中...';
                btn.disabled = true;

                // Optimization: If only 1 item, download directly as PNG
                if (selectedInventoryIds.size === 1) {
                    const id = Array.from(selectedInventoryIds)[0];
                    const sample = sampleInventory.find(s => s.id === id);
                    if (sample) {
                        try {
                            const dataUrl = await generateLabelImage(sample, size);
                            const link = document.createElement('a');
                            link.href = dataUrl;
                            const cleanName = sample.sampleName.replace(/[<>:"/\\|?*]/g, '_');
                            link.download = `${cleanName}_${id.substring(0,4)}_${size}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showToast(`已下載 ${sample.sampleName} 的 QR 圖檔`, 'success');
                        } catch (e) {
                            console.error(e);
                            showToast('圖片生成失敗', 'error');
                        }
                    }
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                // Batch Mode: Use ZIP
                const zip = new JSZip();
                const promises = [];
                selectedInventoryIds.forEach(id => {
                    const sample = sampleInventory.find(s => s.id === id);
                    if (sample) {
                        promises.push(generateLabelImage(sample, size).then(dataUrl => {
                            const cleanName = sample.sampleName.replace(/[<>:"/\\|?*]/g, '_');
                            // Remove data:image/png;base64, prefix
                            zip.file(`${cleanName}_${id.substring(0,4)}.png`, dataUrl.split(',')[1], {base64: true});
                        }));
                    }
                });

                await Promise.all(promises);
                const content = await zip.generateAsync({type:"blob"});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `samples_qr_batch_${new Date().toISOString().slice(0,10)}.zip`;
                link.click();
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast(`已下載 ${selectedInventoryIds.size} 個 QR Code (ZIP)`, 'success');
            });
            
            // Add listener for batch-qr-btn in Staging Drawer (Robustness)
            const stagingBatchBtn = document.getElementById('batch-qr-btn');
            if (stagingBatchBtn) {
                stagingBatchBtn.addEventListener('click', async () => {
                    // Simple logic: grab all staging samples for now since we don't track selection strictly in drawer yet
                    // OR implementing simple check
                    const selectedChecks = document.querySelectorAll('#staging-list input[type="checkbox"]:checked');
                    if (selectedChecks.length === 0) return showToast('請先勾選暫存區樣品', 'error');

                    const btn = stagingBatchBtn;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i>';
                    btn.disabled = true;
                    
                    const size = document.getElementById('stagingBatchLabelSize').value;
                    const zip = new JSZip();
                    const promises = [];
                    let singleSample = null;

                    // Identify selected samples (Using index or simple logic if IDs were stored, here relying on sample list order if DOM matches)
                    // Better approach: Iterate stagingSamples and match? 
                    // Let's assume user wants all for now or check current simple implementation.
                    // To be safe, let's just zip all STAGING samples for now as the checkboxes in drawer are visual in this snippet version
                    // OR simply fix it to be robust:
                    const stagingListDivs = document.getElementById('staging-list').children;
                    let count = 0;
                    
                    for (let i = 0; i < stagingListDivs.length; i++) {
                        if (stagingListDivs[i].querySelector('input').checked) {
                            const sample = stagingSamples[i]; // Assuming order matches
                            if (sample) {
                                count++;
                                singleSample = sample;
                                promises.push(generateLabelImage(sample, size).then(dataUrl => {
                                    const cleanName = sample.sampleName.replace(/[<>:"/\\|?*]/g, '_');
                                    zip.file(`${cleanName}_${sample.id.substring(0,4)}.png`, dataUrl.split(',')[1], {base64: true});
                                }));
                            }
                        }
                    }

                    if (count === 0) { btn.innerHTML = originalText; btn.disabled = false; return; }

                    if (count === 1 && singleSample) {
                         const dataUrl = await generateLabelImage(singleSample, size);
                         const link = document.createElement('a');
                         link.href = dataUrl;
                         link.download = `${singleSample.sampleName}_${singleSample.id.substring(0,4)}.png`;
                         link.click();
                         showToast('已下載圖檔', 'success');
                    } else {
                        await Promise.all(promises);
                        const content = await zip.generateAsync({type:"blob"});
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(content);
                        link.download = `staging_qr_${new Date().getTime()}.zip`;
                        link.click();
                        showToast(`已下載 ${count} 個圖檔`, 'success');
                    }
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }


            onAuthStateChanged(auth, user => {
                if (user) {
                    setupRfidListeners();
                    onSnapshot(doc(db, 'sampleSystem', 'config'), snap => {
                        systemConfig = snap.exists() ? snap.data() : { storageLayout: {}, personnel: [] };
                        const cabFilter = document.getElementById('cabinetFilter');
                        if (cabFilter) { cabFilter.innerHTML = '<option value="all">所有櫃位</option>'; Object.keys(systemConfig.storageLayout || {}).forEach(k => cabFilter.innerHTML += `<option value="${k}">${k}</option>`); }
                        updateGlobalOperatorOptions();
                        if(rfidMode === 'stocktake') initStocktakeUI();
                    });
                    onSnapshot(query(collection(db, 'sampleSystem/data/inventory')), snap => {
                        sampleInventory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        window.sampleInventory = sampleInventory; // Sync to window for inline calls
                        const loader = document.getElementById('loader'); if (loader) loader.classList.add('hidden');
                        if(currentPage === 'inventory') dom.contentInventory.classList.remove('hidden');
                        renderInventory();
                        if(currentPage === 'rfid' && rfidMode === 'bind') renderRfidUnboundList();
                    });
                    onSnapshot(query(collection(db, 'sampleSystem/data/staging')), snap => { stagingSamples = snap.docs.map(d => ({id: d.id, ...d.data()})); renderStagingDrawer(); });
                    onSnapshot(query(collection(db, 'sampleSystem/data/history'), orderBy('timestamp', 'desc'), limit(50)), snap => { historyLog = snap.docs.map(d => d.data()); });
                } else { signInAnonymously(auth); }
            });
            const globalSearch = document.getElementById('globalSearchInput');
            if (globalSearch) globalSearch.addEventListener('input', renderInventory);
            
            // New Event Listeners for Search Dropdowns
            const searchFieldSelect = document.getElementById('globalSearchField');
            if(searchFieldSelect) searchFieldSelect.addEventListener('change', renderInventory);
            
            const mobileSearchField = document.getElementById('mobileSearchField');
            if(mobileSearchField) mobileSearchField.addEventListener('change', renderInventory);
            
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if(mobileSearchInput) mobileSearchInput.addEventListener('input', renderInventory);
        });

        // Expose functions and data for inline HTML handlers
        window.closeModal = closeModal;
        window.switchPage = switchPage;
        window.switchRfidMode = switchRfidMode; 
        window.openQrModal = openQrModal;
        window.resetBindSelection = resetBindSelection;
        // window.sampleInventory is set inside onSnapshot
        window.openActionModal = openActionModal;
    </script>
</body>
</html>