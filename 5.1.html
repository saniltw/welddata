<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢ç›¤é»ç³»çµ± (RFIDç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border: 1px solid #e5e7eb; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none; appearance: none;
        }
        .admin-tab-active { color: #4f46e5; border-color: #4f46e5; }
        .status-dot { height: 0.6rem; width: 0.6rem; border-radius: 50%; display: inline-block; margin-right: 0.3rem; }
        .status-dot.active { background-color: #22c55e; }
        .status-dot.repair { background-color: #eab308; }
        .status-dot.unused { background-color: #9ca3af; }
        
        /* æ¬Šé™æ§åˆ¶æ¨£å¼ */
        .role-guest .action-edit, 
        .role-guest .action-delete, 
        .role-guest .action-add,
        .role-guest .action-bind, 
        .role-guest .action-unbind,
        .role-guest .action-submit { display: none !important; }

        /* Operator ä¹Ÿä¸èƒ½åŸ·è¡Œç®¡ç†å“¡çš„ç¶å®šæ“ä½œ */
        .role-operator .action-bind,
        .role-operator .action-unbind { display: none !important; }
        
        /* Progress Bar */
        .progress-bar-container { width: 100%; background-color: #e2e8f0; border-radius: 9999px; height: 20px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; }

        /* User Switcher Hover Effect */
        #user-status-container { @apply cursor-pointer hover:bg-gray-100 rounded-lg p-2 transition-colors border border-transparent hover:border-gray-200; }

        /* Pagination Controls */
        .pagination-btn { @apply px-3 py-1 border rounded bg-white text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm font-medium; }
        .pagination-info { @apply text-sm text-gray-600 font-mono mx-2; }

        /* RFID Input Focus Animation */
        .rfid-listening { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        
        /* Scan Flash Animation */
        @keyframes flash-green { 0% { background-color: #dcfce7; } 100% { background-color: white; } }
        .scan-success { animation: flash-green 1s ease-out; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-slate-600 font-bold">ç³»çµ±è¼‰å…¥ä¸­ï¼Œæ­£åœ¨åŒæ­¥è³‡æ–™...</p>
        <div id="loading-status-details" class="mt-2 text-xs text-slate-400 space-y-1">
            <!-- è©³ç´°è¼‰å…¥ç‹€æ…‹å°‡ç”± JS æ’å…¥ -->
        </div>
        <button id="reload-btn" onclick="window.location.reload()" class="mt-6 bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-300 hidden">
            ç¶²è·¯é€£ç·šç·©æ…¢ï¼Ÿé»æ“Šé‡æ–°æ•´ç†
        </button>
    </div>

    <!-- ç™»å…¥/åˆ‡æ›ä½¿ç”¨è€… Modal -->
    <div id="user-switch-modal" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center p-4 z-[150] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="flex justify-end">
                <button onclick="document.getElementById('user-switch-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">åˆ‡æ›ä½¿ç”¨è€…</h1>
                <p class="text-slate-500 mt-2">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ä½¿ç”¨è€…</label>
                    <select id="login-user-select" class="form-select w-full p-3 border border-gray-300 rounded-xl text-lg bg-slate-50 focus:ring-2 focus:ring-indigo-500">
                        <option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>
                        <!-- ä½¿ç”¨è€…åˆ—è¡¨å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
                    </select>
                </div>
                
                <button onclick="window.app.handleLogin()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl text-lg hover:bg-indigo-700 shadow-lg transform transition hover:scale-[1.02]">
                    ç¢ºèªåˆ‡æ›
                </button>
            </div>
            <p class="text-center text-xs text-slate-400 mt-6">è³‡ç”¢ç›¤é»ç³»çµ± v1.2 (Strict Load)</p>
        </div>
    </div>

    <!-- App Container (User Mode) -->
    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8 hidden">
        <!-- Main Content -->
        <div class="flex justify-between items-center mb-6">
            <div id="user-status-container" onclick="window.app.showUserSwitchModal()" title="é»æ“Šåˆ‡æ›ä½¿ç”¨è€…">
                <div id="logged-in-view" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-sm">
                        <span id="user-avatar-text">è¨ª</span>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-center">
                            <strong id="logged-in-name" class="text-slate-700 text-sm">è¨ªå®¢</strong>
                            <span id="role-badge" class="ml-2 px-1.5 py-0.5 rounded text-[10px] bg-gray-200 text-gray-700">è¨ªå®¢</span>
                        </div>
                        <span class="text-[10px] text-indigo-500 cursor-pointer">åˆ‡æ›ä½¿ç”¨è€…</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <!-- æ–°å¢ï¼šRFID é–‹é—œæŒ‰éˆ• -->
                <button id="rfid-toggle-btn" onclick="window.app.toggleRfidListener()" class="hidden sm:flex items-center text-xs font-bold bg-green-100 text-green-700 border border-green-200 px-3 py-1 rounded-full hover:bg-green-200 transition-colors" title="é»æ“Šæš«åœ/é–‹å•Ÿ RFID ç›£è½">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse" id="rfid-status-dot"></span>
                    <span id="rfid-status-text">ç›£è½ä¸­</span>
                </button>
                <button id="toggle-mode-btn" onclick="window.app.toggleManagementMode()" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 text-sm hidden">âš™ï¸ ç®¡ç†å¾Œå°</button>
            </div>
        </div>

        <!-- ç›¤é»æ¨¡å¼ (User Mode) -->
        <div id="user-mode">
            <header class="mb-6 border-b pb-4">
                <div class="flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 flex items-center">
                            ğŸ“¦ è³‡ç”¢ç›¤é»ç³»çµ±
                        </h1>
                        <p class="text-slate-500 mt-1 text-sm">è«‹ä½¿ç”¨ RFID æƒææ§é€²è¡Œç›¤é» (ä¸€ç‰©ä¸€ç¢¼)</p>
                    </div>
                    <div class="text-right">
                         <label class="text-xs font-bold text-slate-500 block mb-1">ç•¶å‰ç›¤é»å ´æ¬¡</label>
                         <input type="month" id="inventory-session-select" class="border rounded p-1 text-sm font-bold text-indigo-700 bg-white" onchange="window.app.changeInventorySession()">
                    </div>
                </div>
                <p class="text-red-500 font-bold hidden guest-warning mt-2 text-sm bg-red-50 p-2 rounded">âš ï¸ è¨ªå®¢æ¨¡å¼ï¼šåƒ…ä¾›æª¢è¦–ï¼Œç„¡æ³•åŸ·è¡Œç›¤é»å¯«å…¥</p>
            </header>

            <!-- ç›¤é»å„€è¡¨æ¿ -->
            <div id="inventory-dashboard" class="space-y-6">
                
                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-4 border-l-4 border-slate-500">
                        <p class="text-xs text-slate-500 font-bold uppercase">æ‡‰ç›¤è³‡ç”¢ç¸½æ•¸</p>
                        <p id="total-assets-count" class="text-3xl font-bold text-slate-700 mt-1">0</p>
                    </div>
                    <div class="card p-4 border-l-4 border-green-500 bg-green-50">
                        <p class="text-xs text-green-600 font-bold uppercase">å·²ç›¤é»æ•¸é‡</p>
                        <p id="counted-assets-count" class="text-3xl font-bold text-green-700 mt-1">0</p>
                    </div>
                    <div class="card p-4 border-l-4 border-red-500">
                        <p class="text-xs text-red-500 font-bold uppercase">æœªç›¤é»æ•¸é‡</p>
                        <p id="uncounted-assets-count" class="text-3xl font-bold text-red-700 mt-1">0</p>
                    </div>
                </div>

                <!-- é€²åº¦æ¢ -->
                <div class="card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-slate-700">ç›¤é»é€²åº¦</h3>
                        <span id="progress-percentage" class="text-indigo-600 font-bold">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="main-progress-bar" class="progress-bar-fill bg-indigo-600" style="width: 0%">0%</div>
                    </div>
                </div>

                <!-- æƒæå›é¥‹å€ (æœ€æ–°æƒæ) -->
                <div id="last-scan-feedback" class="hidden p-4 rounded-lg border-2 border-green-500 bg-green-50 text-center transition-all">
                    <p class="text-green-800 text-sm font-bold mb-1">æƒææˆåŠŸï¼</p>
                    <p id="last-scan-name" class="text-2xl font-bold text-slate-800">è¨­å‚™åç¨±</p>
                    <p id="last-scan-id" class="text-xs text-slate-500 font-mono mt-1">ID: ...</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- å·²ç›¤æ¸…å–® -->
                    <div class="card p-0 overflow-hidden h-96 flex flex-col">
                        <div class="p-3 bg-green-100 border-b border-green-200 flex justify-between items-center">
                            <h3 class="font-bold text-green-800">âœ… å·²ç›¤é»æ¸…å–® (æœ€æ–° 20 ç­†)</h3>
                            <span id="counted-list-badge" class="bg-white text-green-600 px-2 py-0.5 rounded text-xs font-bold">0</span>
                        </div>
                        <div id="counted-list-container" class="flex-1 overflow-y-auto p-2 space-y-2 bg-white">
                            <p class="text-center text-gray-400 text-sm mt-4">å°šç„¡ç›¤é»ç´€éŒ„</p>
                        </div>
                    </div>

                    <!-- æœªç›¤æ¸…å–® -->
                    <div class="card p-0 overflow-hidden h-96 flex flex-col">
                        <div class="p-3 bg-red-100 border-b border-red-200 flex justify-between items-center">
                            <h3 class="font-bold text-red-800">âŒ æœªç›¤é»æ¸…å–®</h3>
                            <div class="flex gap-2">
                                <select id="uncounted-category-filter" onchange="window.app.renderUncountedList()" class="text-xs border rounded p-1"><option value="ALL">å…¨éƒ¨åˆ†é¡</option></select>
                                <span id="uncounted-list-badge" class="bg-white text-red-600 px-2 py-0.5 rounded text-xs font-bold">0</span>
                            </div>
                        </div>
                        <div id="uncounted-list-container" class="flex-1 overflow-y-auto p-2 space-y-2 bg-white">
                            <p class="text-center text-gray-400 text-sm mt-4">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å¾Œå° (Admin Mode) -->
        <div id="admin-mode" class="hidden">
            <header class="mb-6"><h1 class="text-4xl font-bold text-slate-800">ç®¡ç†å¾Œå°</h1></header>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-4 overflow-x-auto text-sm font-medium">
                    <button onclick="window.app.switchAdminTab('equipment')" id="tab-equipment" class="px-1 py-3 border-b-2 admin-tab-active">è¨­å‚™ç®¡ç† & RFID ç¶å®š</button>
                    <button onclick="window.app.switchAdminTab('users')" id="tab-users" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600 action-delete">äººå“¡ç®¡ç†</button>
                    <button onclick="window.app.switchAdminTab('inventoryHistory')" id="tab-inventoryHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">ç›¤é»æ­·å²ç´€éŒ„</button>
                </nav>
            </div>
            
            <div id="admin-tab-content-equipment">
                <div id="equipment-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">è¨­å‚™åˆ—è¡¨ (å« RFID ç¶å®š)</h2>
                        <button onclick="window.app.showEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm action-add">æ–°å¢è¨­å‚™</button>
                    </div>
                    <div id="equipment-category-tabs" class="mb-6"></div>
                    <div id="equipment-list-container"></div>
                </div>
                
                <!-- è¨­å‚™ç·¨è¼¯å™¨ (ç°¡åŒ–ç‰ˆï¼Œç§»é™¤é»æª¢æ’ç¨‹ç­‰) -->
                <div id="equipment-editor-section" class="hidden card p-6">
                    <h2 id="editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯è¨­å‚™</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™ç·¨è™Ÿ (ID)</label><input type="text" id="edit-device-id" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™åç¨±</label><input type="text" id="edit-device-name" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™å€åˆ†</label><select id="edit-device-category-select" class="w-full p-2 border rounded mb-2"></select><input type="text" id="edit-device-category-new" class="w-full p-2 border rounded hidden" placeholder="è¼¸å…¥æ–°åˆ†é¡..."></div>
                            <div><label class="block text-xs font-medium text-slate-500">æ”¾ç½®åœ°é»</label><input type="text" id="edit-device-location" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><input type="text" id="edit-device-asset" class="w-full p-2 border rounded"></div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500">ç¾æ³</label>
                                <select id="edit-device-status" class="w-full p-2 border rounded form-select">
                                    <option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option>
                                    <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
                                    <option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option>
                                </select>
                            </div>
                        </div>
                        <div><label class="block text-xs font-medium text-slate-500 mb-2">è¨­å‚™åœ–ç‰‡</label><div class="flex items-center gap-4"><img id="image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border"><button type="button" onclick="document.getElementById('edit-device-image').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ğŸ“· æ‹ç…§ / ä¸Šå‚³</button><input type="file" id="edit-device-image" accept="image/*" class="hidden" onchange="window.app.handleImageUpload(this)"></div></div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveEquipment(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </div>

            <div id="admin-tab-content-users" class="hidden">
                 <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">äººå“¡åˆ—è¡¨</h2><button onclick="window.app.showUserEditor()" class="bg-indigo-600 text-white px-4 py-2 rounded action-add">æ–°å¢</button></div>
                <div id="user-list-container" class="space-y-2"></div>
                <div id="user-editor-section" class="hidden card p-6">
                    <h2 id="user-editor-title" class="text-xl font-bold mb-4">ç·¨è¼¯äººå“¡</h2>
                    <div class="space-y-3"><input type="text" id="edit-user-id" placeholder="ID" class="w-full p-2 border rounded"><input type="text" id="edit-user-name" placeholder="å§“å" class="w-full p-2 border rounded"><select id="edit-user-role" class="w-full p-2 border rounded"><option value="operator">æ“ä½œå“¡</option><option value="manager">ç®¡ç†å“¡</option></select><input type="password" id="edit-user-password" placeholder="å¯†ç¢¼ (ç®¡ç†å“¡å¿…å¡«)" class="w-full p-2 border rounded hidden"></div>
                    <div class="flex justify-end gap-2 mt-4"><button onclick="window.app.showUserList()" class="bg-gray-200 px-4 py-2 rounded">å–æ¶ˆ</button><button onclick="window.app.saveUser(this)" class="bg-indigo-600 text-white px-4 py-2 rounded">å„²å­˜</button></div>
                </div>
            </div>

             <div id="admin-tab-content-inventoryHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">ç›¤é»æ­·å²ç´€éŒ„ (æ‰€æœ‰ç´€éŒ„)</h2>
                <div id="inventory-history-log-container"></div>
             </div>
        </div>
    </div>
    
    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center p-4 z-[200] hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <div class="mb-4">
                <h3 class="text-xl font-bold text-slate-900 text-center mb-2">ç¢ºèªæ“ä½œ</h3>
                <p id="custom-confirm-msg" class="text-sm text-slate-500 text-center">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            </div>
            <div class="flex flex-col gap-2 sm:flex-row-reverse">
                <button id="custom-confirm-btn-yes" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:w-auto sm:text-sm">ç¢ºå®š</button>
                <button onclick="window.app.closeConfirmModal()" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:w-auto sm:text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- RFID Binding Modal -->
    <div id="rfid-bind-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[160] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 mb-6">
                <svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">RFID ç¶å®šæ¨¡å¼</h2>
            <p class="text-slate-500 mb-6">æ­£åœ¨ç‚º <span id="bind-target-name" class="font-bold text-indigo-600">è¨­å‚™</span> ç¶å®šæ¨™ç±¤</p>
            
            <div class="bg-slate-100 p-4 rounded-lg mb-6 relative">
                <p class="text-sm text-slate-500 mb-2">è«‹ä½¿ç”¨ RFID æƒææ§æƒææ¨™ç±¤...</p>
                <input type="text" id="rfid-bind-input" class="w-full p-3 border-2 border-slate-300 rounded-lg text-center font-mono font-bold text-xl focus:border-indigo-500 outline-none" placeholder="ç­‰å¾…æƒæ..." autocomplete="off">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                     <span class="animate-ping absolute inline-flex h-3 w-3 rounded-full bg-indigo-400 opacity-75 right-4"></span>
                </div>
            </div>
            
            <div class="flex gap-3 justify-center">
                <button onclick="window.app.closeBindModal()" class="px-6 py-2 bg-slate-200 rounded-lg text-slate-700 font-bold hover:bg-slate-300">å–æ¶ˆ</button>
                <button onclick="window.app.confirmBind()" class="px-6 py-2 bg-indigo-600 rounded-lg text-white font-bold hover:bg-indigo-700">æ‰‹å‹•ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[210] space-y-3 w-full max-w-xs"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, writeBatch, serverTimestamp, updateDoc, Timestamp, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let equipmentDatabase = {}, userDatabase = {}, rfidBindings = {}, inventoryRecords = [];
        let loggedInUser = null;
        let currentInventorySession = ""; // YYYY-MM
        let bindTargetId = null; // ç•¶å‰æ­£åœ¨ç¶å®šçš„è¨­å‚™ ID
        let isRfidEnabled = true; // æ–°å¢ï¼šRFID é–‹é—œç‹€æ…‹

        // åš´æ ¼è¼‰å…¥æ¨¡å¼ç‹€æ…‹ (New)
        let dataSyncStatus = {
            users: false,
            equipment: false,
            bindings: false
        };
        let isAppReady = false;

        // RFID Buffer
        let rfidBuffer = "";
        let rfidTimer = null;
        const RFID_TIMEOUT = 100; // ms

        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `p-4 rounded shadow-lg text-white font-bold transition-opacity duration-500 opacity-0 transform translate-y-2 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.remove('opacity-0', 'translate-y-2'); });
            setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => { if (container.contains(toast)) { container.removeChild(toast); } }, 500); }, 3000);
        };

        window.app = {}; 
        
        // --- æ–°å¢ï¼šRFID é–‹é—œé‚è¼¯ ---
        window.app.toggleRfidListener = function() {
            isRfidEnabled = !isRfidEnabled;
            const btn = document.getElementById('rfid-toggle-btn');
            const dot = document.getElementById('rfid-status-dot');
            const text = document.getElementById('rfid-status-text');
            
            if (isRfidEnabled) {
                // é–‹å•Ÿç‹€æ…‹
                btn.classList.remove('bg-red-100', 'text-red-700', 'border-red-200', 'hover:bg-red-200');
                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200', 'hover:bg-green-200');
                dot.classList.remove('bg-red-500');
                dot.classList.add('bg-green-500', 'animate-pulse');
                text.textContent = "ç›£è½ä¸­";
                showToast("RFID ç›£è½å·²é–‹å•Ÿ", "success");
            } else {
                // æš«åœç‹€æ…‹
                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-200', 'hover:bg-green-200');
                btn.classList.add('bg-red-100', 'text-red-700', 'border-red-200', 'hover:bg-red-200');
                dot.classList.remove('bg-green-500', 'animate-pulse');
                dot.classList.add('bg-red-500');
                text.textContent = "å·²æš«åœ";
                showToast("RFID ç›£è½å·²æš«åœ", "info");
            }
            // é»æ“Šå¾Œå¤±ç„¦ï¼Œé¿å… Enter è§¸ç™¼
            btn.blur();
        };

        // --- RFID Handler (Global Listener) ---
        // æ ¸å¿ƒé‚è¼¯ï¼šHID æ¨¡å¼æƒææ§æœƒåƒéµç›¤ä¸€æ¨£å¿«é€Ÿè¼¸å…¥å­—å…ƒä¸¦ä»¥ Enter çµæŸ
        document.addEventListener('keydown', (e) => {
            // å¦‚æœæ˜¯åœ¨ç¶å®šè¦–çª—çš„ Inputï¼Œæˆ‘å€‘è®“å®ƒè‡ªç„¶è¼¸å…¥ï¼Œç„¶å¾Œç›£è½ Enter
            if (document.activeElement.id === 'rfid-bind-input') {
                if (e.key === 'Enter') {
                    window.app.confirmBind();
                }
                return;
            }

            // å¦‚æœæ˜¯åœ¨å…¶ä»–è¼¸å…¥æ¡†æ‰“å­—ï¼Œå¿½ç•¥
            const activeTag = document.activeElement.tagName;
            if (activeTag === 'INPUT' || activeTag === 'TEXTAREA' || activeTag === 'SELECT') return;

            // æª¢æŸ¥å…¨åŸŸé–‹é—œ (Feature 1)
            if (!isRfidEnabled) return;

            // é–‹å§‹æ¥æ”¶ HID è¨Šè™Ÿ
            if (e.key === 'Enter') {
                if (rfidBuffer.length > 3) { // å‡è¨­ Tag è‡³å°‘ 3 ç¢¼
                    // æ””æˆª Enter éµï¼Œé¿å…è§¸ç™¼æŒ‰éˆ•é»æ“Š (Fix Issue 2)
                    e.preventDefault();
                    window.app.handleGlobalScan(rfidBuffer);
                }
                rfidBuffer = "";
            } else {
                // éæ¿¾éå­—å…ƒéµ (Shift, Ctrl ç­‰)
                if (e.key.length === 1) {
                    rfidBuffer += e.key;
                    // å¦‚æœå¤ªä¹…æ²’è¼¸å…¥ä¸‹ä¸€ç¢¼ï¼Œè¦–ç‚ºæ‰‹å‹•æ‰“å­—ï¼Œæ¸…ç©º Buffer
                    clearTimeout(rfidTimer);
                    rfidTimer = setTimeout(() => { rfidBuffer = ""; }, RFID_TIMEOUT);
                }
            }
        });

        // è™•ç†å…¨åŸŸæƒæ (ç›¤é»æ¨¡å¼)
        window.app.handleGlobalScan = async function(code) {
            // é˜²å‘†æª¢æŸ¥ (New Feature): è³‡æ–™å°šæœªæº–å‚™å¥½ï¼Œç¦æ­¢æ“ä½œ
            if (!isAppReady) {
                window.app.playErrorSound();
                showToast("ç³»çµ±è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...", "warning");
                return;
            }

            // å¿…é ˆåœ¨ User Mode ä¸”ä¸åœ¨ Modal ä¸­
            const userMode = document.getElementById('user-mode');
            if (userMode.classList.contains('hidden')) return; // åœ¨ç®¡ç†å¾Œå°ä¸è§¸ç™¼ç›¤é»
            if (!document.getElementById('user-switch-modal').classList.contains('hidden')) return;

            console.log("Scanned RFID:", code);

            // 1. æŸ¥æ‰¾ç¶å®š
            const binding = rfidBindings[code];

            if (!binding) {
                window.app.playErrorSound();
                showToast(`ç„¡æ•ˆæ¨™ç±¤: ${code} (æœªç¶å®šè¨­å‚™)`, "error");
                return;
            }

            const eqId = binding.equipmentId;
            const eq = equipmentDatabase[eqId];

            if (!eq) {
                window.app.playErrorSound();
                showToast(`æ‰¾ä¸åˆ°å°æ‡‰è¨­å‚™ (ID: ${eqId})`, "error");
                return;
            }

            // 2. åŸ·è¡Œç›¤é»å¯«å…¥ (ä¸€ç‰©ä¸€ç¢¼)
            await window.app.submitInventoryRecord(eq, code);
        };

        window.app.submitInventoryRecord = async function(eq, rfidCode) {
            if (loggedInUser.role === 'guest') {
                window.app.playErrorSound();
                showToast("è¨ªå®¢ç„¡æ³•åŸ·è¡Œç›¤é»å¯«å…¥", "error");
                return;
            }

            // æª¢æŸ¥æœ¬å ´æ¬¡æ˜¯å¦å·²ç›¤é»é (é¿å…é‡è¤‡è¨ˆæ•¸ï¼Œé›–ç„¶è³‡æ–™åº«å¯ä»¥å­˜ï¼Œä½† UI è¦æç¤º)
            const alreadyCounted = inventoryRecords.some(r => r.sessionId === currentInventorySession && r.equipmentId === eq.id);
            
            if (alreadyCounted) {
                window.app.playSuccessSound(true); // Double beep for "Already done"
                showToast(`é‡è¤‡æƒæ: ${eq.name}`, "info");
                window.app.updateLastScanFeedback(eq, "é‡è¤‡ç›¤é»");
                return;
            }

            try {
                const record = {
                    sessionId: currentInventorySession,
                    equipmentId: eq.id,
                    equipmentName: eq.name,
                    rfidCode: rfidCode,
                    userId: loggedInUser.id,
                    userName: loggedInUser.name,
                    timestamp: serverTimestamp(),
                    scanTimeStr: new Date().toLocaleString()
                };

                // å¯«å…¥ inventory_records
                await addDoc(getCollectionRef("inventory_records"), record);
                
                window.app.playSuccessSound();
                showToast(`ç›¤é»æˆåŠŸ: ${eq.name}`, "success");
                window.app.updateLastScanFeedback(eq, "æƒææˆåŠŸ");

            } catch(e) {
                console.error(e);
                window.app.playErrorSound();
                showToast("å¯«å…¥å¤±æ•—: " + e.message, "error");
            }
        };

        window.app.updateLastScanFeedback = function(eq, statusText) {
            const box = document.getElementById('last-scan-feedback');
            document.getElementById('last-scan-name').textContent = eq.name;
            document.getElementById('last-scan-id').textContent = `ID: ${eq.id} | ${statusText}`;
            box.classList.remove('hidden', 'bg-green-50', 'bg-yellow-50', 'border-green-500', 'border-yellow-500');
            
            // Trigger animation
            void box.offsetWidth; 

            if (statusText === 'é‡è¤‡ç›¤é»') {
                box.classList.add('bg-yellow-50', 'border-yellow-500');
            } else {
                box.classList.add('bg-green-50', 'border-green-500', 'scan-success');
            }
        };

        window.app.playSuccessSound = function(isRepeat = false) {
            // Simple oscillator beep
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            if (isRepeat) {
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
                // Second beep
                const osc2 = ctx.createOscillator();
                const gain2 = ctx.createGain();
                osc2.connect(gain2);
                gain2.connect(ctx.destination);
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(880, ctx.currentTime + 0.15);
                gain2.gain.setValueAtTime(0.1, ctx.currentTime + 0.15);
                osc2.start(ctx.currentTime + 0.15);
                osc2.stop(ctx.currentTime + 0.25);
            } else {
                osc.frequency.setValueAtTime(1200, ctx.currentTime); // High pitch for success
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            }
        };

        window.app.playErrorSound = function() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, ctx.currentTime); // Low pitch
            gain.gain.setValueAtTime(0.2, ctx.currentTime);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        };

        let confirmCallback = null;
        window.app.confirmAction = function(message, callback) { document.getElementById('custom-confirm-msg').textContent = message; confirmCallback = callback; document.getElementById('custom-confirm-modal').classList.remove('hidden'); document.getElementById('custom-confirm-modal').classList.add('flex'); };
        window.app.closeConfirmModal = function() { document.getElementById('custom-confirm-modal').classList.add('hidden'); document.getElementById('custom-confirm-modal').classList.remove('flex'); confirmCallback = null; };
        const confirmBtn = document.getElementById('custom-confirm-btn-yes'); if(confirmBtn) { confirmBtn.onclick = function() { if (confirmCallback) confirmCallback(); window.app.closeConfirmModal(); }; }

        const firebaseConfig = { apiKey: "", authDomain: "checklist-20250825.firebaseapp.com", databaseURL: "https://checklist-20250825-default-rtdb.firebaseio.com", projectId: "checklist-20250825", storageBucket: "checklist-20250825.appspot.com", messagingSenderId: "899658463753", appId: "1:899658463753:web:71819671db2cdf6bf4d6d8", measurementId: "G-FH3F97BZ7F" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        function getCollectionRef(name) { return collection(db, name); }
        function getDocRef(colName, docId) { return doc(db, colName, docId); }

        const init = () => {
            window.app.loginAsGuest();
            startListeners();
            // Set default session to current month
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            currentInventorySession = `${yyyy}-${mm}`;
            const sessionSelect = document.getElementById('inventory-session-select');
            if(sessionSelect) sessionSelect.value = currentInventorySession;
            
            // Timeout Watchdog (New Feature)
            setTimeout(() => {
                if (!isAppReady) {
                    const reloadBtn = document.getElementById('reload-btn');
                    if (reloadBtn) reloadBtn.classList.remove('hidden');
                    const loadingText = document.getElementById('loading-text');
                    if (loadingText) loadingText.textContent = "ç¶²è·¯é€£ç·šç·©æ…¢ï¼ŒåŒæ­¥è¶…æ™‚";
                }
            }, 15000); // 15 seconds
        };
        
        // --- Strict Loading Check Logic ---
        function checkDataReadiness() {
            const details = document.getElementById('loading-status-details');
            if(details) {
                details.innerHTML = `
                    <p>äººå“¡è³‡æ–™: ${dataSyncStatus.users ? 'âœ…' : 'â³'}</p>
                    <p>è¨­å‚™æ¸…å–®: ${dataSyncStatus.equipment ? 'âœ…' : 'â³'}</p>
                    <p>RFID å°ç…§è¡¨: ${dataSyncStatus.bindings ? 'âœ…' : 'â³'}</p>
                `;
            }

            if (dataSyncStatus.users && dataSyncStatus.equipment && dataSyncStatus.bindings) {
                console.log("All data synced. App Ready.");
                isAppReady = true;
                window.app.hideLoading();
            }
        }

        window.app.hideLoading = function() {
            // åªæœ‰ç•¶ App Ready ä¸” å·²ç¶“æœ‰ç™»å…¥è€… (loginAsGuest é è¨­æœƒç™»å…¥) æ™‚ï¼Œæ‰çœŸæ­£éš±è—
            if (isAppReady && loggedInUser) {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                // å¦‚æœæ˜¯æ‰‹å‹•é‡æ•´ä¸”é‚„æœªåˆ‡æ›éä½¿ç”¨è€…ï¼Œé è¨­æœƒé€²å…¥ Guest Modeï¼Œä¸éœ€è¦å½ˆ Modal
                // é™¤éæƒ³å¼·åˆ¶ç¬¬ä¸€æ¬¡é¡¯ç¤º Switch Modal? ç›®å‰é‚è¼¯æ˜¯ç›´æ¥é€²å…¥ App Container
            }
        };
        
        window.app.changeInventorySession = function() {
            currentInventorySession = document.getElementById('inventory-session-select').value;
            window.app.renderInventoryDashboard();
        };

        window.app.loginAsGuest = function() { 
            loggedInUser = { id: 'guest', name: 'è¨ªå®¢', role: 'guest' }; 
            // æ³¨æ„ï¼šé€™è£¡ä¸å†éš±è— loading-overlayï¼Œè€Œæ˜¯ç­‰å¾… checkDataReadiness
            updateUIState(); 
        };
        
        window.app.showUserSwitchModal = function() { document.getElementById('user-switch-modal').classList.remove('hidden'); renderLoginOptions(); };
        
        window.app.renderInventoryDashboard = function() {
            if (!equipmentDatabase) return;
            
            const totalAssetsEl = document.getElementById('total-assets-count');
            const countedAssetsEl = document.getElementById('counted-assets-count');
            const uncountedAssetsEl = document.getElementById('uncounted-assets-count');
            const progressEl = document.getElementById('main-progress-bar');
            const progressText = document.getElementById('progress-percentage');
            const countedList = document.getElementById('counted-list-container');
            
            // 1. è¨ˆç®—æ‡‰ç›¤ç¸½æ•¸ (Active Equipment)
            const activeEquipments = Object.values(equipmentDatabase).filter(e => e.status !== 'æœªä½¿ç”¨'); // å‡è¨­"æœªä½¿ç”¨"çš„ä¸éœ€ç›¤é»
            const total = activeEquipments.length;
            totalAssetsEl.textContent = total;

            // 2. ç¯©é¸æœ¬å ´æ¬¡ç´€éŒ„
            const sessionRecords = inventoryRecords.filter(r => r.sessionId === currentInventorySession);
            // Unique Equipment Counted
            const countedIds = new Set(sessionRecords.map(r => r.equipmentId));
            const countedCount = countedIds.size;
            
            countedAssetsEl.textContent = countedCount;
            uncountedAssetsEl.textContent = total - countedCount;

            // 3. é€²åº¦æ¢
            const percent = total === 0 ? 0 : Math.round((countedCount / total) * 100);
            progressEl.style.width = `${percent}%`;
            progressEl.textContent = `${percent}%`;
            progressText.textContent = `${percent}%`;

            // 4. æ¸²æŸ“å·²ç›¤é»åˆ—è¡¨ (æœ€æ–° 20 ç­†)
            // Sort by timestamp desc
            const sortedRecords = [...sessionRecords].sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 20);
            
            document.getElementById('counted-list-badge').textContent = countedCount;

            if (sortedRecords.length === 0) {
                countedList.innerHTML = '<p class="text-center text-gray-400 text-sm mt-4">å°šç„¡ç›¤é»ç´€éŒ„</p>';
            } else {
                countedList.innerHTML = sortedRecords.map(r => `
                    <div class="flex justify-between items-center p-2 border-b last:border-0 hover:bg-slate-50">
                        <div>
                            <div class="font-bold text-slate-700 text-sm">${r.equipmentName}</div>
                            <div class="text-xs text-gray-400 font-mono">${r.rfidCode}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">${new Date(r.timestamp?.toDate()).toLocaleTimeString()}</div>
                            <div class="text-[10px] text-gray-400">${r.userName}</div>
                        </div>
                    </div>
                `).join('');
            }

            // 5. æ¸²æŸ“æœªç›¤é»åˆ—è¡¨ (éœ€é…åˆåˆ†é¡ç¯©é¸)
            window.app.renderUncountedList(countedIds);
        };

        window.app.renderUncountedList = function(countedIdsSet = null) {
            if (!countedIdsSet) {
                 const sessionRecords = inventoryRecords.filter(r => r.sessionId === currentInventorySession);
                 countedIdsSet = new Set(sessionRecords.map(r => r.equipmentId));
            }

            const container = document.getElementById('uncounted-list-container');
            const filterCat = document.getElementById('uncounted-category-filter').value;
            
            // Populate filter if empty
            const catFilterEl = document.getElementById('uncounted-category-filter');
            if (catFilterEl.options.length === 1) {
                const cats = new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'));
                cats.forEach(c => catFilterEl.add(new Option(c, c)));
            }

            const uncounted = Object.values(equipmentDatabase).filter(e => {
                if (e.status === 'æœªä½¿ç”¨') return false;
                if (countedIdsSet.has(e.id)) return false;
                if (filterCat !== 'ALL' && (e.category || 'æœªåˆ†é¡') !== filterCat) return false;
                return true;
            });

            document.getElementById('uncounted-list-badge').textContent = uncounted.length;

            if (uncounted.length === 0) {
                 container.innerHTML = '<p class="text-center text-green-500 text-sm mt-4">ğŸ‰ è©²åˆ†é¡å·²å…¨éƒ¨ç›¤é»å®Œæˆ</p>';
            } else {
                container.innerHTML = uncounted.map(e => `
                    <div class="p-2 border-b last:border-0 hover:bg-slate-50 flex justify-between items-center">
                        <div>
                             <div class="font-bold text-slate-700 text-sm">${e.name}</div>
                             <div class="text-xs text-gray-400">${e.category || 'æœªåˆ†é¡'} | ${e.location || 'ç„¡åœ°é»'}</div>
                        </div>
                        <div class="text-xs text-red-400 font-bold">æœªç›¤</div>
                    </div>
                `).join('');
            }
        };

        function startListeners() {
            onSnapshot(getCollectionRef("users"), (snap) => { 
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; }); userDatabase = newData; renderLoginOptions(); 
                const listContainer = document.getElementById('user-list-container');
                if (listContainer && listContainer.offsetParent) window.app.renderUserList();
                // Flag ready
                dataSyncStatus.users = true;
                checkDataReadiness();
            });
            onSnapshot(getCollectionRef("equipment"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                equipmentDatabase = newData;
                window.app.renderEquipmentList();
                window.app.renderInventoryDashboard();
                // Flag ready
                dataSyncStatus.equipment = true;
                checkDataReadiness();
            });
            
            // ç›£è½ RFID Bindings (æ–¹æ¡ˆ B)
            onSnapshot(getCollectionRef("rfid_bindings"), (snap) => {
                rfidBindings = {};
                snap.forEach(d => {
                    rfidBindings[d.id] = { rfidCode: d.id, ...d.data() };
                });
                console.log("RFID Bindings synced:", Object.keys(rfidBindings).length);
                if (document.getElementById('equipment-list-section').offsetParent) {
                    window.app.renderEquipmentList();
                }
                // Flag ready
                dataSyncStatus.bindings = true;
                checkDataReadiness();
            });

            // ç›£è½ Inventory Records (ä¸å¼·åˆ¶æ“‹ App Loadï¼Œå› ç‚ºæ­·å²ç´€éŒ„å¯èƒ½å¾ˆå¤§ï¼Œä½†é€šå¸¸ä¹Ÿå¾ˆå¿«)
            onSnapshot(getCollectionRef("inventory_records"), (snap) => {
                inventoryRecords = snap.docs.map(d => ({id: d.id, ...d.data()}));
                window.app.renderInventoryDashboard();
                const historyEl = document.getElementById('admin-tab-content-inventoryHistory');
                if (historyEl && historyEl.offsetParent) window.app.renderInventoryHistory();
            });
        }

        function renderLoginOptions() { const select = document.getElementById('login-user-select'); if(!select) return; select.innerHTML = '<option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>'; Object.values(userDatabase).forEach(user => { const roleText = user.role === 'manager' ? 'ğŸ‘‘ ç®¡ç†å“¡' : 'ğŸ”§ æ“ä½œå“¡'; select.add(new Option(`${roleText} - ${user.name}`, user.id)); }); }
        
        window.app.handleLogin = function() { 
            const select = document.getElementById('login-user-select'); 
            const userId = select.value; 
            if (userId === 'guest') { loggedInUser = { id: 'guest', name: 'è¨ªå®¢', role: 'guest' }; } 
            else { loggedInUser = userDatabase[userId]; } 
            
            if (!loggedInUser) return showToast("ç™»å…¥éŒ¯èª¤ï¼Œè«‹é‡è©¦", "error"); 
            document.getElementById('user-switch-modal').classList.add('hidden'); 
            updateUIState();
            // ç™»å…¥å¾Œå˜—è©¦ hideLoading (å¦‚æœè³‡æ–™å·²ç¶“ ready)
            window.app.hideLoading();
        };
        
        window.app.logout = function() { window.app.showUserSwitchModal(); };
        
        function updateUIState() { const loggedInName = document.getElementById('logged-in-name'); const roleBadge = document.getElementById('role-badge'); const avatarText = document.getElementById('user-avatar-text'); const toggleBtn = document.getElementById('toggle-mode-btn'); const guestWarning = document.querySelector('.guest-warning'); loggedInName.textContent = loggedInUser.name; avatarText.textContent = loggedInUser.name.charAt(0); document.body.classList.remove('role-guest', 'role-operator', 'role-manager'); document.body.classList.add(`role-${loggedInUser.role}`); let roleName = 'è¨ªå®¢'; let roleClass = 'bg-gray-200 text-gray-700'; if (loggedInUser.role === 'manager') { roleName = 'ç®¡ç†å“¡'; roleClass = 'bg-purple-100 text-purple-800'; } else if (loggedInUser.role === 'operator') { roleName = 'æ“ä½œå“¡'; roleClass = 'bg-blue-100 text-blue-800'; } roleBadge.textContent = roleName; roleBadge.className = `ml-2 px-1.5 py-0.5 rounded text-[10px] ${roleClass}`; if (loggedInUser.role === 'guest') { if(guestWarning) guestWarning.classList.remove('hidden'); if(toggleBtn) toggleBtn.classList.remove('hidden'); } else { if(guestWarning) guestWarning.classList.add('hidden'); if(toggleBtn) { if (loggedInUser.role === 'operator') { toggleBtn.classList.add('hidden'); } else { toggleBtn.classList.remove('hidden'); } } } document.getElementById('user-mode').classList.remove('hidden'); window.app.renderEquipmentList(); }
        
        window.app.toggleManagementMode = function() { 
            const userMode = document.getElementById('user-mode'); 
            const adminMode = document.getElementById('admin-mode'); 
            const btn = document.getElementById('toggle-mode-btn'); 
            
            if (loggedInUser.role === 'operator') { return showToast("æ¬Šé™ä¸è¶³ï¼šåƒ…ç®¡ç†å“¡å¯é€²å…¥ç®¡ç†å¾Œå°", "error"); } 
            
            if (userMode.classList.contains('hidden')) { 
                userMode.classList.remove('hidden'); 
                adminMode.classList.add('hidden'); 
                btn.textContent = "âš™ï¸ ç®¡ç†å¾Œå°"; 
            } else { 
                userMode.classList.add('hidden'); 
                adminMode.classList.remove('hidden'); 
                btn.textContent = "â¬…ï¸ è¿”å›ç›¤é»"; 
                window.app.renderEquipmentList(); 
            }
            // Fix Issue 2: ç§»é™¤ç„¦é»ï¼Œé¿å… Enter éµå†æ¬¡è§¸ç™¼æ­¤æŒ‰éˆ•
            btn.blur();
        };

        window.app.switchAdminTab = function(tab) { 
            document.querySelectorAll('[id^=admin-tab-content]').forEach(d => d.classList.add('hidden')); 
            document.getElementById(`admin-tab-content-${tab}`).classList.remove('hidden'); 
            document.querySelectorAll('#admin-mode nav button').forEach(b => {
                b.classList.remove('admin-tab-active', 'text-indigo-600');
                // Fix Issue 2: ç§»é™¤ Nav æŒ‰éˆ•ç„¦é»
                b.blur();
            }); 
            document.getElementById(`tab-${tab}`).classList.add('admin-tab-active'); 
            
            if(tab === 'users') window.app.renderUserList(); 
            if(tab === 'equipment') window.app.renderEquipmentList(); 
            if(tab === 'inventoryHistory') window.app.renderInventoryHistory(); 
        };

        window.app.renderEquipmentList = function() {
            const tabsContainer = document.getElementById('equipment-category-tabs');
            const listContainer = document.getElementById('equipment-list-container');
            if(!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) { listContainer.innerHTML = '<p class="text-center text-gray-400 py-4">ç„¡è³‡æ–™</p>'; tabsContainer.innerHTML = ''; return; }
            const groups = {}; Object.values(equipmentDatabase).forEach(eq => { const cat = eq.category || 'æœªåˆ†é¡'; if (!groups[cat]) groups[cat] = []; groups[cat].push(eq); });
            const categories = Object.keys(groups).sort((a, b) => a.localeCompare(b, 'zh-TW'));
            let selectHtml = `<div class="flex items-center bg-white p-3 rounded-lg border border-gray-200 shadow-sm"><label class="mr-3 font-bold text-slate-700 flex items-center whitespace-nowrap"><svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>åˆ†é¡åˆ‡æ›:</label><select id="eq-category-select" onchange="window.app.filterEquipmentCategory(this.value)" class="form-select w-full p-2 border border-gray-300 rounded text-slate-700 font-medium focus:ring-2 focus:ring-indigo-500 bg-slate-50"><option value="ALL">ğŸ“‹ å…¨éƒ¨é¡¯ç¤º (${Object.keys(equipmentDatabase).length} å°)</option>`;
            categories.forEach(cat => { selectHtml += `<option value="${cat}">${cat} (${groups[cat].length})</option>`; }); selectHtml += `</select></div>`; tabsContainer.innerHTML = selectHtml; 
            let listHtml = ''; categories.forEach((cat) => { listHtml += `<div id="cat-content-${cat}" class="eq-category-group space-y-3 mb-6"><h3 class="font-bold text-slate-500 text-sm border-b pb-1 mb-2 mt-4">${cat}</h3>`; groups[cat].forEach(eq => { const imgUrl = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; let statusClass = 'active'; if(eq.status==='ç¶­ä¿®ä¸­') statusClass='repair'; else if(eq.status==='æœªä½¿ç”¨') statusClass='unused'; 
            
            // æª¢æŸ¥ RFID ç¶å®šç‹€æ…‹ (Fix Issue 3)
            const boundTag = Object.values(rfidBindings).find(b => b.equipmentId === eq.id);
            const rfidBadge = boundTag 
                ? `<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] font-bold border border-indigo-200">RFID: ${boundTag.rfidCode}</span>` 
                : `<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] border border-gray-200">æœªç¶å®š RFID</span>`;

            // å‹•æ…‹ç”¢ç”ŸæŒ‰éˆ•ï¼šç¶å®š æˆ– è§£é™¤
            let bindButtonHtml = '';
            if (boundTag) {
                // å·²ç¶å®š -> é¡¯ç¤ºè§£é™¤æŒ‰éˆ•
                bindButtonHtml = `<button onclick="window.app.unbindRFID('${boundTag.rfidCode}', '${eq.name}')" class="bg-orange-100 text-orange-600 border border-orange-200 text-sm font-bold px-3 py-2 rounded hover:bg-orange-200 transition-colors action-unbind" title="è§£é™¤ RFID ç¶å®š">â›“ï¸ è§£é™¤</button>`;
            } else {
                // æœªç¶å®š -> é¡¯ç¤ºç¶å®šæŒ‰éˆ•
                bindButtonHtml = `<button onclick="window.app.openBindModal('${eq.id}')" class="bg-indigo-100 text-indigo-600 border border-indigo-200 text-sm font-bold px-3 py-2 rounded hover:bg-indigo-200 transition-colors action-bind" title="ç¶å®š RFID">ğŸ”— ç¶å®š</button>`;
            }

            listHtml += `
            <div class="card p-4 flex flex-col sm:flex-row items-center gap-4 hover:shadow-md transition-shadow">
                <img src="${imgUrl}" class="w-20 h-20 object-cover rounded-md border flex-shrink-0">
                <div class="flex-grow text-center sm:text-left w-full">
                    <h3 class="font-bold text-lg text-slate-800 flex items-center justify-center sm:justify-start gap-2">
                        <span class="status-dot ${statusClass}"></span>${eq.name}
                        ${rfidBadge}
                    </h3>
                    <div class="text-sm text-slate-500 mt-1 space-y-1">
                        <p>ğŸ†” ID: <span class="font-mono text-slate-700">${eq.id}</span> | ğŸ“ ${eq.location || 'æœªè¨­å®š'}</p>
                    </div>
                </div>
                <div class="flex gap-2 w-full sm:w-auto mt-4 sm:mt-0 min-w-[200px] justify-center sm:justify-end">
                    ${bindButtonHtml}
                    <button onclick="window.app.showEditor('${eq.id}')" class="bg-blue-100 text-blue-600 border border-blue-200 text-sm font-bold px-3 py-2 rounded hover:bg-blue-200 transition-colors action-edit">ç·¨è¼¯</button>
                    <button onclick="window.app.deleteEquipment('${eq.id}')" class="bg-red-100 text-red-600 border border-red-200 text-sm font-bold px-3 py-2 rounded hover:bg-red-200 transition-colors action-delete">åˆªé™¤</button>
                </div>
            </div>`; }); listHtml += '</div>'; }); listContainer.innerHTML = listHtml;
        };
        window.app.filterEquipmentCategory = function(selectedCat) { const allGroups = document.querySelectorAll('.eq-category-group'); allGroups.forEach(group => { if (selectedCat === 'ALL') { group.classList.remove('hidden'); } else { if (group.id === `cat-content-${selectedCat}`) { group.classList.remove('hidden'); } else { group.classList.add('hidden'); } } }); };
        window.app.deleteEquipment = function(id) { window.app.confirmAction('ç¢ºå®šåˆªé™¤æ­¤è¨­å‚™ï¼Ÿ', async () => { try { await deleteDoc(getDocRef("equipment", id)); showToast("è¨­å‚™å·²åˆªé™¤", "success"); } catch(e) { console.error(e); showToast("åˆªé™¤å¤±æ•—: " + e.message, "error"); } }); };
        
        // --- RFID Binding Logic ---
        window.app.openBindModal = function(eqId) {
            if (loggedInUser.role !== 'manager') return showToast("æ¬Šé™ä¸è¶³", "error");
            bindTargetId = eqId;
            const eq = equipmentDatabase[eqId];
            document.getElementById('bind-target-name').textContent = eq.name;
            const input = document.getElementById('rfid-bind-input');
            input.value = "";
            document.getElementById('rfid-bind-modal').classList.remove('hidden');
            document.getElementById('rfid-bind-modal').classList.add('flex');
            // Auto Focus
            setTimeout(() => input.focus(), 100);
        };

        window.app.closeBindModal = function() {
            document.getElementById('rfid-bind-modal').classList.add('hidden');
            document.getElementById('rfid-bind-modal').classList.remove('flex');
            bindTargetId = null;
        };

        window.app.confirmBind = async function() {
            const input = document.getElementById('rfid-bind-input');
            const code = input.value.trim();
            if (!code) return showToast("è«‹æƒææˆ–è¼¸å…¥ RFID ä»£ç¢¼", "error");
            
            // é˜²å‘†ï¼šå¤šå°ä¸€æª¢æŸ¥ (Plan B)
            if (rfidBindings[code] && rfidBindings[code].equipmentId !== bindTargetId) {
                const conflictId = rfidBindings[code].equipmentId;
                const conflictName = equipmentDatabase[conflictId]?.name || "æœªçŸ¥è¨­å‚™";
                window.app.playErrorSound();
                showToast(`éŒ¯èª¤ï¼šæ­¤æ¨™ç±¤å·²è¢« [${conflictName}] ä½¿ç”¨`, "error");
                input.value = ""; // Clear for retry
                return;
            }

            try {
                await setDoc(doc(db, "rfid_bindings", code), {
                    equipmentId: bindTargetId,
                    updatedAt: serverTimestamp(),
                    binderId: loggedInUser.id
                });

                window.app.playSuccessSound();
                showToast("ç¶å®šæˆåŠŸï¼", "success");
                window.app.closeBindModal();
            } catch(e) {
                console.error(e);
                showToast("ç¶å®šå¤±æ•—: " + e.message, "error");
            }
        };

        // æ–°å¢ï¼šè§£é™¤ç¶å®šåŠŸèƒ½ (Fix Issue 3)
        window.app.unbindRFID = function(rfidCode, eqName) {
            window.app.confirmAction(`ç¢ºå®šè¦è§£é™¤ [${eqName}] çš„ RFID ç¶å®šå—ï¼Ÿ`, async () => {
                try {
                    await deleteDoc(doc(db, "rfid_bindings", rfidCode));
                    showToast("è§£é™¤ç¶å®šæˆåŠŸ", "success");
                    // åˆ—è¡¨æœƒå› ç‚º onSnapshot è‡ªå‹•æ›´æ–°
                } catch(e) {
                    console.error(e);
                    showToast("è§£é™¤å¤±æ•—: " + e.message, "error");
                }
            });
        };

        // --- Inventory History in Admin ---
        window.app.renderInventoryHistory = function() {
            const container = document.getElementById('inventory-history-log-container');
            if (!container) return;
            
            let html = `<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200 text-sm">
                <thead class="bg-gray-50"><tr>
                    <th class="py-2 px-4 border-b">æ™‚é–“</th>
                    <th class="py-2 px-4 border-b">å ´æ¬¡</th>
                    <th class="py-2 px-4 border-b">è¨­å‚™</th>
                    <th class="py-2 px-4 border-b">RFID</th>
                    <th class="py-2 px-4 border-b">ç›¤é»äºº</th>
                </tr></thead><tbody>`;
            
            // Sort records desc
            const sorted = [...inventoryRecords].sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 50); // Limit 50
            
            if (sorted.length === 0) {
                 html += `<tr><td colspan="5" class="text-center py-4 text-gray-400">ç„¡ç›¤é»ç´€éŒ„</td></tr>`;
            } else {
                sorted.forEach(r => {
                    const time = r.timestamp ? new Date(r.timestamp.toDate()).toLocaleString() : 'N/A';
                    html += `<tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b">${time}</td>
                        <td class="py-2 px-4 border-b font-mono">${r.sessionId}</td>
                        <td class="py-2 px-4 border-b font-bold text-slate-700">${r.equipmentName}</td>
                        <td class="py-2 px-4 border-b font-mono text-xs text-gray-500">${r.rfidCode}</td>
                        <td class="py-2 px-4 border-b">${r.userName}</td>
                    </tr>`;
                });
            }
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        };
        
        // Editor Logic (Simplified)
        window.app.showEditor = function(id = null) { document.getElementById('equipment-list-section').classList.add('hidden'); document.getElementById('equipment-editor-section').classList.remove('hidden'); const sel = document.getElementById('edit-device-category-select'); const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))]; sel.innerHTML = '<option value="__new__">ï¼‹ æ–°å¢åˆ†é¡</option>'; cats.forEach(c => sel.add(new Option(c, c))); const imgPreview = document.getElementById('image-preview'); document.getElementById('edit-device-image').value = ''; if(id) { const eq = equipmentDatabase[id]; document.getElementById('edit-device-id').value = eq.id; document.getElementById('edit-device-name').value = eq.name; document.getElementById('edit-device-location').value = eq.location || ''; document.getElementById('edit-device-asset').value = eq.assetNumber || ''; document.getElementById('edit-device-status').value = eq.status || 'ä½¿ç”¨ä¸­'; if(eq.category) sel.value = eq.category; imgPreview.src = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; imgPreview.dataset.imageDataUrl = eq.imageUrl || ''; } else { ['edit-device-id', 'edit-device-name', 'edit-device-location', 'edit-device-asset'].forEach(k=> { const el = document.getElementById(k); if(el) el.value=''; }); imgPreview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; imgPreview.dataset.imageDataUrl = ''; } };
        window.app.showList = function() { document.getElementById('equipment-list-section').classList.remove('hidden'); document.getElementById('equipment-editor-section').classList.add('hidden'); window.app.renderEquipmentList(); };
        window.app.saveEquipment = async function(btn) { 
            const originalText = 'å„²å­˜è®Šæ›´'; if (btn) { btn.disabled = true; btn.innerHTML = `å„²å­˜ä¸­...`; } 
            try { 
                const id = document.getElementById('edit-device-id').value; 
                const name = document.getElementById('edit-device-name').value; 
                const catSelect = document.getElementById('edit-device-category-select'); 
                const cat = catSelect.value === '__new__' ? (document.getElementById('edit-device-category-new').value || 'æœªåˆ†é¡') : catSelect.value; 
                const imgPreview = document.getElementById('image-preview'); 
                const data = { name, category: cat, imageUrl: imgPreview.dataset.imageDataUrl || null, location: document.getElementById('edit-device-location').value, assetNumber: document.getElementById('edit-device-asset').value, status: document.getElementById('edit-device-status').value }; 
                await setDoc(getDocRef("equipment", id), data, { merge: true }); 
                showToast('å„²å­˜æˆåŠŸ', 'success'); window.app.showList(); 
            } catch (error) { console.error("Save failed:", error); showToast("å„²å­˜å¤±æ•—: " + error.message, "error"); } finally { if (btn) { btn.disabled = false; btn.innerHTML = originalText; } } 
        };
        window.app.handleImageUpload = function(input) { if(!input.files[0]) return; const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); const preview = document.getElementById('image-preview'); preview.src = dataUrl; preview.dataset.imageDataUrl = dataUrl; }; img.src = e.target.result; }; reader.readAsDataURL(file); };
        
        // Users Management
        window.app.renderUserList = function() { const c = document.getElementById('user-list-container'); c.innerHTML = ''; Object.values(userDatabase).forEach(u => { c.innerHTML += `<div class="card p-3 flex justify-between items-center mb-2"><div><span class="font-bold">${u.name}</span> <span class="text-xs text-gray-500">(${u.role})</span></div><div class="space-x-2"><button onclick="window.app.showUserEditor('${u.id}')" class="text-blue-600 text-sm">ç·¨è¼¯</button><button onclick="window.app.deleteUser('${u.id}')" class="text-red-600 text-sm">åˆªé™¤</button></div></div>`; }); };
        window.app.showUserEditor = (id = null) => { document.getElementById('user-list-container').classList.add('hidden'); document.getElementById('user-editor-section').classList.remove('hidden'); const roleSelect = document.getElementById('edit-user-role'); roleSelect.onchange = (e) => { document.getElementById('edit-user-password').classList.toggle('hidden', e.target.value !== 'manager'); }; if (id && userDatabase[id]) { const user = userDatabase[id]; document.getElementById('edit-user-id').value = id; document.getElementById('edit-user-id').disabled = true; document.getElementById('edit-user-name').value = user.name; roleSelect.value = user.role; } else { document.getElementById('edit-user-id').value = ''; document.getElementById('edit-user-id').disabled = false; document.getElementById('edit-user-name').value = ''; } };
        window.app.saveUser = async function() { const id = document.getElementById('edit-user-id').value; const data = { name: document.getElementById('edit-user-name').value, role: document.getElementById('edit-user-role').value }; if(data.role === 'manager') data.password = document.getElementById('edit-user-password').value; await setDoc(getDocRef("users", id), data, { merge: true }); window.app.showUserList(); };
        window.app.showUserList = function() { document.getElementById('user-list-container').classList.remove('hidden'); document.getElementById('user-editor-section').classList.add('hidden'); };
        window.app.deleteUser = function(id) { window.app.confirmAction('ç¢ºå®šåˆªé™¤æ­¤ä½¿ç”¨è€…ï¼Ÿ', async () => { await deleteDoc(getDocRef("users", id)); showToast("ä½¿ç”¨è€…å·²åˆªé™¤", "success"); }); };
        
        init();
    </script>
</body>
</html>