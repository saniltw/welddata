<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨­å‚™è³‡ç”¢ç›¤é»ç³»çµ± v1.2</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- QR Code & Zipping Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="text/javascript" src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-visible { opacity: 1; pointer-events: auto; }
        .modal-content-hidden { transform: scale(0.95) translateY(10px); opacity: 0; }
        .modal-content-visible { transform: scale(1) translateY(0); opacity: 1; }
        .table-row-hover:hover { background-color: #f1f5f9; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #ef4444; box-shadow: 0 0 4px #ef4444; top: 0; left: 0; animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .rfid-focus-ring { animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { border-color: rgba(168, 85, 247, 0.5); box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); } 70% { border-color: rgba(168, 85, 247, 0); box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); } 100% { border-color: rgba(168, 85, 247, 0); box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); } }
        
        /* Status Colors */
        .status-using { background-color: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; } /* ä½¿ç”¨ä¸­ - Green */
        .status-repair { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; } /* ç¶­ä¿®ä¸­ - Red */
        .status-unused { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; } /* æœªä½¿ç”¨ - Gray */
    </style>
</head>
<body class="text-slate-800 h-screen w-screen flex flex-col md:flex-row">

    <input id="rfidHiddenInput" type="text" class="absolute opacity-0 -z-10 h-0 w-0" autocomplete="off">

    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-64 bg-slate-900 text-white border-r border-slate-800 z-20 shadow-xl">
        <div class="p-6 flex items-center gap-3 border-b border-slate-800">
            <div class="bg-blue-500 p-2 rounded-lg"><i class="ph ph-wrench text-xl text-white"></i></div>
            <h1 class="text-lg font-bold tracking-wide">è¨­å‚™è³‡ç”¢ç›¤é»</h1>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <button id="nav-inventory" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-600 text-white shadow-md transition-colors"><i class="ph ph-list-dashes text-xl"></i><span class="font-medium">è¨­å‚™ç¸½è¦½</span></button>
            <button id="nav-rfid" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors"><i class="ph ph-wifi-high text-xl"></i><span class="font-medium">RFID ä½œæ¥­</span></button>
        </nav>
        <div class="p-4 border-t border-slate-800"><div class="flex items-center gap-3 px-4 py-2"><div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-300" id="user-avatar">U</div><div><p class="text-sm font-medium text-white" id="current-user-display">ä½¿ç”¨è€…</p><p class="text-xs text-slate-500">å·²é€£ç·š</p></div></div></div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-6 shadow-sm z-10 shrink-0 gap-2">
            <div class="flex items-center gap-2 md:gap-4 flex-1">
                <div class="md:hidden bg-blue-600 p-1.5 rounded text-white shrink-0"><i class="ph ph-wrench text-lg"></i></div>
                
                <!-- Desktop Search Bar -->
                <div id="top-search-bar" class="hidden md:flex items-center gap-2 w-full max-w-lg">
                    <select id="globalSearchField" class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 w-28 shrink-0 cursor-pointer shadow-sm">
                        <option value="name" selected>è¨­å‚™åç¨±</option>
                        <option value="all">å…¨éƒ¨æ¬„ä½</option>
                        <option value="assetNumber">è³‡ç”¢ç·¨è™Ÿ</option>
                        <option value="category">åˆ†é¡</option>
                    </select>
                    <div class="relative w-full group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="ph ph-magnifying-glass text-slate-400"></i>
                        </div>
                        <input type="text" id="globalSearchInput" class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg leading-5 bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition duration-150 ease-in-out sm:text-sm shadow-sm" placeholder="æœå°‹è¨­å‚™...">
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 md:gap-3 shrink-0">
                <button class="md:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-lg" onclick="document.getElementById('mobileSearchPanel').classList.toggle('hidden')"><i class="ph ph-magnifying-glass text-xl"></i></button>
                <div class="h-6 w-px bg-slate-200 mx-1 hidden sm:block"></div>
                <!-- QR Code Button (Backup) -->
                <button id="topScanBtn" class="bg-slate-700 hover:bg-slate-800 text-white p-2 rounded-lg shadow-sm transition-colors flex items-center gap-2"><i class="ph ph-qr-code text-lg"></i><span class="hidden md:inline font-medium text-sm">QR æƒæ</span></button>
                <button id="topAddBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg shadow-sm transition-colors flex items-center gap-2"><i class="ph ph-plus text-lg"></i><span class="hidden md:inline font-medium text-sm">æ–°å¢è¨­å‚™</span></button>
            </div>
        </header>

        <!-- Mobile Search Panel -->
        <div id="mobileSearchPanel" class="hidden md:hidden bg-white p-4 border-b border-slate-200 absolute top-16 left-0 right-0 z-10 shadow-md flex gap-2">
            <select id="mobileSearchField" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 w-28 shrink-0">
                 <option value="name" selected>åç¨±</option>
                 <option value="all">å…¨éƒ¨</option>
                 <option value="assetNumber">è³‡ç”¢ç·¨è™Ÿ</option>
            </select>
            <input type="text" id="mobileSearchInput" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="æœå°‹...">
        </div>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 no-scrollbar" id="main-scroll-area">
            <div id="page-header-inventory" class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div><h2 class="text-2xl font-bold text-slate-800">è¨­å‚™ç¸½è¦½</h2><p class="text-slate-500 text-sm mt-1">ç®¡ç†èˆ‡è¿½è¹¤å…¨å» è³‡ç”¢ç‹€æ…‹</p></div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <select id="categoryFilter" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-48 p-2.5">
                        <option value="all">æ‰€æœ‰åˆ†é¡</option>
                    </select>
                     <select id="statusFilter" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-36 p-2.5">
                        <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option>
                        <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
                        <option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option>
                    </select>
                </div>
            </div>
            
            <div id="loader" class="flex flex-col items-center justify-center py-20 text-slate-500">
                <i class="ph ph-spinner animate-spin text-4xl text-blue-600 mb-3"></i>
                <p id="loader-text" class="font-medium animate-pulse">æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...</p>
                <p class="text-xs text-slate-400 mt-2">é¦–æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“å»ºç«‹é€£ç·š</p>
            </div>

            <!-- Inventory List View -->
            <div id="content-area-inventory" class="hidden pb-20"> 
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-600">
                            <thead class="bg-slate-50 text-slate-700 uppercase font-semibold border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4">è¨­å‚™åç¨±</th>
                                    <th class="px-6 py-4">è³‡ç”¢ç·¨è™Ÿ</th>
                                    <th class="px-6 py-4">åˆ†é¡</th>
                                    <th class="px-6 py-4">ç¾æ³</th>
                                    <th class="px-6 py-4">RFID</th>
                                    <th class="px-6 py-4 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                    <div id="list-empty-state" class="hidden p-10 text-center text-slate-500">
                        <i class="ph ph-magnifying-glass text-4xl mb-2 text-slate-300"></i>
                        <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨­å‚™</p>
                    </div>
                </div>
            </div>

            <!-- RFID View -->
            <div id="content-area-rfid" class="hidden h-full flex flex-col pb-20">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-wifi-high text-purple-600"></i> RFID ä½œæ¥­ä¸­å¿ƒ</h2>
                        <p class="text-slate-500 text-sm mt-1">è«‹ç¢ºä¿ RFID è®€å–å™¨å·²é€£æ¥ (HID æ¨¡å¼)</p>
                    </div>
                    <div class="bg-slate-200 p-1 rounded-lg flex text-sm font-medium">
                        <button id="rfid-mode-search" class="px-4 py-1.5 rounded-md bg-white text-purple-700 shadow-sm transition-all" onclick="switchRfidMode('search')"><i class="ph ph-magnifying-glass"></i> æœå°‹</button>
                        <button id="rfid-mode-bind" class="px-4 py-1.5 rounded-md text-slate-500 hover:text-purple-700 transition-all" onclick="switchRfidMode('bind')"><i class="ph ph-link"></i> ç¶å®š</button>
                        <button id="rfid-mode-stocktake" class="px-4 py-1.5 rounded-md text-slate-500 hover:text-purple-700 transition-all" onclick="switchRfidMode('stocktake')"><i class="ph ph-clipboard-text"></i> ç›¤é»</button>
                    </div>
                </div>

                <!-- RFID Status Card -->
                <div id="rfid-status-card" class="bg-white rounded-xl p-6 border-2 border-slate-200 cursor-pointer hover:border-purple-300 transition mb-6 shadow-sm flex items-center gap-4 relative overflow-hidden group">
                    <div id="rfid-status-icon-bg" class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:scale-110 transition-transform"><i class="ph ph-barcode text-3xl"></i></div>
                    <div class="flex-1">
                        <h3 id="rfid-status-title" class="text-lg font-bold text-slate-700">æƒæå™¨æœªå°±ç·’</h3>
                        <p id="rfid-status-desc" class="text-slate-500 text-sm">é»æ“Šæ­¤å€åŸŸä»¥å•Ÿç”¨ RFID æ¥æ”¶æ¨¡å¼</p>
                    </div>
                    <div class="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded border">HID Mode</div>
                </div>

                <!-- Mode 1: Search -->
                <div id="rfid-view-search" class="flex-1 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50">
                    <i class="ph ph-wifi-high text-6xl mb-4 opacity-20"></i>
                    <p class="text-lg font-medium">ç­‰å¾…æƒæ...</p>
                    <p class="text-sm">ç›´æ¥æƒææ¨™ç±¤ä»¥æª¢è¦–è¨­å‚™è©³æƒ…</p>
                </div>

                <!-- Mode 2: Bind -->
                <div id="rfid-view-bind" class="hidden flex-1 flex flex-col md:flex-row gap-6 h-full overflow-hidden">
                    <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50">
                            <h3 class="font-bold text-slate-700 mb-2">1. é¸æ“‡æœªç¶å®šè¨­å‚™</h3>
                            <input type="text" id="bind-search-input" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none" placeholder="è¼¸å…¥è¨­å‚™åç¨±æˆ–è³‡ç”¢ç·¨è™Ÿ...">
                        </div>
                        <div id="unbound-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    </div>
                    <div class="flex-1 bg-purple-50 rounded-xl border border-purple-100 flex flex-col items-center justify-center p-6 text-center">
                        <div id="bind-step-2-inactive" class="opacity-50">
                            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 mx-auto shadow-sm"><i class="ph ph-arrow-left text-3xl text-purple-300"></i></div>
                            <h3 class="font-bold text-purple-900 text-lg">2. ç­‰å¾…é¸æ“‡</h3>
                            <p class="text-purple-600 text-sm mt-1">è«‹å…ˆå¾å·¦å´é¸æ“‡ä¸€å€‹è¨­å‚™</p>
                        </div>
                        <div id="bind-step-2-active" class="hidden w-full">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-purple-200 mb-6 max-w-sm mx-auto rfid-focus-ring">
                                <h4 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-1">æ­£åœ¨ç¶å®š</h4>
                                <h2 id="bind-target-name" class="text-2xl font-bold text-purple-700 mb-2">è¨­å‚™åç¨±</h2>
                                <p id="bind-target-id" class="text-slate-500 font-mono text-sm bg-slate-100 py-1 px-2 rounded inline-block">ID</p>
                            </div>
                            <div class="animate-pulse">
                                <i class="ph ph-wifi-high text-5xl text-purple-500 mb-2"></i>
                                <p class="font-bold text-purple-800">è«‹æƒææ–°çš„ RFID æ¨™ç±¤</p>
                                <button onclick="resetBindSelection()" class="mt-4 text-sm text-slate-400 hover:text-slate-600 underline">å–æ¶ˆé¸å–</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mode 3: Stocktake (Category Based) -->
                <div id="rfid-view-stocktake" class="hidden flex-1 flex flex-col h-full overflow-hidden bg-white rounded-xl shadow-sm border border-slate-200">
                    <div class="p-4 border-b border-slate-200 bg-slate-50 flex flex-wrap gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">é¸æ“‡ç›¤é»ç¯„åœ (åˆ†é¡)</label>
                            <select id="stocktake-category" class="w-full md:w-64 px-3 py-2 border border-slate-300 rounded-lg text-sm bg-white font-medium">
                                <option value="">è«‹é¸æ“‡åˆ†é¡...</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="startStocktake()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition flex items-center gap-2"><i class="ph ph-play"></i> é–‹å§‹ç›¤é»</button>
                            <button onclick="resetStocktake()" class="bg-white text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border border-slate-300 hover:bg-slate-50 transition">é‡ç½®</button>
                        </div>
                    </div>
                    <div class="flex border-b border-slate-200 divide-x divide-slate-100 bg-white">
                        <div class="flex-1 p-3 text-center">
                            <div class="text-xs text-slate-500">æ‡‰ç›¤æ•¸é‡</div>
                            <div id="st-count-expected" class="text-xl font-bold text-slate-800">0</div>
                        </div>
                        <div class="flex-1 p-3 text-center bg-green-50">
                            <div class="text-xs text-green-600 font-bold">å·²ç›¤ (ç›¸ç¬¦)</div>
                            <div id="st-count-scanned" class="text-xl font-bold text-green-700">0</div>
                        </div>
                        <div class="flex-1 p-3 text-center bg-red-50">
                            <div class="text-xs text-red-600 font-bold">ç•°å¸¸ (éæ­¤åˆ†é¡/æœªçŸ¥)</div>
                            <div id="st-count-error" class="text-xl font-bold text-red-700">0</div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0 bg-slate-50 relative">
                        <div id="stocktake-list" class="divide-y divide-slate-200">
                            <div class="p-8 text-center text-slate-400">
                                <i class="ph ph-clipboard-text text-4xl mb-2 opacity-30"></i>
                                <p>è«‹é¸æ“‡åˆ†é¡ä¸¦é»æ“Šã€Œé–‹å§‹ç›¤é»ã€</p>
                                <p class="text-xs mt-2 text-slate-300">æ”¯æ´ã€Œå…¨éƒ¨åˆ†é¡ã€ç¸½ç›¤é»</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Mobile Nav -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-30 pb-safe">
            <button id="mobile-nav-inventory" class="flex flex-col items-center justify-center w-full h-full text-blue-600">
                <i class="ph ph-list-dashes text-2xl"></i><span class="text-[10px] font-medium mt-1">è¨­å‚™</span>
            </button>
            <button id="mobile-nav-rfid" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-purple-600">
                <i class="ph ph-wifi-high text-2xl"></i><span class="text-[10px] font-medium mt-1">RFID</span>
            </button>
             <button id="mobile-nav-add" class="flex flex-col items-center justify-center w-full h-full -mt-6">
                <div class="bg-blue-600 rounded-full p-4 shadow-lg text-white transform hover:scale-105 transition"><i class="ph ph-plus text-2xl"></i></div>
            </button>
            <button id="mobile-nav-scan" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-slate-600">
                <i class="ph ph-qr-code text-2xl"></i><span class="text-[10px] font-medium mt-1">QR</span>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    
    <!-- Add/Edit Device Modal -->
    <div id="deviceModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl mx-4 modal-content modal-content-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-5 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800" id="deviceModalTitle">æ–°å¢è¨­å‚™</h3>
                <button class="close-modal-btn text-slate-400 hover:text-slate-600"><i class="ph ph-x text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="device-form" class="space-y-5">
                    <input type="hidden" id="editDeviceId">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">è¨­å‚™åç¨± <span class="text-red-500">*</span></label>
                        <input type="text" id="inputName" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚: é›»å‹•å †é«˜æ©Ÿ A01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">è³‡ç”¢ç·¨è™Ÿ / è²¡ç”¢ç·¨è™Ÿ</label>
                        <input type="text" id="inputAssetNumber" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚: AS-2023-001">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">åˆ†é¡ (Category)</label>
                            <div class="relative">
                                <input type="text" id="inputCategory" list="categoryList" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <datalist id="categoryList"></datalist>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">ç¾æ³ (Status)</label>
                            <select id="inputStatus" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option>
                                <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
                                <option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option>
                                <option value="å ±å»¢">å ±å»¢</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end pt-4 gap-3">
                        <button type="button" class="close-modal-btn px-4 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-50">å–æ¶ˆ</button>
                        <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg shadow-lg hover:bg-blue-700 transition">å„²å­˜è¨­å‚™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 modal-content modal-content-hidden flex flex-col">
            <div class="p-4 border-b flex justify-between">
                <h3 class="font-bold text-lg">è¨­å‚™è©³æƒ…</h3>
                <button class="close-modal-btn"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div id="detailContent" class="p-6 space-y-4">
                <!-- Content injected via JS -->
            </div>
            <div class="p-4 border-t bg-slate-50 flex justify-end gap-2" id="detailFooter">
                <!-- Buttons injected via JS -->
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-4 modal-content modal-content-hidden flex flex-col relative overflow-hidden">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-lg font-bold">æƒæ QR Code</h3>
                <button class="close-scanner-btn text-slate-500"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="relative w-full aspect-square rounded-lg overflow-hidden bg-black">
                <div id="qr-reader" class="w-full h-full"></div>
                <div class="absolute inset-0 z-10 pointer-events-none flex items-center justify-center">
                    <div class="w-2/3 h-2/3 border-2 border-white/40 rounded-xl relative shadow-[0_0_0_9999px_rgba(0,0,0,0.5)]">
                        <div class="absolute top-0 left-0 w-8 h-8 border-l-4 border-t-4 border-blue-500 -mt-1 -ml-1 rounded-tl-sm"></div>
                        <div class="absolute top-0 right-0 w-8 h-8 border-r-4 border-t-4 border-blue-500 -mt-1 -mr-1 rounded-tr-sm"></div>
                        <div class="absolute bottom-0 left-0 w-8 h-8 border-l-4 border-b-4 border-blue-500 -mb-1 -ml-1 rounded-bl-sm"></div>
                        <div class="absolute bottom-0 right-0 w-8 h-8 border-r-4 border-b-4 border-blue-500 -mb-1 -mr-1 rounded-br-sm"></div>
                        <div class="scan-line"></div>
                    </div>
                </div>
            </div>
            <p class="text-center text-sm text-slate-500 mt-4">å°æº–è¨­å‚™ä¸Šçš„ QR Code å³å¯æœå°‹</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="notification-toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl z-[70] transition-all duration-300 opacity-0 translate-y-10 flex items-center gap-3">
        <i class="ph ph-info text-blue-400 text-lg"></i>
        <span id="notification-message" class="font-medium">Notification</span>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-xl shadow-lg w-80 p-6 modal-content modal-content-hidden">
            <h3 id="confirmationTitle" class="font-bold text-lg mb-2">ç¢ºèª</h3>
            <p id="confirmationMessage" class="text-slate-600 mb-4">Content</p>
            <div class="flex justify-end gap-2">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-slate-100 rounded text-slate-600">å–æ¶ˆ</button>
                <button id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white rounded">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, serverTimestamp, deleteDoc, query, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Config updated by user
        const firebaseConfig = {
            apiKey: "AIzaSyDPpMCssbitCn2wE7WEqefL2czjIsRuyBw",
            authDomain: "checklist-20250825.firebaseapp.com",
            databaseURL: "https://checklist-20250825-default-rtdb.firebaseio.com",
            projectId: "checklist-20250825",
            storageBucket: "checklist-20250825.firebasestorage.app",
            messagingSenderId: "899658463753",
            appId: "1:899658463753:web:71819671db2cdf6bf4d6d8",
            measurementId: "G-FH3F97BZ7F"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // 2. æ”¹å›æœ€æ¨™æº–çš„åˆå§‹åŒ–æ–¹å¼ï¼Œä¸å¼·åˆ¶ä½¿ç”¨é•·è¼ªè©¢
        const db = getFirestore(app);

        // State Variables
        let currentPage = 'inventory'; 
        let equipmentInventory = [];
        let html5QrCode = null; 
        let isScannerRunning = false; 
        let rfidMode = 'search'; 
        let bindTargetId = null;
        let isRfidFocused = false;
        let pendingConfirmCallback = null;
        
        // Stocktake State
        let stocktakeState = { 
            active: false, 
            targetCategory: null, 
            expectedItems: [], 
            scannedItems: new Set(), 
            intruders: [] 
        };

        const dom = {
            contentInventory: document.getElementById('content-area-inventory'),
            contentRfid: document.getElementById('content-area-rfid'),
            navInv: document.getElementById('nav-inventory'),
            navRfid: document.getElementById('nav-rfid'),
            mobileNavInv: document.getElementById('mobile-nav-inventory'),
            mobileNavRfid: document.getElementById('mobile-nav-rfid'),
            rfidStatusCard: document.getElementById('rfid-status-card'),
            rfidStatusIconBg: document.getElementById('rfid-status-icon-bg'),
            rfidStatusTitle: document.getElementById('rfid-status-title'),
            rfidStatusDesc: document.getElementById('rfid-status-desc'),
            rfidViewSearch: document.getElementById('rfid-view-search'),
            rfidViewBind: document.getElementById('rfid-view-bind'),
            rfidViewStocktake: document.getElementById('rfid-view-stocktake'),
            rfidBtnSearch: document.getElementById('rfid-mode-search'),
            rfidBtnBind: document.getElementById('rfid-mode-bind'),
            rfidBtnStocktake: document.getElementById('rfid-mode-stocktake'),
            unboundList: document.getElementById('unbound-list'),
            bindSearchInput: document.getElementById('bind-search-input'),
            stCategory: document.getElementById('stocktake-category'),
            stCountExpected: document.getElementById('st-count-expected'),
            stCountScanned: document.getElementById('st-count-scanned'),
            stCountError: document.getElementById('st-count-error'),
            stList: document.getElementById('stocktake-list')
        };

        const modals = {
            device: document.getElementById('deviceModal'),
            detail: document.getElementById('detailModal'),
            qrScanner: document.getElementById('qrScannerModal'),
            confirmation: document.getElementById('confirmationModal')
        };

        // --- Helpers ---

        function openModal(modal) {
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            modal.querySelector('.modal-content').classList.remove('modal-content-hidden');
            modal.querySelector('.modal-content').classList.add('modal-content-visible');
        }

        function closeModal(modal) {
             if(modal.classList.contains('modal-backdrop')) {
                modal.querySelector('.modal-content').classList.add('modal-content-hidden');
                setTimeout(() => {
                    modal.classList.add('modal-hidden');
                    modal.classList.remove('modal-visible');
                }, 300);
             }
        }
        window.closeModal = closeModal;

        function openConfirmation(title, message, callback) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            pendingConfirmCallback = callback;
            openModal(modals.confirmation);
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('notification-toast');
            const msgEl = document.getElementById('notification-message');
            const iconEl = toast.querySelector('i');
            msgEl.textContent = msg;
            if (type === 'success') iconEl.className = 'ph ph-check-circle text-green-400 text-lg';
            else if (type === 'error') iconEl.className = 'ph ph-x-circle text-red-400 text-lg';
            else if (type === 'bind') iconEl.className = 'ph ph-link text-purple-400 text-lg';
            else iconEl.className = 'ph ph-info text-blue-400 text-lg';
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        function playSound(type) {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'success') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                } else if (type === 'bind') { 
                    osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now);
                    gain.gain.setValueAtTime(0.1, now); 
                    osc.start(now); osc.stop(now + 0.1);
                    setTimeout(() => {
                        const o2 = ctx.createOscillator(); const g2 = ctx.createGain();
                        o2.connect(g2); g2.connect(ctx.destination);
                        o2.frequency.setValueAtTime(1200, ctx.currentTime);
                        g2.gain.setValueAtTime(0.1, ctx.currentTime); g2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                        o2.start(); o2.stop(ctx.currentTime + 0.1);
                    }, 150);
                } else if (type === 'error') {
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(200, now);
                    gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now + 0.3);
                }
            } catch (e) {}
        }
        
        async function logAction(action, details) {
            await addDoc(collection(db, 'inventory_logs'), {
                action, details, userId: auth.currentUser?.uid || 'anon', timestamp: serverTimestamp()
            });
        }

        function switchPage(page) {
            currentPage = page;
            const activeClass = "bg-blue-600 text-white shadow-md";
            const inactiveClass = "text-slate-400 hover:text-white hover:bg-slate-800";
            const mobileActive = "text-blue-600";
            const mobileInactive = "text-slate-400";
            const mobileActiveRfid = "text-purple-600";

            dom.navInv.className = `w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${page === 'inventory' ? activeClass : inactiveClass}`;
            dom.navRfid.className = `w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${page === 'rfid' ? 'bg-purple-600 text-white shadow-md' : inactiveClass}`;
            dom.mobileNavInv.className = `flex flex-col items-center justify-center w-full h-full ${page === 'inventory' ? mobileActive : mobileInactive}`;
            dom.mobileNavRfid.className = `flex flex-col items-center justify-center w-full h-full ${page === 'rfid' ? mobileActiveRfid : mobileInactive}`;

            if (page === 'inventory') {
                dom.contentInventory.classList.remove('hidden');
                dom.contentRfid.classList.add('hidden');
                if(window.innerWidth >= 768) document.getElementById('top-search-bar').style.display = 'flex';
                document.getElementById('page-header-inventory').classList.remove('hidden');
            } else {
                dom.contentInventory.classList.add('hidden');
                dom.contentRfid.classList.remove('hidden');
                document.getElementById('top-search-bar').style.display = 'none';
                document.getElementById('page-header-inventory').classList.add('hidden');
                stopScanner();
                if (rfidMode === 'bind') renderRfidUnboundList();
                if (rfidMode === 'stocktake') updateStocktakeDropdown();
                document.getElementById('rfidHiddenInput').focus();
            }
        }
        window.switchPage = switchPage;

        // --- Inventory Logic ---

        function getFilteredInventory() {
            let query = '';
            let field = 'name';
            
            const desktopInput = document.getElementById('globalSearchInput');
            const desktopField = document.getElementById('globalSearchField');
            const mobileInput = document.getElementById('mobileSearchInput');
            const mobileField = document.getElementById('mobileSearchField');

            if (window.innerWidth < 768 && mobileInput && mobileInput.value.trim() !== '') {
                 query = mobileInput.value.toLowerCase().trim();
                 field = mobileField.value;
            } else if (desktopInput) {
                 query = desktopInput.value.toLowerCase().trim();
                 field = desktopField.value;
            }

            const catFilter = document.getElementById('categoryFilter').value;
            const statFilter = document.getElementById('statusFilter').value;

            return equipmentInventory.filter(s => {
                let matchText = false;
                if (!query) matchText = true;
                else if (field === 'all') {
                    matchText = Object.values(s).join(' ').toLowerCase().includes(query);
                } else {
                    const val = s[field] ? String(s[field]).toLowerCase() : '';
                    matchText = val.includes(query);
                }
                
                const matchCat = catFilter === 'all' || s.category === catFilter;
                const matchStat = statFilter === 'all' || s.status === statFilter;
                
                return matchText && matchCat && matchStat;
            });
        }

        function renderInventory() {
            const data = getFilteredInventory();
            const tbody = document.getElementById('inventory-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            const emptyState = document.getElementById('list-empty-state');
            
            if (data.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
            } else {
                if(emptyState) emptyState.classList.add('hidden');
                data.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-slate-100 hover:bg-slate-50 transition-colors group table-row-hover';
                    
                    const hasRfid = !!s.rfid_epc;
                    
                    let statusClass = 'status-unused';
                    if (s.status === 'ä½¿ç”¨ä¸­') statusClass = 'status-using';
                    else if (s.status === 'ç¶­ä¿®ä¸­') statusClass = 'status-repair';

                    tr.innerHTML = `
                        <td class="px-6 py-4 font-bold text-slate-900 group-hover:text-blue-600 cursor-pointer nav-detail">${s.name}</td>
                        <td class="px-6 py-4 font-mono text-slate-500 text-xs">${s.assetNumber || s.id.substring(0,8)}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-slate-100 text-xs text-slate-600 border border-slate-200">${s.category || 'æœªåˆ†é¡'}</span></td>
                        <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${s.status || 'æœªä½¿ç”¨'}</span></td>
                        <td class="px-6 py-4 hidden lg:table-cell">${hasRfid ? '<span class="inline-flex items-center gap-1 bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-100 text-xs font-bold"><i class="ph ph-wifi-high"></i> å·²ç¶å®š</span>' : '<span class="text-slate-300 text-xs">--</span>'}</td>
                        <td class="px-6 py-4 text-right">
                            <button class="text-slate-400 hover:text-blue-600 p-1.5 rounded-full hover:bg-blue-50 transition btn-detail" title="è©³æƒ…">
                                <i class="ph ph-info text-xl"></i>
                            </button>
                        </td>`;
                    
                    const clickHandler = () => showDeviceDetails(s);
                    tr.querySelector('.nav-detail').addEventListener('click', clickHandler);
                    tr.querySelector('.btn-detail').addEventListener('click', clickHandler);
                    
                    tbody.appendChild(tr);
                });
            }
        }

        // --- RFID Logic ---

        window.switchRfidMode = (mode) => {
            rfidMode = mode;
            bindTargetId = null;
            document.getElementById('bind-step-2-active').classList.add('hidden');
            document.getElementById('bind-step-2-inactive').classList.remove('hidden');
            
            const btnInactive = "px-4 py-1.5 rounded-md text-slate-500 hover:text-purple-700 transition-all";
            const btnActive = "px-4 py-1.5 rounded-md bg-white text-purple-700 shadow-sm transition-all";
            
            dom.rfidBtnSearch.className = mode === 'search' ? btnActive : btnInactive;
            dom.rfidBtnBind.className = mode === 'bind' ? btnActive : btnInactive;
            dom.rfidBtnStocktake.className = mode === 'stocktake' ? btnActive : btnInactive;
            
            dom.rfidViewSearch.classList.add('hidden');
            dom.rfidViewBind.classList.add('hidden');
            dom.rfidViewStocktake.classList.add('hidden');
            
            if (mode === 'search') dom.rfidViewSearch.classList.remove('hidden');
            else if (mode === 'bind') { dom.rfidViewBind.classList.remove('hidden'); renderRfidUnboundList(); }
            else if (mode === 'stocktake') { dom.rfidViewStocktake.classList.remove('hidden'); updateStocktakeDropdown(); }
            
            document.getElementById('rfidHiddenInput').focus();
        };

        function resetBindSelection() {
            bindTargetId = null;
            document.getElementById('bind-step-2-active').classList.add('hidden');
            document.getElementById('bind-step-2-inactive').classList.remove('hidden');
            renderRfidUnboundList();
        }
        window.resetBindSelection = resetBindSelection;

        function selectBindTarget(eq) {
            bindTargetId = eq.id;
            document.getElementById('bind-step-2-inactive').classList.add('hidden');
            document.getElementById('bind-step-2-active').classList.remove('hidden');
            document.getElementById('bind-target-name').textContent = eq.name;
            document.getElementById('bind-target-id').textContent = eq.assetNumber || eq.id;
            renderRfidUnboundList();
        }

        function renderRfidUnboundList() {
            const list = dom.unboundList;
            list.innerHTML = '';
            const term = dom.bindSearchInput.value.toLowerCase();
            const unbound = equipmentInventory.filter(s => !s.rfid_epc && (s.name.toLowerCase().includes(term) || (s.assetNumber && s.assetNumber.toLowerCase().includes(term))));
            
            if (unbound.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">ç„¡ç¬¦åˆçš„æœªç¶å®šè¨­å‚™</div>'; return; }
            
            unbound.forEach(s => {
                const isSelected = s.id === bindTargetId;
                const div = document.createElement('div');
                div.className = isSelected 
                    ? "p-3 rounded-lg border-2 border-purple-500 bg-purple-50 cursor-pointer transition flex justify-between items-center group shadow-sm text-left"
                    : "p-3 rounded-lg border border-slate-100 bg-white hover:border-purple-300 hover:bg-purple-50 cursor-pointer transition flex justify-between items-center group text-left";
                
                div.innerHTML = `
                    <div class="flex-1 min-w-0 pr-3">
                        <div class="font-bold text-slate-800 text-sm md:text-base mb-0.5 group-hover:text-purple-700 break-words">${s.name}</div>
                        <div class="text-xs text-slate-500 font-mono">${s.assetNumber || s.id}</div>
                    </div>
                    <div class="shrink-0 pl-1">
                        <i class="ph ${isSelected ? 'ph-check-circle-fill text-purple-600 text-2xl' : 'ph-caret-right text-slate-300 group-hover:text-purple-400 text-xl'}"></i>
                    </div>`;
                div.onclick = () => selectBindTarget(s);
                list.appendChild(div);
            });
        }

        // --- Stocktake Logic ---
        
        function updateStocktakeDropdown() {
             const cats = [...new Set(equipmentInventory.map(e => e.category || 'æœªåˆ†é¡'))].sort();
             dom.stCategory.innerHTML = '<option value="">è«‹é¸æ“‡ç›¤é»ç¯„åœ...</option><option value="ALL" class="font-bold text-blue-600">ğŸ“¦ æ‰€æœ‰åˆ†é¡ (å…¨å» ç›¤é»)</option>';
             cats.forEach(c => {
                 dom.stCategory.innerHTML += `<option value="${c}">${c}</option>`;
             });
        }

        window.startStocktake = () => {
            const cat = dom.stCategory.value;
            if (!cat) return showToast('è«‹å…ˆé¸æ“‡ç›¤é»ç¯„åœ', 'error');
            
            let targetItems = [];
            let displayTitle = "";
            
            if (cat === 'ALL') {
                targetItems = equipmentInventory.filter(e => e.status !== 'å ±å»¢'); 
                displayTitle = "å…¨å» ç›¤é» (æ‰€æœ‰åˆ†é¡)";
            } else {
                targetItems = equipmentInventory.filter(e => e.category === cat && e.status !== 'å ±å»¢');
                displayTitle = `${cat}`;
            }

            stocktakeState = { 
                active: true, 
                targetCategory: cat, 
                expectedItems: targetItems, 
                scannedItems: new Set(), 
                intruders: [] 
            };
            
            renderStocktakeResults();
            showToast(`é–‹å§‹ç›¤é»: ${displayTitle}`, 'success');
            document.getElementById('rfidHiddenInput').focus();
        };

        window.resetStocktake = () => {
            stocktakeState = { active: false, targetCategory: null, expectedItems: [], scannedItems: new Set(), intruders: [] };
            dom.stList.innerHTML = '<div class="p-8 text-center text-slate-400"><i class="ph ph-clipboard-text text-4xl mb-2 opacity-30"></i><p>è«‹é¸æ“‡åˆ†é¡ä¸¦é»æ“Šã€Œé–‹å§‹ç›¤é»ã€</p><p class="text-xs mt-2 text-slate-300">æ”¯æ´ã€Œå…¨éƒ¨åˆ†é¡ã€ç¸½ç›¤é»</p></div>';
            dom.stCountExpected.textContent = '0'; dom.stCountScanned.textContent = '0'; dom.stCountError.textContent = '0';
        };

        function renderStocktakeResults() {
            dom.stCountExpected.textContent = stocktakeState.expectedItems.length;
            dom.stCountScanned.textContent = stocktakeState.scannedItems.size;
            dom.stCountError.textContent = stocktakeState.intruders.length;
            
            dom.stList.innerHTML = '';
            
            // Render Intruders (Errors) first
            stocktakeState.intruders.forEach(item => {
                const el = document.createElement('div');
                el.className = "p-3 bg-red-50 border-l-4 border-red-500 flex justify-between items-center group";
                el.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-red-800 flex items-center gap-2">
                            ${item.name || 'æœªçŸ¥æ¨™ç±¤'}
                            <span class="text-xs font-normal text-red-600 border border-red-200 px-1 rounded bg-white">ç•°å¸¸</span>
                        </div>
                        <div class="text-xs text-red-600 mt-0.5">åˆ†é¡: ${item.category || 'N/A'} (éç›®æ¨™)</div>
                        <div class="text-[10px] text-slate-400 font-mono">${item.assetNumber || item.rfid_epc}</div>
                    </div>`;
                dom.stList.appendChild(el);
            });

            // Render Expected Items
            stocktakeState.expectedItems.forEach(item => {
                const isScanned = stocktakeState.scannedItems.has(item.id);
                const el = document.createElement('div');
                el.className = `p-3 border-b border-slate-100 flex justify-between items-center ${isScanned ? 'bg-green-50' : 'bg-white'}`;
                el.innerHTML = `
                    <div class="${isScanned ? 'opacity-100' : 'opacity-60'}">
                        <div class="font-bold text-slate-700">${item.name}</div>
                        <div class="text-xs text-slate-500">${item.assetNumber || item.id.substring(0,8)}</div>
                    </div>
                    ${isScanned ? '<span class="text-xs font-bold text-green-700 flex items-center gap-1"><i class="ph ph-check-circle-fill text-lg"></i> å·²ç›¤</span>' : '<span class="text-xs font-bold text-slate-400">æœªæƒæ</span>'}`;
                dom.stList.appendChild(el);
            });
        }

        // --- RFID Handling Core ---

        async function handleRfidScan(epc) {
            // 1. STOCKTAKE MODE
            if (rfidMode === 'stocktake' && stocktakeState.active && currentPage === 'rfid') {
                let item = equipmentInventory.find(s => s.rfid_epc === epc);
                
                if (!item) { 
                    stocktakeState.intruders.push({ name: `æœªçŸ¥æ¨™ç±¤ (${epc})`, category: 'Unknown', rfid_epc: epc }); 
                    renderStocktakeResults(); 
                    playSound('error'); 
                    return; 
                }
                
                const isTarget = stocktakeState.targetCategory === 'ALL' 
                    ? (item.status !== 'å ±å»¢') 
                    : (item.category === stocktakeState.targetCategory);

                if (isTarget) {
                    if (!stocktakeState.scannedItems.has(item.id)) { 
                        stocktakeState.scannedItems.add(item.id); 
                        renderStocktakeResults(); 
                        playSound('success'); 
                    }
                } else {
                    if (!stocktakeState.intruders.find(x => x.id === item.id)) { 
                        stocktakeState.intruders.push(item); 
                        renderStocktakeResults(); 
                        playSound('error'); 
                        showToast(`éæœ¬é¡åˆ¥è¨­å‚™! ${item.name}`, 'error'); 
                    }
                }
                return;
            }

            // 2. BIND MODE
            if (rfidMode === 'bind' && bindTargetId && currentPage === 'rfid') {
                const targetEq = equipmentInventory.find(s => s.id === bindTargetId);
                if (!targetEq) return;
                
                const used = equipmentInventory.find(s => s.rfid_epc === epc);
                if (used) { 
                    playSound('error'); 
                    showToast(`æ¨™ç±¤å·²è¢« ${used.name} ä½¿ç”¨ï¼`, 'error'); 
                    return; 
                }
                
                try {
                    await updateDoc(doc(db, 'equipment', bindTargetId), { rfid_epc: epc });
                    await logAction('ç¶å®š RFID', `è¨­å‚™: ${targetEq.name}, EPC: ${epc}`);
                    playSound('bind'); 
                    showToast(`ç¶å®šæˆåŠŸï¼`, 'bind'); 
                    resetBindSelection(); 
                } catch (e) { 
                    showToast("ç¶å®šå¤±æ•—", 'error'); 
                }
                return;
            }

            // 3. SEARCH MODE (Default)
            let found = equipmentInventory.find(s => s.rfid_epc === epc);
            if (!found) found = equipmentInventory.find(s => s.id === epc || s.assetNumber === epc);
            
            if (found) { 
                playSound('success'); 
                showToast(`å·²æƒæ: ${found.name}`, 'success'); 
                showDeviceDetails(found); 
            } else { 
                playSound('error'); 
                showToast(`æœªçŸ¥çš„æ¨™ç±¤: ${epc}`, 'error'); 
            }
        }

        function setupRfidListeners() {
            const hiddenInput = document.getElementById('rfidHiddenInput');
            
            const updateStatus = (focused) => {
                isRfidFocused = focused;
                if (focused) {
                    dom.rfidStatusCard.className = "bg-white rounded-xl p-6 border-2 border-green-500 cursor-pointer shadow-md flex items-center gap-4 relative overflow-hidden group";
                    dom.rfidStatusIconBg.className = "w-16 h-16 rounded-full bg-green-100 flex items-center justify-center text-green-600";
                    dom.rfidStatusTitle.textContent = "æƒæå™¨å·²å°±ç·’"; 
                    dom.rfidStatusDesc.textContent = "ç³»çµ±æ­£åœ¨ç›£è½ RFID è¨Šè™Ÿ...";
                } else {
                    dom.rfidStatusCard.className = "bg-slate-50 rounded-xl p-6 border-2 border-slate-200 cursor-pointer hover:border-purple-300 transition mb-6 shadow-sm flex items-center gap-4 relative overflow-hidden group opacity-70";
                    dom.rfidStatusIconBg.className = "w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center text-slate-400";
                    dom.rfidStatusTitle.textContent = "æƒæå™¨æœªé€£ç·š"; 
                    dom.rfidStatusDesc.textContent = "é»æ“Šæ­¤è™•ä»¥å•Ÿç”¨æƒææ¨¡å¼";
                }
            };

            const maintainFocus = () => {
                if (currentPage !== 'rfid') return;
                if (document.activeElement && ['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName) && document.activeElement !== hiddenInput) {
                    if(document.activeElement !== dom.bindSearchInput) updateStatus(false);
                    return;
                }
                hiddenInput.focus(); 
                updateStatus(true);
            };

            document.addEventListener('click', (e) => { 
                if (currentPage === 'rfid' && !['INPUT', 'SELECT', 'TEXTAREA', 'BUTTON'].includes(e.target.tagName)) maintainFocus(); 
            });
            hiddenInput.addEventListener('blur', () => { if(currentPage === 'rfid') setTimeout(maintainFocus, 100); });
            hiddenInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { 
                    e.preventDefault(); 
                    const epc = hiddenInput.value.trim(); 
                    hiddenInput.value = ''; 
                    if (epc) handleRfidScan(epc); 
                }
            });
            dom.rfidStatusCard.addEventListener('click', () => { hiddenInput.focus(); updateStatus(true); });
            dom.bindSearchInput.addEventListener('input', renderRfidUnboundList);
        }

        // --- Auth Listener Setup ---
        
        function setupAuthListener() {
            const loaderText = document.getElementById('loader-text');
            
            // åˆå§‹ç‹€æ…‹
            if(loaderText) loaderText.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';

            onAuthStateChanged(auth, user => {
                if (user) {
                    // éšæ®µ 2ï¼šå·²å–å¾—èº«åˆ†ï¼Œé–‹å§‹ç›£è½è³‡æ–™åº«
                    if(loaderText) {
                        loaderText.textContent = 'é€£ç·šæˆåŠŸï¼Œæ­£åœ¨åŒæ­¥è³‡æ–™åº«...';
                        loaderText.classList.remove('text-blue-600'); // Reset color just in case
                    }

                    setupRfidListeners();
                    onSnapshot(query(collection(db, 'equipment')), snap => {
                        equipmentInventory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        
                        const cats = [...new Set(equipmentInventory.map(e => e.category || 'æœªåˆ†é¡'))].sort();
                        const catList = document.getElementById('categoryList');
                        const catFilter = document.getElementById('categoryFilter');
                        
                        if(catList) {
                            catList.innerHTML = '';
                            cats.forEach(c => catList.innerHTML += `<option value="${c}">`);
                        }
                        if(catFilter && catFilter.innerHTML.includes('æ‰€æœ‰åˆ†é¡')) { 
                            const currentVal = catFilter.value;
                            catFilter.innerHTML = '<option value="all">æ‰€æœ‰åˆ†é¡</option>';
                            cats.forEach(c => catFilter.innerHTML += `<option value="${c}">${c}</option>`);
                            catFilter.value = currentVal;
                        }

                        document.getElementById('loader').classList.add('hidden');
                        if(currentPage === 'inventory') dom.contentInventory.classList.remove('hidden');
                        renderInventory();
                        if(currentPage === 'rfid' && rfidMode === 'bind') renderRfidUnboundList();
                        if(currentPage === 'rfid' && rfidMode === 'stocktake') updateStocktakeDropdown();
                    });
                } else {
                    // éšæ®µ 1ï¼šéœ€è¦ç™»å…¥
                    if(loaderText) {
                        loaderText.textContent = 'æ­£åœ¨å»ºç«‹å®‰å…¨é€£ç·š (ç™»å…¥ä¸­)...';
                        loaderText.classList.add('text-blue-600');
                    }
                    signInAnonymously(auth);
                }
            });
        }

        // --- Modals & CRUD ---

        function showDeviceDetails(eq) {
            const content = document.getElementById('detailContent');
            const footer = document.getElementById('detailFooter');
            
            const hasRfid = !!eq.rfid_epc;
            
            let rfidHtml = hasRfid 
                ? `<div class="p-3 bg-green-50 rounded border border-green-100 flex justify-between items-center">
                     <div><span class="text-xs text-green-600 font-bold block">å·²ç¶å®š RFID</span><span class="text-sm font-mono">${eq.rfid_epc}</span></div>
                     <button onclick="unbindRfid('${eq.id}')" class="text-xs bg-white text-red-600 border border-red-200 px-2 py-1 rounded hover:bg-red-50">è§£é™¤</button>
                   </div>`
                : `<div class="p-3 bg-slate-50 rounded border border-slate-100 flex justify-between items-center">
                     <span class="text-sm text-slate-500">å°šæœªç¶å®š RFID</span>
                     <button onclick="closeModal(document.getElementById('detailModal')); switchPage('rfid'); switchRfidMode('bind'); setTimeout(() => { document.getElementById('bind-search-input').value='${eq.name}'; }, 100);" class="text-xs bg-purple-600 text-white px-3 py-1 rounded shadow hover:bg-purple-700">å»ç¶å®š</button>
                   </div>`;

            content.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <div class="h-12 w-12 rounded bg-slate-100 flex items-center justify-center overflow-hidden">
                        ${eq.imageUrl ? `<img src="${eq.imageUrl}" class="h-full w-full object-cover">` : '<i class="ph ph-wrench text-2xl text-slate-400"></i>'}
                    </div>
                    <div>
                        <h4 class="text-xl font-bold text-slate-800">${eq.name}</h4>
                        <p class="text-sm text-slate-500 font-mono">${eq.assetNumber || eq.id}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="p-2 border rounded"><span class="block text-xs text-slate-400">åˆ†é¡</span>${eq.category || '-'}</div>
                    <div class="p-2 border rounded"><span class="block text-xs text-slate-400">ç‹€æ…‹</span>${eq.status || 'æœªä½¿ç”¨'}</div>
                    <div class="p-2 border rounded col-span-2"><span class="block text-xs text-slate-400">æ”¾ç½®åœ°é»</span>${eq.location || 'æœªè¨­å®š (åƒ…ä¾›åƒè€ƒ)'}</div>
                </div>
                ${rfidHtml}
            `;

            footer.innerHTML = `
                <button onclick="window.editDevice('${eq.id}')" class="px-4 py-2 bg-slate-100 text-slate-700 rounded hover:bg-slate-200 font-medium">ç·¨è¼¯</button>
                <button onclick="closeModal(document.getElementById('detailModal'))" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium">é—œé–‰</button>
            `;
            
            openModal(modals.detail);
        }
        window.showDeviceDetails = showDeviceDetails;

        window.unbindRfid = function(id) {
            const eq = equipmentInventory.find(e => e.id === id);
            openConfirmation('è§£é™¤ç¶å®š', `ç¢ºå®šè¦è§£é™¤ ${eq.name} çš„ RFID ç¶å®šå—ï¼Ÿ`, async () => {
                try {
                    await updateDoc(doc(db, 'equipment', id), { rfid_epc: deleteField() });
                    showToast('å·²è§£é™¤ç¶å®š', 'success');
                    closeModal(modals.detail);
                } catch(e) { showToast('è§£é™¤å¤±æ•—', 'error'); }
            });
        };

        window.editDevice = function(id) {
            closeModal(modals.detail);
            const eq = equipmentInventory.find(e => e.id === id);
            document.getElementById('deviceModalTitle').textContent = 'ç·¨è¼¯è¨­å‚™';
            document.getElementById('editDeviceId').value = id;
            document.getElementById('inputName').value = eq.name;
            document.getElementById('inputAssetNumber').value = eq.assetNumber || '';
            document.getElementById('inputCategory').value = eq.category || '';
            document.getElementById('inputStatus').value = eq.status || 'ä½¿ç”¨ä¸­';
            openModal(modals.device);
        };

        document.getElementById('device-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editDeviceId').value;
            const data = {
                name: document.getElementById('inputName').value,
                assetNumber: document.getElementById('inputAssetNumber').value,
                category: document.getElementById('inputCategory').value || 'æœªåˆ†é¡',
                status: document.getElementById('inputStatus').value,
                lastModifiedAt: serverTimestamp()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, 'equipment', id), data);
                    showToast('è¨­å‚™æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'equipment'), data);
                    showToast('è¨­å‚™æ–°å¢æˆåŠŸ', 'success');
                }
                closeModal(modals.device);
            } catch(err) {
                console.error(err);
                showToast('å„²å­˜å¤±æ•—', 'error');
            }
        });

        // --- QR Code Scanner (Backup) ---
        
        async function stopScanner() { 
            if (html5QrCode && isScannerRunning) { 
                try { await html5QrCode.stop(); html5QrCode.clear(); isScannerRunning = false; } catch (err) {} 
            } 
        }
        
        window.startScanner = function() {
            openModal(modals.qrScanner);
            setTimeout(() => {
                if (html5QrCode === null) html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, (txt) => {
                     stopScanner().then(() => {
                         closeModal(modals.qrScanner);
                         handleRfidScan(txt); 
                     });
                }).catch(console.error);
                isScannerRunning = true;
            }, 300);
        };
        
        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.close-modal-btn').forEach(b => b.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop'))));
            document.querySelector('.close-scanner-btn').addEventListener('click', () => stopScanner().then(() => closeModal(modals.qrScanner)));
            
            document.getElementById('confirmActionBtn').addEventListener('click', () => { if (pendingConfirmCallback) pendingConfirmCallback(); closeModal(modals.confirmation); });
            document.getElementById('confirmCancelBtn').addEventListener('click', () => closeModal(modals.confirmation));

            dom.navInv.addEventListener('click', () => switchPage('inventory'));
            dom.navRfid.addEventListener('click', () => switchPage('rfid'));
            dom.mobileNavInv.addEventListener('click', () => switchPage('inventory'));
            dom.mobileNavRfid.addEventListener('click', () => switchPage('rfid'));
            
            const updateInv = () => renderInventory();
            ['globalSearchInput', 'mobileSearchInput', 'globalSearchField', 'mobileSearchField', 'categoryFilter', 'statusFilter'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener(el.tagName === 'INPUT' ? 'input' : 'change', updateInv);
            });
            
            const openAdd = () => {
                document.getElementById('device-form').reset();
                document.getElementById('editDeviceId').value = '';
                document.getElementById('deviceModalTitle').textContent = 'æ–°å¢è¨­å‚™';
                openModal(modals.device);
            };
            document.getElementById('topAddBtn').addEventListener('click', openAdd);
            document.getElementById('mobile-nav-add').addEventListener('click', openAdd);
            
            document.getElementById('topScanBtn').addEventListener('click', window.startScanner);
            document.getElementById('mobile-nav-scan').addEventListener('click', window.startScanner);

            dom.bindSearchInput.addEventListener('input', renderRfidUnboundList);

            // Start Logic
            setupAuthListener();
        });
    </script>
</body>
</html>