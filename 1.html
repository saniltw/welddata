<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案進度追蹤儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'Inter', '微軟正黑體', 'Microsoft JhengHei', sans-serif;
        }
        .hidden { display: none; }
        
        /* Toast Notification Animation */
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out {
            animation: fade-in-out 3s forwards;
        }

        /* Modal Entry Animation */
        @keyframes modal-in {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-modal-in {
            animation: modal-in 0.3s ease-out forwards;
        }

        /* Stats Collapse Animation */
        .stats-transition {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        .stats-collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0 !important;
        }
        .stats-expanded {
            max-height: 500px;
            opacity: 1;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }

        /* Sticky Header styles */
        thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* PDF and Print Styles */
        #report-content-wrapper, #report-content-wrapper * {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif !important;
        }
        @media print {
            body * { visibility: hidden; }
            #report-content-wrapper, #report-content-wrapper * { visibility: visible; }
            #report-content-wrapper {
                position: absolute; left: 0; top: 0; width: 100%;
            }
            .report-table { font-size: 10px; }
            .report-table th, .report-table td { padding: 4px 6px; border: 1px solid #ccc; }
        }

        /* Mobile Card View Optimization */
        @media (max-width: 768px) {
            .mobile-table-card thead { display: none; }
            .mobile-table-card tbody tr {
                display: block;
                background: white;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .mobile-table-card tbody td {
                display: block;
                text-align: right;
                padding: 0.75rem;
                border-bottom: 1px solid #f3f4f6;
                position: relative;
                padding-left: 50%;
            }
            .mobile-table-card tbody td:last-child { border-bottom: none; }
            .mobile-table-card tbody td::before {
                content: attr(data-label);
                position: absolute;
                left: 0.75rem;
                width: 45%;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #6b7280;
                font-size: 0.875rem;
            }
            /* Adjust content specific cells */
            .mobile-table-card tbody td:nth-child(3) { /* Content Items */
                padding-left: 0.75rem;
                text-align: left;
            }
            .mobile-table-card tbody td:nth-child(3)::before {
                position: static;
                display: block;
                margin-bottom: 0.5rem;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="p-2 sm:p-6 lg:p-8 h-screen flex flex-col">
        <!-- Toast Notification -->
        <div id="toast-notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-[70]"></div>

        <div class="max-w-7xl mx-auto w-full flex-1 flex flex-col min-h-0">
            <header class="mb-4 flex-shrink-0">
                <div class="flex justify-between items-start flex-wrap gap-4">
                    <div class="flex items-center gap-3">
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">專案進度儀表板</h1>
                            <p class="text-xs sm:text-base text-gray-600 mt-1">即時追蹤所有任務的最新狀態與協作進度。</p>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <!-- Stats Toggle Button -->
                            <button id="btn-toggle-stats" class="p-2 text-gray-400 hover:text-gray-600 focus:outline-none transition-colors" title="收合/展開數據卡片">
                                <i id="icon-toggle-stats" class="fas fa-chevron-up rotate-180 transition-transform duration-300"></i>
                            </button>
                            <!-- Summary Text (Show when collapsed) -->
                            <span id="stats-summary-text" class="text-xs sm:text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100 transition-opacity duration-300">
                                載入中...
                            </span>
                        </div>
                    </div>
                    <!-- User Info / Status -->
                    <div class="text-right text-xs text-gray-500 bg-white p-2 rounded shadow-sm">
                        <p>ID: <span id="user-id" class="font-mono">連接中...</span></p>
                    </div>
                </div>
            </header>

            <main class="flex-1 flex flex-col min-h-0">
                <!-- Stats Cards (Wrap for animation) - Default Collapsed -->
                <div id="stats-wrapper" class="stats-transition stats-collapsed mb-6 flex-shrink-0">
                    <div id="stats-cards-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
                        <!-- Stat cards will be injected here -->
                        <div class="col-span-full text-center py-4 text-gray-400">載入數據中...</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mb-4 flex flex-col sm:flex-row justify-between items-center gap-3 flex-shrink-0">
                    <!-- Search Bar -->
                    <div class="relative w-full sm:w-64">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="search-input" class="pl-10 block w-full shadow-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm p-2" placeholder="搜尋專案、內容或人員...">
                    </div>

                    <div class="flex gap-2 flex-wrap justify-end w-full sm:w-auto">
                        <button id="btn-show-report" class="flex-1 sm:flex-none flex items-center justify-center bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition-colors duration-300 text-sm">
                            <i class="fas fa-file-alt mr-2"></i> 報表
                        </button>
                        <button id="btn-show-schedule" class="flex-1 sm:flex-none flex items-center justify-center bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition-colors duration-300 text-sm">
                            <i class="fas fa-calendar-alt mr-2"></i> 輪值
                        </button>
                        <button id="btn-show-settings" class="flex-1 sm:flex-none flex items-center justify-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition-colors duration-300 text-sm">
                            <i class="fas fa-cog mr-2"></i> 設定
                        </button>
                        <button id="btn-show-archive" class="flex-1 sm:flex-none flex items-center justify-center bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-orange-700 transition-colors duration-300 text-sm">
                            <i class="fas fa-archive mr-2"></i> 已封存
                        </button>
                        <button id="btn-add-task" class="flex-1 sm:flex-none flex items-center justify-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 text-sm">
                            <i class="fas fa-plus mr-2"></i> 新增
                        </button>
                    </div>
                </div>

                <!-- Main Table -->
                <div class="bg-gray-100 sm:bg-white sm:rounded-xl sm:shadow-lg flex-1 flex flex-col min-h-0 overflow-hidden">
                    <div id="loading-spinner" class="flex justify-center items-center p-8 absolute inset-0 bg-white z-20">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div>
                    </div>
                    
                    <div id="dashboard-table-container" class="hidden flex flex-col h-full">
                        <!-- Table Filters -->
                        <div class="p-4 bg-gray-50 border-b flex items-center justify-between flex-wrap gap-4 flex-shrink-0 rounded-t-xl">
                            <div class="flex items-center space-x-4 flex-wrap gap-y-2">
                                <label class="flex items-center space-x-2 cursor-pointer select-none">
                                    <input type="checkbox" id="filter-show-completed" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                    <span class="text-sm text-gray-700">顯示已完成</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer select-none">
                                    <input type="checkbox" id="filter-show-paused" class="h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500" />
                                    <span class="text-sm text-gray-700">顯示暫停</span>
                                </label>
                            </div>
                            <div class="flex items-center space-x-4 flex-wrap gap-y-2">
                                <div class="flex items-center space-x-2">
                                    <label for="person-filter" class="text-sm text-gray-700">人員:</label>
                                    <select id="person-filter" class="border-gray-300 rounded-md shadow-sm text-sm p-1 focus:ring-blue-500 focus:border-blue-500 w-24">
                                        <option value="all">全部</option>
                                    </select>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label for="sort-select" class="text-sm text-gray-700">排序:</label>
                                    <select id="sort-select" class="border-gray-300 rounded-md shadow-sm text-sm p-1 focus:ring-blue-500 focus:border-blue-500 w-32">
                                        <option value="startDate_asc" selected>專案開始日 (舊→新)</option>
                                        <option value="startDate_desc">專案開始日 (新→舊)</option>
                                        <option value="createdAt_desc">建立時間 (新→舊)</option>
                                        <option value="createdAt_asc">建立時間 (舊→新)</option>
                                        <option value="projectName_asc">專案名稱</option>
                                        <option value="projectCategory_asc">專案類別</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Scrollable Table Area (Mobile Optimized) -->
                        <div class="overflow-auto flex-1 relative sm:px-0 bg-gray-100 sm:bg-white">
                            <table class="min-w-full divide-y divide-gray-200 mobile-table-card">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <!-- Column Widths Adjusted Here -->
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">專案名稱</th>
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">類別</th>
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">處理項目詳情</th>
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">總體進度</th>
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">天數</th>
                                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-table-body" class="bg-white sm:divide-y sm:divide-gray-200 block sm:table-row-group p-2 sm:p-0">
                                    <!-- Table rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Table Footer -->
                        <div class="bg-gray-50 px-6 py-3 text-xs text-gray-500 border-t flex-shrink-0 rounded-b-xl flex justify-between items-center">
                            <div>
                                目前顯示 <span id="displayed-count" class="font-bold text-gray-700">0</span> 筆任務
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Generic Confirmation Modal (Replaces Native confirm()) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[60] p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm animate-modal-in">
            <h3 class="text-xl font-bold text-gray-800 mb-4">確認操作</h3>
            <p id="confirm-message" class="text-gray-600 mb-6">確定要執行此操作嗎？</p>
            <div class="flex justify-end space-x-3">
                <button id="btn-confirm-cancel" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button>
                <button id="btn-confirm-ok" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-md">確定</button>
            </div>
        </div>
    </div>

    <!-- Task Form Modal -->
    <div id="task-form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col animate-modal-in">
            <form id="task-form" class="flex flex-col flex-1 min-h-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="task-form-title" class="text-2xl font-bold text-gray-800">新增任務</h2>
                    <button type="button" class="btn-cancel-task-form text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div class="flex-grow overflow-y-auto pr-4 space-y-4">
                    <input type="hidden" id="task-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                            <input type="text" id="projectName" name="projectName" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">專案類別</label>
                            <div class="flex items-center gap-2">
                                <select id="projectCategory" name="projectCategory" class="flex-grow border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                                <button type="button" id="btn-toggle-new-category" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-bold text-gray-600 transition-colors">+</button>
                            </div>
                            <div id="new-category-container" class="hidden mt-2 flex gap-2">
                                <input type="text" id="new-category-input" placeholder="新類別名稱" class="flex-grow border-gray-300 rounded-lg shadow-sm text-sm" />
                                <button type="button" id="btn-add-new-category" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600">新增</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="content-items-container" class="space-y-3 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <!-- Content items will be injected here -->
                    </div>
                    <button type="button" id="btn-add-content-item" class="mt-2 w-full py-2 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 hover:bg-blue-50 hover:border-blue-500 transition-colors flex justify-center items-center gap-2">
                        <i class="fas fa-plus"></i> 新增處理內容
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">專案總體開始日</label>
                            <input type="date" id="startDate" name="startDate" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">專案總體預計完成日</label>
                            <input type="date" id="estimatedCompletionDate" name="estimatedCompletionDate" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">專案總體進度</label>
                            <select id="status" name="status" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                         <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">備註事項</label>
                            <textarea id="remarks" name="remarks" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" class="btn-cancel-task-form bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-md transition-colors">儲存任務</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col animate-modal-in">
            <form id="settings-form" class="flex flex-col flex-1 min-h-0">
                <h2 class="text-2xl font-bold mb-6">系統設定</h2>
                <div class="flex-grow overflow-y-auto pr-4 space-y-6">
                    <!-- Project Categories Management -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg mb-2 flex items-center gap-2"><i class="fas fa-tag text-blue-500"></i> 專案類別管理</h3>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="settings-new-category" placeholder="新增類別" class="flex-grow border-gray-300 rounded-lg shadow-sm p-2 text-sm" />
                            <button type="button" id="settings-add-category" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-medium">新增</button>
                        </div>
                        <div id="settings-categories-list" class="flex flex-wrap gap-2"></div>
                    </div>
                    <!-- Status Options Management -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg mb-2 flex items-center gap-2"><i class="fas fa-tasks text-yellow-500"></i> 進度項目管理</h3>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="settings-new-status" placeholder="新增進度" class="flex-grow border-gray-300 rounded-lg shadow-sm p-2 text-sm" />
                            <button type="button" id="settings-add-status" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-medium">新增</button>
                        </div>
                        <div id="settings-statuses-list" class="flex flex-wrap gap-2"></div>
                    </div>
                    <!-- Personnel Management -->
                    <div class="p-4 border rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg mb-2 flex items-center gap-2"><i class="fas fa-users text-green-500"></i> 組別與人員管理</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="settings-new-group" placeholder="新增組別" class="flex-grow border-gray-300 rounded-lg shadow-sm p-2 text-sm" />
                            <button type="button" id="settings-add-group" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-medium">新增</button>
                        </div>
                        <div id="settings-personnel-list" class="space-y-4"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="btn-cancel-settings" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-md">儲存設定</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Report Modal -->
    <div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-6xl max-h-[90vh] flex flex-col animate-modal-in">
            <div class="flex justify-between items-center mb-4 border-b pb-3 flex-wrap gap-y-2">
                <h2 class="text-2xl font-bold">專案報表</h2>
                <div class="flex items-center gap-2 flex-wrap justify-end">
                    <select id="report-year-filter" class="border-gray-300 rounded-md shadow-sm text-sm p-2"></select>
                    <select id="report-category-filter" class="border-gray-300 rounded-md shadow-sm text-sm p-2"></select>
                    <select id="report-status-filter" class="border-gray-300 rounded-md shadow-sm text-sm p-2"></select>
                    <select id="report-person-filter" class="border-gray-300 rounded-md shadow-sm text-sm p-2"></select>
                    <button id="btn-download-csv" class="flex items-center bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 shadow-sm">
                        <i class="fas fa-file-csv mr-2"></i> CSV
                    </button>
                    <button id="btn-print-report" class="flex items-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 shadow-sm">
                         <i class="fas fa-print mr-2"></i> 列印
                    </button>
                    <button id="btn-download-pdf" class="flex items-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-sm">
                         <i class="fas fa-file-pdf mr-2"></i> PDF
                    </button>
                    <button id="btn-close-report" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">關閉</button>
                </div>
            </div>
            <div id="report-content-wrapper" class="overflow-y-auto flex-1 min-h-0 bg-white p-4 border rounded shadow-inner">
                <div class="text-center mb-6">
                    <h1 class="text-xl font-bold">專案進度報表</h1>
                    <p id="report-date" class="text-sm text-gray-600"></p>
                </div>
                <table class="min-w-full border-collapse border border-gray-300 report-table">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border border-gray-300 p-2 text-left text-sm font-semibold text-gray-700 w-1/4">專案名稱</th>
                            <th class="border border-gray-300 p-2 text-left text-sm font-semibold text-gray-700 w-1/6">類別</th>
                            <th class="border border-gray-300 p-2 text-left text-sm font-semibold text-gray-700 w-1/12">總體進度</th>
                            <th class="border border-gray-300 p-2 text-left text-sm font-semibold text-gray-700">項目內容詳情</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Archive Modal -->
    <div id="archive-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-6xl max-h-[90vh] flex flex-col animate-modal-in">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-bold flex items-center text-orange-600"><i class="fas fa-archive mr-2"></i> 已封存專案</h2>
                <button id="btn-close-archive" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <!-- Archive Search Bar and Sort -->
            <div class="mb-4 flex gap-2">
                <div class="relative flex-grow">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="archive-search-input" class="pl-10 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 text-sm p-2" placeholder="搜尋封存專案名稱、類別或狀態...">
                </div>
                <select id="archive-sort-select" class="border-gray-300 rounded-lg shadow-sm text-sm p-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="projectName_asc">專案名稱 (A-Z)</option>
                    <option value="projectName_desc">專案名稱 (Z-A)</option>
                    <option value="projectCategory_asc">類別 (A-Z)</option>
                    <option value="projectCategory_desc">類別 (Z-A)</option>
                </select>
            </div>
            <div class="flex-1 min-h-0 overflow-auto">
                <div id="archive-loading" class="text-center py-8 text-gray-500">載入中...</div>
                <table class="min-w-full divide-y divide-gray-200" id="archive-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">專案名稱</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">類別</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">狀態</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody id="archive-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div id="schedule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col animate-modal-in">
            <h2 class="text-2xl font-bold mb-4">設定會議記錄人員輪值</h2>
            <div class="flex-1 min-h-0 overflow-y-auto pr-2">
                <div class="p-4 border rounded-lg mb-6 bg-gray-50">
                    <h3 class="font-semibold text-lg mb-3">輪值人員列表</h3>
                    <p class="text-sm text-gray-500 mb-3">系統將會依照列表順序自動循環排班。</p>
                    <div class="flex items-center gap-2 mb-4">
                        <select id="schedule-person-to-add" class="flex-grow border-gray-300 rounded-lg shadow-sm text-sm p-2"></select>
                        <button id="schedule-btn-add-person" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">新增</button>
                    </div>
                    <div id="schedule-rotation-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
                <div class="p-4 border rounded-lg">
                    <h3 class="font-semibold text-lg mb-3">自動排程預覽與調整</h3>
                    <p class="text-sm text-gray-500 mb-3">可在此微調整體排班順序 (Offset)。</p>
                    <div id="schedule-preview-list" class="space-y-1"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                <button type="button" id="btn-cancel-schedule" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">取消</button>
                <button type="button" id="btn-save-schedule" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-md">儲存輪值設定</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, serverTimestamp, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- Firebase Config & Auth ---
        let app, db, auth, userId, appId;
        
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyDZMH8jbae1H7n3F5GJ8IeNMpuYhV0hxzQ",
                authDomain: "rd202507229.firebaseapp.com",
                databaseURL: "https://rd202507229-default-rtdb.firebaseio.com",
                projectId: "rd202507229",
                storageBucket: "rd202507229.appspot.com",
                messagingSenderId: "893455158003",
                appId: "1:893455158003:web:98a775db491d2fc8724586",
            };
            appId = firebaseConfig.projectId;
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            signInAnonymously(auth).catch(e => console.error("Auth failed:", e));
        } catch (e) {
            console.error("Firebase init failed:", e);
            document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500 font-bold">Firebase 初始化失敗</p>`;
        }

        // --- Default Data ---
        const DEFAULT_CONFIG = {
            personnelData: {
                '開發組': ['張家銘', '陳小美', '王大明', '石宇杰', '阮紹勳', '陳冠彰', '邱柏勳', '潘豐城', '林仕哲'],
                '銲接組': ['哀聖哲', '林志強', '黃小英', '陳彥廷', '林晉宇', '陳冠彰', '蔡明利'],
                '測試組': ['李四', '趙五', '孫六', '莊育誠'],
                '加工組': ['王志新'],
                '其他': ['王正賢', '邱耀賢', '莊立旋']
            },
            projectCategories: ['碳鋼包藥開發', '碳鋼包藥改善', '設備', '測試'],
            statusOptions: ['尚未開始', '進行中', '已完成', '暫停']
        };
        
        const EXCEL_RAW_DATA = [
            { name: "KTVN 火嘴磨耗設備", content: "設計", group: "銲接課", person: "哀聖哲", date: "2024-05-01" },
            { name: "銲接室空間整理", content: "規劃", group: "銲接課", person: "哀聖哲", date: "2024-09-01" },
            { name: "SGS資料整理", content: "資料整合", group: "銲接課", person: "哀聖哲", date: "2024-10-15" },
            { name: "耗材造冊", content: "資料整理", group: "銲接課", person: "哀聖哲", date: "2024-11-01" },
            { name: "銲接年會", content: "2024年銲接年會", group: "銲接課", person: "蔡明利", date: "2024-10-01" },
            { name: "無渣銲線 KM-50LS", content: "資料整合", group: "開發課", person: "邱柏勳", date: "2024-11-01" },
            { name: "樣品防潮箱", content: "規劃", group: "銲接課", person: "陳冠彰", date: "2024-10-01" },
            { name: "長榮混合氣實心", content: "測試比較報告", group: "開發課", person: "張家銘", date: "2024-10-01" },
            { name: "308(-196°C)測試(蓬萊巨濤)", content: "銲線設計", group: "開發課", person: "林仕哲", date: "2024-10-27" },
            { name: "2594測試(長江中車)", content: "調整配方", group: "開發課", person: "林仕哲", date: "2025-03-31" }
        ];
        
        // --- Global State ---
        let allTasks = [];
        let allArchivedTasks = [];
        let config = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
        let recorderSchedule = { rotation: [], offset: 0 };
        let currentTaskToEdit = null;
        let contentItemCounter = 0; 
        let unsubscribeTasks = null;
        let archivedTasksUnsubscribe = null;

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const dashboardTableContainer = document.getElementById('dashboard-table-container');
        const dashboardTableBody = document.getElementById('dashboard-table-body');
        const taskFormModal = document.getElementById('task-form-modal');
        const settingsModal = document.getElementById('settings-modal');
        const reportModal = document.getElementById('report-modal');
        const scheduleModal = document.getElementById('schedule-modal');
        const archiveModal = document.getElementById('archive-modal');
        const taskForm = document.getElementById('task-form');
        const searchInput = document.getElementById('search-input');
        const archiveSearchInput = document.getElementById('archive-search-input');
        const archiveSortSelect = document.getElementById('archive-sort-select');

        // --- Modal Elements ---
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMsg = document.getElementById('confirm-message');
        const confirmBtnOk = document.getElementById('btn-confirm-ok');
        const confirmBtnCancel = document.getElementById('btn-confirm-cancel');
        let confirmCallback = null;

        // --- Helper Functions ---
        const getStatusColor = (status) => {
            switch (status) {
                case '已完成': return 'bg-green-100 text-green-800 border-green-200';
                case '進行中': return 'bg-blue-100 text-blue-800 border-blue-200';
                case '暫停': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                default: return 'bg-gray-100 text-gray-800 border-gray-200';
            }
        };

        const createStatusBadge = (status, taskId, itemIndex = null) => {
            return `
                <div class="relative status-badge-wrapper inline-block">
                    <button class="px-3 py-1 text-xs font-bold rounded-full border cursor-pointer ${getStatusColor(status)} shadow-sm hover:opacity-80 transition-opacity whitespace-nowrap">
                        ${status}
                    </button>
                    <div class="status-popover hidden absolute z-50 mt-1 w-32 bg-white rounded-lg shadow-xl border border-gray-200 left-0">
                        <ul class="py-1 text-sm" data-task-id="${taskId}" data-item-index="${itemIndex !== null ? itemIndex : ''}">
                            ${config.statusOptions.map(s => `
                                <li><a href="#" class="block px-4 py-2 hover:bg-blue-50 text-gray-700 hover:text-blue-700" data-status="${s}">${s}</a></li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
        };

        const getWeekKey = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}-${String(weekNo).padStart(2, '0')}`;
        };

        const calculateDaysInProgress = (task) => {
            const { startDate, status, actualCompletionDate } = task;
            if (!startDate) return '-';
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            let end = (status === '已完成' && actualCompletionDate) ? new Date(actualCompletionDate) : new Date();
            end.setHours(0, 0, 0, 0);
            if (start > end) return 0;
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        };
        
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `hidden fixed top-5 right-5 py-2 px-4 rounded-lg shadow-lg z-[70] animate-fade-in-out font-bold ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        };
        
        const toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if(show) { el.classList.remove('hidden'); setTimeout(()=>el.querySelector('div').classList.remove('opacity-0'), 10); } 
            else { el.classList.add('hidden'); }
        };

        // --- Custom Confirm Logic ---
        function showConfirm(message, callback, confirmText = "確定", confirmColorClass = "bg-blue-600") {
            confirmMsg.textContent = message;
            confirmCallback = callback;
            
            // Reset button style
            confirmBtnOk.className = `text-white font-bold py-2 px-4 rounded-lg shadow-md hover:opacity-90 ${confirmColorClass}`;
            confirmBtnOk.textContent = confirmText;
            
            confirmModal.classList.remove('hidden');
        }

        confirmBtnOk.onclick = () => {
            if (confirmCallback) confirmCallback();
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        };
        confirmBtnCancel.onclick = () => {
            confirmModal.classList.add('hidden');
            confirmCallback = null;
        };

        // --- Enhanced Settings Logic ---
        const openSettingsModal = () => {
            const tempConfig = JSON.parse(JSON.stringify(config));
            
            const render = () => {
                document.getElementById('settings-categories-list').innerHTML = tempConfig.projectCategories.map(c => `
                    <span class="flex items-center gap-2 bg-gray-200 text-gray-800 text-sm px-3 py-1 rounded-full">
                        ${c} <button type="button" data-action="delete-category" data-value="${c}" class="font-bold text-red-500 hover:text-red-700">&times;</button>
                    </span>
                `).join('');

                document.getElementById('settings-statuses-list').innerHTML = tempConfig.statusOptions.map(s => `
                    <span class="flex items-center gap-2 bg-gray-200 text-gray-800 text-sm px-3 py-1 rounded-full">
                        ${s} <button type="button" data-action="delete-status" data-value="${s}" class="font-bold text-red-500 hover:text-red-700">&times;</button>
                    </span>
                `).join('');

                document.getElementById('settings-personnel-list').innerHTML = Object.entries(tempConfig.personnelData).map(([group, people]) => `
                    <div class="p-3 bg-gray-50 rounded-md border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-700">${group}</h4>
                            <button type="button" data-action="delete-group" data-group="${group}" class="text-red-500 text-sm hover:text-red-700 hover:underline">刪除組別</button>
                        </div>
                        <div class="pl-0 sm:pl-4">
                            <div class="flex gap-2 mb-3">
                                <input type="text" placeholder="新增人員" id="input-person-${group}" class="flex-grow border-gray-300 rounded-lg shadow-sm text-sm p-2" />
                                <button type="button" data-action="add-person" data-group="${group}" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 shadow-sm">加入</button>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${people.map(person => `
                                    <span class="flex items-center gap-2 bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full">
                                        ${person} <button type="button" data-action="delete-person" data-group="${group}" data-person="${person}" class="font-bold text-red-500 hover:text-red-700">&times;</button>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            };

            render();

            const form = document.getElementById('settings-form');
            form.onclick = (e) => {
                const target = e.target;
                const action = target.dataset.action;
                
                if (target.id === 'settings-add-category') {
                    const val = document.getElementById('settings-new-category').value.trim();
                    if (val && !tempConfig.projectCategories.includes(val)) {
                        tempConfig.projectCategories.push(val);
                        document.getElementById('settings-new-category').value = '';
                        render();
                    }
                } else if (target.id === 'settings-add-status') {
                    const val = document.getElementById('settings-new-status').value.trim();
                    if (val && !tempConfig.statusOptions.includes(val)) {
                        tempConfig.statusOptions.push(val);
                        document.getElementById('settings-new-status').value = '';
                        render();
                    }
                } else if (target.id === 'settings-add-group') {
                    const val = document.getElementById('settings-new-group').value.trim();
                    if (val && !tempConfig.personnelData[val]) {
                        tempConfig.personnelData[val] = [];
                        document.getElementById('settings-new-group').value = '';
                        render();
                    }
                }
                
                if (!action) return;

                if (action === 'delete-category') {
                    tempConfig.projectCategories = tempConfig.projectCategories.filter(c => c !== target.dataset.value);
                    render();
                } else if (action === 'delete-status') {
                    tempConfig.statusOptions = tempConfig.statusOptions.filter(s => s !== target.dataset.value);
                    render();
                } else if (action === 'delete-group') {
                    showConfirm(`確定要刪除 ${target.dataset.group} 嗎？`, () => {
                        delete tempConfig.personnelData[target.dataset.group];
                        render();
                    }, '刪除', 'bg-red-600');
                } else if (action === 'add-person') {
                    const group = target.dataset.group;
                    const input = document.getElementById(`input-person-${group}`);
                    const val = input.value.trim();
                    if (val && !tempConfig.personnelData[group].includes(val)) {
                        tempConfig.personnelData[group].push(val);
                        input.value = '';
                        render();
                    }
                } else if (action === 'delete-person') {
                    const { group, person } = target.dataset;
                    tempConfig.personnelData[group] = tempConfig.personnelData[group].filter(p => p !== person);
                    render();
                }
            };

            form.onsubmit = (e) => {
                e.preventDefault();
                set(ref(db, `artifacts/${appId}/public/data/app_config`), tempConfig);
                toggleModal('settings-modal', false);
                showToast('設定已更新');
            };

            toggleModal('settings-modal', true);
        };

        const openScheduleModal = () => {
            renderSchedulePreview();
            toggleModal('schedule-modal', true);
        };
        
        const downloadCSV = () => {
            const year = document.getElementById('report-year-filter').value;
            const category = document.getElementById('report-category-filter').value;
            const status = document.getElementById('report-status-filter').value;
            const person = document.getElementById('report-person-filter').value;

            const filtered = allTasks.filter(task => 
                (year === 'all' || (task.startDate && task.startDate.startsWith(year))) &&
                (category === 'all' || task.projectCategory === category) &&
                (status === 'all' || task.status === status) &&
                (person === 'all' || task.contentItems?.some(item => item.assignedPersonnel?.some(p => p.name === person)))
            );
            
            if (filtered.length === 0) {
                showToast("沒有可匯出的資料。", 'error');
                return;
            }

            const headers = [
                "專案名稱", "專案類別", "專案總體開始日", "專案總體預計完成日", "專案總體進度",
                "項目內容", "項目開始日", "項目結束日", "項目進度", "主要人員", "協助人員", "備註"
            ];
            
            let csvContent = "\uFEFF"; 
            csvContent += headers.join(',') + '\r\n';

            filtered.forEach(task => {
                const escapeCSV = (field) => `"${(field || '').toString().replace(/"/g, '""')}"`;
                if (task.contentItems && task.contentItems.length > 0) {
                    task.contentItems.forEach(item => {
                        const mainPersonnel = (item.assignedPersonnel || []).filter(p => p.role === '主要').map(p => p.name).join('; ');
                        const assistingPersonnel = (item.assignedPersonnel || []).filter(p => p.role === '協助').map(p => p.name).join('; ');
                        const row = [task.projectName, task.projectCategory, task.startDate, task.estimatedCompletionDate, task.status, item.content, item.startDate, item.endDate, item.status, mainPersonnel, assistingPersonnel, task.remarks].map(escapeCSV).join(',');
                        csvContent += row + '\r\n';
                    });
                } else {
                    const row = [task.projectName, task.projectCategory, task.startDate, task.estimatedCompletionDate, task.status, "", "", "", "", "", "", task.remarks].map(escapeCSV).join(',');
                    csvContent += row + '\r\n';
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `專案進度報表_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const printReport = () => {
            const reportContent = document.getElementById('report-content-wrapper').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>專案進度報表</title>
                <style>
                    body { font-family: "Microsoft JhengHei", sans-serif !important; -webkit-print-color-adjust: exact !important; }
                    @page { size: A4 landscape; margin: 10mm; }
                    table { width: 100%; border-collapse: collapse; font-size: 10pt; }
                    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                    th { background-color: #f3f4f6; }
                </style>
                </head><body>${reportContent}<script>window.onload = function() { window.print(); window.close(); }<\/script></body></html>
            `);
            printWindow.document.close();
        };

        const renderApp = () => {
            renderStatsCards();
            renderDashboardTable();
        };
        
        const renderStatsCards = () => {
            const container = document.getElementById('stats-cards-container');
            const allSubItems = allTasks.flatMap(t => t.contentItems || []);
            const completedProjects = allTasks.filter(t => t.status === '已完成').length;
            const inProgressProjects = allTasks.filter(t => t.status === '進行中').length;
            const pausedProjects = allTasks.filter(t => t.status === '暫停').length;
            
            let thisWeeksRecorder = '未排定', nextWeeksRecorder = '未排定';
            const { rotation = [], offset = 0 } = recorderSchedule;
            if (Array.isArray(rotation) && rotation.length > 0) {
                const today = new Date();
                const thisWeekKey = getWeekKey(today);
                const nextWeekKey = getWeekKey(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
                
                const thisWeekNum = parseInt(thisWeekKey.split('-')[1], 10) || 1;
                const nextWeekNum = parseInt(nextWeekKey.split('-')[1], 10) || 2;
                const total = rotation.length;
                thisWeeksRecorder = rotation[((thisWeekNum - 1 + offset) % total + total) % total];
                nextWeeksRecorder = rotation[((nextWeekNum - 1 + offset) % total + total) % total];
            }

            // Update Summary Text
            const summaryEl = document.getElementById('stats-summary-text');
            if(summaryEl) {
                summaryEl.textContent = `本週記錄人員: ${thisWeeksRecorder}`;
                const wrapper = document.getElementById('stats-wrapper');
                if (wrapper.classList.contains('stats-collapsed')) {
                    summaryEl.classList.remove('hidden');
                    summaryEl.classList.remove('opacity-0');
                } else {
                    summaryEl.classList.add('opacity-0');
                    summaryEl.classList.add('hidden');
                }
            }

            const cards = [
                { color: 'blue', icon: 'fa-chart-pie', title: '專案總數', value: allTasks.length, sub: `進行中: ${inProgressProjects}` },
                { color: 'green', icon: 'fa-check-circle', title: '已完成專案', value: completedProjects, sub: `完成率: ${allTasks.length ? Math.round((completedProjects/allTasks.length)*100) : 0}%` },
                { color: 'yellow', icon: 'fa-pause-circle', title: '暫停中專案', value: pausedProjects, sub: '待重啟' },
                { color: 'indigo', icon: 'fa-user-clock', title: '本週記錄', value: thisWeeksRecorder, sub: `下週: ${nextWeeksRecorder}` }
            ];

            container.innerHTML = cards.map(c => `
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-${c.color}-500 flex items-center justify-between">
                    <div>
                        <div class="text-gray-500 text-xs font-semibold uppercase tracking-wide">${c.title}</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1">${c.value}</div>
                        <div class="text-xs text-gray-400 mt-1">${c.sub}</div>
                    </div>
                    <div class="bg-${c.color}-100 p-3 rounded-full text-${c.color}-600">
                        <i class="fas ${c.icon} text-xl"></i>
                    </div>
                </div>
            `).join('');
        };
        
        const renderDashboardTable = () => {
            const showCompleted = document.getElementById('filter-show-completed').checked;
            const showPaused = document.getElementById('filter-show-paused').checked;
            const sortCriteria = document.getElementById('sort-select').value;
            const selectedPerson = document.getElementById('person-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();

            const existingOptions = new Set();
            allTasks.forEach(t => t.contentItems?.forEach(i => i.assignedPersonnel?.forEach(p => {
                if(p.role === '主要') existingOptions.add(p.name);
            })));
            const currentSelected = document.getElementById('person-filter').value;
            let optionsHtml = `<option value="all">全部人員</option>`;
            Array.from(existingOptions).sort().forEach(p => {
                optionsHtml += `<option value="${p}" ${p === currentSelected ? 'selected' : ''}>${p}</option>`;
            });
            if (document.getElementById('person-filter').innerHTML !== optionsHtml) {
                 document.getElementById('person-filter').innerHTML = optionsHtml;
            }

            let filteredTasks = allTasks.filter(task => {
                if (!showCompleted && task.status === '已完成') return false;
                if (!showPaused && task.status === '暫停') return false;
                if (selectedPerson !== 'all') {
                    const hasPerson = task.contentItems?.some(item => item.assignedPersonnel?.some(p => p.role === '主要' && p.name === selectedPerson));
                    if (!hasPerson) return false;
                }
                if (searchTerm) {
                    const inName = task.projectName.toLowerCase().includes(searchTerm);
                    const inCat = task.projectCategory.toLowerCase().includes(searchTerm);
                    const inContent = task.contentItems?.some(i => i.content.toLowerCase().includes(searchTerm));
                    const inPerson = task.contentItems?.some(i => i.assignedPersonnel?.some(p => p.name.toLowerCase().includes(searchTerm)));
                    if (!inName && !inCat && !inContent && !inPerson) return false;
                }
                return true;
            });

            filteredTasks.sort((a, b) => {
                switch (sortCriteria) {
                    case 'startDate_desc': return (new Date(b.startDate || 0)) - (new Date(a.startDate || 0));
                    case 'startDate_asc': return (new Date(a.startDate || 0)) - (new Date(b.startDate || 0));
                    case 'projectName_asc': return a.projectName.localeCompare(b.projectName, 'zh-Hant');
                    case 'projectCategory_asc': return a.projectCategory.localeCompare(b.projectCategory, 'zh-Hant');
                    case 'createdAt_asc': return (a.createdAt || 0) - (b.createdAt || 0);
                    default: return (b.createdAt || 0) - (a.createdAt || 0);
                }
            });

            document.getElementById('displayed-count').textContent = filteredTasks.length;

            if (filteredTasks.length === 0) {
                 dashboardTableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500 bg-gray-50">沒有符合條件的任務。</td></tr>`;
            } else {
                dashboardTableBody.innerHTML = filteredTasks.map(task => {
                    const allItemsWithIndex = (task.contentItems || []).map((item, idx) => ({ ...item, originalIndex: idx }));
                    const visibleItems = allItemsWithIndex.filter(item => {
                         if (!showCompleted && item.status === '已完成') return false;
                         if (!showPaused && item.status === '暫停') return false;
                         return true;
                    });

                    const contentHtml = visibleItems.length > 0 ? visibleItems.map((item) => {
                         const mainP = item.assignedPersonnel?.filter(p => p.role === '主要').map(p => p.name).join(', ') || '-';
                         const asstP = item.assignedPersonnel?.filter(p => p.role === '協助').map(p => p.name).join(', ');
                         const dateRange = (item.startDate || item.endDate) ? `<span class="text-gray-400 mx-1">|</span> ${item.startDate||'?'}~${item.endDate||'?'}` : '';
                         
                         return `
                            <div class="mb-2 last:mb-0 p-2 rounded hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-colors">
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-gray-800 text-base">${item.content}</div>
                                    ${createStatusBadge(item.status, task.id, item.originalIndex)}
                                </div>
                                <div class="text-xs text-gray-500 mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                    <div class="flex items-center"><i class="fas fa-user-circle mr-1 text-blue-400"></i> ${mainP}</div>
                                    ${asstP ? `<div class="flex items-center"><i class="fas fa-hands-helping mr-1 text-green-400"></i> ${asstP}</div>` : ''}
                                    <div class="flex items-center"><i class="far fa-calendar-alt mr-1 text-gray-400"></i> ${dateRange}</div>
                                </div>
                            </div>
                         `;
                    }).join('') : `<span class="text-gray-400 italic text-sm">${(task.contentItems||[]).length > 0 ? '所有項目已隱藏' : '無細項內容'}</span>`;

                    const days = calculateDaysInProgress(task);
                    
                    return `
                        <tr class="hover:bg-blue-50 transition-colors group" data-task-id="${task.id}">
                            <td class="px-3 py-4 align-top text-gray-900 font-bold" data-label="專案名稱">${task.projectName}</td>
                            <td class="px-3 py-4 align-top text-sm text-gray-600" data-label="類別"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${task.projectCategory}</span></td>
                            <td class="px-3 py-4 align-top" data-label="處理項目詳情">${contentHtml}</td>
                            <td class="px-3 py-4 align-top" data-label="總體進度">${createStatusBadge(task.status, task.id)}</td>
                            <td class="px-3 py-4 align-top text-sm text-gray-600 font-mono" data-label="天數">${days}</td>
                            <td class="px-3 py-4 align-top" data-label="操作">
                                <div class="flex space-x-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity justify-end sm:justify-start">
                                    <button class="btn-edit-task bg-indigo-50 text-indigo-600 p-2 rounded hover:bg-indigo-100" title="編輯"><i class="fas fa-edit"></i></button>
                                    <button class="btn-archive-task bg-orange-50 text-orange-600 p-2 rounded hover:bg-orange-100" title="封存"><i class="fas fa-archive"></i></button>
                                    <button class="btn-delete-task bg-red-50 text-red-600 p-2 rounded hover:bg-red-100" title="刪除"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        };

        // --- Interaction Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            if (auth) {
                 onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId.substring(0,6) + '...';
                        initDataListeners();
                    } else {
                        document.getElementById('user-id').textContent = '未登入';
                    }
                });
            } else {
                console.error("Firebase auth not initialized");
                loadingSpinner.innerHTML = `<p class="text-red-500 font-bold">系統連線失敗</p>`;
            }

            setupEventListeners();
        });

        // --- Modified Data Listeners: Removed Pagination ---
        function initDataListeners() {
            onValue(ref(db, `artifacts/${appId}/public/data/app_config`), (snap) => {
                if (snap.exists()) {
                    config = snap.val();
                } else {
                    set(ref(db, `artifacts/${appId}/public/data/app_config`), DEFAULT_CONFIG);
                }
                renderApp(); 
            });

            onValue(ref(db, `artifacts/${appId}/public/data/recorder_schedule`), (snap) => {
                if (snap.exists()) {
                    const val = snap.val();
                    recorderSchedule = { rotation: val.rotation || [], offset: val.offset || 0 };
                }
                renderStatsCards();
            });

            // Initial load of tasks
            loadTasks();
        }

        // Modified: Load ALL active tasks (no limit)
        function loadTasks() {
            const tasksRef = ref(db, `artifacts/${appId}/public/data/tasks`);
            // Plain onValue without query limits
            unsubscribeTasks = onValue(tasksRef, (snap) => {
                const val = snap.val();
                if (!val) {
                    allTasks = [];
                    // Seed logic could go here if needed
                } else {
                    allTasks = Object.keys(val).map(key => ({ id: key, ...val[key] }));
                }
                
                loadingSpinner.classList.add('hidden');
                dashboardTableContainer.classList.remove('hidden');
                renderApp();
            });
        }

        function setupEventListeners() {
            // Stats Toggle
            document.getElementById('btn-toggle-stats').onclick = () => {
                const wrapper = document.getElementById('stats-wrapper');
                const icon = document.getElementById('icon-toggle-stats');
                const summary = document.getElementById('stats-summary-text');

                if (wrapper.classList.contains('stats-expanded')) {
                    // Collapse
                    wrapper.classList.remove('stats-expanded');
                    wrapper.classList.add('stats-collapsed');
                    icon.classList.add('rotate-180');
                    summary.classList.remove('hidden');
                    setTimeout(() => summary.classList.remove('opacity-0'), 10);
                } else {
                    // Expand
                    wrapper.classList.remove('stats-collapsed');
                    wrapper.classList.add('stats-expanded');
                    icon.classList.remove('rotate-180');
                    summary.classList.add('opacity-0');
                    setTimeout(() => summary.classList.add('hidden'), 300);
                }
            };
            
            document.getElementById('btn-add-task').onclick = () => openTaskForm();
            document.querySelectorAll('.btn-cancel-task-form').forEach(b => b.onclick = () => toggleModal('task-form-modal', false));
            
            document.getElementById('btn-show-settings').onclick = openSettingsModal;
            document.getElementById('btn-cancel-settings').onclick = () => toggleModal('settings-modal', false);

            document.getElementById('btn-show-report').onclick = openReportModal;
            document.getElementById('btn-close-report').onclick = () => toggleModal('report-modal', false);

            document.getElementById('btn-show-schedule').onclick = openScheduleModal;
            document.getElementById('btn-cancel-schedule').onclick = () => toggleModal('schedule-modal', false);

            document.getElementById('btn-show-archive').onclick = openArchiveModal;
            document.getElementById('btn-close-archive').onclick = () => toggleModal('archive-modal', false);
            
            // Add Archive Search Listener
            archiveSearchInput.addEventListener('input', renderArchiveTable);
            archiveSortSelect.addEventListener('change', renderArchiveTable);

            ['filter-show-completed', 'filter-show-paused', 'sort-select', 'person-filter'].forEach(id => {
                document.getElementById(id).onchange = renderDashboardTable;
            });
            document.getElementById('search-input').oninput = renderDashboardTable;

            // Dashboard Actions
            dashboardTableBody.onclick = (e) => {
                // Status Popup
                const statusLink = e.target.closest('.status-popover a');
                if (statusLink) {
                    e.preventDefault();
                    const ul = statusLink.closest('ul');
                    const taskId = ul.dataset.taskId;
                    const idx = ul.dataset.itemIndex;
                    const newStatus = statusLink.dataset.status;
                    
                    const path = (idx !== null && idx !== '')
                        ? `artifacts/${appId}/public/data/tasks/${taskId}/contentItems/${idx}/status`
                        : `artifacts/${appId}/public/data/tasks/${taskId}/status`;
                    
                    const updates = { [path]: newStatus };
                    if ((idx === null || idx === '') && newStatus === '已完成') {
                        updates[`artifacts/${appId}/public/data/tasks/${taskId}/actualCompletionDate`] = new Date().toISOString().slice(0,10);
                    }
                    
                    update(ref(db), updates);
                    showToast('狀態已更新');
                    document.querySelectorAll('.status-popover').forEach(p => p.classList.add('hidden'));
                    return;
                }

                // Other Actions
                const btnEdit = e.target.closest('.btn-edit-task');
                const btnArchive = e.target.closest('.btn-archive-task');
                const btnDel = e.target.closest('.btn-delete-task');
                const badgeWrapper = e.target.closest('.status-badge-wrapper');
                
                const tr = e.target.closest('tr');
                if(!tr) return;
                const taskId = tr.dataset.taskId;

                if (btnEdit) openTaskForm(allTasks.find(t => t.id === taskId));
                if (btnArchive) {
                    showConfirm('確定要封存此任務嗎？封存後可至「已封存專案」查看。', () => archiveTask(taskId), '封存', 'bg-orange-600');
                }
                if (btnDel) {
                    showConfirm('確定刪除此任務？(此操作無法復原)', () => remove(ref(db, `artifacts/${appId}/public/data/tasks/${taskId}`)), '刪除', 'bg-red-600');
                }
                
                if (badgeWrapper) {
                     const popover = badgeWrapper.querySelector('.status-popover');
                     const wasHidden = popover.classList.contains('hidden');
                     document.querySelectorAll('.status-popover').forEach(p => p.classList.add('hidden'));
                     if (wasHidden) popover.classList.remove('hidden');
                     e.stopPropagation(); 
                }
            };

            // Archive Modal Actions
            document.getElementById('archive-table-body').onclick = (e) => {
                const btnRestore = e.target.closest('.btn-restore-task');
                const btnDelPerm = e.target.closest('.btn-delete-permanent');
                const tr = e.target.closest('tr');
                if(!tr) return;
                const taskId = tr.dataset.taskId;

                if(btnRestore) {
                    showConfirm('確定要還原此任務嗎？', () => restoreTask(taskId), '還原', 'bg-green-600');
                }
                if(btnDelPerm) {
                    showConfirm('警告：確定要永久刪除此任務嗎？此操作無法復原！', () => deleteArchivedTask(taskId), '永久刪除', 'bg-red-600');
                }
            };

            // Global click to close popovers
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.status-badge-wrapper')) {
                    document.querySelectorAll('.status-popover').forEach(p => p.classList.add('hidden'));
                }
            });

            // ... (rest of listeners like form submit) ...
            document.getElementById('btn-add-content-item').onclick = () => addContentItemToForm();
            document.getElementById('content-items-container').onclick = (e) => {
                if (e.target.closest('.btn-remove-item')) e.target.closest('.item-row').remove();
                if (e.target.closest('.btn-remove-p')) {
                    const pill = e.target.closest('.person-pill');
                    pill.remove();
                }
            };
            
            document.getElementById('content-items-container').addEventListener('change', (e) => {
                if (e.target.classList.contains('p-selector')) {
                    const row = e.target.closest('.item-row');
                    const role = row.querySelector('.p-role').value;
                    const group = row.querySelector('.p-group').value;
                    const name = row.querySelector('.p-name').value;
                    if (e.target.classList.contains('p-group')) {
                        const names = config.personnelData[group] || [];
                        row.querySelector('.p-name').innerHTML = `<option value="">選擇人員</option>` + names.map(n => `<option value="${n}">${n}</option>`).join('');
                    } else if (e.target.classList.contains('p-name') && name) {
                        const container = row.querySelector('.p-list');
                        const fullName = `${group} - ${name}`;
                        if (!Array.from(container.children).some(c => c.dataset.name === fullName)) {
                            container.innerHTML += `
                                <span class="person-pill bg-${role==='主要'?'green':'blue'}-100 text-${role==='主要'?'green':'blue'}-800 text-xs px-2 py-1 rounded-full mr-1 mb-1 inline-flex items-center" data-name="${fullName}" data-role="${role}">
                                    ${role}: ${name} <button type="button" class="btn-remove-p ml-1 hover:text-red-600">&times;</button>
                                </span>
                            `;
                            e.target.value = ''; 
                        }
                    }
                }
            });

            taskForm.onsubmit = (e) => {
                e.preventDefault();
                const taskId = document.getElementById('task-id').value;
                const items = Array.from(document.querySelectorAll('#content-items-container .item-row')).map(row => ({
                    content: row.querySelector('.item-content').value,
                    startDate: row.querySelector('.item-start').value,
                    endDate: row.querySelector('.item-end').value,
                    status: row.querySelector('.item-status').value,
                    assignedPersonnel: Array.from(row.querySelectorAll('.person-pill')).map(p => ({
                        name: p.dataset.name, role: p.dataset.role
                    }))
                }));
                
                const payload = {
                    projectName: document.getElementById('projectName').value,
                    projectCategory: document.getElementById('projectCategory').value,
                    startDate: document.getElementById('startDate').value,
                    estimatedCompletionDate: document.getElementById('estimatedCompletionDate').value,
                    status: document.getElementById('status').value,
                    remarks: document.getElementById('remarks').value,
                    contentItems: items
                };

                if (taskId) update(ref(db, `artifacts/${appId}/public/data/tasks/${taskId}`), payload);
                else push(ref(db, `artifacts/${appId}/public/data/tasks`), { ...payload, createdAt: serverTimestamp(), ownerId: userId });
                
                toggleModal('task-form-modal', false);
                showToast('儲存成功');
            };

            setupScheduleInteractions();
            
            document.getElementById('btn-download-pdf').onclick = () => {
                 const el = document.getElementById('report-content-wrapper');
                 const opt = { margin: 0.5, filename: 'report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } };
                 html2pdf().set(opt).from(el).save();
            };
            document.getElementById('btn-print-report').onclick = printReport;
            document.getElementById('btn-download-csv').onclick = downloadCSV;
            ['report-year-filter', 'report-category-filter', 'report-status-filter', 'report-person-filter'].forEach(id => {
                document.getElementById(id).onchange = renderReportTable; 
            });
        }

        // --- Archive Functions ---
        async function archiveTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;
            
            const taskData = { ...task };
            delete taskData.id; 
            
            try {
                await set(ref(db, `artifacts/${appId}/public/data/archived_tasks/${taskId}`), taskData);
                await remove(ref(db, `artifacts/${appId}/public/data/tasks/${taskId}`));
                showToast('任務已封存');
            } catch (e) {
                console.error(e);
                showToast('封存失敗', 'error');
            }
        }

        function openArchiveModal() {
            toggleModal('archive-modal', true);
            const archiveRef = ref(db, `artifacts/${appId}/public/data/archived_tasks`);
            
            if (archivedTasksUnsubscribe) archivedTasksUnsubscribe();
            
            document.getElementById('archive-loading').classList.remove('hidden');
            document.getElementById('archive-table').classList.add('hidden');
            archiveSearchInput.value = ''; // Reset search
            
            archivedTasksUnsubscribe = onValue(archiveRef, (snap) => {
                const val = snap.val();
                allArchivedTasks = val ? Object.keys(val).map(key => ({ id: key, ...val[key] })) : [];
                
                document.getElementById('archive-loading').classList.add('hidden');
                document.getElementById('archive-table').classList.remove('hidden');
                
                renderArchiveTable();
            });
        }

        function renderArchiveTable() {
            const tbody = document.getElementById('archive-table-body');
            const term = archiveSearchInput.value.toLowerCase().trim();
            const sortValue = archiveSortSelect.value;
            
            let filtered = allArchivedTasks.filter(t => {
                if(!term) return true;
                return (t.projectName || '').toLowerCase().includes(term) ||
                       (t.projectCategory || '').toLowerCase().includes(term) ||
                       (t.status || '').toLowerCase().includes(term);
            });

            // Sorting Logic
            filtered.sort((a, b) => {
                const key = sortValue.split('_')[0];
                const type = sortValue.split('_')[1];
                const valA = (a[key] || '').toString();
                const valB = (b[key] || '').toString();
                
                return type === 'asc' ? valA.localeCompare(valB, 'zh-Hant') : valB.localeCompare(valA, 'zh-Hant');
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">${allArchivedTasks.length === 0 ? '暫無封存資料' : '找不到符合的資料'}</td></tr>`;
            } else {
                tbody.innerHTML = filtered.map(t => `
                    <tr data-task-id="${t.id}" class="hover:bg-gray-50">
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${t.projectName}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${t.projectCategory}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${t.status}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium">
                            <button class="btn-restore-task text-green-600 hover:text-green-900 mr-3"><i class="fas fa-undo"></i> 還原</button>
                            <button class="btn-delete-permanent text-red-600 hover:text-red-900"><i class="fas fa-trash"></i> 刪除</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        async function restoreTask(taskId) {
             try {
                const snap = await new Promise(resolve => onValue(ref(db, `artifacts/${appId}/public/data/archived_tasks/${taskId}`), resolve, {onlyOnce: true}));
                const taskData = snap.val();
                
                if(taskData) {
                     await set(ref(db, `artifacts/${appId}/public/data/tasks/${taskId}`), taskData);
                     await remove(ref(db, `artifacts/${appId}/public/data/archived_tasks/${taskId}`));
                     showToast('任務已還原');
                }
             } catch(e) {
                 console.error(e);
                 showToast('還原失敗', 'error');
             }
        }
        
        async function deleteArchivedTask(taskId) {
            try {
                await remove(ref(db, `artifacts/${appId}/public/data/archived_tasks/${taskId}`));
                showToast('永久刪除成功');
            } catch(e) {
                 console.error(e);
                 showToast('刪除失敗', 'error');
            }
        }

        // --- Form Helpers (unchanged logic) ---
        function openTaskForm(task = null) {
            currentTaskToEdit = task;
            taskForm.reset();
            document.getElementById('task-id').value = task ? task.id : '';
            document.getElementById('task-form-title').innerText = task ? '編輯任務' : '新增任務';
            
            const catSel = document.getElementById('projectCategory');
            catSel.innerHTML = config.projectCategories.map(c => `<option value="${c}">${c}</option>`).join('');
            const statSel = document.getElementById('status');
            statSel.innerHTML = config.statusOptions.map(s => `<option value="${s}">${s}</option>`).join('');

            if(task) {
                document.getElementById('projectName').value = task.projectName;
                catSel.value = task.projectCategory;
                document.getElementById('startDate').value = task.startDate || '';
                document.getElementById('estimatedCompletionDate').value = task.estimatedCompletionDate || '';
                statSel.value = task.status;
                document.getElementById('remarks').value = task.remarks || '';
                renderFormItems(task.contentItems || []);
            } else {
                statSel.value = '進行中';
                renderFormItems([{ content: '', status: '進行中' }]);
            }
            
            document.getElementById('task-form-modal').classList.remove('hidden');
        }

        function renderFormItems(items) {
            const container = document.getElementById('content-items-container');
            container.innerHTML = '';
            items.forEach(addContentItemToForm);
        }

        function addContentItemToForm(item = {}) {
            const container = document.getElementById('content-items-container');
            const div = document.createElement('div');
            div.className = 'item-row p-3 bg-white rounded border shadow-sm relative';
            
            const groups = Object.keys(config.personnelData);
            
            div.innerHTML = `
                <button type="button" class="btn-remove-item absolute top-2 right-2 text-gray-400 hover:text-red-500">&times;</button>
                <div class="mb-2">
                    <label class="text-xs text-gray-500">處理內容</label>
                    <input type="text" class="item-content w-full border-gray-300 rounded text-sm" value="${item.content || ''}" placeholder="描述處理項目">
                </div>
                <div class="personnel-wrapper mb-2 bg-gray-50 p-2 rounded">
                    <div class="flex gap-2 mb-1">
                        <select class="p-role p-selector border-gray-300 rounded text-xs"><option value="主要">主要</option><option value="協助">協助</option></select>
                        <select class="p-group p-selector border-gray-300 rounded text-xs">${groups.map(g => `<option value="${g}">${g}</option>`).join('')}</select>
                        <select class="p-name p-selector border-gray-300 rounded text-xs flex-grow"><option value="">選擇人員</option></select>
                    </div>
                    <div class="p-list flex flex-wrap">
                        ${(item.assignedPersonnel || []).map(p => `
                            <span class="person-pill bg-${p.role==='主要'?'green':'blue'}-100 text-${p.role==='主要'?'green':'blue'}-800 text-xs px-2 py-1 rounded-full mr-1 mb-1 inline-flex items-center" data-name="${p.name}" data-role="${p.role}">
                                ${p.role}: ${p.name.split('-')[1] || p.name} <button type="button" class="btn-remove-p ml-1 hover:text-red-600">&times;</button>
                            </span>
                        `).join('')}
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-xs text-gray-500">開始</label><input type="date" class="item-start w-full border-gray-300 rounded text-xs" value="${item.startDate || ''}"></div>
                    <div><label class="text-xs text-gray-500">結束</label><input type="date" class="item-end w-full border-gray-300 rounded text-xs" value="${item.endDate || ''}"></div>
                    <div>
                        <label class="text-xs text-gray-500">狀態</label>
                        <select class="item-status w-full border-gray-300 rounded text-xs">
                             ${config.statusOptions.map(s => `<option value="${s}" ${item.status===s?'selected':''}>${s}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            const groupSel = div.querySelector('.p-group');
            const nameSel = div.querySelector('.p-name');
            nameSel.innerHTML = `<option value="">選擇人員</option>` + (config.personnelData[groupSel.value]||[]).map(n => `<option value="${n}">${n}</option>`).join('');
            
            container.appendChild(div);
        }

        function setupScheduleInteractions() {
             document.getElementById('schedule-btn-add-person').onclick = () => {
                const p = document.getElementById('schedule-person-to-add').value;
                if(p && !recorderSchedule.rotation.includes(p)) {
                    recorderSchedule.rotation.push(p);
                    renderSchedulePreview();
                }
             };
             document.getElementById('schedule-preview-list').onclick = (e) => {
                 if(e.target.dataset.offset) {
                     recorderSchedule.offset += parseInt(e.target.dataset.offset);
                     renderSchedulePreview();
                 }
             };
        }

        function renderSchedulePreview() {
            const list = document.getElementById('schedule-rotation-list');
            list.innerHTML = recorderSchedule.rotation.map(p => `<div class="flex justify-between p-2 border-b text-sm">${p} <button class="text-red-500" onclick="removeSchedulePerson('${p}')">&times;</button></div>`).join('');
            window.removeSchedulePerson = (p) => { recorderSchedule.rotation = recorderSchedule.rotation.filter(x => x!==p); renderSchedulePreview(); };

            const allP = Object.values(config.personnelData).flat();
            document.getElementById('schedule-person-to-add').innerHTML = `<option value="">選擇人員</option>` + allP.map(p => `<option value="${p}">${p}</option>`).join('');

            const preview = document.getElementById('schedule-preview-list');
            if(!recorderSchedule.rotation.length) { preview.innerHTML = '無資料'; return; }
            
            const today = new Date();
            const currentWeek = getWeekKey(today);
            let html = '';
            for(let i=0; i<5; i++) {
                const d = new Date(today.getTime() + i*7*86400000);
                const wk = getWeekKey(d);
                const wNum = parseInt(wk.split('-')[1]) || 1;
                const total = recorderSchedule.rotation.length;
                const person = recorderSchedule.rotation[((wNum - 1 + recorderSchedule.offset) % total + total) % total];
                html += `
                    <div class="flex justify-between items-center p-2 rounded ${i===0?'bg-blue-50 border border-blue-200':''}">
                        <span class="text-sm">${wk} ${i===0?'(本週)':''}</span>
                        <span class="font-bold text-blue-700">${person}</span>
                        ${i===0 ? `<div><button class="text-xs bg-white border px-1" data-offset="-1">←</button><button class="text-xs bg-white border px-1" data-offset="1">→</button></div>` : ''}
                    </div>
                `;
            }
            preview.innerHTML = html;
        }

        function openReportModal() {
            const years = Array.from(new Set(allTasks.map(t => (t.startDate||'').split('-')[0]))).filter(Boolean).sort().reverse();
            document.getElementById('report-year-filter').innerHTML = `<option value="all">所有年份</option>` + years.map(y => `<option value="${y}">${y}</option>`).join('');
            document.getElementById('report-category-filter').innerHTML = `<option value="all">所有類別</option>` + config.projectCategories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('report-status-filter').innerHTML = `<option value="all">所有狀態</option>` + config.statusOptions.map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.getElementById('report-modal').classList.remove('hidden');
            renderReportTable();
        }

        function renderReportTable() {
             document.getElementById('report-date').innerText = `製表日期: ${new Date().toLocaleDateString()}`;
             const year = document.getElementById('report-year-filter').value;
             const filtered = allTasks.filter(t => (year==='all' || t.startDate?.startsWith(year))); // Simplified
             
             document.getElementById('report-table-body').innerHTML = filtered.map(t => `
                <tr class="border-b">
                    <td class="p-2 align-top font-bold">${t.projectName}</td>
                    <td class="p-2 align-top text-xs">${t.projectCategory}</td>
                    <td class="p-2 align-top text-xs">${t.status}</td>
                    <td class="p-2 align-top text-xs">
                        ${(t.contentItems||[]).map(i => `<div>• ${i.content} (${i.status}) - ${i.assignedPersonnel?.map(p=>p.name).join(' ')}</div>`).join('')}
                    </td>
                </tr>
             `).join('');
        }

    </script>
</body>
</html>