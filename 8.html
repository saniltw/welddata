<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTC 機器人銲接參數管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .slide-in {
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        .slide-in.active {
            transform: translateX(0);
        }
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 隱藏數字輸入框的上下箭頭 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* 表格輸入樣式 */
        #multi-pass-table input, #multi-pass-table select, #multi-pass-table textarea {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            width: 100%;
        }
        #multi-pass-table input[type=number] {
             min-width: 80px;
        }
        #multi-pass-table .compound-input-container {
            min-width: 150px;
        }
        #multi-pass-table textarea {
            min-width: 150px; /* 備註欄位較寬 */
        }
        #multi-pass-table th, #multi-pass-table td {
            white-space: nowrap;
        }
        .weave-conditional {
            transition: all 0.3s ease-in-out;
            max-width: 0;
            overflow: hidden;
            padding: 0 !important;
            border: none !important;
        }
        tr.weave-active .weave-conditional {
           max-width: 200px; /* Or a suitable max-width */
           padding: 0.25rem !important; /* Re-apply padding */
           border-left: 1px solid #e5e7eb !important; /* Re-apply border */
        }
        .image-upload-container {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .upload-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.3);
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
            border-radius: 0.5rem;
            pointer-events: none;
        }
        .image-upload-container:hover .upload-overlay {
            opacity: 1;
        }
        .remove-image-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: white;
            border-radius: 9999px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6">
        <!-- 頁首 -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                 <h1 class="text-2xl md:text-3xl font-bold text-gray-800">OTC 機器人銲接參數</h1>
                 <button onclick="checkFirebaseStatus()" title="連線狀態檢查" class="text-green-500 hover:text-green-700 text-xl"><i class="fas fa-check-circle"></i></button>
            </div>
            <button id="add-program-btn" onclick="openModal('base', null)" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-plus mr-2"></i> 新增程式
            </button>
        </header>

        <!-- 基礎參數列表 -->
        <main id="base-params-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            <!-- Loading indicator -->
            <div id="loading-indicator" class="col-span-full flex flex-col items-center justify-center p-10">
                <div class="loader"></div>
                <p class="mt-4 text-gray-600">正在連接您的 Firebase 專案...</p>
            </div>
        </main>
    </div>

    <!-- 詳細資料側邊欄 (Slide-in Panel) -->
    <div id="detail-panel" class="fixed top-0 right-0 h-full w-full md:w-3/4 lg:w-2/3 bg-gray-50 shadow-2xl z-20 p-6 overflow-y-auto slide-in">
        <div class="flex justify-between items-center mb-6">
            <h2 id="detail-title" class="text-2xl font-bold text-gray-800"></h2>
            <button onclick="closeDetailPanel()" class="text-gray-500 hover:text-gray-800">
                <i class="fas fa-times fa-2x"></i>
            </button>
        </div>
        
        <div id="base-param-details" class="mb-8"></div>

        <div id="multipass-params-section">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700">銲接條件</h3>
                <button id="add-multipass-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center">
                    <i class="fas fa-plus mr-2"></i> 編輯/新增條件
                </button>
            </div>
            <div id="multipass-params-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- 新增/編輯 Modal -->
    <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-30 flex justify-center items-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-semibold"></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <form id="data-form" class="p-6 space-y-6 overflow-y-auto flex-grow"></form>
            <div id="modal-footer" class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0"></div>
        </div>
    </div>
    
    <!-- 狀態檢查 Modal -->
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-40 flex justify-center items-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold">Firebase 連線狀態</h3>
            </div>
            <div id="status-content" class="p-6 space-y-3">
                <p>正在檢查...</p>
            </div>
            <div class="p-3 bg-gray-50 text-right">
                 <button onclick="document.getElementById('status-modal').classList.add('hidden')" class="bg-blue-500 text-white py-2 px-4 rounded-lg">關閉</button>
            </div>
        </div>
    </div>


    <script type="module">
        /*
        =======================================================================
        === !! 緊急 !! 請更新 Firebase 安全性規則                          ===
        =======================================================================
        
        這個版本新增了照片上傳功能，您需要更新兩處的安全性規則：
        1. Firestore Database (儲存文字資料)
        2. Storage (儲存照片檔案)

        --- 1. Firestore Database 規則 ---
        前往: Firebase 控制台 -> Firestore Database -> 「規則 (Rules)」分頁
        貼上:
        -----------------------------------------------------------------------
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /otcRobotBaseParams/{docId} { allow read, write: if request.auth != null; }
            match /otcRobotMultiPassParams/{docId} { allow read, write: if request.auth != null; }
            match /sharedBaseParams/{docId} { allow read, write: if request.auth != null; }
            match /sharedMultiPassParams/{docId} { allow read, write: if request.auth != null; }
          }
        }
        -----------------------------------------------------------------------

        --- 2. Storage 規則 (最終安全版本) ---
        前往: Firebase 控制台 -> Storage -> 「規則 (Rules)」分頁
        貼上:
        -----------------------------------------------------------------------
        rules_version = '2';
        service firebase.storage {
          // 直接指定您的儲存桶 ID
          match /b/welding-params-app.appspot.com/o {
            match /images/{allPaths=**} {
              allow read, write: if request.auth != null;
            }
          }
        }
        -----------------------------------------------------------------------
        貼上後，請務必點擊「發布 (Publish)」按鈕。
        =======================================================================
        */

        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, where, getDocs, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase 設定 (最終確認版本) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDPM9cbOuMttVVZQUu9w-URwF5qipgHZU",
            authDomain: "welding-params-app.firebaseapp.com",
            projectId: "welding-params-app",
            storageBucket: "welding-params-app.firebasestorage.app", // <-- 請確認此行完全正確
            messagingSenderId: "623714580072",
            appId: "1:623714580072:web:22f6a7c14942358c39eddd",
            measurementId: "G-WNCHHP4R1D"
        };
        
        let db, auth, storage;
        let baseParamsCol, multiPassParamsCol;
        let baseParamsUnsubscribe, multiPassParamsUnsubscribe;

        // --- 資料模型 ---
        let baseParams = [];
        let multiPassParams = [];

        let currentEditing = { type: null, id: null };
        let currentSelectedBaseId = null;

        const baseParamFields = {
            recordTime: { label: '記錄時間', type: 'datetime-local' },
            programName: { label: '程式名稱', type: 'text' },
            robotModel: { label: '機器人型號', type: 'text' },
            welderModel: { label: '銲機型號', type: 'text' },
            robotProcedure: { label: '機器人程序', type: 'text' },
            weldingCharacteristicData: { label: '銲接特性數據', type: 'text' },
            characteristicStorageLocation: { label: '特性儲存位置', type: 'text' },
            workpieceType: { label: '工件型式', type: 'text' },
            plateThickness: { label: '板厚 (mm)', type: 'number' },
            weldingMaterial: { label: '銲接材料', type: 'text' },
            wireDiameter: { label: '線徑 (mm)', type: 'number' },
            gas: { label: '氣體', type: 'text' },
            tipLength: { label: '使用TIP長度 (mm)', type: 'number' },
            // Photo fields
            workpiecePhoto: { label: '工件照片', type: 'file' },
            torchConditionPhoto: { label: '銲槍狀況照片', type: 'file' },
            torchPositionPhoto: { label: '銲槍位置照片', type: 'file' },
            torchAnglePhoto: { label: '銲槍角度照片', type: 'file' },
        };

        const multiPassParamFields = {
            weldPass: { label: '銲接道次', type: 'text' },
            voltage: { label: '電壓 (V)', type: 'number' },
            current: { label: '電流 (A)', type: 'number' },
            wireFeedSpeed: { label: '送線速度 (m/min)', type: 'number' },
            weldSpeed: { label: '銲接速度 (cm/min)', type: 'number' },
            tcpHeight: { label: 'TCP高度 (mm)', type: 'number' },
            torchAngle: { label: '銲槍角度 (°)', type: 'number' },
            weaveMode: { label: '擺弧模式', type: 'select', options: ['無', '有'] },
            frequency: { label: '頻率 (Hz)', type: 'number', dependsOn: 'weaveMode' },
            motionType: { label: '動作方式', type: 'select', options: ['一次函數', '三角函數', '圓弧'], dependsOn: 'weaveMode' },
            amplitude: { label: '振幅 (mm)', type: 'dual_input', subFields: { right: '右', left: '左' }, dependsOn: 'weaveMode' },
            dwellTime: { label: '停止時間 (s)', type: 'triple_input', subFields: { quarter: '1/4', center: '中央', three_quarter: '3/4' }, dependsOn: 'weaveMode' },
            tiltAngle: { label: '傾位角 (°)', type: 'dual_input', subFields: { right: '右', left: '左' }, dependsOn: 'weaveMode' },
            torchTiltAngle: { label: '銲矩傾斜角度 (°)', type: 'dual_input', subFields: { right: '右', left: '左' }, dependsOn: 'weaveMode' },
            travelAngle: { label: '前後角 (°)', type: 'dual_input', subFields: { right: '右', left: '左' }, dependsOn: 'weaveMode' },
            postWeldPhoto: { label: '銲接後照片', type: 'file' },
            notes: { label: '備註事項', type: 'textarea' }
        };
        
        // --- Firestore Realtime Listeners ---
        function setupRealtimeListeners() {
            if (baseParamsUnsubscribe) baseParamsUnsubscribe();
            if (multiPassParamsUnsubscribe) multiPassParamsUnsubscribe();
            const baseParamsPath = 'otcRobotBaseParams';
            const multiPassParamsPath = 'otcRobotMultiPassParams';
            baseParamsCol = collection(db, baseParamsPath);
            multiPassParamsCol = collection(db, multiPassParamsPath);

            baseParamsUnsubscribe = onSnapshot(baseParamsCol, (snapshot) => {
                baseParams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                renderBaseParamsList();
            }, (error) => {
                console.error("Error fetching base params:", error);
                document.getElementById('base-params-list').innerHTML = `<div class="col-span-full text-center p-10 text-red-500">從 Firebase 載入共用資料失敗: ${error.message} <br>請確認 Firestore 安全性規則已更新為最新版。</div>`;
            });

            multiPassParamsUnsubscribe = onSnapshot(multiPassParamsCol, (snapshot) => {
                multiPassParams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentSelectedBaseId) renderMultiPassList(currentSelectedBaseId);
                renderBaseParamsList();
            }, (error) => console.error("Error fetching multi-pass params:", error));
        }
        
        // --- Helper 函式 ---
        function getRecordTime(data) {
            const recordTime = data.recordTime;
            if (recordTime && recordTime.toDate) return recordTime.toDate();
            if (typeof recordTime === 'string') return new Date(recordTime);
            return new Date();
        }

        function timeout(promise, ms) {
            return new Promise((resolve, reject) => {
                const timer = setTimeout(() => {
                    reject(new Error(`操作超時 (超過 ${ms / 1000} 秒)`));
                }, ms);
                promise
                    .then(value => {
                        clearTimeout(timer);
                        resolve(value);
                    })
                    .catch(reason => {
                        clearTimeout(timer);
                        reject(reason);
                    });
            });
        }

        function resizeImage(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.85); // Compress to 85% quality JPEG
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }


        // --- 渲染函式 ---
        function renderBaseParamsList() {
            const listEl = document.getElementById('base-params-list');
            if (!listEl) return;
            const stillLoading = document.getElementById('loading-indicator')?.style.display !== 'none';
            listEl.innerHTML = '';

            if (baseParams.length === 0 && !stillLoading) {
                listEl.innerHTML = `<div class="col-span-full text-center p-10 text-gray-500">尚無程式資料，請點擊右上角新增。</div>`;
                return;
            }
            
            baseParams.sort((a, b) => getRecordTime(b) - getRecordTime(a));
            baseParams.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-md p-5 cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-all';
                card.onclick = () => showDetail(p.id);
                const displayDate = getRecordTime(p);
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 truncate">${p.programName || '未命名程式'}</h3>
                        <span class="text-xs font-semibold text-white bg-blue-400 px-2 py-1 rounded-full shrink-0">${multiPassParams.filter(mp => mp.baseId == p.id).length} 筆</span>
                    </div>
                    <p class="text-sm text-gray-500 mb-1">工件: ${p.workpieceType || 'N/A'}</p>
                    <p class="text-sm text-gray-500">日期: ${displayDate.toLocaleDateString()}</p>
                `;
                listEl.appendChild(card);
            });
        }

        function renderDetailView(baseId) {
            currentSelectedBaseId = baseId;
            const base = baseParams.find(p => p.id == baseId);
            if (!base) { closeDetailPanel(); return; }

            document.getElementById('detail-title').textContent = base.programName || "程式詳情";
            const detailsEl = document.getElementById('base-param-details');
            
            const renderTextField = (key) => {
                const field = baseParamFields[key];
                if (!field || field.type === 'file') return '';
                let displayValue = base[key] || 'N/A';
                if (key === 'recordTime') displayValue = getRecordTime(base).toLocaleString('zh-TW', { hour12: false });
                return `<div><p class="text-gray-500 text-sm">${field.label}</p><p class="font-medium text-gray-800">${displayValue}</p></div>`;
            };

            const renderPhotoField = (key) => {
                const field = baseParamFields[key];
                const url = base[key];
                if (!field || field.type !== 'file') return '';
                const imageHtml = url 
                    ? `<a href="${url}" target="_blank"><img src="${url}" class="w-full h-32 object-cover rounded-md shadow-sm"></a>` 
                    : `<div class="w-full h-32 bg-gray-200 rounded-md flex items-center justify-center text-gray-400 text-sm">無照片</div>`;
                return `<div><p class="text-gray-500 text-sm mb-1">${field.label}</p>${imageHtml}</div>`;
            };

            detailsEl.innerHTML = `
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-700">基礎設定</h4>
                        <div class="flex items-center space-x-3">
                            <button onclick="exportReport('${base.id}')" class="text-teal-500 hover:text-teal-700"><i class="fas fa-print mr-1"></i> 匯出報表</button>
                            <button onclick="openModal('base', '${base.id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i> 編輯</button>
                            <button onclick="deleteRecord('base', '${base.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i> 刪除</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4">${Object.keys(baseParamFields).filter(k => baseParamFields[k].type !== 'file').slice(0, 4).map(renderTextField).join('')}</div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">${Object.keys(baseParamFields).filter(k => baseParamFields[k].type !== 'file').slice(4, 7).map(renderTextField).join('')}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">${Object.keys(baseParamFields).filter(k => baseParamFields[k].type !== 'file').slice(7, 9).map(renderTextField).join('')}</div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4">${Object.keys(baseParamFields).filter(k => baseParamFields[k].type !== 'file').slice(9, 13).map(renderTextField).join('')}</div>
                    </div>
                    <div class="border-t my-6"></div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-4">相關照片</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${Object.keys(baseParamFields).filter(k => baseParamFields[k].type === 'file').map(renderPhotoField).join('')}
                    </div>
                </div>
            `;
            document.getElementById('add-multipass-btn').onclick = () => openModal('multi', null);
            renderMultiPassList(baseId);
        }

        function renderMultiPassList(baseId) {
            const multiPassListEl = document.getElementById('multipass-params-list');
            const relatedParams = multiPassParams.filter(p => p.baseId == baseId).sort((a,b) => (a.weldPass || "").localeCompare(b.weldPass || ""));
            multiPassListEl.innerHTML = '';

            if (relatedParams.length === 0) {
                multiPassListEl.innerHTML = `<p class="text-center text-gray-500 py-4">尚無銲接條件，點擊上方按鈕新增。</p>`;
                return;
            }

            relatedParams.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg p-4 shadow-sm';
                
                let mainFieldsHtml = Object.keys(multiPassParamFields)
                    .filter(k => !multiPassParamFields[k].dependsOn && multiPassParamFields[k].type !== 'file' && k !== 'notes')
                    .map(key => `<div><p class="text-gray-500 text-xs">${multiPassParamFields[key].label.replace(/ \(.+?\)/g, '')}</p><p class="font-medium text-gray-800 text-sm">${p[key] ?? 'N/A'}</p></div>`)
                    .join('');

                let weaveFieldsHtml = '';
                if (p.weaveMode === '有') {
                    weaveFieldsHtml = `<div class="mt-3 pt-3 border-t border-gray-200">
                             <p class="font-semibold text-gray-700 text-sm mb-2">擺弧參數</p>
                             <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-3">
                                ${Object.keys(multiPassParamFields).filter(key => multiPassParamFields[key].dependsOn === 'weaveMode').map(key => {
                                    const field = multiPassParamFields[key];
                                    const fieldData = p[key];
                                    let displayValue;
                                    if ((field.type === 'dual_input' || field.type === 'triple_input') && fieldData) {
                                        displayValue = Object.keys(field.subFields).map(subKey => `${field.subFields[subKey]}: ${fieldData[subKey] ?? '-'}`).join(' / ');
                                    } else {
                                        displayValue = fieldData ?? 'N/A';
                                    }
                                    return `<div><p class="text-gray-500 text-xs">${field.label.replace(/ \(.+?\)/g, '')}</p><p class="font-medium text-gray-800 text-sm">${displayValue}</p></div>`;
                                }).join('')}
                             </div>
                        </div>`;
                }
                
                const postWeldPhotoHtml = p.postWeldPhoto
                    ? `<div class="mt-3 pt-3 border-t"><p class="font-semibold text-gray-700 text-sm my-2">銲接後照片</p><a href="${p.postWeldPhoto}" target="_blank"><img src="${p.postWeldPhoto}" class="w-32 h-32 object-cover rounded-md shadow-sm"></a></div>`
                    : '';
                const notesHtml = p.notes ? `<div class="mt-3 pt-3 border-t border-gray-200"><p class="text-xs text-gray-600"><strong>備註:</strong> ${p.notes}</p></div>` : '';

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <p class="font-bold text-gray-800">道次: ${p.weldPass || 'N/A'}</p>
                        <div><button onclick="openModal('multi', null)" class="text-blue-500 hover:text-blue-700 mr-3"><i class="fas fa-edit fa-sm"></i> 編輯</button></div>
                    </div>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 gap-x-4 gap-y-3">${mainFieldsHtml}</div>
                    ${weaveFieldsHtml}
                    ${postWeldPhotoHtml}
                    ${notesHtml}
                `;
                multiPassListEl.appendChild(card);
            });
        }
        
        // --- 互動函式 ---
        function showDetail(baseId) {
            renderDetailView(baseId);
            document.getElementById('detail-panel').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDetailPanel() {
            document.getElementById('detail-panel').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentSelectedBaseId = null;
        }

        function openModal(type, id) {
            currentEditing = { type, id };
            const modal = document.getElementById('form-modal');
            const form = document.getElementById('data-form');
            const modalTitle = document.getElementById('modal-title');
            form.innerHTML = '';

            if (type === 'base') {
                modalTitle.textContent = id ? '編輯基礎設定' : '新增基礎設定';
                const data = id ? baseParams.find(p => p.id == id) : {};
                buildBaseForm(form, data);
            } else { // multi
                modalTitle.textContent = '編輯/新增 銲接條件';
                buildMultiPassTableForm(form);
            }
            
            const modalFooter = document.getElementById('modal-footer');
            modalFooter.innerHTML = `
                <button type="button" onclick="closeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">取消</button>
                <button id="save-btn" type="submit" form="data-form" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">全部儲存</button>
            `;
            modal.classList.remove('hidden');
        }

        function createFieldHtml(key, field, data) {
            let value = data[key] || '';
            const commonClasses = "block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm";

            if (key === 'recordTime') {
                const dateObj = data.id && value ? getRecordTime({recordTime: value}) : new Date();
                value = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            }

            let inputElement;
            if (field.type === 'textarea') {
                inputElement = `<textarea id="${key}" name="${key}" rows="3" class="${commonClasses}">${value}</textarea>`;
            } else {
                const stepAttribute = field.type === 'number' ? ' step="any"' : '';
                inputElement = `<input type="${field.type}" id="${key}" name="${key}" value="${value}" class="${commonClasses}"${stepAttribute}>`;
            }

            return `<div><label for="${key}" class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>${inputElement}</div>`;
        }
        
        function createImageUploadField(key, field, data) {
            const url = data[key] || '';
            const placeholder = 'https://placehold.co/100x100/e2e8f0/9ca3af?text=+';
            return `
                <div class="flex flex-col items-center">
                    <label class="block text-sm font-medium text-gray-700 mb-2">${field.label}</label>
                    <div class="image-upload-container">
                        <img id="preview_${key}" src="${url || placeholder}" class="image-preview" onclick="this.nextElementSibling.click()">
                        <input id="${key}" name="${key}" type="file" class="hidden" accept="image/*" capture="environment" onchange="previewImage(event, 'preview_${key}', this)">
                        <div class="upload-overlay"><i class="fas fa-camera fa-lg"></i></div>
                        <span onclick="removeImage('${key}')" class="remove-image-btn text-red-500 hover:text-red-700 p-1 ${!url ? 'hidden' : ''}"><i class="fas fa-times-circle"></i></span>
                        <input type="hidden" id="hidden_${key}" name="hidden_${key}" value="${url}">
                    </div>
                </div>`;
        }
        
        function buildBaseForm(form, data) {
            const textFields = Object.keys(baseParamFields).filter(k => baseParamFields[k].type !== 'file');
            const photoFields = Object.keys(baseParamFields).filter(k => baseParamFields[k].type === 'file');

            form.innerHTML = `
                <div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">${textFields.slice(0, 4).map(k => createFieldHtml(k, baseParamFields[k], data)).join('')}</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">${textFields.slice(4, 7).map(k => createFieldHtml(k, baseParamFields[k], data)).join('')}</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">${textFields.slice(7, 9).map(k => createFieldHtml(k, baseParamFields[k], data)).join('')}</div>
                    <div class="border-t border-gray-200 my-4"></div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">${textFields.slice(9, 13).map(k => createFieldHtml(k, baseParamFields[k], data)).join('')}</div>
                </div>
                <div class="border-t border-gray-200 my-6"></div>
                <div>
                    <h4 class="text-lg font-medium text-gray-800 mb-4 text-center">相關照片</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 justify-items-center">
                        ${photoFields.map(k => createImageUploadField(k, baseParamFields[k], data)).join('')}
                    </div>
                </div>
            `;
        }
        
        function toggleWeaveFields(selectElement) {
            const row = selectElement.closest('tr');
            const show = selectElement.value === '有';
            row.classList.toggle('weave-active', show);
        }

        function buildMultiPassTableForm(form) {
            const relatedParams = multiPassParams
                .filter(p => p.baseId == currentSelectedBaseId)
                .sort((a, b) => (a.weldPass || "").localeCompare(b.weldPass || ""));

            const headers = Object.values(multiPassParamFields).map(f => f.label);
            
            form.innerHTML = `
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table id="multi-pass-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                ${headers.map(h => `<th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10">${h}</th>`).join('')}
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div class="mt-4">
                    <button type="button" onclick="addPassRowToTable(null)" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center">
                        <i class="fas fa-plus mr-2"></i> 新增條件
                    </button>
                </div>
            `;
            
            if (relatedParams.length > 0) {
                relatedParams.forEach(p => addPassRowToTable(p, false));
            } else {
                addPassRowToTable(null, false);
            }
        }

        function addPassRowToTable(data, shouldAnimate = true) {
            const tableBody = document.getElementById('multi-pass-table')?.querySelector('tbody');
            if (!tableBody) return;

            const newRow = tableBody.insertRow();
            if (data && data.id) newRow.dataset.docId = data.id;
            if (data?.weaveMode === '有') newRow.classList.add('weave-active');
            
            let rowHtml = '';
            for (const key in multiPassParamFields) {
                const field = multiPassParamFields[key];
                const value = data?.[key] ?? '';
                const isConditional = field.dependsOn === 'weaveMode';
                
                let cellHtml;
                switch (field.type) {
                    case 'select':
                        cellHtml = `<select name="${key}" class="border-gray-300 rounded-md" ${key === 'weaveMode' ? 'onchange="toggleWeaveFields(this)"' : ''}>
                                ${field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>`;
                        break;
                    case 'textarea':
                        cellHtml = `<textarea name="${key}" class="border-gray-300 rounded-md" rows="1">${value}</textarea>`;
                        break;
                    case 'dual_input':
                    case 'triple_input':
                         cellHtml = `<div class="space-y-1 compound-input-container">
                            ${Object.keys(field.subFields).map(subKey => `
                                <div class="flex items-center">
                                    <label class="text-xs mr-1 w-10 text-right shrink-0">${field.subFields[subKey]}:</label>
                                    <input type="number" step="any" name="${key}_${subKey}" value="${value?.[subKey] ?? ''}" class="border-gray-300 rounded-md w-full">
                                </div>
                            `).join('')}
                        </div>`;
                        break;
                    case 'file':
                        const url = data?.[key] ?? '';
                        const uniqueId = `${key}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        cellHtml = `
                            <div class="image-upload-container !w-20 !h-20">
                                <img id="preview_${uniqueId}" src="${url || 'https://placehold.co/80x80/e2e8f0/9ca3af?text=+'}" class="image-preview !border-dashed" onclick="this.nextElementSibling.click()">
                                <input name="${key}" type="file" class="hidden" accept="image/*" capture="environment" onchange="previewImage(event, 'preview_${uniqueId}', this)">
                                <input type="hidden" name="hidden_${key}" value="${url}">
                            </div>`;
                        break;
                    default: // text, number
                        cellHtml = `<input type="${field.type}" name="${key}" value="${value}" class="border-gray-300 rounded-md" ${field.type === 'number' ? 'step="any"' : ''}>`;
                        break;
                }
                
                rowHtml += `<td class="p-1 ${isConditional ? 'weave-conditional' : ''}">${cellHtml}</td>`;
            }

            rowHtml += `
                <td class="p-2 whitespace-nowrap">
                    <button type="button" onclick="duplicateRow(this.closest('tr'))" class="text-green-600 hover:text-green-900" title="複製此條件"><i class="fas fa-copy"></i></button>
                    <button type="button" onclick="removePassRow(this.closest('tr'))" class="text-red-600 hover:text-red-900 ml-2" title="刪除此條件"><i class="fas fa-trash"></i></button>
                </td>`;
            newRow.innerHTML = rowHtml;

            if (shouldAnimate) {
                newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                newRow.style.backgroundColor = '#d1fae5';
                setTimeout(() => { newRow.style.backgroundColor = ''; }, 1500);
            }
        }

        function removePassRow(rowElement) {
            if (rowElement.dataset.docId) {
                rowElement.dataset.deleted = "true";
                rowElement.style.textDecoration = 'line-through';
                rowElement.style.opacity = '0.5';
                rowElement.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
            } else {
                rowElement.remove();
            }
        }

        function duplicateRow(rowElement) {
            const data = {};
            for (const key in multiPassParamFields) {
                const field = multiPassParamFields[key];
                 if (field.type === 'dual_input' || field.type === 'triple_input') {
                    data[key] = {};
                    Object.keys(field.subFields).forEach(subKey => {
                        const input = rowElement.querySelector(`[name="${key}_${subKey}"]`);
                        if(input) data[key][subKey] = input.value;
                    });
                } else if (field.type === 'file') {
                    const hiddenInput = rowElement.querySelector(`input[name="hidden_${key}"]`);
                    if (hiddenInput) data[key] = hiddenInput.value;
                }
                else {
                    const input = rowElement.querySelector(`[name="${key}"]`);
                    if(input) data[key] = input.value;
                }
            }
            delete data.id;
            addPassRowToTable(data);
        }
        
        function closeModal() {
            const modal = document.getElementById('form-modal');
            if (modal) modal.classList.add('hidden');
            currentEditing = { type: null, id: null };
        }

        async function previewImage(event, previewId, inputElement) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById(previewId);
            const placeholderUrl = `https://placehold.co/100x100/e2e8f0/9ca3af?text=壓縮中...`;

            if (preview) {
                preview.src = placeholderUrl;
            }

            try {
                const resizedBlob = await resizeImage(file, 800, 600);
                inputElement.resizedFileBlob = resizedBlob;
                const objectURL = URL.createObjectURL(resizedBlob);
                if (preview) preview.src = objectURL;

                const parentContainer = (inputElement || document.getElementById(previewId)).closest('.image-upload-container');
                const removeBtn = parentContainer.querySelector('.remove-image-btn');
                if (removeBtn) removeBtn.classList.remove('hidden');
            } catch (error) {
                console.error("圖片壓縮失敗，請嘗試另一張圖片。", error);
                if (preview) preview.src = 'https://placehold.co/100x100/fecaca/991b1b?text=壓縮失敗';
            }
        }

        function removeImage(key) {
            const preview = document.getElementById(`preview_${key}`);
            preview.src = 'https://placehold.co/100x100/e2e8f0/9ca3af?text=+';
            const hiddenInput = document.getElementById(`hidden_${key}`);
            hiddenInput.value = '';
            const fileInput = document.getElementById(key);
            if(fileInput) {
                fileInput.value = '';
                delete fileInput.resizedFileBlob;
            }
            preview.parentElement.querySelector('.remove-image-btn').classList.add('hidden');
        }

        function uploadFile(fileOrBlob, originalFileName) {
            return new Promise((resolve, reject) => {
                if (!fileOrBlob) { resolve(null); return; }
                const fileName = originalFileName || fileOrBlob.name || 'image.jpg';
                const storageRef = ref(storage, `images/${Date.now()}_${fileName}`);
                const uploadTask = uploadBytesResumable(storageRef, fileOrBlob);
                uploadTask.on('state_changed', 
                    (snapshot) => { /* Can show progress here */ }, 
                    (error) => reject(error), 
                    () => getDownloadURL(uploadTask.snapshot.ref).then(resolve)
                );
            });
        }

        async function saveData() {
            const form = document.getElementById('data-form');
            const { type } = currentEditing;

            const saveBtn = document.getElementById('save-btn');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 儲存中...`;
            saveBtn.disabled = true;

            try {
                if (type === 'base') {
                    const formData = new FormData(form);
                    let data = {};
                    for (let [key, value] of formData.entries()) {
                         if (key.startsWith('hidden_')) continue;
                         data[key] = baseParamFields[key]?.type === 'number' && value !== '' ? parseFloat(value) : value;
                    }
                    if (data.recordTime) data.recordTime = new Date(data.recordTime);

                    const photoFields = Object.keys(baseParamFields).filter(k => baseParamFields[k].type === 'file');
                    for (const key of photoFields) {
                        const fileInput = form.querySelector(`input[name="${key}"]`);
                        const hiddenInput = form.querySelector(`input[name="hidden_${key}"]`);
                        const newFile = fileInput.files[0];
                        const resizedBlob = fileInput.resizedFileBlob;
                        const oldUrl = hiddenInput.value;

                        if (resizedBlob) {
                            data[key] = await uploadFile(resizedBlob, newFile.name);
                            if (oldUrl && oldUrl !== data[key]) {
                                try { await deleteObject(ref(storage, oldUrl)); } catch (e) { console.warn("Could not delete old file:", oldUrl, e); }
                            }
                        } else {
                            data[key] = oldUrl;
                        }
                        delete fileInput.resizedFileBlob;
                    }

                    if (currentEditing.id) {
                        await setDoc(doc(baseParamsCol, currentEditing.id), data, { merge: true });
                    } else {
                        await addDoc(baseParamsCol, data);
                    }
                } else if (type === 'multi') {
                    const batch = writeBatch(db);
                    const tableBody = document.getElementById('multi-pass-table')?.querySelector('tbody');
                    if (!tableBody) throw new Error("Table not found");

                    const rows = Array.from(tableBody.rows);
                    for (const row of rows) {
                        const docId = row.dataset.docId;
                        const isDeleted = row.dataset.deleted === "true";

                        if (docId && isDeleted) {
                            const oldRecord = multiPassParams.find(p => p.id === docId);
                            if (oldRecord?.postWeldPhoto) {
                                try { await deleteObject(ref(storage, oldRecord.postWeldPhoto)); } catch(e) { console.warn("Could not delete photo for row:", e); }
                            }
                            batch.delete(doc(multiPassParamsCol, docId));
                            continue;
                        }
                        if (isDeleted) continue;

                        const data = { baseId: currentSelectedBaseId };
                        let hasData = false;
                        for (const key in multiPassParamFields) {
                             const field = multiPassParamFields[key];
                             if (field.type === 'dual_input' || field.type === 'triple_input') {
                                data[key] = {};
                                Object.keys(field.subFields).forEach(subKey => {
                                    const input = row.querySelector(`[name="${key}_${subKey}"]`);
                                    if (input && input.value !== '') {
                                        const numValue = parseFloat(input.value);
                                        data[key][subKey] = isNaN(numValue) ? null : numValue;
                                        if(!isNaN(numValue)) hasData = true;
                                    } else {
                                        data[key][subKey] = null;
                                    }
                                });
                             } else if (field.type === 'file') {
                                // Defer file processing
                             } else {
                                const input = row.querySelector(`[name="${key}"]`);
                                if (input) {
                                    const value = input.value;
                                    if (value !== '' && value !== null) {
                                        data[key] = field.type === 'number' ? parseFloat(value) || null : value;
                                        if(data[key] !== null) hasData = true;
                                    } else {
                                        data[key] = null;
                                    }
                                }
                             }
                        }

                        // Handle file for the row
                        const fileInput = row.querySelector(`input[name="postWeldPhoto"]`);
                        const hiddenInput = row.querySelector(`input[name="hidden_postWeldPhoto"]`);
                        const newFile = fileInput?.files[0];
                        const resizedBlob = fileInput?.resizedFileBlob;
                        const oldUrl = hiddenInput?.value;
                        if (resizedBlob) {
                            data.postWeldPhoto = await uploadFile(resizedBlob, newFile.name);
                            if (oldUrl && oldUrl !== data.postWeldPhoto) {
                                try { await deleteObject(ref(storage, oldUrl)); } catch(e) { console.warn("Could not delete old multi-pass file:", e); }
                            }
                        } else {
                            data.postWeldPhoto = oldUrl || null;
                        }
                        if (data.postWeldPhoto) hasData = true;
                        if(fileInput) delete fileInput.resizedFileBlob;

                        if (data['weldPass'] || hasData) {
                            if (docId) {
                                batch.set(doc(multiPassParamsCol, docId), data, { merge: true });
                            } else {
                                batch.set(doc(multiPassParamsCol), data);
                            }
                        }
                    }
                    await batch.commit();
                }
                closeModal();
            } catch (error) {
                console.error(`儲存失敗: ${error.message}`, error);
            } finally {
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
            }
        }
        
        function handleFormSubmit(event) {
            event.preventDefault();
            saveData();
        }

        async function deleteRecord(type, id) {
            // 移除了 confirm() 以避免在 iframe 中阻擋腳本執行。
            // 在正式產品中，建議使用自訂的 modal 元件來做確認對話框。
            console.log(`Attempting to delete ${type} with id: ${id}`);
            
            try {
                if (type === 'base') {
                    const baseDoc = baseParams.find(p => p.id === id);
                    if(!baseDoc) return;
                    
                    const batch = writeBatch(db);
                    batch.delete(doc(baseParamsCol, id));
                    
                    Object.keys(baseParamFields).filter(k => baseParamFields[k].type === 'file').forEach(key => {
                        if (baseDoc[key]) try { deleteObject(ref(storage, baseDoc[key])); } catch(e) { console.warn(e); }
                    });

                    const q = query(multiPassParamsCol, where("baseId", "==", id));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.postWeldPhoto) try { deleteObject(ref(storage, data.postWeldPhoto)); } catch(e) { console.warn(e); }
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    closeDetailPanel();
                }
            } catch (error) {
                console.error("刪除失敗，請檢查主控台錯誤訊息。", error);
            }
        }
        
        function exportReport(baseId) {
             const base = baseParams.find(p => p.id == baseId);
            const relatedMultiPass = multiPassParams
                .filter(p => p.baseId == baseId)
                .sort((a, b) => (a.weldPass || "").localeCompare(b.weldPass || ""));

            if (!base) return;

            const reportWindow = window.open('', '_blank');
            let reportHtml = `
                <!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>OTC 機器人銲接參數報表 - ${base.programName}</title>
                <style>
                    body { font-family: 'Segoe UI', 'Microsoft JhengHei', 'PingFang TC', sans-serif; margin: 20px; font-size: 12px; }
                    h1, h2, h3 { border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 15px; }
                    .section { margin-bottom: 25px; page-break-inside: avoid; } 
                    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
                    .grid-item strong { display: block; color: #555; font-size: 11px; margin-bottom: 2px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10px; }
                    th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; vertical-align: top; }
                    th { background-color: #f2f2f2; font-weight: bold; }
                    img { max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 4px; }
                    @media print { body { margin: 1cm; font-size: 9pt; } thead { display: table-header-group; } .no-print { display: none; } }
                </style></head><body><h1>OTC 機器人銲接參數報表</h1>`;
            
            reportHtml += `<div class="section"><h2>基礎設定</h2><div class="grid-container">`;
            Object.keys(baseParamFields).filter(k => baseParamFields[k].type !== 'file').forEach(key => {
                const field = baseParamFields[key];
                let value = base[key] || 'N/A';
                if (key === 'recordTime') value = getRecordTime(base).toLocaleString('zh-TW', { hour12: false });
                reportHtml += `<div class="grid-item"><strong>${field.label}:</strong> ${value}</div>`;
            });
            reportHtml += `</div></div>`;

            reportHtml += `<div class="section"><h3>相關照片</h3><div class="grid-container">`;
             Object.keys(baseParamFields).filter(k => baseParamFields[k].type === 'file').forEach(key => {
                reportHtml += `<div class="grid-item"><strong>${baseParamFields[key].label}:</strong><br>${base[key] ? `<img src="${base[key]}">` : '無'}</div>`;
            });
            reportHtml += `</div></div>`;

            reportHtml += `<div class="section"><h2>銲接條件</h2>`;
            if (relatedMultiPass.length > 0) {
                reportHtml += `<table><thead><tr>`;
                Object.keys(multiPassParamFields).forEach(key => { reportHtml += `<th>${multiPassParamFields[key].label}</th>`; });
                reportHtml += `</tr></thead><tbody>`;
                relatedMultiPass.forEach(p => {
                    reportHtml += `<tr>`;
                    Object.keys(multiPassParamFields).forEach(key => { 
                        const field = multiPassParamFields[key];
                        let value = p[key] ?? '';
                        if (field.dependsOn === 'weaveMode' && p.weaveMode !== '有') value = '---';
                        else if ((field.type === 'dual_input' || field.type === 'triple_input') && value) value = Object.keys(field.subFields).map(subKey => `${field.subFields[subKey]}: ${value[subKey] ?? '-'}`).join('<br>');
                        else if (field.type === 'file') value = value ? `<img src="${value}">` : '無';
                        reportHtml += `<td>${value}</td>`; 
                    });
                    reportHtml += `</tr>`;
                });
                reportHtml += `</tbody></table>`;
            } else {
                reportHtml += `<p>無銲接條件資料。</p>`;
            }
            reportHtml += `</div><div class="no-print" style="text-align:center; margin-top: 20px;"><button onclick="window.print()">列印</button></div></body></html>`;
            
            reportWindow.document.write(reportHtml);
            reportWindow.document.close();
        }

        async function checkFirebaseStatus() {
            const modal = document.getElementById('status-modal');
            const content = document.getElementById('status-content');
            modal.classList.remove('hidden');
            
            const updateStatus = (message) => {
                content.innerHTML += `<div>${message}</div>`;
            };
            content.innerHTML = ''; // Clear previous results

            // 1. Auth Check
            updateStatus('<div class="flex items-center"><div class="loader !w-5 !h-5 !border-2 mr-2"></div>正在檢查認證狀態...</div>');
            const user = auth.currentUser;
            if (user) {
                let userType = user.isAnonymous ? '匿名' : '已登入';
                updateStatus(`<div class="flex items-center"><i class="fas fa-user-check text-green-500 mr-2"></i> 認證狀態: 成功 (${userType})</div>`);
            } else {
                updateStatus(`<div class="flex items-center"><i class="fas fa-user-times text-red-500 mr-2"></i> 認證狀態: 失敗。無法獲取使用者。</div>`);
                return; // Stop here if auth fails
            }

            // 2. Firestore Check
            updateStatus('<div class="flex items-center"><div class="loader !w-5 !h-5 !border-2 mr-2"></div>正在測試 Firestore 連線...</div>');
            try {
                // FIX: Changed "___test_read___" to "_internal_test_read_" to avoid reserved name error.
                const docRef = doc(db, "otcRobotBaseParams", "_internal_test_read_");
                await timeout(getDoc(docRef), 5000); // 5 second timeout
                updateStatus(`<div class="flex items-center"><i class="fas fa-database text-green-500 mr-2"></i> Firestore 讀取: 成功</div>`);
            } catch (error) {
                let errorMessage = error.message;
                if (error.code === 'permission-denied') {
                    errorMessage = "權限不足。請檢查您的 Firestore 安全性規則。";
                } else if (errorMessage.includes('超時')) {
                    errorMessage = "連線超時。最常見的原因是您尚未在 Firebase 控制台中「建立」Firestore 資料庫。";
                }
                updateStatus(`<div class="flex items-center"><i class="fas fa-database text-red-500 mr-2"></i> Firestore 讀取: 失敗 - ${errorMessage}</div>`);
            }

            // 3. Storage Write Test
            updateStatus('<div class="flex items-center"><div class="loader !w-5 !h-5 !border-2 mr-2"></div>正在測試 Storage 連線...</div>');
            try {
                const testRef = ref(storage, `test/write_test_${Date.now()}.txt`);
                const testBlob = new Blob(['test'], { type: 'text/plain' });
                await timeout(uploadBytes(testRef, testBlob), 8000); // 8 second timeout for upload
                await timeout(deleteObject(testRef), 5000); // And for delete
                updateStatus(`<div class="flex items-center font-bold"><i class="fas fa-cloud-upload-alt text-green-500 mr-2"></i> Storage 寫入測試: <span class="text-green-600 ml-1">成功</span></div>`);
            } catch (error) {
                let errorMessage = error.message;
                if (error.code === 'storage/unauthorized') {
                     errorMessage = "權限不足。請檢查您的 Storage 安全性規則。";
                } else if (errorMessage.includes('超時')) {
                    errorMessage = "連線超時。請檢查您的網路連線或 Firebase Storage 是否已啟用。";
                }
                updateStatus(`<div class="flex items-center font-bold"><i class="fas fa-cloud-upload-alt text-red-500 mr-2"></i> Storage 寫入測試: <span class="text-red-600 ml-1">失敗</span> - ${errorMessage}</div>`);
            }
            
            // Replace loaders with checkmarks
            content.innerHTML = content.innerHTML.replace(/<div class="loader.*?<\/div>/g, '<i class="fas fa-check text-gray-400 mr-2"></i>');
        }

        // --- 初始化 ---
        async function initializeAppWithAuth() {
            try {
                console.log("Forcing initialization with hardcoded project config:", firebaseConfig.projectId);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("✅ Auth state changed: User is signed in. UID:", user.uid);
                        // 認證成功，啟用主要操作按鈕
                        document.getElementById('add-program-btn').disabled = false;
                        setupRealtimeListeners();
                    } else {
                        console.log("Auth state changed: User is signed out.");
                        // 尚未認證或已登出，禁用按鈕
                        document.getElementById('add-program-btn').disabled = true;
                        if(baseParamsUnsubscribe) baseParamsUnsubscribe();
                        if(multiPassParamsUnsubscribe) multiPassParamsUnsubscribe();
                        baseParams = [];
                        multiPassParams = [];
                        renderBaseParamsList();
                    }
                });
                
                if (!auth.currentUser) {
                    console.log("No current user, signing in anonymously...");
                    await signInAnonymously(auth);
                } else {
                    console.log("User already signed in from previous session.");
                    setupRealtimeListeners();
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const loadingEl = document.getElementById('loading-indicator');
                if(loadingEl) loadingEl.innerHTML = `<p class="col-span-full text-center p-10 text-red-500">Firebase 初始化失敗: ${error.message}</p>`;
            }
        }
        
        // Expose functions to global scope for HTML onclick handlers
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.showDetail = showDetail;
        window.closeDetailPanel = closeDetailPanel;
        window.deleteRecord = deleteRecord;
        window.exportReport = exportReport;
        window.addPassRowToTable = addPassRowToTable;
        window.removePassRow = removePassRow;
        window.duplicateRow = duplicateRow;
        window.toggleWeaveFields = toggleWeaveFields;
        window.previewImage = previewImage;
        window.removeImage = removeImage;
        window.checkFirebaseStatus = checkFirebaseStatus;
        
        document.getElementById('data-form').addEventListener('submit', handleFormSubmit);

        // Start the app
        initializeAppWithAuth();
    </script>
</body>
</html>