<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銲接資料管理系統 (已連結 Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2;
            --primary-hover: #357ABD;
            --secondary-color: #F5F7FA;
            --text-dark: #333;
            --text-light: #777;
            --border-color: #EAEAEA;
            --card-bg: #FFFFFF;
            --shadow-color: rgba(74, 144, 226, 0.15);
            --danger-color: #EF4444;
            --danger-hover: #DC2626;
        }

        body {
            font-family: 'Noto Sans TC', 'Inter', '微軟正黑體', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-dark);
        }

        /* 自訂滾動條樣式 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .main-card { background-color: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid var(--border-color); }
        .tab-button { padding: 12px 18px; font-weight: 500; color: var(--text-light); border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-button.active { border-color: var(--primary-color); color: var(--primary-color); }
        .btn { padding: 10px 24px; border-radius: 8px; font-weight: 700; text-align: center; transition: all 0.2s ease-in-out; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:disabled { background-color: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #e2e8f0; color: #475569; }
        .btn-secondary:hover:not(:disabled) { background-color: #cbd5e1; }
        .btn-green { background-color: #10B981; color: white; }
        .btn-green:hover:not(:disabled) { background-color: #059669; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        .action-link { font-weight: 500; text-decoration: underline; text-underline-offset: 2px; cursor: pointer; transition: color 0.2s; }
        .edit-btn { color: var(--primary-color); }
        .edit-btn:hover { color: var(--primary-hover); }
        .delete-btn { color: var(--danger-color); }
        .delete-btn:hover { color: var(--danger-hover); }
        .settings-main-btn { background-color: var(--card-bg); color: var(--text-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-weight: 500; transition: all 0.2s ease; }
        .settings-main-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-color); border-color: var(--primary-color); color: var(--primary-color); }
        .settings-main-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 8px var(--shadow-color); }
        #dataTable th, #settingsContentDisplay th { position: sticky; top: 0; background-color: #F9FAFB; z-index: 10; }
        .modal-content-xs { max-width: 24rem; }
        .modal-content-sm { max-width: 32rem; }
        .modal-content-md { max-width: 42rem; }
        .modal-content-2xl { max-width: 48rem; }
        .modal-content-7xl { max-width: 80rem; }
        .validation-tooltip { position: absolute; bottom: 0.1rem; left: 0; font-size: 0.7rem; color: #dc2626; white-space: nowrap; }
        .input-container { position: relative; padding-bottom: 1.5rem; }
        input.invalid-field { border-color: #EF4444; box-shadow: 0 0 0 1px #EF4444; }

        /* 讀取中與提示訊息樣式 */
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .spinner { width: 56px; height: 56px; border: 7px solid var(--primary-color); border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); margin-bottom: 10px; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
        
        /* 排序樣式 */
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #F0F2F5; }
        .sort-indicator { display: inline-block; width: 1em; text-align: right; color: var(--primary-color); font-size: 0.9em; vertical-align: middle; }

        /* 拖曳排序樣式 */
        .drag-handle { cursor: move; cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.4; background-color: #dbeafe; }

        /* 固定欄位樣式 */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 1;
            background-color: #FFFFFF;
        }
        #dataTable tbody tr:hover, #settingsContentDisplay tbody tr:hover {
            background-color: #dbeafe; /* Tailwind blue-100 for a noticeable hover */
        }
        #dataTable tbody tr:hover .sticky-col {
            background-color: #dbeafe; /* Match the row hover color */
        }
        #dataTable thead .sticky-col {
            z-index: 11; /* 必須比 th 的 z-index 高 */
            background-color: #F9FAFB; /* Corresponds to bg-gray-50 */
        }
        .sticky-col-divider {
            border-right: 2px solid #e2e8f0;
        }

        /* 數據看板樣式 */
        .stat-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .stat-card .stat-title {
            font-size: 0.875rem;
            color: var(--text-light);
            font-weight: 500;
        }
        .stat-card .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-top: 0.5rem;
        }
        .stat-card .stat-value .sub {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
        }

        /* 報表樣式 */
        .report-page {
            background: white;
            padding: 2rem;
            margin: 1rem auto;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px; /* A4-like width */
        }
        .stats-tab-button.active { 
            border-color: var(--primary-color); 
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner"></div>
            <p class="mt-4 text-lg font-semibold text-gray-700">正在連接 Firebase...</p>
        </div>
    </div>

    
    <div id="toast-container"></div>

    
    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800">銲接資料管理系統</h1>
            <p class="text-gray-500 mt-2 text-lg">WeldData Management System (Firebase)</p>
        </header>

        <div class="mb-6 flex justify-center">
            <nav class="bg-white rounded-xl shadow-sm p-1 inline-flex" aria-label="Tabs">
                <button id="main-tab" class="tab-button active">資料查詢</button>
                <button id="stats-report-tab" class="tab-button">統計報表</button>
                <button id="settings-tab" class="tab-button">系統設定</button>
            </nav>
        </div>
        
        <main>
            <div id="main-page">
                
                <div id="dashboard-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="stat-card">
                        <div class="stat-title">未完成 / 總組數</div>
                        <div id="stat-unfinished-total" class="stat-value">
                            <span id="stat-unfinished-count">0</span>
                            <span class="sub">/</span>
                            <span id="stat-total-count" class="sub">0</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">拉力未完成</div>
                        <div id="stat-tensile-unfinished" class="stat-value">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">衝擊未完成</div>
                        <div id="stat-impact-unfinished" class="stat-value">0</div>
                    </div>
                </div>

                <div class="main-card p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <div class="relative flex-grow">
                                <input type="text" id="searchInput" placeholder="搜尋任何欄位..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <button id="displaySettingsBtn" class="btn btn-secondary p-2.5">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                            </button>
                            <button id="toggleExtraColumnsBtn" class="btn btn-secondary p-2.5" title="顯示額外欄位">
                                <svg id="icon-show-more" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                                <svg id="icon-show-less" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            </button>
                        </div>
                        <div class="flex space-x-2 w-full md:w-auto">
                            <button id="generateReportBtn" class="btn btn-secondary w-full flex items-center justify-center" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                                產生報表
                            </button>
                            <button id="importDataBtn" class="btn btn-secondary w-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                資料匯入
                            </button>
                            <button id="quickEditBtn" class="btn btn-green w-full flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m18 5-3-3-6 6 3 3Z"/><path d="m6 8 3 3-6 6-3-3Z"/><path d="m2 22 3-3"/><path d="m8 2 3 3"/></svg>
                                快速編輯
                            </button>
                            <button id="addDataBtn" class="btn btn-primary w-full flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                新增資料
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr id="dataTableHead"></tr></thead>
                            <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="pagination-container" class="flex justify-between items-center mt-4 px-2 py-1">
                        <!-- Pagination controls will be rendered here -->
                    </div>
                </div>
            </div>
            <div id="stats-report-page" class="hidden">
                <div class="main-card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6">測試次數統計報表</h2>
                    
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                        <div class="flex-1 w-full">
                            <label for="statsStartDate" class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                            <input type="date" id="statsStartDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div class="flex-1 w-full">
                            <label for="statsEndDate" class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                            <input type="date" id="statsEndDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div class="w-full sm:w-auto pt-6 sm:pt-0">
                             <button id="generateStatsReportBtn" class="btn btn-primary w-full">產生報表</button>
                        </div>
                    </div>
            
                    <div id="statsReportDisplayArea">
                        <div class="text-center py-12 text-gray-500">
                            請選擇日期範圍並點擊「產生報表」。
                        </div>
                    </div>
                </div>
            </div>
            <div id="settings-page" class="hidden">
                 <div class="main-card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">系統設定項目</h2>
                    <div id="settings-buttons-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"></div>
                    <div id="settings-content-display" class="mt-4"></div>
                 </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="displaySettingsModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-md">
            <div class="flex justify-between items-center pb-4 border-b">
                <h3 class="text-2xl font-bold">顯示設定</h3>
                <button id="closeDisplaySettingsBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-5 space-y-6">
                <div>
                    <h4 class="text-lg font-semibold mb-2">欄位顯示設定</h4>
                    <div id="column-toggle-container" class="grid grid-cols-3 sm:grid-cols-4 gap-2 text-sm max-h-48 overflow-y-auto p-2 border rounded-lg"></div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-2">資料篩選條件</h4>
                    <div id="filter-container" class="space-y-2"></div>
                    <button id="addFilterBtn" class="btn btn-secondary btn-sm mt-2 py-1 px-3 text-sm">+ 新增條件</button>
                </div>
            </div>
            <div class="flex justify-end pt-5 space-x-3 border-t mt-5">
                <button id="applyDisplaySettingsBtn" class="btn btn-primary">套用設定</button>
            </div>
        </div>
    </div>
    <div id="formModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div id="modalDialog" class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white">
            <div class="flex justify-between items-center pb-4 border-b">
                <h3 id="modalTitle" class="text-2xl font-bold"></h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-5"><form id="modalForm" class="space-y-4 max-h-[75vh] overflow-y-auto p-2"></form></div>
            <div class="flex justify-end pt-5 space-x-3 border-t mt-5">
                <button id="cancelModalBtn" class="btn btn-secondary">取消</button>
                <button id="saveModalBtn" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>
    <div id="quickEditModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div id="quickEditModalDialog" class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-7xl">
            <div class="flex justify-between items-center pb-4 border-b">
                <h3 class="text-2xl font-bold">快速編輯資料</h3>
                <button id="quickEditCloseBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="quickEditNav" class="flex items-center space-x-4 my-4">
                <button id="prevRecordBtn" class="btn btn-secondary px-4 py-2">上一筆</button>
                <select id="recordSelector" class="w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm"></select>
                <button id="nextRecordBtn" class="btn btn-secondary px-4 py-2">下一筆</button>
            </div>
            <div class="border-t pt-4 mt-4">
                 <button id="togglePasteDataBtn" class="btn btn-secondary btn-sm py-1 px-3 text-sm mb-2">貼上外部資料</button>
                 <div id="pasteDataContainer" class="hidden space-y-2 p-4 bg-gray-50 rounded-lg">
                     <textarea id="pasteDataTextarea" rows="6" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="請在此貼上 JSON 格式的資料..."></textarea>
                     <button id="applyPastedDataBtn" class="btn btn-primary">帶入資料</button>
                 </div>
            </div>
            <div class="mt-2">
                <form id="quickEditForm" class="space-y-4 max-h-[55vh] overflow-y-auto p-2"></form>
            </div>
            <div class="flex justify-end pt-5 space-x-3 border-t mt-5">
                <button id="quickEditCancelBtn" class="btn btn-secondary">關閉</button>
                <button id="quickEditSaveBtn" class="btn btn-primary">儲存變更</button>
            </div>
        </div>
    </div>
    <div id="settingsQuickEditModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div id="settingsQuickEditModalDialog" class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-7xl">
            <div class="flex justify-between items-center pb-4 border-b">
                <h3 id="settingsQuickEditTitle" class="text-2xl font-bold">快速編輯設定</h3>
                <button id="settingsQuickEditCloseBtn" class="text-gray-400 hover:text-gray-600">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex items-center space-x-4 my-4">
                <button id="settingsPrevRecordBtn" class="btn btn-secondary px-4 py-2">上一筆</button>
                <select id="settingsRecordSelector" class="w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm"></select>
                <button id="settingsNextRecordBtn" class="btn btn-secondary px-4 py-2">下一筆</button>
            </div>
            <div class="mt-2">
                <form id="settingsQuickEditForm" class="space-y-4 max-h-[60vh] overflow-y-auto p-2"></form>
            </div>
            <div class="flex justify-end pt-5 space-x-3 border-t mt-5">
                <button id="settingsQuickEditCancelBtn" class="btn btn-secondary">關閉</button>
                <button id="settingsQuickEditSaveBtn" class="btn btn-primary">儲存變更</button>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-xs">
             <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-5">確定要刪除嗎？</h3>
                <div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500">此操作將直接從 Firebase 中刪除此筆資料，且無法復原。</p></div>
                <div class="flex justify-center space-x-4 mt-4">
                    <button id="confirmCancelBtn" class="btn btn-secondary">取消</button>
                    <button id="confirmDeleteBtn" class="btn btn-danger">確定刪除</button>
                </div>
            </div>
        </div>
    </div>
    <div id="quickAddModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-sm">
            <h3 id="quickAddTitle" class="text-xl font-bold mb-4">快速新增</h3>
            <form id="quickAddForm" class="space-y-4"></form>
            <div class="flex justify-end pt-5 space-x-3 border-t mt-5">
                <button id="quickAddCancelBtn" type="button" class="btn btn-secondary">取消</button>
                <button id="quickAddSaveBtn" type="button" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>
    <div id="reportModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-70 overflow-y-auto h-full w-full z-50 flex items-start justify-center pt-10">
        <div id="reportModalDialog" class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-7xl">
            <div class="flex justify-between items-end pb-4 border-b mb-4">
                <!-- Left part with title and selectors -->
                <div class="flex items-end gap-6">
                    <div>
                        <h3 class="text-2xl font-bold">檢驗報告預覽</h3>
                        <p class="text-sm text-gray-500 mt-1">請選擇人員後開啟列印。</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div>
                            <label for="reportingPersonSelect" class="text-sm font-medium text-gray-700">報告人員</label>
                            <select id="reportingPersonSelect" class="block w-40 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 mt-1 text-sm"></select>
                        </div>
                        <div>
                            <label for="auditingPersonSelect" class="text-sm font-medium text-gray-700">審核人員</label>
                            <select id="auditingPersonSelect" class="block w-40 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 mt-1 text-sm"></select>
                        </div>
                    </div>
                </div>
                
                <!-- Right part with buttons -->
                <div class="flex-shrink-0">
                    <button id="nativePrintReportBtn" class="btn btn-primary">開啟列印報表</button>
                    <button id="closeReportModalBtn" class="btn btn-secondary ml-2">返回編輯</button>
                </div>
            </div>
            <div id="reportContent" class="bg-gray-100 p-4 max-h-[75vh] overflow-y-auto"></div>
        </div>
    </div>
    <div id="importModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-2xl">
            <div class="flex justify-between items-center pb-4 border-b">
                <h3 class="text-2xl font-bold">批次匯入測試資料</h3>
                <button id="closeImportModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-5">
                <p class="text-sm text-gray-600 mb-2">請貼上 JSON 格式的資料。系統支援兩種格式：<br>1. <strong>(建議) 簡化格式：</strong>直接貼上資料陣列，系統會自動匯入至「資料」集合。<br>2. <strong>完整格式：</strong>可指定 `collection` 和 `docIdField` 進行多集合匯入。<br><strong class="text-blue-600">注意：若指定的 ID (如「筆數」) 已存在，匯入的資料將會「合併」至現有資料中，而非完全覆蓋。</strong></p>
                <textarea id="importDataTextarea" rows="10" class="w-full p-2 border border-gray-300 rounded-lg font-mono text-sm" placeholder="// --- 簡化格式 (建議) ---&#10;[&#10;  {&#10;    &quot;groupId&quot;: &quot;1003&quot;,&#10;    &quot;data&quot;: {&#10;      &quot;化學成分&quot;: { &quot;C&quot;: &quot;0.05&quot;, &quot;Si&quot;: &quot;0.55&quot; },&#10;      &quot;機械性質&quot;: { &quot;抗拉強度&quot;: &quot;654&quot; },&#10;      &quot;衝擊測試&quot;: [ { &quot;測試溫度&quot;: &quot;-30℃&quot;, &quot;平均值&quot;: &quot;81&quot; } ]&#10;    }&#10;  }&#10;]&#10;&#10;// --- 完整格式 ---&#10;[&#10;  {&#10;    &quot;collection&quot;: &quot;資料&quot;,&#10;    &quot;docIdField&quot;: &quot;筆數&quot;,&#10;    &quot;data&quot;: [{ &quot;筆數&quot;: &quot;1001&quot;, &quot;品名&quot;: &quot;範例A&quot; }]&#10;  }&#10;]"></textarea>
                <div id="importResults" class="mt-4 max-h-48 overflow-y-auto p-3 bg-gray-50 rounded-lg text-sm">
                    <p class="text-gray-400">準備匯入...</p>
                </div>
            </div>
            <div class="flex justify-end pt-5 space-x-3 border-t mt-5">
                <button id="closeImportModalBtn2" class="btn btn-secondary">關閉</button>
                <button id="startImportBtn" class="btn btn-primary">開始匯入</button>
            </div>
        </div>
    </div>

<!-- Firebase SDK -->
<script type="module">
    // 匯入 Firebase v9 模組化 SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, doc, getDocs, onSnapshot, addDoc, setDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    // --- 1. Firebase 初始化設定 ---
    // 請將下方的設定物件換成您自己的 Firebase 專案設定
    // 您可以在 Firebase 控制台的「專案設定」中找到這些資訊
    const firebaseConfig = {
      apiKey: "AIzaSyDGguuoIfRMNKJG2UvJ_QI7y-_6cNfS9D0",
      authDomain: "weldingdata-20250902.firebaseapp.com",
      projectId: "weldingdata-20250902",
      storageBucket: "weldingdata-20250902.firebasestorage.app",
      messagingSenderId: "63887490861",
      appId: "1:63887490861:web:ce1fed7d7c99ce78c8dda4",
      measurementId: "G-ZN7Q19FTNP"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const firestoreDb = getFirestore(app);
    const auth = getAuth(app);

    // 將 Firebase 實例掛載到 window 物件，以便在另一個 script 標籤中存取
    window.firebaseInstances = {
        firestoreDb,
        auth,
        collection,
        doc,
        getDocs,
        onSnapshot,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        writeBatch,
        signInAnonymously
    };
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // 從 window 物件獲取 Firebase 實例
    const { firestoreDb, auth, collection, doc, getDocs, onSnapshot, addDoc, setDoc, updateDoc, deleteDoc, writeBatch, signInAnonymously } = window.firebaseInstances;
    
    // --- 重要設定：預設欄位名稱與順序 ---
    const defaultHeaders = {
        '人員': ['姓名'],
        '鋼板': ['材質'],
        '氣體': ['名稱'],
        '銲材分類': ['銲材分類'],
        '品名對規範': ['品名', '預設適用規範', '預設銲材分類'],
        '件別': ['件別名稱'] // <-- 新增
    };
    const CHEM_ELEMENTS_ORDER = [ 'C', 'Si', 'Mn', 'P', 'S', 'Cr', 'Ni', 'Mo', 'Al', 'Cu', 'Co', 'Ti', 'Nb', 'V', 'W', 'B', 'Sn', 'Zr', 'Fe', 'O', 'N' ];
    const CANONICAL_COLUMN_ORDER = [ '筆數', '銲接日期', '品名', '線徑', '適用規範', '配方', 'RUD卡', '備註', '銲接人員', '銲接模式', '氣體', '鋼板材質', '電流', '電壓', '件別', '拉力棒加工人員', '衝擊片加工人員', '機械性質', '衝擊測試', '硬度測試', '化學成分' ]; // <-- 新增 '件別'


    // --- 資料庫與狀態管理 ---
    let db = {}; // 將由 Firestore 填充
    let state = {
        currentPage: 'main',
        currentSettingView: null,
        editingDocId: null, 
        editingTableName: null,
        searchTerm: '',
        sortKey: '筆數', 
        sortOrder: 'desc', 
        quickEditCurrentIndex: -1,
        quickEditSortedIds: [],
        settingsQuickEditTableName: null,
        settingsQuickEditSortedIds: [],
        settingsQuickEditCurrentIndex: -1,
        showExtraColumns: false,
        visibleColumns: [],
        filters: [],
        selectedRowIds: [],
        currentPageNumber: 1,
        itemsPerPage: 10,
        currentStatsTab: 'welding',
    };

    // --- DOM 元素 ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const toastContainer = document.getElementById('toast-container');
    const mainTab = document.getElementById('main-tab');
    const settingsTab = document.getElementById('settings-tab');
    const statsReportTab = document.getElementById('stats-report-tab');
    const mainPage = document.getElementById('main-page');
    const settingsPage = document.getElementById('settings-page');
    const statsReportPage = document.getElementById('stats-report-page');
    const searchInput = document.getElementById('searchInput');
    const addDataBtn = document.getElementById('addDataBtn');
    const quickEditBtn = document.getElementById('quickEditBtn');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const dataTableHead = document.getElementById('dataTableHead');
    const dataTableBody = document.getElementById('dataTableBody');
    const formModal = document.getElementById('formModal');
    const modalDialog = document.getElementById('modalDialog');
    const modalTitle = document.getElementById('modalTitle');
    const modalForm = document.getElementById('modalForm');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const saveModalBtn = document.getElementById('saveModalBtn');
    const confirmModal = document.getElementById('confirmModal');
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    const paginationContainer = document.getElementById('pagination-container');
    const quickAddModal = document.getElementById('quickAddModal');
    const quickAddTitle = document.getElementById('quickAddTitle');
    const quickAddForm = document.getElementById('quickAddForm');
    const quickAddCancelBtn = document.getElementById('quickAddCancelBtn');
    const quickAddSaveBtn = document.getElementById('quickAddSaveBtn');
    const settingsButtonsContainer = document.getElementById('settings-buttons-container');
    const settingsContentDisplay = document.getElementById('settings-content-display');
    const displaySettingsBtn = document.getElementById('displaySettingsBtn');
    const displaySettingsModal = document.getElementById('displaySettingsModal');
    const closeDisplaySettingsBtn = document.getElementById('closeDisplaySettingsBtn');
    const columnToggleContainer = document.getElementById('column-toggle-container');
    const filterContainer = document.getElementById('filter-container');
    const addFilterBtn = document.getElementById('addFilterBtn');
    const applyDisplaySettingsBtn = document.getElementById('applyDisplaySettingsBtn');
    const quickEditModal = document.getElementById('quickEditModal');
    const quickEditCloseBtn = document.getElementById('quickEditCloseBtn');
    const quickEditCancelBtn = document.getElementById('quickEditCancelBtn');
    const prevRecordBtn = document.getElementById('prevRecordBtn');
    const nextRecordBtn = document.getElementById('nextRecordBtn');
    const recordSelector = document.getElementById('recordSelector');
    const quickEditForm = document.getElementById('quickEditForm');
    const quickEditSaveBtn = document.getElementById('quickEditSaveBtn');
    const statUnfinishedCount = document.getElementById('stat-unfinished-count');
    const statTotalCount = document.getElementById('stat-total-count');
    const statTensileUnfinished = document.getElementById('stat-tensile-unfinished');
    const statImpactUnfinished = document.getElementById('stat-impact-unfinished');
    const reportModal = document.getElementById('reportModal');
    const reportContent = document.getElementById('reportContent');
    const closeReportModalBtn = document.getElementById('closeReportModalBtn');
    const printReportBtn = document.getElementById('printReportBtn');
    const generateStatsReportBtn = document.getElementById('generateStatsReportBtn');
    const statsReportDisplayArea = document.getElementById('statsReportDisplayArea');
    const togglePasteDataBtn = document.getElementById('togglePasteDataBtn');
    const pasteDataContainer = document.getElementById('pasteDataContainer');
    const pasteDataTextarea = document.getElementById('pasteDataTextarea');
    const applyPastedDataBtn = document.getElementById('applyPastedDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const importModal = document.getElementById('importModal');
    const closeImportModalBtn = document.getElementById('closeImportModalBtn');
    const closeImportModalBtn2 = document.getElementById('closeImportModalBtn2');
    const importDataTextarea = document.getElementById('importDataTextarea');
    const startImportBtn = document.getElementById('startImportBtn');
    const importResults = document.getElementById('importResults');
    const toggleExtraColumnsBtn = document.getElementById('toggleExtraColumnsBtn');
    const iconShowMore = document.getElementById('icon-show-more');
    const iconShowLess = document.getElementById('icon-show-less');

    // --- 新增：設定頁的快速編輯 Modal DOM 元素 ---
    const settingsQuickEditModal = document.getElementById('settingsQuickEditModal');
    const settingsQuickEditTitle = document.getElementById('settingsQuickEditTitle');
    const settingsQuickEditCloseBtn = document.getElementById('settingsQuickEditCloseBtn');
    const settingsPrevRecordBtn = document.getElementById('settingsPrevRecordBtn');
    const settingsNextRecordBtn = document.getElementById('settingsNextRecordBtn');
    const settingsRecordSelector = document.getElementById('settingsRecordSelector');
    const settingsQuickEditForm = document.getElementById('settingsQuickEditForm');
    const settingsQuickEditCancelBtn = document.getElementById('settingsQuickEditCancelBtn');
    const settingsQuickEditSaveBtn = document.getElementById('settingsQuickEditSaveBtn');
    
    // --- 快速新增 Modal 狀態 ---
    let quickAddState = {
        targetField: null,
        sourceForm: null,
        tableName: null
    };

    // --- 提示函式 (無變更) ---
    const showLoading = (text = '處理中...') => { loadingOverlay.querySelector('p').textContent = text; loadingOverlay.style.opacity = '1'; loadingOverlay.style.pointerEvents = 'auto'; };
    const hideLoading = () => { loadingOverlay.style.opacity = '0'; loadingOverlay.style.pointerEvents = 'none'; };
    const showToast = (message, type = 'success') => { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; toastContainer.appendChild(toast); setTimeout(() => { toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 3000); }, 3000); }, 10); };
    
    // --- 排序、篩選與驗證函式 (無變更) ---
    const sortDataByKey = (array, key, order = 'asc') => {
        return [...array].sort((a, b) => {
            const valA = a[key]; const valB = b[key];
            if (valA == null && valB == null) return 0;
            if (valA == null) return order === 'asc' ? 1 : -1;
            if (valB == null) return order === 'asc' ? -1 : 1;
            const numA = parseFloat(valA); const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) { return order === 'asc' ? numA - numB : numB - numA; }
            const dateA = new Date(valA); const dateB = new Date(valB);
            if (!isNaN(dateA.getTime()) && !isNaN(dateB.getTime())) { return order === 'asc' ? dateA - dateB : dateB - dateA; }
            return order === 'asc' ? String(valA).localeCompare(String(valB), 'zh-Hant') : String(valB).localeCompare(String(valA), 'zh-Hant');
        });
    };
    const getValidationResult = (specName, property, value) => {
        if (!specName || value === null || value === undefined || value === '') return { hasSpec: false, isValid: true, message: '' };
        const spec = db['規範'].find(s => s.規範名稱 === specName);
        if (!spec) return { hasSpec: false, isValid: true, message: '找不到對應規範' };

        const valNum = parseFloat(value);
        if (isNaN(valNum)) return { hasSpec: false, isValid: true, message: '' }; // Not a number, can't validate numerically

        let isValid = true;
        const messages = [];

        const minKey = property + '_最低';
        const maxKey = property + '_最高';
        const lowerLimitKey = property + '_下限';
        const requiredValueKey = property + '要求數據';

        const hasMin = spec.hasOwnProperty(minKey) && spec[minKey] !== '' && spec[minKey] !== null;
        const hasMax = spec.hasOwnProperty(maxKey) && spec[maxKey] !== '' && spec[maxKey] !== null;
        const hasLowerLimit = spec.hasOwnProperty(lowerLimitKey) && spec[lowerLimitKey] !== '' && spec[lowerLimitKey] !== null;
        const hasRequiredValue = spec.hasOwnProperty(requiredValueKey) && spec[requiredValueKey] !== '' && spec[requiredValueKey] !== null;

        const hasAnySpec = hasMin || hasMax || hasLowerLimit || hasRequiredValue;

        if (!hasAnySpec) {
            return { hasSpec: false, isValid: true, message: '無規範要求' };
        }

        // Check against max
        if (hasMax) {
            const max = parseFloat(spec[maxKey]);
            if (!isNaN(max) && valNum > max) {
                isValid = false;
                messages.push(`高於上限 ${max}`);
            }
        }

        // Check against min
        if (hasMin) {
            const min = parseFloat(spec[minKey]);
            if (!isNaN(min) && valNum < min) {
                isValid = false;
                messages.push(`低於下限 ${min}`);
            }
        }
        
        // Check against lower limit (e.g. for Elongation %)
        if (hasLowerLimit) {
            const required = parseFloat(spec[lowerLimitKey]);
            if (!isNaN(required) && valNum < required) {
                isValid = false;
                messages.push(`低於下限 ${required}`);
            }
        }
        
        // Check against required value (e.g. for Impact)
        if (hasRequiredValue) {
            const required = parseFloat(spec[requiredValueKey]);
            if (!isNaN(required) && valNum < required) {
                isValid = false;
                messages.push(`低於要求 ${required}`);
            }
        }

        return { hasSpec: true, isValid: isValid, message: isValid ? '符合規範' : messages.join(', ') };
    };

    const renderFilters = () => {
        filterContainer.innerHTML = '';
        const allColumns = (db['資料'] && db['資料'].length > 0) ? getSortedColumns(db['資料']) : [];
        const operatorOptions = [
            { value: 'contains', text: '包含' },
            { value: 'not-contains', text: '不包含' },
            { value: 'equals', text: '等於' },
            { value: 'not-equals', text: '不等於' },
            { value: 'greater-than', text: '大於' },
            { value: 'less-than', text: '小於' },
        ];
        state.filters.forEach((filter, index) => {
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'filter-rule flex items-center gap-2';
            ruleDiv.dataset.index = index;
            const columnSelect = `<select class="filter-column block w-1/3 py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm">${allColumns.map(col => `<option value="${col}" ${filter.column === col ? 'selected' : ''}>${col}</option>`).join('')}</select>`;
            const operatorSelect = `<select class="filter-operator block w-1/4 py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm">${operatorOptions.map(opt => `<option value="${opt.value}" ${filter.operator === opt.value ? 'selected' : ''}>${opt.text}</option>`).join('')}</select>`;
            const valueInput = `<input type="text" class="filter-value block w-1/3 py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm" value="${filter.value || ''}" placeholder="篩選值">`;
            const removeButton = `<button type="button" class="remove-filter-btn text-red-500 hover:text-red-700 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
            ruleDiv.innerHTML = columnSelect + operatorSelect + valueInput + removeButton;
            filterContainer.appendChild(ruleDiv);
        });
    };

    const populateFormWithParsedData = (data, formElement) => {
        for (const key in data) {
            if (data.hasOwnProperty(key)) {
                const input = formElement.querySelector(`[name="${key}"]`);
                if (input && typeof data[key] === 'string') {
                    input.value = data[key];
                }
            }
        }
        populateTestData(data, formElement);
        setTimeout(() => validateAllFormFields(formElement), 100);
        showToast('資料已成功帶入表單！', 'success');
    };

    // --- 新增：取得下一筆資料編號的函式 ---
    const getNextGroupId = (allData) => {
        if (!allData || allData.length === 0) return '1';
        const maxId = allData.reduce((max, item) => {
            const id = parseInt(item['筆數'], 10);
            return isNaN(id) ? max : Math.max(max, id);
        }, 0);
        return String(maxId + 1);
    };


    // --- 渲染函式 (邏輯不變，僅修改 id 來源) ---
    const renderDataTable = () => {
        dataTableHead.innerHTML = '';
        dataTableBody.innerHTML = '';
        const data = db['資料'];
        if (!data) { 
            dataTableBody.innerHTML = `<tr><td colspan="100%" class="text-center py-10 text-gray-500">沒有資料</td></tr>`; 
            renderDashboards([]);
            renderPaginationControls(0, 0);
            return; 
        }
        
        let processedData = [...data];
        state.filters.forEach(filter => {
            if (!filter.column || !filter.operator || filter.value === undefined) return;
            processedData = processedData.filter(row => {
                const rowValue = row[filter.column]; const filterValue = filter.value;
                if (rowValue === undefined || rowValue === null) return false;
                const rowValueStr = String(rowValue).toLowerCase(); const filterValueStr = String(filterValue).toLowerCase();
                const rowValueNum = parseFloat(rowValue); const filterValueNum = parseFloat(filterValue);
                switch (filter.operator) {
                    case 'contains': return rowValueStr.includes(filterValueStr);
                    case 'not-contains': return !rowValueStr.includes(filterValueStr);
                    case 'equals': return rowValueStr === filterValueStr;
                    case 'not-equals': return rowValueStr !== filterValueStr;
                    case 'greater-than': return !isNaN(rowValueNum) && !isNaN(filterValueNum) && rowValueNum > filterValueNum;
                    case 'less-than': return !isNaN(rowValueNum) && !isNaN(filterValueNum) && rowValueNum < filterValueNum;
                    default: return true;
                }
            });
        });
        const filteredData = processedData.filter(row => { if (!state.searchTerm) return true; return Object.values(row).some(value => String(value).toLowerCase().includes(state.searchTerm.toLowerCase())); });
        const sortedData = sortDataByKey(filteredData, state.sortKey, state.sortOrder);

        renderDashboards(sortedData);

        const totalItems = sortedData.length;
        const totalPages = Math.ceil(totalItems / state.itemsPerPage);
        if (state.currentPageNumber > totalPages && totalPages > 0) { state.currentPageNumber = totalPages; }
        else if (totalPages === 0) { state.currentPageNumber = 1; }
        const startIndex = (state.currentPageNumber - 1) * state.itemsPerPage;
        const paginatedData = sortedData.slice(startIndex, startIndex + state.itemsPerPage);
        
        const thCheckbox = document.createElement('th');
        thCheckbox.className = 'px-4 py-3';
        thCheckbox.innerHTML = `<input type="checkbox" id="selectAllCheckbox" class="rounded">`;
        dataTableHead.appendChild(thCheckbox);
        
        const extraColumns = ['銲接人員', '拉力棒加工人員', '衝擊片加工人員', '銲接模式', '鋼板材質', '電流', '電壓'];
        const headers = state.showExtraColumns
            ? state.visibleColumns
            : state.visibleColumns.filter(col => !extraColumns.includes(col));

        headers.forEach(header => {
            const th = document.createElement('th');
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header';
            if (header === '筆數' && headers.includes('筆數')) { th.classList.add('sticky-col', 'sticky-col-divider'); }
            th.dataset.sortKey = header;
            let indicator = '';
            if (state.sortKey === header) { indicator = state.sortOrder === 'asc' ? '▲' : '▼'; }
            th.innerHTML = `${header} <span class="sort-indicator">${indicator}</span>`;
            dataTableHead.appendChild(th);
        });
        const thActions = document.createElement('th');
        thActions.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
        thActions.textContent = '操作';
        dataTableHead.appendChild(thActions);
        
        if (paginatedData.length === 0) {
            dataTableBody.innerHTML = `<tr><td colspan="${headers.length + 2}" class="text-center py-10 text-gray-500">找不到符合條件的資料</td></tr>`;
        } else {
            paginatedData.forEach(row => {
                const tr = document.createElement('tr');
                const specName = row['適用規範'];
                const tdCheckbox = document.createElement('td'); tdCheckbox.className = 'px-4 py-4';
                tdCheckbox.innerHTML = `<input type="checkbox" class="row-checkbox rounded" data-id="${row._docId}">`;
                tr.appendChild(tdCheckbox);

                // --- 集中且安全的 JSON 解析 ---
                let mechanicalData, impactData, chemicalData;
                try { mechanicalData = JSON.parse(row['機械性質'] || '[]'); } catch (e) { mechanicalData = null; }
                try { impactData = JSON.parse(row['衝擊測試'] || '[]'); } catch (e) { impactData = null; }
                try { chemicalData = JSON.parse(row['化學成分'] || '{}'); } catch (e) { chemicalData = null; }
                
                const checkMechHasData = (data) => { if (data === null || !data || data.length === 0) return false; const firstSet = data[0]; if (firstSet.doNotTest) return true; return !!(firstSet['抗拉強度'] || firstSet['降伏強度'] || firstSet['延伸率']); };
                const checkImpactHasData = (data) => { if (data === null || !data || data.length === 0) return false; const firstSet = data[0]; if (firstSet.doNotTest) return true; const hasValues = firstSet['實測值'] && firstSet['實測值'].length > 0 && firstSet['實測值'].some(v => v); return hasValues; };
                const checkChemHasData = (data) => { return data !== null && data && Object.keys(data).length > 0; };
                
                const hasMechanical = checkMechHasData(mechanicalData);
                const hasImpact = checkImpactHasData(impactData);
                const hasChemical = checkChemHasData(chemicalData);

                let lightColorClass = 'bg-red-500';
                let lightTooltip = '缺少所有測試資料';
                if (hasMechanical && hasImpact && hasChemical) { lightColorClass = 'bg-blue-500'; lightTooltip = '所有測試資料齊全'; } else if (hasMechanical && hasImpact) { lightColorClass = 'bg-purple-500'; lightTooltip = '有機械與衝擊資料，缺少化學成份'; } else if (hasMechanical) { lightColorClass = 'bg-yellow-500'; lightTooltip = '有機械資料，缺少衝擊與化學成份'; }
                const lightIndicatorHTML = `<span class="inline-block w-3 h-3 ${lightColorClass} rounded-full mr-2 flex-shrink-0" title="${lightTooltip}"></span>`;
                
                headers.forEach(header => {
                    const td = document.createElement('td'); td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700'; 
                    if (header === '筆數' && headers.includes('筆數')) { td.classList.add('sticky-col', 'sticky-col-divider'); }
                    
                    const rawValue = row[header];
                    td.title = rawValue || '';
                    let contentHTML = rawValue ?? '';

                    
                    if (header === '銲接日期' && rawValue) {
                        const dateParts = rawValue.split('-');
                        if (dateParts.length === 3 && dateParts[0].length === 4) {
                            contentHTML = `${dateParts[0].substring(2)}-${dateParts[1]}-${dateParts[2]}`;
                        }
                    } else if (header === '適用規範' && rawValue && rawValue.length > 20) {
                        contentHTML = rawValue.substring(0, 20) + '...';
                    } else if (header === '備註' && rawValue && rawValue.length > 10) {
                        contentHTML = rawValue.substring(0, 10) + '...';
                    } else if (header === '機械性質') {
                        if (mechanicalData === null) {
                            contentHTML = rawValue ?? '-';
                            td.classList.add('text-red-600', 'italic');
                            td.title = '此資料格式錯誤，無法解析';
                        } else {
                            contentHTML = !checkMechHasData(mechanicalData) ? '-' : mechanicalData.map(p => {
                                if (p.doNotTest) return '<span class="text-gray-500 italic">不做測試</span>';
                                const parts = [];
                                const ts = p['抗拉強度'];
                                const ys = p['降伏強度'];
                                const el = p['延伸率'];
                                if (ts) {
                                    const tsV = getValidationResult(specName, '抗拉強度', ts);
                                    parts.push(`抗拉:${tsV.isValid?ts:`<span class="text-red-500 font-bold" title="${tsV.message}">${ts}</span>`}`);
                                }
                                if (ys) {
                                    const ysV = getValidationResult(specName, '降伏強度', ys);
                                    parts.push(`降伏:${ysV.isValid?ys:`<span class="text-red-500 font-bold" title="${ysV.message}">${ys}</span>`}`);
                                }
                                if (el) {
                                    const elV = getValidationResult(specName, '延伸率', el);
                                    parts.push(`延伸:${elV.isValid?el:`<span class="text-red-500 font-bold" title="${elV.message}">${el}</span>`}%`);
                                }
                                return parts.join(', ');
                            }).join('<br>');
                        }
                    } else if (header === '衝擊測試') {
                        if (impactData === null) {
                            contentHTML = rawValue ?? '-';
                            td.classList.add('text-red-600', 'italic');
                            td.title = '此資料格式錯誤，無法解析';
                        } else {
                            contentHTML = !checkImpactHasData(impactData) ? '-' : impactData.map(p => {
                                if (p.doNotTest) return '<span class="text-gray-500 italic">不做測試</span>';
                                const parts = [];
                                if (p['測試溫度']) {
                                    parts.push(`溫度:${p['測試溫度']}${p['單位']||''}`);
                                }
                                if (p['實測值'] && p['實測值'].length > 0) {
                                    const vHtml = (p['實測值'] || []).map(v => {
                                        const vV = getValidationResult(specName, '衝擊', v);
                                        return vV.isValid ? v : `<span class="text-red-500 font-bold" title="${vV.message}">${v}</span>`;
                                    }).join(', ');
                                    parts.push(`實測:[${vHtml}]`);
                                }
                                if (p['平均值']) {
                                    const avg = p['平均值'];
                                    const avgV = getValidationResult(specName, '衝擊', avg);
                                    const avgHtml = avgV.isValid ? avg : `<span class="text-red-500 font-bold" title="${avgV.message}">${avg}</span>`;
                                    parts.push(`平均:${avgHtml}`);
                                }
                                return parts.join(', ');
                            }).join('<br>');
                        }
                    } else if (header === '硬度測試') {
                        let parsed;
                        try { parsed = JSON.parse(rawValue || '[]'); } catch(e) { parsed = null; }

                        if (parsed === null) {
                            contentHTML = rawValue ?? '-';
                            td.classList.add('text-red-600', 'italic');
                            td.title = '此資料格式錯誤，無法解析';
                        } else {
                            const hasData = parsed.length > 0 && parsed.some(p => p['實測值'] && p['實測值'].length > 0);
                            contentHTML = !hasData ? '-' : parsed.map(p => {
                                const parts = [];
                                if (p['單位']) {
                                    parts.push(`單位:${p['單位']}`);
                                }
                                if (p['實測值'] && p['實測值'].length > 0) {
                                    parts.push(`實測:[${(p['實測值']||[]).join(', ')}]`);
                                }
                                return parts.join(', ');
                            }).join('<br>');
                        }
                    } else if (header === '化學成分') {
                         if (chemicalData === null) {
                            contentHTML = rawValue ?? '-';
                            td.classList.add('text-red-600', 'italic');
                            td.title = '此資料格式錯誤，無法解析';
                        } else {
                            if (!checkChemHasData(chemicalData)) {
                                contentHTML = '-';
                            } else {
                                const elementsToShow = ['C', 'Si', 'Mn', 'P', 'S', 'Cr', 'Ni', 'Mo'];
                                const htmls = [];
                                elementsToShow.forEach(el => {
                                    if (chemicalData.hasOwnProperty(el)) {
                                        const v = chemicalData[el];
                                        const val = getValidationResult(specName, el, v);
                                        htmls.push(val.isValid ? `${el}:${v}` : `${el}:<span class="text-red-500 font-bold" title="${val.message}">${v}</span>`);
                                    }
                                });
                                contentHTML = htmls.join(', ');
                            }
                        }
                    } else if (header === '筆數') {
                        contentHTML = `<div class="flex items-center">${lightIndicatorHTML}${rawValue}</div>`;
                    }
                    
                    td.innerHTML = contentHTML;
                    tr.appendChild(td);
                });
                const tdActions = document.createElement('td'); tdActions.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4'; tdActions.innerHTML = `<button class="action-link edit-btn" data-id="${row._docId}" data-table="資料">編輯</button> <button class="action-link delete-btn" data-id="${row._docId}" data-table="資料">刪除</button>`; tr.appendChild(tdActions);
                dataTableBody.appendChild(tr);
            });
        }
        renderPaginationControls(totalItems, totalPages);
    };
    const renderPaginationControls = (totalItems, totalPages) => {
        if (!paginationContainer) return; if (totalPages <= 1) { paginationContainer.innerHTML = ''; return; }
        const startItem = (state.currentPageNumber - 1) * state.itemsPerPage + 1;
        const endItem = Math.min(startItem + state.itemsPerPage - 1, totalItems);
        paginationContainer.innerHTML = `<span class="text-sm text-gray-600">顯示 ${startItem} - ${endItem} 筆，共 ${totalItems} 筆資料</span><div class="inline-flex items-center -space-x-px"><button id="prevPageBtn" class="flex items-center btn btn-secondary rounded-r-none py-2 px-3 text-sm" ${state.currentPageNumber === 1 ? 'disabled' : ''}><svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>上一頁</button><span class="bg-white border-y border-gray-300 text-gray-700 px-4 py-2 text-sm">${state.currentPageNumber} / ${totalPages}</span><button id="nextPageBtn" class="flex items-center btn btn-secondary rounded-l-none py-2 px-3 text-sm" ${state.currentPageNumber >= totalPages ? 'disabled' : ''}>下一頁<svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div>`;
    };
    const renderDashboards = (data) => {
        const totalCount = data.length; let tensileUnfinishedCount = 0; let impactUnfinishedCount = 0; let totalUnfinishedCount = 0;
        data.forEach(row => { let isTensileUnfinished = true; let isImpactUnfinished = true; try { const mechanical = JSON.parse(row['機械性質'] || '[]'); if (mechanical.length > 0) { const test = mechanical[0]; if (test.doNotTest || (test['抗拉強度'] !== null && test['抗拉強度'] !== undefined && test['抗拉強度'] !== '')) { isTensileUnfinished = false; } } } catch (e) {} try { const impact = JSON.parse(row['衝擊測試'] || '[]'); if (impact.length > 0) { const test = impact[0]; if (test.doNotTest || (test['平均值'] !== null && test['平均值'] !== undefined && test['平均值'] !== '')) { isImpactUnfinished = false; } } } catch (e) {} if (isTensileUnfinished) tensileUnfinishedCount++; if (isImpactUnfinished) impactUnfinishedCount++; if (isTensileUnfinished || isImpactUnfinished) totalUnfinishedCount++; });
        statTotalCount.textContent = totalCount; statUnfinishedCount.textContent = totalUnfinishedCount; statTensileUnfinished.textContent = tensileUnfinishedCount; statImpactUnfinished.textContent = impactUnfinishedCount;
    };
    const renderSettingsContent = (tableName) => {
        state.currentSettingView = tableName;
        renderSettingsButtons();
        settingsContentDisplay.innerHTML = '';
        const data = db[tableName];
        if (!data) {
            settingsContentDisplay.innerHTML = `<p class="text-center text-gray-500">找不到資料表: ${tableName}</p>`;
            return;
        }

        const drawTable = () => {
            settingsContentDisplay.innerHTML = '';
            const isSpec = tableName === '規範';
            const canQuickEdit = ['規範', '品名對規範'].includes(tableName);

            const btnContainer = document.createElement('div');
            btnContainer.className = 'flex space-x-4 mb-4';
            let buttonsHTML = '';
            if (canQuickEdit) {
                buttonsHTML += `<button class="btn btn-green" data-table="${tableName}" id="settings-quick-edit-btn">快速編輯</button>`;
            }
            if (isSpec) {
                buttonsHTML += `<button class="btn btn-primary" onclick="window.openFormModal('規範', null)">新增規範</button>`;
            }
            if (buttonsHTML) {
                btnContainer.innerHTML = buttonsHTML;
                settingsContentDisplay.appendChild(btnContainer);
            }

            let headers;
            if (tableName === '規範' && data.length > 0) {
                const allSpecKeys = new Set(data.flatMap(row => Object.keys(row)).filter(k => !['_docId', 'sortOrder'].includes(k)));
                const orderedGroups = [
                    ['規範名稱'],
                    ['抗拉強度_最低', '抗拉強度_最高', '降伏強度_最低', '降伏強度_最高', '延伸率_下限'],
                    ['衝擊溫度需求', '衝擊溫度單位', '衝擊要求數據'],
                    ...CHEM_ELEMENTS_ORDER.map(el => [`${el}_最低`, `${el}_最高`])
                ];
                let orderedHeaders = [];
                const addedKeys = new Set();
                orderedGroups.forEach(group => {
                    group.forEach(key => {
                        if (allSpecKeys.has(key) && !addedKeys.has(key)) {
                            orderedHeaders.push(key);
                            addedKeys.add(key);
                        }
                    });
                });
                const otherKeys = [...allSpecKeys].filter(key => !addedKeys.has(key)).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                headers = [...orderedHeaders, ...otherKeys];
            } else {
                headers = data.length > 0 ? Object.keys(data[0]).filter(h => !['_docId', 'sortOrder'].includes(h)) : (defaultHeaders[tableName] || []);
            }

            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto';
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            
            // Primary sort is now based on the `sortOrder` field.
            const sortedData = [...data].sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));

            const tableBodyHTML = sortedData.map(row => {
                const handleCell = `<td class="px-2 py-4 text-center drag-handle text-gray-400 align-middle"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg></td>`;
                const dataCells = headers.map(h => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 align-middle" title="${row[h] || ''}">${(row[h] === undefined || row[h] === null ? '' : String(row[h])).substring(0, 100)}</td>`).join('');
                const actionCell = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4 align-middle"><button class="action-link edit-btn" data-id="${row._docId}" data-table="${tableName}">編輯</button><button class="action-link delete-btn" data-id="${row._docId}" data-table="${tableName}">刪除</button></td>`;
                return `<tr data-id="${row._docId}">${handleCell}${dataCells}${actionCell}</tr>`;
            }).join('');

            const tableFooterHTML = !isSpec ? `<tfoot class="bg-gray-50"><tr id="add-row-${tableName}"><td class="p-2"></td>${headers.map(h => { const tdClass = 'p-2 relative'; if (tableName === '品名對規範' && h === '預設適用規範') { const opts = (db['規範'] || []).map(s => `<option value="${s.規範名稱}">${s.規範名稱}</option>`).join(''); return `<td class="${tdClass}"><select name="${h}" class="block w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm"><option value="">請選擇</option>${opts}</select></td>`; } if (tableName === '品名對規範' && h === '預設銲材分類') { const opts = (db['銲材分類'] || []).map(s => `<option value="${s.銲材分類}">${s.銲材分類}</option>`).join(''); return `<td class="${tdClass}"><select name="${h}" class="block w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm"><option value="">請選擇</option>${opts}</select></td>`; } return `<td class="${tdClass}"><input type="text" name="${h}" placeholder="${h}" class="block w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm"></td>`; }).join('')}<td class="p-2"><button class="add-inline-btn w-full btn btn-primary py-2" data-table="${tableName}">新增</button></td></tr></tfoot>` : '';
            
            const handleHeader = `<th class="px-2 py-3 w-12"></th>`;
            const headerHTML = headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');
            const actionHeader = `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>`;

            table.innerHTML = `<thead class="bg-gray-50"><tr>${handleHeader}${headerHTML}${actionHeader}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${tableBodyHTML}</tbody>${tableFooterHTML}`;
            
            tableContainer.appendChild(table);
            settingsContentDisplay.appendChild(tableContainer);

            const tbody = table.querySelector('tbody');
            if (tbody) {
                Sortable.create(tbody, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: async (evt) => {
                        const rows = Array.from(evt.target.children);
                        const allIdsInNewOrder = rows.map(row => row.dataset.id);
                        
                        showLoading('正在儲存順序...');
                        const batch = writeBatch(firestoreDb);
                        allIdsInNewOrder.forEach((docId, index) => {
                            const docRef = doc(firestoreDb, tableName, docId);
                            batch.update(docRef, { sortOrder: index });
                        });

                        try {
                            await batch.commit();
                            showToast('順序已更新', 'success');
                        } catch (error) {
                            console.error("Failed to save new order: ", error);
                            showToast(`順序儲存失敗: ${error.message}`, 'error');
                            renderSettingsContent(tableName);
                        } finally {
                            hideLoading();
                        }
                    },
                });
            }
        };
        
        if (settingsContentDisplay.handler) {
            settingsContentDisplay.removeEventListener('click', settingsContentDisplay.handler);
        }

        drawTable();
    };
    const renderSettingsButtons = () => {
        settingsButtonsContainer.innerHTML = ''; Object.keys(db).filter(key => key !== '資料').forEach(tableName => { const button = document.createElement('button'); button.textContent = tableName; button.dataset.table = tableName; button.className = `settings-main-btn ${state.currentSettingView === tableName ? 'active' : ''}`; settingsButtonsContainer.appendChild(button); });
    };
    
    // --- Modal 相關函式 ---
    const createFormField = (name, value, type = 'text', options = {}) => {
        const { label = name, placeholder = '', isTextarea = false, isSelect = false, selectOptions = [], noLabel = false, inputClass = '', isReadonly = false } = options;
        let valueAttr = value || ''; if (type === 'date' && valueAttr && typeof valueAttr === 'string' && valueAttr.includes('/')) { valueAttr = valueAttr.replace(/\//g, '-'); }
        const readonlyAttr = isReadonly ? 'readonly' : '';
        const baseClass = 'block w-full py-2 px-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 sm:text-sm';
        const finalClass = `${baseClass} ${inputClass} ${isReadonly ? 'bg-gray-100' : ''}`;
        const labelHtml = noLabel ? '' : `<label for="field-${name}" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>`;
        const fieldHtml = isTextarea ? `<textarea id="field-${name}" name="${name}" rows="4" class="${finalClass}" placeholder="${placeholder}" ${readonlyAttr}>${valueAttr}</textarea><p class="mt-1 text-xs text-gray-500">建議使用 JSON 格式。</p>` : isSelect ? `<select id="field-${name}" name="${name}" class="${finalClass}" ${readonlyAttr}><option value="">請選擇</option>${selectOptions.map(p => `<option value="${p}" ${p == valueAttr ? 'selected' : ''}>${p}</option>`).join('')}</select>` : `<input type="${type}" id="field-${name}" name="${name}" value="${valueAttr}" placeholder="${placeholder}" class="${finalClass}" ${readonlyAttr}>`;
        return `<div class="input-container">${labelHtml}${fieldHtml}</div>`;
    };
    const generateMainDataFormHtml = (item) => {
        let formHtml = `<h4 class="col-span-full text-lg font-semibold text-gray-800 border-b pb-2 mb-2">基本資料</h4><div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4">`;
        const fields = ["筆數", "銲接日期", "品名", "線徑", "適用規範", "配方", "RUD卡", "備註", "銲接人員", "銲接模式", "氣體", "鋼板材質", "電流", "電壓", "件別", "拉力棒加工人員", "衝擊片加工人員"]; // <-- 新增 '件別'
        const quickAddMapping = { '品名': '品名對規範', '銲接人員': '人員', '拉力棒加工人員': '人員', '衝擊片加工人員': '人員', '銲接模式': '銲材分類', '氣體': '氣體', '鋼板材質': '鋼板', '件別': '件別' }; // <-- 新增 '件別'
        const selectOptionsMapping = { '銲接人員': (db['人員']||[]).map(p => p.姓名), '拉力棒加工人員': (db['人員']||[]).map(p => p.姓名), '衝擊片加工人員': (db['人員']||[]).map(p => p.姓名), '品名': [...(db['品名對規範']||[])].sort((a, b) => String(a.品名).localeCompare(String(b.品名), 'zh-Hant')).map(p => p.品名), '適用規範': (db['規範']||[]).map(p => p.規範名稱), '銲接模式': (db['銲材分類']||[]).map(p => p.銲材分類), '氣體': (db['氣體']||[]).map(p => p.名稱), '鋼板材質': (db['鋼板']||[]).map(p => p.材質), '件別': (db['件別']||[]).map(p => p.件別名稱) }; // <-- 新增 '件別'
        fields.forEach(field => {
            const value = item[field] || ''; const colSpan = (field === '適用規範' || field === '備註') ? 'md:col-span-2' : 'col-span-1';
            let fieldOptions = { type: 'text' }; if (selectOptionsMapping[field]) { fieldOptions.isSelect = true; fieldOptions.selectOptions = selectOptionsMapping[field]; } if (field === '銲接日期') { fieldOptions.type = 'date'; }
            const quickAddTable = quickAddMapping[field];
            if (quickAddTable) { formHtml += `<div class="${colSpan}"><div class="flex items-center justify-between"><label class="block text-sm font-medium text-gray-700 mb-1">${field}</label><button type="button" class="quick-add-btn text-sm text-blue-500 hover:text-blue-700 font-semibold" data-table="${quickAddTable}" data-field="${field}">+ 新增</button></div>${createFormField(field, value, 'text', { ...fieldOptions, noLabel: true })}</div>`; } else { formHtml += `<div class="${colSpan}">${createFormField(field, value, fieldOptions.type, fieldOptions)}</div>`; }
        });
        formHtml += `</div><h4 class="col-span-full text-lg font-semibold text-gray-800 border-b pb-2 mt-6 mb-2">測試結果</h4><div id="test-results-container" class="space-y-4">${createTestSetContainerHTML('mechanical', '拉力實測')}${createTestSetContainerHTML('impact', '衝擊實測')}${createTestSetContainerHTML('hardness', '硬度實測')}${createTestSetContainerHTML('chemical', '成份實測')}</div>`;
        return formHtml;
    };
    window.openFormModal = (tableName, docId = null) => {
        state.editingDocId = docId; state.editingTableName = tableName;
        const data = db[tableName]; const item = docId ? data.find(d => d._docId === docId) : {};
        modalTitle.textContent = `${docId ? '編輯' : '新增'} ${tableName}`;
        modalForm.innerHTML = ''; modalForm.className = 'space-y-4 max-h-[75vh] overflow-y-auto p-2';
        modalDialog.className = 'relative mx-auto p-6 border w-full shadow-lg rounded-xl bg-white modal-content-2xl';
        saveModalBtn.dataset.tableName = tableName;
        if (tableName === '規範') {
            modalDialog.classList.remove('modal-content-2xl'); modalDialog.classList.add('modal-content-7xl');
            modalForm.innerHTML = generateSettingsFormHtml(tableName, item);
        } else if (tableName === '資料') {
            modalDialog.classList.remove('modal-content-2xl'); modalDialog.classList.add('modal-content-7xl');
            if (!docId && db['資料']) { 
                item['筆數'] = getNextGroupId(db['資料']);
                item['銲接日期'] = new Date().toISOString().split('T')[0]; 
            }
            modalForm.innerHTML = generateMainDataFormHtml(item);
            populateTestData(item, modalForm); setTimeout(() => validateAllFormFields(modalForm), 100);
        } else {
            modalForm.innerHTML = generateSettingsFormHtml(tableName, item);
        }
        formModal.classList.remove('hidden');
    };
    const closeFormModal = () => { formModal.classList.add('hidden'); state.editingDocId = null; state.editingTableName = null; };
    const openConfirmModal = (onConfirm) => { confirmModal.classList.remove('hidden'); const oldBtn = document.getElementById('confirmDeleteBtn'); const newBtn = oldBtn.cloneNode(true); oldBtn.parentNode.replaceChild(newBtn, oldBtn); newBtn.onclick = () => { onConfirm(); closeConfirmModal(); }; };
    const closeConfirmModal = () => confirmModal.classList.add('hidden');

    const openQuickAddModal = (tableName, targetField, sourceForm) => {
        quickAddState = { tableName, targetField, sourceForm };
        quickAddTitle.textContent = `快速新增 - ${tableName}`;
        const headers = defaultHeaders[tableName] || [];
        if (headers.length === 0) {
            showToast('此項目不支援快速新增', 'error');
            return;
        }

        let formHtml = '';
        if (tableName === '品名對規範') {
             formHtml = headers.map(header => {
                if (header === '預設適用規範') {
                    const specOptions = (db['規範'] || []).map(s => s.規範名稱);
                    return createFormField(header, '', 'text', { isSelect: true, selectOptions: specOptions });
                }
                if (header === '預設銲材分類') {
                    const classificationOptions = (db['銲材分類'] || []).map(s => s.銲材分類);
                    return createFormField(header, '', 'text', { isSelect: true, selectOptions: classificationOptions });
                }
                return createFormField(header, '');
            }).join('');
        } else {
            formHtml = headers.map(header => createFormField(header, '')).join('');
        }
        
        quickAddForm.innerHTML = formHtml;
        quickAddModal.classList.remove('hidden');
    };

    const createTestSetContainerHTML = (type, title) => { const checkboxHtml = (type === 'mechanical' || type === 'impact') ? `<label class="flex items-center text-sm cursor-pointer"><input type="checkbox" name="${type}_doNotTest" class="do-not-test-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">不做測試</label>` : ''; return `<div class="p-3 border rounded-lg"><div class="flex justify-between items-center mb-2"><h5 class="font-semibold">${title}</h5><div class="flex items-center space-x-4">${checkboxHtml}<button type="button" class="add-set-btn text-sm btn btn-secondary py-1 px-3" data-type="${type}">＋ 新增一組</button></div></div><div id="${type}-sets-container" class="space-y-3"></div></div>`; };
    const createMechanicalSetHTML = (data = {}) => `<div class="test-set grid grid-cols-3 gap-2 p-2 border-t">${createFormField('抗拉強度', data['抗拉強度'], 'text', { label: '抗拉強度(Mpa)' })}${createFormField('降伏強度', data['降伏強度'], 'text', { label: '降伏強度(Mpa)' })}${createFormField('延伸率', data['延伸率'], 'text', { label: '延伸率(%)' })}</div>`;
    const createImpactSetHTML = (data = {}) => { data.實測值 = data.實測值 || []; return `<div class="test-set p-2 border-t"><div class="grid grid-cols-8 gap-2 items-end">${createFormField('衝擊_溫度', data['測試溫度'], 'text', { label: '溫度' })}${createFormField('衝擊_單位', data['單位'], 'text', { label: '單位' })}${[0,1,2,3,4].map(i => createFormField(`衝擊_數值_${i+1}`, data.實測值[i], 'text', { label: `數值${i+1}`, inputClass: 'impact-value' })).join('')}${createFormField('衝擊_平均', data['平均值'], 'text', { label: '平均', isReadonly: true })}</div></div>`; };
    const createHardnessSetHTML = (data = {}) => { data.實測值 = data.實測值 || []; return `<div class="test-set grid grid-cols-8 gap-2 items-end p-2 border-t">${createFormField('硬度_單位', data['單位'], 'text', { label: '單位' })}${[0,1,2,3,4].map(i => createFormField(`硬度_數值_${i+1}`, data.實測值[i], 'text', { label: `數值${i+1}` })).join('')}</div>`; };
    const createChemicalSetHTML = (data = {}) => { const chemElements = CHEM_ELEMENTS_ORDER; return `<div class="test-set grid grid-cols-4 md:grid-cols-8 gap-x-4 gap-y-2 p-2 border-t">${chemElements.map(el => createFormField(`化學_${el}`, data[el] || '', 'text', { label: el })).join('')}</div>`; };
    const populateTestData = (item, formElement) => { const addAndPopulate = (type, dataArray, createHTMLFunc) => { const container = formElement.querySelector(`#${type}-sets-container`); const doNotTestCheckbox = formElement.querySelector(`[name="${type}_doNotTest"]`); container.innerHTML = ''; let doNotTest = false; if (dataArray && dataArray.length > 0 && dataArray[0].doNotTest) { doNotTest = true; } if (doNotTestCheckbox) { doNotTestCheckbox.checked = doNotTest; } if (dataArray && dataArray.length > 0) { dataArray.forEach(data => container.insertAdjacentHTML('beforeend', createHTMLFunc(data))); } else { container.insertAdjacentHTML('beforeend', createHTMLFunc({})); } if (doNotTestCheckbox) { doNotTestCheckbox.dispatchEvent(new Event('change', { bubbles: true })); } }; try { addAndPopulate('mechanical', JSON.parse(item['機械性質'] || '[]'), createMechanicalSetHTML); } catch(e) { addAndPopulate('mechanical', [{}], createMechanicalSetHTML); } try { addAndPopulate('impact', JSON.parse(item['衝擊測試'] || '[]'), createImpactSetHTML); } catch(e) { addAndPopulate('impact', [{}], createImpactSetHTML); } try { addAndPopulate('hardness', JSON.parse(item['硬度測試'] || '[]'), createHardnessSetHTML); } catch(e) { addAndPopulate('hardness', [{}], createHardnessSetHTML); } try { addAndPopulate('chemical', JSON.parse(item['化學成分'] ? `[${item['化學成分']}]` : '[]'), createChemicalSetHTML); } catch(e) { addAndPopulate('chemical', [{}], createChemicalSetHTML); } };
    const calculateImpactAverage = (setElement) => { const valueInputs = setElement.querySelectorAll('.impact-value'); const averageInput = setElement.querySelector('input[name="衝擊_平均"]'); let values = Array.from(valueInputs).map(input => parseFloat(input.value)).filter(v => !isNaN(v)); if (values.length < 3) { if (values.length > 0) { const sum = values.reduce((a, b) => a + b, 0); averageInput.value = (sum / values.length).toFixed(1); } else { averageInput.value = ''; } } else { values.sort((a, b) => a - b); const valuesToAverage = values.slice(1, -1); const sum = valuesToAverage.reduce((a, b) => a + b, 0); averageInput.value = (sum / valuesToAverage.length).toFixed(1); } averageInput.dispatchEvent(new Event('input', { bubbles: true })); };
    const validateFormField = (inputElement, specName, property) => { if (!inputElement) return; const result = getValidationResult(specName, property, inputElement.value); inputElement.classList.remove('invalid-field'); const container = inputElement.closest('.input-container'); const existingTooltip = container.querySelector('.validation-tooltip'); if (existingTooltip) existingTooltip.remove(); if (!result.isValid && result.message) { inputElement.classList.add('invalid-field'); const tooltip = document.createElement('div'); tooltip.className = 'validation-tooltip'; tooltip.textContent = result.message; container.appendChild(tooltip); } };
    const validateAllFormFields = (form) => { const specName = form.querySelector('[name="適用規範"]')?.value; if (!specName) return; form.querySelectorAll('#mechanical-sets-container .test-set').forEach(set => { validateFormField(set.querySelector('[name="抗拉強度"]'), specName, '抗拉強度'); validateFormField(set.querySelector('[name="降伏強度"]'), specName, '降伏強度'); validateFormField(set.querySelector('[name="延伸率"]'), specName, '延伸率'); }); form.querySelectorAll('#impact-sets-container .test-set').forEach(set => { validateFormField(set.querySelector('[name="衝擊_平均"]'), specName, '衝擊'); set.querySelectorAll('.impact-value').forEach(input => validateFormField(input, specName, '衝擊')); }); form.querySelectorAll('#chemical-sets-container .test-set').forEach(set => { const chemElements = CHEM_ELEMENTS_ORDER; chemElements.forEach(el => validateFormField(set.querySelector(`[name="化學_${el}"]`), specName, el)); }); };

    // --- 事件監聽 (部分修改以適應 Firebase) ---
    const switchTab = (tabName) => {
        state.currentPage = tabName;
        [mainPage, settingsPage, statsReportPage].forEach(p => p.classList.add('hidden'));
        [mainTab, settingsTab, statsReportTab].forEach(t => t.classList.remove('active'));
        if (tabName === 'main') { 
            mainPage.classList.remove('hidden'); 
            mainTab.classList.add('active'); 
            renderDataTable(); // <--- 新增這一行
        } 
        else if (tabName === 'settings') { settingsPage.classList.remove('hidden'); settingsTab.classList.add('active'); renderSettingsButtons(); settingsContentDisplay.innerHTML = '<p class="text-gray-500 text-center py-8">請從上方選擇一個設定項目進行管理。</p>'; } 
        else if (tabName === 'stats-report') { statsReportPage.classList.remove('hidden'); statsReportTab.classList.add('active'); }
    };

    mainTab.addEventListener('click', () => switchTab('main'));
    settingsTab.addEventListener('click', () => switchTab('settings'));
    statsReportTab.addEventListener('click', () => switchTab('stats-report'));

    searchInput.addEventListener('input', (e) => { state.searchTerm = e.target.value; state.currentPageNumber = 1; renderDataTable(); });
    settingsButtonsContainer.addEventListener('click', (e) => { if (e.target.closest('button')) renderSettingsContent(e.target.closest('button').dataset.table); });
    addDataBtn.addEventListener('click', () => openFormModal('資料', null));
    closeModalBtn.addEventListener('click', closeFormModal);
    cancelModalBtn.addEventListener('click', closeFormModal);
    confirmCancelBtn.addEventListener('click', closeConfirmModal);

    quickAddCancelBtn.addEventListener('click', () => {
        quickAddModal.classList.add('hidden');
    });

    quickAddSaveBtn.addEventListener('click', async () => {
        const { tableName, targetField, sourceForm } = quickAddState;
        if (!tableName) return;
        
        const formData = new FormData(quickAddForm);
        const newEntry = {};
        let allFilled = true;
        let firstValue = '';
        for (let [key, value] of formData.entries()) {
            newEntry[key] = value;
            if (!value) allFilled = false;
            if (!firstValue) firstValue = value;
        }

        if (!allFilled) {
            showToast('請填寫所有欄位！', 'error');
            return;
        }
        
        showLoading('新增中...');
        try {
            const docRef = await addDoc(collection(firestoreDb, tableName), newEntry);
            showToast('新增成功', 'success');
            
            const targetSelect = sourceForm.querySelector(`[name="${targetField}"]`);
            if (targetSelect) {
                const newOption = document.createElement('option');
                newOption.value = firstValue;
                newOption.textContent = firstValue;
                targetSelect.appendChild(newOption);
                targetSelect.value = firstValue;
                targetSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }

            if (!db[tableName]) db[tableName] = [];
            db[tableName].push({ ...newEntry, _docId: docRef.id });

            quickAddModal.classList.add('hidden');
        } catch (error) {
            showToast(`新增失敗: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    });

    paginationContainer.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; if (button.id === 'prevPageBtn' && !button.disabled) { state.currentPageNumber--; renderDataTable(); } else if (button.id === 'nextPageBtn' && !button.disabled) { state.currentPageNumber++; renderDataTable(); } });

    dataTableHead.addEventListener('click', (e) => {
        const target = e.target; const th = target.closest('th.sortable-header');
        if (th && th.dataset.sortKey) { const key = th.dataset.sortKey; const nonSortableColumns = ['機械性質', '衝擊測試', '硬度測試', '化學成分']; if (nonSortableColumns.includes(key)) { showToast('此欄位不支援排序', 'error'); return; } if (state.sortKey === key) { state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc'; } else { state.sortKey = key; state.sortOrder = 'asc'; } renderDataTable(); }
        if (target.id === 'selectAllCheckbox') { const isChecked = target.checked; const checkboxes = dataTableBody.querySelectorAll('.row-checkbox'); checkboxes.forEach(checkbox => { checkbox.checked = isChecked; const docId = checkbox.dataset.id; if (isChecked) { if (!state.selectedRowIds.includes(docId)) { state.selectedRowIds.push(docId); } } else { const index = state.selectedRowIds.indexOf(docId); if (index > -1) { state.selectedRowIds.splice(index, 1); } } }); generateReportBtn.disabled = state.selectedRowIds.length === 0; }
    });

    dataTableBody.addEventListener('click', e => {
        if (e.target.classList.contains('row-checkbox')) {
            const checkbox = e.target; const docId = checkbox.dataset.id;
            if (checkbox.checked) { if (!state.selectedRowIds.includes(docId)) { state.selectedRowIds.push(docId); } } else { const index = state.selectedRowIds.indexOf(docId); if (index > -1) { state.selectedRowIds.splice(index, 1); } }
            generateReportBtn.disabled = state.selectedRowIds.length === 0;
        }
    });

    const getFormDataFromModal = (formElement) => {
        const formData = new FormData(formElement); const newEntry = {};
        for (let [key, value] of formData.entries()) { if (!key.startsWith('衝擊_') && !key.startsWith('硬度_') && !key.startsWith('化學_') && !key.endsWith('_doNotTest') && !['抗拉強度', '降伏強度', '延伸率'].includes(key)) { newEntry[key] = value; } }
        const mechDoNotTest = formElement.querySelector('[name="mechanical_doNotTest"]')?.checked || false; newEntry['機械性質'] = JSON.stringify(Array.from(formElement.querySelectorAll('#mechanical-sets-container .test-set')).map(set => ({ '抗拉強度': set.querySelector('[name="抗拉強度"]').value, '降伏強度': set.querySelector('[name="降伏強度"]').value, '延伸率': set.querySelector('[name="延伸率"]').value, 'doNotTest': mechDoNotTest })));
        const impactDoNotTest = formElement.querySelector('[name="impact_doNotTest"]')?.checked || false; newEntry['衝擊測試'] = JSON.stringify(Array.from(formElement.querySelectorAll('#impact-sets-container .test-set')).map(set => ({ '測試溫度': set.querySelector('[name="衝擊_溫度"]').value, '單位': set.querySelector('[name="衝擊_單位"]').value, '實測值': [0,1,2,3,4].map(i => set.querySelector(`[name="衝擊_數值_${i+1}"]`).value).filter(v => v), '平均值': set.querySelector('[name="衝擊_平均"]').value, 'doNotTest': impactDoNotTest })));
        newEntry['硬度測試'] = JSON.stringify(Array.from(formElement.querySelectorAll('#hardness-sets-container .test-set')).map(set => ({ '單位': set.querySelector('[name="硬度_單位"]').value, '實測值': [0,1,2,3,4].map(i => set.querySelector(`[name="硬度_數值_${i+1}"]`).value).filter(v => v) })));
        const chemElements = CHEM_ELEMENTS_ORDER; newEntry['化學成分'] = JSON.stringify(Array.from(formElement.querySelectorAll('#chemical-sets-container .test-set')).map(set => { const data = {}; chemElements.forEach(el => { const val = set.querySelector(`[name="化學_${el}"]`).value; if (val) data[el] = val; }); return data; })[0] || {});
        return newEntry;
    };
    
    // --- Firestore CRUD 事件綁定 ---
    saveModalBtn.addEventListener('click', async (e) => {
        const tableName = e.currentTarget.dataset.tableName; if (!tableName) return;
        showLoading('儲存中...');
        let newEntry = {};
        if (tableName === '資料') { newEntry = getFormDataFromModal(modalForm); } else { const formData = new FormData(modalForm); for (let [key, value] of formData.entries()) newEntry[key] = value; }
        try {
            if (state.editingDocId) {
                // 更新
                const docRef = doc(firestoreDb, tableName, state.editingDocId);
                await updateDoc(docRef, newEntry);
                showToast('更新成功', 'success');
            } else {
                // 新增
                if (tableName !== '資料') {
                    const newSortOrder = (db[tableName] || []).length;
                    newEntry.sortOrder = newSortOrder;
                }

                if (tableName === '資料' && newEntry['筆數']) {
                    const newGroupId = String(newEntry['筆數']);
                    const existingRecord = db['資料'].find(d => String(d['筆數']) === newGroupId);
                    let docRef;

                    if (existingRecord) {
                        // If it exists, get its actual docId to merge data
                        docRef = doc(firestoreDb, tableName, existingRecord._docId);
                    } else {
                        // If it doesn't exist, create a new document with the 筆數 as the ID
                        docRef = doc(firestoreDb, tableName, newGroupId);
                    }
                    await setDoc(docRef, newEntry, { merge: true });
                    showToast('新增/合併成功', 'success');

                } else {
                    await addDoc(collection(firestoreDb, tableName), newEntry);
                    showToast('新增成功', 'success');
                }
            }
            closeFormModal();
            // onSnapshot 會自動更新畫面，此處不需手動 re-render
        } catch (error) { 
            console.error("Save error: ", error);
            showToast(`儲存失敗: ${error.message}`, 'error'); 
        } finally { 
            hideLoading(); 
        }
    });

    // --- 新增：表單連動邏輯 ---
    document.body.addEventListener('change', e => {
        const target = e.target;
        const currentForm = target.closest('form');
        if (!currentForm) return;

        // 當「品名」變更時，自動帶入對應的「適用規範」和「銲接模式」
        if (target.name === '品名') {
            const selectedProductName = target.value;
            if (!selectedProductName) return;

            const specMapping = db['品名對規範']?.find(item => item.品名 === selectedProductName);
            if (specMapping) {
                const specSelect = currentForm.querySelector('[name="適用規範"]');
                const classificationSelect = currentForm.querySelector('[name="銲接模式"]');

                if (specSelect && specMapping['預設適用規範']) {
                    specSelect.value = specMapping['預設適用規範'];
                    // 手動觸發 change 事件以更新相關驗證
                    specSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
                if (classificationSelect && specMapping['預設銲材分類']) {
                    classificationSelect.value = specMapping['預設銲材分類'];
                }
            }
        }

        // 當「適用規範」變更時，重新驗證所有測試欄位
        if (target.name === '適用規範') {
            validateAllFormFields(currentForm);
        }
    });

    document.body.addEventListener('click', async (e) => {
        const target = e.target;
        if (target.classList.contains('edit-btn')) { openFormModal(target.dataset.table, target.dataset.id); }
        if (target.classList.contains('delete-btn')) {
            const docId = target.dataset.id; const tableName = target.dataset.table;
            openConfirmModal(async () => {
                showLoading('刪除中...');
                try {
                    await deleteDoc(doc(firestoreDb, tableName, docId));
                    showToast('刪除成功', 'success');
                    // onSnapshot 會自動更新畫面
                } catch (error) { showToast(`刪除失敗: ${error.message}`, 'error'); } finally { hideLoading(); }
            });
        }
        if (target.classList.contains('add-inline-btn')) {
            const tableName = target.dataset.table; const addRow = document.getElementById(`add-row-${tableName}`); if (!addRow) return;
            const inputs = addRow.querySelectorAll('input, select'); const newEntry = {}; let allFilled = true;
            inputs.forEach(input => { newEntry[input.name] = input.value; if (!input.value && tableName !== '規範') allFilled = false; });
            if (tableName === '品名對規範') { const newName = (newEntry.品名 || '').trim(); if (!newName) { showToast('品名不得為空！', 'error'); return; } if (db['品名對規範'].some(item => item.品名 === newName)) { showToast('此品名已存在，請勿重複新增！', 'error'); return; } }
            if (!allFilled) { showToast('請填寫所有欄位！', 'error'); return; }
            
            const newSortOrder = (db[tableName] || []).length;
            newEntry.sortOrder = newSortOrder;

            showLoading('新增中...');
            try {
                await addDoc(collection(firestoreDb, tableName), newEntry);
                showToast('新增成功', 'success');
                // onSnapshot 會自動更新畫面
            } catch (error) { showToast(`新增失敗: ${error.message}`, 'error'); } finally { hideLoading(); }
        }
        if (target.classList.contains('add-set-btn')) { const type = target.dataset.type; const container = target.closest('form').querySelector(`#${type}-sets-container`); let html = ''; if (type === 'mechanical') html = createMechanicalSetHTML(); else if (type === 'impact') html = createImpactSetHTML(); else if (type === 'hardness') html = createHardnessSetHTML(); else if (type === 'chemical') html = createChemicalSetHTML(); container.insertAdjacentHTML('beforeend', html); }
        if (target.classList.contains('quick-add-btn')) { openQuickAddModal(target.dataset.table, target.dataset.field, target.closest('form')); }
    });
    settingsContentDisplay.addEventListener('click', (e) => {
        if (e.target.id === 'settings-quick-edit-btn') {
            openSettingsQuickEditModal(e.target.dataset.table);
        }
    });

    toggleExtraColumnsBtn.addEventListener('click', () => {
        state.showExtraColumns = !state.showExtraColumns;
        if (state.showExtraColumns) {
            iconShowMore.classList.add('hidden');
            iconShowLess.classList.remove('hidden');
            toggleExtraColumnsBtn.title = '隱藏額外欄位';
        } else {
            iconShowMore.classList.remove('hidden');
            iconShowLess.classList.add('hidden');
            toggleExtraColumnsBtn.title = '顯示額外欄位';
        }
        renderDataTable();
    });
    
    // --- 快速編輯 Modal 邏輯 (使用 Firestore) ---
    quickEditSaveBtn.addEventListener('click', async () => {
        const currentId = recordSelector.value; if (!currentId) return;
        showLoading('儲存中...'); const newEntry = getFormDataFromModal(quickEditForm);
        try {
            const docRef = doc(firestoreDb, '資料', currentId);
            await updateDoc(docRef, newEntry);
            showToast('更新成功', 'success');
            // onSnapshot 會自動更新畫面
        } catch (error) { showToast(`儲存失敗: ${error.message}`, 'error'); } finally { hideLoading(); }
    });

    // --- 新增：設定頁的快速編輯 Modal 邏輯 ---
    const generateSettingsFormHtml = (tableName, item = {}) => {
        if (tableName === '規範') {
            const chemElements = CHEM_ELEMENTS_ORDER;
            const strengthHtml = `<div class="p-3 border rounded-lg"><h4 class="text-base font-semibold text-gray-800 mb-3">強度要求</h4><div class="space-y-2"><div class="grid grid-cols-3 gap-x-2"><div></div><div class="text-xs font-medium text-gray-500 text-center">上限</div><div class="text-xs font-medium text-gray-500 text-center">下限</div></div><div class="grid grid-cols-3 gap-x-2 items-center"><div class="text-sm font-medium text-gray-700">抗拉強度 (Mpa)</div>${createFormField('抗拉強度_最高', item['抗拉強度_最高'] || '', 'text', { noLabel: true, placeholder: 'Max', inputClass: 'text-sm p-1' })}${createFormField('抗拉強度_最低', item['抗拉強度_最低'] || '', 'text', { noLabel: true, placeholder: 'Min', inputClass: 'text-sm p-1' })}</div><div class="grid grid-cols-3 gap-x-2 items-center"><div class="text-sm font-medium text-gray-700">降伏強度 (Mpa)</div>${createFormField('降伏強度_最高', item['降伏強度_最高'] || '', 'text', { noLabel: true, placeholder: 'Max', inputClass: 'text-sm p-1' })}${createFormField('降伏強度_最低', item['降伏強度_最低'] || '', 'text', { noLabel: true, placeholder: 'Min', inputClass: 'text-sm p-1' })}</div><div class="grid grid-cols-3 gap-x-2 items-center"><div class="text-sm font-medium text-gray-700">延伸率 (%)</div><div class="col-span-2">${createFormField('延伸率_下限', item['延伸率_下限'] || '', 'text', { noLabel: true, placeholder: 'Min', inputClass: 'text-sm p-1' })}</div></div></div></div>`;
            const impactHtml = `<div class="p-3 border rounded-lg"><h4 class="text-base font-semibold text-gray-800 mb-3">衝擊要求</h4><div class="grid grid-cols-3 gap-2">${createFormField('衝擊溫度需求', item['衝擊溫度需求'] || '', 'text', { label: '溫度數值', inputClass: 'text-sm p-1' })}${createFormField('衝擊溫度單位', item['衝擊溫度單位'] || '', 'text', { label: '溫度單位', inputClass: 'text-sm p-1' })}${createFormField('衝擊要求數據', item['衝擊要求數據'] || '', 'text', { label: '要求數值', inputClass: 'text-sm p-1' })}</div></div>`;
            const chemHtml = `<div class="p-3 border rounded-lg"><h4 class="text-base font-semibold text-gray-800 mb-3">成份要求</h4><div class="grid grid-cols-4 md:grid-cols-8 gap-x-2 gap-y-3">${chemElements.map(el => `<div class="text-center"><label class="text-sm font-medium text-gray-700">${el}</label><div class="mt-1 space-y-1">${createFormField(`${el}_最高`, item[`${el}_最高`] || '', 'text', { noLabel: true, placeholder: '上限', inputClass: 'text-xs p-1' })}${createFormField(`${el}_最低`, item[`${el}_最低`] || '', 'text', { noLabel: true, placeholder: '下限', inputClass: 'text-xs p-1' })}</div></div>`).join('')}</div></div>`;
            
            return `<div class="space-y-4">
                        ${createFormField('規範名稱', item['規範名稱'] || '', 'text', { label: '規範名稱' })}
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                            <div class="lg:col-span-2 space-y-4">
                                ${strengthHtml}
                                ${impactHtml}
                            </div>
                            <div class="lg:col-span-3">
                                ${chemHtml}
                            </div>
                        </div>
                    </div>`;
        } else {
            const data = db[tableName];
            if (!data || data.length === 0) return '';
            const headers = Object.keys(data[0]).filter(h => h !== '_docId');
            let formHtml = '';
            headers.forEach(header => {
                 if (tableName === '品名對規範' && header === '預設適用規範') {
                    formHtml += createFormField(header, item[header] || '', 'text', { isSelect: true, selectOptions: (db['規範']||[]).map(s => s.規範名稱) });
                 } else if (tableName === '品名對規範' && header === '預設銲材分類') {
                    formHtml += createFormField(header, item[header] || '', 'text', { isSelect: true, selectOptions: (db['銲材分類']||[]).map(c => c.銲材分類) });
                 } else {
                    formHtml += createFormField(header, item[header] || '');
                 }
            });
            return formHtml;
        }
    };
    const openSettingsQuickEditModal = (tableName) => {
        if (!db[tableName] || db[tableName].length === 0) { showToast('沒有可編輯的資料', 'error'); return; }
        state.settingsQuickEditTableName = tableName;
        settingsQuickEditTitle.textContent = `快速編輯 - ${tableName}`;
        const primaryKey = (tableName === '規範') ? '規範名稱' : '品名';
        const sortedRecords = sortDataByKey(db[tableName], primaryKey, 'asc');
        state.settingsQuickEditSortedIds = sortedRecords.map(r => r._docId);
        settingsRecordSelector.innerHTML = sortedRecords.map(r => `<option value="${r._docId}">${r[primaryKey]}</option>`).join('');
        settingsQuickEditModal.classList.remove('hidden');
        if (state.settingsQuickEditSortedIds.length > 0) {
            const firstId = state.settingsQuickEditSortedIds[0];
            settingsRecordSelector.value = firstId;
            loadRecordIntoSettingsQuickEditForm(firstId);
        }
    };
    const loadRecordIntoSettingsQuickEditForm = (docId) => {
        const tableName = state.settingsQuickEditTableName;
        const record = db[tableName].find(r => r._docId === docId);
        if (!record) { showToast('找不到該筆資料', 'error'); return; }
        state.settingsQuickEditCurrentIndex = state.settingsQuickEditSortedIds.findIndex(id => id === docId);
        settingsQuickEditForm.innerHTML = generateSettingsFormHtml(tableName, record);
        settingsPrevRecordBtn.disabled = state.settingsQuickEditCurrentIndex <= 0;
        settingsNextRecordBtn.disabled = state.settingsQuickEditCurrentIndex >= state.settingsQuickEditSortedIds.length - 1;
    };
    settingsQuickEditSaveBtn.addEventListener('click', async () => {
        const tableName = state.settingsQuickEditTableName;
        const currentId = settingsRecordSelector.value;
        if (!tableName || !currentId) return;
        showLoading('儲存中...');
        const formData = new FormData(settingsQuickEditForm);
        const newEntry = {};
        for (let [key, value] of formData.entries()) { newEntry[key] = value; }
        try {
            const docRef = doc(firestoreDb, tableName, currentId);
            await updateDoc(docRef, newEntry);
            showToast('更新成功', 'success');
        } catch (error) { showToast(`儲存失敗: ${error.message}`, 'error'); } finally { hideLoading(); }
    });
    settingsRecordSelector.addEventListener('change', (e) => loadRecordIntoSettingsQuickEditForm(e.target.value));
    settingsPrevRecordBtn.addEventListener('click', () => { if (state.settingsQuickEditCurrentIndex > 0) { state.settingsQuickEditCurrentIndex--; const newId = state.settingsQuickEditSortedIds[state.settingsQuickEditCurrentIndex]; settingsRecordSelector.value = newId; loadRecordIntoSettingsQuickEditForm(newId); } });
    settingsNextRecordBtn.addEventListener('click', () => { if (state.settingsQuickEditCurrentIndex < state.settingsQuickEditSortedIds.length - 1) { state.settingsQuickEditCurrentIndex++; const newId = state.settingsQuickEditSortedIds[state.settingsQuickEditCurrentIndex]; settingsRecordSelector.value = newId; loadRecordIntoSettingsQuickEditForm(newId); } });
    settingsQuickEditCloseBtn.addEventListener('click', () => settingsQuickEditModal.classList.add('hidden'));
    settingsQuickEditCancelBtn.addEventListener('click', () => settingsQuickEditModal.classList.add('hidden'));

    
    // --- 資料匯入功能 (使用 Firestore) ---
    startImportBtn.addEventListener('click', async () => {
        const jsonText = importDataTextarea.value; if (!jsonText) { showToast('請貼上 JSON 資料', 'error'); return; }
        
        let rawData;
        try { 
            rawData = JSON.parse(jsonText); 
        } catch (error) { 
            showToast(`JSON 解析錯誤: ${error.message}`, 'error'); 
            importResults.innerHTML = `<p class="text-red-500">JSON 解析錯誤: ${error.message}</p>`; 
            return; 
        }

        let importPlan;

        // --- NEW: 自動格式轉換邏輯 ---
        // 檢查是否為簡化格式 (array of objects with groupId)
        if (Array.isArray(rawData) && rawData.length > 0 && rawData[0].hasOwnProperty('groupId') && rawData[0].hasOwnProperty('data')) {
            showToast('偵測到簡化格式，正在自動轉換...', 'success');
            try {
                const transformedData = rawData.map(item => {
                    const newItem = { '筆數': String(item.groupId) }; // 確保筆數永遠是字串
                    
                    if (item.data) {
                        // 處理化學成分 - 只有當來源有資料時才加入
                        if (item.data['化學成分'] && Object.keys(item.data['化學成分']).length > 0) {
                           newItem['化學成分'] = JSON.stringify(item.data['化學成分']);
                        }

                        // 處理機械性質 - 只有當來源有資料時才加入
                        const mechanical = item.data['機械性質'];
                        if (mechanical && Object.keys(mechanical).length > 0) {
                           newItem['機械性質'] = JSON.stringify([mechanical]);
                        }

                        // 處理衝擊測試 - 只有當來源有資料時才加入
                        const impactTests = item.data['衝擊測試'] || item.data['衝擊試驗'];
                        if (impactTests && Array.isArray(impactTests) && impactTests.length > 0) {
                            const cleanedImpactTests = impactTests.filter(t => typeof t === 'object' && t.hasOwnProperty('實測值'));
                            if (cleanedImpactTests.length > 0) {
                                newItem['衝擊測試'] = JSON.stringify(cleanedImpactTests);
                            }
                        }
                    }

                    // 根據使用者要求，不再將 sourceFiles 自動填入備註
                    // if (item.sourceFiles && item.sourceFiles.length > 0) {
                    //     newItem['備註'] = `來源檔案: ${item.sourceFiles.join(', ')}`;
                    // }

                    return newItem;
                });

                importPlan = [{
                    "collection": "資料",
                    "docIdField": "筆數",
                    "data": transformedData
                }];

            } catch (transformError) {
                showToast(`資料轉換失敗: ${transformError.message}`, 'error');
                importResults.innerHTML = `<p class="text-red-500">資料轉換失敗: ${transformError.message}</p>`;
                return;
            }
        } else {
            // 維持原有格式的處理方式
            importPlan = rawData;
        }
        
        if (!Array.isArray(importPlan)) {
             showToast('JSON 格式錯誤，應為陣列 (Array)', 'error'); 
             importResults.innerHTML = `<p class="text-red-500">JSON 格式錯誤，應為陣列 (Array)</p>`; 
             return;
        }

        showLoading(`準備匯入資料...`);
        importResults.innerHTML = '';
        let totalSuccessCount = 0;
        let totalErrorCount = 0;
        let operationsCount = 0;
        let batch = writeBatch(firestoreDb);

        // *** 新增：建立現有資料的 ID 映射表以處理舊資料 ***
        const existingDataMap = new Map();
        if (db['資料']) {
            db['資料'].forEach(doc => {
                if (doc['筆數']) {
                    existingDataMap.set(String(doc['筆數']), doc._docId);
                }
            });
        }

        for (const section of importPlan) {
            const collectionName = section.collection;
            const dataArray = section.data;
            const docIdField = section.docIdField; // e.g., '筆數'

            if (!collectionName || !Array.isArray(dataArray)) {
                totalErrorCount++;
                importResults.innerHTML += `<p><span class="font-bold text-red-500">[格式錯誤]</span> 找不到 collection 或 data 陣列。</p>`;
                continue;
            }

            importResults.innerHTML += `<p>正在處理集合: <span class="font-bold">${collectionName}</span> (${dataArray.length} 筆)</p>`;

            for (const itemData of dataArray) {
                try {
                    let docRef;
                    const docIdFieldValue = itemData[docIdField] ? String(itemData[docIdField]) : null;

                    if (collectionName === '資料' && docIdFieldValue) {
                        if (existingDataMap.has(docIdFieldValue)) {
                            // 找到現有資料，使用其真實的 docId
                            const existingDocId = existingDataMap.get(docIdFieldValue);
                            docRef = doc(firestoreDb, collectionName, existingDocId);
                        } else {
                            // 找不到，是全新資料，使用 "筆數" 作為 docId
                            docRef = doc(firestoreDb, collectionName, docIdFieldValue);
                        }
                    } else if (docIdFieldValue) {
                         // 其他集合，維持原有邏輯
                        docRef = doc(firestoreDb, collectionName, docIdFieldValue);
                    } else {
                        // 沒有 ID 欄位，自動產生 ID
                        docRef = doc(collection(firestoreDb, collectionName));
                    }
                    
                    batch.set(docRef, itemData, { merge: true });
                    operationsCount++;
                    totalSuccessCount++;

                    // Firestore 的批次寫入有 500 次操作的上限
                    if (operationsCount >= 499) {
                        await batch.commit();
                        batch = writeBatch(firestoreDb); // 建立新的批次
                        operationsCount = 0;
                        importResults.innerHTML += `<p class="text-gray-500 italic">...已提交一批 500 筆操作...</p>`;
                    }
                } catch (e) {
                    totalErrorCount++;
                }
            }
        }

        try {
            if (operationsCount > 0) {
                await batch.commit(); // 提交最後剩餘的批次
            }
            const finalMessage = `匯入完成！成功處理 ${totalSuccessCount} 筆，失敗 ${totalErrorCount} 筆。`;
            importResults.innerHTML += `<p class="font-bold text-green-500 mt-2">${finalMessage}</p>`;
            showToast(finalMessage, 'success');
        } catch(error) {
            console.error("Batch import error:", error);
            const errorMessage = `批次匯入失敗: ${error.message}`;
            showToast(errorMessage, 'error');
            importResults.innerHTML += `<p class="font-bold text-red-500">${errorMessage}</p>`;
        } finally {
            hideLoading();
        }
    });

    // --- 其餘未修改的函式 (快速編輯導航、報表產生等) ---
    const loadRecordIntoQuickEditForm = (docId) => { const record = db['資料'].find(r => r._docId === docId); if (!record) { showToast('找不到該筆資料', 'error'); return; } state.quickEditCurrentIndex = state.quickEditSortedIds.findIndex(id => id === docId); quickEditForm.innerHTML = generateMainDataFormHtml(record); populateTestData(record, quickEditForm); setTimeout(() => validateAllFormFields(quickEditForm), 100); prevRecordBtn.disabled = state.quickEditCurrentIndex <= 0; nextRecordBtn.disabled = state.quickEditCurrentIndex >= state.quickEditSortedIds.length - 1; pasteDataContainer.classList.add('hidden'); pasteDataTextarea.value = ''; };
    quickEditBtn.addEventListener('click', () => { if (!db['資料'] || db['資料'].length === 0) { showToast('沒有可編輯的資料', 'error'); return; } const sortedRecords = sortDataByKey(db['資料'], '筆數', 'desc'); state.quickEditSortedIds = sortedRecords.map(r => r._docId); recordSelector.innerHTML = sortedRecords.map(r => `<option value="${r._docId}">筆數: ${r['筆數']} - 品名: ${r['品名']} - 配方: ${r['配方'] || '無'} (${r['銲接日期']})</option>`).join(''); quickEditModal.classList.remove('hidden'); if (state.quickEditSortedIds.length > 0) { const firstId = state.quickEditSortedIds[0]; recordSelector.value = firstId; loadRecordIntoQuickEditForm(firstId); } });
    recordSelector.addEventListener('change', (e) => { const selectedId = e.target.value; loadRecordIntoQuickEditForm(selectedId); });
    prevRecordBtn.addEventListener('click', () => { if (state.quickEditCurrentIndex > 0) { state.quickEditCurrentIndex--; const newId = state.quickEditSortedIds[state.quickEditCurrentIndex]; recordSelector.value = newId; loadRecordIntoQuickEditForm(newId); } });
    nextRecordBtn.addEventListener('click', () => { if (state.quickEditCurrentIndex < state.quickEditSortedIds.length - 1) { state.quickEditCurrentIndex++; const newId = state.quickEditSortedIds[state.quickEditCurrentIndex]; recordSelector.value = newId; loadRecordIntoQuickEditForm(newId); } });
    quickEditCloseBtn.addEventListener('click', () => quickEditModal.classList.add('hidden'));
    quickEditCancelBtn.addEventListener('click', () => quickEditModal.classList.add('hidden'));
    togglePasteDataBtn.addEventListener('click', () => { pasteDataContainer.classList.toggle('hidden'); });
    applyPastedDataBtn.addEventListener('click', () => { const textToParse = pasteDataTextarea.value; if (!textToParse) { showToast('請先貼上資料', 'error'); return; } let parsedData; try { parsedData = JSON.parse(textToParse); if (!parsedData) { throw new Error("無法解析資料"); } populateFormWithParsedData(parsedData, quickEditForm); } catch (error) { console.error("Pasted data processing error:", error); showToast(`資料處理失敗: ${error.message}`, 'error'); } });
    displaySettingsBtn.addEventListener('click', () => { 
        const allColumns = getSortedColumns(db['資料']); 
        columnToggleContainer.innerHTML = allColumns.map(col => `<label class="flex items-center space-x-2"><input type="checkbox" class="column-toggle-checkbox rounded" value="${col}" ${state.visibleColumns.includes(col) ? 'checked' : ''}><span>${col}</span></label>`).join(''); 
        renderFilters(); 
        displaySettingsModal.classList.remove('hidden'); 
    });
    closeDisplaySettingsBtn.addEventListener('click', () => displaySettingsModal.classList.add('hidden'));
    addFilterBtn.addEventListener('click', () => { const allColumns = (db['資料'] && db['資料'].length > 0) ? Object.keys(db['資料'][0]).filter(k => k !== '_docId') : []; state.filters.push({ column: allColumns[0], operator: 'contains', value: '' }); renderFilters(); });
    filterContainer.addEventListener('click', (e) => { 
        const removeBtn = e.target.closest('.remove-filter-btn');
        if (removeBtn) {
            const ruleDiv = removeBtn.closest('.filter-rule');
            if (ruleDiv) {
                const index = parseInt(ruleDiv.dataset.index);
                if (!isNaN(index)) {
                    state.filters.splice(index, 1);
                    renderFilters();
                }
            }
        }
    });
    applyDisplaySettingsBtn.addEventListener('click', () => { 
        const allColumnsCanonical = getSortedColumns(db['資料']);
        const checkedValues = new Set(Array.from(columnToggleContainer.querySelectorAll('.column-toggle-checkbox:checked')).map(cb => cb.value));
        const selectedColumns = allColumnsCanonical.filter(col => checkedValues.has(col));

        if (selectedColumns.length === 0) { 
            showToast('至少必須選擇一個欄位顯示', 'error'); 
            return; 
        } 
        state.visibleColumns = selectedColumns; 
        localStorage.setItem('visibleColumns', JSON.stringify(state.visibleColumns)); 
        const newFilters = []; 
        filterContainer.querySelectorAll('.filter-rule').forEach(rule => { 
            newFilters.push({ 
                column: rule.querySelector('.filter-column').value, 
                operator: rule.querySelector('.filter-operator').value, 
                value: rule.querySelector('.filter-value').value, 
            }); 
        }); 
        state.filters = newFilters; 
        state.currentPageNumber = 1; 
        showToast('設定已套用', 'success'); 
        displaySettingsModal.classList.add('hidden'); 
        renderDataTable(); 
    });
    const getSpecRequirementString = (specName, property) => {
        if (!specName) return '-';
        const spec = db['規範'].find(s => s.規範名稱 === specName);
        if (!spec) return 'N/A';
        const minKey = property + '_最低',
              maxKey = property + '_最高',
              lowerLimitKey = property + '_下限',
              requiredValueKey = property + '要求數據';
        let requirement = '';

        const formatNumber = (val) => {
            if (val === null || val === undefined || val === '') return val;
            const num = Number(val);
            return isNaN(num) ? val : num;
        };

        if ((spec.hasOwnProperty(minKey) && spec[minKey] !== '' && spec[minKey] !== null) && (spec.hasOwnProperty(maxKey) && spec[maxKey] !== '' && spec[maxKey] !== null)) {
            requirement = `${formatNumber(spec[minKey])} - ${formatNumber(spec[maxKey])}`;
        } else if (spec.hasOwnProperty(minKey) && spec[minKey] !== '' && spec[minKey] !== null) {
            requirement = `≥ ${formatNumber(spec[minKey])}`;
        } else if (spec.hasOwnProperty(lowerLimitKey) && spec[lowerLimitKey] !== '' && spec[lowerLimitKey] !== null) {
            requirement = `≥ ${formatNumber(spec[lowerLimitKey])}`;
        } else if (spec.hasOwnProperty(requiredValueKey) && spec[requiredValueKey] !== '' && spec[requiredValueKey] !== null) {
            requirement = `≥ ${formatNumber(spec[requiredValueKey])}`;
        } else if (spec.hasOwnProperty(maxKey) && spec[maxKey] !== '' && spec[maxKey] !== null) {
            requirement = `≤ ${formatNumber(spec[maxKey])}`;
        } else {
            requirement = '-';
        }
        return requirement;
    };
    const getValidationCellsHtml = (specName, property, value, unit = '') => {
        if (value === null || value === undefined || value === '') return ['<td class="border border-black px-2 py-1 text-center">-</td>', '<td class="border border-black px-2 py-1 text-center">-</td>'];
        
        const result = getValidationResult(specName, property, value);
        const displayValue = `${value}${unit}`;
        let valueCell, resultCell;

        if (!result.hasSpec) {
            // No specification for this property, so just display the value and no result.
            valueCell = `<td class="border border-black px-2 py-1 text-center">${displayValue}</td>`;
            resultCell = `<td class="border border-black px-2 py-1 text-center">-</td>`;
        } else if (result.isValid) {
            valueCell = `<td class="border border-black px-2 py-1 text-center">${displayValue}</td>`;
            resultCell = `<td class="border border-black px-2 py-1 text-center text-green-600 font-bold">✓</td>`;
        } else {
            valueCell = `<td class="border border-black px-2 py-1 text-center text-red-500 font-bold" title="${result.message}">${displayValue}</td>`;
            resultCell = `<td class="border border-black px-2 py-1 text-center text-red-500 font-bold">✗</td>`;
        }
        return [valueCell, resultCell];
    };
    const generateSingleReportHTML = (selectedData, reportingPerson = '', auditingPerson = '') => {
        return selectedData.map(item => {
            const mechanical = JSON.parse(item['機械性質'] || '[{}]')[0]; const impact = JSON.parse(item['衝擊測試'] || '[{}]')[0]; const chemical = JSON.parse(item['化學成分'] || '{}'); const specName = item['適用規範'];
            const [tsValue, tsResult] = getValidationCellsHtml(specName, '抗拉強度', mechanical['抗拉強度'], ' Mpa'); const [ysValue, ysResult] = getValidationCellsHtml(specName, '降伏強度', mechanical['降伏強度'], ' Mpa'); const [elValue, elResult] = getValidationCellsHtml(specName, '延伸率', mechanical['延伸率'], ' %'); const [impValue, impResult] = getValidationCellsHtml(specName, '衝擊', impact['平均值']);
            const chemElements = CHEM_ELEMENTS_ORDER; let chemHtml = ''; for(let i = 0; i < chemElements.length; i += 2) { const el1 = chemElements[i]; const el2 = chemElements[i+1]; const [val1, res1] = getValidationCellsHtml(specName, el1, chemical[el1] || ''); const spec1 = `<td class="border border-black px-2 py-1 text-center">${getSpecRequirementString(specName, el1)}</td>`; let el2Html = '<td class="border border-black"></td><td class="border border-black"></td><td class="border border-black"></td><td class="border border-black"></td>'; if (el2) { const [val2, res2] = getValidationCellsHtml(specName, el2, chemical[el2] || ''); const spec2 = `<td class="border border-black px-2 py-1 text-center">${getSpecRequirementString(specName, el2)}</td>`; el2Html = `<td class="border border-black px-2 py-1 font-semibold">${el2}</td>${spec2}${val2}${res2}`; } chemHtml += `<tr><td class="border border-black px-2 py-1 font-semibold">${el1}</td>${spec1}${val1}${res1}${el2Html}</tr>`; }
            const reporterLine = reportingPerson ? `<p class="font-semibold text-base py-1">${reportingPerson}</p>` : '<p class="py-1">____________________</p>';
            const auditorLine = auditingPerson ? `<p class="font-semibold text-base py-1">${auditingPerson}</p>` : '<p class="py-1">____________________</p>';
            return `<div class="report-page"><header class="text-center mb-6"><h1 class="text-2xl font-bold">銲接材料測試報告</h1><h2 class="text-xl font-semibold">Welding Material Test Report</h2></header><table class="w-full border-collapse border border-black text-sm mb-6"><tbody><tr><td class="border border-black px-2 py-1 font-semibold bg-gray-100 w-1/4">品名 (Product)</td><td class="border border-black px-2 py-1 w-1/4">${item['品名'] || ''}</td><td class="border border-black px-2 py-1 font-semibold bg-gray-100 w-1/4">線徑 (Diameter)</td><td class="border border-black px-2 py-1 w-1/4">${item['線徑'] || ''}</td></tr><tr><td class="border border-black px-2 py-1 font-semibold bg-gray-100">適用規範 (Specification)</td><td class="border border-black px-2 py-1">${item['適用規範'] || ''}</td><td class="border border-black px-2 py-1 font-semibold bg-gray-100">RUD卡號</td><td class="border border-black px-2 py-1">${item['RUD卡'] || ''}</td></tr><tr><td class="border border-black px-2 py-1 font-semibold bg-gray-100">銲接日期 (Welding Date)</td><td class="border border-black px-2 py-1">${item['銲接日期'] || ''}</td><td class="border border-black px-2 py-1 font-semibold bg-gray-100">銲接人員 (Welder)</td><td class="border border-black px-2 py-1">${item['銲接人員'] || ''}</td></tr></tbody></table><h3 class="text-lg font-bold mt-6 mb-2 border-b-2 border-black pb-1">一、機械性質 (Mechanical Properties)</h3>${mechanical.doNotTest ? '<p class="text-center text-gray-600 italic my-4">--- 不做測試 ---</p>' : `<table class="w-full border-collapse border border-black text-sm mb-6"><thead><tr class="bg-gray-100"><th class="border border-black px-2 py-1">項目</th><th class="border border-black px-2 py-1">規範要求</th><th class="border border-black px-2 py-1">實測值</th><th class="border border-black px-2 py-1">判定</th></tr></thead><tbody><tr><td class="border border-black px-2 py-1 font-semibold">抗拉強度 (Tensile Strength)</td><td class="border border-black px-2 py-1 text-center">${getSpecRequirementString(specName, '抗拉強度')}</td>${tsValue}${tsResult}</tr><tr><td class="border border-black px-2 py-1 font-semibold">降伏強度 (Yield Strength)</td><td class="border border-black px-2 py-1 text-center">${getSpecRequirementString(specName, '降伏強度')}</td>${ysValue}${ysResult}</tr><tr><td class="border border-black px-2 py-1 font-semibold">延伸率 (Elongation)</td><td class="border border-black px-2 py-1 text-center">${getSpecRequirementString(specName, '延伸率')}</td>${elValue}${elResult}</tr></tbody></table>`}<h3 class="text-lg font-bold mt-6 mb-2 border-b-2 border-black pb-1">二、衝擊測試 (Impact Test)</h3>${impact.doNotTest ? '<p class="text-center text-gray-600 italic my-4">--- 不做測試 ---</p>' : `<table class="w-full border-collapse border border-black text-sm mb-6"><thead><tr class="bg-gray-100"><th class="border border-black px-2 py-1">測試溫度</th><th class="border border-black px-2 py-1">規範要求</th><th class="border border-black px-2 py-1">實測值</th><th class="border border-black px-2 py-1">平均值</th><th class="border border-black px-2 py-1">判定</th></tr></thead><tbody><tr><td class="border border-black px-2 py-1 text-center">${impact['測試溫度'] || ''}${impact['單位'] || ''}</td><td class="border border-black px-2 py-1 text-center">${getSpecRequirementString(specName, '衝擊')}</td><td class="border border-black px-2 py-1 text-center">${(impact['實測值'] || []).join(', ')}</td>${impValue}${impResult}</tr></tbody></table>`}<h3 class="text-lg font-bold mt-6 mb-2 border-b-2 border-black pb-1">三、化學成分 (Chemical Composition)</h3><table class="w-full border-collapse border border-black text-sm"><thead><tr class="bg-gray-100"><th class="border border-black px-2 py-1">元素</th><th class="border border-black px-2 py-1">規範要求</th><th class="border border-black px-2 py-1">實測值 (%)</th><th class="border border-black px-2 py-1">判定</th><th class="border border-black px-2 py-1">元素</th><th class="border border-black px-2 py-1">規範要求</th><th class="border border-black px-2 py-1">實測值 (%)</th><th class="border border-black px-2 py-1">判定</th></tr></thead><tbody>${chemHtml}</tbody></table><footer class="mt-20 text-sm"><div class="flex justify-around"><div class="text-center"><p class="mb-8">報告人員:</p>${reporterLine}</div><div class="text-center"><p class="mb-8">審核人員:</p>${auditorLine}</div></div><p class="text-center mt-6">報告日期: ${new Date().toLocaleDateString()}</p></footer></div>`;
        }).join('');
    };
    const triggerNativePrint = (elementToPrint) => {
        const reportHTML = elementToPrint.innerHTML;
        const tailwindScript = `<script src="https://cdn.tailwindcss.com"><\/script>`;
        const fontLinks = Array.from(document.head.querySelectorAll('link[href*="fonts.googleapis.com"]')).map(el => el.outerHTML).join('\n');
        const customStyles = document.querySelector('style').outerHTML;
        const printWindowHTML = `
            <!DOCTYPE html>
            <html lang="zh-Hant">
            <head>
                <meta charset="UTF-8">
                <title>列印報表</title>
                ${tailwindScript}
                ${fontLinks}
                ${customStyles}
                <style>
                    @media print {
                        @page { size: A4; margin: 10mm; }
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .report-page { box-shadow: none !important; border: none !important; margin: 0 auto !important; padding: 0 !important; page-break-after: always; }
                    }
                    body { background-color: #e5e7eb; }
                </style>
            </head>
            <body>
                ${reportHTML}
                <script type="text/javascript">
                    window.onload = function() {
                        setTimeout(function() { window.print(); window.close(); }, 500);
                    }
                <\/script>
            </body>
            </html>
        `;
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        if (printWindow) {
            printWindow.document.write(printWindowHTML);
            printWindow.document.close();
        } else {
            showToast('無法開啟新分頁，請檢查您的瀏覽器設定是否封鎖了彈出式視窗。', 'error');
        }
    };
    generateReportBtn.addEventListener('click', () => { 
        if (state.selectedRowIds.length === 0) { 
            showToast('請先勾選要產生報表的資料', 'error'); 
            return; 
        } 
        const selectedData = db['資料'].filter(row => state.selectedRowIds.includes(row._docId));
        
        // Populate dropdowns
        const reportingPersonSelect = document.getElementById('reportingPersonSelect');
        const auditingPersonSelect = document.getElementById('auditingPersonSelect');
        const personOptions = (db['人員'] || []).map(p => `<option value="${p.姓名}">${p.姓名}</option>`).join('');
        const placeholderOption = `<option value="">-- 請選擇 --</option>`;
        reportingPersonSelect.innerHTML = placeholderOption + personOptions;
        auditingPersonSelect.innerHTML = placeholderOption + personOptions;

        reportContent.innerHTML = generateSingleReportHTML(selectedData); 
        reportModal.classList.remove('hidden'); 
    });

    const reportingPersonSelect = document.getElementById('reportingPersonSelect');
    const auditingPersonSelect = document.getElementById('auditingPersonSelect');
    const updateReportPreview = () => {
        if (state.selectedRowIds.length === 0) return;
        const selectedData = db['資料'].filter(row => state.selectedRowIds.includes(row._docId));
        const reporter = reportingPersonSelect.value;
        const auditor = auditingPersonSelect.value;
        reportContent.innerHTML = generateSingleReportHTML(selectedData, reporter, auditor);
    };
    reportingPersonSelect.addEventListener('change', updateReportPreview);
    auditingPersonSelect.addEventListener('change', updateReportPreview);

    closeReportModalBtn.addEventListener('click', () => reportModal.classList.add('hidden'));
    document.body.addEventListener('click', (e) => {
        if (e.target.id === 'nativePrintReportBtn') {
            const contentElement = reportContent;
            if (contentElement && contentElement.children.length > 0) {
                triggerNativePrint(contentElement);
            } else {
                showToast('沒有可列印的報表內容', 'error');
            }
        }
    });
    generateStatsReportBtn.addEventListener('click', () => {
        const startDateInput = document.getElementById('statsStartDate');
        const endDateInput = document.getElementById('statsEndDate');
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        if (!startDate || !endDate) {
            showToast('請選擇開始及結束日期', 'error');
            return;
        }
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        if (start > end) {
            showToast('開始日期不能晚於結束日期', 'error');
            return;
        }

        let tensileSetCount = 0;
        let impactPieceCount = 0;
        const welderCountsByName = {};
        const tensileProcessorCounts = {};
        const impactProcessorCounts = {};
        const processorStats = {}; // 新增：用於合併加工人員統計

        const filteredData = db['資料'].filter(item => {
            if (!item['銲接日期']) return false;
            const itemDate = new Date(item['銲接日期']);
            return itemDate >= start && itemDate <= end;
        });

        filteredData.forEach(item => {
            // Welder Count by Name, then by Mode
            const welder = item['銲接人員'];
            const mode = item['銲接模式'] || '未指定模式';
            if (welder) {
                if (!welderCountsByName[welder]) {
                    welderCountsByName[welder] = {};
                }
                welderCountsByName[welder][mode] = (welderCountsByName[welder][mode] || 0) + 1;
            }

            // Tensile Test & Processor Count
            let hasTensileData = false;
            try {
                const mechanical = JSON.parse(item['機械性質'] || '[]');
                if (mechanical.some(m => !m.doNotTest && (m['抗拉強度'] !== null && m['抗拉強度'] !== undefined && m['抗拉強度'] !== ''))) {
                    hasTensileData = true;
                }
            } catch (e) { /* ignore */ }
            
            if (hasTensileData) {
                tensileSetCount++;
                if (item['拉力棒加工人員']) {
                    tensileProcessorCounts[item['拉力棒加工人員']] = (tensileProcessorCounts[item['拉力棒加工人員']] || 0) + 1;
                }
            }

            // Impact Test & Processor Count
            let hasImpactData = false;
            let impactPiecesForProcessor = 0; // 用於計算單筆資料中的衝擊片數
            try {
                const impactTests = JSON.parse(item['衝擊測試'] || '[]');
                if (impactTests.some(i => !i.doNotTest && i['平均值'] !== null && i['平均值'] !== undefined && i['平均值'] !== '')) {
                    hasImpactData = true;
                }
                // Count individual pieces for the main report and for processor stats
                impactTests.forEach(test => {
                    if (!test.doNotTest && test['實測值'] && Array.isArray(test['實測值'])) {
                        const validValues = test['實測值'].filter(v => v !== null && v !== undefined && v !== '');
                        impactPieceCount += validValues.length;
                        impactPiecesForProcessor += validValues.length; // 累加片數
                    }
                });
            } catch (e) { /* ignore */ }
            
            if (hasImpactData && item['衝擊片加工人員']) {
                impactProcessorCounts[item['衝擊片加工人員']] = (impactProcessorCounts[item['衝擊片加工人員']] || 0) + impactPiecesForProcessor;
            }
        });

        // --- 新增：合併加工人員統計資料 ---
        for (const person in tensileProcessorCounts) {
            if (!processorStats[person]) {
                processorStats[person] = { tensile: 0, impact: 0 };
            }
            processorStats[person].tensile = tensileProcessorCounts[person];
        }
        for (const person in impactProcessorCounts) {
            if (!processorStats[person]) {
                processorStats[person] = { tensile: 0, impact: 0 };
            }
            processorStats[person].impact = impactProcessorCounts[person];
        }
        // --- 結束新增 ---

        const createCountsTableHTML = (title, counts) => {
            if (Object.keys(counts).length === 0) return '';
            const sortedCounts = Object.entries(counts).sort(([, a], [, b]) => b - a);
            return `
                <h3 class="text-xl font-bold mt-8 mb-4">${title}</h3>
                <table class="w-full border-collapse border border-black text-lg">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-black px-4 py-2">人員</th>
                            <th class="border border-black px-4 py-2">執行次數 (組)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedCounts.map(([name, count]) => `
                            <tr>
                                <td class="border border-black px-4 py-2">${name}</td>
                                <td class="border border-black px-4 py-2 text-center">${count}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        };
        
        const createWelderStatsByNameHTML = (title, countsByName) => {
            if (Object.keys(countsByName).length === 0) return '';
            let html = `<h3 class="text-xl font-bold mt-8 mb-4">${title}</h3>`;
            const sortedWelders = Object.keys(countsByName).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            
            for (const welder of sortedWelders) {
                const modeCounts = countsByName[welder];
                const sortedModes = Object.entries(modeCounts).sort((a, b) => b[1] - a[1]); // Sort by count desc
                
                html += `
                    <div class="mt-6">
                        <h4 class="text-lg font-semibold mb-2 bg-gray-200 p-2 rounded-t-lg">銲接人員: ${welder}</h4>
                        <table class="w-full border-collapse border border-black text-lg">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-black px-4 py-2">銲接模式</th>
                                    <th class="border border-black px-4 py-2">執行次數 (組)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedModes.map(([mode, count]) => `
                                    <tr>
                                        <td class="border border-black px-4 py-2">${mode}</td>
                                        <td class="border border-black px-4 py-2 text-center">${count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            return html;
        };

        // --- 新增：產生加工統計報表的函式 ---
        const createProcessorStatsHTML = (title, stats) => {
            if (Object.keys(stats).length === 0) return '<p class="text-center py-8 text-gray-500">此期間內沒有加工資料。</p>';
            const sortedPersons = Object.keys(stats).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            return `
                <h3 class="text-xl font-bold mt-8 mb-4">${title}</h3>
                <table class="w-full border-collapse border border-black text-lg">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-black px-4 py-2">加工人員</th>
                            <th class="border border-black px-4 py-2">拉力棒加工 (組)</th>
                            <th class="border border-black px-4 py-2">衝擊片加工 (片)</th>
                            <th class="border border-black px-4 py-2">總計</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedPersons.map(person => {
                            const personStats = stats[person];
                            const total = (personStats.tensile || 0) + (personStats.impact || 0);
                            return `
                                <tr>
                                    <td class="border border-black px-4 py-2">${person}</td>
                                    <td class="border border-black px-4 py-2 text-center">${personStats.tensile || 0}</td>
                                    <td class="border border-black px-4 py-2 text-center">${personStats.impact || 0}</td>
                                    <td class="border border-black px-4 py-2 text-center font-bold">${total}</td>
                                </tr>
                            `
                        }).join('')}
                    </tbody>
                </table>
            `;
        };
        // --- 結束新增 ---

        const weldingReportHTML = `
            <div class="report-page">
                 <header class="text-center mb-8">
                    <h1 class="text-2xl font-bold">銲接工作量統計報告</h1>
                    <p class="text-lg text-gray-600">期間：${startDate} 至 ${endDate}</p>
                </header>
                ${createWelderStatsByNameHTML('銲接人員工作量統計 (依人員區分)', welderCountsByName)}
                <footer class="mt-20 text-sm">
                    <p class="text-right">報告產生日期: ${new Date().toLocaleDateString()}</p>
                </footer>
            </div>
        `;

        const testingReportHTML = `
            <div class="report-page">
                <header class="text-center mb-8">
                    <h1 class="text-2xl font-bold">測試次數統計報告</h1>
                    <p class="text-lg text-gray-600">期間：${startDate} 至 ${endDate}</p>
                </header>
                
                <h3 class="text-xl font-bold mb-4">總體測試統計</h3>
                <table class="w-full border-collapse border border-black text-lg">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-black px-4 py-2">測試項目</th>
                            <th class="border border-black px-4 py-2">執行次數</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border border-black px-4 py-2 font-semibold">抗拉強度測試 (組數)</td>
                            <td class="border border-black px-4 py-2 text-center">${tensileSetCount}</td>
                        </tr>
                        <tr>
                            <td class="border border-black px-4 py-2 font-semibold">衝擊測試 (片數)</td>
                            <td class="border border-black px-4 py-2 text-center">${impactPieceCount}</td>
                        </tr>
                    </tbody>
                </table>

                ${createCountsTableHTML('拉力棒加工人員工作量統計', tensileProcessorCounts)}
                ${createCountsTableHTML('衝擊片加工人員工作量統計', impactProcessorCounts)}

                <footer class="mt-20 text-sm">
                    <p class="text-right">報告產生日期: ${new Date().toLocaleDateString()}</p>
                </footer>
            </div>
        `;

        const processorReportHTML = `
            <div class="report-page">
                 <header class="text-center mb-8">
                    <h1 class="text-2xl font-bold">加工人員工作量統計報告</h1>
                    <p class="text-lg text-gray-600">期間：${startDate} 至 ${endDate}</p>
                </header>
                ${createProcessorStatsHTML('加工項目統計 (依人員區分)', processorStats)}
                <footer class="mt-20 text-sm">
                    <p class="text-right">報告產生日期: ${new Date().toLocaleDateString()}</p>
                </footer>
            </div>
        `;

        statsReportDisplayArea.innerHTML = `
            <div class="flex justify-between items-center mb-4 border-b">
                <nav class="flex -mb-px" aria-label="Tabs">
                    <button data-tab="welding" class="stats-tab-button active py-4 px-6 font-medium text-center border-b-2 text-gray-500 hover:text-gray-700 hover:border-gray-300">銲接統計</button>
                    <button data-tab="testing" class="stats-tab-button py-4 px-6 font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">測試統計</button>
                    <button data-tab="processor" class="stats-tab-button py-4 px-6 font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">加工統計</button>
                </nav>
                <button id="printStatsReportBtn" class="btn btn-primary">匯出 PDF</button>
            </div>
            <div id="statsTabContent">
                <div id="weldingStatsReportContent">${weldingReportHTML}</div>
                <div id="testingStatsReportContent" class="hidden">${testingReportHTML}</div>
                <div id="processorStatsReportContent" class="hidden">${processorReportHTML}</div>
            </div>
        `;
        
        state.currentStatsTab = 'welding';
    });
    statsReportDisplayArea.addEventListener('click', (e) => {
        const printBtn = e.target.closest('#printStatsReportBtn');
        const tabBtn = e.target.closest('.stats-tab-button');

        if (tabBtn) {
            const tabName = tabBtn.dataset.tab;
            state.currentStatsTab = tabName;
            
            statsReportDisplayArea.querySelectorAll('.stats-tab-button').forEach(btn => btn.classList.remove('active'));
            tabBtn.classList.add('active');
            
            document.getElementById('weldingStatsReportContent').classList.toggle('hidden', tabName !== 'welding');
            document.getElementById('testingStatsReportContent').classList.toggle('hidden', tabName !== 'testing');
            document.getElementById('processorStatsReportContent').classList.toggle('hidden', tabName !== 'processor');
        }
        
        if (printBtn) {
            const date = new Date().toISOString().split('T')[0];
            let contentElement;
            let fileName;

            if (state.currentStatsTab === 'welding') {
                contentElement = document.getElementById('weldingStatsReportContent');
                fileName = `統計報表_銲接_${date}.pdf`;
            } else if (state.currentStatsTab === 'testing') {
                contentElement = document.getElementById('testingStatsReportContent');
                fileName = `統計報表_測試_${date}.pdf`;
            } else if (state.currentStatsTab === 'processor') {
                contentElement = document.getElementById('processorStatsReportContent');
                fileName = `統計報表_加工_${date}.pdf`;
            }

            if (contentElement) { 
                handlePrint(contentElement, fileName); 
            } else { 
                showToast('沒有可匯出的統計報表內容', 'error'); 
            } 
        } 
    });
    importDataBtn.addEventListener('click', () => { importResults.innerHTML = '<p class="text-gray-400">準備匯入...</p>'; importDataTextarea.value = ''; importModal.classList.remove('hidden'); });
    closeImportModalBtn.addEventListener('click', () => importModal.classList.add('hidden')); closeImportModalBtn2.addEventListener('click', () => importModal.classList.add('hidden'));

    // --- 初始化 ---
    const getSortedColumns = (data) => {
        if (!data || data.length === 0) return [];
        // Get all unique keys from all records to handle sparse data
        const allKeys = new Set(data.flatMap(row => Object.keys(row)).filter(k => k !== '_docId'));
        const canonicalSet = new Set(CANONICAL_COLUMN_ORDER);
        
        // Start with keys from the canonical order that are actually present in the data
        const sortedKeys = CANONICAL_COLUMN_ORDER.filter(key => allKeys.has(key));
        
        // Find any keys that are in the data but not in our canonical list, and sort them alphabetically
        const otherKeys = [...allKeys].filter(key => !canonicalSet.has(key)).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
        
        // Combine them, ensuring canonical order is respected first
        return [...sortedKeys, ...otherKeys];
    };
    const init = async () => {
        showLoading('系統起始中，請連接 Firebase...');
        try {
            await signInAnonymously(auth);
            console.log("Firebase 已匿名登入:", auth.currentUser.uid);
            
            const collectionNames = ['資料', '規範', '人員', '鋼板', '氣體', '銲材分類', '品名對規範', '件別']; // <-- 新增 '件別'
            let initialDataLoaded = 0;
            const totalCollections = collectionNames.length;

            // 設置即時監聽器
            collectionNames.forEach(name => {
                onSnapshot(collection(firestoreDb, name), (snapshot) => {
                    db[name] = snapshot.docs.map(d => ({ ...d.data(), _docId: d.id }));
                    console.log(`[Realtime] ${name} 資料已更新，共 ${db[name].length} 筆`);
                    
                    // 根據當前頁面決定是否需要重新渲染
                    if (state.currentPage === 'main') {
                        // 主頁面資料變動時，重新渲染主表格和儀表板
                        renderDataTable();
                    } else if (state.currentPage === 'settings' && state.currentSettingView === name) {
                        // 設定頁面且對應的表格資料變動時，重新渲染設定內容
                        renderSettingsContent(name);
                    } else if (name !== '資料') {
                        // 如果是輔助資料表 (如規範、人員等) 變動，也要更新主儀表板
                        if(db['資料']) renderDashboards(db['資料']);
                    }
                }, (error) => {
                    console.error(`無法監聽 ${name} 集合:`, error);
                    showToast(`無法從 ${name} 即時獲取資料`, 'error');
                });
            });

            // 等待所有集合的首次數據載入，或超時
            await new Promise(async (resolve) => {
                const promises = collectionNames.map(name => 
                    getDocs(collection(firestoreDb, name)).then(snapshot => {
                         db[name] = snapshot.docs.map(d => ({ ...d.data(), _docId: d.id }));
                    })
                );
                await Promise.all(promises);
                resolve();
            });


            const savedColumns = localStorage.getItem('visibleColumns');
            const allColumns = getSortedColumns(db['資料']);
            state.visibleColumns = savedColumns ? JSON.parse(savedColumns) : allColumns;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('statsStartDate').value = today; document.getElementById('statsEndDate').value = today;
            
            renderDataTable();
            switchTab('main');
            showToast('Firebase 連接成功並已載入即時資料！', 'success');

        } catch (error) {
            console.error('Firebase 初始化失敗:', error);
            showToast(`Firebase 連接失敗: ${error.message}`, 'error');
            loadingOverlay.querySelector('p').textContent = `Firebase 連接失敗: ${error.message}。請檢查您的 Firebase 設定。`;
            return; // 初始化失敗，停止後續操作
        } finally {
            hideLoading();
        }
    };

    init();
});
</script>

</body>
</html>