<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>樣品庫存管理系統 - 儀表板</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- QR Code & Zipping Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="text/javascript" src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content-hidden {
            transform: scale(0.95);
            opacity: 0;
        }
        .modal-content-visible {
            transform: scale(1);
            opacity: 1;
        }
        .tab-btn, .history-tab-btn {
            border-color: transparent;
            color: #475569; /* slate-600 */
        }
        .active-tab {
            border-color: #2563eb; /* blue-600 */
            color: #1e293b; /* slate-800 */
        }
        .horizontal-scroll-container {
            cursor: grab;
            cursor: -webkit-grab;
            scrollbar-width: none;
            -ms-overflow-style: none;
            user-select: none;
        }
        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .horizontal-scroll-container.active {
            cursor: grabbing;
            cursor: -webkit-grabbing;
        }
        /* Notification Toast */
        .toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .toast-visible {
            transform: translateY(0);
            opacity: 1;
        }

        /* VISUAL INVENTORY GRID STYLES */
        .shelf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }
        @media (max-width: 640px) {
            .shelf-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
        .slot-card {
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            position: relative; /* Needed for tooltip positioning */
            cursor: pointer;
        }
        .slot-occupied {
            background-color: white;
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            border: 1px solid #e2e8f0;
        }
        .slot-occupied:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .slot-occupied.selected, .staging-card.selected {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #bfdbfe; /* blue-200 */
            background-color: #eff6ff; /* blue-50 */
        }
        .slot-empty {
            background-color: #f8fafc;
            border-style: dashed;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            color: #cbd5e1;
            border-width: 1px;
            border-color: #e2e8f0;
        }
        .slot-empty:hover {
            background-color: #f0f9ff;
            border-color: #38bdf8;
            color: #0284c7;
        }

        /* TOOLTIP STYLES */
        .tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b; /* slate-800 */
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            width: max-content;
            max-width: 320px;
            z-index: 20;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            pointer-events: none;
        }
        .tooltip::after { /* The little arrow */
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        .slot-occupied:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Staging Area Styles */
        .staging-card {
            background-color: #fffbeb; /* amber-50 */
            border: 1px solid #fcd34d; /* amber-300 */
            border-radius: 0.75rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
         .staging-card.selected {
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        
        /* Batch Action Bar */
        #batch-action-bar {
            transition: transform 0.3s ease-in-out;
            transform: translateY(110%);
        }
        #batch-action-bar.visible {
            transform: translateY(0);
        }
        
        /* QR Scanner Style */
        #qr-reader {
            width: 100%;
            max-width: 500px;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 pb-32"> <!-- Added padding-bottom -->

    <div class="max-w-7xl mx-auto">
        <!-- 頁首 -->
        <header class="flex justify-between items-center mb-8 flex-wrap gap-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">樣品儀表板</h1>
            <div class="flex items-center gap-2 sm:gap-3">
                 <button id="scanSearchBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2.5 rounded-lg shadow-sm hover:bg-indigo-700 whitespace-nowrap text-sm sm:text-base flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="7" y="7" width="10" height="10" rx="1"></rect></svg>
                    掃描搜尋
                 </button>
                 <button id="openAddSampleModalBtn" class="bg-blue-600 text-white font-semibold px-4 py-2.5 rounded-lg shadow-sm hover:bg-blue-700 whitespace-nowrap text-sm sm:text-base">新增樣品</button>
                 <button id="openHistoryModalBtn" class="bg-white text-slate-700 font-semibold px-4 py-2.5 rounded-lg shadow-sm hover:bg-slate-100 border border-slate-300 whitespace-nowrap text-sm sm:text-base">查看歷史</button>
                 <button id="openReportModalBtn" class="bg-white text-slate-700 font-semibold px-4 py-2.5 rounded-lg shadow-sm hover:bg-slate-100 border border-slate-300 whitespace-nowrap text-sm sm:text-base">庫存報表</button>
                 <button id="openSettingsBtn" class="bg-slate-700 text-white font-semibold px-4 py-2.5 rounded-lg shadow-sm hover:bg-slate-800 whitespace-nowrap text-sm sm:text-base">系統設定</button>
            </div>
        </header>

        <!-- 主系統內容 -->
        <main id="mainContent">
            <!-- 搜尋區塊 -->
            <section id="search-section" class="mb-8 bg-white p-4 sm:p-6 rounded-2xl shadow-lg border border-slate-200">
                <h2 class="text-xl sm:text-2xl font-bold mb-5 text-slate-800">搜尋樣品</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="text" id="searchInput" class="sm:col-span-2 lg:col-span-2 w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="輸入樣品名稱、線徑、標準...">
                    <select id="searchCabinet" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                    <select id="searchPerson" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                </div>
                 <div id="searchResults" class="mt-6 hidden">
                    <h3 class="text-lg sm:text-xl font-semibold text-slate-700 mb-4">搜尋結果</h3>
                    <div id="searchResultsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
                        <!-- Search results will be injected here as a grid -->
                    </div>
                </div>
            </section>

            <!-- 樣品暫存區 -->
            <section id="staging-area-section" class="mb-8">
                <h2 class="text-xl sm:text-2xl font-bold mb-5 text-slate-800">樣品暫存區</h2>
                <div id="stagingAreaGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6">
                    <!-- Staging samples will be injected here -->
                </div>
                <div id="noStagingSamples" class="hidden text-center py-10 bg-white rounded-2xl border border-slate-200 shadow-lg">
                    <p class="text-slate-500">暫存區是空的</p>
                </div>
            </section>

            <!-- 各櫃子庫存總覽 (Tab 介面) -->
            <section id="inventory-overview-section" class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg border border-slate-200 min-h-[200px] flex items-center justify-center">
                 <div id="loader" class="text-center text-slate-500">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    正在連接資料庫...
                </div>
                <div id="inventory-content" class="hidden w-full">
                    <div id="cabinet-tabs-container" class="mb-4 border-b border-slate-200 -mx-4 sm:-mx-6 px-4 sm:px-6 flex items-center gap-4 overflow-x-auto horizontal-scroll-container"></div>
                    <div id="cabinet-content-container" class="pt-4"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="qrScannerModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 p-4 sm:p-6 modal-content modal-content-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="qrScannerTitle" class="text-xl sm:text-2xl font-bold text-slate-800">掃描 QR Code</h2>
                <button class="close-scanner-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div id="qr-reader" class="mx-auto"></div>
        </div>
    </div>
    
    <div id="addSampleModal" class="fixed inset-0 z-40 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 modal-content modal-content-hidden">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">登錄新樣品</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div class="p-4 sm:p-6 overflow-y-auto" style="max-height: 80vh;">
                <form id="add-sample-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="sampleName" class="block text-sm font-medium text-slate-600 mb-1">樣品名稱</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="sampleName" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="可掃描 QR Code 或手動輸入">
                                <button type="button" id="scanInputQrBtn" class="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600" title="掃描 QR Code">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                                </button>
                            </div>
                        </div>
                         <div><label for="wireDiameter" class="block text-sm font-medium text-slate-600 mb-1">線徑</label><input type="text" id="wireDiameter" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="例如：2.5mm"></div>
                    </div>
                    <div class="p-4 border border-slate-200 rounded-lg">
                        <p class="text-sm text-slate-500 mb-4">以下欄位至少擇一填寫：</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label for="applicableStandard" class="block text-sm font-medium text-slate-600 mb-1">適用標準(規範)</label><input type="text" id="applicableStandard" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="例如：JIS G 3521"></div>
                            <div><label for="manufacturer" class="block text-sm font-medium text-slate-600 mb-1">製造商</label><input type="text" id="manufacturer" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="例如：中鋼"></div>
                            <div><label for="formulaCode" class="block text-sm font-medium text-slate-600 mb-1">配方代號</label><input type="text" id="formulaCode" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></div>
                            <div><label for="processDetails" class="block text-sm font-medium text-slate-600 mb-1">製程明細</label><input type="text" id="processDetails" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></div>
                            <div><label for="furnaceNo" class="block text-sm font-medium text-slate-600 mb-1">爐號</label><input type="text" id="furnaceNo" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></div>
                            <div><label for="batchNo" class="block text-sm font-medium text-slate-600 mb-1">批號</label><input type="text" id="batchNo" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></div>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-3">
                            <label class="block text-sm font-medium text-slate-600 mb-1">存放位置</label>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <select id="storageCabinet" required class="w-full px-4 py-2 border border-slate-300 rounded-lg"></select>
                                <select id="storageShelf" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" disabled></select>
                                <select id="storagePosition" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" disabled></select>
                            </div>
                        </div>
                        <div><label for="loggedBy" class="block text-sm font-medium text-slate-600 mb-1">登錄人員</label><select id="loggedBy" required class="w-full px-4 py-2 border border-slate-300 rounded-lg"></select></div>
                    </div>
                    <div class="text-right"><button type="submit" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-6 py-2.5 rounded-lg shadow-md hover:bg-blue-700">確認存入</button></div>
                </form>
            </div>
        </div>
    </div>
    <div id="historyModal" class="fixed inset-0 z-40 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl mx-4 modal-content modal-content-hidden flex flex-col">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">操作歷史紀錄</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div class="p-4 sm:p-6 flex-grow overflow-y-auto" style="max-height: 80vh;">
                <div id="history-tabs-container" class="mb-4 border-b border-slate-200 flex items-center gap-4 -mx-4 sm:-mx-6 px-4 sm:px-6 overflow-x-auto horizontal-scroll-container">
                    <button data-target="historyTab-add" class="history-tab-btn text-sm sm:text-base font-semibold py-3 px-4 border-b-2 whitespace-nowrap active-tab">新增</button>
                    <button data-target="historyTab-stage" class="history-tab-btn text-sm sm:text-base font-semibold py-3 px-4 border-b-2 whitespace-nowrap">暫存</button>
                    <button data-target="historyTab-return" class="history-tab-btn text-sm sm:text-base font-semibold py-3 px-4 border-b-2 whitespace-nowrap">放回</button>
                    <button data-target="historyTab-move" class="history-tab-btn text-sm sm:text-base font-semibold py-3 px-4 border-b-2 whitespace-nowrap">移位</button>
                    <button data-target="historyTab-finalize" class="history-tab-btn text-sm sm:text-base font-semibold py-3 px-4 border-b-2 whitespace-nowrap">取出</button>
                </div>
                <div id="history-content-container" class="mt-4">
                    <div id="historyTab-add" class="history-tab-content"></div>
                    <div id="historyTab-stage" class="history-tab-content hidden"></div>
                    <div id="historyTab-return" class="history-tab-content hidden"></div>
                    <div id="historyTab-move" class="history-tab-content hidden"></div>
                    <div id="historyTab-finalize" class="history-tab-content hidden"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="settingsModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 modal-content modal-content-hidden flex flex-col">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">系統設定</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div class="p-4 sm:p-6 overflow-y-auto flex-grow" style="max-height: 70vh;">
                <div class="mb-8">
                    <h3 class="text-lg sm:text-xl font-semibold text-slate-700 mb-4">人員管理</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4"><input type="text" id="newPersonName" class="flex-grow px-4 py-2 border border-slate-300 rounded-lg" placeholder="輸入人員姓名"><button id="addPersonBtn" class="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-blue-700 whitespace-nowrap">新增人員</button></div>
                    <div id="personList" class="space-y-2"></div>
                </div><hr class="my-6">
                <div>
                    <h3 class="text-lg sm:text-xl font-semibold text-slate-700 mb-4">櫃子配置管理</h3>
                    <div class="mb-6 p-4 bg-slate-50 rounded-lg">
                        <h4 class="font-semibold text-slate-600 mb-2">新增櫃子</h4>
                        <div class="flex flex-col sm:flex-row items-center gap-4"><input type="text" id="newCabinetName" class="flex-grow w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="輸入新櫃子名稱"><button id="addCabinetBtn" class="bg-green-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-green-700 w-full sm:w-auto whitespace-nowrap">新增櫃子</button></div>
                    </div><div id="cabinetSettings" class="space-y-6"></div>
                </div>
            </div>
            <div class="p-4 sm:p-6 bg-slate-50 border-t border-slate-200 flex justify-end gap-3">
                <button id="closeSettingsBtn" class="bg-white text-slate-700 font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-slate-100 border border-slate-300">關閉</button>
                <button id="saveSettingsBtn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-blue-700">儲存設定</button>
            </div>
        </div>
    </div>
    <div id="moveSampleModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 modal-content modal-content-hidden">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">移動樣品位置</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <form id="move-sample-form" class="p-4 sm:p-6 space-y-4">
                <input type="hidden" id="moveSampleId">
                <input type="hidden" id="moveSampleSource">
                <div>
                    <p>樣品名稱: <span id="moveSampleName" class="font-semibold"></span></p>
                    <p>目前位置: <span id="moveSampleOldLocation" class="text-sm text-slate-500"></span></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">新的存放位置</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <select id="moveStorageCabinet" required class="w-full px-4 py-2 border border-slate-300 rounded-lg"></select>
                        <select id="moveStorageShelf" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" disabled></select>
                        <select id="moveStoragePosition" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" disabled></select>
                    </div>
                </div>
                <div>
                    <label for="movedBy" class="block text-sm font-medium text-slate-600 mb-1">操作人員</label>
                    <select id="movedBy" required class="w-full px-4 py-2 border border-slate-300 rounded-lg"></select>
                </div>
                <div class="text-right pt-4">
                    <button type="button" class="close-modal-btn bg-slate-200 text-slate-700 font-semibold px-5 py-2.5 rounded-lg hover:bg-slate-300 mr-2">取消</button>
                    <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white font-semibold px-6 py-2.5 rounded-lg shadow-md hover:bg-blue-700">確認移動</button>
                </div>
            </form>
        </div>
    </div>
    <div id="actionModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 modal-content modal-content-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200">
                <h2 id="actionModalTitle" class="text-xl font-bold text-slate-800"></h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <form id="actionForm" class="p-6 space-y-4">
                <input type="hidden" id="actionSampleId">
                <input type="hidden" id="actionType">
                <p id="actionModalMessage" class="text-slate-600"></p>
                <div>
                    <label for="actionPerson" class="block text-sm font-medium text-slate-600 mb-1">操作人員</label>
                    <select id="actionPerson" required class="w-full px-4 py-2 border border-slate-300 rounded-lg"></select>
                </div>
                <div id="remarksContainer" class="hidden">
                     <label for="actionRemarks" class="block text-sm font-medium text-slate-600 mb-1">備註事項 (必填)</label>
                     <textarea id="actionRemarks" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="3" placeholder="例如：用於 XX 實驗..."></textarea>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-slate-200 text-slate-700 font-semibold px-5 py-2.5 rounded-lg hover:bg-slate-300">取消</button>
                    <button type="submit" id="actionConfirmBtn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg">確認</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirmationModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm mx-4 p-6 modal-content modal-content-hidden">
             <h3 id="confirmationTitle" class="text-xl font-bold text-slate-800 mb-4">確認操作</h3>
             <p id="confirmationMessage" class="mb-6 text-slate-600"></p>
             <div class="flex justify-end gap-3">
                 <button id="confirmCancelBtn" class="bg-slate-200 text-slate-700 font-semibold px-5 py-2.5 rounded-lg hover:bg-slate-300">取消</button>
                 <button id="confirmActionBtn" class="bg-red-600 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-red-700">確認</button>
             </div>
        </div>
    </div>
    <div id="sampleDetailModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 modal-content modal-content-hidden flex flex-col">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">樣品詳細資訊</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div id="sampleDetailContent" class="p-4 sm:p-6 overflow-y-auto" style="max-height: 70vh;"></div>
            <div id="sampleDetailFooter" class="p-4 sm:p-6 bg-slate-50 border-t border-slate-200 flex justify-end gap-3"></div>
        </div>
    </div>
     <!-- Batch Action Modal -->
    <div id="batchActionModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 modal-content modal-content-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200">
                <h2 class="text-xl font-bold text-slate-800">批次移至暫存區</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <form id="batchActionForm" class="p-6">
                <p class="text-slate-600 mb-4">您確定要將以下 <span id="batchCount" class="font-bold"></span> 個樣品移至暫存區嗎？</p>
                <div id="batchSampleList" class="max-h-48 overflow-y-auto bg-slate-50 p-3 rounded-lg space-y-2 mb-4"></div>
                <div>
                    <label for="batchActionPerson" class="block text-sm font-medium text-slate-600 mb-1">操作人員</label>
                    <select id="batchActionPerson" required class="w-full px-4 py-2 border border-slate-300 rounded-lg"></select>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-slate-200 text-slate-700 font-semibold px-5 py-2.5 rounded-lg hover:bg-slate-300">取消</button>
                    <button type="submit" class="bg-amber-500 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-amber-600">確認移至暫存</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Batch Finalize Modal -->
    <div id="batchFinalizeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 modal-content modal-content-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200">
                <h2 class="text-xl font-bold text-slate-800">批次最終取出 (歸檔)</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <form id="batchFinalizeForm" class="p-6">
                <p class="text-slate-600 mb-4">您確定要歸檔以下 <span id="batchFinalizeCount" class="font-bold"></span> 個樣品嗎？此操作無法復原。</p>
                <div id="batchFinalizeSampleList" class="max-h-48 overflow-y-auto bg-slate-50 p-3 rounded-lg space-y-2 mb-4"></div>
                <div class="space-y-4">
                    <div>
                        <label for="batchFinalizePerson" class="block text-sm font-medium text-slate-600 mb-1">操作人員</label>
                        <select id="batchFinalizePerson" required class="w-full px-4 py-2 border border-slate-300 rounded-lg"></select>
                    </div>
                    <div>
                        <label for="batchFinalizeRemarks" class="block text-sm font-medium text-slate-600 mb-1">備註事項 (將套用至所有樣品)</label>
                        <textarea id="batchFinalizeRemarks" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" rows="3" placeholder="例如：XX 專案已結案"></textarea>
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-slate-200 text-slate-700 font-semibold px-5 py-2.5 rounded-lg hover:bg-slate-300">取消</button>
                    <button type="submit" class="bg-red-600 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-red-700">確認並歸檔</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Report Filter Modal -->
    <div id="reportFilterModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 modal-content modal-content-hidden">
            <div class="flex justify-between items-center p-6 border-b border-slate-200">
                <h2 class="text-xl font-bold text-slate-800">選擇報表範圍</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div class="p-6">
                <label for="reportCabinetSelect" class="block text-sm font-medium text-slate-600 mb-2">請選擇要產生的櫃子報表：</label>
                <select id="reportCabinetSelect" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="close-modal-btn bg-slate-200 text-slate-700 font-semibold px-5 py-2.5 rounded-lg hover:bg-slate-300">取消</button>
                    <button id="generateReportBtn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg">產生報表</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 z-40 flex items-center justify-center modal-backdrop modal-hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl mx-4 modal-content modal-content-hidden flex flex-col">
            <div class="flex justify-between items-center p-4 sm:p-6 border-b border-slate-200">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">庫存報表</h2>
                <button class="close-modal-btn text-slate-500 hover:text-slate-800 text-3xl">&times;</button>
            </div>
            <div id="reportContent" class="p-4 sm:p-6 flex-grow overflow-y-auto" style="max-height: 80vh;">
                <!-- Report table will be injected here -->
            </div>
            <div class="p-4 sm:p-6 bg-slate-50 border-t border-slate-200 flex justify-end gap-3">
                 <button type="button" class="close-modal-btn bg-slate-200 text-slate-700 font-semibold px-5 py-2.5 rounded-lg hover:bg-slate-300">關閉</button>
                 <button id="downloadCsvBtn" class="bg-green-600 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-green-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    下載 CSV
                 </button>
                 <button id="printReportBtn" class="bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-lg shadow-sm hover:bg-blue-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    列印報表
                 </button>
            </div>
        </div>
    </div>


    <!-- Notification Toast -->
    <div id="notification-toast" class="toast fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <span id="notification-message"></span>
    </div>

    <!-- Batch Action Bar -->
    <div id="batch-action-bar" class="fixed bottom-0 left-0 right-0 bg-slate-800 text-white p-4 shadow-lg z-30">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <span id="selected-count" class="font-bold"></span>
                <span> 個樣品已選取</span>
            </div>
            <div class="flex items-center gap-4">
                <button id="batch-download-qr-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg hidden">下載 QR Codes</button>
                <button id="batch-stage-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold px-5 py-2 rounded-lg">批次移至暫存</button>
                <button id="batch-finalize-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-2 rounded-lg hidden">批次最終取出</button>
                <button id="deselect-all-btn" class="text-slate-300 hover:text-white font-semibold">取消選取</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, serverTimestamp, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDLS5yzP9yMeyhGJMePFCCUwpKpob6S84",
            authDomain: "rdspools-6dc53.firebaseapp.com",
            projectId: "rdspools-6dc53",
            storageBucket: "rdspools-6dc53.appspot.com",
            messagingSenderId: "1052447565403",
            appId: "1:1052447565403:web:23498fc330636ecb38817e",
            measurementId: "G-6DYX4YRN7D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            let systemConfig = {}, tempSystemConfig = {}, sampleInventory = [], stagingSamples = [], historyLog = [], currentReportData = [];
            let unsubscribeConfig, unsubscribeInventory, unsubscribeStaging, unsubscribeHistory;
            let selectedSamples = new Set();
            let selectedStagingSamples = new Set();
            let html5QrCode = null;
            let scannerMode = 'input'; // 'input' or 'search'

            const mainContent = document.getElementById('mainContent');
            const searchInput = document.getElementById('searchInput');
            const searchCabinetSelect = document.getElementById('searchCabinet');
            const searchPersonSelect = document.getElementById('searchPerson');
            const searchResultsContainer = document.getElementById('searchResults');
            const searchResultsGrid = document.getElementById('searchResultsGrid');
            const inventoryOverviewSection = document.getElementById('inventory-overview-section');
            const loader = document.getElementById('loader');
            const inventoryContent = document.getElementById('inventory-content');
            const notificationToast = document.getElementById('notification-toast');
            const notificationMessage = document.getElementById('notification-message');
            const stagingAreaGrid = document.getElementById('stagingAreaGrid');
            const noStagingSamplesMessage = document.getElementById('noStagingSamples');
            const batchActionBar = document.getElementById('batch-action-bar');
            
            const modals = { 
                addSample: document.getElementById('addSampleModal'), 
                history: document.getElementById('historyModal'), 
                settings: document.getElementById('settingsModal'),
                moveSample: document.getElementById('moveSampleModal'),
                action: document.getElementById('actionModal'),
                confirmation: document.getElementById('confirmationModal'),
                sampleDetail: document.getElementById('sampleDetailModal'),
                batchAction: document.getElementById('batchActionModal'),
                batchFinalize: document.getElementById('batchFinalizeModal'),
                qrScanner: document.getElementById('qrScannerModal'),
                report: document.getElementById('reportModal'),
                reportFilter: document.getElementById('reportFilterModal'),
            };
            const addSampleForm = document.getElementById('add-sample-form');
            const storageCabinetSelect = document.getElementById('storageCabinet');
            const storageShelfSelect = document.getElementById('storageShelf');
            const storagePositionSelect = document.getElementById('storagePosition');
            const loggedBySelect = document.getElementById('loggedBy');
            const newCabinetNameInput = document.getElementById('newCabinetName');
            const cabinetSettingsContainer = document.getElementById('cabinetSettings');
            const personListContainer = document.getElementById('personList');
            const newPersonNameInput = document.getElementById('newPersonName');
            const moveSampleForm = document.getElementById('move-sample-form');
            const actionForm = document.getElementById('actionForm');
            const batchActionForm = document.getElementById('batchActionForm');
            const batchFinalizeForm = document.getElementById('batchFinalizeForm');
            const scanInputQrBtn = document.getElementById('scanInputQrBtn');
            const scanSearchBtn = document.getElementById('scanSearchBtn');
            const openReportModalBtn = document.getElementById('openReportModalBtn');
            const printReportBtn = document.getElementById('printReportBtn');
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');

            function showNotification(message, duration = 3000) {
                notificationMessage.textContent = message;
                notificationToast.classList.add('toast-visible');
                setTimeout(() => notificationToast.classList.remove('toast-visible'), duration);
            }
            
            function showConfirmation({ title = '確認操作', message, actionText = '確認' }) {
                return new Promise((resolve) => {
                    const modal = modals.confirmation;
                    modal.querySelector('#confirmationTitle').textContent = title;
                    modal.querySelector('#confirmationMessage').textContent = message;
                    const actionBtn = modal.querySelector('#confirmActionBtn');
                    actionBtn.textContent = actionText;
                    openModal(modal);
                    
                    const cancelBtn = modal.querySelector('#confirmCancelBtn');

                    const confirmHandler = () => { closeModal(modal); resolve(true); actionBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
                    const cancelHandler = () => { closeModal(modal); resolve(false); actionBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
                    
                    actionBtn.addEventListener('click', confirmHandler, { once: true });
                    cancelBtn.addEventListener('click', cancelHandler, { once: true });
                });
            }

            // --- QR Code Scanner Functions ---
            function onScanInputSuccess(decodedText, decodedResult) {
                document.getElementById('sampleName').value = decodedText;
                stopScanner();
                showNotification(`已掃描樣品名稱: ${decodedText}`);
            }

            function onScanSearchSuccess(decodedText, decodedResult) {
                stopScanner();
                const sampleId = decodedText.trim();
                const foundSample = sampleInventory.find(s => s.id === sampleId) || stagingSamples.find(s => s.id === sampleId);
                
                if (foundSample) {
                    showSampleDetails(foundSample);
                    showNotification("已找到樣品並顯示詳細資訊。");
                } else {
                    showNotification(`找不到 ID 為 "${sampleId}" 的樣品。`, 4000);
                }
            }


            function startScanner(mode) {
                scannerMode = mode;
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }
                
                const titleEl = modals.qrScanner.querySelector('#qrScannerTitle');
                titleEl.textContent = mode === 'search' ? '掃描以搜尋樣品' : '掃描以輸入名稱';
                openModal(modals.qrScanner);

                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                const successCallback = mode === 'search' ? onScanSearchSuccess : onScanInputSuccess;
                
                Html5Qrcode.getCameras().then(cameras => {
                    if (cameras && cameras.length) {
                        const cameraId = cameras.length > 1 ? { facingMode: "environment" } : cameras[0].id;
                        html5QrCode.start(cameraId, config, successCallback, (errorMessage) => {})
                        .catch((err) => {
                            console.error(`無法啟動掃描: ${err}`);
                            showNotification("無法啟動相機掃描", 4000);
                            closeModal(modals.qrScanner);
                        });
                    } else {
                         showNotification("找不到相機設備", 4000);
                         closeModal(modals.qrScanner);
                    }
                }).catch(err => {
                     showNotification("無法存取相機", 4000);
                     closeModal(modals.qrScanner);
                });
            }

            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        closeModal(modals.qrScanner);
                    }).catch(err => {
                        console.error("停止掃描失敗", err);
                        closeModal(modals.qrScanner);
                    });
                } else {
                    closeModal(modals.qrScanner);
                }
            }


            async function setupListeners() {
                const configRef = doc(db, 'sampleSystem', 'config');
                unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
                    systemConfig = docSnap.exists() ? docSnap.data() : { storageLayout: {}, personnel: [] };
                    updateAllSelects();
                    renderInventoryByCabinet();
                });
                const inventoryQuery = query(collection(db, 'sampleSystem/data/inventory'));
                unsubscribeInventory = onSnapshot(inventoryQuery, (querySnapshot) => {
                    sampleInventory = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInventoryByCabinet();
                    handleSearch();
                    loader.classList.add('hidden');
                    inventoryContent.classList.remove('hidden');
                });
                const stagingQuery = query(collection(db, 'sampleSystem/data/staging'));
                unsubscribeStaging = onSnapshot(stagingQuery, (querySnapshot) => {
                    stagingSamples = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderStagingArea();
                });
                const historyQuery = query(collection(db, 'sampleSystem/data/history'));
                unsubscribeHistory = onSnapshot(historyQuery, (querySnapshot) => {
                    historyLog = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    historyLog.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    renderAllHistoryTables();
                });
            }

            async function saveConfig(configToSave) {
                await setDoc(doc(db, 'sampleSystem', 'config'), configToSave);
                showNotification("設定已儲存");
            }
            
            async function logAction(logData) {
                await addDoc(collection(db, 'sampleSystem/data/history'), { ...logData, timestamp: serverTimestamp() });
            }

            function openModal(modal) { modal.classList.remove('modal-hidden'); modal.classList.add('modal-visible'); modal.querySelector('.modal-content').classList.remove('modal-content-hidden'); modal.querySelector('.modal-content').classList.add('modal-content-visible'); }
            function closeModal(modal) { modal.querySelector('.modal-content').classList.add('modal-content-hidden'); setTimeout(() => { modal.classList.add('modal-hidden'); modal.classList.remove('modal-visible'); }, 300); }

            function createOccupiedSlotCard(sample) {
                const card = document.createElement('div');
                card.className = `slot-card slot-occupied ${selectedSamples.has(sample.id) ? 'selected' : ''}`;
                card.dataset.sampleId = sample.id;

                const locationParts = sample.storageLocation.split(' - ');
                const position = locationParts[locationParts.length - 1];
                const cardDetails = [sample.wireDiameter, sample.applicableStandard, sample.manufacturer].filter(Boolean).slice(0, 2).join(' / ');
                const loggedAtDate = sample.loggedAt?.toDate().toLocaleString('zh-TW', { hour12: false }) || 'N/A';
                
                const tooltipHTML = `<div class="tooltip"><h5 class="font-bold text-base mb-2 border-b border-slate-600 pb-1">${sample.sampleName}</h5><dl class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-left"><dt class="font-semibold text-slate-300">線徑</dt><dd class="truncate" title="${sample.wireDiameter||''}">${sample.wireDiameter||'-'}</dd><dt class="font-semibold text-slate-300">標準</dt><dd class="truncate" title="${sample.applicableStandard||''}">${sample.applicableStandard||'-'}</dd><dt class="font-semibold text-slate-300">製造商</dt><dd class="truncate" title="${sample.manufacturer||''}">${sample.manufacturer||'-'}</dd><dt class="font-semibold text-slate-300">配方</dt><dd class="truncate" title="${sample.formulaCode||''}">${sample.formulaCode||'-'}</dd><dt class="col-span-2 font-semibold text-slate-300 mt-2">位置</dt><dd class="col-span-2">${sample.storageLocation}</dd><dt class="col-span-2 font-semibold text-slate-300 mt-1">登錄者</dt><dd class="col-span-2">${sample.loggedBy} (${loggedAtDate})</dd></dl></div>`;
                
                card.innerHTML = `
                    <div class="absolute top-2 right-2 z-10">
                        <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 sample-checkbox" ${selectedSamples.has(sample.id) ? 'checked' : ''}>
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-base text-slate-800 truncate mb-1 pr-8" title="${sample.sampleName}">${sample.sampleName}</h4>
                            <span class="text-xs font-mono bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">${position.replace('位置 ','')}</span>
                        </div>
                        <p class="text-xs text-slate-500 mb-2 truncate" title="${cardDetails}">${cardDetails||'無詳細資料'}</p>
                    </div>
                    <div class="mt-2 pt-2 border-t border-slate-100 flex justify-between items-center gap-2">
                        <button class="details-btn text-xs text-slate-500 hover:text-blue-600 font-semibold px-2 py-1 rounded-md">詳情</button>
                        <button class="stage-btn text-xs bg-amber-100 text-amber-700 font-semibold px-2 py-1 rounded-md hover:bg-amber-200">暫存</button>
                    </div>
                    ${tooltipHTML}`;
                
                card.addEventListener('click', (e) => {
                    // 忽略在按鈕或複選框上的點擊，避免觸發卡片選取
                    if (e.target.closest('button') || e.target.matches('.sample-checkbox')) {
                        return;
                    }
                    const checkbox = card.querySelector('.sample-checkbox');
                    checkbox.checked = !checkbox.checked;
                    toggleInventorySelection(sample.id, checkbox.checked);
                });

                card.querySelector('.sample-checkbox').addEventListener('click', e => {
                    e.stopPropagation();
                    toggleInventorySelection(sample.id, e.target.checked);
                });

                card.querySelector('.stage-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    openActionModal('stage', sample);
                });

                card.querySelector('.details-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    showSampleDetails(sample);
                });


                return card;
            }

            function toggleInventorySelection(sampleId, isSelected) {
                selectedStagingSamples.clear(); // Clear other selection type
                const cardInGrid = document.querySelector(`.slot-card[data-sample-id="${sampleId}"]`);
                const cardInSearch = document.querySelector(`#searchResultsGrid .slot-card[data-sample-id="${sampleId}"]`);
                
                if (isSelected) {
                    selectedSamples.add(sampleId);
                    if (cardInGrid) cardInGrid.classList.add('selected');
                    if (cardInSearch) cardInSearch.classList.add('selected');
                } else {
                    selectedSamples.delete(sampleId);
                    if (cardInGrid) cardInGrid.classList.remove('selected');
                     if (cardInSearch) cardInSearch.classList.remove('selected');
                }
                updateBatchActionBar();
            }

            function toggleStagingSelection(sampleId, isSelected) {
                selectedSamples.clear(); // Clear other selection type
                const card = document.querySelector(`.staging-card[data-sample-id="${sampleId}"]`);

                if (isSelected) {
                    selectedStagingSamples.add(sampleId);
                    if (card) card.classList.add('selected');
                } else {
                    selectedStagingSamples.delete(sampleId);
                    if (card) card.classList.remove('selected');
                }
                updateBatchActionBar();
            }

            function updateBatchActionBar() {
                const inventoryCount = selectedSamples.size;
                const stagingCount = selectedStagingSamples.size;
                const countEl = batchActionBar.querySelector('#selected-count');
                const stageBtn = document.getElementById('batch-stage-btn');
                const finalizeBtn = document.getElementById('batch-finalize-btn');
                const downloadQrBtn = document.getElementById('batch-download-qr-btn');
                
                document.querySelectorAll('.slot-card.selected, .staging-card.selected').forEach(el => el.classList.remove('selected'));
                document.querySelectorAll('.sample-checkbox:checked, .staging-sample-checkbox:checked').forEach(cb => cb.checked = false);
                
                if (inventoryCount > 0) {
                    countEl.textContent = inventoryCount;
                    stageBtn.classList.remove('hidden');
                    finalizeBtn.classList.add('hidden');
                    downloadQrBtn.classList.remove('hidden');
                    batchActionBar.classList.add('visible');
                    selectedSamples.forEach(id => {
                       document.querySelectorAll(`.slot-card[data-sample-id="${id}"]`).forEach(card => card.classList.add('selected'));
                       document.querySelectorAll(`.slot-card[data-sample-id="${id}"] .sample-checkbox`).forEach(cb => cb.checked = true);
                    });
                } else if (stagingCount > 0) {
                    countEl.textContent = stagingCount;
                    stageBtn.classList.add('hidden');
                    finalizeBtn.classList.remove('hidden');
                    downloadQrBtn.classList.add('hidden');
                    batchActionBar.classList.add('visible');
                    selectedStagingSamples.forEach(id => {
                        const card = document.querySelector(`.staging-card[data-sample-id="${id}"]`);
                        if (card) {
                            card.classList.add('selected');
                            card.querySelector('.staging-sample-checkbox').checked = true;
                        }
                    });
                } else {
                    batchActionBar.classList.remove('visible');
                }
            }
            
            function deselectAll() {
                selectedSamples.clear();
                selectedStagingSamples.clear();
                updateBatchActionBar();
            }

            function createEmptySlotCard(cabinet, shelf, position) {
                const card = document.createElement('div');
                card.className = "slot-card slot-empty";
                card.innerHTML = `<span class="text-2xl font-light">+</span><span class="text-xs mt-1">位置 ${position}</span>`;
                card.addEventListener('click', () => {
                    addSampleForm.reset();
                    updateAddFormSelects();
                    storageCabinetSelect.value = cabinet;
                    storageCabinetSelect.dispatchEvent(new Event('change'));
                    storageShelfSelect.value = shelf;
                    storageShelfSelect.dispatchEvent(new Event('change'));
                    storagePositionSelect.value = `位置 ${position}`;
                    openModal(modals.addSample);
                });
                return card;
            }

            function renderInventoryByCabinet() {
                if (!systemConfig.storageLayout) return;
                const tabsContainer = document.getElementById('cabinet-tabs-container');
                const contentContainer = document.getElementById('cabinet-content-container');
                const currentActiveTab = tabsContainer.querySelector('.active-tab')?.dataset.target;
                
                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '';

                const cabinetNames = Object.keys(systemConfig.storageLayout);
                if (cabinetNames.length === 0) { inventoryOverviewSection.innerHTML = '<p class="text-slate-500">尚未設定任何櫃子。請至系統設定新增。</p>'; return; }
                const samplesByLocation = new Map(sampleInventory.map(s => [s.storageLocation, s]));
                
                let tabToActivate = currentActiveTab;
                if (!tabToActivate || !cabinetNames.map(name => `tab-${name.replace(/\s/g, '-')}`).includes(tabToActivate)) {
                    tabToActivate = `tab-${cabinetNames[0].replace(/\s/g, '-')}`;
                }

                cabinetNames.forEach((cabinetName, index) => {
                    const tabId = `tab-${cabinetName.replace(/\s/g, '-')}`;
                    const isActive = tabId === tabToActivate;
                    const tabBtn = document.createElement('button');
                    tabBtn.className = `tab-btn text-sm sm:text-base font-semibold py-3 px-4 border-b-2 whitespace-nowrap ${isActive ? 'active-tab' : ''}`;
                    tabBtn.textContent = cabinetName;
                    tabBtn.dataset.target = tabId;
                    tabsContainer.appendChild(tabBtn);

                    const tabContent = document.createElement('div');
                    tabContent.id = tabId;
                    tabContent.className = `space-y-6 tab-content ${isActive ? '' : 'hidden'}`;
                    const shelves = systemConfig.storageLayout[cabinetName];

                    if (shelves && Object.keys(shelves).length > 0) {
                        Object.entries(shelves).forEach(([shelfName, capacity]) => {
                            const shelfContainer = document.createElement('div');
                            shelfContainer.innerHTML = `<h3 class="text-lg font-semibold text-slate-700 mb-3">${shelfName}</h3>`;
                            const gridContainer = document.createElement('div');
                            gridContainer.className = 'shelf-grid';
                            for (let i = 1; i <= capacity; i++) {
                                const locationString = `${cabinetName} - ${shelfName} - 位置 ${i}`;
                                const sample = samplesByLocation.get(locationString);
                                gridContainer.appendChild(sample ? createOccupiedSlotCard(sample) : createEmptySlotCard(cabinetName, shelfName, i));
                            }
                            shelfContainer.appendChild(gridContainer);
                            tabContent.appendChild(shelfContainer);
                        });
                    } else {
                        tabContent.innerHTML = '<p class="text-center py-8 text-slate-500">此櫃子尚未設定任何層架。</p>';
                    }
                    contentContainer.appendChild(tabContent);
                });
                if (tabsContainer.children.length > 0) makeSliderScrollable(tabsContainer);
            }

            function renderStagingArea() {
                stagingAreaGrid.innerHTML = '';
                noStagingSamplesMessage.classList.toggle('hidden', stagingSamples.length > 0);
                stagingAreaGrid.classList.toggle('hidden', stagingSamples.length === 0);
                if (stagingSamples.length > 0) {
                    stagingSamples.forEach(sample => stagingAreaGrid.appendChild(createStagingCard(sample)));
                }
            }

            function createStagingCard(sample) {
                const card = document.createElement('div');
                card.className = `p-4 sm:p-5 flex flex-col staging-card ${selectedStagingSamples.has(sample.id) ? 'selected' : ''}`;
                card.dataset.sampleId = sample.id;

                const fieldLabels = {
                    wireDiameter: "線徑",
                    applicableStandard: "適用標準",
                    manufacturer: "製造商",
                    formulaCode: "配方代號",
                    processDetails: "製程明細",
                    furnaceNo: "爐號",
                    batchNo: "批號",
                };

                let detailsHTML = '';
                for (const [key, label] of Object.entries(fieldLabels)) {
                    if (sample[key]) {
                        detailsHTML += `
                            <dt class="text-amber-600 font-medium">${label}</dt>
                            <dd class="col-span-2 text-amber-800 truncate" title="${sample[key]}">${sample[key]}</dd>
                        `;
                    }
                }

                card.innerHTML = `
                    <div class="absolute top-2 right-2 z-10">
                        <input type="checkbox" class="h-4 w-4 rounded border-gray-400 text-blue-600 focus:ring-blue-500 staging-sample-checkbox" ${selectedStagingSamples.has(sample.id) ? 'checked' : ''}>
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg text-amber-900 truncate mb-1 pr-8" title="${sample.sampleName}">${sample.sampleName}</h4>
                        <p class="text-sm text-amber-700 mb-2">原位置: ${sample.storageLocation}</p>
                        <div class="mt-2 pt-2 border-t border-amber-200 text-xs space-y-1">
                            <dl class="grid grid-cols-3 gap-x-2">
                                ${detailsHTML}
                            </dl>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-amber-200 grid grid-cols-3 gap-2">
                        <button class="return-btn text-sm bg-green-100 text-green-800 font-semibold px-2 py-1.5 rounded-md hover:bg-green-200">放回</button>
                        <button class="move-btn text-sm bg-blue-100 text-blue-800 font-semibold px-2 py-1.5 rounded-md hover:bg-blue-200">移位</button>
                        <button class="finalize-btn text-sm bg-red-100 text-red-800 font-semibold px-2 py-1.5 rounded-md hover:bg-red-200">歸檔</button>
                    </div>`;

                card.addEventListener('click', (e) => {
                    // 忽略在按鈕或複選框上的點擊，避免觸發卡片選取
                    if (e.target.closest('button') || e.target.matches('.staging-sample-checkbox')) {
                        return;
                    }
                    const checkbox = card.querySelector('.staging-sample-checkbox');
                    checkbox.checked = !checkbox.checked;
                    toggleStagingSelection(sample.id, checkbox.checked);
                });

                card.querySelector('.staging-sample-checkbox').addEventListener('click', e => {
                    e.stopPropagation();
                    toggleStagingSelection(sample.id, e.target.checked);
                });

                card.querySelector('.return-btn').addEventListener('click', (e) => { e.stopPropagation(); openActionModal('return', sample); });
                card.querySelector('.move-btn').addEventListener('click', (e) => { e.stopPropagation(); handleMoveFromStaging(sample); });
                card.querySelector('.finalize-btn').addEventListener('click', (e) => { e.stopPropagation(); openActionModal('finalize', sample); });
                return card;
            }

            function showSampleDetails(sample) {
                const contentContainer = document.getElementById('sampleDetailContent');
                const footerContainer = document.getElementById('sampleDetailFooter');
                const loggedAtDate = sample.loggedAt?.toDate().toLocaleString('zh-TW', { hour12: false }) || 'N/A';
                
                contentContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6">
                            <div class="sm:col-span-2"><dt class="text-sm font-medium text-slate-500">樣品名稱</dt><dd class="mt-1 text-lg font-semibold text-slate-900">${sample.sampleName||'-'}</dd></div>
                            <div><dt class="text-sm font-medium text-slate-500">線徑</dt><dd class="mt-1 text-lg text-slate-900">${sample.wireDiameter||'-'}</dd></div>
                            <div class="sm:col-span-2"><hr class="border-slate-200"></div>
                            <div><dt class="text-sm font-medium text-slate-500">適用標準</dt><dd class="mt-1 text-slate-800">${sample.applicableStandard||'-'}</dd></div>
                            <div><dt class="text-sm font-medium text-slate-500">製造商</dt><dd class="mt-1 text-slate-800">${sample.manufacturer||'-'}</dd></div>
                            <div><dt class="text-sm font-medium text-slate-500">配方代號</dt><dd class="mt-1 text-slate-800">${sample.formulaCode||'-'}</dd></div>
                            <div class="sm:col-span-2"><hr class="border-slate-200"></div>
                            <div class="sm:col-span-2"><dt class="text-sm font-medium text-slate-500">存放位置</dt><dd class="mt-1 text-slate-800">${sample.storageLocation||'-'}</dd></div>
                            <div><dt class="text-sm font-medium text-slate-500">登錄人員</dt><dd class="mt-1 text-slate-800">${sample.loggedBy||'-'}</dd></div>
                            <div class="sm:col-span-2"><dt class="text-sm font-medium text-slate-500">登錄時間</dt><dd class="mt-1 text-slate-800">${loggedAtDate}</dd></div>
                        </dl>
                    </div>
                    <div class="text-center p-4 bg-slate-50 rounded-lg flex flex-col items-center justify-center">
                        <h4 class="font-semibold text-slate-600 mb-2">樣品 QR Code</h4>
                        <div id="qrCodeContainer" class="w-40 h-40"></div>
                        <p class="text-xs text-slate-500 mt-2 break-all">ID: ${sample.id}</p>
                        <button id="downloadQrBtn" class="mt-4 text-sm bg-slate-200 text-slate-700 font-semibold px-3 py-1.5 rounded-md hover:bg-slate-300 w-full">下載 QR Code</button>
                    </div>
                </div>`;

                const qrContainer = document.getElementById('qrCodeContainer');
                if (qrContainer) {
                    try {
                        const qr = qrcode(0, 'M');
                        qr.addData(sample.id);
                        qr.make();
                        const qrDataURL = qr.createDataURL(4, 8);
                        qrContainer.innerHTML = `<img src="${qrDataURL}" style="width: 100%; height: 100%;">`;
                        
                        document.getElementById('downloadQrBtn').addEventListener('click', () => {
                            const link = document.createElement('a');
                            link.href = qrDataURL;
                            link.download = `${sample.sampleName || 'qrcode'}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        });

                    } catch (err) {
                        qrContainer.innerHTML = '<p class="text-xs text-red-500">無法產生 QR Code</p>';
                        console.error("QR Code generation failed:", err);
                    }
                }
                
                const sampleIsInInventory = sampleInventory.some(s => s.id === sample.id);
                if (sampleIsInInventory) {
                    footerContainer.innerHTML = `<button id="detailStageBtn" class="bg-amber-500 text-white font-semibold px-5 py-2.5 rounded-lg hover:bg-amber-600">移至暫存區</button>`;
                    footerContainer.querySelector('#detailStageBtn').addEventListener('click', () => { closeModal(modals.sampleDetail); openActionModal('stage', sample); });
                } else {
                    footerContainer.innerHTML = '';
                }

                openModal(modals.sampleDetail);
            }
            
            function createHistoryTableHTML(data) {
                if (data.length === 0) return '<p class="text-center py-8 text-slate-500">此分類沒有歷史紀錄</p>';
                const rows = data.map(log => {
                    const timestamp = log.timestamp?.toDate().toLocaleString('zh-TW') || 'N/A';
                    let actionClass = '', locationInfo = log.storageLocation || '';
                    if (log.action === '放入') actionClass = 'text-green-600';
                    else if (log.action === '最終取出' || log.action === '批次最終取出') actionClass = 'text-red-600';
                    else if (log.action === '移至暫存' || log.action === '批次移至暫存') actionClass = 'text-amber-600';
                    else if (log.action === '放回儲位') actionClass = 'text-sky-600';
                    else if (log.action === '移動') { actionClass = 'text-blue-600'; locationInfo = `<span class="text-xs text-slate-400 block">${log.fromLocation}</span> → ${log.toLocation}`; }
                    
                    let sampleNameDisplay = log.sampleName;
                    if(log.action.startsWith('批次')) {
                        sampleNameDisplay = `批次操作 (${log.count} 個)`;
                    }

                    return `<tr><td class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-200 text-sm whitespace-nowrap">${timestamp}</td><td class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-200 font-semibold ${actionClass}">${log.action}</td><td class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-200 font-medium text-slate-800">${sampleNameDisplay}</td><td class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-200 text-xs text-slate-500 hidden md:table-cell">${log.details||''}</td><td class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-200 text-sm hidden sm:table-cell">${locationInfo}</td><td class="px-4 py-3 sm:px-6 sm:py-4 border-b border-slate-200">${log.person}</td></tr>`;
                }).join('');
                return `<div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 border-b border-slate-200"><tr><th class="px-4 py-3 sm:px-6 sm:py-4 font-semibold text-slate-600 text-sm">時間</th><th class="px-4 py-3 sm:px-6 sm:py-4 font-semibold text-slate-600 text-sm">操作</th><th class="px-4 py-3 sm:px-6 sm:py-4 font-semibold text-slate-600 text-sm">樣品名稱</th><th class="px-4 py-3 sm:px-6 sm:py-4 font-semibold text-slate-600 text-sm hidden md:table-cell">詳細資訊</th><th class="px-4 py-3 sm:px-6 sm:py-4 font-semibold text-slate-600 text-sm hidden sm:table-cell">位置/備註</th><th class="px-4 py-3 sm:px-6 sm:py-4 font-semibold text-slate-600 text-sm">操作人員</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }

            function renderAllHistoryTables() {
                document.getElementById('historyTab-add').innerHTML = createHistoryTableHTML(historyLog.filter(l => l.action === '放入'));
                document.getElementById('historyTab-stage').innerHTML = createHistoryTableHTML(historyLog.filter(l => l.action === '移至暫存' || l.action === '批次移至暫存'));
                document.getElementById('historyTab-return').innerHTML = createHistoryTableHTML(historyLog.filter(l => l.action === '放回儲位'));
                document.getElementById('historyTab-move').innerHTML = createHistoryTableHTML(historyLog.filter(l => l.action === '移動'));
                document.getElementById('historyTab-finalize').innerHTML = createHistoryTableHTML(historyLog.filter(l => l.action === '最終取出' || l.action === '批次最終取出'));
            }
            
            function generateReportTable(data) {
                let tableHTML = `
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3 font-semibold">位置</th>
                                <th class="p-3 font-semibold">樣品名稱</th>
                                <th class="p-3 font-semibold">線徑</th>
                                <th class="p-3 font-semibold">適用標準</th>
                                <th class="p-3 font-semibold">製造商</th>
                                <th class="p-3 font-semibold">登錄人員</th>
                                <th class="p-3 font-semibold">登錄時間</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(sample => {
                    const loggedAtDate = sample.loggedAt?.toDate().toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short', hour12: false }) || 'N/A';
                    tableHTML += `
                        <tr class="border-b border-slate-200">
                            <td class="p-3">${sample.storageLocation || '-'}</td>
                            <td class="p-3 font-medium">${sample.sampleName || '-'}</td>
                            <td class="p-3">${sample.wireDiameter || '-'}</td>
                            <td class="p-3">${sample.applicableStandard || '-'}</td>
                            <td class="p-3">${sample.manufacturer || '-'}</td>
                            <td class="p-3">${sample.loggedBy || '-'}</td>
                            <td class="p-3">${loggedAtDate}</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                return tableHTML;
            }

            function renderInventoryReport(selectedCabinet = 'all') {
                const reportContent = document.getElementById('reportContent');
                let inventoryToReport = [];

                if (selectedCabinet === 'all') {
                    inventoryToReport = [...sampleInventory];
                } else {
                    inventoryToReport = sampleInventory.filter(s => s.storageLocation.startsWith(selectedCabinet));
                }
                
                currentReportData = [...inventoryToReport].sort((a, b) => a.storageLocation.localeCompare(b.storageLocation));

                if (currentReportData.length === 0) {
                    reportContent.innerHTML = '<p class="text-center py-8 text-slate-500">此範圍內沒有庫存樣品。</p>';
                    return;
                }

                const reportDate = new Date().toLocaleString('zh-TW', { hour12: false });
                let finalHTML = `
                    <div class="mb-4 text-center">
                        <h3 class="text-2xl font-bold">樣品庫存報表</h3>
                        <p class="text-sm text-slate-500">報表範圍：${selectedCabinet === 'all' ? '全部櫃子' : selectedCabinet}</p>
                        <p class="text-sm text-slate-500">報表生成時間：${reportDate}</p>
                        <p class="text-sm text-slate-500">總筆數：${currentReportData.length}</p>
                    </div>
                `;

                if (selectedCabinet === 'all') {
                    const groupedByCabinet = currentReportData.reduce((acc, sample) => {
                        const cabinetName = sample.storageLocation.split(' - ')[0];
                        if (!acc[cabinetName]) {
                            acc[cabinetName] = [];
                        }
                        acc[cabinetName].push(sample);
                        return acc;
                    }, {});

                    Object.keys(groupedByCabinet).sort().forEach(cabinetName => {
                         finalHTML += `<h4 class="text-lg font-semibold mt-6 mb-3 p-2 bg-slate-200 rounded-md">${cabinetName}</h4>`;
                         finalHTML += generateReportTable(groupedByCabinet[cabinetName]);
                    });

                } else {
                    finalHTML += generateReportTable(currentReportData);
                }
                
                reportContent.innerHTML = finalHTML;
            }

            function handlePrintReport() {
                const reportContentHTML = document.getElementById('reportContent').innerHTML;
                const styles = `
                    <style>
                        body { font-family: 'Noto Sans TC', sans-serif; line-height: 1.5; }
                        h3, h4, p { text-align: center; }
                        h3 { font-size: 1.5rem; margin-bottom: 0.5rem; }
                        h4 { font-size: 1.2rem; margin-top: 1.5rem; margin-bottom: 0.5rem; padding: 0.25rem; background-color: #f1f5f9; page-break-before: auto; page-break-after: avoid; }
                        p { font-size: 0.875rem; color: #555; margin-bottom: 1rem; }
                        table { width: 100%; border-collapse: collapse; font-size: 10pt; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; word-break: break-word; }
                        thead { display: table-header-group; }
                        tr { page-break-inside: avoid; }
                        th { background-color: #f8fafc; }
                        @page { size: A4; margin: 1.5cm; }
                    </style>
                `;

                const printWindow = window.open('', '', 'height=800,width=1200');
                printWindow.document.write('<html><head><title>庫存報表</title>');
                printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">');
                printWindow.document.write(styles);
                printWindow.document.write('</head><body>');
                printWindow.document.write(reportContentHTML);
                printWindow.document.write('<script>window.onload = function() { window.print(); window.close(); };<\/script>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
            }

            function handleDownloadCsv() {
                if (currentReportData.length === 0) {
                    showNotification('沒有庫存資料可供下載。');
                    return;
                }

                const headers = ["位置", "樣品名稱", "線徑", "適用標準", "製造商", "配方代號", "製程明細", "爐號", "批號", "登錄人員", "登錄時間"];
                
                const escapeCsvCell = (cell) => {
                    const str = String(cell === null || cell === undefined ? '' : cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                let csvContent = headers.map(escapeCsvCell).join(',') + '\r\n';

                currentReportData.forEach(sample => {
                    const loggedAtDate = sample.loggedAt?.toDate().toLocaleString('zh-TW', { hour12: false }) || '';
                    const row = [
                        sample.storageLocation, sample.sampleName, sample.wireDiameter,
                        sample.applicableStandard, sample.manufacturer, sample.formulaCode,
                        sample.processDetails, sample.furnaceNo, sample.batchNo,
                        sample.loggedBy, loggedAtDate
                    ];
                    csvContent += row.map(escapeCsvCell).join(',') + '\r\n';
                });

                const bom = '\uFEFF';
                const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const reportDate = new Date().toISOString().slice(0, 10);
                link.setAttribute("download", `樣品庫存報表_${reportDate}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('CSV 檔案已開始下載。');
            }
            
            async function handleBatchDownloadQr() {
                if (typeof JSZip === 'undefined') {
                    showNotification('無法載入壓縮函式庫，請稍後再試。');
                    return;
                }
                const samplesToDownload = Array.from(selectedSamples).map(id => sampleInventory.find(s => s.id === id)).filter(Boolean);
                if (samplesToDownload.length === 0) return;

                showNotification(`正在準備 ${samplesToDownload.length} 個 QR Code...`);

                const zip = new JSZip();
                
                samplesToDownload.forEach(sample => {
                    try {
                        const qr = qrcode(0, 'M');
                        qr.addData(sample.id);
                        qr.make();
                        const qrDataURL = qr.createDataURL(4, 0);
                        const base64Data = qrDataURL.substring(qrDataURL.indexOf(',') + 1);
                        const fileName = (sample.sampleName || sample.id).replace(/[^a-z0-9_.-]/gi, '_') + '.png';
                        zip.file(fileName, base64Data, { base64: true });
                    } catch (err) {
                        console.error(`無法為樣品 "${sample.sampleName}" 產生 QR Code:`, err);
                    }
                });

                try {
                    const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(content);
                    link.href = url;
                    const date = new Date().toISOString().slice(0, 10);
                    link.download = `樣品QR_Codes_${date}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    deselectAll();
                } catch(err) {
                     showNotification('壓縮 QR Code 檔案失敗。', 4000);
                     console.error('Zipping failed:', err);
                }
            }


            function openActionModal(action, sample) {
                actionForm.reset();
                const title = modals.action.querySelector('#actionModalTitle');
                const message = modals.action.querySelector('#actionModalMessage');
                const confirmBtn = modals.action.querySelector('#actionConfirmBtn');
                const remarksContainer = modals.action.querySelector('#remarksContainer');
                const remarksTextarea = modals.action.querySelector('#actionRemarks');
                const personSelect = modals.action.querySelector('#actionPerson');

                modals.action.querySelector('#actionSampleId').value = sample.id;
                modals.action.querySelector('#actionType').value = action;
                
                personSelect.innerHTML = '<option value="">--- 請選擇人員 ---</option>';
                (systemConfig.personnel || []).forEach(p => personSelect.innerHTML += `<option value="${p}">${p}</option>`);

                remarksContainer.classList.add('hidden');
                remarksTextarea.required = false;
                confirmBtn.className = "text-white font-semibold px-5 py-2.5 rounded-lg";

                switch(action) {
                    case 'stage':
                        title.textContent = '移至暫存區';
                        message.textContent = `您確定要將樣品 "${sample.sampleName}" 從儲位取出嗎？`;
                        confirmBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
                        confirmBtn.textContent = '確認移至暫存';
                        break;
                    case 'return':
                         title.textContent = '放回原位';
                        message.textContent = `您確定要將樣品 "${sample.sampleName}" 放回原位 (${sample.storageLocation}) 嗎？`;
                        confirmBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        confirmBtn.textContent = '確認放回';
                        break;
                    case 'finalize':
                        title.textContent = '最終取出 (歸檔)';
                        message.textContent = `此操作將會歸檔樣品 "${sample.sampleName}"，無法復原。`;
                        remarksContainer.classList.remove('hidden');
                        remarksTextarea.required = true;
                        confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                        confirmBtn.textContent = '確認並歸檔';
                        break;
                }
                openModal(modals.action);
            }
            
            async function handleActionFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const sampleId = form.actionSampleId.value;
                const type = form.actionType.value;
                const person = form.actionPerson.value;
                
                if (!person) { showNotification('請選擇操作人員！'); return; }

                let sample;
                if(type === 'stage') {
                    sample = sampleInventory.find(s => s.id === sampleId);
                } else {
                    sample = stagingSamples.find(s => s.id === sampleId);
                }
                if (!sample) { showNotification('找不到樣品資料，請重新整理。'); return; }
                const { id, ...originalData } = sample;

                try {
                    switch(type) {
                        case 'stage':
                            await setDoc(doc(db, 'sampleSystem/data/staging', id), originalData);
                            await deleteDoc(doc(db, 'sampleSystem/data/inventory', id));
                            await logAction({ action: '移至暫存', person, sampleName: sample.sampleName, storageLocation: sample.storageLocation });
                            showNotification(`樣品 "${sample.sampleName}" 已移至暫存區。`);
                            break;
                        case 'return':
                            const isOccupied = sampleInventory.some(s => s.storageLocation === sample.storageLocation);
                            if (isOccupied) { showNotification("原位置已被佔用，請改用「移至新位」。"); closeModal(modals.action); return; }
                            await setDoc(doc(db, 'sampleSystem/data/inventory', id), originalData);
                            await deleteDoc(doc(db, 'sampleSystem/data/staging', id));
                            await logAction({ action: '放回儲位', person, sampleName: sample.sampleName, storageLocation: sample.storageLocation });
                            showNotification("樣品已成功放回原位。");
                            break;
                        case 'finalize':
                            const remarks = form.actionRemarks.value.trim();
                            if(!remarks) { showNotification('請填寫備註事項！'); return; }
                            await addDoc(collection(db, 'sampleSystem/data/archived'), { ...originalData, archivedAt: serverTimestamp(), remarks });
                            await deleteDoc(doc(db, 'sampleSystem/data/staging', id));
                            await logAction({ action: '最終取出', person, sampleName: sample.sampleName, details: remarks, storageLocation: sample.storageLocation });
                            showNotification(`樣品 "${sample.sampleName}" 已歸檔。`);
                            break;
                    }
                    closeModal(modals.action);
                } catch (error) {
                    console.error("Action failed: ", error);
                    showNotification("操作失敗，請稍後再試。");
                }
            }

            function handleMoveFromStaging(sample) {
                const moveModal = modals.moveSample;
                moveModal.querySelector('#moveSampleId').value = sample.id;
                moveModal.querySelector('#moveSampleSource').value = 'staging';
                moveModal.querySelector('#moveSampleName').textContent = sample.sampleName;
                moveModal.querySelector('#moveSampleOldLocation').textContent = `暫存區 (原位置: ${sample.storageLocation})`;
                const movedBySelect = moveModal.querySelector('#movedBy');
                movedBySelect.innerHTML = '<option value="">--- 請選擇人員 ---</option>';
                (systemConfig.personnel || []).forEach(p => movedBySelect.innerHTML += `<option value="${p}">${p}</option>`);
                updateMoveFormSelects();
                openModal(moveModal);
            }
            
            function updateAllSelects() { updateSearchSelects(); updateAddFormSelects(); }
            function updateAddShelves() {
                const selectedCabinet = storageCabinetSelect.value;
                storageShelfSelect.innerHTML = '<option value="">--- 請選擇層數 ---</option>'; storageShelfSelect.disabled = true;
                storagePositionSelect.innerHTML = '<option value="">--- 請選擇位置 ---</option>'; storagePositionSelect.disabled = true;
                if (!selectedCabinet || !systemConfig.storageLayout?.[selectedCabinet]) return;
                const occupiedCounts = sampleInventory.reduce((acc, s) => { const key = s.storageLocation.split(' - ').slice(0, 2).join(' - '); acc[key] = (acc[key] || 0) + 1; return acc; }, {});
                let availableShelvesHTML = '';
                Object.keys(systemConfig.storageLayout[selectedCabinet]).forEach(shelfName => {
                    const capacity = systemConfig.storageLayout[selectedCabinet][shelfName];
                    const itemsOnShelf = occupiedCounts[`${selectedCabinet} - ${shelfName}`] || 0;
                    if (itemsOnShelf < capacity) availableShelvesHTML += `<option value="${shelfName}">${shelfName}</option>`;
                });
                if (availableShelvesHTML) { storageShelfSelect.innerHTML += availableShelvesHTML; storageShelfSelect.disabled = false; } else { storageShelfSelect.innerHTML = '<option value="">此櫃無空位</option>'; }
            }
            function updateAddPositions() {
                const selectedCabinet = storageCabinetSelect.value, selectedShelf = storageShelfSelect.value;
                storagePositionSelect.innerHTML = '<option value="">--- 請選擇位置 ---</option>'; storagePositionSelect.disabled = true;
                if (!selectedCabinet || !selectedShelf || !systemConfig.storageLayout?.[selectedCabinet]?.[selectedShelf]) return;
                const capacity = systemConfig.storageLayout[selectedCabinet][selectedShelf];
                const occupiedPositions = new Set(sampleInventory.filter(s => s.storageLocation.startsWith(`${selectedCabinet} - ${selectedShelf}`)).map(s => parseInt(s.storageLocation.split(' - ')[2].replace('位置 ', ''), 10)));
                let availablePositionsHTML = '';
                for (let i = 1; i <= capacity; i++) { if (!occupiedPositions.has(i)) availablePositionsHTML += `<option value="位置 ${i}">位置 ${i}</option>`; }
                if (availablePositionsHTML) { storagePositionSelect.innerHTML += availablePositionsHTML; storagePositionSelect.disabled = false; } else { storagePositionSelect.innerHTML = '<option value="">此層已滿</option>'; }
            }
            function updateMoveShelves() {
                const cabinetSelect = document.getElementById('moveStorageCabinet');
                const shelfSelect = document.getElementById('moveStorageShelf');
                const positionSelect = document.getElementById('moveStoragePosition');
                const selectedCabinet = cabinetSelect.value;
                shelfSelect.innerHTML = '<option value="">--- 請選擇層數 ---</option>'; shelfSelect.disabled = true;
                positionSelect.innerHTML = '<option value="">--- 請選擇位置 ---</option>'; positionSelect.disabled = true;
                if (!selectedCabinet || !systemConfig.storageLayout?.[selectedCabinet]) return;
                const occupiedCounts = sampleInventory.reduce((acc, s) => { const key = s.storageLocation.split(' - ').slice(0, 2).join(' - '); acc[key] = (acc[key] || 0) + 1; return acc; }, {});
                let availableShelvesHTML = '';
                Object.keys(systemConfig.storageLayout[selectedCabinet]).forEach(shelfName => {
                    const capacity = systemConfig.storageLayout[selectedCabinet][shelfName];
                    const itemsOnShelf = occupiedCounts[`${selectedCabinet} - ${shelfName}`] || 0;
                    if (itemsOnShelf < capacity) availableShelvesHTML += `<option value="${shelfName}">${shelfName}</option>`;
                });
                if (availableShelvesHTML) { shelfSelect.innerHTML += availableShelvesHTML; shelfSelect.disabled = false; } else { shelfSelect.innerHTML = '<option value="">此櫃無空位</option>'; }
            }
            function updateMovePositions() {
                const cabinetSelect = document.getElementById('moveStorageCabinet'), shelfSelect = document.getElementById('moveStorageShelf'), positionSelect = document.getElementById('moveStoragePosition');
                const selectedCabinet = cabinetSelect.value, selectedShelf = shelfSelect.value;
                positionSelect.innerHTML = '<option value="">--- 請選擇位置 ---</option>'; positionSelect.disabled = true;
                if (!selectedCabinet || !selectedShelf || !systemConfig.storageLayout?.[selectedCabinet]?.[selectedShelf]) return;
                const capacity = systemConfig.storageLayout[selectedCabinet][selectedShelf];
                const occupiedPositions = new Set(sampleInventory.filter(s => s.storageLocation.startsWith(`${selectedCabinet} - ${selectedShelf}`)).map(s => parseInt(s.storageLocation.split(' - ')[2].replace('位置 ', ''), 10)));
                let availablePositionsHTML = '';
                for (let i = 1; i <= capacity; i++) { if (!occupiedPositions.has(i)) availablePositionsHTML += `<option value="位置 ${i}">位置 ${i}</option>`; }
                if (availablePositionsHTML) { positionSelect.innerHTML += availablePositionsHTML; positionSelect.disabled = false; } else { positionSelect.innerHTML = '<option value="">此層已滿</option>'; }
            }
            function handleSearch() {
                deselectAll();
                const query = searchInput.value.toLowerCase().trim();
                const cabinet = searchCabinetSelect.value;
                const person = searchPersonSelect.value;
                if (!query && !cabinet && !person) { searchResultsContainer.classList.add('hidden'); return; }
                const results = sampleInventory.filter(sample => {
                    const sampleString = Object.values(sample).join(' ').toLowerCase();
                    return (!query || sampleString.includes(query)) && (!cabinet || sample.storageLocation.startsWith(cabinet)) && (!person || sample.loggedBy === person);
                });
                searchResultsGrid.innerHTML = '';
                if (results.length > 0) { results.forEach(sample => searchResultsGrid.appendChild(createOccupiedSlotCard(sample))); } else { searchResultsGrid.innerHTML = '<p class="text-slate-500 col-span-full">找不到符合條件的樣品。</p>'; }
                searchResultsContainer.classList.remove('hidden');
            }
            function updateSearchSelects() {
                searchCabinetSelect.innerHTML = '<option value="">所有櫃子</option>';
                Object.keys(systemConfig.storageLayout || {}).forEach(name => searchCabinetSelect.innerHTML += `<option value="${name}">${name}</option>`);
                searchPersonSelect.innerHTML = '<option value="">所有人員</option>';
                (systemConfig.personnel || []).forEach(p => searchPersonSelect.innerHTML += `<option value="${p}">${p}</option>`);
            }
            function updateAddFormSelects() {
                storageCabinetSelect.innerHTML = '<option value="">--- 請選擇櫃子 ---</option>';
                Object.keys(systemConfig.storageLayout || {}).forEach(name => storageCabinetSelect.innerHTML += `<option value="${name}">${name}</option>`);
                loggedBySelect.innerHTML = '<option value="">--- 請選擇登錄人員 ---</option>';
                (systemConfig.personnel || []).forEach(p => loggedBySelect.innerHTML += `<option value="${p}">${p}</option>`);
                storageShelfSelect.innerHTML = '<option value="">--- 請選擇層數 ---</option>'; storageShelfSelect.disabled = true;
                storagePositionSelect.innerHTML = '<option value="">--- 請選擇位置 ---</option>'; storagePositionSelect.disabled = true;
            }
            function updateMoveFormSelects() {
                const cabinetSelect = document.getElementById('moveStorageCabinet');
                cabinetSelect.innerHTML = '<option value="">--- 請選擇櫃子 ---</option>';
                Object.keys(systemConfig.storageLayout || {}).forEach(name => cabinetSelect.innerHTML += `<option value="${name}">${name}</option>`);
                document.getElementById('moveStorageShelf').disabled = true;
                document.getElementById('moveStoragePosition').disabled = true;
            }
            async function handleAddSample(e) {
                e.preventDefault();
                const form = e.target;
                const sampleName = form.sampleName.value.trim();
                const wireDiameter = form.wireDiameter.value.trim();
                const loggedBy = form.loggedBy.value;
                const cabinet = form.storageCabinet.value, shelf = form.storageShelf.value, position = form.storagePosition.value;
                if (!sampleName || !wireDiameter || !loggedBy || !cabinet || !shelf || !position) { showNotification('請填寫所有必填欄位！'); return; }
                const optionalFields = { applicableStandard: form.applicableStandard.value.trim(), manufacturer: form.manufacturer.value.trim(), formulaCode: form.formulaCode.value.trim(), processDetails: form.processDetails.value.trim(), furnaceNo: form.furnaceNo.value.trim(), batchNo: form.batchNo.value.trim() };
                if (Object.values(optionalFields).every(f => f === '')) { showNotification('適用標準、製造商等欄位至少需填寫一項。'); return; }
                const storageLocation = `${cabinet} - ${shelf} - ${position}`;
                const newSample = { sampleName, wireDiameter, ...optionalFields, storageLocation, loggedBy, loggedAt: serverTimestamp() };
                const details = Object.entries({線徑: wireDiameter, ...optionalFields}).filter(([_,v]) => v).map(([k,v]) => `${k}:${v}`).join(', ');
                try {
                    await addDoc(collection(db, 'sampleSystem/data/inventory'), newSample);
                    await logAction({ action: '放入', person: loggedBy, sampleName, details, storageLocation });
                    showNotification("樣品已成功存入");
                    form.reset();
                    closeModal(modals.addSample);
                } catch (error) { console.error("Error adding document: ", error); showNotification("存入失敗，請稍後再試"); }
            }
            async function handleMoveSample(e) {
                e.preventDefault();
                const form = e.target;
                const sampleId = form.moveSampleId.value;
                const source = form.moveSampleSource.value;
                const cabinet = form.moveStorageCabinet.value, shelf = form.moveStorageShelf.value, position = form.moveStoragePosition.value;
                const movedBy = form.movedBy.value;
                if (!cabinet || !shelf || !position || !movedBy) { showNotification('請完整填寫所有欄位！'); return; }
                const sampleData = source === 'staging' ? stagingSamples.find(s => s.id === sampleId) : sampleInventory.find(s => s.id === sampleId);
                if (!sampleData) return;
                const fromLocation = source === 'staging' ? `暫存區 (原: ${sampleData.storageLocation})` : sampleData.storageLocation;
                const toLocation = `${cabinet} - ${shelf} - ${position}`;
                try {
                    const { id, ...originalData } = sampleData;
                    await setDoc(doc(db, 'sampleSystem/data/inventory', id), { ...originalData, storageLocation: toLocation });
                    if (source === 'staging') await deleteDoc(doc(db, 'sampleSystem/data/staging', id));
                    await logAction({ action: '移動', person: movedBy, sampleName: sampleData.sampleName, fromLocation, toLocation });
                    showNotification("樣品已成功移動");
                    form.reset();
                    closeModal(modals.moveSample);
                } catch (error) { console.error("Error moving sample: ", error); showNotification("移動失敗，請稍後再試"); }
            }
            async function handleBatchStageSubmit(e) {
                e.preventDefault();
                const person = batchActionForm.batchActionPerson.value;
                if (!person) { showNotification('請選擇操作人員！'); return; }

                const batch = writeBatch(db);
                const samplesToMove = Array.from(selectedSamples).map(id => sampleInventory.find(s => s.id === id)).filter(Boolean);

                if (samplesToMove.length === 0) {
                    showNotification('沒有有效的樣品可供移動。');
                    return;
                }

                samplesToMove.forEach(sample => {
                    const { id, ...data } = sample;
                    const inventoryRef = doc(db, 'sampleSystem/data/inventory', id);
                    const stagingRef = doc(db, 'sampleSystem/data/staging', id);
                    batch.set(stagingRef, data);
                    batch.delete(inventoryRef);
                });
                
                const historyRef = collection(db, 'sampleSystem/data/history');
                const logEntry = { action: '批次移至暫存', person, count: samplesToMove.length, details: `批次移動 ${samplesToMove.length} 個樣品`, timestamp: serverTimestamp() };
                batch.set(doc(historyRef), logEntry);

                try {
                    await batch.commit();
                    showNotification(`成功將 ${samplesToMove.length} 個樣品移至暫存區。`);
                    closeModal(modals.batchAction);
                    deselectAll();
                } catch (error) { console.error("Batch stage failed: ", error); showNotification("批次操作失敗，請稍後再試。"); }
            }
            async function handleBatchFinalizeSubmit(e) {
                e.preventDefault();
                const person = batchFinalizeForm.batchFinalizePerson.value;
                const remarks = batchFinalizeForm.batchFinalizeRemarks.value.trim();
                if (!person || !remarks) { showNotification('請選擇操作人員並填寫備註！'); return; }

                const batch = writeBatch(db);
                const samplesToFinalize = Array.from(selectedStagingSamples).map(id => stagingSamples.find(s => s.id === id)).filter(Boolean);

                if (samplesToFinalize.length === 0) { showNotification('沒有有效的樣品可供歸檔。'); return; }

                samplesToFinalize.forEach(sample => {
                    const { id, ...data } = sample;
                    const stagingRef = doc(db, 'sampleSystem/data/staging', id);
                    const archivedRef = doc(collection(db, 'sampleSystem/data/archived'));
                    batch.set(archivedRef, { ...data, archivedAt: serverTimestamp(), remarks });
                    batch.delete(stagingRef);
                });

                const historyRef = collection(db, 'sampleSystem/data/history');
                const logEntry = { action: '批次最終取出', person, count: samplesToFinalize.length, details: remarks, timestamp: serverTimestamp() };
                batch.set(doc(historyRef), logEntry);
                
                try {
                    await batch.commit();
                    showNotification(`成功歸檔 ${samplesToFinalize.length} 個樣品。`);
                    closeModal(modals.batchFinalize);
                    deselectAll();
                } catch (error) { console.error("Batch finalize failed: ", error); showNotification("批次歸檔失敗，請稍後再試。"); }
            }


            function makeSliderScrollable(slider) {
                let isDown = false, startX, scrollLeft;
                slider.addEventListener('mousedown', (e) => { isDown = true; slider.classList.add('active'); startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
                ['mouseleave', 'mouseup'].forEach(ev => slider.addEventListener(ev, () => { isDown = false; slider.classList.remove('active'); }));
                slider.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const walk = (e.pageX - slider.offsetLeft - startX) * 2; slider.scrollLeft = scrollLeft - walk; });
            }
            
            // --- Settings Modal Logic ---
            function renderSettingsUI(config) {
                renderPersonnelList(config.personnel || []);
                renderCabinetSettings(config.storageLayout || {});
            }
            function renderPersonnelList(personnel) {
                personListContainer.innerHTML = '';
                personnel.forEach(person => personListContainer.innerHTML += `<div class="flex justify-between items-center bg-slate-100 p-2 rounded-lg"><span>${person}</span><button data-person="${person}" class="delete-person-btn text-red-500 hover:text-red-700">刪除</button></div>`);
            }
            function renderCabinetSettings(storageLayout) {
                cabinetSettingsContainer.innerHTML = '';
                Object.entries(storageLayout).forEach(([cabinetName, shelves]) => {
                    const shelfHTML = Object.entries(shelves).map(([shelfName, capacity]) => `<div class="flex justify-between items-center mb-2 bg-slate-50 p-2 rounded flex-wrap gap-2"><div class="flex-grow flex items-center gap-2"><span class="font-medium text-slate-700">${shelfName}</span><label class="text-sm text-slate-600 ml-auto">格數:</label><input type="number" value="${capacity}" class="edit-shelf-capacity w-20 px-2 py-1 border border-slate-300 rounded-md text-sm" min="1" data-cabinet="${cabinetName}" data-shelf="${shelfName}"></div><button data-cabinet="${cabinetName}" data-shelf="${shelfName}" class="delete-shelf-btn text-red-500 hover:text-red-700 text-sm">刪除層</button></div>`).join('');
                    cabinetSettingsContainer.innerHTML += `<div class="p-4 border border-slate-200 rounded-lg"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-lg text-slate-700">${cabinetName}</h4><button data-cabinet="${cabinetName}" class="delete-cabinet-btn bg-red-100 text-red-700 text-sm font-semibold px-3 py-1 rounded-full hover:bg-red-200">刪除櫃子</button></div><div class="mb-4">${shelfHTML}</div><div class="flex flex-col sm:flex-row items-center gap-2 mt-4"><input type="text" class="new-shelf-name w-full sm:flex-grow px-3 py-1.5 border border-slate-300 rounded-md text-sm" placeholder="新層數名稱"><input type="number" class="new-shelf-capacity w-full sm:w-24 px-3 py-1.5 border border-slate-300 rounded-md text-sm" placeholder="格數" min="1"><button data-cabinet="${cabinetName}" class="add-shelf-btn w-full sm:w-auto bg-slate-200 text-slate-700 text-sm font-semibold px-3 py-1.5 rounded-md hover:bg-slate-300">新增層</button></div></div>`;
                });
            }
            function handleAddPerson() {
                const name = newPersonNameInput.value.trim();
                if (name && !(tempSystemConfig.personnel || []).includes(name)) {
                    if (!tempSystemConfig.personnel) tempSystemConfig.personnel = [];
                    tempSystemConfig.personnel.push(name);
                    renderPersonnelList(tempSystemConfig.personnel);
                    newPersonNameInput.value = '';
                } else {
                    showNotification(name ? '此人員已存在！' : '人員姓名不能為空！');
                }
            }
             function handleAddCabinet() {
                const name = newCabinetNameInput.value.trim();
                if (name && !(tempSystemConfig.storageLayout || {})[name]) {
                    if (!tempSystemConfig.storageLayout) tempSystemConfig.storageLayout = {};
                    tempSystemConfig.storageLayout[name] = {};
                    renderCabinetSettings(tempSystemConfig.storageLayout);
                    newCabinetNameInput.value = '';
                } else {
                    showNotification(name ? '此櫃子名稱已存在！' : '櫃子名稱不能為空！');
                }
            }
            async function handleSettingsClick(e) {
                const { cabinet, shelf } = e.target.dataset;
                if (e.target.classList.contains('delete-cabinet-btn')) {
                    if (await showConfirmation({ message: `確定要刪除整個櫃子 "${cabinet}" 嗎？`, actionText: '確認刪除' })) {
                        delete tempSystemConfig.storageLayout[cabinet];
                        renderCabinetSettings(tempSystemConfig.storageLayout);
                    }
                } else if (e.target.classList.contains('add-shelf-btn')) {
                    const parent = e.target.parentElement;
                    const shelfName = parent.querySelector('.new-shelf-name').value.trim();
                    const shelfCapacity = parseInt(parent.querySelector('.new-shelf-capacity').value, 10);
                    if (shelfName && shelfCapacity > 0) {
                        if (!tempSystemConfig.storageLayout[cabinet]) tempSystemConfig.storageLayout[cabinet] = {};
                        if (tempSystemConfig.storageLayout[cabinet][shelfName]) {
                            showNotification(`層數 "${shelfName}" 已存在！`);
                            return;
                        }
                        tempSystemConfig.storageLayout[cabinet][shelfName] = shelfCapacity;
                        renderCabinetSettings(tempSystemConfig.storageLayout);
                        parent.querySelector('.new-shelf-name').value = '';
                        parent.querySelector('.new-shelf-capacity').value = '';
                    } else {
                        showNotification('請輸入有效的層數名稱和格數！');
                    }
                } else if (e.target.classList.contains('delete-shelf-btn')) {
                     if (await showConfirmation({ message: `確定要刪除櫃子 "${cabinet}" 中的 "${shelf}" 嗎？`, actionText: '確認刪除' })) {
                        delete tempSystemConfig.storageLayout[cabinet][shelf];
                        renderCabinetSettings(tempSystemConfig.storageLayout);
                    }
                }
            }

            // --- Event Listeners ---
            [searchInput, searchCabinetSelect, searchPersonSelect].forEach(el => el.addEventListener('input', handleSearch));
            document.getElementById('openAddSampleModalBtn').addEventListener('click', () => { addSampleForm.reset(); updateAddFormSelects(); openModal(modals.addSample); });
            document.getElementById('openHistoryModalBtn').addEventListener('click', () => openModal(modals.history));
            document.getElementById('openSettingsBtn').addEventListener('click', () => { tempSystemConfig = JSON.parse(JSON.stringify(systemConfig)); renderSettingsUI(tempSystemConfig); openModal(modals.settings); });
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-backdrop'))));
            document.querySelectorAll('.close-scanner-btn').forEach(btn => btn.addEventListener('click', stopScanner));
            scanInputQrBtn.addEventListener('click', () => startScanner('input'));
            scanSearchBtn.addEventListener('click', () => startScanner('search'));
            openReportModalBtn.addEventListener('click', () => {
                const select = document.getElementById('reportCabinetSelect');
                select.innerHTML = '<option value="all">全部櫃子</option>';
                Object.keys(systemConfig.storageLayout || {}).sort().forEach(name => {
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
                openModal(modals.reportFilter);
            });
            document.getElementById('generateReportBtn').addEventListener('click', () => {
                const selectedCabinet = document.getElementById('reportCabinetSelect').value;
                closeModal(modals.reportFilter);
                renderInventoryReport(selectedCabinet);
                openModal(modals.report);
            });
            printReportBtn.addEventListener('click', handlePrintReport);
            downloadCsvBtn.addEventListener('click', handleDownloadCsv);
            document.getElementById('batch-download-qr-btn').addEventListener('click', handleBatchDownloadQr);
            document.getElementById('closeSettingsBtn').addEventListener('click', () => closeModal(modals.settings));
            document.getElementById('saveSettingsBtn').addEventListener('click', () => saveConfig(tempSystemConfig).then(() => closeModal(modals.settings)));
            addSampleForm.addEventListener('submit', handleAddSample);
            moveSampleForm.addEventListener('submit', handleMoveSample);
            actionForm.addEventListener('submit', handleActionFormSubmit);
            batchActionForm.addEventListener('submit', handleBatchStageSubmit);
            batchFinalizeForm.addEventListener('submit', handleBatchFinalizeSubmit);
            storageCabinetSelect.addEventListener('change', updateAddShelves);
            storageShelfSelect.addEventListener('change', updateAddPositions);
            document.getElementById('moveStorageCabinet').addEventListener('change', updateMoveShelves);
            document.getElementById('moveStorageShelf').addEventListener('change', updateMovePositions);
            document.getElementById('addPersonBtn').addEventListener('click', handleAddPerson);
            personListContainer.addEventListener('click', async (e) => { 
                if (e.target.classList.contains('delete-person-btn')) {
                    const personToDelete = e.target.dataset.person;
                    if (await showConfirmation({message: `確定刪除人員 "${personToDelete}"?`, actionText: '確認刪除'})) { 
                        tempSystemConfig.personnel = tempSystemConfig.personnel.filter(p => p !== personToDelete); 
                        renderPersonnelList(tempSystemConfig.personnel); 
                    } 
                }
            });
            document.getElementById('addCabinetBtn').addEventListener('click', handleAddCabinet);
            cabinetSettingsContainer.addEventListener('click', handleSettingsClick);
            cabinetSettingsContainer.addEventListener('input', (e) => { if (e.target.classList.contains('edit-shelf-capacity')) { const { cabinet, shelf } = e.target.dataset; const newCapacity = parseInt(e.target.value, 10); if (cabinet && shelf && newCapacity > 0) tempSystemConfig.storageLayout[cabinet][shelf] = newCapacity; } });
            mainContent.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    deselectAll();
                    e.target.parentElement.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-tab'));
                    e.target.classList.add('active-tab');
                    document.getElementById('cabinet-content-container').querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(e.target.dataset.target).classList.remove('hidden');
                }
            });
            document.getElementById('history-tabs-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('history-tab-btn')) {
                    e.target.parentElement.querySelectorAll('.history-tab-btn').forEach(btn => btn.classList.remove('active-tab'));
                    e.target.classList.add('active-tab');
                    document.getElementById('history-content-container').querySelectorAll('.history-tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(e.target.dataset.target).classList.remove('hidden');
                }
            });
            document.getElementById('deselect-all-btn').addEventListener('click', deselectAll);
            document.getElementById('batch-stage-btn').addEventListener('click', () => {
                const modal = modals.batchAction;
                const listEl = modal.querySelector('#batchSampleList');
                const countEl = modal.querySelector('#batchCount');
                const personSelect = modal.querySelector('#batchActionPerson');
                const samplesToMove = Array.from(selectedSamples).map(id => sampleInventory.find(s => s.id === id)).filter(Boolean);
                listEl.innerHTML = samplesToMove.map(s => `<div class="text-sm p-2 bg-white rounded truncate" title="${s.sampleName}">${s.sampleName} <span class="text-xs text-slate-500">(${s.storageLocation})</span></div>`).join('');
                countEl.textContent = samplesToMove.length;
                personSelect.innerHTML = '<option value="">--- 請選擇人員 ---</option>';
                (systemConfig.personnel || []).forEach(p => personSelect.innerHTML += `<option value="${p}">${p}</option>`);
                openModal(modal);
            });
            document.getElementById('batch-finalize-btn').addEventListener('click', () => {
                const modal = modals.batchFinalize;
                const listEl = modal.querySelector('#batchFinalizeSampleList');
                const countEl = modal.querySelector('#batchFinalizeCount');
                const personSelect = modal.querySelector('#batchFinalizePerson');
                const samplesToFinalize = Array.from(selectedStagingSamples).map(id => stagingSamples.find(s => s.id === id)).filter(Boolean);
                listEl.innerHTML = samplesToFinalize.map(s => `<div class="text-sm p-2 bg-white rounded truncate" title="${s.sampleName}">${s.sampleName} <span class="text-xs text-slate-500">(${s.storageLocation})</span></div>`).join('');
                countEl.textContent = samplesToFinalize.length;
                personSelect.innerHTML = '<option value="">--- 請選擇人員 ---</option>';
                (systemConfig.personnel || []).forEach(p => personSelect.innerHTML += `<option value="${p}">${p}</option>`);
                openModal(modal);
            });

            onAuthStateChanged(auth, user => {
                if (user) setupListeners();
                else signInAnonymously(auth).catch(error => { console.error("Anonymous sign-in failed:", error); loader.textContent = '連接認證失敗，請檢查 Firebase 設定。'; });
            });
        });
    </script>
</body>
</html>

