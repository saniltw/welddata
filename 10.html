<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RFID 樣品管理系統 V17.3 (HTML版)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.9); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-bounce-in { animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        /* Utility */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900 pb-24 select-none">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 sticky top-0 z-40 shadow-lg">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i data-lucide="flask-conical" class="mr-2 text-blue-400 w-5 h-5"></i>
                <h1 class="text-lg font-bold">實驗室樣品 (HTML版)</h1>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="logout()" id="userBtn" class="flex items-center text-xs bg-slate-800 px-3 py-1 rounded hover:bg-slate-700 transition">
                    <i data-lucide="user" class="mr-1 w-3 h-3"></i> <span id="userNameDisplay">登入</span>
                </button>
                <button onclick="fetchData()" class="p-1 hover:bg-slate-700 rounded transition"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                <button onclick="toggleConfig()" class="p-1 hover:bg-slate-700 rounded transition"><i data-lucide="link" class="w-4 h-4"></i></button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 mt-2" id="mainContainer">
        <div id="loadingIndicator" class="text-center py-2 text-xs text-slate-400 hidden">正在同步資料庫...</div>

        <!-- Navigation Tabs -->
        <div class="bg-white p-1 rounded-xl shadow-sm mb-6 flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('operation')" id="tab-operation" class="flex-1 py-3 rounded-lg text-sm font-bold flex flex-col items-center justify-center text-slate-500 transition">
                <i data-lucide="tag" class="mb-1 w-5 h-5"></i> 作業
            </button>
            <button onclick="switchTab('stocktake')" id="tab-stocktake" class="flex-1 py-3 rounded-lg text-sm font-bold flex flex-col items-center justify-center text-slate-500 transition">
                <i data-lucide="clipboard-check" class="mb-1 w-5 h-5"></i> 盤點
            </button>
            <button onclick="switchTab('inventory')" id="tab-inventory" class="flex-1 py-3 rounded-lg text-sm font-bold flex flex-col items-center justify-center text-slate-500 transition">
                <i data-lucide="database" class="mb-1 w-5 h-5"></i> 庫存
            </button>
            <button onclick="switchTab('archive')" id="tab-archive" class="flex-1 py-3 rounded-lg text-sm font-bold flex flex-col items-center justify-center text-slate-500 transition">
                <i data-lucide="archive" class="mb-1 w-5 h-5"></i> 銷毀
            </button>
        </div>

        <!-- Dynamic Content Area -->
        <div id="contentArea" class="animate-fade-in">
            <!-- Content injected via JS -->
        </div>
    </main>

    <!-- Scanner Input (Hidden) -->
    <form onsubmit="handleScan(event)" class="relative h-0 overflow-hidden">
        <input id="scanInput" type="text" autocomplete="off" class="opacity-0 w-full h-10" onblur="handleBlur()" onfocus="handleFocus()">
    </form>

    <!-- Modals Container -->
    <div id="modalsArea"></div>

    <!-- Toast Container -->
    <div id="toastArea" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-[10000]"></div>

    <!-- Application Logic -->
    <script>
        // --- Configuration & State ---
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsl-mA-tYI1_hheBnecppCAfPSku6PFNuREBnh6r0XDEJTo5VDO5AiDaw45AmXePN2/exec";
        
        const state = {
            scriptUrl: localStorage.getItem('google_script_url') || DEFAULT_SCRIPT_URL,
            activeTab: 'operation',
            isConfiguring: false,
            operator: '',
            showOperatorModal: true,
            validOperators: [],
            samples: [],
            archives: [],
            logs: [],
            auditResults: {}, // {epc: 'OK' | 'WRONG_CABINET' | 'WRONG_LAYER' | 'UNKNOWN'}
            targetCabinet: '',
            targetLayer: '',
            isFocused: false,
            isLoading: false,
            isProcessing: false,
            expandedRowId: null, // For inventory table
            
            // Temporary Modal States
            registerData: null,
            actionItem: null,
            progress: null, // {current, total, message, failures}
            confirmState: null // {title, message, onConfirm}
        };

        // --- Helper Functions ---
        const generateAutoSKU = () => {
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            return `LAB-${dateStr}-${timeStr}`;
        };

        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                const now = ctx.currentTime;
                if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now);
                    osc.stop(now + 0.15);
                } else if (type === 'alert') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.1, now);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'warning') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(400, now);
                    gain.gain.setValueAtTime(0.1, now);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    
                    setTimeout(() => {
                        const ctx2 = new AudioContext();
                        const osc2 = ctx2.createOscillator();
                        const gain2 = ctx2.createGain();
                        osc2.connect(gain2);
                        gain2.connect(ctx2.destination);
                        osc2.type = 'square';
                        osc2.frequency.setValueAtTime(400, ctx2.currentTime);
                        gain2.gain.setValueAtTime(0.1, ctx2.currentTime);
                        osc2.start();
                        osc2.stop(ctx2.currentTime + 0.1);
                    }, 150);
                } else {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            } catch (e) { console.error(e); }
        };

        const showToast = (msg, type) => {
            const el = document.getElementById('toastArea');
            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-orange-500' : 'bg-red-600';
            
            toast.className = `${bgClass} text-white px-6 py-3 rounded-full shadow-xl font-bold animate-bounce-in mb-2 text-center`;
            toast.innerText = msg;
            
            el.appendChild(toast);
            playSound(type);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.5s';
                setTimeout(() => el.removeChild(toast), 500);
            }, 3000);
        };

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- API Calls ---
        const fetchData = async (silent = false) => {
            if (!silent) {
                state.isLoading = true;
                document.getElementById('loadingIndicator').classList.remove('hidden');
            }
            try {
                const res = await fetch(state.scriptUrl);
                const data = await res.json();
                state.samples = data.samples || [];
                state.archives = data.archives || [];
                state.validOperators = data.operators || [];
                render(); // Re-render to update UI with new data
            } catch (e) {
                console.error("Fetch failed", e);
                if (!silent) showToast("無法連接到資料庫", "error");
            } finally {
                state.isLoading = false;
                if (!silent) document.getElementById('loadingIndicator').classList.add('hidden');
            }
        };

        const postData = async (action, data, skipRefresh = false) => {
            if (!state.operator && action !== 'LOG') {
                alert("請先登入");
                state.showOperatorModal = true;
                render();
                return false;
            }

            if (!skipRefresh && !state.progress) {
                state.isProcessing = true;
                render(); // Show spinner on buttons
            }

            try {
                const payload = { action, data: { ...data, operator: state.operator } };
                await fetch(state.scriptUrl, { method: 'POST', body: JSON.stringify(payload) });
                
                if (!skipRefresh) await fetchData(true);

                // Add to local logs
                let logDetail = '';
                if (action === 'REGISTER') {
                    const parts = [];
                    if (data.cabinet) parts.push(`Loc: ${data.cabinet}-${data.layer}`);
                    if (data.wireDiameter) parts.push(data.wireDiameter);
                    logDetail = parts.join(' | ');
                } else if (action === 'RETURN') logDetail = `To: ${data.cabinet}-${data.layer}`;
                else if (action === 'DESTROY') logDetail = '銷毀';

                const newLog = {
                    timestamp: new Date().toISOString(),
                    operator: state.operator,
                    epc: data.epc || 'BATCH',
                    itemName: data.name || data.itemName || '批量操作',
                    action: action,
                    detail: logDetail
                };
                state.logs = [newLog, ...state.logs].slice(0, 20);
                
                return true;
            } catch (e) {
                console.error("Post failed", e);
                if (!skipRefresh && !state.progress) showToast("操作失敗", "error");
                return false;
            } finally {
                if (!skipRefresh && !state.progress) {
                    state.isProcessing = false;
                    render();
                }
            }
        };

        // --- Main Logic & Event Handlers ---

        function handleScan(e) {
            e.preventDefault();
            const input = document.getElementById('scanInput');
            const rawEpc = input.value.trim();
            input.value = '';
            
            if (!rawEpc) return;
            showToast(`已讀取: ${rawEpc.slice(-6)}`, 'success');

            if (state.activeTab === 'operation') {
                const existing = state.samples.find(s => String(s.epc).trim() === rawEpc);
                if (existing) {
                    state.actionItem = existing;
                    playSound('alert');
                } else {
                    state.registerData = { epc: rawEpc };
                    playSound('alert');
                }
            } else if (state.activeTab === 'stocktake') {
                handleAuditScan(rawEpc);
            }
            render();
        }

        function handleAuditScan(rawEpc) {
            const item = state.samples.find(s => String(s.epc).trim() === rawEpc);
            if (!item) {
                state.auditResults[rawEpc] = 'UNKNOWN';
                playSound('error');
            } else {
                const itemCab = String(item.cabinet);
                const itemLay = String(item.layer);
                let status = 'OK';
                
                if (state.targetCabinet && itemCab !== state.targetCabinet) status = 'WRONG_CABINET';
                else if (state.targetLayer && itemLay !== state.targetLayer) status = 'WRONG_LAYER';
                
                state.auditResults[rawEpc] = status;
                
                if (status === 'OK') playSound('success');
                else if (status === 'WRONG_LAYER') playSound('warning');
                else playSound('error');
            }
            render();
        }

        function switchTab(tab) {
            state.activeTab = tab;
            render();
            refocus();
        }

        function handleFocus() { state.isFocused = true; renderStatusBox(); }
        function handleBlur() { state.isFocused = false; renderStatusBox(); }
        function refocus() { setTimeout(() => document.getElementById('scanInput').focus(), 100); }

        function toggleConfig() {
            state.isConfiguring = !state.isConfiguring;
            render();
        }

        function saveConfig() {
            const url = document.getElementById('configUrlInput').value;
            if (!url.includes("script.google.com")) {
                alert("請輸入有效的 Google Apps Script 網址");
                return;
            }
            state.scriptUrl = url;
            localStorage.setItem('google_script_url', url);
            state.isConfiguring = false;
            fetchData();
        }

        // --- Rendering Logic ---

        function render() {
            if (state.isConfiguring) {
                renderConfigScreen();
                return;
            }
            
            // Header User
            const userBtn = document.getElementById('userBtn');
            const userNameDisplay = document.getElementById('userNameDisplay');
            userNameDisplay.innerText = state.operator || '登入';
            
            // Tabs
            ['operation', 'stocktake', 'inventory', 'archive'].forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                if (state.activeTab === tab) {
                    const colors = {
                        'operation': 'bg-blue-50 text-blue-600',
                        'stocktake': 'bg-teal-50 text-teal-600',
                        'inventory': 'bg-slate-100 text-slate-700',
                        'archive': 'bg-orange-50 text-orange-600'
                    };
                    btn.className = `flex-1 py-3 rounded-lg text-sm font-bold flex flex-col items-center justify-center transition ${colors[tab]}`;
                } else {
                    btn.className = `flex-1 py-3 rounded-lg text-sm font-bold flex flex-col items-center justify-center text-slate-500 transition hover:bg-slate-50`;
                }
            });

            // Content
            const content = document.getElementById('contentArea');
            content.innerHTML = '';
            
            if (state.activeTab === 'operation') renderOperation(content);
            else if (state.activeTab === 'stocktake') renderStocktake(content);
            else if (state.activeTab === 'inventory') renderInventory(content);
            else if (state.activeTab === 'archive') renderArchive(content);

            // Modals
            renderModals();
            
            // Icons
            lucide.createIcons();
        }

        function renderConfigScreen() {
            document.getElementById('mainContainer').innerHTML = `
                <div class="min-h-[60vh] flex items-center justify-center">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md animate-fade-in">
                        <div class="flex justify-center mb-6 text-blue-600"><i data-lucide="cloud" class="w-12 h-12"></i></div>
                        <h2 class="text-2xl font-bold text-center mb-2">連接 Google Sheets</h2>
                        <input id="configUrlInput" class="w-full p-3 border rounded-lg mb-4 text-sm" value="${state.scriptUrl}" />
                        <button onclick="saveConfig()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">更新設定</button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderStatusBox() {
            // Only re-renders the specific div to avoid flickering
            const container = document.getElementById('scannerStatusContainer');
            if (!container) return; // Should not happen if tabs are correct

            let style = {
                bg: 'bg-slate-50', border: 'border-slate-300', text: 'text-slate-800',
                icon: 'mouse-pointer-click', title: '掃描暫停', sub: '點擊此處開始工作'
            };

            if (state.isFocused) {
                if (state.activeTab === 'operation') {
                    style = {
                        bg: 'bg-blue-50', border: 'border-blue-500', text: 'text-blue-900',
                        icon: 'tag', title: '作業模式就緒', sub: `操作人員: ${state.operator || '未設定'}`
                    };
                } else if (state.activeTab === 'stocktake') {
                    const locationText = state.targetCabinet 
                        ? `${state.targetCabinet} ${state.targetLayer ? ` / ${state.targetLayer}` : '(全層)'}`
                        : '未指定 (盤點全部)';
                    style = {
                        bg: 'bg-teal-50', border: 'border-teal-500', text: 'text-teal-900',
                        icon: 'clipboard-check', title: '盤點模式就緒', sub: `正在檢查: ${locationText}`
                    };
                }
            }

            container.innerHTML = `
                <div onclick="refocus()" class="relative p-6 rounded-xl border-2 mb-6 cursor-pointer transition-all flex items-center justify-between ${style.bg} ${style.border}">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full mr-4 bg-white shadow-sm ${style.text}"><i data-lucide="${style.icon}"></i></div>
                        <div>
                            <h3 class="font-bold text-lg ${style.text}">${style.title}</h3>
                            <p class="text-sm opacity-70">${style.sub}</p>
                        </div>
                    </div>
                    ${state.isFocused ? '<span class="flex h-3 w-3 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>' : ''}
                </div>
            `;
            lucide.createIcons();
        }

        function renderOperation(container) {
            // Scanner Box Container
            const statusDiv = document.createElement('div');
            statusDiv.id = 'scannerStatusContainer';
            container.appendChild(statusDiv);
            renderStatusBox();

            // Initial instruction
            if (!state.registerData && !state.actionItem && state.logs.length === 0) {
                const info = document.createElement('div');
                info.className = "text-center text-slate-400 mt-10";
                info.innerHTML = `<i data-lucide="info" class="mx-auto h-12 w-12 opacity-20 mb-2"></i><p>請掃描標籤以開始作業</p>`;
                container.appendChild(info);
            }

            // Logs
            if (state.logs.length > 0) {
                const logsDiv = document.createElement('div');
                logsDiv.className = "mt-4 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden";
                let logsHtml = `<div class="p-3 bg-slate-50 border-b border-slate-100 text-xs font-bold text-slate-500 flex items-center"><i data-lucide="activity" class="w-3 h-3 mr-2"></i> 最近操作紀錄</div><ul class="divide-y divide-slate-100">`;
                
                state.logs.slice(0, 5).forEach(log => {
                    let color = 'text-green-600';
                    if(log.action.includes('REGISTER')) color = 'text-blue-600';
                    if(log.action.includes('DESTROY')) color = 'text-red-600';
                    if(log.action.includes('TEST')) color = 'text-orange-600';

                    let actionName = log.action;
                    if(actionName === 'REGISTER') actionName = '登錄';
                    if(actionName === 'DESTROY') actionName = '銷毀';
                    if(actionName === 'MOVE_TEST') actionName = '移出';
                    if(actionName === 'RETURN') actionName = '歸位';

                    logsHtml += `
                        <li class="p-3 flex justify-between items-center text-xs">
                            <div>
                                <span class="font-bold mr-2 ${color}">${actionName}</span>
                                <span class="text-slate-700 font-bold">${log.itemName}</span>
                                <span class="ml-2 text-slate-400 bg-slate-50 px-1 rounded">${log.detail}</span>
                            </div>
                            <div class="text-right text-slate-400">
                                <div>${log.operator}</div>
                                <div class="text-[10px]">${new Date(log.timestamp).toLocaleTimeString()}</div>
                            </div>
                        </li>
                    `;
                });
                logsHtml += '</ul>';
                logsDiv.innerHTML = logsHtml;
                container.appendChild(logsDiv);
            }
        }

        function renderStocktake(container) {
            // Filters
            const uniqueCabinets = Array.from(new Set(state.samples.map(s => String(s.cabinet)).filter(c => c && c !== '試驗區'))).sort();
            const filteredSamples = state.targetCabinet ? state.samples.filter(s => String(s.cabinet) === state.targetCabinet) : state.samples;
            const uniqueLayers = Array.from(new Set(filteredSamples.map(s => String(s.layer)).filter(l => l && l !== '檢測台'))).sort();
            
            const errorCount = Object.values(state.auditResults).filter(s => s === 'WRONG_LAYER' || s === 'WRONG_CABINET').length;

            const filterDiv = document.createElement('div');
            filterDiv.innerHTML = `
                <div class="mb-4 bg-white p-4 rounded-xl shadow-sm border border-teal-100">
                    <label class="block text-xs font-bold text-teal-700 mb-2 uppercase flex items-center"><i data-lucide="filter" class="w-3 h-3 mr-1"></i> 盤點範圍設定</label>
                    <div class="flex gap-2 mb-2">
                        <div class="flex-1">
                            <select id="selCabinet" onchange="updateStocktakeFilter('cabinet', this.value)" class="w-full p-2 border border-teal-200 rounded outline-none focus:bg-teal-50 bg-white">
                                <option value="">(櫃號)</option>
                                ${uniqueCabinets.map(c => `<option value="${c}" ${state.targetCabinet === c ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1">
                            <select id="selLayer" onchange="updateStocktakeFilter('layer', this.value)" class="w-full p-2 border border-teal-200 rounded outline-none focus:bg-teal-50 bg-white" ${!state.targetCabinet ? 'disabled' : ''}>
                                <option value="">(層板)</option>
                                ${uniqueLayers.map(l => `<option value="${l}" ${state.targetLayer === l ? 'selected' : ''}>${l}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="resetAudit()" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded font-bold text-sm shadow-sm hover:bg-slate-200 border border-slate-200">重置</button>
                        ${(state.targetCabinet && state.targetLayer && errorCount > 0) ? `
                            <button onclick="applyLayerCorrection()" class="flex-1 bg-yellow-500 text-white py-2 rounded font-bold text-sm shadow-md hover:bg-yellow-600 flex items-center justify-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-2"></i> 校正 ${errorCount} 個位置錯誤
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            container.appendChild(filterDiv);

            // Status Box
            const statusDiv = document.createElement('div');
            statusDiv.id = 'scannerStatusContainer';
            container.appendChild(statusDiv);
            renderStatusBox();

            // Results Table
            const resultsDiv = document.createElement('div');
            resultsDiv.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-4";
            
            const entries = Object.entries(state.auditResults);
            
            let rows = entries.map(([epc, status]) => {
                const item = state.samples.find(s => s.epc === epc);
                let bgClass = status === 'OK' ? 'bg-green-50' : (status === 'WRONG_LAYER' || status === 'WRONG_CABINET') ? 'bg-yellow-50' : 'bg-red-50';
                let statusText = '';
                if(status === 'OK') statusText = '<span class="text-green-600 flex items-center"><i data-lucide="check-circle-2" class="w-4 h-4 mr-1"></i>正確</span>';
                else if(status === 'WRONG_CABINET') statusText = '<span class="text-red-600 flex items-center"><i data-lucide="x-circle" class="w-4 h-4 mr-1"></i>櫃錯</span>';
                else if(status === 'WRONG_LAYER') statusText = '<span class="text-yellow-600 flex items-center"><i data-lucide="layers" class="w-4 h-4 mr-1"></i>層錯</span>';
                else statusText = '<span class="text-slate-500">未知</span>';

                return `
                    <tr class="${bgClass} border-b last:border-0">
                        <td class="p-3 font-bold">${statusText}</td>
                        <td class="p-3">
                            ${item ? `<div class="font-bold">${item.name}</div><div class="text-xs text-slate-500">${item.sku}</div>` : `<div class="font-mono text-xs">${epc}</div>`}
                        </td>
                        <td class="p-3 text-slate-500">${item ? `${item.cabinet}-${item.layer}` : '-'}</td>
                    </tr>
                `;
            }).join('');

            resultsDiv.innerHTML = `
                <div class="p-4 bg-slate-50 border-b border-slate-100 font-bold flex justify-between">
                    <span>盤點結果</span>
                    <span class="text-xs bg-white border px-2 py-1 rounded text-slate-500">已掃: ${entries.length}</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 border-b"><tr><th>狀態</th><th>樣品</th><th>應在位置</th></tr></thead>
                        <tbody class="divide-y divide-slate-100">${rows}</tbody>
                    </table>
                </div>
            `;
            container.appendChild(resultsDiv);
        }

        function updateStocktakeFilter(type, val) {
            if (type === 'cabinet') {
                state.targetCabinet = val;
                state.targetLayer = '';
            } else {
                state.targetLayer = val;
            }
            render();
            refocus();
        }

        function renderInventory(container) {
            const tableDiv = document.createElement('div');
            tableDiv.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden";
            
            let rows = state.samples.map(s => {
                const isExpanded = state.expandedRowId === s.epc;
                const statusClass = s.status === 'TESTING' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700';
                const statusText = s.status === 'TESTING' ? '試驗中' : '在庫';
                
                let detailsRow = '';
                if (isExpanded) {
                    detailsRow = `
                        <tr class="bg-slate-50 border-b animate-fade-in">
                            <td colspan="3" class="p-4 text-xs text-slate-600">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><span class="font-bold text-slate-400">線徑:</span> ${s.wireDiameter || '-'}</div>
                                    <div><span class="font-bold text-slate-400">標準:</span> ${s.standard || '-'}</div>
                                    <div><span class="font-bold text-slate-400">製造商:</span> ${s.manufacturer || '-'}</div>
                                    <div><span class="font-bold text-slate-400">批號:</span> ${s.batchNo || '-'}</div>
                                    <div><span class="font-bold text-slate-400">爐號:</span> ${s.heatNo || '-'}</div>
                                    <div><span class="font-bold text-slate-400">配方:</span> ${s.formulaCode || '-'}</div>
                                    <div class="col-span-2"><span class="font-bold text-slate-400">製程:</span> ${s.processDetail || '-'}</div>
                                    <div class="col-span-2"><span class="font-bold text-slate-400">備註:</span> ${s.remarks || '-'}</div>
                                </div>
                            </td>
                        </tr>
                    `;
                }

                // Need to stringify item for the onclick handler safely
                // Simple trick: Just store epc in onclick and look it up
                
                return `
                    <tr onclick="toggleRow('${s.epc}')" class="hover:bg-slate-50 cursor-pointer border-b last:border-0 group">
                        <td class="p-3 font-mono font-bold text-blue-600">
                            <div class="flex items-center"><i data-lucide="box" class="w-3 h-3 mr-1"></i>${s.cabinet}</div>
                            <div class="flex items-center text-xs text-slate-400"><i data-lucide="layers" class="w-3 h-3 mr-1"></i>${s.layer}</div>
                        </td>
                        <td class="p-3">
                            <div class="font-bold text-slate-700 flex flex-wrap items-center gap-2">
                                <span>${s.name}</span>
                                ${s.wireDiameter ? `<span class="text-xs bg-slate-100 px-2 rounded flex items-center"><i data-lucide="ruler" class="w-3 h-3 mr-1"></i>${s.wireDiameter}</span>` : ''}
                                <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-3 h-3 text-slate-400"></i>
                            </div>
                            <div class="text-xs text-slate-400 font-mono mt-1">${s.sku}</div>
                        </td>
                        <td class="p-3 text-right flex items-center justify-end space-x-2">
                            <span class="text-xs px-2 py-1 rounded font-bold ${statusClass}">${statusText}</span>
                            <button onclick="event.stopPropagation(); openActionModal('${s.epc}')" class="p-2 rounded-full hover:bg-slate-200 text-slate-500 transition-opacity">
                                <i data-lucide="more-vertical" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                    ${detailsRow}
                `;
            }).join('');

            tableDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 border-b">
                            <tr><th class="p-3">位置</th><th class="p-3">編號/名稱</th><th class="p-3 text-right">狀態</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">${rows}</tbody>
                    </table>
                </div>
            `;
            container.appendChild(tableDiv);
        }

        function toggleRow(epc) {
            state.expandedRowId = state.expandedRowId === epc ? null : epc;
            render();
        }

        function renderArchive(container) {
            const listDiv = document.createElement('div');
            listDiv.className = "bg-white rounded-xl shadow-sm border border-slate-200";
            
            const rows = state.archives.map(a => `
                <li class="p-4 hover:bg-slate-50 flex justify-between items-center opacity-75 border-b last:border-0">
                    <div>
                        <div class="font-bold text-slate-600 line-through decoration-slate-400">${a.name}</div>
                        <div class="text-xs text-slate-400 font-mono">${a.sku} | 原位: ${a.finalLocation}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded mb-1">已銷毀</div>
                        <div class="text-[10px] text-slate-400">${new Date(a.archivedAt).toLocaleDateString()}</div>
                    </div>
                </li>
            `).join('');

            listDiv.innerHTML = `<ul class="divide-y divide-slate-100">${rows}</ul>`;
            container.appendChild(listDiv);
        }

        // --- Modals Logic ---

        function renderModals() {
            const container = document.getElementById('modalsArea');
            container.innerHTML = '';
            
            // 1. Operator Login
            if (state.showOperatorModal) {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm z-[9999]";
                const options = state.validOperators.map(op => `<option value="${op.name}">${op.name} ${op.role ? `(${op.role})` : ''}</option>`).join('');
                
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                        <div class="mx-auto bg-blue-100 p-4 rounded-full w-16 h-16 flex items-center justify-center mb-4 text-blue-600"><i data-lucide="user" class="w-8 h-8"></i></div>
                        <h2 class="text-2xl font-bold mb-2 text-slate-800">人員登入</h2>
                        <div class="text-left space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">操作人員</label>
                                <select id="loginSelect" class="w-full p-3 border-2 border-blue-200 rounded-lg outline-none bg-white"><option value="">-- 請選擇 --</option>${options}</select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1">密碼</label>
                                <input id="loginPass" type="password" class="w-full p-3 border-2 border-blue-200 rounded-lg outline-none" placeholder="請輸入密碼" onkeydown="if(event.key === 'Enter') attemptLogin()">
                            </div>
                        </div>
                        <button onclick="attemptLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-6 shadow-lg">進入系統</button>
                        ${state.validOperators.length === 0 ? '<div class="mt-4 text-xs text-orange-500 bg-orange-50 p-2 rounded">警告：尚未讀取到人員名單</div>' : ''}
                    </div>
                `;
                container.appendChild(modal);
                return; // Block other modals
            }

            // 2. Register Modal
            if (state.registerData) {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-4 z-[9999]";
                
                // Helper to get suggestions
                const existingCab = Array.from(new Set(state.samples.map(s=>s.cabinet))).sort().map(c=>`<option value="${c}"></option>`).join('');
                const existingDia = Array.from(new Set(state.samples.map(s=>s.wireDiameter))).filter(Boolean).sort().map(d=>`<option value="${d}"></option>`).join('');
                const existingStd = Array.from(new Set(state.samples.map(s=>s.standard))).filter(Boolean).sort().map(s=>`<option value="${s}"></option>`).join('');
                const existingMfg = Array.from(new Set(state.samples.map(s=>s.manufacturer))).filter(Boolean).sort().map(m=>`<option value="${m}"></option>`).join('');
                
                const sku = generateAutoSKU();
                
                modal.innerHTML = `
                    <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade-in">
                        <div class="bg-blue-600 p-4 text-white flex justify-between items-center shrink-0">
                            <h3 class="font-bold flex items-center"><i data-lucide="file-text" class="mr-2 w-4 h-4"></i> 樣品詳細資料登錄</h3>
                            <button onclick="state.registerData=null;render();refocus()"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-6 space-y-6 overflow-y-auto">
                            <!-- Basic -->
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 class="text-sm font-bold text-slate-500 uppercase mb-3"><i data-lucide="tag" class="w-3 h-3 inline"></i> 基本資料</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="col-span-2 sm:col-span-1">
                                        <label class="block text-xs font-bold text-slate-700 mb-1">SKU</label>
                                        <input id="regSku" class="w-full p-2 border rounded font-mono bg-white" value="${sku}" readonly>
                                    </div>
                                    <div class="col-span-2 sm:col-span-1">
                                        <label class="block text-xs font-bold text-slate-700 mb-1">名稱</label>
                                        <input id="regName" class="w-full p-2 border rounded" placeholder="例如: 鍍鋅鋼線">
                                    </div>
                                    <div class="col-span-2 bg-blue-50 p-2 rounded text-xs text-blue-700 font-mono">EPC: ${state.registerData.epc}</div>
                                </div>
                            </div>
                            <!-- Specs -->
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 class="text-sm font-bold text-slate-500 uppercase mb-3"><i data-lucide="flask-conical" class="w-3 h-3 inline"></i> 規格</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-xs font-bold block mb-1">線徑</label><input id="regDia" list="dl-dia" class="w-full p-2 border rounded"><datalist id="dl-dia">${existingDia}</datalist></div>
                                    <div><label class="text-xs font-bold block mb-1">標準</label><input id="regStd" list="dl-std" class="w-full p-2 border rounded"><datalist id="dl-std">${existingStd}</datalist></div>
                                    <div><label class="text-xs font-bold block mb-1">廠商</label><input id="regMfg" list="dl-mfg" class="w-full p-2 border rounded"><datalist id="dl-mfg">${existingMfg}</datalist></div>
                                    <div><label class="text-xs font-bold block mb-1">批號</label><input id="regBatch" class="w-full p-2 border rounded"></div>
                                    <div class="col-span-2"><label class="text-xs font-bold block mb-1">備註</label><textarea id="regRmks" class="w-full p-2 border rounded h-16"></textarea></div>
                                </div>
                            </div>
                            <!-- Loc -->
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <h4 class="text-sm font-bold text-slate-500 uppercase mb-3"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> 位置</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-xs font-bold block mb-1">櫃號</label><input id="regCab" list="dl-cab" class="w-full p-2 border rounded"><datalist id="dl-cab">${existingCab}</datalist></div>
                                    <div><label class="text-xs font-bold block mb-1">層板</label><input id="regLay" class="w-full p-2 border rounded"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border-t bg-slate-50 shrink-0">
                            <button onclick="submitRegister()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg flex justify-center items-center">
                                ${state.isProcessing ? '<div class="loader mr-2"></div> 資料儲存中...' : '<i data-lucide="save" class="w-4 h-4 mr-2"></i> 確認並登錄'}
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(modal);
            }

            // 3. Action Modal (Move/Return/Destroy)
            if (state.actionItem) {
                const item = state.actionItem;
                const isTesting = item.status === 'TESTING';
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-4 z-[9999]";
                
                let origInfo = '';
                try {
                    const parsed = JSON.parse(item.originalLocation || '{}');
                    if(parsed.cabinet) origInfo = `還原至: ${parsed.cabinet}-${parsed.layer}`;
                } catch(e) {}

                modal.innerHTML = `
                    <div class="bg-white rounded-t-2xl sm:rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border-t-4 ${isTesting ? 'border-orange-500' : 'border-blue-500'} animate-fade-in">
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <div><h3 class="text-xl font-bold text-slate-800">${item.name}</h3><p class="text-slate-500 text-sm font-mono">${item.sku}</p></div>
                                <div class="px-3 py-1 rounded-full text-xs font-bold border ${isTesting ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-blue-50 text-blue-700 border-blue-200'}">${isTesting ? '試驗中' : '在庫'}</div>
                            </div>
                            <div class="mb-4 flex gap-2 text-xs text-slate-500">
                                <span class="bg-slate-100 px-2 py-1 rounded"><i data-lucide="box" class="w-3 h-3 inline"></i> ${item.cabinet}</span>
                                <span class="bg-slate-100 px-2 py-1 rounded"><i data-lucide="layers" class="w-3 h-3 inline"></i> ${item.layer}</span>
                            </div>
                            <p class="text-slate-600 text-sm mb-6 bg-slate-50 p-3 rounded">${isTesting ? '此樣品在「試驗區」。要歸位嗎？' : '此樣品「在庫」。要移出試驗嗎？'}</p>
                            <div class="grid grid-cols-1 gap-3">
                                ${isTesting ? `
                                    <button onclick="handleAction('RETURN')" ${state.isProcessing ? 'disabled' : ''} class="flex items-center justify-center p-4 rounded-xl border-2 border-green-100 bg-green-50 hover:bg-green-100 text-green-700">
                                        <i data-lucide="undo-2" class="mr-3 h-6 w-6"></i>
                                        <div class="text-left"><div class="font-bold">歸位</div><div class="text-xs opacity-70">${origInfo}</div></div>
                                    </button>
                                ` : `
                                    <button onclick="handleAction('MOVE_TEST')" ${state.isProcessing ? 'disabled' : ''} class="flex items-center justify-center p-4 rounded-xl border-2 border-orange-100 bg-orange-50 hover:bg-orange-100 text-orange-700">
                                        <i data-lucide="flask-conical" class="mr-3 h-6 w-6"></i>
                                        <div class="text-left"><div class="font-bold">移出至試驗</div><div class="text-xs opacity-70">更新狀態為測試中</div></div>
                                    </button>
                                `}
                                <button onclick="confirmDestroy()" ${state.isProcessing ? 'disabled' : ''} class="flex items-center justify-center p-4 rounded-xl border-2 border-red-100 bg-red-50 hover:bg-red-100 text-red-700">
                                    <i data-lucide="trash-2" class="mr-3 h-6 w-6"></i>
                                    <div class="text-left"><div class="font-bold">樣品銷毀</div><div class="text-xs opacity-70">釋放標籤</div></div>
                                </button>
                                <button onclick="state.actionItem=null;render();refocus()" class="mt-2 text-slate-400 text-sm py-2">取消操作</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(modal);
            }

            // 4. Confirm Modal
            if (state.confirmState) {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[10001]";
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-fade-in border-t-4 border-yellow-500">
                        <div class="flex items-center mb-4"><div class="bg-yellow-100 p-2 rounded-full mr-3 text-yellow-600"><i data-lucide="help-circle" class="w-6 h-6"></i></div><h3 class="text-lg font-bold">${state.confirmState.title}</h3></div>
                        <p class="text-slate-600 mb-6 whitespace-pre-line">${state.confirmState.message}</p>
                        <div class="flex gap-3">
                            <button onclick="state.confirmState=null;render()" class="flex-1 py-3 border rounded-lg font-bold text-slate-600">取消</button>
                            <button onclick="executeConfirmCallback()" class="flex-1 py-3 bg-yellow-500 text-white rounded-lg font-bold">確認執行</button>
                        </div>
                    </div>
                `;
                container.appendChild(modal);
            }

            // 5. Progress Overlay
            if (state.progress) {
                const p = state.progress;
                const percentage = Math.round((p.current / p.total) * 100);
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-[10002]";
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center animate-bounce-in">
                        <div class="mb-6 relative flex justify-center">
                            <svg class="w-24 h-24 transform -rotate-90">
                                <circle cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-100" />
                                <circle cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="transparent" class="text-blue-500 transition-all duration-300 ease-out" stroke-dasharray="251.2" stroke-dashoffset="${251.2 - (251.2 * percentage) / 100}" />
                            </svg>
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold text-blue-600">${percentage}%</div>
                        </div>
                        <h3 class="text-xl font-bold mb-2">正在處理中...</h3>
                        <p class="text-slate-500 font-mono text-sm mb-4">${p.message}</p>
                    </div>
                `;
                container.appendChild(modal);
            }
        }

        // --- Interaction Handlers ---

        function attemptLogin() {
            const user = document.getElementById('loginSelect').value;
            const pass = document.getElementById('loginPass').value;
            if (!user || !pass) return;

            const record = state.validOperators.find(op => op.name === user);
            if (record && String(record.password).trim() === pass.trim()) {
                state.operator = user;
                state.showOperatorModal = false;
                showToast(`歡迎, ${user}`, 'success');
                render();
            } else {
                playSound('error');
                alert("密碼錯誤");
            }
        }

        function logout() {
            state.operator = '';
            state.showOperatorModal = true;
            render();
        }

        function openActionModal(epc) {
            state.actionItem = state.samples.find(s => s.epc === epc);
            render();
        }

        async function submitRegister() {
            const sku = document.getElementById('regSku').value;
            const name = document.getElementById('regName').value;
            const cabinet = document.getElementById('regCab').value;
            const layer = document.getElementById('regLay').value;

            if (!name || !cabinet || !layer) {
                alert("請填寫必要欄位 (名稱、櫃號、層板)");
                return;
            }

            const success = await postData('REGISTER', {
                epc: state.registerData.epc,
                sku, name, cabinet, layer,
                wireDiameter: document.getElementById('regDia').value,
                standard: document.getElementById('regStd').value,
                manufacturer: document.getElementById('regMfg').value,
                batchNo: document.getElementById('regBatch').value,
                remarks: document.getElementById('regRmks').value,
                status: 'STORED'
            });

            if (success) {
                state.registerData = null;
                showToast(`已登錄：${name}`, 'success');
                refocus();
            }
        }

        async function handleAction(type) {
            const item = state.actionItem;
            let success = false;
            
            if (type === 'MOVE_TEST') {
                success = await postData('UPDATE', {
                    epc: item.epc,
                    cabinet: '試驗區', layer: '檢測台',
                    status: 'TESTING',
                    originalLocation: JSON.stringify({ cabinet: item.cabinet, layer: item.layer })
                });
            } else if (type === 'RETURN') {
                let restoreCab = '待整理區';
                let restoreLay = '待整理';
                try {
                    const parsed = JSON.parse(item.originalLocation);
                    restoreCab = parsed.cabinet;
                    restoreLay = parsed.layer;
                } catch(e) {}
                
                success = await postData('UPDATE', {
                    epc: item.epc,
                    cabinet: restoreCab, layer: restoreLay,
                    status: 'STORED', originalLocation: ''
                });
            }

            if (success) {
                state.actionItem = null;
                showToast('狀態更新成功', 'success');
                refocus();
            }
        }

        function confirmDestroy() {
            const item = state.actionItem;
            state.confirmState = {
                title: '確認銷毀',
                message: `確定要銷毀：\n${item.name} 嗎？`,
                onConfirm: async () => {
                    const success = await postData('DESTROY', {
                        epc: item.epc, sku: item.sku, name: item.name,
                        finalLocation: `${item.cabinet}-${item.layer}`
                    });
                    if (success) {
                        state.actionItem = null;
                        showToast(`已銷毀`, 'success');
                        refocus();
                    }
                }
            };
            render();
        }

        // Bridge for confirm modal callback
        let confirmCallbackRef = null;
        function executeConfirmCallback() {
            if (state.confirmState && state.confirmState.onConfirm) {
                state.confirmState.onConfirm();
                state.confirmState = null;
                render();
            }
        }

        function resetAudit() {
            state.auditResults = {};
            state.targetCabinet = '';
            state.targetLayer = '';
            render();
        }

        function applyLayerCorrection() {
            const itemsToFix = Object.entries(state.auditResults)
                .filter(([_, status]) => status === 'WRONG_LAYER' || status === 'WRONG_CABINET')
                .map(([epc]) => epc);

            state.confirmState = {
                title: '確認校正',
                message: `將 ${itemsToFix.length} 個樣品位置更新為：\n${state.targetCabinet} - ${state.targetLayer}？`,
                onConfirm: async () => {
                    state.progress = { current: 0, total: itemsToFix.length, message: '開始...', failures: [] };
                    render();

                    let successCount = 0;
                    for (let i = 0; i < itemsToFix.length; i++) {
                        const epc = itemsToFix[i];
                        state.progress.current = i + 1;
                        state.progress.message = `更新中: ${epc.slice(-6)}`;
                        render();

                        const success = await postData('UPDATE', {
                            epc, cabinet: state.targetCabinet, layer: state.targetLayer, status: 'STORED'
                        }, true);

                        if(success) {
                            successCount++;
                            state.auditResults[epc] = 'OK';
                        } else {
                            state.progress.failures.push(epc);
                        }
                        await delay(800);
                    }

                    state.progress.message = "同步資料庫...";
                    render();
                    await fetchData(true);
                    
                    state.progress = null;
                    showToast(`校正完成: ${successCount} 成功`, 'success');
                }
            };
            render();
        }

        // --- Init ---
        window.onload = () => {
            fetchData();
            refocus();
            
            // Re-focus listener
            document.body.addEventListener('click', (e) => {
               if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA') {
                   refocus();
               } 
            });
        };

    </script>
</body>
</html>