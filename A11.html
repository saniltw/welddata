<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銲接試片評分表</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* 動畫 */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 列印設定 */
        @media print {
            @page { size: A4; margin: 0.5cm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, button, .modal { display: none !important; }
            #app-container { box-shadow: none !important; max-width: 100% !important; width: 100% !important; }
            textarea { border: 1px solid black !important; resize: none; }
            select { appearance: none; border: none; font-weight: bold; }
            input { border: none; font-weight: bold; }
            /* 顯示被隱藏的列表 */
            .print-show { display: block !important; }
            .print-hide { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div id="app-container" class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden relative">
        
        <!-- Header -->
        <div id="header-bg" class="bg-slate-800 text-white p-6 transition-colors duration-300">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i data-lucide="clipboard-check" class="w-8 h-8 text-yellow-400" id="header-icon"></i>
                    <div>
                        <h1 class="text-2xl font-bold" id="header-title">銲接試片評分表</h1>
                        <p class="text-slate-300 text-sm" id="header-subtitle">Welding Specimen Examination Score Sheet</p>
                    </div>
                </div>
                
                <div class="flex gap-2 no-print">
                    <button onclick="openMappingModal()" class="flex items-center gap-2 p-2 rounded-lg bg-teal-600 hover:bg-teal-500 text-white shadow-lg transition-colors" title="試片管理">
                        <i data-lucide="users" class="w-5 h-5"></i> <span class="hidden md:inline">試片管理</span>
                    </button>
                    <button onclick="openStatsModal()" class="flex items-center gap-2 p-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg transition-colors" title="統計圖表">
                        <i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span class="hidden md:inline">統計分析</span>
                    </button>
                    <button onclick="openHistoryModal()" class="flex items-center gap-2 p-2 rounded-lg bg-purple-600 hover:bg-purple-500 text-white shadow-lg transition-colors" title="歷史紀錄">
                        <i data-lucide="history" class="w-5 h-5"></i> <span class="hidden md:inline">歷史紀錄</span>
                    </button>
                    
                    <button id="btn-cancel-edit" onclick="cancelEdit()" class="hidden flex items-center gap-2 p-2 rounded-lg bg-gray-500 hover:bg-gray-400 text-white shadow-lg transition-colors">
                        <i data-lucide="ban" class="w-5 h-5"></i> <span class="hidden md:inline">取消</span>
                    </button>

                    <button id="btn-save" onclick="saveToFirebase()" class="flex items-center gap-2 p-2 rounded-lg bg-green-600 hover:bg-green-500 text-white shadow-lg transition-colors border border-transparent">
                        <i data-lucide="save" class="w-5 h-5"></i> <span class="hidden md:inline" id="btn-save-text">儲存紀錄</span>
                    </button>

                    <button id="btn-reset-all" onclick="resetAll()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors text-slate-300" title="全部重置">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                    <button onclick="window.print()" class="p-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition-colors text-white shadow-lg" title="列印">
                        <i data-lucide="printer" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Info Area -->
        <div class="p-6 border-b border-gray-200 bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Specimen ID -->
                <div class="space-y-1">
                    <label class="text-sm font-semibold text-gray-600 flex items-center gap-1">
                        <i data-lucide="file-text" class="w-4 h-4"></i> <span id="label-specimen-id">試片編號 (1G)</span>
                    </label>
                    <input type="text" id="input-specimen-id" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono font-bold text-lg text-blue-800" placeholder="輸入編號">
                </div>
                <!-- Process -->
                <div class="space-y-1">
                    <label class="text-sm font-semibold text-gray-600 flex items-center gap-1">
                        <i data-lucide="settings" class="w-4 h-4"></i> 銲接法 / Process
                    </label>
                    <select id="input-process" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="SMAW">SMAW (手工電銲)</option>
                        <option value="GMAW">GMAW (MIG/MAG)</option>
                        <option value="FCAW">FCAW (包藥銲線)</option>
                        <option value="GTAW">GTAW (TIG/氬銲)</option>
                    </select>
                </div>
                <!-- Date -->
                <div class="space-y-1">
                    <label class="text-sm font-semibold text-gray-600 flex items-center gap-1">
                        <i data-lucide="calendar" class="w-4 h-4"></i> 評分日期 / Date
                    </label>
                    <input type="date" id="input-date" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <!-- Inspector -->
                <div class="space-y-1">
                    <label class="text-sm font-semibold text-gray-600 flex items-center gap-1">
                        <i data-lucide="user" class="w-4 h-4"></i> 監評人員 / Inspector
                    </label>
                    <input type="text" id="input-inspector" list="inspector-list" class="w-full border-gray-300 border rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="輸入或選擇姓名">
                    <datalist id="inspector-list"></datalist>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 no-print">
            <button onclick="switchTab('1G')" id="tab-1G" class="flex-1 py-4 text-center font-bold transition-colors text-blue-600 border-b-2 border-blue-600 bg-blue-50">1G 板對接平銲 (Groove)</button>
            <button onclick="switchTab('Fillet')" id="tab-Fillet" class="flex-1 py-4 text-center font-bold transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-50">3F/4F 角銲 (Fillet)</button>
        </div>

        <!-- Print Only Title -->
        <div class="hidden print-show p-2 border-b-2 border-black">
            <h2 class="text-xl font-bold text-center" id="print-title">1G 板對接平銲檢驗表 <span class="ml-2 text-sm font-normal text-gray-600" id="print-process"></span></h2>
        </div>

        <!-- Content Area -->
        <div class="p-6">
            <!-- 1G Content -->
            <div id="content-1G" class="space-y-4 animate-fadeIn">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 text-sm text-blue-800 no-print">
                    <strong>自動評分標準 (分數制)：</strong>
                    <div class="mt-2 flex gap-2 flex-wrap">
                        <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs border border-green-200">5分: 0缺陷 (A)</span>
                        <span class="bg-yellow-50 text-yellow-800 px-2 py-0.5 rounded text-xs border border-yellow-200">4分: 1缺陷 (B+)</span>
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs border border-yellow-300">3分: 2缺陷 (B)</span>
                        <span class="bg-orange-100 text-orange-800 px-2 py-0.5 rounded text-xs border border-orange-300">2分: 3缺陷 (B-)</span>
                        <span class="bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs border border-red-300">1分: 4+缺陷 (C)</span>
                    </div>
                </div>
                <div id="rows-1G" class="grid grid-cols-1 gap-3"></div>
                
                <div class="mt-4 no-break">
                    <label class="block text-sm font-medium text-gray-700 mb-1">備註 / Remarks</label>
                    <textarea id="remarks-1G" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm" rows="2" placeholder="輸入其他觀察事項..."></textarea>
                </div>
            </div>

            <!-- Fillet Content -->
            <div id="content-Fillet" class="space-y-4 animate-fadeIn hidden">
                <div class="flex items-center gap-4 mb-6 p-4 bg-orange-50 rounded-lg border border-orange-200 no-print">
                    <span class="font-bold text-orange-800">銲接位置：</span>
                    <select id="select-fillet-pos" onchange="updateFilletPosition()" class="border-gray-300 border rounded p-1 bg-white focus:ring-2 focus:ring-orange-500 outline-none">
                        <option value="3F">3F (立銲 Vertical)</option>
                        <option value="4F">4F (仰銲 Overhead)</option>
                    </select>
                </div>

                <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-4 text-sm text-orange-800 no-print">
                    <strong>自動評分標準 (分數制)：</strong>
                    <div class="mt-2 flex gap-2 flex-wrap">
                        <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs border border-green-200">5分: 0缺陷 (A)</span>
                        <span class="bg-yellow-50 text-yellow-800 px-2 py-0.5 rounded text-xs border border-yellow-200">4分: 1缺陷 (B+)</span>
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs border border-yellow-300">3分: 2缺陷 (B)</span>
                        <span class="bg-orange-100 text-orange-800 px-2 py-0.5 rounded text-xs border border-orange-300">2分: 3缺陷 (B-)</span>
                        <span class="bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs border border-red-300">1分: 4+缺陷 (C)</span>
                    </div>
                </div>
                
                <div id="rows-Fillet" class="grid grid-cols-1 gap-3"></div>

                <!-- 量測數據區塊 (Moved here) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 mb-4 bg-gray-50 p-4 rounded-lg border border-gray-200 break-inside-avoid">
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 mb-1">A 腳長 (mm)</label>
                        <input type="number" id="fillet-leg-a" oninput="updateFilletMeasurements()" class="w-full border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none" step="0.1" placeholder="0.0">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 mb-1">B 腳長 (mm)</label>
                        <input type="number" id="fillet-leg-b" oninput="updateFilletMeasurements()" class="w-full border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none" step="0.1" placeholder="0.0">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 mb-1">腳長差 (mm)</label>
                        <input type="text" id="fillet-leg-diff" readonly class="w-full border rounded p-1.5 bg-gray-200 font-bold text-blue-700" placeholder="-">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs font-bold text-gray-500 mb-1">銲道凸度 (mm)</label>
                        <input type="number" id="fillet-convexity" oninput="updateFilletMeasurements()" class="w-full border rounded p-1.5 focus:ring-2 focus:ring-blue-500 outline-none" step="0.1" placeholder="0.0">
                    </div>
                </div>

                <div class="mt-4 no-break">
                    <label class="block text-sm font-medium text-gray-700 mb-1">備註 / Remarks</label>
                    <textarea id="remarks-Fillet" class="w-full border rounded-md p-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm" rows="2" placeholder="輸入其他觀察事項..."></textarea>
                </div>
            </div>
        </div>

        <!-- Footer Summary -->
        <div class="bg-gray-50 p-6 border-t border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left text-sm text-gray-500 no-print">
                    <p>判定說明：</p>
                    <ul class="list-disc ml-4">
                        <li><span class="font-bold text-green-700">A ~ B-</span>：判定為 <span class="text-green-600 font-bold">PASS</span></li>
                        <li><span class="font-bold text-red-600">C (不合格)</span>：任一項缺陷 &ge; 4，即判定為 <span class="text-red-600 font-bold">FAIL</span></li>
                    </ul>
                </div>
                <div class="flex items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 w-full md:w-auto justify-between md:justify-end">
                    <div class="flex items-center gap-2">
                        <i data-lucide="calculator" class="w-6 h-6 text-blue-600 no-print"></i>
                        <span class="text-xl font-bold text-gray-700">總分 Total Score :</span>
                        <span class="text-3xl font-bold text-blue-700" id="display-score">0</span>
                    </div>
                    <div class="h-8 border-l border-gray-300 mx-4 no-print"></div>
                    <div class="flex items-center gap-2">
                        <span class="text-lg font-bold text-gray-700">結果 Result :</span>
                        <div id="display-result"></div>
                    </div>
                </div>
            </div>
            
            <div class="hidden print-show flex justify-between mt-12 pt-8 border-t border-gray-400 no-break">
                <div class="text-center w-1/3">
                    <div class="border-b border-black mb-2 h-8"></div>
                    <p>監評人員簽章 (Inspector)</p>
                </div>
                <div class="text-center w-1/3">
                    <div class="border-b border-black mb-2 h-8"></div>
                    <p>單位主管簽章 (Supervisor)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- History Modal -->
    <div id="modal-history" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-slate-800 text-white rounded-t-xl">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="history"></i> 歷史紀錄 (含解盲資訊)</h2>
                <button onclick="closeModal('modal-history')" class="text-slate-300 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div id="history-loading" class="hidden text-center py-12 text-blue-500">載入中...</div>
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="p-3">日期</th><th class="p-3">試片編號</th><th class="p-3 bg-orange-50">銲工姓名</th>
                            <th class="p-3">工法</th><th class="p-3">類型</th><th class="p-3">總分</th>
                            <th class="p-3">監評</th><th class="p-3">結果</th><th class="p-3">操作</th><th class="p-3">詳情</th>
                        </tr>
                    </thead>
                    <tbody id="history-list" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button onclick="closeModal('modal-history')" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg">關閉</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="modal-stats" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-700 text-white rounded-t-xl">
                <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="bar-chart-3"></i> 統計分析</h2>
                <button onclick="closeModal('modal-stats')" class="text-indigo-200 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <div class="flex flex-col md:flex-row gap-4 items-end bg-gray-50 p-4 rounded-lg">
                    <div class="w-full"><label class="text-sm text-gray-700">起始</label><input type="date" id="stats-start" class="border p-2 w-full rounded"></div>
                    <div class="w-full"><label class="text-sm text-gray-700">結束</label><input type="date" id="stats-end" class="border p-2 w-full rounded"></div>
                    <button onclick="fetchStatistics()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-500 w-full md:w-auto">分析</button>
                </div>
                <div id="stats-content" class="space-y-8 hidden">
                    <!-- Summary Cards -->
                    <div id="stats-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    <!-- Charts -->
                    <div class="bg-white border rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-lg mb-4 text-gray-700"><i data-lucide="trending-up"></i> 依試片類型</h3>
                        <div id="chart-type" class="space-y-4"></div>
                    </div>
                    <!-- Ranking -->
                    <div class="bg-white border rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-lg mb-4 text-gray-700"><i data-lucide="trophy"></i> 銲接人員排名 (依工法)</h3>
                        <div class="flex border-b mb-4 overflow-x-auto" id="stats-ranking-tabs"></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50"><tr><th class="p-3">排名</th><th class="p-3">姓名</th><th class="p-3 text-center">總件數</th><th class="p-3 text-center">合格率</th><th class="p-3 text-center">均分</th><th class="p-3 text-right">P/F</th></tr></thead>
                                <tbody id="stats-ranking-body" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapping Modal -->
    <div id="modal-mapping" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div class="p-4 border-b flex justify-between items-center bg-orange-700 text-white rounded-t-xl">
                <h2 class="text-lg font-bold flex items-center gap-2"><i data-lucide="users"></i> 試片管理 (盲測對照)</h2>
                <button onclick="closeModal('modal-mapping')" class="text-orange-200 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-500">設定試片編號與銲工姓名的對照。<br>(只能選取已評分且尚未歸戶的編號)</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">試片編號</label>
                    <div class="flex gap-2">
                        <select id="map-specimen-id" class="w-full border rounded-md p-2 bg-white font-mono font-bold">
                            <option value="">讀取中...</option>
                        </select>
                        <button onclick="fetchRecentSpecimenIds()" class="p-2 bg-gray-100 rounded hover:bg-gray-200"><i data-lucide="refresh-cw"></i></button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">銲工姓名</label>
                    <input type="text" id="map-welder-name" list="welder-list" class="w-full border rounded-md p-2" placeholder="輸入或選擇姓名">
                    <datalist id="welder-list"></datalist>
                </div>
                <button onclick="saveMapping()" class="w-full py-2 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-bold">綁定並儲存</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="modal-detail" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4 no-print backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-blue-700 text-white rounded-t-xl">
                <h2 class="text-lg font-bold flex items-center gap-2"><i data-lucide="file-search"></i> 詳細評分紀錄</h2>
                <button onclick="closeModal('modal-detail')" class="text-blue-200 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6" id="detail-content"></div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button onclick="closeModal('modal-detail')" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg">關閉</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal (Z-Index 60) -->
    <div id="modal-delete" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[60] p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-red-50 p-6 flex flex-col items-center text-center">
                <div class="bg-red-100 p-3 rounded-full mb-4"><i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i></div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">確定要刪除嗎？</h3>
                <p class="text-gray-500 text-sm">即將刪除試片 <span id="del-specimen-id" class="font-bold text-gray-800"></span> 的紀錄。<br>此動作無法復原。</p>
            </div>
            <div class="bg-gray-50 px-4 py-3 flex flex-row-reverse gap-2">
                <button onclick="confirmDelete()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700">確認刪除</button>
                <button onclick="closeModal('modal-delete')" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">取消</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc, arrayUnion, query, orderBy, limit, getDocs, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA12XH2okeXVEgdztM_oKBXHbVWeYp0EGs",
            authDomain: "weldwps-93ec4.firebaseapp.com",
            projectId: "weldwps-93ec4",
            storageBucket: "weldwps-93ec4.firebasestorage.app",
            messagingSenderId: "734060477729",
            appId: "1:734060477729:web:b3cb8e6d0afa08e0cd9260",
            measurementId: "G-KTFKQQ3PJL"
        };

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global State ---
        const state = {
            activeTab: '1G',
            scores1G: {},
            scoresFillet: {},
            specimenIds: { '1G': '', '3F': '', '4F': '' },
            examInfo: { process: 'SMAW', date: new Date().toISOString().split('T')[0], inspector: '' },
            editingRecordId: null,
            deleteTargetId: null,
            statsRankingData: {}
        };

        // --- Data Definitions ---
        const defectsMap1G = {
            appearance: ['夾渣 (Slag Inclusion)', '表面粗糙 (Roughness)', '接頭不良 (Bad Tie-in)', '銲道過窄 (Too Narrow)', '銲道過寬 (Too Wide)'],
            reinforcement: ['餘高過大 (Excess Reinforcement)', '餘高不足 (Insufficient Reinforcement)', '寬度不均 (Irregular Width)', '寬度不足 (Insufficient Width)'],
            undercut: ['深度過大 >0.5mm (Depth)', '長度過長 (Excessive Length)', '銳角過度 (Sharp Notch)', '母材損傷 (Base Metal Damage)'],
            porosity: ['密集氣孔 (Cluster Porosity)', '表面氣孔 (Surface Porosity)', '針孔 (Pinholes)', '蟲孔 (Wormholes)', '鏈狀氣孔 (Aligned Porosity)'],
            spatter: ['未清除 (Not Cleaned)', '嚴重噴渣 (Heavy Spatter)', '顆粒過大 (Large Particles)', '造成母材損傷 (Base Metal Damage)']
        };

        const defectsMapFillet = {
            legLength: ['腳長不足 (Insufficient Leg)', '腳長不等 (Unequal Leg)', '尺寸過大 (Excessive Leg)', '腳長過小 (Leg too small)'],
            throat: ['喉深不足 (Insufficient Throat)', '喉面凹陷 (Concave Throat)', '實際喉深不足 (Actual Throat Short)'],
            convexity: ['凸度過大 (Excessive Convexity)', '表面平直度不佳 (Poor Profile)', '銲道下垂 (Sagging)'],
            undercut: ['上趾部咬邊 (Top Undercut)', '下趾部咬邊 (Bottom Undercut)', '母材熔蝕 (Erosion)'],
            overlap: ['溢銲 (Overlap)', '銲道垂流 (Sagging)', '趾部未熔合 (Toe Lack of Fusion)']
        };

        const labelsMap = {
            appearance: '銲道外觀', reinforcement: '正面餘高', undercut: '咬邊', porosity: '氣孔', spatter: '噴渣',
            penetration: '背面滲透', bending: '彎曲試驗', legLength: '腳長', throat: '喉深', convexity: '凸度',
            overlap: '溢銲', startStop: '起弧/收弧'
        };

        // --- Init Functions ---
        function createItem() { return { defects: [], grade: 'A', score: 5 }; }

        function initScores() {
            state.scores1G = {
                appearance: createItem(), reinforcement: createItem(), undercut: createItem(), porosity: createItem(), spatter: createItem(),
                bending: { grade: 'NA', defect: '', score: 0 }, remarks: ''
            };
            state.scoresFillet = {
                position: '3F', 
                measurements: { legA: '', legB: '', diff: '', convexity: '' },
                legLength: createItem(), throat: createItem(), convexity: createItem(), undercut: createItem(), overlap: createItem(), remarks: ''
            };
        }

        async function loadMetadata() {
            try {
                // Inspectors
                const inspDoc = await getDoc(doc(db, "welding_metadata", "inspectors"));
                if (inspDoc.exists()) {
                    const list = document.getElementById('inspector-list');
                    list.innerHTML = inspDoc.data().list.map(n => `<option value="${n}">`).join('');
                }
                // Welders
                const weldDoc = await getDoc(doc(db, "welding_metadata", "welders"));
                if (weldDoc.exists()) {
                    const list = document.getElementById('welder-list');
                    list.innerHTML = weldDoc.data().list.map(n => `<option value="${n}">`).join('');
                }
            } catch (e) { console.error("Load metadata error", e); }
        }

        // --- Core Logic ---
        window.switchTab = (tab) => {
            state.activeTab = tab;
            document.getElementById('tab-1G').className = tab === '1G' ? "flex-1 py-4 text-center font-bold transition-colors text-blue-600 border-b-2 border-blue-600 bg-blue-50" : "flex-1 py-4 text-center font-bold transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-50";
            document.getElementById('tab-Fillet').className = tab === 'Fillet' ? "flex-1 py-4 text-center font-bold transition-colors text-blue-600 border-b-2 border-blue-600 bg-blue-50" : "flex-1 py-4 text-center font-bold transition-colors text-gray-500 hover:text-gray-700 hover:bg-gray-50";
            
            document.getElementById('content-1G').classList.toggle('hidden', tab !== '1G');
            document.getElementById('content-Fillet').classList.toggle('hidden', tab !== 'Fillet');
            
            updateHeaderInputs();
            
            // Restore measurements if Fillet
            if (tab === 'Fillet') {
                const m = state.scoresFillet.measurements || { legA: '', legB: '', diff: '', convexity: '' };
                document.getElementById('fillet-leg-a').value = m.legA;
                document.getElementById('fillet-leg-b').value = m.legB;
                document.getElementById('fillet-leg-diff').value = m.diff;
                document.getElementById('fillet-convexity').value = m.convexity;
            }

            renderRows();
            updateSummary();
        };

        window.updateFilletPosition = () => {
            state.scoresFillet.position = document.getElementById('select-fillet-pos').value;
            updateHeaderInputs();
            renderRows();
            updateSummary();
        }

        window.updateFilletMeasurements = () => {
            const a = parseFloat(document.getElementById('fillet-leg-a').value) || 0;
            const b = parseFloat(document.getElementById('fillet-leg-b').value) || 0;
            const conv = document.getElementById('fillet-convexity').value;
            
            const diff = Math.abs(a - b).toFixed(2);
            // Only show diff if both a and b have values (or at least 0, but usually we type)
            // Simplified check:
            const hasA = document.getElementById('fillet-leg-a').value !== '';
            const hasB = document.getElementById('fillet-leg-b').value !== '';
            
            const diffVal = (hasA && hasB) ? diff : '';
            document.getElementById('fillet-leg-diff').value = diffVal;

            if (!state.scoresFillet.measurements) state.scoresFillet.measurements = {};
            state.scoresFillet.measurements.legA = document.getElementById('fillet-leg-a').value;
            state.scoresFillet.measurements.legB = document.getElementById('fillet-leg-b').value;
            state.scoresFillet.measurements.diff = diffVal;
            state.scoresFillet.measurements.convexity = conv;
        }

        function updateHeaderInputs() {
            const contextKey = state.activeTab === '1G' ? '1G' : state.scoresFillet.position;
            const inputId = document.getElementById('input-specimen-id');
            const labelId = document.getElementById('label-specimen-id');
            
            if(labelId) labelId.textContent = `試片編號 (${contextKey})`;
            if(inputId) {
                inputId.placeholder = `輸入 ${contextKey} 編號`;
                inputId.value = state.specimenIds[contextKey] || ''; 
            }
            
            const printTitle = document.getElementById('print-title');
            if(printTitle) {
                printTitle.innerHTML = state.activeTab === '1G' ? 
                    `1G 板對接平銲檢驗表 <span class="ml-2 text-sm font-normal text-gray-600">[${state.examInfo.process}]</span>` : 
                    `角銲 (${state.scoresFillet.position}) 檢驗表 <span class="ml-2 text-sm font-normal text-gray-600">[${state.examInfo.process}]</span>`;
            }
        }

        // Input Listeners
        document.getElementById('input-specimen-id').addEventListener('input', (e) => {
            const contextKey = state.activeTab === '1G' ? '1G' : state.scoresFillet.position;
            state.specimenIds[contextKey] = e.target.value;
        });
        document.getElementById('input-process').addEventListener('change', (e) => { state.examInfo.process = e.target.value; updateHeaderInputs(); });
        document.getElementById('input-date').addEventListener('change', (e) => state.examInfo.date = e.target.value);
        document.getElementById('input-inspector').addEventListener('input', (e) => state.examInfo.inspector = e.target.value);
        document.getElementById('remarks-1G').addEventListener('input', (e) => state.scores1G.remarks = e.target.value);
        document.getElementById('remarks-Fillet').addEventListener('input', (e) => state.scoresFillet.remarks = e.target.value);

        // Date init
        document.getElementById('input-date').value = state.examInfo.date;
        document.getElementById('stats-end').value = state.examInfo.date;
        const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth() - 1);
        document.getElementById('stats-start').value = lastMonth.toISOString().split('T')[0];

        // --- Rendering Rows ---
        function calculateGrade(defectCount) {
            if (defectCount === 0) return { score: 5, grade: 'A' };
            if (defectCount === 1) return { score: 4, grade: 'B+' };
            if (defectCount === 2) return { score: 3, grade: 'B' };
            if (defectCount === 3) return { score: 2, grade: 'B-' };
            return { score: 1, grade: 'C' };
        }

        function getGradeColor(grade) {
            if (grade === 'A') return 'bg-green-100 text-green-800 border-green-200';
            if (grade === 'B+') return 'bg-yellow-50 text-yellow-800 border-yellow-200';
            if (grade === 'B') return 'bg-yellow-100 text-yellow-800 border-yellow-300';
            if (grade === 'B-') return 'bg-orange-100 text-orange-800 border-orange-300';
            if (grade === 'C') return 'bg-red-100 text-red-800 border-red-300';
            return 'bg-gray-100 text-gray-600 border-gray-200'; // NA
        }

        window.toggleDefect = (key, defectName) => {
            const currentScores = state.activeTab === '1G' ? state.scores1G : state.scoresFillet;
            const item = currentScores[key];
            
            // Removed NA check, everything is standard now
            
            const idx = item.defects.indexOf(defectName);
            if (idx > -1) item.defects.splice(idx, 1);
            else item.defects.push(defectName);

            const calc = calculateGrade(item.defects.length);
            item.grade = calc.grade;
            item.score = calc.score;
            
            renderRows();
            updateSummary();
        };

        // Removed toggleNA function

        // Removed setBending function

        function renderRows() {
            const is1G = state.activeTab === '1G';
            const container = document.getElementById(is1G ? 'rows-1G' : 'rows-Fillet');
            const map = is1G ? defectsMap1G : defectsMapFillet;
            const scores = is1G ? state.scores1G : state.scoresFillet;
            
            let html = '';

            // Standard Rows
            for (const [key, options] of Object.entries(map)) {
                const item = scores[key];
                // Removed isNA logic
                const gradeColor = getGradeColor(item.grade);
                
                // Defects Buttons
                const buttons = options.map(opt => {
                    const isSelected = item.defects.includes(opt);
                    const btnClass = isSelected 
                        ? 'bg-red-600 text-white border-red-600 shadow-sm' 
                        : 'bg-white text-gray-600 border-gray-300 hover:border-red-300 hover:bg-red-50';
                    return `<button onclick="toggleDefect('${key}', '${opt}')" class="text-sm px-3 py-1.5 rounded-full border transition-all text-left ${btnClass}">${opt}</button>`;
                }).join('');

                // Print Defects View
                const printDefects = item.defects.length > 0 
                    ? `<ul class="list-disc pl-4 text-red-700 font-bold">${item.defects.map(d=>`<li>${d}</li>`).join('')}</ul>`
                    : `<span class="text-green-800">無明顯缺陷 (滿分)</span>`;

                html += `
                <div class="flex flex-col p-4 border rounded-lg transition-all shadow-sm break-inside-avoid ${item.grade === 'C' ? 'bg-red-50 border-red-200' : 'bg-white hover:bg-gray-50 border-gray-200'} print:border-gray-300 print:bg-white print:p-2 print:shadow-none">
                    <div class="flex flex-col md:flex-row gap-4 print:gap-2">
                        <div class="md:w-1/3 flex flex-row md:flex-col justify-between items-start print:w-1/3">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2 print:text-sm">
                                    ${labelsMap[key]} 
                                    <!-- Removed toggle button -->
                                </h3>
                            </div>
                            <div class="flex gap-2">
                                <div class="px-4 py-2 rounded-lg border-2 text-center min-w-[70px] print:px-2 print:py-1 print:min-w-[50px] print:border ${gradeColor}">
                                    <div class="text-xs font-semibold uppercase opacity-70 print:text-[10px]">等級</div>
                                    <div class="text-2xl font-bold print:text-lg">${item.grade}</div>
                                </div>
                                <div class="px-4 py-2 rounded-lg border-2 text-center min-w-[60px] bg-blue-50 text-blue-800 border-blue-200 print:border-black print:text-black print:px-2 print:py-1"><div class="text-xs font-semibold uppercase opacity-70 print:text-[10px]">分數</div><div class="text-2xl font-bold print:text-lg">${item.score}</div></div>
                            </div>
                        </div>
                        <div class="md:w-2/3 border-t md:border-t-0 md:border-l border-dashed border-gray-300 pt-4 md:pt-0 md:pl-4 print:w-2/3 print:border-l print:border-t-0 print:pt-0 print:pl-2">
                            <div class="no-print">
                                <span class="text-xs font-semibold text-gray-500 mb-2 block">點擊選擇缺陷 (已選: ${item.defects.length})</span>
                                <div class="flex flex-wrap gap-2">${buttons}</div>
                            </div>
                            <div class="hidden print-show text-sm">${printDefects}</div>
                        </div>
                    </div>
                </div>`;
            }

            // Removed Bending Test HTML block

            container.innerHTML = html;
            lucide.createIcons();
        }

        function updateSummary() {
            let currentTotal = 0;
            let result = 'pass';
            const scores = state.activeTab === '1G' ? state.scores1G : state.scoresFillet;

            for (const key in scores) {
                if (key === 'remarks' || key === 'position' || key === 'measurements') continue;
                // Removed bending check since it's removed from state in init
                const item = scores[key];
                
                // Assuming everything has a score now since NA is gone
                if (item.score !== undefined) {
                    currentTotal += item.score;
                }

                if (item.grade === 'C') {
                    // No NA check needed
                    result = 'fail';
                }
            }

            document.getElementById('display-score').textContent = currentTotal;
            const resDiv = document.getElementById('display-result');
            if (result === 'pass') {
                resDiv.innerHTML = `<div class="flex items-center text-green-600 gap-2 print:text-black"><i data-lucide="check-circle" class="w-8 h-8 no-print"></i><span class="text-3xl font-bold border-2 border-green-600 px-4 py-1 rounded print:border-black">合格 PASS</span></div>`;
            } else {
                resDiv.innerHTML = `<div class="flex items-center text-red-600 gap-2 print:text-black"><i data-lucide="alert-triangle" class="w-8 h-8 no-print"></i><span class="text-3xl font-bold border-2 border-red-600 px-4 py-1 rounded print:border-black">不合格 FAIL</span></div>`;
            }
            lucide.createIcons();
            
            state.totalScore = currentTotal;
            state.finalResult = result;
        }

        // --- Firebase Actions ---
        
        window.saveToFirebase = async () => {
            const contextKey = state.activeTab === '1G' ? '1G' : state.scoresFillet.position;
            const currentId = state.specimenIds[contextKey];
            
            if (!currentId) return alert("請輸入試片編號後再儲存！");
            if (!state.examInfo.inspector) return alert("請輸入監評人員姓名！");

            const btn = document.getElementById('btn-save');
            const btnText = document.getElementById('btn-save-text');
            btn.disabled = true;
            btnText.textContent = "處理中...";

            try {
                // Save Inspector
                if (state.examInfo.inspector) {
                    await setDoc(doc(db, "welding_metadata", "inspectors"), { list: arrayUnion(state.examInfo.inspector) }, { merge: true });
                }

                const recordData = {
                    specimenId: currentId,
                    process: state.examInfo.process,
                    inspector: state.examInfo.inspector,
                    examDate: state.examInfo.date,
                    testType: state.activeTab === '1G' ? '1G' : state.scoresFillet.position,
                    finalResult: state.finalResult,
                    totalScore: state.totalScore,
                    createdAt: serverTimestamp(), // For ordering
                    details: state.activeTab === '1G' ? state.scores1G : state.scoresFillet
                };

                if (state.editingRecordId) {
                    // Update
                    await setDoc(doc(db, "welding_records", state.editingRecordId), recordData, { merge: true });
                    alert('紀錄已更新！');
                    cancelEdit();
                } else {
                    // Add New
                    await addDoc(collection(db, "welding_records"), recordData);
                    alert('儲存成功！');
                    resetCurrent();
                }

            } catch (e) {
                console.error(e);
                alert("儲存失敗");
            } finally {
                btn.disabled = false;
                btnText.textContent = state.editingRecordId ? "更新紀錄" : "儲存紀錄";
            }
        };

        window.resetCurrent = () => {
            const contextKey = state.activeTab === '1G' ? '1G' : state.scoresFillet.position;
            state.specimenIds[contextKey] = '';
            // Reset logic adjusted: removed bending and NA defaults
            if (state.activeTab === '1G') {
                state.scores1G = { appearance: createItem(), reinforcement: createItem(), undercut: createItem(), porosity: createItem(), spatter: createItem(), remarks: '' };
            } else {
                const pos = state.scoresFillet.position;
                state.scoresFillet = { 
                    position: pos, 
                    measurements: { legA: '', legB: '', diff: '', convexity: '' },
                    legLength: createItem(), throat: createItem(), convexity: createItem(), undercut: createItem(), overlap: createItem(), remarks: '' 
                };
                // Also reset measurement inputs in UI
                document.getElementById('fillet-leg-a').value = '';
                document.getElementById('fillet-leg-b').value = '';
                document.getElementById('fillet-leg-diff').value = '';
                document.getElementById('fillet-convexity').value = '';
            }
            updateHeaderInputs();
            renderRows();
            updateSummary();
        };

        window.resetAll = () => {
            if(!confirm("確定重置？")) return;
            initScores();
            state.specimenIds = { '1G': '', '3F': '', '4F': '' };
            cancelEdit();
            updateHeaderInputs();
            // Reset Inputs UI as well for Fillet
            document.getElementById('fillet-leg-a').value = '';
            document.getElementById('fillet-leg-b').value = '';
            document.getElementById('fillet-leg-diff').value = '';
            document.getElementById('fillet-convexity').value = '';
            renderRows();
            updateSummary();
        };

        // --- Modals Logic ---
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden', 'flex');
        
        // History
        window.openHistoryModal = async () => {
            document.getElementById('modal-history').classList.remove('hidden');
            document.getElementById('modal-history').classList.add('flex');
            const tbody = document.getElementById('history-list');
            tbody.innerHTML = '';
            document.getElementById('history-loading').classList.remove('hidden');

            try {
                const q = query(collection(db, "welding_records"), orderBy("createdAt", "desc"), limit(20));
                const snap = await getDocs(q);
                const records = [];
                const spIds = new Set();
                
                snap.forEach(d => {
                    const data = d.data();
                    records.push({ id: d.id, ...data });
                    if(data.specimenId) spIds.add(data.specimenId);
                });

                // Mapping
                const mappings = {};
                await Promise.all(Array.from(spIds).map(async (id) => {
                    const mSnap = await getDoc(doc(db, "welding_mappings", id));
                    if(mSnap.exists()) mappings[id] = mSnap.data().welderName;
                }));

                document.getElementById('history-loading').classList.add('hidden');
                
                records.forEach(rec => {
                    const welder = mappings[rec.specimenId] || '未登錄';
                    const passIcon = rec.finalResult === 'pass' 
                        ? '<span class="text-green-600 font-bold flex items-center gap-1"><i data-lucide="check-circle" class="w-4 h-4"></i> 合格</span>'
                        : '<span class="text-red-600 font-bold flex items-center gap-1"><i data-lucide="x-circle" class="w-4 h-4"></i> 不合格</span>';
                    
                    const row = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-3">${rec.examDate}</td>
                        <td class="p-3 font-mono font-bold">${rec.specimenId}</td>
                        <td class="p-3 bg-orange-50 text-gray-800 font-bold border-x border-orange-100">${welder}</td>
                        <td class="p-3">${rec.process || '-'}</td>
                        <td class="p-3"><span class="px-2 py-0.5 rounded text-xs ${rec.testType === '1G' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">${rec.testType}</span></td>
                        <td class="p-3 font-bold text-blue-700">${rec.totalScore ?? '-'}</td>
                        <td class="p-3">${rec.inspector}</td>
                        <td class="p-3">${passIcon}</td>
                        <td class="p-3 flex gap-2">
                            <button onclick="editRecord('${rec.id}')" class="p-1.5 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"><i data-lucide="edit" class="w-4 h-4"></i></button>
                            <button onclick="askDelete('${rec.id}', '${rec.specimenId}')" class="p-1.5 bg-red-100 text-red-600 rounded hover:bg-red-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                        <td class="p-3"><button onclick="viewDetail('${rec.id}')" class="text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="file-search" class="w-4 h-4"></i>查看</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                lucide.createIcons();
                // Save records to global state for detail view
                state.historyRecords = records;

            } catch(e) { console.error(e); alert("讀取失敗"); }
        };

        // Edit
        window.editRecord = (id) => {
            const rec = state.historyRecords.find(r => r.id === id);
            if(!rec) return;
            
            state.examInfo = { process: rec.process, date: rec.examDate, inspector: rec.inspector };
            document.getElementById('input-process').value = rec.process;
            document.getElementById('input-date').value = rec.examDate;
            document.getElementById('input-inspector').value = rec.inspector;

            const testType = rec.testType === '1G' ? '1G' : (['3F','4F'].includes(rec.testType) ? rec.testType : '3F');
            
            if (testType === '1G') {
                state.activeTab = '1G';
                state.specimenIds['1G'] = rec.specimenId;
                state.scores1G = { ...initial1GState, ...rec.details }; // Merge
                switchTab('1G');
            } else {
                state.activeTab = 'Fillet';
                state.specimenIds[testType] = rec.specimenId;
                state.scoresFillet = { ...initialFilletState, ...rec.details, position: testType };
                switchTab('Fillet');
                // Manually trigger render because switchTab does not update select value if hidden
                document.getElementById('select-fillet-pos').value = testType;
                updateFilletPosition();
                // Restore Measurements fields in Edit Mode
                if (rec.details.measurements) {
                    const m = rec.details.measurements;
                    document.getElementById('fillet-leg-a').value = m.legA || '';
                    document.getElementById('fillet-leg-b').value = m.legB || '';
                    document.getElementById('fillet-leg-diff').value = m.diff || '';
                    document.getElementById('fillet-convexity').value = m.convexity || '';
                }
            }

            state.editingRecordId = id;
            document.getElementById('modal-history').classList.add('hidden');
            
            // Toggle Header Styles
            document.getElementById('header-bg').classList.replace('bg-slate-800', 'bg-orange-700');
            document.getElementById('header-title').textContent = "銲接試片評分表 (編輯模式)";
            document.getElementById('header-icon').classList.replace('text-yellow-400', 'text-white');
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('btn-save-text').textContent = "更新紀錄";
            document.getElementById('btn-save').classList.replace('bg-green-600', 'bg-orange-500');
            document.getElementById('btn-reset-all').classList.add('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEdit = () => {
            state.editingRecordId = null;
            resetCurrent();
            // Restore Header
            document.getElementById('header-bg').classList.replace('bg-orange-700', 'bg-slate-800');
            document.getElementById('header-title').textContent = "銲接試片評分表";
            document.getElementById('header-icon').classList.replace('text-white', 'text-yellow-400');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('btn-save-text').textContent = "儲存紀錄";
            document.getElementById('btn-save').classList.replace('bg-orange-500', 'bg-green-600');
            document.getElementById('btn-reset-all').classList.remove('hidden');
        };

        // Delete
        window.askDelete = (id, spId) => {
            state.deleteTargetId = id;
            document.getElementById('del-specimen-id').textContent = spId;
            document.getElementById('modal-delete').classList.remove('hidden');
            document.getElementById('modal-delete').classList.add('flex');
        };

        window.confirmDelete = async () => {
            if(!state.deleteTargetId) return;
            try {
                await deleteDoc(doc(db, "welding_records", state.deleteTargetId));
                alert("已刪除");
                document.getElementById('modal-delete').classList.add('hidden');
                openHistoryModal(); // Refresh
            } catch(e) { console.error(e); alert("刪除失敗"); }
        };

        // Detail
        window.viewDetail = (id) => {
            const rec = state.historyRecords.find(r => r.id === id);
            if(!rec) return;
            const content = document.getElementById('detail-content');
            
            // Helper to get welder name (needs to re-fetch? no, it's in historyRecords now)
            
            let html = `
            <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div><span class="text-xs text-gray-500 block">編號</span><span class="font-bold font-mono text-lg">${rec.specimenId}</span></div>
                <div><span class="text-xs text-gray-500 block">銲工</span><span class="font-bold text-lg text-orange-700">${rec.welderName}</span></div>
                <div><span class="text-xs text-gray-500 block">日期</span><span>${rec.examDate}</span></div>
                <div><span class="text-xs text-gray-500 block">監評</span><span>${rec.inspector}</span></div>
                <div><span class="text-xs text-gray-500 block">工法</span><span>${rec.process}</span></div>
                <div><span class="text-xs text-gray-500 block">類型</span><span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-800">${rec.testType}</span></div>
            </div>`;

            // Display Measurements in Detail View if exists
            if (rec.details.measurements) {
                const m = rec.details.measurements;
                html += `
                <div class="grid grid-cols-4 gap-4 mt-4 bg-blue-50 p-3 rounded-lg text-sm border border-blue-100">
                    <div class="text-center"><span class="text-xs text-gray-500 block">A 腳長</span><span class="font-bold">${m.legA || '-'}</span></div>
                    <div class="text-center"><span class="text-xs text-gray-500 block">B 腳長</span><span class="font-bold">${m.legB || '-'}</span></div>
                    <div class="text-center"><span class="text-xs text-gray-500 block">腳長差</span><span class="font-bold text-blue-700">${m.diff || '-'}</span></div>
                    <div class="text-center"><span class="text-xs text-gray-500 block">凸度</span><span class="font-bold">${m.convexity || '-'}</span></div>
                </div>`;
            }

            html += `
            <div class="border rounded-lg overflow-hidden mt-4">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 text-gray-700"><tr><th class="p-3">項目</th><th class="p-3 text-center">等級</th><th class="p-3 text-center">分數</th><th class="p-3">缺陷</th></tr></thead>
                    <tbody class="divide-y divide-gray-200">`;
            
            for (const key in rec.details) {
                if (key === 'remarks' || key === 'position' || key === 'measurements') continue;
                const item = rec.details[key];
                html += `
                <tr class="${item.grade==='C' && !item.na ? 'bg-red-50':''}">
                    <td class="p-3 font-medium">${labelsMap[key] || key} ${item.isOptional ? '<span class="text-xs text-gray-400">(選)</span>':''}</td>
                    <td class="p-3 text-center"><span class="px-2 py-1 rounded font-bold text-xs ${item.grade==='A'?'bg-green-100 text-green-800':item.grade==='C'?'bg-red-100 text-red-800':item.grade==='NA'?'bg-gray-100':'bg-yellow-100 text-yellow-800'}">${item.grade}</span></td>
                    <td class="p-3 text-center font-bold text-blue-700">${item.na ? '-':item.score}</td>
                    <td class="p-3 text-gray-600 text-xs">${item.na ? '免測' : (item.defects && item.defects.length > 0 ? item.defects.join(', ') : '無缺陷')}</td>
                </tr>`;
            }
            html += `</tbody><tfoot class="bg-gray-50 font-bold border-t-2"><tr><td class="p-3 text-right">總分</td><td></td><td class="p-3 text-center text-lg text-blue-800">${rec.totalScore}</td><td class="p-3">${rec.finalResult}</td></tr></tfoot></table></div>`;
            
            if(rec.details.remarks) html += `<div class="mt-4 bg-yellow-50 p-4 rounded text-sm text-gray-700 border border-yellow-200"><strong>備註:</strong> ${rec.details.remarks}</div>`;

            content.innerHTML = html;
            document.getElementById('modal-detail').classList.remove('hidden');
            document.getElementById('modal-detail').classList.add('flex');
        };

        // Mapping (Blind Test)
        window.openMappingModal = async () => {
            document.getElementById('modal-mapping').classList.remove('hidden');
            document.getElementById('modal-mapping').classList.add('flex');
            await fetchRecentSpecimenIds();
        };

        window.fetchRecentSpecimenIds = async () => {
            const select = document.getElementById('map-specimen-id');
            select.innerHTML = '<option value="">讀取中...</option>';
            
            try {
                // 1. Get recent records
                const q = query(collection(db, "welding_records"), orderBy("createdAt", "desc"), limit(50));
                const snap = await getDocs(q);
                const candidates = new Set();
                snap.forEach(d => { if(d.data().specimenId) candidates.add(d.data().specimenId); });
                
                // 2. Check mapping existence
                const uniqueArr = Array.from(candidates);
                const results = await Promise.all(uniqueArr.map(async id => {
                    const m = await getDoc(doc(db, "welding_mappings", id));
                    return { id, exists: m.exists() };
                }));

                // 3. Filter unmapped
                const unmapped = results.filter(r => !r.exists).map(r => r.id);
                
                select.innerHTML = '<option value="">-- 請選擇試片編號 --</option>';
                if(unmapped.length === 0) select.innerHTML += '<option disabled>無未歸戶編號</option>';
                unmapped.forEach(id => {
                    select.innerHTML += `<option value="${id}">${id}</option>`;
                });

            } catch(e) { console.error(e); select.innerHTML = '<option>讀取失敗</option>'; }
        };

        window.saveMapping = async () => {
            const id = document.getElementById('map-specimen-id').value;
            const name = document.getElementById('map-welder-name').value;
            if(!id || !name) return alert("請完整輸入");

            try {
                if(name && !state.welderList?.includes(name)) {
                    await setDoc(doc(db, "welding_metadata", "welders"), { list: arrayUnion(name) }, { merge: true });
                }
                await setDoc(doc(db, "welding_mappings", id), { welderName: name, updatedAt: serverTimestamp() });
                alert("綁定成功");
                document.getElementById('map-welder-name').value = '';
                fetchRecentSpecimenIds(); // Refresh list
            } catch(e) { console.error(e); alert("失敗"); }
        };

        // Stats
        window.openStatsModal = () => {
            document.getElementById('modal-stats').classList.remove('hidden');
            document.getElementById('modal-stats').classList.add('flex');
        };

        window.fetchStatistics = async () => {
            const start = document.getElementById('stats-start').value;
            const end = document.getElementById('stats-end').value;
            
            document.getElementById('stats-content').classList.remove('hidden');
            document.getElementById('stats-summary').innerHTML = '<div class="col-span-4 text-center">分析中...</div>';

            try {
                const q = query(collection(db, "welding_records"), where("examDate", ">=", start), where("examDate", "<=", end));
                const snap = await getDocs(q);
                const records = [];
                const spIds = new Set();
                snap.forEach(d => { records.push(d.data()); if(d.data().specimenId) spIds.add(d.data().specimenId); });

                // Mappings
                const mappings = {};
                await Promise.all(Array.from(spIds).map(async id => {
                    const m = await getDoc(doc(db, "welding_mappings", id));
                    if(m.exists()) mappings[id] = m.data().welderName;
                }));

                // Calculate
                const stats = { 'SMAW':[], 'GMAW':[], 'FCAW':[], 'GTAW':[] }; 
                const raw = {}; // { 'SMAW': { 'Name': { total, pass, scores:[] } } }

                records.forEach(r => {
                    const proc = r.process || 'SMAW'; // fallback
                    const name = mappings[r.specimenId] || '未登錄';
                    const score = r.totalScore || 0;
                    const isPass = r.finalResult === 'pass';

                    if(!raw[proc]) raw[proc] = {};
                    if(!raw[proc][name]) raw[proc][name] = { total:0, pass:0, fail:0, scores:[] };
                    
                    const d = raw[proc][name];
                    d.total++;
                    if(isPass) d.pass++; else d.fail++;
                    d.scores.push(score);
                });

                // Transform to array & sort
                let htmlTabs = '';
                let firstProc = null;
                
                state.statsRankingData = {}; // Store for render

                for(const p of ['SMAW', 'GMAW', 'FCAW', 'GTAW']) {
                    const welders = raw[p] ? Object.keys(raw[p]).map(w => {
                        const d = raw[p][w];
                        const avg = (d.scores.reduce((a,b)=>a+b,0) / d.total).toFixed(1);
                        const rate = Math.round((d.pass/d.total)*100);
                        return { name: w, ...d, avg, rate };
                    }) : [];
                    
                    // Sort: Avg Score Desc -> Rate Desc
                    welders.sort((a,b) => b.avg - a.avg || b.rate - a.rate);
                    state.statsRankingData[p] = welders;

                    if(welders.length > 0 && !firstProc) firstProc = p;

                    htmlTabs += `<button onclick="renderRanking('${p}')" id="stat-tab-${p}" class="px-4 py-2 font-medium text-sm whitespace-nowrap transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700">${p} <span class="text-xs bg-gray-100 px-1 rounded">${welders.length}</span></button>`;
                }

                document.getElementById('stats-ranking-tabs').innerHTML = htmlTabs;
                
                // Render Charts (Type) & Summary
                const typeStats = { '1G':{total:0, pass:0}, '3F':{total:0, pass:0}, '4F':{total:0, pass:0} };
                let grandTotal = 0; let grandPass = 0;

                records.forEach(r => {
                    const t = r.testType;
                    if(typeStats[t]) {
                        typeStats[t].total++;
                        if(r.finalResult === 'pass') typeStats[t].pass++;
                    }
                    grandTotal++;
                    if(r.finalResult === 'pass') grandPass++;
                });

                // Summary HTML
                const grandRate = grandTotal>0 ? Math.round(grandPass/grandTotal*100) : 0;
                let summaryHtml = `
                    <div class="bg-white border rounded-xl p-4 shadow-sm text-center">
                        <h4 class="text-gray-500 font-bold mb-2">總計</h4>
                        <div class="text-3xl font-bold text-gray-800">${grandTotal} <span class="text-xs text-gray-400 font-normal">件</span></div>
                        <div class="text-sm mt-1 font-bold ${grandRate>=60?'text-green-600':'text-red-600'}">及格率 ${grandRate}%</div>
                    </div>`;
                
                for(const t of ['1G','3F','4F']) {
                    const d = typeStats[t];
                    const r = d.total>0 ? Math.round(d.pass/d.total*100) : 0;
                    summaryHtml += `
                    <div class="bg-white border rounded-xl p-4 shadow-sm text-center">
                        <h4 class="text-gray-500 font-bold mb-2">${t}</h4>
                        <div class="text-3xl font-bold text-gray-800">${d.total}</div>
                        <div class="text-sm mt-1 font-bold ${r>=60?'text-green-600':'text-red-600'}">${r}%</div>
                    </div>`;
                }
                document.getElementById('stats-summary').innerHTML = summaryHtml;

                // Chart HTML
                let chartHtml = '';
                for(const t of ['1G','3F','4F']) {
                    const d = typeStats[t];
                    const pR = d.total>0 ? Math.round(d.pass/d.total*100) : 0;
                    const fR = 100 - pR;
                    if(d.total > 0) {
                        chartHtml += `
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm font-bold text-gray-700"><span>${t} (${d.total})</span><span>P:${d.pass}/F:${d.total-d.pass}</span></div>
                            <div class="h-6 w-full bg-gray-100 rounded-full overflow-hidden flex shadow-inner">
                                ${pR>0 ? `<div style="width:${pR}%" class="bg-green-500 h-full flex items-center justify-center text-white text-[10px]">${pR}%</div>`:''}
                                ${fR>0 ? `<div style="width:${fR}%" class="bg-red-500 h-full flex items-center justify-center text-white text-[10px]">${fR}%</div>`:''}
                            </div>
                        </div>`;
                    }
                }
                document.getElementById('chart-type').innerHTML = chartHtml || '<p class="text-gray-400 text-center">無數據</p>';

                // Render Ranking
                if(firstProc) renderRanking(firstProc);
                else renderRanking('SMAW');

            } catch(e) { console.error(e); alert("統計失敗"); }
        };

        window.renderRanking = (proc) => {
            // Update active tab style
            document.querySelectorAll('#stats-ranking-tabs button').forEach(b => {
                b.className = "px-4 py-2 font-medium text-sm whitespace-nowrap transition-colors border-b-2 border-transparent text-gray-500 hover:text-gray-700";
            });
            const activeBtn = document.getElementById(`stat-tab-${proc}`);
            if(activeBtn) activeBtn.className = "px-4 py-2 font-medium text-sm whitespace-nowrap transition-colors border-b-2 border-indigo-600 text-indigo-600";

            const tbody = document.getElementById('stats-ranking-body');
            const data = state.statsRankingData[proc] || [];
            
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">無數據</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((d, i) => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-3 font-bold text-gray-500">#${i+1}</td>
                    <td class="p-3 font-bold text-gray-800">${d.name}</td>
                    <td class="p-3 text-center">${d.total}</td>
                    <td class="p-3 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <div class="w-16 bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div class="h-2 rounded-full ${d.rate>=80?'bg-green-500':d.rate>=60?'bg-yellow-500':'bg-red-500'}" style="width:${d.rate}%"></div>
                            </div>
                            <span class="text-xs font-bold">${d.rate}%</span>
                        </div>
                    </td>
                    <td class="p-3 text-center font-bold text-indigo-600">${d.avg}</td>
                    <td class="p-3 text-right"><span class="text-green-600 font-bold">${d.pass}</span> / <span class="text-red-500 font-bold">${d.fail}</span></td>
                </tr>
            `).join('');
        };

        // --- Initial Render ---
        initScores();
        updateHeaderInputs();
        renderRows();
        updateSummary();
        loadMetadata();
    </script>
</body>
</html>