<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工程計算工具集 | Engineering Toolkit</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Inter for UI, JetBrains Mono for Numbers -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b', // Custom dark sidebar
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 工業風細節調整 */
        input[type="number"] {
            -moz-appearance: textfield;
            font-family: 'JetBrains Mono', monospace;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .nav-item.active {
            background-color: #2563eb; /* Blue-600 */
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .nav-item.active span {
            background-color: white; /* Indicator dot becomes white */
        }
        
        /* Mobile handling */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        /* Formula Box Style */
        .formula-box {
            @apply mt-8 pt-6 border-t border-slate-200 text-slate-500 text-sm;
        }
        .formula-label {
            @apply text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider;
        }
        /* Math Typsetting Simulation */
        .math-expr {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.25rem;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .math-expr span { font-style: normal; } /* Operators */
        .math-frac {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.2rem;
        }
        .math-num {
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
            text-align: center;
        }
        .math-denom {
            padding-top: 2px;
            text-align: center;
        }
        .math-sub { vertical-align: sub; font-size: 0.7em; margin-left: 1px; }
        .math-sup { vertical-align: super; font-size: 0.7em; margin-left: 1px; }
        .math-desc {
            @apply text-xs text-slate-400 mt-2 text-center block font-sans;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col lg:flex-row overflow-hidden">

    <!-- Mobile Header -->
    <header class="lg:hidden h-14 bg-slate-900 text-white flex items-center justify-between px-4 z-50 shadow-md flex-shrink-0">
        <span class="font-bold text-lg tracking-wider">ENG.TOOLKIT</span>
        <button id="mobile-menu-btn" class="p-2 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </header>

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="sidebar-transition fixed inset-y-0 left-0 w-64 bg-slate-900 text-slate-300 flex flex-col z-40 transform -translate-x-full lg:translate-x-0 lg:relative lg:flex lg:flex-shrink-0 shadow-xl border-r border-slate-800">
        <div class="h-16 flex items-center px-6 border-b border-slate-800 hidden lg:flex">
            <svg class="w-6 h-6 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
            <span class="font-bold text-xl tracking-tight text-white">ENG.TOOLKIT</span>
        </div>
        
        <!-- Navigation Container (Now holds dropdown) -->
        <div class="p-4">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">選擇工具 / Select Tool</label>
            <nav id="nav-container">
                <!-- Select will be injected by JS -->
            </nav>
        </div>
        
        <div class="flex-1"></div> <!-- Spacer -->

        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
            v4.1.0 | Weld Calc UI Update
        </div>
    </aside>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden glass"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-slate-100">
        <!-- Scrollable Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 lg:p-8">
            <div class="max-w-5xl mx-auto">
                <div id="active-calculator-title" class="mb-6">
                    <h1 class="text-2xl font-bold text-slate-900" id="page-title">Loading...</h1>
                    <p class="text-slate-500 text-sm mt-1" id="page-desc">Please select a tool from the menu.</p>
                </div>

                <!-- Calculators Container -->
                <div id="calculator-wrapper" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
                    <!-- Dynamic Content Injected Here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Core Logic & Application Script -->
    <script>
        /**
         * 1. Core Logic Layer (Pure Functions)
         */
        const EngineeringCore = {
            // 1. Heat Input
            calculateHeatInput: (params) => {
                const { current, voltage, efficiency, speed, speedUnit, mode, length, lengthUnit, timeMin, timeSec } = params;
                let finalSpeed = 0; // mm/min

                if (mode === 'speed') {
                    // Direct Speed
                    if (speedUnit === 'cm_min') {
                        finalSpeed = speed * 10;
                    } else { // mm_min
                        finalSpeed = speed;
                    }
                } else {
                    // Length + Time
                    // Convert Length to mm
                    let lengthMm = length;
                    if (lengthUnit === 'm') lengthMm = length * 1000;
                    else if (lengthUnit === 'cm') lengthMm = length * 10;
                    
                    // Convert Time to min
                    let timeTotalMin = (timeMin || 0) + (timeSec || 0) / 60;

                    if (timeTotalMin > 0) {
                        finalSpeed = lengthMm / timeTotalMin;
                    }
                }

                if (!finalSpeed || finalSpeed <= 0) return { kj_mm: 0, kj_cm: 0, speed_cm_min: 0 };

                const kj_mm = (current * voltage * 60 * efficiency) / (finalSpeed * 1000);
                
                return {
                    kj_mm: kj_mm.toFixed(3),
                    kj_cm: (kj_mm * 10).toFixed(2),
                    speed_cm_min: (finalSpeed / 10).toFixed(1)
                };
            },

            // 2. Carbon Equivalent
            calculateCE: (el) => {
                const v = (key) => el[key] || 0;
                const C=v('C'), Mn=v('Mn'), Si=v('Si'), Ni=v('Ni'), Cr=v('Cr'), Mo=v('Mo'), V=v('V'), Cu=v('Cu'), Nb=v('Nb'), B=v('B'), H=v('H'), t=v('t');
                
                const ce_aws = C + Mn/6 + (Cr+Mo+V)/5 + (Ni+Cu)/15;
                const ce_jis = C + Mn/6 + Si/24 + Ni/40 + Cr/5 + Mo/4 + V/14;
                const pcm = C + Si/30 + Mn/20 + Cu/20 + Ni/60 + Cr/20 + Mo/15 + V/10 + 5*B;
                const pw = pcm + H/60 + t/600;

                // Preheat Suggestions (Bilingual)
                let aws_note = "可不預熱 / No Preheat";
                let aws_class = "text-green-600";
                
                if (ce_aws >= 0.60) { aws_note = "極高風險 (預熱 200°C+) / High Risk"; aws_class = "text-red-600"; } 
                else if (ce_aws >= 0.45) { aws_note = "需預熱 (100~150°C) / Preheat Req."; aws_class = "text-orange-600"; } 
                else if (ce_aws >= 0.40) { aws_note = "建議微預熱 (50~100°C) / Optional Preheat"; aws_class = "text-yellow-600"; }

                let pw_note = "可不預熱 / No Preheat";
                let pw_class = "text-green-600";
                
                if (pw >= 0.40) { pw_note = "需高溫預熱 (>150°C) / High Preheat"; pw_class = "text-red-600"; } 
                else if (pw >= 0.30) { pw_note = "需預熱 (100~150°C) / Preheat Req."; pw_class = "text-orange-600"; } 
                else if (pw >= 0.25) { pw_note = "建議預熱 (60~100°C) / Optional Preheat"; pw_class = "text-yellow-600"; }

                return { aws: ce_aws.toFixed(3), jis: ce_jis.toFixed(3), pcm: pcm.toFixed(3), pw: pw.toFixed(3), aws_note, aws_class, pw_note, pw_class };
            },

            // 3. Ferrite Number
            calculateFerrite: (el) => {
                const v = (key) => el[key] || 0;
                const C=v('C'), Si=v('Si'), Mn=v('Mn'), Cr=v('Cr'), Ni=v('Ni'), Mo=v('Mo'), Nb=v('Nb'), N=v('N'), Cu=v('Cu'), Ti=v('Ti'), GS=v('GS');

                const crekv = Cr + 1.5 * Si + Mo + 2.0 * Ti + 0.5 * Nb;
                const niekv = Ni + 0.5 * Mn + 30.0 * N + 30.0 * C + 0.5 * Cu;
                
                let fn = 3.34 * crekv - 2.46 * niekv - 28.6;
                if (fn >= 6.0) fn = 4.44 * crekv - 3.39 * niekv - 38.4;
                if (fn < 0) fn = 0;

                const tmd30 = 551 - (462 * (C + N)) - (9.2 * Si) - (8.1 * Mn) - (13.7 * Cr) - (29 * Ni) - (18.5 * Mo) - (29 * Cu) - (68 * Nb) - (1.42 * (GS - 8.0));

                return { creq: crekv.toFixed(2), nieq: niekv.toFixed(2), fn: fn.toFixed(2), tmd30: tmd30.toFixed(1) };
            },

            // 4. Steel Plate Weight
            calculatePlateWeight: (l, lUnit, w, wUnit, t, d) => {
                let l_m = l;
                if (lUnit === 'mm') l_m = l / 1000;
                else if (lUnit === 'cm') l_m = l / 100;

                let w_m = w;
                if (wUnit === 'mm') w_m = w / 1000;
                else if (wUnit === 'cm') w_m = w / 100;

                return (l_m * w_m * t * d).toFixed(2);
            },

            // 5. PREN
            calculatePREN: (cr, mo, n) => (cr + 3.3 * mo + 16 * n).toFixed(2),

            // 6. Sensitization
            calculateSensitization: (nb, ti, c, n) => {
                const den = c + n;
                if (den === 0) return { val: "N/A", isSafe: false };
                const val = (nb + ti) / den;
                return { val: val.toFixed(2), isSafe: val >= 8 };
            },

            // 7. Current Density
            calculateCurrentDensity: (dia, current) => {
                if (dia <= 0) return "0.00";
                const area = Math.PI * Math.pow(dia/2, 2);
                return (current / area).toFixed(2);
            },

            // 8. Fillet Weld
            calculateFilletWeld: (l1, l2, len, density, eff, reinf) => {
                if(eff <= 0) return "0.00";
                const area_mm2 = (l1 * l2) / 2;
                const weight = (area_mm2 * len * density * (1 + reinf/100)) / (eff * 10);
                return weight.toFixed(2);
            },

            // 9. Butt Weld
            calculateButtWeld: (t, angle, gap, len, density, eff, reinf) => {
                 if(eff <= 0) return "0.00";
                 const rad = (angle * Math.PI) / 180;
                 const area_mm2 = (t * gap) + (t * t * Math.tan(rad / 2));
                 const weight = (area_mm2 * len * density * (1 + reinf/100)) / (eff * 10);
                 return weight.toFixed(2);
            },

            // 10. Gas Cylinder
            calculateGasWeight: (vol, press, avgMw) => {
                 const P_atm = press / 1.033;
                 const moles = (P_atm * vol) / 24.5; // Ideal gas at 25C
                 const weight_g = moles * avgMw;
                 return (weight_g / 1000).toFixed(2);
            },

            // 11. Welder Power
            calculatePower: (params) => {
                const { i_out, v_out, eff, pf, v_in, phase, standby_current, price, arc_h, arc_m, arc_s, total_h, total_m, total_s } = params;
                const p_out_kw = (i_out * v_out) / 1000;
                const eff_decimal = eff / 100;
                const p_weld_in_kw = (eff_decimal > 0) ? p_out_kw / eff_decimal : 0;
                const factor = (phase === 1) ? 1 : 1.732;
                const p_standby_in_kw = (v_in * standby_current * factor * pf) / 1000;
                const t_arc = (arc_h || 0) + (arc_m || 0)/60 + (arc_s || 0)/3600;
                const t_total_work = (total_h || 0) + (total_m || 0)/60 + (total_s || 0)/3600;
                let t_standby = t_total_work - t_arc;
                if (t_standby < 0) t_standby = 0;
                const e_weld = p_weld_in_kw * t_arc;
                const e_standby = p_standby_in_kw * t_standby;
                const e_total = e_weld + e_standby;
                const cost_weld = e_weld * price;
                const cost_standby = e_standby * price;
                const cost_total = e_total * price;
                const i_weld_in = (p_weld_in_kw * 1000) / (v_in * factor * pf);

                return { 
                    kw_weld: p_weld_in_kw.toFixed(2),
                    kw_standby: p_standby_in_kw.toFixed(2),
                    amp_weld_in: i_weld_in.toFixed(1), 
                    time_arc_str: `${t_arc.toFixed(2)} hr`,
                    time_standby_str: `${t_standby.toFixed(2)} hr`,
                    e_weld: e_weld.toFixed(2),
                    e_standby: e_standby.toFixed(2),
                    e_total: e_total.toFixed(2),
                    cost_weld: cost_weld.toFixed(1),
                    cost_standby: cost_standby.toFixed(1),
                    cost_total: cost_total.toFixed(1)
                };
            }
        };

        /**
         * 2. Configuration Layer
         */
        const ToolsConfig = [
            // 1. Unit Conversion
            {
                id: 'unit_conv',
                name: '單位換算 / Unit Conversion',
                desc: '常用工程單位快速轉換 / Common Unit Converters',
                render: () => `
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${renderUnitCard('抗拉強度 / Tensile Strength', ['MPa', 'kgf/mm²', 'psi'], 'tensile')}
                            ${renderUnitCard('溫度 / Temperature', ['°C', '°F'], 'temp')}
                            ${renderUnitCard('衝擊功 / Impact Energy', ['J', 'kg-m', 'lbf.ft'], 'impact')}
                            ${renderUnitCard('氣體流量 / Gas Flow', ['L/min', 'cfh'], 'flow')}
                            ${renderUnitCard('送線速度 / Wire Feed Speed', ['m/min', 'inch/min'], 'wfs')}
                        </div>
                        <div class="formula-box">
                            <span class="formula-label">換算因子 / CONVERSION FACTORS</span>
                            <div class="math-expr mb-2"><span class="text-slate-400 mr-2 not-italic font-sans text-xs">壓力 / Pressure:</span> 1 MPa ≈ 0.102 kgf/mm² ≈ 145.04 psi</div>
                            <div class="math-expr mb-2"><span class="text-slate-400 mr-2 not-italic font-sans text-xs">溫度 / Temp:</span> °F = (°C × 1.8) + 32</div>
                            <div class="math-expr"><span class="text-slate-400 mr-2 not-italic font-sans text-xs">能量 / Energy:</span> 1 J ≈ 0.102 kg-m ≈ 0.738 lbf.ft</div>
                        </div>
                    </div>
                `,
                init: (container) => initUnitConverters(container)
            },
            // 2. Heat Input
            {
                id: 'heat_input',
                name: '入熱量計算 / Heat Input',
                desc: '依據電流、電壓、速度計算入熱量 / Calculate Heat Input',
                render: () => `
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            ${renderInputGroup('電流 / Current (A)', 'hi_current', 200)}
                            ${renderInputGroup('電壓 / Voltage (V)', 'hi_voltage', 25)}
                            <div class="bg-slate-50 p-4 rounded border border-slate-200">
                                <label class="block text-sm font-semibold text-slate-700 mb-2">熱效率 / Thermal Efficiency (η)</label>
                                <select id="hi_process" class="w-full bg-white border border-slate-300 rounded p-2 text-sm mb-2">
                                    <option value="0.9" selected>SAW (0.9)</option>
                                    <option value="0.8">FCAW (0.8)</option>
                                    <option value="0.8">GMAW (0.8)</option>
                                    <option value="0.75">SMAW (0.75)</option>
                                    <option value="0.6">GTAW (0.6)</option>
                                    <option value="custom">自定義 / Custom</option>
                                </select>
                                <input type="number" id="hi_efficiency" value="0.9" step="0.05" class="w-full p-2 border border-slate-300 rounded text-sm font-mono">
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-semibold text-slate-700">速度模式 / Speed Mode</label>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center"><input type="radio" name="hi_mode" value="speed" checked class="form-radio text-blue-600"> <span class="ml-2 text-sm">直接速度 / Speed</span></label>
                                    <label class="inline-flex items-center"><input type="radio" name="hi_mode" value="time" class="form-radio text-blue-600"> <span class="ml-2 text-sm">長度+時間 / Length+Time</span></label>
                                </div>
                            </div>
                            
                            <!-- Direct Speed -->
                            <div id="hi_group_speed" class="flex space-x-2">
                                <input type="number" id="hi_speed" class="flex-1 border border-slate-300 rounded p-2 font-mono" value="30">
                                <select id="hi_speed_unit" class="bg-slate-100 border border-slate-300 rounded px-2 text-sm"><option value="cm_min">cm/min</option><option value="mm_min">mm/min</option></select>
                            </div>

                            <!-- Length + Time -->
                            <div id="hi_group_time" class="hidden space-y-2">
                                <div class="flex space-x-2">
                                    <input type="number" id="hi_length" placeholder="長度 Length" class="flex-1 border border-slate-300 rounded p-2 font-mono">
                                    <select id="hi_length_unit" class="bg-slate-100 border border-slate-300 rounded px-2 text-sm">
                                        <option value="mm">mm</option>
                                        <option value="cm">cm</option>
                                        <option value="m">M</option>
                                    </select>
                                </div>
                                <div class="flex space-x-2 items-center">
                                    <input type="number" id="hi_time_min" placeholder="分 Min" class="flex-1 border border-slate-300 rounded p-2 font-mono">
                                    <span class="text-slate-400">:</span>
                                    <input type="number" id="hi_time_sec" placeholder="秒 Sec" class="flex-1 border border-slate-300 rounded p-2 font-mono">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col justify-center space-y-4">
                            <div class="p-6 bg-slate-900 text-white rounded-lg shadow-lg text-center">
                                <div class="text-xs text-slate-400 uppercase mb-1">Heat Input (kJ/mm)</div>
                                <div id="res_hi_kjmm" class="text-5xl font-mono font-bold text-green-400">0.000</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${renderResultBox('kJ/cm', 'res_hi_kjcm')}
                                ${renderResultBox('Speed (cm/min)', 'res_hi_speed')}
                            </div>
                        </div>
                        
                        <div class="col-span-1 lg:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA (ASME IX)</span>
                            <div class="math-expr">
                                H.I. = 
                                <div class="math-frac">
                                    <div class="math-num">A × V × 60 × η</div>
                                    <div class="math-denom">Speed (mm/min) × 1000</div>
                                </div>
                                <span>(kJ/mm)</span>
                            </div>
                            <div class="math-desc">
                                A: 電流 / Current, V: 電壓 / Voltage, η: 熱效率 / Efficiency
                            </div>
                        </div>
                    </div>
                `,
                init: (c) => initHeatInput(c)
            },
            // 3. Carbon Equivalent
            {
                id: 'ce_calc',
                name: '碳當量計算 / Carbon Equivalent',
                desc: 'AWS / JIS / Pcm / Yurioka',
                render: () => `
                    <div class="p-6">
                        <div class="mb-6 bg-blue-50 p-4 rounded-md border border-blue-100">
                            <label class="text-xs font-bold text-blue-800 uppercase mb-2 block">快速載入材質 / Load Material Preset</label>
                            <select id="ce_preset" class="w-full p-2 border border-blue-200 rounded text-sm bg-white focus:outline-none focus:border-blue-500">
                                <option value="">-- 請選擇 / Select Steel --</option>
                                <optgroup label="一般結構鋼 / Structural Steel">
                                    <option value="ss400">SS400 (General Structure)</option>
                                    <option value="sm490a">SM490A (Welded Structure)</option>
                                    <option value="sm570">SM570 (High Strength)</option>
                                    <option value="sn490b">SN490B (Building Structure)</option>
                                    <option value="a36">ASTM A36</option>
                                    <option value="a572_50">ASTM A572 Gr.50</option>
                                </optgroup>
                                <optgroup label="鋼筋 / Rebar">
                                    <option value="sd280">SD 280 (Low Carbon)</option>
                                    <option value="sd420">SD 420 (Standard)</option>
                                    <option value="sd490">SD 490 (High Strength)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 mb-8">
                            ${['C','Si','Mn','P','S','Ni','Cr','Mo','V','Cu','Nb','B','Ti'].map(el => `<div><label class="text-xs font-bold text-slate-500 block mb-1">${el}</label><input type="number" step="0.01" data-elem="${el}" class="ce-input w-full p-2 border rounded text-sm font-mono" placeholder="0"></div>`).join('')}
                            <div class="col-span-2 md:col-span-1"><label class="text-xs font-bold text-slate-500 block mb-1">H (ml/100g)</label><input type="number" data-elem="H" class="ce-input w-full p-2 border rounded" value="5"></div>
                            <div class="col-span-2 md:col-span-1"><label class="text-xs font-bold text-slate-500 block mb-1">板厚 t / Thickness (mm)</label><input type="number" data-elem="t" class="ce-input w-full p-2 border rounded" value="25"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${renderResultCard('AWS (IACS)', 'res_ce_aws', '<span id="res_ce_aws_msg">--</span>')}
                            ${renderResultCard('JIS (Ceq)', 'res_ce_jis', '結構鋼通用 / General')}
                            ${renderResultCard('Pcm', 'res_ce_pcm', '低碳鋼冷裂 / Cold Cracking')}
                            ${renderResultCard('Pw (Yurioka)', 'res_ce_pw', '<span id="res_ce_pw_msg">--</span>')}
                        </div>
                        
                        <div class="formula-box">
                            <span class="formula-label">計算公式 / FORMULAS</span>
                            <div class="math-expr mb-2">
                                CE<sub>AWS</sub> = C + <div class="math-frac"><div class="math-num">Mn</div><div class="math-denom">6</div></div> + 
                                <div class="math-frac"><div class="math-num">Cr+Mo+V</div><div class="math-denom">5</div></div> + 
                                <div class="math-frac"><div class="math-num">Ni+Cu</div><div class="math-denom">15</div></div>
                            </div>
                            <div class="math-expr">
                                P<sub>cm</sub> = C + <div class="math-frac"><div class="math-num">Si</div><div class="math-denom">30</div></div> + 
                                <div class="math-frac"><div class="math-num">Mn+Cu+Cr</div><div class="math-denom">20</div></div> + 
                                <div class="math-frac"><div class="math-num">Ni</div><div class="math-denom">60</div></div> + 
                                <div class="math-frac"><div class="math-num">Mo</div><div class="math-denom">15</div></div> + 
                                <div class="math-frac"><div class="math-num">V</div><div class="math-denom">10</div></div> + 5B
                            </div>
                            <div class="math-desc">H: 擴散氫含量 / Hydrogen (ml/100g), t: 板厚 / Thickness (mm)</div>
                        </div>
                    </div>
                `,
                init: (c) => initCE(c)
            },
            // 4. Ferrite Number
            {
                id: 'fn_calc',
                name: '肥粒鐵 & Tmd30 / Ferrite No.',
                desc: '不銹鋼化學成分分析 / Stainless Steel Analysis',
                render: () => `
                    <div class="p-6">
                         <div class="mb-6 bg-blue-50 p-4 rounded-md border border-blue-100">
                            <label class="text-xs font-bold text-blue-800 uppercase mb-2 block">快速載入不銹鋼 / Load Stainless Preset</label>
                            <select id="fn_preset" class="w-full p-2 border border-blue-200 rounded text-sm bg-white focus:outline-none focus:border-blue-500">
                                <option value="">-- 請選擇 / Select Grade --</option>
                                <optgroup label="奧氏體 / Austenitic">
                                    <option value="304l">304L (18Cr-8Ni)</option>
                                    <option value="316l">316L (18Cr-12Ni-2Mo)</option>
                                    <option value="309s">309S (23Cr-13Ni)</option>
                                </optgroup>
                                <optgroup label="雙相鋼 / Duplex">
                                    <option value="2205">2205 (S31803 Standard Duplex)</option>
                                    <option value="2507">2507 (S32750 Super Duplex)</option>
                                </optgroup>
                            </select>
                        </div>
                         <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 mb-8">
                             ${['C','Si','Mn','Cr','Ni','Mo','Nb','N','Cu','Ti'].map(el => `<div><label class="text-xs font-bold text-slate-500 block mb-1">${el}</label><input type="number" step="0.01" data-elem="${el}" class="fn-input w-full p-2 border rounded text-sm font-mono" placeholder="0"></div>`).join('')}
                             <div class="col-span-2 md:col-span-1"><label class="text-xs font-bold text-slate-500 block mb-1">晶粒度 / Grain Size (GS)</label><input type="number" data-elem="GS" class="fn-input w-full p-2 border rounded" value="8.0"></div>
                         </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <div class="bg-slate-50 p-4 rounded border">
                                 <div class="text-sm font-bold text-slate-600">鉻當量 (Cr_eq)</div><div id="res_fn_creq" class="text-2xl font-mono font-bold text-blue-600">0.00</div>
                                 <div class="text-sm font-bold text-slate-600 mt-2">鎳當量 (Ni_eq)</div><div id="res_fn_nieq" class="text-2xl font-mono font-bold text-blue-600">0.00</div>
                             </div>
                             <div class="bg-slate-900 text-white p-4 rounded shadow flex flex-col justify-center items-center">
                                 <div class="text-sm opacity-75">肥粒鐵數 (FN)</div>
                                 <div id="res_fn_val" class="text-5xl font-mono font-bold text-green-400 mt-2">0.00</div>
                             </div>
                             <div class="bg-purple-50 p-4 rounded border border-purple-100 flex flex-col justify-center items-center">
                                 <div class="text-sm font-bold text-purple-800">Tmd 30 (°C)</div>
                                 <div id="res_fn_tmd" class="text-4xl font-mono font-bold text-purple-600 mt-2">0.0</div>
                             </div>
                         </div>
                         
                         <div class="formula-box">
                            <span class="formula-label">計算公式 / FORMULAS</span>
                            <div class="math-expr mb-2">Cr<sub>eq</sub> (鉻當量) = Cr + 1.5Si + Mo + 2Ti + 0.5Nb</div>
                            <div class="math-expr mb-2">Ni<sub>eq</sub> (鎳當量) = Ni + 0.5Mn + 30N + 30C + 0.5Cu</div>
                            <div class="math-expr">Tmd30 = 551 - 462(C+N) - 9.2Si - 8.1Mn ...</div>
                        </div>
                    </div>
                `,
                init: (c) => initFerrite(c)
            },
            // 5. Steel Plate
            {
                id: 'plate_calc',
                name: '鋼板重 / Plate Weight',
                desc: '長 x 寬 x 厚 x 密度 / L x W x T x Density',
                render: () => `
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                             <!-- Length -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">長度 / Length</label>
                                <div class="flex">
                                    <input type="number" id="sp_l" class="flex-1 p-2 border border-slate-300 rounded-l font-mono">
                                    <select id="sp_l_unit" class="bg-slate-100 border border-slate-300 border-l-0 rounded-r px-2 text-sm text-slate-600">
                                        <option value="m">M</option>
                                        <option value="cm">cm</option>
                                        <option value="mm">mm</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Width -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">寬度 / Width</label>
                                <div class="flex">
                                    <input type="number" id="sp_w" class="flex-1 p-2 border border-slate-300 rounded-l font-mono">
                                    <select id="sp_w_unit" class="bg-slate-100 border border-slate-300 border-l-0 rounded-r px-2 text-sm text-slate-600">
                                        <option value="m">M</option>
                                        <option value="cm">cm</option>
                                        <option value="mm">mm</option>
                                    </select>
                                </div>
                            </div>
                            
                            ${renderInputGroup('厚度 / Thickness (mm)', 'sp_t')}
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">材質密度 / Density</label>
                                <select id="sp_d_sel" class="w-full bg-slate-50 border border-slate-300 rounded p-2 text-sm mb-2">
                                    <option value="7.85">碳鋼 / Carbon Steel (7.85)</option>
                                    <option value="7.93">不銹鋼 / SS 304 (7.93)</option>
                                    <option value="7.98">不銹鋼 / SS 316 (7.98)</option>
                                    <option value="2.7">鋁 / Aluminum (2.7)</option>
                                    <option value="custom">自定義 / Custom</option>
                                </select>
                                <input type="number" id="sp_d" value="7.85" class="w-full p-2 border border-slate-300 rounded font-mono">
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-slate-500 mb-2">預估重量 / Weight</div>
                            <div id="res_sp_w" class="text-6xl font-mono font-bold text-blue-600">0.00</div>
                            <div class="text-xl text-slate-400 mt-2">KG</div>
                        </div>
                        
                        <div class="col-span-1 md:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA</span>
                            <div class="math-expr">重量 W = 長 L(m) × 寬 W(m) × 厚 t(mm) × 密度 ρ</div>
                        </div>
                    </div>
                `,
                init: (c) => initPlate(c)
            },
            // 6. PREN
            {
                id: 'pren_calc',
                name: '孔蝕指數 / PREN',
                desc: 'Cr + 3.3Mo + 16N',
                render: () => `
                    <div class="p-6 flex flex-col items-center">
                        <div class="w-full max-w-md space-y-4 mb-8">
                             <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                                <label class="text-xs font-bold text-blue-800 uppercase mb-2 block">快速載入 / Quick Load</label>
                                <select id="pren_preset" class="w-full p-2 border border-blue-200 rounded text-sm bg-white focus:outline-none">
                                    <option value="">-- 請選擇 / Select Grade --</option>
                                    <option value="2205">2205 (S31803)</option>
                                    <option value="2507">2507 (S32750 Super Duplex)</option>
                                    <option value="s32101">S32101 (Lean Duplex)</option>
                                    <option value="s32304">S32304 (Lean Duplex)</option>
                                    <option value="316">316 Austenitic</option>
                                </select>
                             </div>
                             ${renderInputGroup('Cr (%)', 'pren_cr')}
                             ${renderInputGroup('Mo (%)', 'pren_mo')}
                             ${renderInputGroup('N (%)', 'pren_n')}
                        </div>
                        <div class="p-8 bg-slate-50 rounded-xl border border-slate-200 text-center w-full max-w-md">
                             <div class="text-sm text-slate-500 uppercase tracking-widest mb-2">PREN Value</div>
                             <div id="res_pren" class="text-6xl font-mono font-bold text-slate-800">0.00</div>
                             <div id="res_pren_note" class="text-sm font-medium mt-4 text-blue-600 min-h-[1.25rem]"></div>
                        </div>
                        
                        <div class="w-full formula-box mt-8">
                            <span class="formula-label">計算公式 / FORMULA</span>
                            <div class="math-expr">PREN (孔蝕指數) = %Cr + 3.3 × %Mo + 16 × %N</div>
                        </div>
                    </div>
                `,
                init: (c) => initPREN(c)
            },
            // 7. Sensitization
            {
                id: 'sen_calc',
                name: '銳敏化計算 / Sensitization',
                desc: '(Nb+Ti) / (C+N) >= 8',
                render: () => `
                     <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                                <label class="text-xs font-bold text-blue-800 uppercase mb-2 block">快速載入 / Quick Load</label>
                                <select id="sen_preset" class="w-full p-2 border border-blue-200 rounded text-sm bg-white focus:outline-none">
                                    <option value="">-- 請選擇 / Select Grade --</option>
                                    <option value="409">409 (Ti Stabilized)</option>
                                    <option value="439">439 (Ti Stabilized)</option>
                                    <option value="441">441 (Ti+Nb Stabilized)</option>
                                    <option value="430">430 (Unstabilized)</option>
                                </select>
                             </div>
                            ${renderInputGroup('Nb (%)', 'sen_nb')}
                            ${renderInputGroup('Ti (%)', 'sen_ti')}
                            ${renderInputGroup('C (%)', 'sen_c')}
                            ${renderInputGroup('N (%)', 'sen_n')}
                        </div>
                        <div class="text-center">
                            <div id="res_sen" class="text-5xl font-mono font-bold text-slate-800">0.00</div>
                            <div id="res_sen_msg" class="text-lg font-bold mt-4"></div>
                        </div>
                        
                        <div class="col-span-1 md:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA</span>
                            <div class="math-expr">
                                穩定化元素比率 Ratio = 
                                <div class="math-frac">
                                    <div class="math-num">Nb + Ti</div>
                                    <div class="math-denom">C + N</div>
                                </div>
                                <span>≥ 8 (合格 / Pass)</span>
                            </div>
                        </div>
                     </div>
                `,
                init: (c) => initSen(c)
            },
            // 8. Current Density
            {
                id: 'cd_calc',
                name: '電流密度 / Current Density',
                desc: 'A / mm²',
                render: () => `
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div class="space-y-4">
                            ${renderInputGroup('線徑 / Wire Dia (mm)', 'cd_dia')}
                            ${renderInputGroup('電流 / Current (A)', 'cd_cur')}
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-slate-500">Current Density</div>
                            <div id="res_cd" class="text-5xl font-mono font-bold text-blue-600 mt-2">0.00</div>
                            <div class="text-slate-400">A/mm²</div>
                        </div>
                        
                        <div class="col-span-1 md:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA</span>
                            <div class="math-expr">
                                電流密度 J = 
                                <div class="math-frac">
                                    <div class="math-num">Current (電流)</div>
                                    <div class="math-denom">Area (面積)</div>
                                </div>
                                = 
                                <div class="math-frac">
                                    <div class="math-num">I</div>
                                    <div class="math-denom">π × (D/2)<sup>2</sup></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                init: (c) => initCD(c)
            },
            // 9. Fillet Weld (Updated)
            {
                id: 'fw_calc',
                name: '角銲計算 / Fillet Weld',
                desc: '計算角銲所需銲材 / Calculate Consumables',
                render: () => `
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                             <!-- SVG Diagram -->
                            <div class="flex justify-center mb-4 p-4 bg-white border rounded">
                                <svg width="200" height="120" viewBox="0 0 200 120">
                                    <line x1="20" y1="100" x2="180" y2="100" stroke="#333" stroke-width="2"/>
                                    <line x1="20" y1="100" x2="20" y2="20" stroke="#333" stroke-width="2"/>
                                    <path d="M22 98 L100 98 L22 20 Z" fill="#cbd5e1" stroke="#475569"/>
                                    <path d="M22 20 Q 70 50 100 98" fill="none" stroke="#2563eb" stroke-dasharray="4"/>
                                    <text x="50" y="115" font-size="10" fill="#666">L2 (Leg)</text>
                                    <text x="5" y="60" font-size="10" fill="#666" transform="rotate(-90 5,60)">L1 (Leg)</text>
                                </svg>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInputGroup('腳長 / Leg L1 (mm)', 'fw_l1')}
                                ${renderInputGroup('腳長 / Leg L2 (mm)', 'fw_l2')}
                            </div>
                            ${renderInputGroup('總長度 / Total Length (M)', 'fw_len')}
                            
                            <!-- Density Select -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">密度 / Density</label>
                                    <select id="fw_den_sel" class="w-full p-2 border border-slate-300 rounded text-sm mb-1 bg-white">
                                        <option value="7.85" selected>碳鋼 (7.85)</option>
                                        <option value="7.93">SS 304 (7.93)</option>
                                        <option value="7.98">SS 316 (7.98)</option>
                                        <option value="2.7">鋁 (2.7)</option>
                                        <option value="custom">自定義</option>
                                    </select>
                                    <input type="number" id="fw_den" value="7.85" step="0.01" class="w-full p-2 border border-slate-300 rounded font-mono text-sm text-slate-700">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">熔填效率 / Eff (%)</label>
                                    <select id="fw_eff_sel" class="w-full p-2 border border-slate-300 rounded text-sm mb-1 bg-white">
                                        <option value="90">SAW (90%)</option>
                                        <option value="80" selected>FCAW/GMAW (80%)</option>
                                        <option value="75">SMAW (75%)</option>
                                        <option value="60">GTAW (60%)</option>
                                        <option value="custom">自定義</option>
                                    </select>
                                    <input type="number" id="fw_eff" value="80" class="w-full p-2 border border-slate-300 rounded font-mono text-sm text-slate-700">
                                </div>
                            </div>

                            ${renderInputGroup('冠高餘裕 / Reinf (%)', 'fw_reinf', 20)}
                        </div>
                         <div class="flex flex-col justify-center items-center bg-slate-50 rounded-lg p-6">
                            <div class="text-sm text-slate-500 mb-2">所需銲材重量 / Weight</div>
                            <div id="res_fw" class="text-5xl font-mono font-bold text-blue-600">0.00</div>
                            <div class="text-xl text-slate-400 mt-2">KG</div>
                        </div>
                        
                        <div class="col-span-1 lg:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA</span>
                            <div class="math-expr">
                                總重量 W = 
                                <div class="math-frac">
                                    <div class="math-num">Area × Length × ρ × (1+R)</div>
                                    <div class="math-denom">Efficiency</div>
                                </div>
                            </div>
                            <div class="math-expr mt-2">
                                斷面積 Area = <div class="math-frac"><div class="math-num">L<sub>1</sub> × L<sub>2</sub></div><div class="math-denom">2</div></div>
                            </div>
                            <div class="math-desc">ρ: 密度, R: 冠高餘裕, Efficiency: 熔填效率</div>
                        </div>
                    </div>
                `,
                init: (c) => initFW(c)
            },
            // 10. Butt Weld (Updated)
            {
                id: 'bw_calc',
                name: '對接銲 / Butt Weld',
                desc: '計算對接銲所需銲材 / Calculate Consumables',
                render: () => `
                     <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <!-- SVG Diagram -->
                            <div class="flex justify-center mb-4 p-4 bg-white border rounded">
                                <svg width="200" height="100" viewBox="0 0 200 100">
                                    <rect x="10" y="40" width="80" height="40" fill="none" stroke="#333" stroke-width="2"/>
                                    <rect x="110" y="40" width="80" height="40" fill="none" stroke="#333" stroke-width="2"/>
                                    <path d="M90 80 L90 70 L80 40 M110 80 L110 70 L120 40" stroke="#333" stroke-width="1" fill="none" stroke-dasharray="2"/>
                                    <path d="M90 80 L110 80 L125 35 L75 35 Z" fill="#cbd5e1" opacity="0.5"/>
                                    <text x="100" y="95" font-size="10" text-anchor="middle" fill="#666">Gap</text>
                                    <text x="50" y="30" font-size="10" text-anchor="middle" fill="#666">Angle θ</text>
                                    <text x="5" y="60" font-size="10" fill="#666" transform="rotate(-90 5,60)">Thick t</text>
                                </svg>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInputGroup('板厚 / Thickness (mm)', 'bw_t')}
                                ${renderInputGroup('開槽角度 / Angle (°)', 'bw_ang', 45)}
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${renderInputGroup('根間 / Root Gap (mm)', 'bw_gap', 2)}
                                ${renderInputGroup('長度 / Length (M)', 'bw_len')}
                            </div>
                             
                            <!-- Density Select -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">密度 / Density</label>
                                    <select id="bw_den_sel" class="w-full p-2 border border-slate-300 rounded text-sm mb-1 bg-white">
                                        <option value="7.85" selected>碳鋼 (7.85)</option>
                                        <option value="7.93">SS 304 (7.93)</option>
                                        <option value="7.98">SS 316 (7.98)</option>
                                        <option value="2.7">鋁 (2.7)</option>
                                        <option value="custom">自定義</option>
                                    </select>
                                    <input type="number" id="bw_den" value="7.85" step="0.01" class="w-full p-2 border border-slate-300 rounded font-mono text-sm text-slate-700">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">熔填效率 / Eff (%)</label>
                                    <select id="bw_eff_sel" class="w-full p-2 border border-slate-300 rounded text-sm mb-1 bg-white">
                                        <option value="90">SAW (90%)</option>
                                        <option value="80" selected>FCAW/GMAW (80%)</option>
                                        <option value="75">SMAW (75%)</option>
                                        <option value="60">GTAW (60%)</option>
                                        <option value="custom">自定義</option>
                                    </select>
                                    <input type="number" id="bw_eff" value="80" class="w-full p-2 border border-slate-300 rounded font-mono text-sm text-slate-700">
                                </div>
                            </div>
                            
                            ${renderInputGroup('冠高餘裕 / Reinf (%)', 'bw_reinf', 20)}
                        </div>
                         <div class="flex flex-col justify-center items-center bg-slate-50 rounded-lg p-6">
                            <div class="text-sm text-slate-500 mb-2">所需銲材重量 / Weight</div>
                            <div id="res_bw" class="text-5xl font-mono font-bold text-blue-600">0.00</div>
                            <div class="text-xl text-slate-400 mt-2">KG</div>
                        </div>
                        
                        <div class="col-span-1 lg:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA</span>
                            <div class="math-expr">
                                斷面積 Area = (t × gap) + (t<sup>2</sup> × tan(θ/2))
                            </div>
                            <div class="math-desc">t: 板厚, gap: 根間, θ: 開槽角度</div>
                        </div>
                    </div>
                `,
                init: (c) => initBW(c)
            },
            // 11. Gas Cylinder
            {
                id: 'gas_calc',
                name: '鋼瓶氣體 / Gas Cylinder',
                desc: '混和氣重量計算 (PV=nRT) / Gas Mixture Weight',
                render: () => `
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            ${renderInputGroup('鋼瓶容積 / Volume (L)', 'gc_vol', 40)}
                            ${renderInputGroup('壓力 / Pressure (kg/cm²)', 'gc_press', 150)}
                            
                            <div class="border-t pt-4">
                                <label class="block text-sm font-bold text-slate-700 mb-2">氣體組成 / Composition</label>
                                <div id="gc_list" class="space-y-2 mb-2">
                                    <!-- Dynamic rows -->
                                    <div class="flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200">
                                        <select class="gc-gas-type w-24 p-1 border rounded text-xs">
                                            <option value="custom">自訂</option>
                                            <option value="CO2" selected>CO2</option>
                                            <option value="Ar">Ar (Argon)</option>
                                            <option value="He">He (Helium)</option>
                                            <option value="O2">O2 (Oxygen)</option>
                                            <option value="N2">N2 (Nitrogen)</option>
                                            <option value="H2">H2 (Hydrogen)</option>
                                        </select>
                                        <input type="number" class="gc-mw w-16 p-1 border rounded text-sm text-center bg-gray-100" placeholder="MW" value="44.01" readonly>
                                        <input type="number" class="gc-pct flex-1 p-1 border rounded text-sm text-center" placeholder="%" value="100">
                                        <span class="text-xs text-slate-400">%</span>
                                    </div>
                                </div>
                                <button id="gc_add_btn" class="text-xs text-blue-600 font-bold hover:underline">+ 增加氣體 / Add Gas</button>
                            </div>
                        </div>
                         <div class="flex flex-col justify-center items-center bg-slate-50 rounded-lg p-6">
                            <div class="text-sm text-slate-500 mb-2">氣體總重 / Total Weight</div>
                            <div id="res_gc" class="text-5xl font-mono font-bold text-blue-600">0.00</div>
                            <div class="text-xl text-slate-400 mt-2">KG</div>
                            <div class="text-xs text-slate-400 mt-4 text-center">假設 25°C, 理想氣體 / Ideal Gas</div>
                        </div>
                        
                        <div class="col-span-1 lg:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA (IDEAL GAS)</span>
                            <div class="math-expr">
                                W = 
                                <div class="math-frac">
                                    <div class="math-num">P × V</div>
                                    <div class="math-denom">24.5</div>
                                </div>
                                × MW<sub>avg</sub>
                            </div>
                            <div class="math-desc">P: 壓力 (atm), V: 體積 (L), MW: 分子量 (24.5為常溫莫耳體積)</div>
                        </div>
                    </div>
                `,
                init: (c) => initGC(c)
            },
             // 12. Welder Power (Updated)
            {
                id: 'pwr_calc',
                name: '銲機耗電 / Power Consumption',
                desc: '輸入電流、功率因數與變頻機比較 / Input Current & Cost',
                render: () => `
                    <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <!-- Inputs -->
                         <div class="space-y-6">
                            <!-- Presets -->
                            <div class="bg-blue-50 p-3 rounded-md border border-blue-100">
                               <label class="text-xs font-bold text-blue-800 uppercase mb-2 block">快速設定 / Presets</label>
                               <select id="wp_preset" class="w-full p-2 border border-blue-200 rounded text-sm bg-white focus:outline-none focus:border-blue-500">
                                   <option value="">-- 請選擇 / Select Type --</option>
                                   <option value="traditional">傳統 SCR / Traditional</option>
                                   <option value="inverter">變頻 Inverter / Modern</option>
                               </select>
                               <div class="text-[10px] text-blue-600 mt-2">
                                 * 傳統: 高待機電流 (風扇常轉)<br>
                                 * 變頻: 低待機電流 (智慧風扇)
                               </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                               ${renderInputGroup('銲接電流 / Weld Current (A)', 'wp_i', 300)}
                               ${renderInputGroup('銲接電壓 / Weld Voltage (V)', 'wp_v', 34)}
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                               ${renderInputGroup('機台效率 / Efficiency (%)', 'wp_eff', 88)}
                               ${renderInputGroup('功率因數 / Power Factor', 'wp_pf', 0.95)}
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                               ${renderInputGroup('輸入電壓 / In Voltage (V)', 'wp_vin', 380)}
                               <div>
                                  <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">電源相數 / Phase</label>
                                  <select id="wp_phase" class="w-full p-2.5 border border-slate-300 rounded font-mono text-slate-700 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                     <option value="3">三相 (3-Phase)</option>
                                     <option value="1">單相 (1-Phase)</option>
                                  </select>
                               </div>
                            </div>
                            <!-- Standby Current -->
                            ${renderInputGroup('待機電流 / Standby Current (A)', 'wp_standby_i', 0.5)}
                            
                            <!-- Cost Params -->
                            <div class="pt-4 border-t border-slate-200 mt-2">
                                <label class="block text-xs font-bold text-blue-800 uppercase mb-3">成本估算 (Cost Estimation)</label>
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">電弧時間 (Hr)</label><input type="number" id="wp_arc_h" class="w-full p-2 border rounded text-sm font-mono" placeholder="0" value="1"></div>
                                    <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Min</label><input type="number" id="wp_arc_m" class="w-full p-2 border rounded text-sm font-mono" placeholder="0"></div>
                                    <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Sec</label><input type="number" id="wp_arc_s" class="w-full p-2 border rounded text-sm font-mono" placeholder="0"></div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">總工時 (Hr)</label><input type="number" id="wp_tot_h" class="w-full p-2 border rounded text-sm font-mono" placeholder="0" value="8"></div>
                                    <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Min</label><input type="number" id="wp_tot_m" class="w-full p-2 border rounded text-sm font-mono" placeholder="0"></div>
                                    <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Sec</label><input type="number" id="wp_tot_s" class="w-full p-2 border rounded text-sm font-mono" placeholder="0"></div>
                                </div>
                                ${renderInputGroup('電價 / Price ($/kWh)', 'wp_price', 4)}
                            </div>
                        </div>

                        <!-- Results -->
                        <div class="flex flex-col justify-center space-y-4">
                            <!-- Main Result: Input Current -->
                            <div class="p-6 bg-slate-800 text-white rounded-lg shadow-lg text-center relative overflow-hidden">
                                <div class="text-xs text-slate-400 uppercase mb-1 tracking-wider">銲接輸入電流 / Welding Input Current</div>
                                <div id="res_wp_amp" class="text-4xl md:text-5xl font-mono font-bold text-yellow-400">0.0</div>
                                <div class="text-sm text-slate-400 mt-1">Amps</div>
                            </div>
                            
                            <!-- Detailed Breakdown Table -->
                            <div class="bg-white border border-slate-200 rounded overflow-hidden text-sm">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200">
                                        <tr>
                                            <th class="p-3">項目 / Item</th>
                                            <th class="p-3 text-right">功率 (kW)</th>
                                            <th class="p-3 text-right">耗電 (kWh)</th>
                                            <th class="p-3 text-right">費用 ($)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <tr>
                                            <td class="p-3 font-medium text-blue-600">實際銲接<div class="text-[10px] text-slate-400 font-normal" id="res_time_arc">0h 0m</div></td>
                                            <td class="p-3 text-right font-mono" id="res_kw_weld">0.00</td>
                                            <td class="p-3 text-right font-mono" id="res_kwh_weld">0.00</td>
                                            <td class="p-3 text-right font-mono font-bold" id="res_cost_weld">0</td>
                                        </tr>
                                        <tr>
                                            <td class="p-3 font-medium text-slate-600">待機空轉<div class="text-[10px] text-slate-400 font-normal" id="res_time_sb">0h 0m</div></td>
                                            <td class="p-3 text-right font-mono text-slate-500" id="res_kw_sb">0.00</td>
                                            <td class="p-3 text-right font-mono text-slate-500" id="res_kwh_sb">0.00</td>
                                            <td class="p-3 text-right font-mono" id="res_cost_sb">0</td>
                                        </tr>
                                        <tr class="bg-blue-50">
                                            <td class="p-3 font-bold text-slate-800">總計 / Total</td>
                                            <td class="p-3 text-right font-mono text-slate-400">-</td>
                                            <td class="p-3 text-right font-mono font-bold text-blue-800" id="res_kwh_tot">0.00</td>
                                            <td class="p-3 text-right font-mono font-bold text-blue-800 text-lg" id="res_cost_tot">0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-span-1 lg:col-span-2 formula-box">
                            <span class="formula-label">計算公式 / FORMULA</span>
                            <div class="math-expr mb-2">
                                P<sub>standby</sub> = √3 × V<sub>in</sub> × I<sub>standby</sub> × PF
                            </div>
                            <div class="math-expr">
                                Cost = (P<sub>weld</sub> × T<sub>arc</sub>) + (P<sub>standby</sub> × (T<sub>total</sub> - T<sub>arc</sub>)) × Price
                            </div>
                        </div>
                    </div>
                `,
                init: (c) => initWP(c)
            }
        ];

        // --- UI Helpers & Init Logics (Minimally changed) ---
        function renderInputGroup(label, id, def = '') { return `<div><label class="block text-xs font-bold text-slate-500 mb-1 uppercase">${label}</label><input type="number" id="${id}" value="${def}" class="w-full p-2.5 border border-slate-300 rounded font-mono focus:ring-2 focus:ring-blue-500 focus:outline-none transition text-slate-700"></div>`; }
        function renderUnitCard(title, units, type) { return `<div class="bg-white border border-slate-200 rounded-lg p-4 shadow-sm"><h3 class="font-bold text-slate-800 mb-3 border-b pb-2 text-sm">${title}</h3>${units.map(u=>`<div class="flex items-center mb-2"><span class="w-28 flex-none text-xs text-slate-500 font-mono mr-2 whitespace-normal leading-tight">${u}</span><input type="number" data-type="${type}" data-unit="${u}" class="unit-input flex-1 p-2 border rounded text-sm font-mono"></div>`).join('')}</div>`; }
        function renderResultCard(label, id, sub) { return `<div class="bg-slate-50 p-4 rounded border"><div class="text-xs font-bold text-slate-500 uppercase">${label}</div><div id="${id}" class="text-3xl font-mono font-bold text-blue-600 my-1">0.00</div><div class="text-xs text-slate-400">${sub}</div></div>`; }
        function renderResultBox(label, id) { return `<div class="p-4 bg-white border border-slate-200 rounded text-center"><div class="text-xs text-slate-500">${label}</div><div id="${id}" class="text-2xl font-mono font-bold text-slate-800">0.00</div></div>` }

        function initUnitConverters(c) {
            const factors = { tensile: {'MPa':1,'kgf/mm²':9.80665,'psi':0.006895}, temp:'special', impact:{'J':1,'kg-m':9.807,'lbf.ft':1.356}, flow:{'L/min':1,'cfh':0.4719}, wfs:{'m/min':1,'inch/min':0.0254} };
            c.querySelectorAll('.unit-input').forEach(i => i.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value), type = e.target.dataset.type, unit = e.target.dataset.unit;
                if(isNaN(val)) return;
                c.querySelectorAll(`.unit-input[data-type="${type}"]`).forEach(sib => {
                    if(sib===e.target) return;
                    if(type==='temp'){ sib.value = unit==='°C' ? (val*1.8+32).toFixed(1) : ((val-32)/1.8).toFixed(1); }
                    else { sib.value = (val * factors[type][unit] / factors[type][sib.dataset.unit]).toFixed(3).replace(/\.?0+$/,''); }
                });
            }));
        }
        function initHeatInput(c) {
            const calc = () => {
                const g = (id) => parseFloat(document.getElementById(id)?.value) || 0;
                const mode = document.querySelector('input[name="hi_mode"]:checked').value;
                const r = EngineeringCore.calculateHeatInput({
                    current: g('hi_current'), voltage: g('hi_voltage'), efficiency: g('hi_efficiency'), 
                    speed: g('hi_speed'), speedUnit: document.getElementById('hi_speed_unit').value, 
                    mode: mode, 
                    length: g('hi_length'), lengthUnit: document.getElementById('hi_length_unit').value,
                    timeMin: g('hi_time_min'), timeSec: g('hi_time_sec')
                });
                document.getElementById('res_hi_kjcm').textContent = r.kj_cm; document.getElementById('res_hi_kjmm').textContent = r.kj_mm; document.getElementById('res_hi_speed').textContent = r.speed_cm_min;
            };
            c.querySelectorAll('input, select').forEach(e => e.addEventListener('input', calc));
            document.getElementById('hi_process').addEventListener('change', (e) => { if(e.target.value!=='custom') document.getElementById('hi_efficiency').value = e.target.value; calc(); });
            c.querySelectorAll('input[name="hi_mode"]').forEach(r => r.addEventListener('change', (e) => { document.getElementById('hi_group_speed').classList.toggle('hidden', e.target.value==='time'); document.getElementById('hi_group_time').classList.toggle('hidden', e.target.value!=='time'); calc(); }));
        }
        function initCE(c) {
            const presets = {'ss400':{C:0.17,Si:0.20,Mn:0.60,P:0.035,S:0.035},'sm490a':{C:0.16,Si:0.35,Mn:1.40,P:0.02,S:0.02},'a36':{C:0.26,Si:0.20,Mn:0.90,P:0.03,S:0.03},'sd420':{C:0.28,Si:0.40,Mn:1.20,P:0.04,S:0.04,V:0.05},'sm570':{C:0.18,Si:0.40,Mn:1.40,P:0.035,S:0.035}};
            const calc = () => { const el={}; c.querySelectorAll('.ce-input').forEach(i=>el[i.dataset.elem]=parseFloat(i.value)||0); const r=EngineeringCore.calculateCE(el); document.getElementById('res_ce_aws').textContent=r.aws; document.getElementById('res_ce_jis').textContent=r.jis; document.getElementById('res_ce_pcm').textContent=r.pcm; document.getElementById('res_ce_pw').textContent=r.pw; document.getElementById('res_ce_aws_msg').textContent=r.aws_note; document.getElementById('res_ce_aws_msg').className=`font-bold ${r.aws_class}`; document.getElementById('res_ce_pw_msg').textContent=r.pw_note; document.getElementById('res_ce_pw_msg').className=`font-bold ${r.pw_class}`; };
            document.getElementById('ce_preset').addEventListener('change', (e) => { const d=presets[e.target.value]; if(d){ c.querySelectorAll('.ce-input').forEach(i=>{if(i.dataset.elem!=='H'&&i.dataset.elem!=='t')i.value=''}); Object.keys(d).forEach(k=>{const inp=c.querySelector(`.ce-input[data-elem="${k}"]`);if(inp)inp.value=d[k]}); calc(); } });
            c.querySelectorAll('input').forEach(e => e.addEventListener('input', calc));
        }
        function initFerrite(c) {
            const presets = {'304l':{C:0.025,Si:0.5,Mn:1.4,Cr:18.2,Ni:8.1,Mo:0.1,N:0.06},'316l':{C:0.02,Si:0.5,Mn:1.4,Cr:16.8,Ni:10.2,Mo:2.1,N:0.05},'2205':{C:0.02,Si:0.4,Mn:1.5,Cr:22.5,Ni:5.5,Mo:3.1,N:0.17}};
            const calc = () => { const el={}; c.querySelectorAll('.fn-input').forEach(i=>el[i.dataset.elem]=parseFloat(i.value)||0); const r=EngineeringCore.calculateFerrite(el); document.getElementById('res_fn_creq').textContent=r.creq; document.getElementById('res_fn_nieq').textContent=r.nieq; document.getElementById('res_fn_val').textContent=r.fn; document.getElementById('res_fn_tmd').textContent=r.tmd30; };
            document.getElementById('fn_preset').addEventListener('change', (e) => { const d=presets[e.target.value]; if(d){ c.querySelectorAll('.fn-input').forEach(i=>{if(i.dataset.elem!=='GS')i.value=''}); Object.keys(d).forEach(k=>{const inp=c.querySelector(`.fn-input[data-elem="${k}"]`);if(inp)inp.value=d[k]}); calc(); } });
            c.querySelectorAll('input').forEach(e => e.addEventListener('input', calc));
        }
        function initPlate(c) {
            const calc = () => document.getElementById('res_sp_w').textContent = EngineeringCore.calculatePlateWeight(parseFloat(document.getElementById('sp_l').value)||0, document.getElementById('sp_l_unit').value, parseFloat(document.getElementById('sp_w').value)||0, document.getElementById('sp_w_unit').value, parseFloat(document.getElementById('sp_t').value)||0, parseFloat(document.getElementById('sp_d').value)||0);
            c.querySelectorAll('input, select').forEach(e => e.addEventListener('input', calc));
            document.getElementById('sp_d_sel').addEventListener('change', (e) => { if(e.target.value!=='custom') { document.getElementById('sp_d').value=e.target.value; calc(); } });
        }
        function initPREN(c) {
            const presets = {'2205':{Cr:22.5,Mo:3.2,N:0.18},'2507':{Cr:25.0,Mo:4.0,N:0.28},'316':{Cr:16.8,Mo:2.1,N:0.05}};
            const calc = () => { const val=EngineeringCore.calculatePREN(parseFloat(document.getElementById('pren_cr').value)||0, parseFloat(document.getElementById('pren_mo').value)||0, parseFloat(document.getElementById('pren_n').value)||0); document.getElementById('res_pren').textContent=val; document.getElementById('res_pren_note').textContent = val>40?'Super Duplex':(val>32?'Duplex':'Austenitic'); };
            document.getElementById('pren_preset').addEventListener('change', (e)=>{ const d=presets[e.target.value]; if(d){ if(d.Cr)document.getElementById('pren_cr').value=d.Cr; if(d.Mo)document.getElementById('pren_mo').value=d.Mo; if(d.N)document.getElementById('pren_n').value=d.N; calc(); } });
            c.querySelectorAll('input').forEach(e => e.addEventListener('input', calc));
        }
        function initSen(c) {
            const presets = {'409':{C:0.015,N:0.015,Ti:0.3,Nb:0},'439':{C:0.015,N:0.015,Ti:0.4,Nb:0}};
            const calc = () => { const r=EngineeringCore.calculateSensitization(parseFloat(document.getElementById('sen_nb').value)||0, parseFloat(document.getElementById('sen_ti').value)||0, parseFloat(document.getElementById('sen_c').value)||0, parseFloat(document.getElementById('sen_n').value)||0); document.getElementById('res_sen').textContent=r.val; const msg=document.getElementById('res_sen_msg'); msg.textContent=r.isSafe?"OK":"Fail"; msg.className=r.isSafe?"text-lg font-bold mt-4 text-green-600":"text-lg font-bold mt-4 text-red-600"; };
            document.getElementById('sen_preset').addEventListener('change', (e)=>{ const d=presets[e.target.value]; if(d){ c.querySelectorAll('input').forEach(i=>i.value=''); if(d.Nb!==undefined)document.getElementById('sen_nb').value=d.Nb; if(d.Ti!==undefined)document.getElementById('sen_ti').value=d.Ti; if(d.C!==undefined)document.getElementById('sen_c').value=d.C; if(d.N!==undefined)document.getElementById('sen_n').value=d.N; calc(); } });
            c.querySelectorAll('input').forEach(e => e.addEventListener('input', calc));
        }
        function initCD(c) { c.querySelectorAll('input').forEach(e => e.addEventListener('input', () => document.getElementById('res_cd').textContent = EngineeringCore.calculateCurrentDensity(parseFloat(document.getElementById('cd_dia').value)||0, parseFloat(document.getElementById('cd_cur').value)||0))); }
        function initFW(c) { 
            const calc = () => document.getElementById('res_fw').textContent = EngineeringCore.calculateFilletWeld(parseFloat(document.getElementById('fw_l1').value)||0, parseFloat(document.getElementById('fw_l2').value)||0, parseFloat(document.getElementById('fw_len').value)||0, parseFloat(document.getElementById('fw_den').value)||0, parseFloat(document.getElementById('fw_eff').value)||0, parseFloat(document.getElementById('fw_reinf').value)||0);
            c.querySelectorAll('input').forEach(e => e.addEventListener('input', calc)); 
            
            const denSel = document.getElementById('fw_den_sel');
            const denInp = document.getElementById('fw_den');
            denSel.addEventListener('change', () => { if(denSel.value !== 'custom') { denInp.value = denSel.value; calc(); } });
            denInp.addEventListener('input', () => denSel.value = 'custom');

            const effSel = document.getElementById('fw_eff_sel');
            const effInp = document.getElementById('fw_eff');
            effSel.addEventListener('change', () => { if(effSel.value !== 'custom') { effInp.value = effSel.value; calc(); } });
            effInp.addEventListener('input', () => effSel.value = 'custom');
        }
        function initBW(c) { 
            const calc = () => document.getElementById('res_bw').textContent = EngineeringCore.calculateButtWeld(parseFloat(document.getElementById('bw_t').value)||0, parseFloat(document.getElementById('bw_ang').value)||0, parseFloat(document.getElementById('bw_gap').value)||0, parseFloat(document.getElementById('bw_len').value)||0, parseFloat(document.getElementById('bw_den').value)||0, parseFloat(document.getElementById('bw_eff').value)||0, parseFloat(document.getElementById('bw_reinf').value)||0);
            c.querySelectorAll('input').forEach(e => e.addEventListener('input', calc)); 
            
            const denSel = document.getElementById('bw_den_sel');
            const denInp = document.getElementById('bw_den');
            denSel.addEventListener('change', () => { if(denSel.value !== 'custom') { denInp.value = denSel.value; calc(); } });
            denInp.addEventListener('input', () => denSel.value = 'custom');

            const effSel = document.getElementById('bw_eff_sel');
            const effInp = document.getElementById('bw_eff');
            effSel.addEventListener('change', () => { if(effSel.value !== 'custom') { effInp.value = effSel.value; calc(); } });
            effInp.addEventListener('input', () => effSel.value = 'custom');
        }
        function initGC(c) {
            const gases = { 'Ar':39.95, 'CO2':44.01, 'He':4.00, 'H2':2.02, 'O2':32.00, 'N2':28.01 };
            const update = () => {
                let wMw=0, totalPct=0; c.querySelectorAll('.gc-mw').forEach((row,i)=>{ const pct=parseFloat(c.querySelectorAll('.gc-pct')[i].value)||0; if(pct>0){ wMw += (parseFloat(row.value)||0)*pct; totalPct+=pct; } });
                document.getElementById('res_gc').textContent = EngineeringCore.calculateGasWeight(parseFloat(document.getElementById('gc_vol').value)||0, parseFloat(document.getElementById('gc_press').value)||0, totalPct>0?wMw/totalPct:0);
            };
            c.querySelectorAll('input').forEach(i => i.addEventListener('input', update));
            
            document.getElementById('gc_add_btn').addEventListener('click', () => { 
                const div=document.createElement('div'); div.className='flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200 relative'; 
                div.innerHTML=`
                    <select class="gc-gas-type w-24 p-1 border rounded text-xs">
                        <option value="custom">自訂</option>${Object.keys(gases).map(g=>`<option value="${g}">${g}</option>`).join('')}
                    </select>
                    <input type="number" class="gc-mw w-16 p-1 border rounded text-sm text-center bg-gray-100" placeholder="MW" value="44.01" readonly>
                    <input type="number" class="gc-pct flex-1 p-1 border rounded text-sm text-center" placeholder="%" value="100">
                    <span class="text-xs text-slate-400">%</span>
                    <button class="remove-gas text-red-500 hover:text-red-700 font-bold ml-2">x</button>`; 
                document.getElementById('gc_list').appendChild(div); 
                
                // Bind events for new row
                const sel = div.querySelector('.gc-gas-type');
                const mwInput = div.querySelector('.gc-mw');
                sel.addEventListener('change', (e) => {
                    if(e.target.value !== 'custom') { mwInput.value = gases[e.target.value]; }
                    update();
                });
                div.querySelectorAll('input').forEach(i=>i.addEventListener('input', update)); 
                div.querySelector('.remove-gas').addEventListener('click', ()=>{div.remove(); update();});
                update();
            });
        }
        function initWP(c) {
            const calc = () => {
                const g = (id) => parseFloat(document.getElementById(id)?.value) || 0;
                const res = EngineeringCore.calculatePower({
                    i_out: g('wp_i'), v_out: g('wp_v'), eff: g('wp_eff'), pf: g('wp_pf'), v_in: g('wp_vin'), phase: parseFloat(document.getElementById('wp_phase').value),
                    standby_current: g('wp_standby_i'), price: g('wp_price'),
                    arc_h: g('wp_arc_h'), arc_m: g('wp_arc_m'), arc_s: g('wp_arc_s'),
                    total_h: g('wp_tot_h'), total_m: g('wp_tot_m'), total_s: g('wp_tot_s')
                });
                document.getElementById('res_wp_amp').textContent = res.amp_weld_in;
                document.getElementById('res_kw_weld').textContent = res.kw_weld; document.getElementById('res_kw_sb').textContent = res.kw_standby;
                document.getElementById('res_time_arc').textContent = res.time_arc_str; document.getElementById('res_time_sb').textContent = res.time_standby_str;
                document.getElementById('res_kwh_weld').textContent = res.e_weld; document.getElementById('res_kwh_sb').textContent = res.e_standby; document.getElementById('res_kwh_tot').textContent = res.e_total;
                document.getElementById('res_cost_weld').textContent = res.cost_weld; document.getElementById('res_cost_sb').textContent = res.cost_standby; document.getElementById('res_cost_tot').textContent = res.cost_total;
            };
            c.querySelectorAll('input, select').forEach(e => e.addEventListener('input', calc));
            
            // Replaced buttons with Select change listener
            document.getElementById('wp_preset').addEventListener('change', (e) => {
                const val = e.target.value;
                if (val === 'traditional') {
                    document.getElementById('wp_eff').value = 80;
                    document.getElementById('wp_pf').value = 0.72;
                    document.getElementById('wp_standby_i').value = 3.0;
                } else if (val === 'inverter') {
                    document.getElementById('wp_eff').value = 88;
                    document.getElementById('wp_pf').value = 0.95;
                    document.getElementById('wp_standby_i').value = 0.5;
                }
                calc();
            });
        }

        /**
         * 3. Application Shell (Modified for Dropdown Nav)
         */
        class App {
            constructor() {
                this.navContainer = document.getElementById('nav-container');
                this.contentArea = document.getElementById('calculator-wrapper');
                this.mobileMenuBtn = document.getElementById('mobile-menu-btn');
                this.sidebar = document.getElementById('sidebar');
                this.overlay = document.getElementById('overlay');
                
                this.initNavigation();
                this.bindMobileEvents();
                this.loadTool(ToolsConfig[0].id);
            }

            initNavigation() {
                // Generate Select Element
                const select = document.createElement('select');
                select.className = 'w-full p-2.5 bg-slate-700 text-white border border-slate-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none font-sans text-sm cursor-pointer hover:bg-slate-600 transition-colors';
                
                ToolsConfig.forEach(tool => {
                    const option = document.createElement('option');
                    option.value = tool.id;
                    option.textContent = tool.name;
                    select.appendChild(option);
                });

                select.addEventListener('change', (e) => {
                    this.loadTool(e.target.value);
                    if (window.innerWidth < 1024) this.toggleSidebar(false);
                });

                this.navContainer.appendChild(select);
                this.toolSelect = select;
            }

            loadTool(id) {
                const tool = ToolsConfig.find(t => t.id === id);
                if (!tool) return;

                // Sync Dropdown
                if(this.toolSelect) this.toolSelect.value = id;

                // Update Header
                document.getElementById('page-title').textContent = tool.name;
                document.getElementById('page-desc').textContent = tool.desc;

                // Render Content
                this.contentArea.innerHTML = tool.render();
                
                // Init Logic
                if (tool.init) tool.init(this.contentArea);
            }

            bindMobileEvents() {
                const toggle = () => this.toggleSidebar();
                this.mobileMenuBtn.addEventListener('click', toggle);
                this.overlay.addEventListener('click', toggle);
            }

            toggleSidebar(forceState) {
                const isClosed = this.sidebar.classList.contains('-translate-x-full');
                const shouldOpen = forceState !== undefined ? forceState : isClosed;
                
                if (shouldOpen) {
                    this.sidebar.classList.remove('-translate-x-full');
                    this.overlay.classList.remove('hidden');
                } else {
                    this.sidebar.classList.add('-translate-x-full');
                    this.overlay.classList.add('hidden');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => { window.app = new App(); });
    </script>
</body>
</html>