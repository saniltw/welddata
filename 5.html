<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å‚™é»æª¢è¡¨ (å®Œç¾å¾©åˆ»ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .status-btn.selected { transform: scale(1.05); box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39); }
        .status-btn.selected-normal { background-color: #22c55e; color: white; border-color: #22c55e; }
        .status-btn.selected-abnormal { background-color: #ef4444; color: white; border-color: #ef4444; }
        .status-btn.selected-na { background-color: #64748b; color: white; border-color: #64748b; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border: 1px solid #e5e7eb; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none; appearance: none;
        }
        .admin-tab-active { color: #4f46e5; border-color: #4f46e5; }
        .eq-tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .eq-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        .eq-tab-inactive:hover { color: #374151; border-color: #d1d5db; }
        .status-dot { height: 0.6rem; width: 0.6rem; border-radius: 50%; display: inline-block; margin-right: 0.3rem; }
        .status-dot.active { background-color: #22c55e; }
        .status-dot.repair { background-color: #eab308; }
        .status-dot.unused { background-color: #9ca3af; }
        
        /* æ¬Šé™æ§åˆ¶æ¨£å¼ */
        .role-guest .action-edit, 
        .role-guest .action-delete, 
        .role-guest .action-add,
        .role-guest .action-submit { display: none !important; }
        
        @media print {
            body > * { display: none !important; }
            #print-area { display: block !important; }
            #print-area * { visibility: visible; }
            @page { size: auto; margin: 10mm; }
            html, body { height: auto; background: white; overflow: visible; }
        }
        #print-area { display: none; position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 9999; padding: 20px; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-slate-600">ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <!-- ç™»å…¥ Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center p-4 z-[150] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">æ­¡è¿ä½¿ç”¨</h1>
                <p class="text-slate-500 mt-2">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†ä»¥é€²å…¥ç³»çµ±</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ä½¿ç”¨è€…</label>
                    <select id="login-user-select" class="form-select w-full p-3 border border-gray-300 rounded-xl text-lg bg-slate-50 focus:ring-2 focus:ring-indigo-500">
                        <option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>
                        <!-- ä½¿ç”¨è€…åˆ—è¡¨å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
                    </select>
                </div>
                
                <button onclick="window.app.handleLogin()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl text-lg hover:bg-indigo-700 shadow-lg transform transition hover:scale-[1.02]">
                    é€²å…¥ç³»çµ±
                </button>
            </div>
            
            <p class="text-center text-xs text-slate-400 mt-6">ç³»çµ±ç‰ˆæœ¬ v2.6 (Role-Based)</p>
        </div>
    </div>

    <div id="print-area"></div>

    <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 md:p-8 hidden">
        
        <div class="flex justify-between items-center mb-6">
            <div id="user-status" class="text-sm flex items-center">
                <div id="logged-in-view">
                    <span>Hi, <strong id="logged-in-name" class="text-indigo-600 font-semibold"></strong> 
                    <span id="role-badge" class="ml-2 px-2 py-0.5 rounded text-xs bg-gray-200 text-gray-700"></span></span>
                    <button onclick="window.app.logout()" class="ml-3 text-xs text-red-500 underline">ç™»å‡º</button>
                </div>
            </div>
            <button id="toggle-mode-btn" onclick="window.app.toggleManagementMode()" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 text-sm hidden">âš™ï¸ ç®¡ç†å¾Œå°</button>
        </div>

        <!-- ä½¿ç”¨è€…é»æª¢æ¨¡å¼ -->
        <div id="user-mode">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-slate-800">è¨­å‚™é»æª¢</h1>
                <p id="header-subtitle" class="text-slate-500 mt-2">ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæ QR Code æˆ–æ‰‹å‹•é¸æ“‡</p>
            </header>

            <div id="main-content" class="space-y-6">
                <div id="scan-section" class="card text-center p-8">
                    <button onclick="window.app.showScanner()" class="bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-indigo-700 transition-transform hover:scale-105 flex items-center justify-center mx-auto action-submit">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                        é–‹å•Ÿç¶²é æƒæå™¨
                    </button>
                    <p class="text-sm text-gray-500 mt-3 action-submit">ğŸ’¡ æç¤ºï¼šæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæè¨­å‚™ä¸Šçš„ QR Code</p>
                    <p class="text-red-500 font-bold hidden guest-warning mt-2">è¨ªå®¢åƒ…ä¾›æª¢è¦–ï¼Œç„¡æ³•åŸ·è¡Œé»æª¢æ“ä½œ</p>
                </div>

                <div id="manual-select-section" class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">æ‰‹å‹•é¸æ“‡è¨­å‚™</h2>
                    <div class="space-y-4">
                        <select id="manual-category-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm"><option value="">è¼‰å…¥ä¸­...</option></select>
                        <select id="manual-device-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm" disabled><option value="">è«‹å…ˆé¸æ“‡å¤§é¡...</option></select>
                        <div class="flex space-x-3 action-submit">
                            <button onclick="window.app.handleManualSelection()" id="manual-start-button" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>
                                ğŸ“‹ é–‹å§‹é»æª¢
                            </button>
                            <button onclick="window.app.handleManualMaintenance()" id="manual-maintenance-button" class="flex-1 bg-orange-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-orange-600 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>
                                ğŸ”§ è¨˜éŒ„ä¿é¤Š
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checklist-section" class="hidden space-y-6">
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4 border-b pb-3">è¨­å‚™è³‡è¨Š</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div><label class="text-slate-500">è¨­å‚™åç¨±</label><p id="device-name" class="font-bold text-slate-700 text-lg"></p></div>
                        <div><label class="text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><p id="device-asset-no" class="font-semibold text-slate-700"></p></div>
                        <div><label class="text-slate-500">é»æª¢äººå“¡</label><p id="user-name-display" class="font-semibold text-slate-700"></p></div>
                        <div><label class="text-slate-500">é»æª¢æ—¥æœŸ</label><p id="check-date" class="font-semibold text-slate-700"></p></div>
                    </div>
                </div>
                <div id="checklist-items-container" class="space-y-6"></div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">ç¸½çµå‚™è¨»</h2>
                    <textarea id="summary-notes" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="window.app.resetApp()" class="w-1/3 bg-slate-500 text-white font-bold py-3 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button onclick="window.app.submitChecklist(this)" class="w-2/3 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg action-submit">æäº¤</button>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†è€…æ¨¡å¼ -->
        <div id="admin-mode" class="hidden">
            <header class="mb-6"><h1 class="text-4xl font-bold text-slate-800">ç®¡ç†å¾Œå°</h1></header>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-4 overflow-x-auto text-sm font-medium">
                    <button onclick="window.app.switchAdminTab('equipment')" id="tab-equipment" class="px-1 py-3 border-b-2 admin-tab-active">è¨­å‚™ç®¡ç†</button>
                    <!-- è¨ªå®¢éš±è—ç¯„æœ¬èˆ‡äººå“¡ç®¡ç† -->
                    <button onclick="window.app.switchAdminTab('templates')" id="tab-templates" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600 action-delete">é»æª¢ç¯„æœ¬</button>
                    <button onclick="window.app.switchAdminTab('users')" id="tab-users" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600 action-delete">äººå“¡ç®¡ç†</button>
                    
                    <button onclick="window.app.switchAdminTab('checklistHistory')" id="tab-checklistHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">é»æª¢ç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('maintenanceHistory')" id="tab-maintenanceHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">ä¿é¤Šç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('reports')" id="tab-reports" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">å ±è¡¨è¼¸å‡º</button>
                </nav>
            </div>
            
            <!-- è¨­å‚™ç®¡ç† -->
            <div id="admin-tab-content-equipment">
                <div id="equipment-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">è¨­å‚™åˆ—è¡¨</h2>
                        <button onclick="window.app.showEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm action-add">æ–°å¢è¨­å‚™</button>
                    </div>
                    <!-- è¨­å‚™åˆ†é¡åˆ‡æ›å€ (å·²æ”¹ç‚ºä¸‹æ‹‰é¸å–®) -->
                    <div id="equipment-category-tabs" class="mb-6"></div>
                    <div id="equipment-list-container"></div>
                </div>
                
                <div id="equipment-editor-section" class="hidden card p-6">
                    <h2 id="editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯è¨­å‚™</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™ç·¨è™Ÿ (ID)</label><input type="text" id="edit-device-id" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™åç¨±</label><input type="text" id="edit-device-name" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™å€åˆ†</label><select id="edit-device-category-select" class="w-full p-2 border rounded mb-2"></select><input type="text" id="edit-device-category-new" class="w-full p-2 border rounded hidden" placeholder="è¼¸å…¥æ–°åˆ†é¡..."></div>
                            <div><label class="block text-xs font-medium text-slate-500">æ”¾ç½®åœ°é»</label><input type="text" id="edit-device-location" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><input type="text" id="edit-device-asset" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">ç¾æ³</label><select id="edit-device-status" class="w-full p-2 border rounded form-select"><option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option><option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option><option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option></select></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">é»æª¢é€±æœŸ (å¤©)</label><input type="number" id="edit-device-cycle" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">ä¸‹æ¬¡é»æª¢æ—¥</label><input type="date" id="edit-device-next-date" class="w-full p-2 border rounded"></div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-2">æˆæ¬Šäººå“¡</label>
                            <div id="user-assignment-container" class="w-full p-3 border rounded h-32 overflow-y-auto bg-slate-50 grid grid-cols-2 gap-2"></div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-2">è¨­å‚™åœ–ç‰‡</label>
                            <div class="flex items-center gap-4">
                                <img id="image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border">
                                <button type="button" onclick="document.getElementById('edit-device-image').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ğŸ“· æ‹ç…§ / ä¸Šå‚³</button>
                                <input type="file" id="edit-device-image" accept="image/*" class="hidden" onchange="window.app.handleImageUpload(this)">
                            </div>
                        </div>

                        <hr class="my-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700">é»æª¢é …ç›®è¨­å®š</h3>
                            <button onclick="window.app.showTemplateModal()" class="text-sm bg-teal-500 text-white px-3 py-1 rounded hover:bg-teal-600">ğŸ“‘ å¾ç¯„æœ¬è¼‰å…¥</button>
                        </div>
                        <div id="item-editor-container" class="space-y-4"></div>
                        <button onclick="window.app.addCategoryEditor(null, 'item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button>

                        <hr class="my-4">
                        <h3 class="font-bold text-slate-700">å¯æ›´æ›é›¶ä»¶ç®¡ç† (è€—æ)</h3>
                        <div id="component-editor-container" class="space-y-2"></div>
                        <button onclick="window.app.addComponentEditor()" class="w-full bg-gray-100 text-gray-700 py-2 rounded border border-gray-300 hover:bg-gray-200">ï¼‹ æ–°å¢é›¶ä»¶</button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveEquipment(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </div>

            <!-- å…¶ä»–ç®¡ç†é é¢ (ç¯„æœ¬, äººå“¡, å ±è¡¨, ç´€éŒ„) -->
            <div id="admin-tab-content-templates" class="hidden">
                <div id="template-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">é»æª¢ç¯„æœ¬ç®¡ç†</h2>
                        <button onclick="window.app.showTemplateEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm action-add">æ–°å¢ç¯„æœ¬</button>
                    </div>
                    <div id="template-list-container" class="space-y-3"></div>
                </div>
                <div id="template-editor-section" class="hidden card p-6">
                    <h2 id="template-editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯ç¯„æœ¬</h2>
                    <div class="space-y-4">
                        <input type="hidden" id="edit-template-id">
                        <div><label class="block text-xs font-medium text-slate-500">ç¯„æœ¬åç¨±</label><input type="text" id="edit-template-name" class="w-full p-2 border rounded" placeholder="ä¾‹å¦‚ï¼šå †é«˜æ©Ÿé€šç”¨æª¢æŸ¥è¡¨"></div>
                        <hr class="my-4">
                        <h3 class="font-bold text-slate-700">ç¯„æœ¬é …ç›®è¨­å®š</h3>
                        <div id="template-item-editor-container" class="space-y-4"></div>
                        <button onclick="window.app.addCategoryEditor(null, 'template-item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showTemplateList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveTemplate(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜ç¯„æœ¬</button>
                    </div>
                </div>
            </div>
            
            <div id="admin-tab-content-users" class="hidden">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">äººå“¡åˆ—è¡¨</h2><button onclick="window.app.showUserEditor()" class="bg-indigo-600 text-white px-4 py-2 rounded action-add">æ–°å¢</button></div>
                <div id="user-list-container" class="space-y-2"></div>
                <div id="user-editor-section" class="hidden card p-6">
                    <h2 id="user-editor-title" class="text-xl font-bold mb-4">ç·¨è¼¯äººå“¡</h2>
                    <div class="space-y-3">
                        <input type="text" id="edit-user-id" placeholder="ID" class="w-full p-2 border rounded">
                        <input type="text" id="edit-user-name" placeholder="å§“å" class="w-full p-2 border rounded">
                        <select id="edit-user-role" class="w-full p-2 border rounded">
                            <option value="operator">æ“ä½œå“¡</option>
                            <option value="manager">ç®¡ç†å“¡</option>
                        </select>
                        <input type="password" id="edit-user-password" placeholder="å¯†ç¢¼ (ç®¡ç†å“¡å¿…å¡«)" class="w-full p-2 border rounded hidden">
                    </div>
                    <div class="flex justify-end gap-2 mt-4"><button onclick="window.app.showUserList()" class="bg-gray-200 px-4 py-2 rounded">å–æ¶ˆ</button><button onclick="window.app.saveUser(this)" class="bg-indigo-600 text-white px-4 py-2 rounded">å„²å­˜</button></div>
                </div>
            </div>

             <div id="admin-tab-content-reports" class="hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-slate-800">å ±è¡¨è¼¸å‡ºä¸­å¿ƒ</h2>
                 <div class="card p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="block text-xs font-medium text-slate-500 mb-1">å ±è¡¨é¡å‹</label><select id="report-type" class="w-full p-2 border rounded bg-white"><option value="checklist">è¨­å‚™é»æª¢ç´€éŒ„è¡¨</option><option value="maintenance">ä¿é¤Šç¶­ä¿®ç´€éŒ„è¡¨</option></select></div>
                        <div><label class="block text-xs font-medium text-slate-500 mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date" id="report-start-date" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-xs font-medium text-slate-500 mb-1">çµæŸæ—¥æœŸ</label><input type="date" id="report-end-date" class="w-full p-2 border rounded"></div>
                        <div class="flex items-end"><button onclick="window.app.generateReport()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">ç”¢ç”Ÿå ±è¡¨</button></div>
                    </div>
                 </div>
                 <div id="report-preview-container" class="bg-white p-8 shadow-lg rounded-lg min-h-[500px] hidden">
                     <div class="text-center border-b-2 border-slate-800 pb-4 mb-6">
                         <h1 class="text-3xl font-bold text-slate-900 mb-2" id="report-title">è¨­å‚™ç´€éŒ„å ±è¡¨</h1>
                         <p class="text-slate-600" id="report-subtitle">æŸ¥è©¢å€é–“: </p>
                     </div>
                     <div id="report-content" class="overflow-x-auto"></div>
                     <div class="mt-8 text-right text-sm text-slate-500"><p>è£½è¡¨æ™‚é–“: <span id="report-timestamp"></span></p></div>
                 </div>
                 <div id="report-actions" class="mt-4 flex justify-end gap-3 hidden">
                     <button onclick="window.app.printReport()" class="bg-slate-700 text-white font-bold py-2 px-6 rounded hover:bg-slate-800 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>åˆ—å° / å¦å­˜ PDF</button>
                 </div>
             </div>

             <div id="admin-tab-content-checklistHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™é»æª¢æ­·å²ç´€éŒ„</h2>
                <div id="checklist-history-log-container"></div>
             </div>
             <div id="admin-tab-content-maintenanceHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„</h2>
                <div id="maintenance-history-log-container"></div>
             </div>
        </div>
    </div>

    <!-- Modals (Scanner, Template, Maint, QR) -->
    <!-- æƒæå¾Œå‹•ä½œé¸æ“‡ Modal -->
    <div id="scan-action-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[140] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center hidden" id="scan-action-content">
             <h3 class="text-xl font-bold mb-2 text-slate-800">æƒææˆåŠŸ</h3>
             <p id="scan-match-name" class="text-lg text-indigo-600 font-bold mb-6">è¨­å‚™åç¨±</p>
             <div class="space-y-3">
                 <button id="btn-scan-checklist" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 action-submit">ğŸ“‹ é–‹å§‹é»æª¢</button>
                 <button id="btn-scan-maintenance" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 shadow-md flex items-center justify-center gap-2 action-submit">ğŸ”§ è¨˜éŒ„ä¿é¤Š</button>
                 <button onclick="document.getElementById('scan-action-modal').classList.add('hidden')" class="w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300">å–æ¶ˆ</button>
             </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">é¸æ“‡ç¯„æœ¬</h3>
            <div id="template-selection-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button onclick="window.app.closeTemplateModal()" class="mt-4 w-full bg-slate-200 py-2 rounded">é—œé–‰</button>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h2 class="text-2xl font-semibold mb-4 text-slate-800">æ–°å¢ä¿é¤Šç´€éŒ„</h2>
            <p id="maint-device-name" class="mb-4 text-slate-600"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600">ä¿é¤Šé¡å‹</label>
                    <select id="maintenance-type" class="w-full p-2 border rounded mt-1" onchange="window.app.toggleMaintType()">
                        <option value="cleaning">æ©Ÿå°æ¸…æ½”</option>
                        <option value="replacement">é›¶ä»¶æ›´æ›</option>
                    </select>
                </div>
                <div id="maintenance-component-selector" class="hidden">
                    <label class="block text-sm font-medium text-slate-600">æ›´æ›é›¶ä»¶</label>
                    <select id="maintenance-component-name" class="w-full p-2 border rounded mt-1"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">å‚™è¨»èªªæ˜</label>
                    <textarea id="maintenance-notes" class="w-full p-2 border rounded mt-1" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">ä¿é¤Šç…§ç‰‡ (é¸å¡«)</label>
                    <div class="flex items-center gap-4">
                        <img id="maint-image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border">
                        <button type="button" onclick="document.getElementById('maint-image-upload').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ğŸ“· æ‹ç…§ / ä¸Šå‚³</button>
                        <input type="file" id="maint-image-upload" accept="image/*" class="hidden" onchange="window.app.handleMaintImageUpload(this)">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="window.app.closeMaintenanceModal()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                <button onclick="window.app.logMaintenance(this)" class="bg-orange-500 text-white py-2 px-4 rounded font-bold">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <!-- QR Code Display Modal -->
    <div id="qr-code-display-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[130] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 text-center max-w-sm w-full hidden" id="qr-display-content">
            <h3 class="text-xl font-bold mb-2">è¨­å‚™ QR Code</h3>
            <p id="qr-display-name" class="text-gray-600 mb-4"></p>
            <div id="qr-code-container" class="flex justify-center mb-4 border p-2 rounded bg-white"></div>
            <p class="text-xs text-gray-400 mb-4">ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæå³å¯ç›´æ¥é–‹å•Ÿ</p>
            <div class="space-y-2">
                <button onclick="window.app.downloadQRCode()" class="w-full bg-indigo-600 text-white font-bold px-4 py-2 rounded hover:bg-indigo-700 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è¼‰åœ–ç‰‡
                </button>
                <button onclick="document.getElementById('qr-code-display-modal').classList.add('hidden')" class="w-full bg-slate-200 text-gray-700 font-bold px-4 py-2 rounded hover:bg-slate-300">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-50 flex">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center hidden" id="qr-scanner-content">
            <h3 class="text-2xl font-bold mb-4">æƒæè¨­å‚™ QR Code</h3>
            <div id="qr-reader" class="w-full"></div>
            <button onclick="window.app.hideScanner()" class="w-full bg-slate-500 text-white p-3 rounded-lg mt-4">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-[110] space-y-3 w-full max-w-xs"></div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPpMCssbitCn2wE7WEqefL2czjIsRuyBw",
            authDomain: "checklist-20250825.firebaseapp.com",
            databaseURL: "https://checklist-20250825-default-rtdb.firebaseio.com",
            projectId: "checklist-20250825",
            storageBucket: "checklist-20250825.appspot.com",
            messagingSenderId: "899658463753",
            appId: "1:899658463753:web:71819671db2cdf6bf4d6d8",
            measurementId: "G-FH3F97BZ7F"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function getCollectionRef(name) { return collection(db, name); }
        function getDocRef(colName, docId) { return doc(db, colName, docId); }

        let equipmentDatabase = {}, userDatabase = {}, templateDatabase = {}, checkHistory = [], maintenanceHistory = [];
        let loggedInUser = null, currentCheckId = null, html5QrCode = null, currentMaintEqId = null;
        let currentQrId = null; 

        window.app = {};

        const init = () => {
            console.log("åˆå§‹åŒ– Firebase...");
            const urlParams = new URLSearchParams(window.location.search);
            const scanId = urlParams.get('id');
            if(scanId) window.app.pendingScanId = scanId;

            startListeners();
            
            const today = new Date().toISOString().slice(0,10);
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
        };

        function startListeners() {
            const onError = (error) => {
                console.error("Listener Error:", error);
                if (error.code === 'permission-denied') showToast("æ¬Šé™ä¸è¶³", 'error');
            };

            onSnapshot(getCollectionRef("users"), (snap) => {
                let newData = {}; 
                snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                userDatabase = newData;
                renderLoginOptions();
                if (!loggedInUser) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('login-modal').classList.remove('hidden');
                }
                if (document.getElementById('user-list-container').offsetParent) window.app.renderUserList();
            }, onError);

            onSnapshot(getCollectionRef("equipment"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                equipmentDatabase = newData;
                if (document.getElementById('equipment-list-section').offsetParent) window.app.renderEquipmentList();
                if (document.getElementById('admin-tab-content-checklistHistory').offsetParent) window.app.renderChecklistHistory(document.getElementById('check-filter-select')?.value || 'ALL');
                if (document.getElementById('admin-tab-content-maintenanceHistory').offsetParent) window.app.renderMaintenanceHistory(document.getElementById('maint-filter-select')?.value || 'ALL');
                
                populateManualDropdown();
                if(window.app.pendingScanId && loggedInUser) { 
                    if(equipmentDatabase[window.app.pendingScanId]) {
                        window.app.handleScanResult(window.app.pendingScanId);
                        window.app.pendingScanId = null; 
                        try { window.history.replaceState({}, document.title, window.location.pathname); } catch(e){}
                    }
                }
            }, onError);

            onSnapshot(getCollectionRef("checklist_templates"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                templateDatabase = newData;
                if (document.getElementById('template-list-section').offsetParent) window.app.renderTemplateList();
            }, onError);

            onSnapshot(getCollectionRef("check_history"), (snap) => {
                checkHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('admin-tab-content-checklistHistory').offsetParent) window.app.renderChecklistHistory(document.getElementById('check-filter-select')?.value || 'ALL');
            }, onError);

            onSnapshot(getCollectionRef("maintenance_history"), (snap) => {
                maintenanceHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('admin-tab-content-maintenanceHistory').offsetParent) window.app.renderMaintenanceHistory(document.getElementById('maint-filter-select')?.value || 'ALL');
            }, onError);
        }

        // ç™»å…¥é‚è¼¯
        function renderLoginOptions() {
            const select = document.getElementById('login-user-select');
            select.innerHTML = '<option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>';
            Object.values(userDatabase).forEach(user => {
                const roleText = user.role === 'manager' ? 'ğŸ‘‘ ç®¡ç†å“¡' : 'ğŸ”§ æ“ä½œå“¡';
                select.add(new Option(`${roleText} - ${user.name}`, user.id));
            });
        }

        window.app.handleLogin = function() {
            const select = document.getElementById('login-user-select');
            const userId = select.value;
            if (userId === 'guest') { loggedInUser = { id: 'guest', name: 'è¨ªå®¢', role: 'guest' }; } 
            else { loggedInUser = userDatabase[userId]; }
            if (!loggedInUser) return showToast("ç™»å…¥éŒ¯èª¤ï¼Œè«‹é‡è©¦", "error");
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            updateUIState();
            if(window.app.pendingScanId && equipmentDatabase[window.app.pendingScanId]) {
                window.app.handleScanResult(window.app.pendingScanId); window.app.pendingScanId = null;
            }
        };

        window.app.logout = function() {
            loggedInUser = null;
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('admin-mode').classList.add('hidden');
            document.getElementById('user-mode').classList.remove('hidden');
            document.getElementById('toggle-mode-btn').textContent = "âš™ï¸ ç®¡ç†å¾Œå°";
        };

        function updateUIState() {
            document.getElementById('logged-in-view').classList.remove('hidden');
            document.getElementById('logged-in-name').textContent = loggedInUser.name;
            const roleBadge = document.getElementById('role-badge');
            const body = document.body;
            body.classList.remove('role-guest', 'role-operator', 'role-manager');
            body.classList.add(`role-${loggedInUser.role}`);
            let roleName = '';
            if (loggedInUser.role === 'manager') roleName = 'ç®¡ç†å“¡';
            else if (loggedInUser.role === 'operator') roleName = 'æ“ä½œå“¡';
            else roleName = 'è¨ªå®¢';
            roleBadge.textContent = roleName;
            roleBadge.className = `ml-2 px-2 py-0.5 rounded text-xs font-bold ${loggedInUser.role === 'manager' ? 'bg-purple-100 text-purple-800' : loggedInUser.role === 'operator' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-600'}`;
            const guestWarning = document.querySelector('.guest-warning');
            if (loggedInUser.role === 'guest') {
                guestWarning.classList.remove('hidden');
                document.getElementById('toggle-mode-btn').classList.remove('hidden');
            } else {
                guestWarning.classList.add('hidden');
                if (loggedInUser.role === 'operator') { document.getElementById('toggle-mode-btn').classList.add('hidden'); } else { document.getElementById('toggle-mode-btn').classList.remove('hidden'); }
            }
            document.getElementById('main-content').classList.remove('hidden');
            populateManualDropdown();
        }
        
        function populateManualDropdown() {
            const sel = document.getElementById('manual-category-select');
            const devSel = document.getElementById('manual-device-select');
            const btnStart = document.getElementById('manual-start-button');
            const btnMaint = document.getElementById('manual-maintenance-button');
            if (!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) return;
            const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))];
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">è«‹é¸æ“‡å¤§é¡...</option>';
            cats.forEach(c => sel.add(new Option(c, c)));
            if (currentVal && cats.includes(currentVal)) sel.value = currentVal;
            sel.onchange = () => {
                devSel.innerHTML = '<option value="">è«‹é¸æ“‡è¨­å‚™...</option>'; devSel.disabled = false;
                Object.values(equipmentDatabase).filter(e => (e.category || 'æœªåˆ†é¡') === sel.value).forEach(e => devSel.add(new Option(e.name, e.id)));
                btnStart.disabled = true; btnMaint.disabled = true;
            };
            devSel.onchange = () => {
                const hasValue = !!devSel.value; const isGuest = loggedInUser && loggedInUser.role === 'guest';
                btnStart.disabled = !hasValue || isGuest; btnMaint.disabled = !hasValue || isGuest;
            };
        }

        window.app.handleManualSelection = () => { const id = document.getElementById('manual-device-select').value; startChecklist(id); };
        window.app.handleManualMaintenance = () => { const id = document.getElementById('manual-device-select').value; window.app.showMaintenanceModal(id); };

        function startChecklist(id) {
            if (loggedInUser.role === 'guest') return showToast("è¨ªå®¢ç„¡æ³•åŸ·è¡Œé»æª¢", "error");
            const eq = equipmentDatabase[id]; if (!eq) return;
            currentCheckId = id;
            document.getElementById('main-content').classList.add('hidden'); document.getElementById('checklist-section').classList.remove('hidden');
            document.getElementById('device-name').textContent = eq.name; document.getElementById('device-asset-no').textContent = eq.assetNumber || 'ç„¡';
            document.getElementById('user-name-display').textContent = loggedInUser.name; document.getElementById('check-date').textContent = new Date().toISOString().slice(0,10);
            const container = document.getElementById('checklist-items-container'); container.innerHTML = '';
            if (eq.items) {
                eq.items.forEach(cat => {
                    const group = document.createElement('div'); group.innerHTML = `<h3 class="font-bold text-lg mb-2 text-slate-600 border-b pb-1">${cat.category}</h3>`;
                    cat.subItems.forEach(item => {
                        group.innerHTML += `<div class="card p-4 mb-3 item-row" data-cat="${cat.category}" data-text="${item.text}"><div class="flex justify-between items-center"><span class="text-slate-800 font-medium">${item.text}</span><div class="space-x-1 flex-shrink-0"><button onclick="window.app.setStatus(this, 'normal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">æ­£å¸¸</button><button onclick="window.app.setStatus(this, 'abnormal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">ç•°å¸¸</button></div></div><input type="text" class="abnormal-input hidden w-full mt-2 p-2 border rounded text-sm bg-red-50 text-red-700 placeholder-red-300" placeholder="è«‹èªªæ˜ç•°å¸¸åŸå› ..."></div>`;
                    }); container.appendChild(group);
                });
            }
        }

        window.app.setStatus = function(btn, status) {
            const row = btn.closest('.item-row');
            row.querySelectorAll('.status-btn').forEach(b => { b.classList.remove('selected', 'selected-normal', 'selected-abnormal', 'bg-green-500', 'bg-red-500', 'text-white'); });
            btn.classList.add('selected');
            if(status === 'normal') btn.classList.add('selected-normal', 'bg-green-500', 'text-white'); else btn.classList.add('selected-abnormal', 'bg-red-500', 'text-white');
            const input = row.querySelector('.abnormal-input'); if(status === 'abnormal') input.classList.remove('hidden'); else input.classList.add('hidden');
            row.dataset.status = status;
        };

        window.app.submitChecklist = async function(btn) {
            if (loggedInUser.role === 'guest') return;
            btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
            try {
                const rows = document.querySelectorAll('.item-row'); const items = [];
                rows.forEach(r => { items.push({ category: r.dataset.cat, text: r.dataset.text, status: r.dataset.status === 'abnormal' ? 'ç•°å¸¸' : 'æ­£å¸¸', details: r.querySelector('.abnormal-input').value }); });
                const record = { deviceId: currentCheckId, deviceName: equipmentDatabase[currentCheckId].name, userId: loggedInUser.id, userName: loggedInUser.name, checkTimestamp: serverTimestamp(), summaryNotes: document.getElementById('summary-notes').value, items: items };
                await setDoc(doc(getCollectionRef("check_history")), record);
                const cycle = parseInt(equipmentDatabase[currentCheckId].checkCycleDays) || 7; const nextDate = new Date(); nextDate.setDate(nextDate.getDate() + cycle);
                await updateDoc(getDocRef("equipment", currentCheckId), { nextCheckDate: nextDate.toISOString().slice(0,10) });
                showToast('æäº¤æˆåŠŸ', 'success'); window.app.resetApp();
            } catch (e) { console.error(e); showToast('æäº¤å¤±æ•—: ' + e.message, 'error'); } finally { btn.disabled = false; btn.innerText = "æäº¤"; }
        };

        window.app.resetApp = function() { document.getElementById('checklist-section').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); currentCheckId = null; };

        window.app.toggleManagementMode = function() {
            const userMode = document.getElementById('user-mode'); const adminMode = document.getElementById('admin-mode'); const btn = document.getElementById('toggle-mode-btn');
            if (loggedInUser.role === 'operator') { return showToast("æ¬Šé™ä¸è¶³ï¼šåƒ…ç®¡ç†å“¡å¯é€²å…¥ç®¡ç†å¾Œå°", "error"); }
            if (userMode.classList.contains('hidden')) { userMode.classList.remove('hidden'); adminMode.classList.add('hidden'); btn.textContent = "âš™ï¸ ç®¡ç†å¾Œå°"; } 
            else { userMode.classList.add('hidden'); adminMode.classList.remove('hidden'); btn.textContent = "â¬…ï¸ è¿”å›é»æª¢"; window.app.renderEquipmentList(); }
        };

        window.app.switchAdminTab = function(tab) {
            document.querySelectorAll('[id^=admin-tab-content]').forEach(d => d.classList.add('hidden'));
            document.getElementById(`admin-tab-content-${tab}`).classList.remove('hidden');
            document.querySelectorAll('#admin-mode nav button').forEach(b => b.classList.remove('admin-tab-active', 'text-indigo-600'));
            document.getElementById(`tab-${tab}`).classList.add('admin-tab-active');
            if(tab === 'users') window.app.renderUserList();
            if(tab === 'equipment') window.app.renderEquipmentList();
            if(tab === 'templates') window.app.renderTemplateList();
            
            // å‚³å…¥é è¨­çš„ç¯©é¸ç‹€æ…‹ 'ALL'ï¼Œé¿å…åˆæ¬¡åˆ‡æ›æ™‚ç©ºç™½
            if(tab === 'checklistHistory') window.app.renderChecklistHistory('ALL');
            if(tab === 'maintenanceHistory') window.app.renderMaintenanceHistory('ALL');
        };

        // è¨­å‚™ç®¡ç† (Updated: Dropdown List Logic)
        window.app.renderEquipmentList = function() {
            const tabsContainer = document.getElementById('equipment-category-tabs');
            const listContainer = document.getElementById('equipment-list-container');
            
            if(!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 py-4">ç„¡è³‡æ–™</p>'; 
                tabsContainer.innerHTML = ''; 
                return;
            }

            // Group data
            const groups = {};
            Object.values(equipmentDatabase).forEach(eq => {
                const cat = eq.category || 'æœªåˆ†é¡';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(eq);
            });
            const categories = Object.keys(groups).sort((a, b) => a.localeCompare(b, 'zh-TW'));

            // 1. Build Dropdown (Replacement for Tabs)
            let selectHtml = `
                <div class="flex items-center bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                    <label class="mr-3 font-bold text-slate-700 flex items-center whitespace-nowrap">
                        <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        åˆ†é¡åˆ‡æ›:
                    </label>
                    <select id="eq-category-select" onchange="window.app.filterEquipmentCategory(this.value)" class="form-select w-full p-2 border border-gray-300 rounded text-slate-700 font-medium focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                        <option value="ALL">ğŸ“‹ å…¨éƒ¨é¡¯ç¤º (${Object.keys(equipmentDatabase).length} å°)</option>
            `;
            
            categories.forEach(cat => {
                selectHtml += `<option value="${cat}">${cat} (${groups[cat].length})</option>`;
            });
            selectHtml += `</select></div>`;
            
            tabsContainer.innerHTML = selectHtml; // Inject dropdown where tabs were

            // 2. Build List Content
            let listHtml = '';
            categories.forEach((cat) => {
                // Show ALL by default
                listHtml += `<div id="cat-content-${cat}" class="eq-category-group space-y-3 mb-6">`;
                
                // Add a header for the category so it's clear when viewing "All"
                listHtml += `<h3 class="font-bold text-slate-500 text-sm border-b pb-1 mb-2 mt-4">${cat}</h3>`;
                
                groups[cat].forEach(eq => {
                    const imgUrl = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡';
                    let statusClass = 'active'; 
                    if(eq.status==='ç¶­ä¿®ä¸­') statusClass='repair'; 
                    else if(eq.status==='æœªä½¿ç”¨') statusClass='unused';
                    
                    listHtml += `
                    <div class="card p-4 flex flex-col sm:flex-row items-center gap-4 hover:shadow-md transition-shadow">
                        <img src="${imgUrl}" class="w-24 h-24 object-cover rounded-md border flex-shrink-0 cursor-pointer" onclick="window.open('${imgUrl}')">
                        <div class="flex-grow text-center sm:text-left w-full">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center justify-center sm:justify-start">
                                <span class="status-dot ${statusClass}"></span>${eq.name}
                            </h3>
                            <div class="text-sm text-slate-500 mt-1 space-y-1">
                                <p>ğŸ†” ID: <span class="font-mono text-slate-700">${eq.id}</span></p>
                                <p>ğŸ“ åœ°é»: ${eq.location || 'æœªè¨­å®š'}</p>
                            </div>
                            <div class="flex items-center gap-2 mt-2 text-xs text-gray-400 justify-center sm:justify-start">
                                <span class="bg-slate-100 px-2 py-1 rounded">ä¸‹æ¬¡é»æª¢: ${eq.nextCheckDate || 'æœªè¨­å®š'}</span>
                                <span class="bg-slate-100 px-2 py-1 rounded">ä¸‹æ¬¡æ¸…æ½”: ${eq.nextCleaningDate || 'æœªè¨­å®š'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto mt-2 sm:mt-0">
                            <button onclick="window.app.showQRCode('${eq.id}', '${eq.name}')" class="bg-white border border-green-500 text-green-600 text-sm font-bold px-3 py-2 rounded hover:bg-green-50 transition-colors flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>QR</button>
                            <button onclick="window.app.showMaintenanceModal('${eq.id}')" class="bg-orange-100 text-orange-600 border border-orange-200 text-sm font-bold px-3 py-2 rounded hover:bg-orange-200 transition-colors action-edit">ä¿é¤Š</button>
                            <button onclick="window.app.showEditor('${eq.id}')" class="bg-blue-100 text-blue-600 border border-blue-200 text-sm font-bold px-3 py-2 rounded hover:bg-blue-200 transition-colors action-edit">ç·¨è¼¯</button>
                            <button onclick="window.app.deleteEquipment('${eq.id}')" class="bg-red-100 text-red-600 border border-red-200 text-sm font-bold px-3 py-2 rounded hover:bg-red-200 transition-colors action-delete">åˆªé™¤</button>
                        </div>
                    </div>`;
                });
                listHtml += '</div>';
            });
            listContainer.innerHTML = listHtml;
        };

        // Helper function for the select onchange
        window.app.filterEquipmentCategory = function(selectedCat) {
            const allGroups = document.querySelectorAll('.eq-category-group');
            allGroups.forEach(group => {
                if (selectedCat === 'ALL') {
                    group.classList.remove('hidden');
                } else {
                    if (group.id === `cat-content-${selectedCat}`) {
                        group.classList.remove('hidden');
                    } else {
                        group.classList.add('hidden');
                    }
                }
            });
        };

        window.app.deleteEquipment = async function(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¨­å‚™ï¼Ÿ')) await deleteDoc(getDocRef("equipment", id));
        };
        
        // ... (QR Code, Image Upload, Modals Logic same as before) ...
        window.app.showQRCode = function(id, name) {
            currentQrId = id; const container = document.getElementById('qr-code-container'); container.innerHTML = '';
            document.getElementById('qr-display-name').textContent = name;
            document.getElementById('qr-code-display-modal').classList.remove('hidden'); document.getElementById('qr-display-content').classList.remove('hidden');
            const baseUrl = "https://saniltw.github.io/welddata/5.html"; const qrData = `${baseUrl}?id=${id}`; const hiddenDiv = document.createElement('div');
            new QRCode(hiddenDiv, { text: qrData, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H });
            const checkQrImage = setInterval(() => { const qrImg = hiddenDiv.querySelector('img'); if (qrImg && qrImg.src) { clearInterval(checkQrImage); const imgObj = new Image(); imgObj.onload = () => window.app.drawCompositeQRCode(imgObj, name, container); imgObj.src = qrImg.src; } else { const qrCanvas = hiddenDiv.querySelector('canvas'); if(qrCanvas) { clearInterval(checkQrImage); window.app.drawCompositeQRCode(qrCanvas, name, container); } } }, 50);
        };
        window.app.drawCompositeQRCode = function(sourceImage, text, container) { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const padding = 20; const qrSize = 200; const textBoxHeight = 50; const width = qrSize + (padding * 2); const height = qrSize + (padding * 2) + textBoxHeight; canvas.width = width; canvas.height = height; ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, width, height); ctx.drawImage(sourceImage, padding, padding, qrSize, qrSize); ctx.fillStyle = '#000000'; ctx.font = 'bold 18px "Noto Sans TC", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; let fontSize = 18; do { ctx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`; fontSize -= 1; } while (ctx.measureText(text).width > width - 20 && fontSize > 10); ctx.fillText(text, width / 2, height - (textBoxHeight / 2) - 5); ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.strokeRect(0, 0, width, height); canvas.style.maxWidth = '100%'; canvas.style.height = 'auto'; container.appendChild(canvas); };
        window.app.downloadQRCode = function() { const container = document.getElementById('qr-code-container'); const canvas = container.querySelector('canvas'); if(canvas) { const link = document.createElement('a'); const deviceName = document.getElementById('qr-display-name').textContent || 'device'; link.download = `QR-${deviceName}.png`; link.href = canvas.toDataURL("image/png"); document.body.appendChild(link); link.click(); document.body.removeChild(link); } else { showToast("QR Code å°šæœªç”¢ç”Ÿ", "error"); } };
        window.app.showMaintenanceModal = function(id) { if (loggedInUser.role === 'guest') return showToast("è¨ªå®¢æ¬Šé™ä¸è¶³", "error"); currentMaintEqId = id; document.getElementById('maint-device-name').textContent = equipmentDatabase[id].name; const compSelect = document.getElementById('maintenance-component-name'); compSelect.innerHTML = ''; document.getElementById('maintenance-notes').value = ''; document.getElementById('maint-image-preview').src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; document.getElementById('maint-image-preview').removeAttribute('data-image-data-url'); document.getElementById('maint-image-upload').value = ''; const comps = equipmentDatabase[id].components || []; if(comps.length > 0) comps.forEach(c => compSelect.add(new Option(c.name, c.name))); else compSelect.add(new Option('ç„¡é›¶ä»¶è³‡æ–™', '')); window.app.toggleMaintType(); document.getElementById('maintenance-modal').classList.remove('hidden'); };
        window.app.toggleMaintType = function() { const type = document.getElementById('maintenance-type').value; const selector = document.getElementById('maintenance-component-selector'); if(type === 'replacement') selector.classList.remove('hidden'); else selector.classList.add('hidden'); };
        window.app.closeMaintenanceModal = function() { document.getElementById('maintenance-modal').classList.add('hidden'); };
        window.app.handleMaintImageUpload = function(input) { if(!input.files[0]) return; const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); const preview = document.getElementById('maint-image-preview'); preview.src = dataUrl; preview.dataset.imageDataUrl = dataUrl; }; img.src = e.target.result; }; reader.readAsDataURL(file); };
        window.app.logMaintenance = async function(btn) { if(!currentMaintEqId) return; btn.disabled = true; const type = document.getElementById('maintenance-type').value; const notes = document.getElementById('maintenance-notes').value; const componentName = type === 'replacement' ? document.getElementById('maintenance-component-name').value : null; const imageUrl = document.getElementById('maint-image-preview').dataset.imageDataUrl || null; try { const record = { deviceId: currentMaintEqId, deviceName: equipmentDatabase[currentMaintEqId].name, userId: loggedInUser.id, userName: loggedInUser.name, timestamp: serverTimestamp(), type, notes, componentName, imageUrl }; await setDoc(doc(getCollectionRef("maintenance_history")), record); const updates = {}; if(type === 'cleaning') { const nextClean = new Date(); nextClean.setDate(nextClean.getDate() + 30); updates.nextCleaningDate = nextClean.toISOString().slice(0,10); } await updateDoc(getDocRef("equipment", currentMaintEqId), updates); showToast("ä¿é¤Šç´€éŒ„å·²å„²å­˜", "success"); window.app.closeMaintenanceModal(); } catch(e) { console.error(e); showToast("å„²å­˜å¤±æ•—", "error"); } finally { btn.disabled = false; } };
        window.app.handleImageUpload = function(input) { if(!input.files[0]) return; const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); const preview = document.getElementById('image-preview'); preview.src = dataUrl; preview.dataset.imageDataUrl = dataUrl; }; img.src = e.target.result; }; reader.readAsDataURL(file); };
        window.app.showEditor = function(id = null) { document.getElementById('equipment-list-section').classList.add('hidden'); document.getElementById('equipment-editor-section').classList.remove('hidden'); document.getElementById('item-editor-container').innerHTML = ''; document.getElementById('component-editor-container').innerHTML = ''; const sel = document.getElementById('edit-device-category-select'); const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))]; sel.innerHTML = '<option value="__new__">ï¼‹ æ–°å¢åˆ†é¡</option>'; cats.forEach(c => sel.add(new Option(c, c))); const imgPreview = document.getElementById('image-preview'); document.getElementById('edit-device-image').value = ''; const userContainer = document.getElementById('user-assignment-container'); userContainer.innerHTML = ''; Object.values(userDatabase).forEach(u => { userContainer.innerHTML += `<label class="flex items-center space-x-2 text-sm p-1"><input type="checkbox" class="auth-user-cb rounded" value="${u.id}"><span class="text-gray-700">${u.name}</span></label>`; }); if(id) { const eq = equipmentDatabase[id]; document.getElementById('edit-device-id').value = eq.id; document.getElementById('edit-device-name').value = eq.name; document.getElementById('edit-device-location').value = eq.location || ''; document.getElementById('edit-device-asset').value = eq.assetNumber || ''; document.getElementById('edit-device-status').value = eq.status || 'ä½¿ç”¨ä¸­'; document.getElementById('edit-device-cycle').value = eq.checkCycleDays || ''; document.getElementById('edit-device-next-date').value = eq.nextCheckDate || ''; if(eq.category) sel.value = eq.category; if(eq.items) eq.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container')); if(eq.components) eq.components.forEach(c => window.app.addComponentEditor(c)); if(Array.isArray(eq.authorizedUsers)) { eq.authorizedUsers.forEach(uid => { const cb = userContainer.querySelector(`input[value="${uid}"]`); if(cb) cb.checked = true; }); } imgPreview.src = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; imgPreview.dataset.imageDataUrl = eq.imageUrl || ''; } else { ['edit-device-id', 'edit-device-name', 'edit-device-location', 'edit-device-asset', 'edit-device-cycle', 'edit-device-next-date'].forEach(k=>document.getElementById(k).value=''); imgPreview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; imgPreview.dataset.imageDataUrl = ''; } };
        window.app.addCategoryEditor = function(data = null, containerId = 'item-editor-container') { const container = document.getElementById(containerId); const div = document.createElement('div'); div.className = 'editor-item border p-3 rounded bg-slate-50 mb-2'; div.innerHTML = `<div class="flex justify-between mb-2"><input type="text" class="cat-name p-1 border rounded w-1/2 font-bold" value="${data?.category || ''}" placeholder="åˆ†é¡åç¨± (å¦‚: å¤–è§€)"><button onclick="this.closest('.editor-item').remove()" class="text-red-500 text-xs">åˆªé™¤</button></div><textarea class="sub-items w-full p-2 border rounded text-sm h-20" placeholder="é …ç›® (ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚: ç•°éŸ³, æ¼æ²¹)">${data?.subItems?.map(s => s.text).join(',') || ''}</textarea>`; container.appendChild(div); };
        window.app.addComponentEditor = function(data = null) { const container = document.getElementById('component-editor-container'); const div = document.createElement('div'); div.className = 'component-item border p-2 rounded bg-white mb-2 flex space-x-2 items-center'; div.innerHTML = `<input type="text" class="comp-name w-1/2 p-1 border rounded text-sm" value="${data?.name || ''}" placeholder="é›¶ä»¶åç¨±"><input type="number" class="comp-cycle w-1/4 p-1 border rounded text-sm" value="${data?.cycle || ''}" placeholder="é€±æœŸ(å¤©)"><button onclick="this.closest('.component-item').remove()" class="text-red-500 text-xs px-2">âœ•</button>`; container.appendChild(div); };
        window.app.saveEquipment = async function() { const id = document.getElementById('edit-device-id').value; const name = document.getElementById('edit-device-name').value; const catSelect = document.getElementById('edit-device-category-select'); const cat = catSelect.value === '__new__' ? (document.getElementById('edit-device-category-new').value || 'æœªåˆ†é¡') : catSelect.value; const items = []; document.querySelectorAll('#item-editor-container .editor-item').forEach(el => { const cName = el.querySelector('.cat-name').value; const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text); if(cName) items.push({ category: cName, subItems: subs }); }); const components = []; document.querySelectorAll('#component-editor-container .component-item').forEach(el => { const cName = el.querySelector('.comp-name').value; const cCycle = el.querySelector('.comp-cycle').value; if(cName) components.push({ name: cName, cycle: cCycle }); }); const authorizedUsers = []; document.querySelectorAll('.auth-user-cb:checked').forEach(cb => authorizedUsers.push(cb.value)); const imgPreview = document.getElementById('image-preview'); const data = { name, category: cat, items, components, authorizedUsers, imageUrl: imgPreview.dataset.imageDataUrl || null, location: document.getElementById('edit-device-location').value, assetNumber: document.getElementById('edit-device-asset').value, status: document.getElementById('edit-device-status').value, checkCycleDays: parseInt(document.getElementById('edit-device-cycle').value) || 0, nextCheckDate: document.getElementById('edit-device-next-date').value }; await setDoc(getDocRef("equipment", id), data, { merge: true }); showToast('å„²å­˜æˆåŠŸ', 'success'); window.app.showList(); };
        window.app.showList = function() { document.getElementById('equipment-list-section').classList.remove('hidden'); document.getElementById('equipment-editor-section').classList.add('hidden'); };
        window.app.renderTemplateList = function() { const container = document.getElementById('template-list-container'); container.innerHTML = ''; if(Object.keys(templateDatabase).length === 0) { container.innerHTML = '<p class="text-center text-gray-400">å°šç„¡ç¯„æœ¬</p>'; return; } Object.values(templateDatabase).forEach(t => { container.innerHTML += `<div class="card p-4 flex justify-between items-center"><span class="font-bold">${t.name}</span><div class="flex gap-2"><button onclick="window.app.showTemplateEditor('${t.id}')" class="text-blue-600 text-sm border px-2 py-1 rounded">ç·¨è¼¯</button><button onclick="window.app.deleteTemplate('${t.id}')" class="text-red-600 text-sm border px-2 py-1 rounded">åˆªé™¤</button></div></div>`; }); };
        window.app.showTemplateEditor = function(id = null) { document.getElementById('template-list-section').classList.add('hidden'); document.getElementById('template-editor-section').classList.remove('hidden'); document.getElementById('template-item-editor-container').innerHTML = ''; if(id) { const t = templateDatabase[id]; document.getElementById('edit-template-id').value = t.id; document.getElementById('edit-template-name').value = t.name; if(t.items) t.items.forEach(i => window.app.addCategoryEditor(i, 'template-item-editor-container')); } else { document.getElementById('edit-template-id').value = ''; document.getElementById('edit-template-name').value = ''; } };
        window.app.showTemplateList = function() { document.getElementById('template-list-section').classList.remove('hidden'); document.getElementById('template-editor-section').classList.add('hidden'); };
        window.app.saveTemplate = async function() { const id = document.getElementById('edit-template-id').value || doc(getCollectionRef("checklist_templates")).id; const name = document.getElementById('edit-template-name').value; if(!name) return showToast("è«‹è¼¸å…¥ç¯„æœ¬åç¨±", "error"); const items = []; document.querySelectorAll('#template-item-editor-container .editor-item').forEach(el => { const cName = el.querySelector('.cat-name').value; const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text); if(cName) items.push({ category: cName, subItems: subs }); }); await setDoc(getDocRef("checklist_templates", id), { name, items }); showToast("ç¯„æœ¬å·²å„²å­˜", "success"); window.app.showTemplateList(); };
        window.app.deleteTemplate = async function(id) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç¯„æœ¬ï¼Ÿ')) await deleteDoc(getDocRef("checklist_templates", id)); };
        window.app.showTemplateModal = function() { const container = document.getElementById('template-selection-container'); container.innerHTML = ''; if(Object.keys(templateDatabase).length === 0) { container.innerHTML = '<p class="text-center text-gray-400">ç„¡å¯ç”¨ç¯„æœ¬</p>'; } else { Object.values(templateDatabase).forEach(t => { container.innerHTML += `<button onclick="window.app.applyTemplate('${t.id}')" class="w-full text-left p-3 border rounded hover:bg-indigo-50 mb-2">${t.name}</button>`; }); } document.getElementById('template-modal').classList.remove('hidden'); document.getElementById('template-modal').classList.add('flex'); };
        window.app.closeTemplateModal = function() { document.getElementById('template-modal').classList.add('hidden'); document.getElementById('template-modal').classList.remove('flex'); };
        window.app.applyTemplate = function(id) { const t = templateDatabase[id]; if(t && t.items) { document.getElementById('item-editor-container').innerHTML = ''; t.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container')); showToast(`å·²å¥—ç”¨ç¯„æœ¬ï¼š${t.name}`, "success"); } window.app.closeTemplateModal(); };
        window.app.renderUserList = function() { const c = document.getElementById('user-list-container'); c.innerHTML = ''; Object.values(userDatabase).forEach(u => { c.innerHTML += `<div class="card p-3 flex justify-between items-center mb-2"><div><span class="font-bold">${u.name}</span> <span class="text-xs text-gray-500">(${u.role})</span></div><div class="space-x-2"><button onclick="window.app.showUserEditor('${u.id}')" class="text-blue-600 text-sm">ç·¨è¼¯</button><button onclick="window.app.deleteUser('${u.id}')" class="text-red-600 text-sm">åˆªé™¤</button></div></div>`; }); };
        window.app.showUserEditor = (id = null) => { document.getElementById('user-list-container').classList.add('hidden'); document.getElementById('user-editor-section').classList.remove('hidden'); const roleSelect = document.getElementById('edit-user-role'); roleSelect.onchange = (e) => { document.getElementById('edit-user-password').classList.toggle('hidden', e.target.value !== 'manager'); }; if (id && userDatabase[id]) { const user = userDatabase[id]; document.getElementById('edit-user-id').value = id; document.getElementById('edit-user-id').disabled = true; document.getElementById('edit-user-name').value = user.name; roleSelect.value = user.role; } else { document.getElementById('edit-user-id').value = ''; document.getElementById('edit-user-id').disabled = false; document.getElementById('edit-user-name').value = ''; } };
        window.app.saveUser = async function() { const id = document.getElementById('edit-user-id').value; const data = { name: document.getElementById('edit-user-name').value, role: document.getElementById('edit-user-role').value }; if(data.role === 'manager') data.password = document.getElementById('edit-user-password').value; await setDoc(getDocRef("users", id), data, { merge: true }); window.app.showUserList(); };
        window.app.showUserList = function() { document.getElementById('user-list-container').classList.remove('hidden'); document.getElementById('user-editor-section').classList.add('hidden'); };
        window.app.deleteUser = async (id) => { if(confirm('åˆªé™¤?')) await deleteDoc(getDocRef("users", id)); };

        // é‡æ–°å¯¦ä½œï¼šé»æª¢æ­·å²ç´€éŒ„ (åŒ…å«åˆ†é¡ç¯©é¸)
        window.app.renderChecklistHistory = function(selectedCat = 'ALL') {
             const c = document.getElementById('checklist-history-log-container');
             c.innerHTML = '';
             
             // 1. å–å¾—æ‰€æœ‰ç›¸é—œçš„è¨­å‚™åˆ†é¡ (å‹•æ…‹ç”Ÿæˆé¸é …)
             const categories = new Set(['ALL']);
             checkHistory.forEach(h => {
                 const eq = equipmentDatabase[h.deviceId];
                 if (eq && eq.category) categories.add(eq.category);
                 else categories.add('æœªåˆ†é¡');
             });
             
             // 2. å»ºç«‹ç¯©é¸å™¨ HTML
             let filterHtml = `
                <div class="mb-4 flex items-center bg-white p-3 rounded-lg border border-gray-200">
                    <label class="mr-3 font-bold text-slate-700 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                        åˆ†é¡ç¯©é¸:
                    </label>
                    <select id="check-filter-select" onchange="window.app.renderChecklistHistory(this.value)" class="form-select flex-grow p-2 border border-gray-300 rounded text-slate-700 font-medium">
                        <option value="ALL" ${selectedCat === 'ALL' ? 'selected' : ''}>å…¨éƒ¨é¡¯ç¤º</option>
             `;
             
             // æ’åºä¸¦ç”¢ç”Ÿé¸é …
             Array.from(categories).filter(c => c !== 'ALL').sort((a,b) => a.localeCompare(b, 'zh-TW')).forEach(cat => {
                 filterHtml += `<option value="${cat}" ${cat === selectedCat ? 'selected' : ''}>${cat}</option>`;
             });
             filterHtml += `</select></div>`;
             c.innerHTML = filterHtml;

             // 3. ç¯©é¸èˆ‡é¡¯ç¤ºè³‡æ–™
             let filteredHistory = checkHistory.filter(h => {
                 if (selectedCat === 'ALL') return true;
                 const eq = equipmentDatabase[h.deviceId];
                 const cat = eq ? (eq.category || 'æœªåˆ†é¡') : 'æœªåˆ†é¡';
                 return cat === selectedCat;
             });

             if(filteredHistory.length === 0) { 
                 c.innerHTML += '<p class="text-gray-400 text-center py-4">ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</p>'; 
                 return; 
             }
             
             filteredHistory.sort((a,b) => b.checkTimestamp.seconds - a.checkTimestamp.seconds).forEach(h => {
                 const date = h.checkTimestamp?.toDate().toLocaleString() || 'N/A';
                 const abCount = h.items.filter(i => i.status === 'ç•°å¸¸').length;
                 const statusStr = abCount > 0 ? `<span class="text-red-500 font-bold">${abCount} ç•°å¸¸</span>` : `<span class="text-green-600">æ­£å¸¸</span>`;
                 // é¡¯ç¤ºè¨­å‚™åˆ†é¡æ¨™ç±¤
                 const eq = equipmentDatabase[h.deviceId];
                 const catLabel = eq ? `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded ml-2">${eq.category || 'æœªåˆ†é¡'}</span>` : '';
                 
                 c.innerHTML += `
                 <div class="card p-4 mb-2 text-sm border-l-4 ${abCount>0?'border-red-500':'border-green-500'}">
                    <p class="font-bold text-lg flex items-center flex-wrap">
                        ${h.deviceName} 
                        ${catLabel}
                        <span class="text-xs font-normal text-gray-500 ml-auto">by ${h.userName}</span>
                    </p>
                    <p class="text-gray-500 mt-1 flex justify-between"><span>${date}</span><span>${statusStr}</span></p>
                 </div>`;
             });
        };

        // é‡æ–°å¯¦ä½œï¼šä¿é¤Šæ­·å²ç´€éŒ„ (åŒ…å«åˆ†é¡ç¯©é¸)
        window.app.renderMaintenanceHistory = function(selectedCat = 'ALL') {
             const c = document.getElementById('maintenance-history-log-container');
             c.innerHTML = '';
             
             // 1. å–å¾—åˆ†é¡
             const categories = new Set(['ALL']);
             maintenanceHistory.forEach(h => {
                 const eq = equipmentDatabase[h.deviceId];
                 if (eq && eq.category) categories.add(eq.category);
                 else categories.add('æœªåˆ†é¡');
             });

             // 2. å»ºç«‹ç¯©é¸å™¨ HTML
             let filterHtml = `
                <div class="mb-4 flex items-center bg-white p-3 rounded-lg border border-gray-200">
                    <label class="mr-3 font-bold text-slate-700 flex items-center">
                        <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                        åˆ†é¡ç¯©é¸:
                    </label>
                    <select id="maint-filter-select" onchange="window.app.renderMaintenanceHistory(this.value)" class="form-select flex-grow p-2 border border-gray-300 rounded text-slate-700 font-medium">
                        <option value="ALL" ${selectedCat === 'ALL' ? 'selected' : ''}>å…¨éƒ¨é¡¯ç¤º</option>
             `;
             Array.from(categories).filter(c => c !== 'ALL').sort((a,b) => a.localeCompare(b, 'zh-TW')).forEach(cat => {
                 filterHtml += `<option value="${cat}" ${cat === selectedCat ? 'selected' : ''}>${cat}</option>`;
             });
             filterHtml += `</select></div>`;
             c.innerHTML = filterHtml;

             // 3. ç¯©é¸èˆ‡é¡¯ç¤º
             let filteredHistory = maintenanceHistory.filter(h => {
                 if (selectedCat === 'ALL') return true;
                 const eq = equipmentDatabase[h.deviceId];
                 const cat = eq ? (eq.category || 'æœªåˆ†é¡') : 'æœªåˆ†é¡';
                 return cat === selectedCat;
             });

             if(filteredHistory.length === 0) { 
                 c.innerHTML += '<p class="text-gray-400 text-center py-4">ç„¡ä¿é¤Šè³‡æ–™</p>'; 
                 return; 
             }
             
             filteredHistory.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds).forEach(h => {
                 const date = h.timestamp?.toDate().toLocaleString() || 'N/A';
                 const typeStr = h.type === 'cleaning' ? 'ğŸ§¹ æ©Ÿå°æ¸…æ½”' : 'ğŸ”§ é›¶ä»¶æ›´æ›';
                 const imgHtml = h.imageUrl ? `<a href="${h.imageUrl}" target="_blank" class="block mt-2"><img src="${h.imageUrl}" class="w-16 h-16 object-cover rounded border hover:scale-110 transition-transform"></a>` : '';
                 const eq = equipmentDatabase[h.deviceId];
                 const catLabel = eq ? `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded ml-2">${eq.category || 'æœªåˆ†é¡'}</span>` : '';

                 c.innerHTML += `
                 <div class="card p-4 mb-2 text-sm border-l-4 border-yellow-500">
                    <p class="font-bold text-lg flex items-center flex-wrap">
                        ${h.deviceName} 
                        ${catLabel}
                        <span class="text-xs font-normal text-gray-500 ml-auto">by ${h.userName}</span>
                    </p>
                    <p class="mt-1 font-semibold text-slate-700">${typeStr} ${h.componentName ? `(${h.componentName})` : ''}</p>
                    <p class="text-gray-500 mt-1">${date}</p>
                    ${h.notes ? `<p class="mt-2 p-2 bg-gray-50 rounded text-gray-600">${h.notes}</p>` : ''}
                    ${imgHtml}
                 </div>`;
             });
        };

        window.app.generateReport = function() {
            const type = document.getElementById('report-type').value;
            const start = new Date(document.getElementById('report-start-date').value);
            const end = new Date(document.getElementById('report-end-date').value); end.setHours(23,59,59);
            const container = document.getElementById('report-preview-container'); const content = document.getElementById('report-content'); const title = document.getElementById('report-title'); const subtitle = document.getElementById('report-subtitle');
            container.classList.remove('hidden'); document.getElementById('report-actions').classList.remove('hidden');
            subtitle.textContent = `æŸ¥è©¢å€é–“: ${start.toISOString().slice(0,10)} ~ ${end.toISOString().slice(0,10)}`; document.getElementById('report-timestamp').textContent = new Date().toLocaleString();
            let html = '<table style="width:100%; border-collapse: collapse; font-size: 14px; text-align: left;">'; const thStyle = 'border: 1px solid #94a3b8; padding: 8px; background-color: #f1f5f9; font-weight: bold;'; const tdStyle = 'border: 1px solid #94a3b8; padding: 8px;';
            if (type === 'checklist') {
                title.textContent = "è¨­å‚™é»æª¢ç´€éŒ„è¡¨";
                html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é»æª¢äºº</th><th style="${thStyle}">çµæœ</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`;
                const filtered = checkHistory.filter(h => { const d = h.checkTimestamp?.toDate(); return d >= start && d <= end; }).sort((a,b) => b.checkTimestamp.seconds - a.checkTimestamp.seconds);
                if(filtered.length === 0) html += `<tr><td colspan="5" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`;
                filtered.forEach(r => {
                    const date = r.checkTimestamp?.toDate().toLocaleString(); const abItems = r.items.filter(i => i.status === 'ç•°å¸¸'); const resultHtml = abItems.length > 0 ? `<span style="color:red; font-weight:bold;">ç•°å¸¸ (${abItems.length})</span><br><span style="font-size:12px; color:#64748b;">${abItems.map(i=>i.text).join(', ')}</span>` : '<span style="color:green;">æ­£å¸¸</span>';
                    html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${resultHtml}</td><td style="${tdStyle}">${r.summaryNotes || ''}</td></tr>`;
                });
            } else {
                title.textContent = "è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„è¡¨";
                html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é¡å‹</th><th style="${thStyle}">é …ç›®</th><th style="${thStyle}">åŸ·è¡Œäºº</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`;
                const filtered = maintenanceHistory.filter(h => { const d = h.timestamp?.toDate(); return d >= start && d <= end; }).sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
                if(filtered.length === 0) html += `<tr><td colspan="6" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`;
                filtered.forEach(r => {
                    const date = r.timestamp?.toDate().toLocaleString(); const typeStr = r.type === 'cleaning' ? 'æ¸…æ½”' : 'æ›´æ›';
                    html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${typeStr}</td><td style="${tdStyle}">${r.componentName || '-'}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${r.notes || ''}</td></tr>`;
                });
            }
            html += '</tbody></table>'; content.innerHTML = html;
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `<div style="text-align:center; margin-bottom:20px;"><h1>${title.textContent}</h1><p>${subtitle.textContent}</p></div>${html}<div style="text-align:right; margin-top:20px; font-size:12px; color:#666;">è£½è¡¨æ™‚é–“: ${document.getElementById('report-timestamp').textContent}</div>`;
        };
        window.app.printReport = function() { window.print(); };

        window.app.showScanner = function() {
            document.getElementById('qr-scanner-modal').classList.remove('hidden'); document.getElementById('qr-scanner-content').classList.remove('hidden');
            if(!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, (decodedText) => {
                 window.app.hideScanner();
                 let id = decodedText; try { const url = new URL(decodedText); const paramId = url.searchParams.get('id'); if(paramId) id = paramId; } catch(e) {}
                 window.app.handleScanResult(id);
            }).catch(err => { document.getElementById('qr-reader').innerHTML = `<p class="text-red-500 p-4">ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ (éœ€ HTTPS)</p>`; });
        };
        window.app.handleScanResult = function(id) {
            const eq = equipmentDatabase[id];
            if (!eq) { showToast("æ‰¾ä¸åˆ°å°æ‡‰çš„è¨­å‚™ ID: " + id, "error"); return; }
            document.getElementById('scan-match-name').textContent = eq.name;
            const btnCheck = document.getElementById('btn-scan-checklist'); const btnMaint = document.getElementById('btn-scan-maintenance');
            
            // è¨ªå®¢ç¦ç”¨æƒæå¾Œçš„æ“ä½œ
            if(loggedInUser.role === 'guest') {
                btnCheck.disabled = true; btnCheck.classList.add('opacity-50', 'cursor-not-allowed');
                btnMaint.disabled = true; btnMaint.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btnCheck.disabled = false; btnCheck.classList.remove('opacity-50', 'cursor-not-allowed');
                btnMaint.disabled = false; btnMaint.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            btnCheck.onclick = () => { document.getElementById('scan-action-modal').classList.add('hidden'); startChecklist(id); };
            btnMaint.onclick = () => { document.getElementById('scan-action-modal').classList.add('hidden'); window.app.showMaintenanceModal(id); };
            document.getElementById('scan-action-modal').classList.remove('hidden'); document.getElementById('scan-action-content').classList.remove('hidden');
        };
        window.app.hideScanner = function() { if(html5QrCode) html5QrCode.stop().catch(e=>{}); document.getElementById('qr-scanner-modal').classList.add('hidden'); };
        function showToast(msg, type='info') {
            const t = document.getElementById('toast-container'); const d = document.createElement('div');
            d.className = `p-3 rounded shadow text-white ${type==='error'?'bg-red-500':'bg-blue-500'}`; d.innerText = msg;
            t.appendChild(d); setTimeout(() => d.remove(), 3000);
        }

        init();
    </script>
</body>
</html>