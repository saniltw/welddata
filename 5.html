<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å‚™é»æª¢è¡¨ (å®Œç¾å¾©åˆ»ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .status-btn.selected { transform: scale(1.05); box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39); }
        .status-btn.selected-normal { background-color: #22c55e; color: white; border-color: #22c55e; }
        .status-btn.selected-abnormal { background-color: #ef4444; color: white; border-color: #ef4444; }
        .status-btn.selected-na { background-color: #64748b; color: white; border-color: #64748b; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border: 1px solid #e5e7eb; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none; appearance: none;
        }
        .admin-tab-active { color: #4f46e5; border-color: #4f46e5; }
        .eq-tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .eq-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        .eq-tab-inactive:hover { color: #374151; border-color: #d1d5db; }
        .status-dot { height: 0.6rem; width: 0.6rem; border-radius: 50%; display: inline-block; margin-right: 0.3rem; }
        .status-dot.active { background-color: #22c55e; }
        .status-dot.repair { background-color: #eab308; }
        .status-dot.unused { background-color: #9ca3af; }

        @media print {
            body > * { display: none !important; }
            #print-area { display: block !important; }
            #print-area * { visibility: visible; }
            @page { size: auto; margin: 10mm; }
            html, body { height: auto; background: white; overflow: visible; }
        }
        #print-area { display: none; position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 9999; padding: 20px; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-slate-600">ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div id="print-area"></div>

    <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 md:p-8">
        
        <div class="flex justify-between items-center mb-6">
            <div id="user-status" class="text-sm flex items-center">
                <div id="logged-in-view" class="hidden">
                    <span>ç•¶å‰ä½¿ç”¨è€…: <strong id="logged-in-name" class="text-indigo-600 font-semibold"></strong></span>
                </div>
            </div>
            <button id="toggle-mode-btn" onclick="window.app.toggleManagementMode()" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 text-sm hidden">âš™ï¸ ç®¡ç†å¾Œå°</button>
        </div>

        <!-- ä½¿ç”¨è€…é»æª¢æ¨¡å¼ -->
        <div id="user-mode">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-slate-800">è¨­å‚™é»æª¢</h1>
                <p id="header-subtitle" class="text-slate-500 mt-2">ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæ QR Code æˆ–æ‰‹å‹•é¸æ“‡</p>
            </header>

            <div id="main-content" class="hidden space-y-6">
                <div id="scan-section" class="card text-center p-8">
                    <button onclick="window.app.showScanner()" class="bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-indigo-700 transition-transform hover:scale-105 flex items-center justify-center mx-auto">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                        é–‹å•Ÿç¶²é æƒæå™¨
                    </button>
                    <p class="text-sm text-gray-500 mt-3">ğŸ’¡ æç¤ºï¼šæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæè¨­å‚™ä¸Šçš„ QR Code</p>
                </div>

                <div id="manual-select-section" class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">æ‰‹å‹•é¸æ“‡è¨­å‚™</h2>
                    <div class="space-y-4">
                        <select id="manual-category-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm"><option value="">è¼‰å…¥ä¸­...</option></select>
                        <select id="manual-device-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm" disabled><option value="">è«‹å…ˆé¸æ“‡å¤§é¡...</option></select>
                        <button onclick="window.app.handleManualSelection()" id="manual-start-button" class="w-full bg-slate-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-slate-700 disabled:bg-slate-400" disabled>é–‹å§‹é»æª¢</button>
                    </div>
                </div>
            </div>

            <div id="checklist-section" class="hidden space-y-6">
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4 border-b pb-3">è¨­å‚™è³‡è¨Š</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div><label class="text-slate-500">è¨­å‚™åç¨±</label><p id="device-name" class="font-bold text-slate-700 text-lg"></p></div>
                        <div><label class="text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><p id="device-asset-no" class="font-semibold text-slate-700"></p></div>
                        <div><label class="text-slate-500">é»æª¢äººå“¡</label><p id="user-name-display" class="font-semibold text-slate-700"></p></div>
                        <div><label class="text-slate-500">é»æª¢æ—¥æœŸ</label><p id="check-date" class="font-semibold text-slate-700"></p></div>
                    </div>
                </div>
                <div id="checklist-items-container" class="space-y-6"></div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">ç¸½çµå‚™è¨»</h2>
                    <textarea id="summary-notes" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="window.app.resetApp()" class="w-1/3 bg-slate-500 text-white font-bold py-3 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button onclick="window.app.submitChecklist(this)" class="w-2/3 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">æäº¤</button>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†è€…æ¨¡å¼ -->
        <div id="admin-mode" class="hidden">
            <header class="mb-6"><h1 class="text-4xl font-bold text-slate-800">ç®¡ç†å¾Œå°</h1></header>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-4 overflow-x-auto text-sm font-medium">
                    <button onclick="window.app.switchAdminTab('equipment')" id="tab-equipment" class="px-1 py-3 border-b-2 admin-tab-active">è¨­å‚™ç®¡ç†</button>
                    <button onclick="window.app.switchAdminTab('templates')" id="tab-templates" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">é»æª¢ç¯„æœ¬</button>
                    <button onclick="window.app.switchAdminTab('users')" id="tab-users" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">äººå“¡ç®¡ç†</button>
                    <button onclick="window.app.switchAdminTab('checklistHistory')" id="tab-checklistHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">é»æª¢ç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('maintenanceHistory')" id="tab-maintenanceHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">ä¿é¤Šç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('reports')" id="tab-reports" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">å ±è¡¨è¼¸å‡º</button>
                </nav>
            </div>
            
            <!-- è¨­å‚™ç®¡ç† -->
            <div id="admin-tab-content-equipment">
                <div id="equipment-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">è¨­å‚™åˆ—è¡¨</h2>
                        <button onclick="window.app.showEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm">æ–°å¢è¨­å‚™</button>
                    </div>
                    <div id="equipment-category-tabs" class="mb-4 border-b border-gray-200 overflow-x-auto"></div>
                    <div id="equipment-list-container"></div>
                </div>
                
                <div id="equipment-editor-section" class="hidden card p-6">
                    <h2 id="editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯è¨­å‚™</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™ç·¨è™Ÿ (ID)</label><input type="text" id="edit-device-id" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™åç¨±</label><input type="text" id="edit-device-name" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™å€åˆ†</label><select id="edit-device-category-select" class="w-full p-2 border rounded mb-2"></select><input type="text" id="edit-device-category-new" class="w-full p-2 border rounded hidden" placeholder="è¼¸å…¥æ–°åˆ†é¡..."></div>
                            <div><label class="block text-xs font-medium text-slate-500">æ”¾ç½®åœ°é»</label><input type="text" id="edit-device-location" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><input type="text" id="edit-device-asset" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">ç¾æ³</label><select id="edit-device-status" class="w-full p-2 border rounded form-select"><option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option><option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option><option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option></select></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">é»æª¢é€±æœŸ (å¤©)</label><input type="number" id="edit-device-cycle" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">ä¸‹æ¬¡é»æª¢æ—¥</label><input type="date" id="edit-device-next-date" class="w-full p-2 border rounded"></div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-2">æˆæ¬Šäººå“¡</label>
                            <div id="user-assignment-container" class="w-full p-3 border rounded h-32 overflow-y-auto bg-slate-50 grid grid-cols-2 gap-2"></div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-2">è¨­å‚™åœ–ç‰‡</label>
                            <div class="flex items-center gap-4">
                                <img id="image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border">
                                <button type="button" onclick="document.getElementById('edit-device-image').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ä¸Šå‚³åœ–ç‰‡</button>
                                <input type="file" id="edit-device-image" accept="image/*" class="hidden" onchange="window.app.handleImageUpload(this)">
                            </div>
                        </div>

                        <hr class="my-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700">é»æª¢é …ç›®è¨­å®š</h3>
                            <button onclick="window.app.showTemplateModal()" class="text-sm bg-teal-500 text-white px-3 py-1 rounded hover:bg-teal-600">ğŸ“‘ å¾ç¯„æœ¬è¼‰å…¥</button>
                        </div>
                        <div id="item-editor-container" class="space-y-4"></div>
                        <button onclick="window.app.addCategoryEditor(null, 'item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button>

                        <hr class="my-4">
                        <h3 class="font-bold text-slate-700">å¯æ›´æ›é›¶ä»¶ç®¡ç† (è€—æ)</h3>
                        <div id="component-editor-container" class="space-y-2"></div>
                        <button onclick="window.app.addComponentEditor()" class="w-full bg-gray-100 text-gray-700 py-2 rounded border border-gray-300 hover:bg-gray-200">ï¼‹ æ–°å¢é›¶ä»¶</button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveEquipment(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </div>

            <!-- å…¶ä»–ç®¡ç†é é¢ (ç¯„æœ¬, äººå“¡, å ±è¡¨, ç´€éŒ„) -->
            <div id="admin-tab-content-templates" class="hidden">
                <div id="template-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">é»æª¢ç¯„æœ¬ç®¡ç†</h2>
                        <button onclick="window.app.showTemplateEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm">æ–°å¢ç¯„æœ¬</button>
                    </div>
                    <div id="template-list-container" class="space-y-3"></div>
                </div>
                <div id="template-editor-section" class="hidden card p-6">
                    <h2 id="template-editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯ç¯„æœ¬</h2>
                    <div class="space-y-4">
                        <input type="hidden" id="edit-template-id">
                        <div><label class="block text-xs font-medium text-slate-500">ç¯„æœ¬åç¨±</label><input type="text" id="edit-template-name" class="w-full p-2 border rounded" placeholder="ä¾‹å¦‚ï¼šå †é«˜æ©Ÿé€šç”¨æª¢æŸ¥è¡¨"></div>
                        <hr class="my-4">
                        <h3 class="font-bold text-slate-700">ç¯„æœ¬é …ç›®è¨­å®š</h3>
                        <div id="template-item-editor-container" class="space-y-4"></div>
                        <button onclick="window.app.addCategoryEditor(null, 'template-item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showTemplateList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveTemplate(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜ç¯„æœ¬</button>
                    </div>
                </div>
            </div>
            
            <div id="admin-tab-content-users" class="hidden">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">äººå“¡åˆ—è¡¨</h2><button onclick="window.app.showUserEditor()" class="bg-indigo-600 text-white px-4 py-2 rounded">æ–°å¢</button></div>
                <div id="user-list-container" class="space-y-2"></div>
                <div id="user-editor-section" class="hidden card p-6">
                    <h2 id="user-editor-title" class="text-xl font-bold mb-4">ç·¨è¼¯äººå“¡</h2>
                    <div class="space-y-3">
                        <input type="text" id="edit-user-id" placeholder="ID" class="w-full p-2 border rounded">
                        <input type="text" id="edit-user-name" placeholder="å§“å" class="w-full p-2 border rounded">
                        <select id="edit-user-role" class="w-full p-2 border rounded"><option value="operator">æ“ä½œå“¡</option><option value="manager">ä¸»ç®¡</option></select>
                        <input type="password" id="edit-user-password" placeholder="å¯†ç¢¼ (ä¸»ç®¡å¿…å¡«)" class="w-full p-2 border rounded hidden">
                    </div>
                    <div class="flex justify-end gap-2 mt-4"><button onclick="window.app.showUserList()" class="bg-gray-200 px-4 py-2 rounded">å–æ¶ˆ</button><button onclick="window.app.saveUser(this)" class="bg-indigo-600 text-white px-4 py-2 rounded">å„²å­˜</button></div>
                </div>
            </div>

             <div id="admin-tab-content-reports" class="hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-slate-800">å ±è¡¨è¼¸å‡ºä¸­å¿ƒ</h2>
                 <div class="card p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="block text-xs font-medium text-slate-500 mb-1">å ±è¡¨é¡å‹</label><select id="report-type" class="w-full p-2 border rounded bg-white"><option value="checklist">è¨­å‚™é»æª¢ç´€éŒ„è¡¨</option><option value="maintenance">ä¿é¤Šç¶­ä¿®ç´€éŒ„è¡¨</option></select></div>
                        <div><label class="block text-xs font-medium text-slate-500 mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date" id="report-start-date" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-xs font-medium text-slate-500 mb-1">çµæŸæ—¥æœŸ</label><input type="date" id="report-end-date" class="w-full p-2 border rounded"></div>
                        <div class="flex items-end"><button onclick="window.app.generateReport()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">ç”¢ç”Ÿå ±è¡¨</button></div>
                    </div>
                 </div>
                 <div id="report-preview-container" class="bg-white p-8 shadow-lg rounded-lg min-h-[500px] hidden">
                     <div class="text-center border-b-2 border-slate-800 pb-4 mb-6">
                         <h1 class="text-3xl font-bold text-slate-900 mb-2" id="report-title">è¨­å‚™ç´€éŒ„å ±è¡¨</h1>
                         <p class="text-slate-600" id="report-subtitle">æŸ¥è©¢å€é–“: </p>
                     </div>
                     <div id="report-content" class="overflow-x-auto"></div>
                     <div class="mt-8 text-right text-sm text-slate-500"><p>è£½è¡¨æ™‚é–“: <span id="report-timestamp"></span></p></div>
                 </div>
                 <div id="report-actions" class="mt-4 flex justify-end gap-3 hidden">
                     <button onclick="window.app.printReport()" class="bg-slate-700 text-white font-bold py-2 px-6 rounded hover:bg-slate-800 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>åˆ—å° / å¦å­˜ PDF</button>
                 </div>
             </div>

             <div id="admin-tab-content-checklistHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™é»æª¢æ­·å²ç´€éŒ„</h2>
                <div id="checklist-history-log-container"></div>
             </div>
             <div id="admin-tab-content-maintenanceHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„</h2>
                <div id="maintenance-history-log-container"></div>
             </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- æƒæå¾Œå‹•ä½œé¸æ“‡ Modal -->
    <div id="scan-action-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[140] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center hidden" id="scan-action-content">
             <h3 class="text-xl font-bold mb-2 text-slate-800">æƒææˆåŠŸ</h3>
             <p id="scan-match-name" class="text-lg text-indigo-600 font-bold mb-6">è¨­å‚™åç¨±</p>
             <div class="space-y-3">
                 <button id="btn-scan-checklist" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2">ğŸ“‹ é–‹å§‹é»æª¢</button>
                 <button id="btn-scan-maintenance" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 shadow-md flex items-center justify-center gap-2">ğŸ”§ è¨˜éŒ„ä¿é¤Š</button>
                 <button onclick="document.getElementById('scan-action-modal').classList.add('hidden')" class="w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300">å–æ¶ˆ</button>
             </div>
        </div>
    </div>

    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">é¸æ“‡ç¯„æœ¬</h3>
            <div id="template-selection-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button onclick="window.app.closeTemplateModal()" class="mt-4 w-full bg-slate-200 py-2 rounded">é—œé–‰</button>
        </div>
    </div>

    <!-- ä¿é¤Šç´€éŒ„è¦–çª— -->
    <div id="maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h2 class="text-2xl font-semibold mb-4 text-slate-800">æ–°å¢ä¿é¤Šç´€éŒ„</h2>
            <p id="maint-device-name" class="mb-4 text-slate-600"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600">ä¿é¤Šé¡å‹</label>
                    <select id="maintenance-type" class="w-full p-2 border rounded mt-1" onchange="window.app.toggleMaintType()">
                        <option value="cleaning">æ©Ÿå°æ¸…æ½”</option>
                        <option value="replacement">é›¶ä»¶æ›´æ›</option>
                    </select>
                </div>
                <div id="maintenance-component-selector" class="hidden">
                    <label class="block text-sm font-medium text-slate-600">æ›´æ›é›¶ä»¶</label>
                    <select id="maintenance-component-name" class="w-full p-2 border rounded mt-1"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">å‚™è¨»èªªæ˜</label>
                    <textarea id="maintenance-notes" class="w-full p-2 border rounded mt-1" rows="3"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="window.app.closeMaintenanceModal()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                <button onclick="window.app.logMaintenance(this)" class="bg-orange-500 text-white py-2 px-4 rounded font-bold">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal (å·²å‡ç´šï¼šå«ä¸‹è¼‰æŒ‰éˆ• & æ–‡å­—åˆæˆ) -->
    <div id="qr-code-display-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[130] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 text-center max-w-sm w-full hidden" id="qr-display-content">
            <h3 class="text-xl font-bold mb-2">è¨­å‚™ QR Code</h3>
            <p id="qr-display-name" class="text-gray-600 mb-4"></p>
            <!-- å®¹å™¨æ¸…ç©ºï¼Œæ”¹ç”± JS å‹•æ…‹æ’å…¥ Canvas -->
            <div id="qr-code-container" class="flex justify-center mb-4 border p-2 rounded bg-white"></div>
            <p class="text-xs text-gray-400 mb-4">ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæå³å¯ç›´æ¥é–‹å•Ÿ</p>
            <div class="space-y-2">
                <button onclick="window.app.downloadQRCode()" class="w-full bg-indigo-600 text-white font-bold px-4 py-2 rounded hover:bg-indigo-700 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è¼‰åœ–ç‰‡
                </button>
                <button onclick="document.getElementById('qr-code-display-modal').classList.add('hidden')" class="w-full bg-slate-200 text-gray-700 font-bold px-4 py-2 rounded hover:bg-slate-300">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-50 flex">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center hidden" id="qr-scanner-content">
            <h3 class="text-2xl font-bold mb-4">æƒæè¨­å‚™ QR Code</h3>
            <div id="qr-reader" class="w-full"></div>
            <button onclick="window.app.hideScanner()" class="w-full bg-slate-500 text-white p-3 rounded-lg mt-4">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-[110] space-y-3 w-full max-w-xs"></div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPpMCssbitCn2wE7WEqefL2czjIsRuyBw",
            authDomain: "checklist-20250825.firebaseapp.com",
            databaseURL: "https://checklist-20250825-default-rtdb.firebaseio.com",
            projectId: "checklist-20250825",
            storageBucket: "checklist-20250825.appspot.com",
            messagingSenderId: "899658463753",
            appId: "1:899658463753:web:71819671db2cdf6bf4d6d8",
            measurementId: "G-FH3F97BZ7F"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function getCollectionRef(name) { return collection(db, name); }
        function getDocRef(colName, docId) { return doc(db, colName, docId); }

        let equipmentDatabase = {}, userDatabase = {}, templateDatabase = {}, checkHistory = [], maintenanceHistory = [];
        let loggedInUser = null, currentCheckId = null, html5QrCode = null, currentMaintEqId = null;
        let currentQrId = null; // Store current QR ID for filename

        window.app = {};

        const init = () => {
            console.log("åˆå§‹åŒ– Firebase...");
            // URL Parameter Check for Deep Linking
            const urlParams = new URLSearchParams(window.location.search);
            const scanId = urlParams.get('id');
            if(scanId) {
                console.log("åµæ¸¬åˆ°æƒæ ID:", scanId);
                window.app.pendingScanId = scanId;
            }

            loggedInUser = { id: 'default_admin', name: 'é è¨­æ“ä½œå“¡', role: 'manager' };
            updateUIState();
            startListeners();
            const today = new Date().toISOString().slice(0,10);
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
        };

        function startListeners() {
            const onError = (error) => {
                console.error("Listener Error:", error);
                if (error.code === 'permission-denied') showToast("æ¬Šé™ä¸è¶³", 'error');
            };

            onSnapshot(getCollectionRef("users"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                userDatabase = newData;
                if (document.getElementById('user-list-container').offsetParent) window.app.renderUserList();
                document.getElementById('loading-overlay').classList.add('hidden');
            }, onError);

            onSnapshot(getCollectionRef("equipment"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                equipmentDatabase = newData;
                if (document.getElementById('equipment-list-section').offsetParent) window.app.renderEquipmentList();
                populateManualDropdown();
                
                // Handle Pending Deep Link (Scan)
                if(window.app.pendingScanId) {
                    if(equipmentDatabase[window.app.pendingScanId]) {
                        window.app.handleScanResult(window.app.pendingScanId);
                        window.app.pendingScanId = null; // Clear it
                        try { window.history.replaceState({}, document.title, window.location.pathname); } catch(e){}
                    }
                }
            }, onError);

            onSnapshot(getCollectionRef("checklist_templates"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                templateDatabase = newData;
                if (document.getElementById('template-list-section').offsetParent) window.app.renderTemplateList();
            }, onError);

            onSnapshot(getCollectionRef("check_history"), (snap) => {
                checkHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('admin-tab-content-checklistHistory').offsetParent) window.app.renderChecklistHistory();
            }, onError);

            onSnapshot(getCollectionRef("maintenance_history"), (snap) => {
                maintenanceHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('admin-tab-content-maintenanceHistory').offsetParent) window.app.renderMaintenanceHistory();
            }, onError);
        }

        window.app.logout = () => {}; 

        function updateUIState() {
            document.getElementById('logged-in-view').classList.remove('hidden');
            document.getElementById('logged-in-name').textContent = loggedInUser.name;
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('toggle-mode-btn').classList.remove('hidden');
            populateManualDropdown();
        }
        
        function populateManualDropdown() {
            const sel = document.getElementById('manual-category-select');
            const devSel = document.getElementById('manual-device-select');
            if (!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) return;
            const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))];
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">è«‹é¸æ“‡å¤§é¡...</option>';
            cats.forEach(c => sel.add(new Option(c, c)));
            if (currentVal && cats.includes(currentVal)) sel.value = currentVal;
            sel.onchange = () => {
                devSel.innerHTML = '<option value="">è«‹é¸æ“‡è¨­å‚™...</option>';
                devSel.disabled = false;
                Object.values(equipmentDatabase).filter(e => (e.category || 'æœªåˆ†é¡') === sel.value).forEach(e => devSel.add(new Option(e.name, e.id)));
                document.getElementById('manual-start-button').disabled = true;
            };
            devSel.onchange = () => document.getElementById('manual-start-button').disabled = !devSel.value;
        }

        window.app.handleManualSelection = () => {
             const id = document.getElementById('manual-device-select').value;
             startChecklist(id);
        };

        function startChecklist(id) {
            const eq = equipmentDatabase[id];
            if (!eq) return;
            currentCheckId = id;
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('checklist-section').classList.remove('hidden');
            document.getElementById('device-name').textContent = eq.name;
            document.getElementById('device-asset-no').textContent = eq.assetNumber || 'ç„¡';
            document.getElementById('user-name-display').textContent = loggedInUser.name;
            document.getElementById('check-date').textContent = new Date().toISOString().slice(0,10);
            const container = document.getElementById('checklist-items-container');
            container.innerHTML = '';
            if (eq.items) {
                eq.items.forEach(cat => {
                    const group = document.createElement('div');
                    group.innerHTML = `<h3 class="font-bold text-lg mb-2 text-slate-600 border-b pb-1">${cat.category}</h3>`;
                    cat.subItems.forEach(item => {
                        group.innerHTML += `
                        <div class="card p-4 mb-3 item-row" data-cat="${cat.category}" data-text="${item.text}">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-800 font-medium">${item.text}</span>
                                <div class="space-x-1 flex-shrink-0">
                                    <button onclick="window.app.setStatus(this, 'normal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">æ­£å¸¸</button>
                                    <button onclick="window.app.setStatus(this, 'abnormal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">ç•°å¸¸</button>
                                </div>
                            </div>
                            <input type="text" class="abnormal-input hidden w-full mt-2 p-2 border rounded text-sm bg-red-50 text-red-700 placeholder-red-300" placeholder="è«‹èªªæ˜ç•°å¸¸åŸå› ...">
                        </div>`;
                    });
                    container.appendChild(group);
                });
            }
        }

        window.app.setStatus = function(btn, status) {
            const row = btn.closest('.item-row');
            row.querySelectorAll('.status-btn').forEach(b => {
                b.classList.remove('selected', 'selected-normal', 'selected-abnormal', 'bg-green-500', 'bg-red-500', 'text-white');
            });
            btn.classList.add('selected');
            if(status === 'normal') btn.classList.add('selected-normal', 'bg-green-500', 'text-white');
            else btn.classList.add('selected-abnormal', 'bg-red-500', 'text-white');
            
            const input = row.querySelector('.abnormal-input');
            if(status === 'abnormal') input.classList.remove('hidden'); else input.classList.add('hidden');
            row.dataset.status = status;
        };

        window.app.submitChecklist = async function(btn) {
            btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
            try {
                const rows = document.querySelectorAll('.item-row');
                const items = [];
                rows.forEach(r => {
                    items.push({
                        category: r.dataset.cat,
                        text: r.dataset.text,
                        status: r.dataset.status === 'abnormal' ? 'ç•°å¸¸' : 'æ­£å¸¸',
                        details: r.querySelector('.abnormal-input').value
                    });
                });
                const record = {
                    deviceId: currentCheckId,
                    deviceName: equipmentDatabase[currentCheckId].name,
                    userId: loggedInUser.id,
                    userName: loggedInUser.name,
                    checkTimestamp: serverTimestamp(),
                    summaryNotes: document.getElementById('summary-notes').value,
                    items: items
                };
                await setDoc(doc(getCollectionRef("check_history")), record);
                const cycle = parseInt(equipmentDatabase[currentCheckId].checkCycleDays) || 7;
                const nextDate = new Date();
                nextDate.setDate(nextDate.getDate() + cycle);
                await updateDoc(getDocRef("equipment", currentCheckId), { nextCheckDate: nextDate.toISOString().slice(0,10) });
                showToast('æäº¤æˆåŠŸ', 'success');
                window.app.resetApp();
            } catch (e) {
                console.error(e);
                showToast('æäº¤å¤±æ•—: ' + e.message, 'error');
            } finally {
                btn.disabled = false; btn.innerText = "æäº¤";
            }
        };

        window.app.resetApp = function() {
            document.getElementById('checklist-section').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            currentCheckId = null;
        };

        // --- å¾Œå°ç®¡ç† ---
        window.app.toggleManagementMode = function() {
            const userMode = document.getElementById('user-mode');
            const adminMode = document.getElementById('admin-mode');
            const btn = document.getElementById('toggle-mode-btn');
            if (userMode.classList.contains('hidden')) {
                userMode.classList.remove('hidden'); adminMode.classList.add('hidden');
                btn.textContent = "âš™ï¸ ç®¡ç†å¾Œå°";
            } else {
                userMode.classList.add('hidden'); adminMode.classList.remove('hidden');
                btn.textContent = "â¬…ï¸ è¿”å›é»æª¢";
                window.app.renderEquipmentList();
            }
        };

        window.app.switchAdminTab = function(tab) {
            document.querySelectorAll('[id^=admin-tab-content]').forEach(d => d.classList.add('hidden'));
            document.getElementById(`admin-tab-content-${tab}`).classList.remove('hidden');
            document.querySelectorAll('#admin-mode nav button').forEach(b => b.classList.remove('admin-tab-active', 'text-indigo-600'));
            document.getElementById(`tab-${tab}`).classList.add('admin-tab-active');
            
            if(tab === 'users') window.app.renderUserList();
            if(tab === 'equipment') window.app.renderEquipmentList();
            if(tab === 'templates') window.app.renderTemplateList();
            if(tab === 'checklistHistory') window.app.renderChecklistHistory();
            if(tab === 'maintenanceHistory') window.app.renderMaintenanceHistory();
        };

        // è¨­å‚™ç®¡ç† (Updated Render to match screenshot)
        window.app.renderEquipmentList = function() {
            const tabsContainer = document.getElementById('equipment-category-tabs');
            const listContainer = document.getElementById('equipment-list-container');
            if(!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 py-4">ç„¡è³‡æ–™</p>'; tabsContainer.innerHTML = ''; return;
            }
            const groups = {};
            Object.values(equipmentDatabase).forEach(eq => {
                const cat = eq.category || 'æœªåˆ†é¡';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(eq);
            });
            const categories = Object.keys(groups).sort((a, b) => a.localeCompare(b, 'zh-TW'));
            let tabsHtml = '<nav class="flex -mb-px space-x-6 overflow-x-auto">';
            categories.forEach((cat, index) => {
                const activeClass = index === 0 ? 'eq-tab-active' : 'eq-tab-inactive';
                tabsHtml += `<button onclick="window.app.switchEqTab('${cat}')" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors ${activeClass}" id="tab-btn-${cat}">${cat}</button>`;
            });
            tabsHtml += '</nav>';
            tabsContainer.innerHTML = tabsHtml;
            let listHtml = '';
            categories.forEach((cat, index) => {
                const hiddenClass = index === 0 ? '' : 'hidden';
                listHtml += `<div id="cat-content-${cat}" class="${hiddenClass} animate-fade-in space-y-3">`;
                groups[cat].forEach(eq => {
                    const imgUrl = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡';
                    let statusClass = 'active'; if(eq.status==='ç¶­ä¿®ä¸­') statusClass='repair'; else if(eq.status==='æœªä½¿ç”¨') statusClass='unused';
                    listHtml += `
                    <div class="card p-4 flex flex-col sm:flex-row items-center gap-4">
                        <img src="${imgUrl}" class="w-24 h-24 object-cover rounded-md border flex-shrink-0">
                        <div class="flex-grow text-center sm:text-left w-full">
                            <h3 class="font-bold text-lg text-slate-800"><span class="status-dot ${statusClass}"></span>${eq.name}</h3>
                            <p class="text-sm text-slate-500 mt-1">ID: ${eq.id} | åœ°é»: ${eq.location || 'æœªè¨­å®š'}</p>
                            <p class="text-xs text-gray-400 mt-2">ä¸‹æ¬¡é»æª¢: ${eq.nextCheckDate || 'æœªè¨­å®š'}</p>
                            <p class="text-xs text-gray-400">ä¸‹æ¬¡æ¸…æ½”: ${eq.nextCleaningDate || 'æœªè¨­å®š'}</p>
                        </div>
                        <div class="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto mt-2 sm:mt-0">
                            <button onclick="window.app.showQRCode('${eq.id}', '${eq.name}')" class="bg-green-500 text-white text-sm font-bold px-3 py-2 rounded hover:bg-green-600 transition-colors">QR Code</button>
                            <button onclick="window.app.showMaintenanceModal('${eq.id}')" class="bg-orange-500 text-white text-sm font-bold px-3 py-2 rounded hover:bg-orange-600 transition-colors">ä¿é¤Š</button>
                            <button onclick="window.app.showEditor('${eq.id}')" class="bg-blue-600 text-white text-sm font-bold px-3 py-2 rounded hover:bg-blue-700 transition-colors">ç·¨è¼¯</button>
                            <button onclick="window.app.deleteEquipment('${eq.id}')" class="bg-red-500 text-white text-sm font-bold px-3 py-2 rounded hover:bg-red-600 transition-colors">åˆªé™¤</button>
                        </div>
                    </div>`;
                });
                listHtml += '</div>';
            });
            listContainer.innerHTML = listHtml;
        };

        window.app.switchEqTab = function(cat) {
            document.querySelectorAll('#equipment-category-tabs button').forEach(btn => {
                if (btn.id === `tab-btn-${cat}`) { btn.classList.remove('eq-tab-inactive'); btn.classList.add('eq-tab-active'); } 
                else { btn.classList.remove('eq-tab-active'); btn.classList.add('eq-tab-inactive'); }
            });
            document.querySelectorAll('[id^="cat-content-"]').forEach(div => div.classList.add('hidden'));
            document.getElementById(`cat-content-${cat}`).classList.remove('hidden');
        };

        window.app.deleteEquipment = async function(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¨­å‚™ï¼Ÿ')) await deleteDoc(getDocRef("equipment", id));
        };

        // QR Code é¡¯ç¤ºèˆ‡ç”¢ç”ŸåŠŸèƒ½ (å·²å‡ç´š URL Based + Canvas Drawing)
        window.app.showQRCode = function(id, name) {
            currentQrId = id;
            const container = document.getElementById('qr-code-container');
            container.innerHTML = ''; // Clear previous content
            document.getElementById('qr-display-name').textContent = name;
            document.getElementById('qr-code-display-modal').classList.remove('hidden');
            document.getElementById('qr-display-content').classList.remove('hidden');

            // 1. æŒ‡å®šçš„å›ºå®šç¶²å€
            const baseUrl = "https://saniltw.github.io/welddata/5.html";
            const qrData = `${baseUrl}?id=${id}`;

            // 2. å…ˆåœ¨è¨˜æ†¶é«”ä¸­å»ºç«‹ä¸€å€‹éš±è—çš„ div ä¾†ç”¢ç”ŸåŸå§‹ QR Code
            const hiddenDiv = document.createElement('div');
            // è¨­å®šå¤§ä¸€é»çš„å°ºå¯¸ä»¥ç¢ºä¿åˆ—å°æ¸…æ™°
            new QRCode(hiddenDiv, { text: qrData, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H });

            // 3. ç­‰å¾… QR Code åœ–ç‰‡ç”Ÿæˆå¾Œï¼Œç¹ªè£½åˆ°æ–°çš„ Canvas ä¸Šä¸¦åŠ ä¸Šæ–‡å­—
            const checkQrImage = setInterval(() => {
                const qrImg = hiddenDiv.querySelector('img');
                if (qrImg && qrImg.src) {
                    clearInterval(checkQrImage);
                    // ç¢ºä¿åœ–ç‰‡è¼‰å…¥å®Œæˆ
                    const imgObj = new Image();
                    imgObj.onload = () => {
                         window.app.drawCompositeQRCode(imgObj, name, container);
                    };
                    imgObj.src = qrImg.src;
                } else {
                    // Fallback for canvas-based rendering (some browsers/settings)
                    const qrCanvas = hiddenDiv.querySelector('canvas');
                    if(qrCanvas) {
                        clearInterval(checkQrImage);
                        window.app.drawCompositeQRCode(qrCanvas, name, container);
                    }
                }
            }, 50);
        };

        // ç¹ªè£½åˆæˆåœ–ç‰‡ (QR Code + æ–‡å­—)
        window.app.drawCompositeQRCode = function(sourceImage, text, container) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è¨­å®šå°ºå¯¸
            const padding = 20;
            const qrSize = 200;
            const textBoxHeight = 50;
            const width = qrSize + (padding * 2);
            const height = qrSize + (padding * 2) + textBoxHeight;

            canvas.width = width;
            canvas.height = height;

            // 1. å¡«æ»¿ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // 2. ç¹ªè£½ QR Code
            ctx.drawImage(sourceImage, padding, padding, qrSize, qrSize);

            // 3. ç¹ªè£½æ–‡å­— (è¨­å‚™åç¨±)
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 18px "Noto Sans TC", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // è‡ªå‹•ç¸®å°æ–‡å­—ä»¥é©æ‡‰å¯¬åº¦
            let fontSize = 18;
            do {
                ctx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`;
                fontSize -= 1;
            } while (ctx.measureText(text).width > width - 20 && fontSize > 10);

            ctx.fillText(text, width / 2, height - (textBoxHeight / 2) - 5);

            // 4. åŠ å€‹å¤–æ¡† (é¸ç”¨ï¼Œå¢åŠ è³ªæ„Ÿ)
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.strokeRect(0, 0, width, height);

            // é¡¯ç¤ºåœ¨ç•«é¢ä¸Š (ç¸®æ”¾ä»¥é©æ‡‰è¢å¹•)
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            container.appendChild(canvas);
        };

        // ä¸‹è¼‰ QR Code åŠŸèƒ½ (ç›´æ¥ä¸‹è¼‰ Canvas)
        window.app.downloadQRCode = function() {
            const container = document.getElementById('qr-code-container');
            const canvas = container.querySelector('canvas');
            
            if(canvas) {
                const link = document.createElement('a');
                // æª”ååŠ ä¸Šè¨­å‚™åç¨±ï¼Œæ–¹ä¾¿è¾¨è­˜
                const deviceName = document.getElementById('qr-display-name').textContent || 'device';
                link.download = `QR-${deviceName}.png`;
                link.href = canvas.toDataURL("image/png");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                showToast("QR Code å°šæœªç”¢ç”Ÿï¼Œè«‹ç¨å€™", "error");
            }
        };

        // ä¿é¤ŠåŠŸèƒ½
        window.app.showMaintenanceModal = function(id) {
            currentMaintEqId = id;
            document.getElementById('maint-device-name').textContent = equipmentDatabase[id].name;
            const compSelect = document.getElementById('maintenance-component-name');
            compSelect.innerHTML = '';
            // Load components from equipment data
            const comps = equipmentDatabase[id].components || [];
            if(comps.length > 0) {
                comps.forEach(c => compSelect.add(new Option(c.name, c.name)));
            } else {
                compSelect.add(new Option('ç„¡é›¶ä»¶è³‡æ–™', ''));
            }
            window.app.toggleMaintType();
            document.getElementById('maintenance-modal').classList.remove('hidden');
        };

        window.app.toggleMaintType = function() {
            const type = document.getElementById('maintenance-type').value;
            const selector = document.getElementById('maintenance-component-selector');
            if(type === 'replacement') selector.classList.remove('hidden');
            else selector.classList.add('hidden');
        };

        window.app.closeMaintenanceModal = function() {
            document.getElementById('maintenance-modal').classList.add('hidden');
        };

        window.app.logMaintenance = async function(btn) {
            if(!currentMaintEqId) return;
            btn.disabled = true;
            const type = document.getElementById('maintenance-type').value;
            const notes = document.getElementById('maintenance-notes').value;
            const componentName = type === 'replacement' ? document.getElementById('maintenance-component-name').value : null;
            
            try {
                const record = {
                    deviceId: currentMaintEqId,
                    deviceName: equipmentDatabase[currentMaintEqId].name,
                    userId: loggedInUser.id,
                    userName: loggedInUser.name,
                    timestamp: serverTimestamp(),
                    type, notes, componentName
                };
                await setDoc(doc(getCollectionRef("maintenance_history")), record);
                
                // Update equipment cycles if needed (simplified logic)
                const updates = {};
                if(type === 'cleaning') {
                    // Assuming default 30 days if not set
                    const nextClean = new Date();
                    nextClean.setDate(nextClean.getDate() + 30); 
                    updates.nextCleaningDate = nextClean.toISOString().slice(0,10);
                }
                await updateDoc(getDocRef("equipment", currentMaintEqId), updates);

                showToast("ä¿é¤Šç´€éŒ„å·²å„²å­˜", "success");
                window.app.closeMaintenanceModal();
            } catch(e) {
                console.error(e);
                showToast("å„²å­˜å¤±æ•—", "error");
            } finally {
                btn.disabled = false;
            }
        };

        // åœ–ç‰‡ä¸Šå‚³
        window.app.handleImageUpload = function(input) {
            if(!input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    const preview = document.getElementById('image-preview');
                    preview.src = dataUrl; preview.dataset.imageDataUrl = dataUrl;
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        };

        // è¨­å‚™ç·¨è¼¯å™¨
        window.app.showEditor = function(id = null) {
            document.getElementById('equipment-list-section').classList.add('hidden');
            document.getElementById('equipment-editor-section').classList.remove('hidden');
            document.getElementById('item-editor-container').innerHTML = '';
            document.getElementById('component-editor-container').innerHTML = '';
            
            const sel = document.getElementById('edit-device-category-select');
            const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))];
            sel.innerHTML = '<option value="__new__">ï¼‹ æ–°å¢åˆ†é¡</option>';
            cats.forEach(c => sel.add(new Option(c, c)));
            
            const imgPreview = document.getElementById('image-preview');
            document.getElementById('edit-device-image').value = ''; 
            
            // æˆæ¬Šäººå“¡
            const userContainer = document.getElementById('user-assignment-container');
            userContainer.innerHTML = '';
            Object.values(userDatabase).forEach(u => {
                userContainer.innerHTML += `<label class="flex items-center space-x-2 text-sm p-1"><input type="checkbox" class="auth-user-cb rounded" value="${u.id}"><span class="text-gray-700">${u.name}</span></label>`;
            });

            if(id) {
                const eq = equipmentDatabase[id];
                document.getElementById('edit-device-id').value = eq.id;
                document.getElementById('edit-device-name').value = eq.name;
                document.getElementById('edit-device-location').value = eq.location || '';
                document.getElementById('edit-device-asset').value = eq.assetNumber || '';
                document.getElementById('edit-device-status').value = eq.status || 'ä½¿ç”¨ä¸­';
                document.getElementById('edit-device-cycle').value = eq.checkCycleDays || '';
                document.getElementById('edit-device-next-date').value = eq.nextCheckDate || '';
                if(eq.category) sel.value = eq.category;
                if(eq.items) eq.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container'));
                if(eq.components) eq.components.forEach(c => window.app.addComponentEditor(c));
                
                // Fix for authorizedUsers error: Check if array exists
                if(Array.isArray(eq.authorizedUsers)) {
                    eq.authorizedUsers.forEach(uid => {
                        const cb = userContainer.querySelector(`input[value="${uid}"]`);
                        if(cb) cb.checked = true;
                    });
                }
                
                imgPreview.src = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡';
                imgPreview.dataset.imageDataUrl = eq.imageUrl || '';
            } else {
                ['edit-device-id', 'edit-device-name', 'edit-device-location', 'edit-device-asset', 'edit-device-cycle', 'edit-device-next-date'].forEach(k=>document.getElementById(k).value='');
                imgPreview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡';
                imgPreview.dataset.imageDataUrl = '';
            }
        };

        window.app.addCategoryEditor = function(data = null, containerId = 'item-editor-container') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'editor-item border p-3 rounded bg-slate-50 mb-2';
            div.innerHTML = `
                <div class="flex justify-between mb-2">
                    <input type="text" class="cat-name p-1 border rounded w-1/2 font-bold" value="${data?.category || ''}" placeholder="åˆ†é¡åç¨± (å¦‚: å¤–è§€)">
                    <button onclick="this.closest('.editor-item').remove()" class="text-red-500 text-xs">åˆªé™¤</button>
                </div>
                <textarea class="sub-items w-full p-2 border rounded text-sm h-20" placeholder="é …ç›® (ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚: ç•°éŸ³, æ¼æ²¹)">${data?.subItems?.map(s => s.text).join(',') || ''}</textarea>
            `;
            container.appendChild(div);
        };

        // æ–°å¢é›¶ä»¶ç·¨è¼¯åŠŸèƒ½
        window.app.addComponentEditor = function(data = null) {
            const container = document.getElementById('component-editor-container');
            const div = document.createElement('div');
            div.className = 'component-item border p-2 rounded bg-white mb-2 flex space-x-2 items-center';
            div.innerHTML = `
                <input type="text" class="comp-name w-1/2 p-1 border rounded text-sm" value="${data?.name || ''}" placeholder="é›¶ä»¶åç¨±">
                <input type="number" class="comp-cycle w-1/4 p-1 border rounded text-sm" value="${data?.cycle || ''}" placeholder="é€±æœŸ(å¤©)">
                <button onclick="this.closest('.component-item').remove()" class="text-red-500 text-xs px-2">âœ•</button>
            `;
            container.appendChild(div);
        };

        window.app.saveEquipment = async function() {
            const id = document.getElementById('edit-device-id').value;
            const name = document.getElementById('edit-device-name').value;
            const catSelect = document.getElementById('edit-device-category-select');
            const cat = catSelect.value === '__new__' ? (document.getElementById('edit-device-category-new').value || 'æœªåˆ†é¡') : catSelect.value;
            
            const items = [];
            document.querySelectorAll('#item-editor-container .editor-item').forEach(el => {
                const cName = el.querySelector('.cat-name').value;
                const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text);
                if(cName) items.push({ category: cName, subItems: subs });
            });

            const components = [];
            document.querySelectorAll('#component-editor-container .component-item').forEach(el => {
                const cName = el.querySelector('.comp-name').value;
                const cCycle = el.querySelector('.comp-cycle').value;
                if(cName) components.push({ name: cName, cycle: cCycle });
            });

            const authorizedUsers = [];
            document.querySelectorAll('.auth-user-cb:checked').forEach(cb => authorizedUsers.push(cb.value));

            const imgPreview = document.getElementById('image-preview');
            const data = {
                name, category: cat, items, components, authorizedUsers,
                imageUrl: imgPreview.dataset.imageDataUrl || null,
                location: document.getElementById('edit-device-location').value,
                assetNumber: document.getElementById('edit-device-asset').value,
                status: document.getElementById('edit-device-status').value,
                checkCycleDays: parseInt(document.getElementById('edit-device-cycle').value) || 0,
                nextCheckDate: document.getElementById('edit-device-next-date').value
            };

            await setDoc(getDocRef("equipment", id), data, { merge: true });
            showToast('å„²å­˜æˆåŠŸ', 'success');
            window.app.showList();
        };
        
        window.app.showList = function() {
             document.getElementById('equipment-list-section').classList.remove('hidden');
             document.getElementById('equipment-editor-section').classList.add('hidden');
        };

        // ç¯„æœ¬ç®¡ç†
        window.app.renderTemplateList = function() {
            const container = document.getElementById('template-list-container');
            container.innerHTML = '';
            if(Object.keys(templateDatabase).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">å°šç„¡ç¯„æœ¬</p>'; return;
            }
            Object.values(templateDatabase).forEach(t => {
                container.innerHTML += `
                <div class="card p-4 flex justify-between items-center">
                    <span class="font-bold">${t.name}</span>
                    <div class="flex gap-2">
                        <button onclick="window.app.showTemplateEditor('${t.id}')" class="text-blue-600 text-sm border px-2 py-1 rounded">ç·¨è¼¯</button>
                        <button onclick="window.app.deleteTemplate('${t.id}')" class="text-red-600 text-sm border px-2 py-1 rounded">åˆªé™¤</button>
                    </div>
                </div>`;
            });
        };

        window.app.showTemplateEditor = function(id = null) {
            document.getElementById('template-list-section').classList.add('hidden');
            document.getElementById('template-editor-section').classList.remove('hidden');
            document.getElementById('template-item-editor-container').innerHTML = '';
            
            if(id) {
                const t = templateDatabase[id];
                document.getElementById('edit-template-id').value = t.id;
                document.getElementById('edit-template-name').value = t.name;
                if(t.items) t.items.forEach(i => window.app.addCategoryEditor(i, 'template-item-editor-container'));
            } else {
                document.getElementById('edit-template-id').value = '';
                document.getElementById('edit-template-name').value = '';
            }
        };

        window.app.showTemplateList = function() {
            document.getElementById('template-list-section').classList.remove('hidden');
            document.getElementById('template-editor-section').classList.add('hidden');
        };

        window.app.saveTemplate = async function() {
            const id = document.getElementById('edit-template-id').value || doc(getCollectionRef("checklist_templates")).id;
            const name = document.getElementById('edit-template-name').value;
            if(!name) return showToast("è«‹è¼¸å…¥ç¯„æœ¬åç¨±", "error");

            const items = [];
            document.querySelectorAll('#template-item-editor-container .editor-item').forEach(el => {
                const cName = el.querySelector('.cat-name').value;
                const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text);
                if(cName) items.push({ category: cName, subItems: subs });
            });

            await setDoc(getDocRef("checklist_templates", id), { name, items });
            showToast("ç¯„æœ¬å·²å„²å­˜", "success");
            window.app.showTemplateList();
        };

        window.app.deleteTemplate = async function(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç¯„æœ¬ï¼Ÿ')) await deleteDoc(getDocRef("checklist_templates", id));
        };

        window.app.showTemplateModal = function() {
            const container = document.getElementById('template-selection-container');
            container.innerHTML = '';
            if(Object.keys(templateDatabase).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400">ç„¡å¯ç”¨ç¯„æœ¬</p>';
            } else {
                Object.values(templateDatabase).forEach(t => {
                    container.innerHTML += `<button onclick="window.app.applyTemplate('${t.id}')" class="w-full text-left p-3 border rounded hover:bg-indigo-50 mb-2">${t.name}</button>`;
                });
            }
            document.getElementById('template-modal').classList.remove('hidden');
            document.getElementById('template-modal').classList.add('flex');
        };

        window.app.closeTemplateModal = function() {
            document.getElementById('template-modal').classList.add('hidden');
            document.getElementById('template-modal').classList.remove('flex');
        };

        window.app.applyTemplate = function(id) {
            const t = templateDatabase[id];
            if(t && t.items) {
                document.getElementById('item-editor-container').innerHTML = ''; // Clear existing
                t.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container'));
                showToast(`å·²å¥—ç”¨ç¯„æœ¬ï¼š${t.name}`, "success");
            }
            window.app.closeTemplateModal();
        };

        // äººå“¡èˆ‡ç´€éŒ„ (åŒå‰)
        window.app.renderUserList = function() {
            const c = document.getElementById('user-list-container'); c.innerHTML = '';
            Object.values(userDatabase).forEach(u => {
                c.innerHTML += `<div class="card p-3 flex justify-between items-center mb-2"><div><span class="font-bold">${u.name}</span> <span class="text-xs text-gray-500">(${u.role})</span></div><div class="space-x-2"><button onclick="window.app.showUserEditor('${u.id}')" class="text-blue-600 text-sm">ç·¨è¼¯</button><button onclick="window.app.deleteUser('${u.id}')" class="text-red-600 text-sm">åˆªé™¤</button></div></div>`;
            });
        };
        window.app.showUserEditor = (id = null) => {
            document.getElementById('user-list-container').classList.add('hidden');
            document.getElementById('user-editor-section').classList.remove('hidden');
            const roleSelect = document.getElementById('edit-user-role');
            roleSelect.onchange = (e) => { document.getElementById('edit-user-password').classList.toggle('hidden', e.target.value !== 'manager'); };
            if (id && userDatabase[id]) {
                const user = userDatabase[id];
                document.getElementById('edit-user-id').value = id; document.getElementById('edit-user-id').disabled = true;
                document.getElementById('edit-user-name').value = user.name;
                roleSelect.value = user.role;
            } else {
                document.getElementById('edit-user-id').value = ''; document.getElementById('edit-user-id').disabled = false;
                document.getElementById('edit-user-name').value = '';
            }
        };
        window.app.saveUser = async function() {
            const id = document.getElementById('edit-user-id').value;
            const data = { name: document.getElementById('edit-user-name').value, role: document.getElementById('edit-user-role').value };
            if(data.role === 'manager') data.password = document.getElementById('edit-user-password').value;
            await setDoc(getDocRef("users", id), data, { merge: true });
            window.app.showUserList();
        };
        window.app.showUserList = function() { document.getElementById('user-list-container').classList.remove('hidden'); document.getElementById('user-editor-section').classList.add('hidden'); };
        window.app.deleteUser = async (id) => { if(confirm('åˆªé™¤?')) await deleteDoc(getDocRef("users", id)); };

        // ç´€éŒ„åˆ—è¡¨ Render
        window.app.renderChecklistHistory = function() {
             const c = document.getElementById('checklist-history-log-container'); c.innerHTML = '';
             if(checkHistory.length === 0) { c.innerHTML = '<p class="text-gray-400 text-center py-4">ç„¡è³‡æ–™</p>'; return; }
             checkHistory.sort((a,b) => b.checkTimestamp.seconds - a.checkTimestamp.seconds).forEach(h => {
                 const date = h.checkTimestamp?.toDate().toLocaleString() || 'N/A';
                 const abCount = h.items.filter(i => i.status === 'ç•°å¸¸').length;
                 const statusStr = abCount > 0 ? `<span class="text-red-500 font-bold">${abCount} ç•°å¸¸</span>` : `<span class="text-green-600">æ­£å¸¸</span>`;
                 c.innerHTML += `<div class="card p-4 mb-2 text-sm border-l-4 ${abCount>0?'border-red-500':'border-green-500'}"><p class="font-bold text-lg">${h.deviceName} <span class="text-xs font-normal text-gray-500">by ${h.userName}</span></p><p class="text-gray-500 mt-1 flex justify-between"><span>${date}</span><span>${statusStr}</span></p></div>`;
             });
        };

        window.app.renderMaintenanceHistory = function() {
             const c = document.getElementById('maintenance-history-log-container'); c.innerHTML = '';
             if(maintenanceHistory.length === 0) { c.innerHTML = '<p class="text-gray-400 text-center py-4">ç„¡ä¿é¤Šè³‡æ–™</p>'; return; }
             maintenanceHistory.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds).forEach(h => {
                 const date = h.timestamp?.toDate().toLocaleString() || 'N/A';
                 const typeStr = h.type === 'cleaning' ? 'ğŸ§¹ æ©Ÿå°æ¸…æ½”' : 'ğŸ”§ é›¶ä»¶æ›´æ›';
                 c.innerHTML += `<div class="card p-4 mb-2 text-sm border-l-4 border-yellow-500"><p class="font-bold text-lg">${h.deviceName} <span class="text-xs font-normal text-gray-500">by ${h.userName}</span></p><p class="mt-1 font-semibold text-slate-700">${typeStr} ${h.componentName ? `(${h.componentName})` : ''}</p><p class="text-gray-500 mt-1">${date}</p>${h.notes ? `<p class="mt-2 p-2 bg-gray-50 rounded text-gray-600">${h.notes}</p>` : ''}</div>`;
             });
        };

        // --- å ±è¡¨ç”¢ç”Ÿé‚è¼¯ ---
        window.app.generateReport = function() {
            const type = document.getElementById('report-type').value;
            const start = new Date(document.getElementById('report-start-date').value);
            const end = new Date(document.getElementById('report-end-date').value);
            end.setHours(23,59,59);

            const container = document.getElementById('report-preview-container');
            const content = document.getElementById('report-content');
            const title = document.getElementById('report-title');
            const subtitle = document.getElementById('report-subtitle');
            
            container.classList.remove('hidden');
            document.getElementById('report-actions').classList.remove('hidden');
            subtitle.textContent = `æŸ¥è©¢å€é–“: ${start.toISOString().slice(0,10)} ~ ${end.toISOString().slice(0,10)}`;
            document.getElementById('report-timestamp').textContent = new Date().toLocaleString();

            let html = '<table style="width:100%; border-collapse: collapse; font-size: 14px; text-align: left;">';
            const thStyle = 'border: 1px solid #94a3b8; padding: 8px; background-color: #f1f5f9; font-weight: bold;';
            const tdStyle = 'border: 1px solid #94a3b8; padding: 8px;';
            
            if (type === 'checklist') {
                title.textContent = "è¨­å‚™é»æª¢ç´€éŒ„è¡¨";
                html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é»æª¢äºº</th><th style="${thStyle}">çµæœ</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`;
                
                const filtered = checkHistory.filter(h => {
                    const d = h.checkTimestamp?.toDate(); return d >= start && d <= end;
                }).sort((a,b) => b.checkTimestamp.seconds - a.checkTimestamp.seconds);

                if(filtered.length === 0) html += `<tr><td colspan="5" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`;
                
                filtered.forEach(r => {
                    const date = r.checkTimestamp?.toDate().toLocaleString();
                    const abItems = r.items.filter(i => i.status === 'ç•°å¸¸');
                    const resultHtml = abItems.length > 0 ? `<span style="color:red; font-weight:bold;">ç•°å¸¸ (${abItems.length})</span><br><span style="font-size:12px; color:#64748b;">${abItems.map(i=>i.text).join(', ')}</span>` : '<span style="color:green;">æ­£å¸¸</span>';
                    html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${resultHtml}</td><td style="${tdStyle}">${r.summaryNotes || ''}</td></tr>`;
                });

            } else {
                title.textContent = "è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„è¡¨";
                html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é¡å‹</th><th style="${thStyle}">é …ç›®</th><th style="${thStyle}">åŸ·è¡Œäºº</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`;
                
                const filtered = maintenanceHistory.filter(h => {
                    const d = h.timestamp?.toDate(); return d >= start && d <= end;
                }).sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                if(filtered.length === 0) html += `<tr><td colspan="6" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`;

                filtered.forEach(r => {
                    const date = r.timestamp?.toDate().toLocaleString();
                    const typeStr = r.type === 'cleaning' ? 'æ¸…æ½”' : 'æ›´æ›';
                    html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${typeStr}</td><td style="${tdStyle}">${r.componentName || '-'}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${r.notes || ''}</td></tr>`;
                });
            }
            html += '</tbody></table>';
            content.innerHTML = html;
            
            // å¯«å…¥åˆ—å°å…§å®¹
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div style="text-align:center; margin-bottom:20px;">
                    <h1>${title.textContent}</h1>
                    <p>${subtitle.textContent}</p>
                </div>
                ${html}
                <div style="text-align:right; margin-top:20px; font-size:12px; color:#666;">
                    è£½è¡¨æ™‚é–“: ${document.getElementById('report-timestamp').textContent}
                </div>
            `;
        };

        // --- æ ¸å¿ƒï¼šåˆ—å°åŠŸèƒ½å¯¦ä½œ ---
        window.app.printReport = function() {
            window.print();
        };

        window.app.showScanner = function() {
            document.getElementById('qr-scanner-modal').classList.remove('hidden');
            document.getElementById('qr-scanner-content').classList.remove('hidden');
            if(!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, (decodedText) => {
                 window.app.hideScanner();
                 
                 // Check if it's a URL-based QR or old Text-based QR
                 // Try to parse URL to find ID
                 let id = decodedText;
                 try {
                     const url = new URL(decodedText);
                     const paramId = url.searchParams.get('id');
                     if(paramId) id = paramId;
                 } catch(e) {
                     // Not a valid URL, treat as raw ID (old QR codes)
                 }
                 
                 window.app.handleScanResult(id);
            }).catch(err => { document.getElementById('qr-reader').innerHTML = `<p class="text-red-500 p-4">ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ (éœ€ HTTPS)</p>`; });
        };
        
        window.app.handleScanResult = function(id) {
            const eq = equipmentDatabase[id];
            if (!eq) {
                showToast("æ‰¾ä¸åˆ°å°æ‡‰çš„è¨­å‚™ ID: " + id, "error");
                return;
            }
            // Show selection modal
            document.getElementById('scan-match-name').textContent = eq.name;
            const btnCheck = document.getElementById('btn-scan-checklist');
            const btnMaint = document.getElementById('btn-scan-maintenance');
            
            btnCheck.onclick = () => {
                 document.getElementById('scan-action-modal').classList.add('hidden');
                 startChecklist(id);
            };
            
            btnMaint.onclick = () => {
                 document.getElementById('scan-action-modal').classList.add('hidden');
                 window.app.showMaintenanceModal(id);
            };
            
            document.getElementById('scan-action-modal').classList.remove('hidden');
            document.getElementById('scan-action-content').classList.remove('hidden');
        };

        window.app.hideScanner = function() { if(html5QrCode) html5QrCode.stop().catch(e=>{}); document.getElementById('qr-scanner-modal').classList.add('hidden'); };
        function showToast(msg, type='info') {
            const t = document.getElementById('toast-container'); const d = document.createElement('div');
            d.className = `p-3 rounded shadow text-white ${type==='error'?'bg-red-500':'bg-blue-500'}`; d.innerText = msg;
            t.appendChild(d); setTimeout(() => d.remove(), 3000);
        }

        init();
    </script>
</body>
</html>