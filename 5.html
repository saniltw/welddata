<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å‚™é»æª¢è¡¨ (å®Œç¾å¾©åˆ»ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .status-btn.selected { transform: scale(1.05); box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39); }
        .status-btn.selected-normal { background-color: #22c55e; color: white; border-color: #22c55e; }
        .status-btn.selected-abnormal { background-color: #ef4444; color: white; border-color: #ef4444; }
        .status-btn.selected-na { background-color: #64748b; color: white; border-color: #64748b; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border: 1px solid #e5e7eb; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none; appearance: none;
        }
        .admin-tab-active { color: #4f46e5; border-color: #4f46e5; }
        .eq-tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .eq-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        .eq-tab-inactive:hover { color: #374151; border-color: #d1d5db; }
        .status-dot { height: 0.6rem; width: 0.6rem; border-radius: 50%; display: inline-block; margin-right: 0.3rem; }
        .status-dot.active { background-color: #22c55e; }
        .status-dot.repair { background-color: #eab308; }
        .status-dot.unused { background-color: #9ca3af; }
        
        /* æ¬Šé™æ§åˆ¶æ¨£å¼ */
        .role-guest .action-edit, 
        .role-guest .action-delete, 
        .role-guest .action-add,
        .role-guest .action-submit { display: none !important; }
        
        /* å»£æ³°å ±è¡¨å°ˆç”¨æ¨£å¼ */
        .kt-report-table { width: 100%; border-collapse: collapse; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif; }
        .kt-report-table th, .kt-report-table td { border: 1px solid black; padding: 4px; text-align: center; vertical-align: middle; height: 35px; font-size: 14px; }
        .kt-header { text-align: center; font-weight: bold; margin-bottom: 10px; position: relative; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .kt-logo-container { position: absolute; left: 0; top: 0; text-align: left; }
        .kt-logo { height: 40px; display: block; margin-bottom: 2px; }
        .kt-logo-text { font-family: sans-serif; font-weight: bold; font-size: 14px; }
        .kt-company-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .kt-title-main { font-size: 26px; text-decoration: underline; font-weight: bold; }
        .kt-info-table { width: 100%; border-collapse: collapse; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif; margin-bottom: 5px; }
        .kt-info-table td { border: 1px solid black; padding: 5px 10px; font-size: 16px; vertical-align: middle; }
        .kt-footer-notes { font-size: 12px; margin-top: 10px; line-height: 1.5; text-align: left; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif;}
        .kt-sign-area { display: flex; justify-content: space-between; margin-top: 20px; font-size: 14px; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif;}
        .page-break { page-break-after: always; display: block; }
        
        /* Progress Bar */
        .progress-bar-container { width: 100%; background-color: #e2e8f0; border-radius: 9999px; height: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; }

        /* Task Mode Tabs */
        .task-tab { @apply flex-1 py-3 text-center font-bold text-gray-500 border-b-2 border-transparent cursor-pointer transition-colors text-sm sm:text-base; }
        .task-tab.active-check { @apply text-indigo-600 border-indigo-600 bg-indigo-50; }
        .task-tab.active-clean { @apply text-orange-600 border-orange-600 bg-orange-50; }
        .task-tab.active-part { @apply text-teal-600 border-teal-600 bg-teal-50; }

        /* Backup User List Item */
        .backup-user-item { @apply flex items-center justify-between p-2 mb-2 bg-white border rounded shadow-sm; }
        .backup-user-actions { @apply flex gap-1; }
        .backup-action-btn { @apply p-1 rounded hover:bg-gray-100 text-gray-500; }

        /* User Switcher Hover Effect */
        #user-status-container { @apply cursor-pointer hover:bg-gray-100 rounded-lg p-2 transition-colors border border-transparent hover:border-gray-200; }

        /* Pagination Controls */
        .pagination-btn { @apply px-3 py-1 border rounded bg-white text-gray-600 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm font-medium; }
        .pagination-info { @apply text-sm text-gray-600 font-mono mx-2; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-slate-600">ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <!-- ç™»å…¥/åˆ‡æ›ä½¿ç”¨è€… Modal -->
    <div id="user-switch-modal" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center p-4 z-[150] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="flex justify-end">
                <button onclick="document.getElementById('user-switch-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">åˆ‡æ›ä½¿ç”¨è€…</h1>
                <p class="text-slate-500 mt-2">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ä½¿ç”¨è€…</label>
                    <select id="login-user-select" class="form-select w-full p-3 border border-gray-300 rounded-xl text-lg bg-slate-50 focus:ring-2 focus:ring-indigo-500">
                        <option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>
                        <!-- ä½¿ç”¨è€…åˆ—è¡¨å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
                    </select>
                </div>
                
                <button onclick="window.app.handleLogin()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl text-lg hover:bg-indigo-700 shadow-lg transform transition hover:scale-[1.02]">
                    ç¢ºèªåˆ‡æ›
                </button>
            </div>
            
            <p class="text-center text-xs text-slate-400 mt-6">ç³»çµ±ç‰ˆæœ¬ v5.3.0 (Smart Calendar Expand)</p>
        </div>
    </div>

    <!-- App Container (User Mode) -->
    <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 md:p-8 hidden">
        <!-- Main Content -->
        <div class="flex justify-between items-center mb-6">
            <div id="user-status-container" onclick="window.app.showUserSwitchModal()" title="é»æ“Šåˆ‡æ›ä½¿ç”¨è€…">
                <div id="logged-in-view" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-sm">
                        <span id="user-avatar-text">è¨ª</span>
                    </div>
                    <div class="flex flex-col">
                        <div class="flex items-center">
                            <strong id="logged-in-name" class="text-slate-700 text-sm">è¨ªå®¢</strong>
                            <span id="role-badge" class="ml-2 px-1.5 py-0.5 rounded text-[10px] bg-gray-200 text-gray-700">è¨ªå®¢</span>
                        </div>
                        <span class="text-[10px] text-indigo-500 cursor-pointer">åˆ‡æ›ä½¿ç”¨è€…</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="window.app.showScanner()" class="bg-white text-indigo-600 border border-indigo-200 p-2 rounded-lg hover:bg-indigo-50 shadow-sm flex items-center justify-center action-submit" title="é–‹å•Ÿæƒæå™¨">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                </button>
                <button id="toggle-mode-btn" onclick="window.app.toggleManagementMode()" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 text-sm hidden">âš™ï¸ ç®¡ç†å¾Œå°</button>
            </div>
        </div>

        <div id="user-mode">
            <header class="mb-4">
                <h1 class="text-3xl font-bold text-slate-800">è¨­å‚™ç®¡ç†ç³»çµ±</h1>
                <p class="text-red-500 font-bold hidden guest-warning mt-2 text-sm bg-red-50 p-2 rounded">âš ï¸ è¨ªå®¢æ¨¡å¼ï¼šåƒ…ä¾›æª¢è¦–ï¼Œç„¡æ³•åŸ·è¡Œæäº¤æ“ä½œ</p>
            </header>

            <div class="flex rounded-lg bg-white shadow-sm mb-6 overflow-hidden border border-gray-200">
                <button onclick="window.app.switchTaskMode('check')" id="tab-mode-check" class="task-tab active-check">ğŸ“‹ è¨­å‚™é»æª¢</button>
                <button onclick="window.app.switchTaskMode('clean')" id="tab-mode-clean" class="task-tab">ğŸ§¹ æ¸…æ½”ä¿é¤Š</button>
                <button onclick="window.app.switchTaskMode('part')" id="tab-mode-part" class="task-tab">âš™ï¸ è€—ææ›´æ›</button>
            </div>

            <div id="main-content" class="space-y-6">
                <div id="manual-select-section" class="card p-6 border-l-4 border-slate-400">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-slate-800" id="manual-select-title">æ‰‹å‹•é¸æ“‡è¨­å‚™</h2>
                    </div>
                    <div class="space-y-4">
                        <select id="manual-category-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm"><option value="">è¼‰å…¥ä¸­...</option></select>
                        <select id="manual-device-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm" disabled><option value="">è«‹å…ˆé¸æ“‡å¤§é¡...</option></select>
                        <div class="action-submit">
                            <button onclick="window.app.handleManualSelection()" id="manual-start-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>ğŸ“‹ é–‹å§‹é»æª¢</button>
                            <button onclick="window.app.handleManualMaintenance()" id="manual-maintenance-button" class="w-full bg-orange-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-orange-600 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors hidden" disabled>ğŸ”§ è¨˜éŒ„ä¿é¤Š</button>
                             <button onclick="window.app.handleManualReplace()" id="manual-replace-button" class="w-full bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors hidden" disabled>ğŸ› ï¸ ç™»è¨˜é›¶ä»¶æ›´æ›</button>
                        </div>
                    </div>
                </div>

                <div id="dashboard-section" class="card p-5 mb-6 shadow-sm">
                    <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center"><span id="dashboard-icon">ğŸ“Š</span><span class="ml-2" id="dashboard-title">å·¥ä½œæ¦‚è¦½</span></h2>
                        <div class="flex gap-2">
                            <select id="dashboard-owner-filter" onchange="window.app.renderDashboard()" class="text-xs border rounded p-1 bg-slate-50 text-slate-600 max-w-[120px]"><option value="ALL">å…¨éƒ¨è² è²¬äºº</option></select>
                            <select id="dashboard-category-filter" onchange="window.app.renderDashboard()" class="text-xs border rounded p-1 bg-slate-50 text-slate-600 max-w-[100px]"><option value="ALL">å…¨éƒ¨åˆ†é¡</option></select>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4 text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded"><span id="dashboard-range-label">çµ±è¨ˆå€é–“ (æœ¬é€±)</span><span id="dashboard-date-range" class="font-mono">...</span></div>
                    <div class="mb-4">
                        <div class="flex justify-between text-xs text-slate-600 mb-1"><span>æœ¬é€±å®Œæˆåº¦</span><span id="dashboard-progress-text" class="font-bold">0%</span></div>
                        <div class="progress-bar-container"><div id="dashboard-progress-bar" class="progress-bar-fill bg-indigo-500" style="width: 0%"></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center mb-4">
                        <div class="bg-slate-50 rounded p-2 border border-slate-200"><span class="block text-xs text-slate-500 font-bold mb-1" id="label-pending">æœ¬é€±å¾…è¾¦</span><span id="count-pending" class="text-2xl font-bold text-slate-700">0</span></div>
                        <div class="bg-green-50 rounded p-2 border border-green-100"><span class="block text-xs text-green-600 font-bold mb-1" id="label-completed">æœ¬é€±å·²å®Œæˆ</span><span id="count-completed" class="text-2xl font-bold text-green-700">0</span></div>
                    </div>
                    <div id="todo-list-container" class="space-y-3 max-h-60 overflow-y-auto pr-1"><p class="text-center text-sm text-gray-400 py-2">è¼‰å…¥ä¸­...</p></div>
                    <div id="completed-section-toggle" class="mt-4 text-center hidden">
                         <button onclick="document.getElementById('completed-list-container').classList.toggle('hidden')" class="text-xs text-gray-400 hover:text-gray-600 underline">é¡¯ç¤ºå·²å®Œæˆé …ç›® â–¼</button>
                         <div id="completed-list-container" class="space-y-2 mt-2 hidden text-left max-h-40 overflow-y-auto pr-1"></div>
                    </div>
                </div>
            </div>

            <div id="checklist-section" class="hidden space-y-6">
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4 border-b pb-3">è¨­å‚™è³‡è¨Š</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div><label class="text-slate-500">è¨­å‚™åç¨±</label><p id="device-name" class="font-bold text-slate-700 text-lg"></p></div>
                        <div><label class="text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><p id="device-asset-no" class="font-semibold text-slate-700"></p></div>
                        <div><label class="text-slate-500">ä¸»è¦è² è²¬äºº</label><p id="device-primary-owner" class="font-semibold text-slate-700"></p></div>
                        <div><label class="text-slate-500">é»æª¢äººå“¡ (ç›®å‰)</label><p id="user-name-display" class="font-semibold text-slate-700"></p></div>
                        <div class="col-span-1 sm:col-span-2">
                            <label class="text-slate-500 block mb-1">é»æª¢æ—¥æœŸ (å¯è£œç™»)</label>
                            <div class="flex items-center gap-2">
                                <input type="date" id="check-date-input" class="border border-slate-300 rounded p-1.5 text-slate-700 font-semibold bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="window.app.updateWeekDisplay(this.value)">
                                <span id="week-display" class="text-sm font-medium text-indigo-600 bg-indigo-50 px-2.5 py-1.5 rounded-full border border-indigo-100"></span>
                            </div>

                            <!-- æ–°å¢ï¼šæœˆä»½æª¢è¦–æŒ‰éˆ•èˆ‡å®¹å™¨ -->
                            <div class="mt-2">
                                <button onclick="window.app.toggleCalendarView()" class="text-sm text-indigo-600 font-bold hover:text-indigo-800 flex items-center transition-colors">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    ğŸ“… æœˆä»½æª¢è¦– / è£œç™»å…¶ä»–é€±æ¬¡
                                </button>
                            </div>
                            <div id="calendar-view-container" class="mt-3 p-4 bg-slate-50 border border-slate-200 rounded-lg hidden transition-all">
                                <div class="flex items-center gap-2 mb-3">
                                    <label class="text-sm font-bold text-slate-700">é¸æ“‡æœˆä»½:</label>
                                    <input type="month" id="calendar-month-select" class="border rounded p-1 text-sm bg-white" onchange="window.app.renderCalendarView()">
                                </div>
                                <div id="calendar-weeks-list" class="space-y-2"></div>
                            </div>
                            <!-- çµæŸæ–°å¢ -->

                            <!-- å·²ç§»é™¤ç´…è‰²é€¾æœŸæ–‡å­—æé†’ (Option A) -->
                        </div>
                    </div>
                </div>
                <div id="checklist-items-container" class="space-y-6"></div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">ç¸½çµå‚™è¨»</h2>
                    <textarea id="summary-notes" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="window.app.resetApp()" class="w-1/3 bg-slate-500 text-white font-bold py-3 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button onclick="window.app.submitChecklist(this)" class="w-2/3 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg action-submit">æäº¤</button>
                </div>
            </div>
        </div>

        <div id="admin-mode" class="hidden">
            <header class="mb-6"><h1 class="text-4xl font-bold text-slate-800">ç®¡ç†å¾Œå°</h1></header>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-4 overflow-x-auto text-sm font-medium">
                    <button onclick="window.app.switchAdminTab('equipment')" id="tab-equipment" class="px-1 py-3 border-b-2 admin-tab-active">è¨­å‚™ç®¡ç†</button>
                    <button onclick="window.app.switchAdminTab('templates')" id="tab-templates" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600 action-delete">é»æª¢ç¯„æœ¬</button>
                    <button onclick="window.app.switchAdminTab('users')" id="tab-users" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600 action-delete">äººå“¡ç®¡ç†</button>
                    <button onclick="window.app.switchAdminTab('checklistHistory')" id="tab-checklistHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">é»æª¢ç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('maintenanceHistory')" id="tab-maintenanceHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">ä¿é¤Šç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('reports')" id="tab-reports" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">å ±è¡¨è¼¸å‡º</button>
                </nav>
            </div>
            
            <div id="admin-tab-content-equipment">
                <div id="equipment-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">è¨­å‚™åˆ—è¡¨</h2>
                        <button onclick="window.app.showEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm action-add">æ–°å¢è¨­å‚™</button>
                    </div>
                    <div id="equipment-category-tabs" class="mb-6"></div>
                    <div id="equipment-list-container"></div>
                </div>
                
                <div id="equipment-editor-section" class="hidden card p-6">
                    <h2 id="editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯è¨­å‚™</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™ç·¨è™Ÿ (ID)</label><input type="text" id="edit-device-id" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™åç¨±</label><input type="text" id="edit-device-name" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™å€åˆ†</label><select id="edit-device-category-select" class="w-full p-2 border rounded mb-2"></select><input type="text" id="edit-device-category-new" class="w-full p-2 border rounded hidden" placeholder="è¼¸å…¥æ–°åˆ†é¡..."></div>
                            <div><label class="block text-xs font-medium text-slate-500">æ”¾ç½®åœ°é»</label><input type="text" id="edit-device-location" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><input type="text" id="edit-device-asset" class="w-full p-2 border rounded"></div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500">ç¾æ³</label>
                                <select id="edit-device-status" class="w-full p-2 border rounded form-select" onchange="window.app.toggleEditorSections()">
                                    <option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option>
                                    <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
                                    <option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option>
                                </select>
                            </div>
                        </div>
                        <hr class="my-4 border-slate-200">
                        <div id="editor-section-check-schedule" class="border border-indigo-200 rounded-lg bg-indigo-50 p-4">
                            <h3 class="font-bold text-indigo-800 mb-3 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>é»æª¢æ’ç¨‹è¨­å®š</h3>
                            <div class="flex gap-6 mb-3 text-sm"><label class="flex items-center cursor-pointer"><input type="radio" name="checkMode" value="weekly" class="mr-2 text-indigo-600" onchange="window.app.toggleScheduleMode('check')"> <span class="font-bold text-slate-700">å›ºå®šæ˜ŸæœŸ (æ¯é€±)</span></label><label class="flex items-center cursor-pointer"><input type="radio" name="checkMode" value="interval" class="mr-2 text-indigo-600" onchange="window.app.toggleScheduleMode('check')"> <span class="font-bold text-slate-700">å›ºå®šé€±æœŸ (å¤©æ•¸)</span></label></div>
                            <div id="check-weekly-input" class="mb-3 hidden"><div class="flex flex-wrap gap-2"><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="checkWeekday" value="1" class="mr-2" onchange="window.app.updateSchedulePreview('check')">é€±ä¸€</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="checkWeekday" value="2" class="mr-2" onchange="window.app.updateSchedulePreview('check')">é€±äºŒ</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="checkWeekday" value="3" class="mr-2" onchange="window.app.updateSchedulePreview('check')">é€±ä¸‰</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="checkWeekday" value="4" class="mr-2" onchange="window.app.updateSchedulePreview('check')">é€±å››</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="checkWeekday" value="5" class="mr-2" onchange="window.app.updateSchedulePreview('check')">é€±äº”</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="checkWeekday" value="6" class="mr-2" onchange="window.app.updateSchedulePreview('check')">é€±å…­</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="checkWeekday" value="0" class="mr-2" onchange="window.app.updateSchedulePreview('check')">é€±æ—¥</label></div><p class="text-xs text-orange-600 mt-1 font-bold">âš ï¸ å»ºè­°é¿å…é¸æ“‡é€±å…­ã€é€±æ—¥ï¼Œä»¥å…ç„¡äººåŸ·è¡Œé€ æˆç³»çµ±é€¾æœŸåˆ¤å®šã€‚</p></div>
                            <div id="check-interval-input" class="mb-3 hidden"><div class="flex items-center"><span class="mr-2 text-slate-600">æ¯</span><input type="number" id="edit-check-interval" class="border rounded w-24 p-2 text-center font-mono" min="1" oninput="window.app.updateSchedulePreview('check')"><span class="ml-2 text-slate-600">å¤© åŸ·è¡Œä¸€æ¬¡</span></div></div>
                            <div class="bg-white p-3 rounded border border-indigo-100 mt-2"><p class="text-xs text-slate-500 mb-1">æœ€è¿‘å…©æ¬¡é è¨ˆé»æª¢æ—¥æœŸ (ç³»çµ±è‡ªå‹•è¨ˆç®—)ï¼š</p><div class="flex gap-4 font-mono font-bold text-indigo-600"><span id="check-preview-1">--</span><span class="text-slate-300">|</span><span id="check-preview-2">--</span></div></div>
                        </div>
                        <div id="editor-section-clean-schedule" class="border border-orange-200 rounded-lg bg-orange-50 p-4 mt-4">
                            <h3 class="font-bold text-orange-800 mb-3 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>æ¸…æ½”æ’ç¨‹è¨­å®š</h3>
                            <div class="flex gap-4 mb-3 text-sm flex-wrap"><label class="flex items-center cursor-pointer"><input type="radio" name="cleanMode" value="weekly" class="mr-2 text-orange-600" onchange="window.app.toggleScheduleMode('clean')"> <span class="font-bold text-slate-700">å›ºå®šæ˜ŸæœŸ (æ¯é€±)</span></label><label class="flex items-center cursor-pointer"><input type="radio" name="cleanMode" value="biweekly" class="mr-2 text-orange-600" onchange="window.app.toggleScheduleMode('clean')"> <span class="font-bold text-slate-700">å›ºå®šæ˜ŸæœŸ (éš”é€±)</span></label><label class="flex items-center cursor-pointer"><input type="radio" name="cleanMode" value="interval" class="mr-2 text-orange-600" onchange="window.app.toggleScheduleMode('clean')"> <span class="font-bold text-slate-700">å›ºå®šé€±æœŸ (å¤©æ•¸)</span></label></div>
                            <div id="clean-weekly-input" class="mb-3 hidden"><div class="flex flex-wrap gap-2"><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="cleanWeekday" value="1" class="mr-2" onchange="window.app.updateSchedulePreview('clean')">é€±ä¸€</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="cleanWeekday" value="2" class="mr-2" onchange="window.app.updateSchedulePreview('clean')">é€±äºŒ</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="cleanWeekday" value="3" class="mr-2" onchange="window.app.updateSchedulePreview('clean')">é€±ä¸‰</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="cleanWeekday" value="4" class="mr-2" onchange="window.app.updateSchedulePreview('clean')">é€±å››</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="cleanWeekday" value="5" class="mr-2" onchange="window.app.updateSchedulePreview('clean')">é€±äº”</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="cleanWeekday" value="6" class="mr-2" onchange="window.app.updateSchedulePreview('clean')">é€±å…­</label><label class="inline-flex items-center bg-white px-3 py-1.5 rounded border"><input type="checkbox" name="cleanWeekday" value="0" class="mr-2" onchange="window.app.updateSchedulePreview('clean')">é€±æ—¥</label></div><p class="text-xs text-orange-600 mt-1 font-bold">âš ï¸ å»ºè­°é¿å…é¸æ“‡é€±å…­ã€é€±æ—¥ã€‚</p></div>
                            <div id="clean-interval-input" class="mb-3 hidden"><div class="flex items-center"><span class="mr-2 text-slate-600">æ¯</span><input type="number" id="edit-clean-interval" class="border rounded w-24 p-2 text-center font-mono" min="1" oninput="window.app.updateSchedulePreview('clean')"><span class="ml-2 text-slate-600">å¤© åŸ·è¡Œä¸€æ¬¡</span></div></div>
                            <div class="bg-white p-3 rounded border border-orange-100 mt-2"><p class="text-xs text-slate-500 mb-1">æœ€è¿‘å…©æ¬¡é è¨ˆæ¸…æ½”æ—¥æœŸ (ç³»çµ±è‡ªå‹•è¨ˆç®—)ï¼š</p><div class="flex gap-4 font-mono font-bold text-orange-600"><span id="clean-preview-1">--</span><span class="text-slate-300">|</span><span id="clean-preview-2">--</span></div></div>
                        </div>
                        <div id="editor-section-print-option" class="mt-4 p-3 bg-indigo-50 border border-indigo-100 rounded-lg"><label class="flex items-center space-x-3 cursor-pointer"><input type="checkbox" id="edit-device-include-kt" class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500"><span class="font-bold text-indigo-700">åˆ—å°æ–¼ã€Œå»£æ³°é‡‘å±¬-é€±é»æª¢è¡¨ã€</span></label><p class="text-xs text-indigo-500 mt-1 ml-8">å‹¾é¸æ­¤é …ç›®å¾Œï¼Œæ­¤è¨­å‚™æ‰æœƒå‡ºç¾åœ¨ã€Œå»£æ³°é‡‘å±¬-é€±é»æª¢è¡¨ã€å ±è¡¨ä¸­ã€‚</p></div>
                        <div id="editor-section-auth-users" class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h3 class="font-bold text-gray-700 mb-3 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>äººå“¡æ¬Šé™è¨­å®š</h3>
                            <div class="mb-4"><label class="block text-xs font-medium text-slate-500 mb-1">ä¸»è¦è² è²¬äºº (Primary Owner)</label><select id="edit-primary-owner" class="w-full p-2 border rounded bg-white"><option value="">è«‹é¸æ“‡è² è²¬äºº...</option></select></div>
                            <div><label class="block text-xs font-medium text-slate-500 mb-1">å‚™æ´äººå“¡ (Backup Personnel) - ä¾å„ªå…ˆé †åº</label><div class="flex gap-2 mb-2"><select id="edit-backup-adder-select" class="flex-1 p-2 border rounded bg-white text-sm"><option value="">é¸æ“‡äººå“¡åŠ å…¥...</option></select><button onclick="window.app.addBackupUser()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm font-bold">æ–°å¢</button></div><div id="backup-user-list-container" class="min-h-[50px] space-y-2"></div></div>
                        </div>
                        <div><label class="block text-xs font-medium text-slate-500 mb-2">è¨­å‚™åœ–ç‰‡</label><div class="flex items-center gap-4"><img id="image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border"><button type="button" onclick="document.getElementById('edit-device-image').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ğŸ“· æ‹ç…§ / ä¸Šå‚³</button><input type="file" id="edit-device-image" accept="image/*" class="hidden" onchange="window.app.handleImageUpload(this)"></div></div>
                        <div id="editor-section-checklist-items"><hr class="my-4"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-700">é»æª¢é …ç›®è¨­å®š</h3><button onclick="window.app.showTemplateModal()" class="text-sm bg-teal-500 text-white px-3 py-1 rounded hover:bg-teal-600">ğŸ“‘ å¾ç¯„æœ¬è¼‰å…¥</button></div><div id="item-editor-container" class="space-y-4"></div><button onclick="window.app.addCategoryEditor(null, 'item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button></div>
                        <div id="editor-section-components"><hr class="my-4"><h3 class="font-bold text-slate-700">å¯æ›´æ›é›¶ä»¶ç®¡ç† (è€—æ)</h3><div id="component-editor-container" class="space-y-2"></div><button onclick="window.app.addComponentEditor()" class="w-full bg-gray-100 text-gray-700 py-2 rounded border border-gray-300 hover:bg-gray-200">ï¼‹ æ–°å¢é›¶ä»¶</button></div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveEquipment(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </div>

            <div id="admin-tab-content-templates" class="hidden">
                <div id="template-list-section">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-slate-800">é»æª¢ç¯„æœ¬ç®¡ç†</h2><button onclick="window.app.showTemplateEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm action-add">æ–°å¢ç¯„æœ¬</button></div>
                    <div id="template-list-container" class="space-y-3"></div>
                </div>
                <div id="template-editor-section" class="hidden card p-6">
                    <h2 id="template-editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯ç¯„æœ¬</h2>
                    <div class="space-y-4"><input type="hidden" id="edit-template-id"><div><label class="block text-xs font-medium text-slate-500">ç¯„æœ¬åç¨±</label><input type="text" id="edit-template-name" class="w-full p-2 border rounded" placeholder="ä¾‹å¦‚ï¼šå †é«˜æ©Ÿé€šç”¨æª¢æŸ¥è¡¨"></div><hr class="my-4"><h3 class="font-bold text-slate-700">ç¯„æœ¬é …ç›®è¨­å®š</h3><div id="template-item-editor-container" class="space-y-4"></div><button onclick="window.app.addCategoryEditor(null, 'template-item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button></div>
                    <div class="mt-6 flex justify-end space-x-3"><button onclick="window.app.showTemplateList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button><button onclick="window.app.saveTemplate(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜ç¯„æœ¬</button></div>
                </div>
            </div>
            
            <div id="admin-tab-content-users" class="hidden">
                 <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">äººå“¡åˆ—è¡¨</h2><button onclick="window.app.showUserEditor()" class="bg-indigo-600 text-white px-4 py-2 rounded action-add">æ–°å¢</button></div>
                <div id="user-list-container" class="space-y-2"></div>
                <div id="user-editor-section" class="hidden card p-6">
                    <h2 id="user-editor-title" class="text-xl font-bold mb-4">ç·¨è¼¯äººå“¡</h2>
                    <div class="space-y-3"><input type="text" id="edit-user-id" placeholder="ID" class="w-full p-2 border rounded"><input type="text" id="edit-user-name" placeholder="å§“å" class="w-full p-2 border rounded"><select id="edit-user-role" class="w-full p-2 border rounded"><option value="operator">æ“ä½œå“¡</option><option value="manager">ç®¡ç†å“¡</option></select><input type="password" id="edit-user-password" placeholder="å¯†ç¢¼ (ç®¡ç†å“¡å¿…å¡«)" class="w-full p-2 border rounded hidden"></div>
                    <div class="flex justify-end gap-2 mt-4"><button onclick="window.app.showUserList()" class="bg-gray-200 px-4 py-2 rounded">å–æ¶ˆ</button><button onclick="window.app.saveUser(this)" class="bg-indigo-600 text-white px-4 py-2 rounded">å„²å­˜</button></div>
                </div>
            </div>

             <div id="admin-tab-content-reports" class="hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-slate-800">å ±è¡¨è¼¸å‡ºä¸­å¿ƒ</h2>
                 <div class="card p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">å ±è¡¨é¡å‹</label>
                            <select id="report-type" class="w-full p-2 border rounded bg-white">
                                <option value="checklist">è¨­å‚™é»æª¢ç´€éŒ„è¡¨ (æ¸…å–®å¼)</option>
                                <option value="overdue">é€¾æœŸæœªåŸ·è¡Œå ±è¡¨ (é€±ç®¡ç†)</option>
                                <option value="kt_weekly">å»£æ³°é‡‘å±¬-é€±é»æª¢è¡¨ (æ ¼å¼åŒ–)</option>
                                <option value="maintenance">ä¿é¤Šç¶­ä¿®ç´€éŒ„è¡¨</option>
                                <option value="analysis_retroactive">è£œç™»åˆ†æå ±è¡¨ (æ•ˆç‡åˆ†æ)</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-medium text-slate-500 mb-1">è¨­å‚™åˆ†é¡</label><select id="report-category" class="w-full p-2 border rounded bg-white"><option value="ALL">å…¨éƒ¨åˆ†é¡</option></select></div>
                        <div id="date-range-container" class="contents"><div><label class="block text-xs font-medium text-slate-500 mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date" id="report-start-date" class="w-full p-2 border rounded"></div><div><label class="block text-xs font-medium text-slate-500 mb-1">çµæŸæ—¥æœŸ</label><input type="date" id="report-end-date" class="w-full p-2 border rounded"></div></div>
                        <div id="kt-report-options" class="hidden md:col-span-2 flex gap-4">
                            <div class="flex-1"><label class="block text-xs font-medium text-slate-500 mb-1">å ±è¡¨æœˆä»½</label><input type="month" id="report-month" class="w-full p-2 border rounded"></div>
                            <div class="flex-1"><label class="block text-xs font-medium text-slate-500 mb-1">ä¸»ç®¡</label><input type="text" id="report-supervisor" class="w-full p-2 border rounded" placeholder="ç°½æ ¸ä¸»ç®¡"></div>
                        </div>
                        <div class="flex items-end"><button onclick="window.app.generateReport()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">ç”¢ç”Ÿå ±è¡¨</button></div>
                    </div>
                 </div>
                 <div id="report-preview-container" class="bg-white p-8 shadow-lg rounded-lg min-h-[500px] hidden">
                     <div class="text-center border-b-2 border-slate-800 pb-4 mb-6"><h1 class="text-3xl font-bold text-slate-900 mb-2" id="report-title">è¨­å‚™ç´€éŒ„å ±è¡¨</h1><p class="text-slate-600" id="report-subtitle">æŸ¥è©¢å€é–“: </p></div>
                     <div id="report-content" class="overflow-x-auto"></div>
                 </div>
                 <div id="report-actions" class="mt-4 flex justify-end gap-3 hidden">
                     <button onclick="window.app.printReport()" class="bg-slate-700 text-white font-bold py-2 px-6 rounded hover:bg-slate-800 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>åˆ—å° / å¦å­˜ PDF</button>
                 </div>
             </div>

             <div id="admin-tab-content-checklistHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™é»æª¢æ­·å²ç´€éŒ„</h2>
                <div id="checklist-history-log-container"></div>
             </div>
             <div id="admin-tab-content-maintenanceHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„</h2>
                <div id="maintenance-history-log-container"></div>
             </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-50 flex"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center hidden" id="qr-scanner-content"><h3 class="text-2xl font-bold mb-4">æƒæè¨­å‚™ QR Code</h3><div id="qr-reader" class="w-full"></div><button onclick="window.app.hideScanner()" class="w-full bg-slate-500 text-white p-3 rounded-lg mt-4">å–æ¶ˆ</button></div></div>
    
    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center p-4 z-[200] hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <div class="mb-4">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-900 text-center mb-2">ç¢ºèªåˆªé™¤</h3>
                <p id="custom-confirm-msg" class="text-sm text-slate-500 text-center">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
            </div>
            <div class="flex flex-col gap-2 sm:flex-row-reverse">
                <button id="custom-confirm-btn-yes" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:w-auto sm:text-sm">
                    ç¢ºå®šåˆªé™¤
                </button>
                <button onclick="window.app.closeConfirmModal()" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Scan Action Modal -->
    <div id="scan-action-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[140] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center hidden" id="scan-action-content">
             <h3 class="text-xl font-bold mb-2 text-slate-800">æƒææˆåŠŸ</h3>
             <p id="scan-match-name" class="text-lg text-indigo-600 font-bold mb-6">è¨­å‚™åç¨±</p>
             <div class="space-y-3">
                 <button id="btn-scan-checklist" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 action-submit">ğŸ“‹ é–‹å§‹é»æª¢</button>
                 <button id="btn-scan-maintenance" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 shadow-md flex items-center justify-center gap-2 action-submit">ğŸ”§ è¨˜éŒ„ä¿é¤Š</button>
                 <button id="btn-scan-part" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 shadow-md flex items-center justify-center gap-2 action-submit">ğŸ› ï¸ æ›´æ›è€—æ</button>
                 <button onclick="document.getElementById('scan-action-modal').classList.add('hidden')" class="w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300">å–æ¶ˆ</button>
             </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">é¸æ“‡ç¯„æœ¬</h3>
            <div id="template-selection-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button onclick="window.app.closeTemplateModal()" class="mt-4 w-full bg-slate-200 py-2 rounded">é—œé–‰</button>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h2 class="text-2xl font-semibold mb-4 text-slate-800">æ–°å¢ä¿é¤Šç´€éŒ„</h2>
            <p id="maint-device-name" class="mb-4 text-slate-600"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">åŸ·è¡Œæ—¥æœŸ (å¯è£œç™»)</label>
                    <input type="date" id="maint-date-input" class="w-full p-2 border rounded border-gray-300">
                    <!-- å·²ç§»é™¤ç´…è‰²é€¾æœŸæ–‡å­—æé†’ -->
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">ä¿é¤Šé¡å‹</label>
                    <select id="maintenance-type" class="w-full p-2 border rounded mt-1" onchange="window.app.toggleMaintType()">
                        <option value="cleaning">æ©Ÿå°æ¸…æ½”</option>
                        <option value="replacement">é›¶ä»¶æ›´æ›</option>
                    </select>
                </div>
                <div id="maintenance-component-selector" class="hidden">
                    <label class="block text-sm font-medium text-slate-600">æ›´æ›é›¶ä»¶</label>
                    <select id="maintenance-component-name" class="w-full p-2 border rounded mt-1"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">å‚™è¨»èªªæ˜</label>
                    <textarea id="maintenance-notes" class="w-full p-2 border rounded mt-1" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">ä¿é¤Šç…§ç‰‡ (é¸å¡«)</label>
                    <div class="flex items-center gap-4">
                        <img id="maint-image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border">
                        <button type="button" onclick="document.getElementById('maint-image-upload').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ğŸ“· æ‹ç…§ / ä¸Šå‚³</button>
                        <input type="file" id="maint-image-upload" accept="image/*" class="hidden" onchange="window.app.handleMaintImageUpload(this)">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="window.app.closeMaintenanceModal()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                <button onclick="window.app.logMaintenance(this)" class="bg-orange-500 text-white py-2 px-4 rounded font-bold">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <!-- QR Code Display Modal -->
    <div id="qr-code-display-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[130] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 text-center max-w-sm w-full hidden" id="qr-display-content">
            <h3 class="text-xl font-bold mb-2">è¨­å‚™ QR Code</h3>
            <p id="qr-display-name" class="text-gray-600 mb-4"></p>
            <div id="qr-code-container" class="flex justify-center mb-4 border p-2 rounded bg-white"></div>
            <p class="text-xs text-gray-400 mb-4">ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæå³å¯ç›´æ¥é–‹å•Ÿ</p>
            <div class="space-y-2">
                <button onclick="window.app.downloadQRCode()" class="w-full bg-indigo-600 text-white font-bold px-4 py-2 rounded hover:bg-indigo-700 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è¼‰åœ–ç‰‡
                </button>
                <button onclick="document.getElementById('qr-code-display-modal').classList.add('hidden')" class="w-full bg-slate-200 text-gray-700 font-bold px-4 py-2 rounded hover:bg-slate-300">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[110] space-y-3 w-full max-w-xs"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, serverTimestamp, updateDoc, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let equipmentDatabase = {}, userDatabase = {}, templateDatabase = {}, checkHistory = [], maintenanceHistory = [];
        let loggedInUser = null, currentCheckId = null, html5QrCode = null, currentMaintEqId = null;
        let currentQrId = null;
        let currentTaskMode = 'check';

        let checkPageState = { eq: 'ALL', user: 'ALL', page: 1 };
        let maintPageState = { eq: 'ALL', user: 'ALL', page: 1 };
        const PAGE_SIZE = 20;

        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `p-4 rounded shadow-lg text-white font-bold transition-opacity duration-500 opacity-0 transform translate-y-2 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.remove('opacity-0', 'translate-y-2'); });
            setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => { if (container.contains(toast)) { container.removeChild(toast); } }, 500); }, 3000);
        };

        window.app = {}; 

        // --- Date Utilities ---
        window.app.formatDate = function(date) {
            if (!date) return '';
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // **æ ¸å¿ƒä¿®æ”¹ï¼šé€±æœ«è·³éé‚è¼¯**
        // å°‡æ—¥æœŸå¾€å¾Œæ¨ï¼Œç›´åˆ°ä¸æ˜¯é€±å…­æˆ–é€±æ—¥
        window.app.adjustForWeekend = function(date) {
            const d = new Date(date);
            const day = d.getDay();
            if (day === 6) { // Sat -> +2 -> Mon
                d.setDate(d.getDate() + 2);
            } else if (day === 0) { // Sun -> +1 -> Mon
                d.setDate(d.getDate() + 1);
            }
            return d;
        };
        
        // **æ ¸å¿ƒä¿®æ”¹ï¼šå–å¾—é€±æ¬¡ç¯„åœå­—ä¸²**
        // æ ¼å¼: 2025-W02 (01/06~01/12)
        window.app.getWeekRangeString = function(date) {
            if(!date) return '';
            const d = new Date(date);
            // æ‰¾å‡ºè©²é€±çš„é€±ä¸€
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d);
            monday.setDate(diff);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            // è¨ˆç®—é€±æ•¸ (ISO Week Number ç°¡åŒ–ç‰ˆ)
            const oneJan = new Date(d.getFullYear(), 0, 1);
            const numberOfDays = Math.floor((d - oneJan) / (24 * 60 * 60 * 1000));
            const weekNum = Math.ceil((d.getDay() + 1 + numberOfDays) / 7);

            const mStr = `${String(monday.getMonth()+1).padStart(2,'0')}/${String(monday.getDate()).padStart(2,'0')}`;
            const sStr = `${String(sunday.getMonth()+1).padStart(2,'0')}/${String(sunday.getDate()).padStart(2,'0')}`;
            
            return `${d.getFullYear()}-W${String(weekNum).padStart(2,'0')} (${mStr}~${sStr})`;
        };

        window.app.toggleScheduleMode = function(type) {
            const mode = document.querySelector(`input[name="${type}Mode"]:checked`).value;
            const weeklyDiv = document.getElementById(`${type}-weekly-input`);
            const intervalDiv = document.getElementById(`${type}-interval-input`);
            if (mode === 'weekly' || mode === 'biweekly') { weeklyDiv.classList.remove('hidden'); intervalDiv.classList.add('hidden'); } else { weeklyDiv.classList.add('hidden'); intervalDiv.classList.remove('hidden'); }
            window.app.updateSchedulePreview(type);
        };
        window.app.updateSchedulePreview = function(type) {
            const mode = document.querySelector(`input[name="${type}Mode"]:checked`).value;
            const today = new Date(); let nextDates = [];
            
            if (mode === 'weekly') { 
                const checked = Array.from(document.querySelectorAll(`input[name="${type}Weekday"]:checked`)).map(cb => parseInt(cb.value)); 
                if (checked.length === 0) { document.getElementById(`${type}-preview-1`).textContent = "--"; document.getElementById(`${type}-preview-2`).textContent = "--"; return; } 
                nextDates = window.app.calculateNextWeeklyDates(today, checked, 2); 
            } 
            else if (mode === 'biweekly') { 
                const checked = Array.from(document.querySelectorAll(`input[name="${type}Weekday"]:checked`)).map(cb => parseInt(cb.value)); 
                if (checked.length === 0) { document.getElementById(`${type}-preview-1`).textContent = "--"; document.getElementById(`${type}-preview-2`).textContent = "--"; return; } 
                const firstBatch = window.app.calculateNextWeeklyDates(today, checked, 1); 
                if (firstBatch.length > 0) { const firstDate = firstBatch[0]; const secondDate = new Date(firstDate); secondDate.setDate(secondDate.getDate() + 14); nextDates = [firstDate, secondDate]; } 
            } 
            else { 
                const interval = parseInt(document.getElementById(`edit-${type}-interval`).value); 
                if (!interval || interval < 1) { document.getElementById(`${type}-preview-1`).textContent = "--"; document.getElementById(`${type}-preview-2`).textContent = "--"; return; } 
                
                let d1 = new Date(today); 
                d1.setDate(d1.getDate() + interval);
                d1 = window.app.adjustForWeekend(d1); // å¼·åˆ¶é€±æœ«è·³é

                let d2 = new Date(d1); 
                d2.setDate(d2.getDate() + interval);
                d2 = window.app.adjustForWeekend(d2); // å¼·åˆ¶é€±æœ«è·³é
                
                nextDates = [d1, d2]; 
            }
            if (nextDates.length > 0) document.getElementById(`${type}-preview-1`).textContent = window.app.formatDate(nextDates[0]); 
            if (nextDates.length > 1) document.getElementById(`${type}-preview-2`).textContent = window.app.formatDate(nextDates[1]);
        };
        
        window.app.calculateNextWeeklyDates = function(startDate, weekdays, count) { let dates = []; let current = new Date(startDate); current.setDate(current.getDate() + 1); let loopCount = 0; while (dates.length < count && loopCount < 365) { if (weekdays.includes(current.getDay())) { dates.push(new Date(current)); } current.setDate(current.getDate() + 1); loopCount++; } return dates; };
        
        // **æ ¸å¿ƒä¿®æ”¹ï¼šæ‰€æœ‰ä¸‹æ¬¡æ—¥æœŸè¨ˆç®—ï¼Œæœ€å¾Œéƒ½è¦ç¶“é adjustForWeekend**
        window.app.calculateNextScheduleDate = function(schedule, fromDate) { 
            if (!schedule) return null; 
            const start = new Date(fromDate); 
            let resultDate = null;

            if ((schedule.mode === 'weekly' || schedule.mode === 'biweekly') && schedule.weekdays && schedule.weekdays.length > 0) { 
                const nextDates = window.app.calculateNextWeeklyDates(start, schedule.weekdays, 1); 
                if (nextDates.length > 0) { 
                    let nextDate = nextDates[0]; 
                    if (schedule.mode === 'biweekly') { nextDate.setDate(nextDate.getDate() + 7); } 
                    resultDate = nextDate;
                } 
            } else if (schedule.mode === 'interval' && schedule.interval) { 
                const next = new Date(start); 
                next.setDate(next.getDate() + parseInt(schedule.interval)); 
                resultDate = next;
            } 
            
            // æœ€çµ‚é˜²ç·šï¼šç¢ºä¿å­˜å…¥è³‡æ–™åº«çš„æ—¥æœŸä¸æ˜¯é€±æœ«
            if (resultDate) {
                return window.app.adjustForWeekend(resultDate);
            }
            return null; 
        };
        
        window.app.calculateOverdueDates = function(nextDateStr, schedule) {
            if (!nextDateStr || !schedule) return [];
            const nextDate = new Date(nextDateStr);
            const today = new Date();
            today.setHours(0,0,0,0);
            nextDate.setHours(0,0,0,0);

            // é€™è£¡ä¸éœ€è¦æ”¹ï¼Œå› ç‚ºæ˜¯å¦ã€Œç®—ã€é€¾æœŸï¼Œç”±é¡¯ç¤ºå±¤(Dashboard/Report)æ±ºå®š
            // é€™è£¡è² è²¬æ‰¾å‡ºæ‰€æœ‰ã€Œåœ¨ä»Šå¤©ä¹‹å‰ã€æ‡‰è©²ç™¼ç”Ÿä½†æ²’ç™¼ç”Ÿçš„æ—¥æœŸé»
            if (nextDate >= today) return []; 

            let missedDates = [];
            let current = new Date(nextDate);
            let loops = 0;
            while (current < today && loops < 50) {
                missedDates.push(new Date(current));
                let next = window.app.calculateNextScheduleDate(schedule, current);
                if (!next || next <= current) break; 
                current = next;
                current.setHours(0,0,0,0);
                loops++;
            }
            return missedDates;
        };
        
        // --- æ–°å¢: æœˆæ›†æª¢è¦–ç›¸é—œåŠŸèƒ½ ---
        window.app.toggleCalendarView = function() {
            const container = document.getElementById('calendar-view-container');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                // Set default to current month if not set
                if (!document.getElementById('calendar-month-select').value) {
                    const now = new Date();
                    const yyyy = now.getFullYear();
                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                    document.getElementById('calendar-month-select').value = `${yyyy}-${mm}`;
                }
                window.app.renderCalendarView();
            } else {
                container.classList.add('hidden');
            }
        };

        window.app.renderCalendarView = function() {
            const container = document.getElementById('calendar-weeks-list');
            const monthVal = document.getElementById('calendar-month-select').value;
            if (!monthVal || !currentCheckId) return;

            const [year, month] = monthVal.split('-').map(Number);
            // ä¾æ“š KT å ±è¡¨é€±æ¬¡å®šç¾©: 1-7, 8-14, 15-21, 22-28, 29-End
            const endDate = new Date(year, month, 0); // Last day of month
            
            const weeks = [
                { id: 1, start: 1, end: 7 },
                { id: 2, start: 8, end: 14 },
                { id: 3, start: 15, end: 21 },
                { id: 4, start: 22, end: 28 },
                { id: 5, start: 29, end: endDate.getDate() }
            ];

            const deviceHistory = checkHistory.filter(h => h.deviceId === currentCheckId);
            
            let html = '';
            
            weeks.forEach(w => {
                if (w.start > endDate.getDate()) return;

                // æ‰¾å°‹æ˜¯å¦æœ‰ç´€éŒ„è½åœ¨é€™å€‹å€é–“
                const record = deviceHistory.find(h => {
                    const d = h.checkTimestamp.toDate();
                    return d.getFullYear() === year && d.getMonth() === (month - 1) && d.getDate() >= w.start && d.getDate() <= w.end;
                });
                
                // è¨­å®šè£œç™»ç›®æ¨™æ—¥æœŸ (è©²é€±èµ·å§‹æ—¥)
                const targetDate = new Date(year, month - 1, w.start);
                const targetDateStr = window.app.formatDate(targetDate);
                const isFuture = targetDate > new Date();

                if (record) {
                    const recordDate = window.app.formatDate(record.checkTimestamp.toDate());
                    html += `
                        <div class="flex justify-between items-center p-2 bg-green-50 border border-green-200 rounded">
                            <div class="flex items-center">
                                 <span class="text-green-600 font-bold mr-2 text-sm">âœ… ç¬¬ ${w.id} é€±</span>
                                 <span class="text-xs text-green-700">(${month}/${w.start}~${month}/${w.end})</span>
                            </div>
                            <span class="text-xs font-mono text-green-800 font-bold">å·²å®Œæˆ: ${recordDate}</span>
                        </div>
                    `;
                } else {
                     const statusText = isFuture ? 'å°šæœªé–‹å§‹' : 'æœªå®Œæˆ';
                     const btnText = isFuture ? 'é å¡«' : 'è£œç™»';
                     const btnClass = isFuture ? 'text-indigo-600 bg-indigo-50 border-indigo-200' : 'text-red-600 bg-red-50 border-red-200 hover:bg-red-100';

                    html += `
                        <div class="flex justify-between items-center p-2 bg-white border border-gray-200 rounded">
                            <div class="flex items-center">
                                 <span class="text-gray-500 font-bold mr-2 text-sm">â¬œ ç¬¬ ${w.id} é€±</span>
                                 <span class="text-xs text-gray-400">(${month}/${w.start}~${month}/${w.end})</span>
                            </div>
                            <button onclick="window.app.selectRetroactiveDate('${targetDateStr}')" class="px-3 py-1 text-xs font-bold border rounded ${btnClass}">
                                ${btnText}
                            </button>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        };

        window.app.selectRetroactiveDate = function(dateStr) {
            document.getElementById('check-date-input').value = dateStr;
            window.app.updateWeekDisplay(dateStr);
            showToast(`å·²è¨­å®šè£œç™»æ—¥æœŸ: ${dateStr}ï¼Œè«‹é–‹å§‹å¡«å¯«è¡¨æ ¼`, 'success');
            // é¸æ“‡æ€§: è¨­å®šå®Œæ—¥æœŸå¾Œå¯ä»¥è‡ªå‹•æ”¶èµ·æ—¥æ›†ï¼Œæˆ–ä¿æŒé–‹å•Ÿ
            // window.app.toggleCalendarView(); 
        };
        // --- çµæŸæ–°å¢ ---

        let confirmCallback = null;
        window.app.confirmAction = function(message, callback) { document.getElementById('custom-confirm-msg').textContent = message; confirmCallback = callback; document.getElementById('custom-confirm-modal').classList.remove('hidden'); document.getElementById('custom-confirm-modal').classList.add('flex'); };
        window.app.closeConfirmModal = function() { document.getElementById('custom-confirm-modal').classList.add('hidden'); document.getElementById('custom-confirm-modal').classList.remove('flex'); confirmCallback = null; };
        const confirmBtn = document.getElementById('custom-confirm-btn-yes'); if(confirmBtn) { confirmBtn.onclick = function() { if (confirmCallback) confirmCallback(); window.app.closeConfirmModal(); }; }

        window.app.printReport = function() { const reportContent = document.getElementById('report-content').innerHTML; if (!reportContent.trim()) { showToast("ç„¡å ±è¡¨å…§å®¹å¯åˆ—å°", "error"); return; } const title = document.getElementById('report-title').textContent; const printWindow = window.open('', '_blank'); if (!printWindow) { alert("ç€è¦½å™¨æ””æˆªäº†å½ˆè·³è¦–çª—ï¼Œè«‹å…è¨±æœ¬ç¶²ç«™çš„å½ˆè·³è¦–çª—ä»¥é€²è¡Œåˆ—å°ã€‚"); return; } printWindow.document.write('<html><head><title>' + title + '</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">'); const styles = document.querySelectorAll('style'); styles.forEach(style => { printWindow.document.write(style.outerHTML); }); printWindow.document.write('<style>body { background-color: white !important; margin: 0; padding: 20px; -webkit-print-color-adjust: exact; } .page-break { page-break-after: always; display: block; position: relative; } @media print { .page-break { break-after: page; } body { padding: 0; } }</style></head><body>'); printWindow.document.write(reportContent); printWindow.document.write('</body></html>'); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); }, 1000); };

        const firebaseConfig = { apiKey: "", authDomain: "checklist-20250825.firebaseapp.com", databaseURL: "https://checklist-20250825-default-rtdb.firebaseio.com", projectId: "checklist-20250825", storageBucket: "checklist-20250825.appspot.com", messagingSenderId: "899658463753", appId: "1:899658463753:web:71819671db2cdf6bf4d6d8", measurementId: "G-FH3F97BZ7F" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        function getCollectionRef(name) { return collection(db, name); }
        function getDocRef(colName, docId) { return doc(db, colName, docId); }

        const init = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const scanId = urlParams.get('id');
            if(scanId) window.app.pendingScanId = scanId;
            window.app.loginAsGuest();
            startListeners();
            const today = window.app.formatDate(new Date());
            const currentMonth = new Date().toISOString().slice(0,7);
            const startDateEl = document.getElementById('report-start-date'); if(startDateEl) startDateEl.value = today;
            const endDateEl = document.getElementById('report-end-date'); if(endDateEl) endDateEl.value = today;
            const reportMonthEl = document.getElementById('report-month'); if(reportMonthEl) reportMonthEl.value = currentMonth;
            const reportTypeSelect = document.getElementById('report-type'); if(reportTypeSelect) { reportTypeSelect.addEventListener('change', window.app.handleReportTypeChange); }
        };

        window.app.loginAsGuest = function() { loggedInUser = { id: 'guest', name: 'è¨ªå®¢', role: 'guest' }; document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('user-switch-modal').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); updateUIState(); };
        window.app.showUserSwitchModal = function() { document.getElementById('user-switch-modal').classList.remove('hidden'); renderLoginOptions(); };
        window.app.updateWeekDisplay = function(dateStr) { if(!dateStr) return; const date = new Date(dateStr); const day = date.getDate(); const month = date.getMonth() + 1; let week = 0; if(day <= 7) week = 1; else if(day <= 14) week = 2; else if(day <= 21) week = 3; else if(day <= 28) week = 4; else week = 5; const display = document.getElementById('week-display'); if(display) display.textContent = `${month}æœˆ ç¬¬ ${week} é€±`; }
        window.app.getThisWeekRange = function() { const today = new Date(); const currentDay = today.getDay(); const diffToMonday = currentDay === 0 ? -6 : 1 - currentDay; const monday = new Date(today); monday.setDate(today.getDate() + diffToMonday); monday.setHours(0,0,0,0); const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999); return { start: monday, end: sunday }; };
        window.app.switchTaskMode = function(mode) {
            currentTaskMode = mode;
            ['check', 'clean', 'part'].forEach(m => document.getElementById(`tab-mode-${m}`).className = 'task-tab');
            document.getElementById(`tab-mode-${mode}`).classList.add(`active-${mode}`);
            const btnStart = document.getElementById('manual-start-button'); const btnMaint = document.getElementById('manual-maintenance-button'); const btnReplace = document.getElementById('manual-replace-button');
            btnStart.classList.add('hidden'); btnMaint.classList.add('hidden'); btnReplace.classList.add('hidden');
            if (mode === 'check') { btnStart.classList.remove('hidden'); document.getElementById('manual-select-title').textContent = 'æ‰‹å‹•é¸æ“‡è¨­å‚™ (é»æª¢æ¨¡å¼)'; } else if (mode === 'clean') { btnMaint.classList.remove('hidden'); document.getElementById('manual-select-title').textContent = 'æ‰‹å‹•é¸æ“‡è¨­å‚™ (æ¸…æ½”æ¨¡å¼)'; } else if (mode === 'part') { btnReplace.classList.remove('hidden'); document.getElementById('manual-select-title').textContent = 'æ‰‹å‹•é¸æ“‡è¨­å‚™ (è€—ææ¨¡å¼)'; }
            window.app.renderDashboard(); 
        };
        window.app.handleManualReplace = function() { const id = document.getElementById('manual-device-select').value; if (loggedInUser.role === 'guest') return showToast("è¨ªå®¢æ¬Šé™ä¸è¶³", "error"); window.app.handleManualReplaceOpen(id); };
        window.app.handleManualReplaceOpen = function(id) {
             currentMaintEqId = id; document.getElementById('maint-device-name').textContent = equipmentDatabase[id].name; const compSelect = document.getElementById('maintenance-component-name'); compSelect.innerHTML = ''; document.getElementById('maintenance-notes').value = ''; document.getElementById('maint-image-preview').src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; document.getElementById('maint-image-preview').removeAttribute('data-image-data-url'); document.getElementById('maint-image-upload').value = ''; const comps = equipmentDatabase[id].components || []; if(comps.length > 0) comps.forEach(c => compSelect.add(new Option(c.name, c.name))); else compSelect.add(new Option('ç„¡é›¶ä»¶è³‡æ–™', '')); document.getElementById('maintenance-type').value = 'replacement'; window.app.toggleMaintType(); 
             document.getElementById('maint-date-input').value = window.app.formatDate(new Date());
             document.getElementById('maintenance-modal').classList.remove('hidden');
        };
        window.app.startChecklist = function(id) { startChecklist(id); };

        window.app.renderDashboard = function() {
            const todoList = document.getElementById('todo-list-container'); const completedList = document.getElementById('completed-list-container'); if(!todoList || !completedList) return;
            const { start, end } = window.app.getThisWeekRange();
            document.getElementById('dashboard-date-range').textContent = `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;
            const icon = document.getElementById('dashboard-icon'); const title = document.getElementById('dashboard-title');
            if(currentTaskMode === 'check') { icon.textContent = 'ğŸ“‹'; title.textContent = 'å·¥ä½œæ¦‚è¦½ (é»æª¢)'; } else if(currentTaskMode === 'clean') { icon.textContent = 'ğŸ§¹'; title.textContent = 'å·¥ä½œæ¦‚è¦½ (æ¸…æ½”)'; } else { icon.textContent = 'âš™ï¸'; title.textContent = 'è€—ææ›´æ›ç´€éŒ„'; }
            const ownerFilter = document.getElementById('dashboard-owner-filter').value; const categoryFilter = document.getElementById('dashboard-category-filter').value;
            
            let pendingItems = []; 
            let completedItems = [];

            Object.values(equipmentDatabase).forEach(eq => {
                if(categoryFilter !== 'ALL' && (eq.category || 'æœªåˆ†é¡') !== categoryFilter) return; 
                if(ownerFilter !== 'ALL' && eq.primaryOwnerId !== ownerFilter) return; 
                if(eq.status !== 'ä½¿ç”¨ä¸­') return;
                
                if(currentTaskMode === 'check') {
                    // Check Logic
                    const isDone = checkHistory.some(h => { const d = h.checkTimestamp?.toDate(); return d >= start && d <= end && h.deviceId === eq.id; });
                    if(isDone) {
                        completedItems.push({ name: eq.name, id: eq.id });
                    } else {
                        const nextDate = eq.nextCheckDate ? new Date(eq.nextCheckDate) : new Date(0);
                        // åˆ¤å®šé‚è¼¯: 
                        // 1. å¦‚æœ nextDate å°æ–¼ æœ¬é€±ä¸€ => Overdue (Red)
                        // 2. å¦‚æœ nextDate åœ¨ æœ¬é€±ä¸€ ~ æœ¬é€±æ—¥ => Pending (This Week)
                        
                        // nextDate ä¸éœ€è¦æ™‚åˆ†ç§’
                        nextDate.setHours(0,0,0,0);
                        const thisWeekStart = new Date(start); thisWeekStart.setHours(0,0,0,0);
                        const thisWeekEnd = new Date(end); thisWeekEnd.setHours(23,59,59,999);

                        if (nextDate < thisWeekStart) {
                             // Overdue
                             pendingItems.push({ name: eq.name, id: eq.id, date: eq.nextCheckDate, status: 'overdue' });
                        } else if (nextDate <= thisWeekEnd) {
                             // This Week
                             pendingItems.push({ name: eq.name, id: eq.id, date: eq.nextCheckDate, status: 'pending' });
                        }
                    }
                } else if(currentTaskMode === 'clean') {
                    // Clean Logic
                    const isDone = maintenanceHistory.some(h => { const d = h.timestamp?.toDate(); return d >= start && d <= end && h.deviceId === eq.id && h.type === 'cleaning'; });
                    if(isDone) {
                        completedItems.push({ name: eq.name, id: eq.id });
                    } else {
                        const nextDate = eq.nextCleaningDate ? new Date(eq.nextCleaningDate) : new Date(0);
                        nextDate.setHours(0,0,0,0);
                        const thisWeekStart = new Date(start); thisWeekStart.setHours(0,0,0,0);
                        const thisWeekEnd = new Date(end); thisWeekEnd.setHours(23,59,59,999);

                        if (nextDate < thisWeekStart) {
                             pendingItems.push({ name: eq.name, id: eq.id, date: eq.nextCleaningDate, status: 'overdue' });
                        } else if (nextDate <= thisWeekEnd) {
                             pendingItems.push({ name: eq.name, id: eq.id, date: eq.nextCleaningDate, status: 'pending' });
                        }
                    }
                }
            });

            // Render Pending List
            todoList.innerHTML = ''; 
            if(pendingItems.length === 0) {
                todoList.innerHTML = '<p class="text-center text-sm text-gray-400 py-2">ç›®å‰ç„¡å¾…è¾¦äº‹é …</p>'; 
            } else { 
                // Sort: Overdue first, then by date
                pendingItems.sort((a,b) => {
                    if (a.status === 'overdue' && b.status !== 'overdue') return -1;
                    if (a.status !== 'overdue' && b.status === 'overdue') return 1;
                    return new Date(a.date) - new Date(b.date);
                });

                pendingItems.forEach(item => { 
                    const action = currentTaskMode === 'check' ? `window.app.startChecklist('${item.id}')` : `window.app.showMaintenanceModal('${item.id}')`; 
                    let statusHtml = '';
                    if (item.status === 'overdue') {
                        // é€¾æœŸé¡¯ç¤ºé€±æ¬¡å€é–“
                        const rangeStr = window.app.getWeekRangeString(item.date);
                        statusHtml = `<div class="text-xs text-red-600 font-bold flex items-center mt-1">âš ï¸ é€¾æœŸ: ${rangeStr}</div>`;
                    } else {
                        // æœ¬é€±å¾…è¾¦é¡¯ç¤ºæ—¥æœŸ
                        statusHtml = `<div class="text-xs text-slate-400 mt-1">é è¨ˆ: ${item.date || 'æœ¬é€±'}</div>`;
                    }

                    todoList.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-white border rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer mb-2" onclick="${action}">
                        <div>
                            <div class="font-bold text-slate-700 text-sm">${item.name}</div>
                            ${statusHtml}
                        </div>
                        <button class="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded text-xs font-bold border border-indigo-100 hover:bg-indigo-100">åŸ·è¡Œ</button>
                    </div>`; 
                }); 
            }
            
            completedList.innerHTML = ''; 
            if(completedItems.length === 0) completedList.innerHTML = '<p class="text-gray-400 text-xs pl-2">æœ¬é€±å°šç„¡å®Œæˆé …ç›®</p>'; 
            else { 
                completedItems.forEach(item => { 
                    completedList.innerHTML += `<div class="flex items-center p-2 border-b border-gray-100 last:border-0"><span class="text-green-500 mr-2 font-bold">âœ“</span><span class="text-gray-500 text-sm line-through opacity-75">${item.name}</span></div>`; 
                }); 
            }
            
            document.getElementById('completed-section-toggle').classList.toggle('hidden', completedItems.length === 0);
            
            // Counts
            const overdueCount = pendingItems.filter(i => i.status === 'overdue').length;
            const weekPendingCount = pendingItems.filter(i => i.status === 'pending').length;
            
            // Update labels to reflect new logic
            document.getElementById('label-pending').innerHTML = overdueCount > 0 ? `æœ¬é€±å¾…è¾¦ <span class="text-red-500 text-[10px] ml-1">(${overdueCount} é€¾æœŸ)</span>` : 'æœ¬é€±å¾…è¾¦';
            document.getElementById('count-pending').textContent = weekPendingCount + overdueCount;
            document.getElementById('count-completed').textContent = completedItems.length;
            
            // Progress based on (Completed) / (Completed + This Week Pending). Ignoring Overdue in denominator? 
            // Usually progress is for "This Week's Goal".
            const totalThisWeek = weekPendingCount + completedItems.length; 
            const percentage = totalThisWeek === 0 ? 0 : Math.round((completedItems.length / totalThisWeek) * 100); 
            document.getElementById('dashboard-progress-text').textContent = `${percentage}%`; 
            document.getElementById('dashboard-progress-bar').style.width = `${percentage}%`;
        };

        window.app.handleReportTypeChange = function() { 
            const type = document.getElementById('report-type').value; 
            const dateContainer = document.getElementById('date-range-container'); 
            const ktOptionsContainer = document.getElementById('kt-report-options'); 
            
            dateContainer.classList.add('hidden');
            dateContainer.classList.remove('contents'); 
            ktOptionsContainer.classList.add('hidden');
            
            if (type === 'kt_weekly') { 
                ktOptionsContainer.classList.remove('hidden'); 
            } else if (type === 'overdue') {
                // Overdue doesn't need date range, implies "As of Now"
            } else { 
                dateContainer.classList.remove('hidden'); 
                dateContainer.classList.add('contents'); 
            } 
        };

        function startListeners() {
            onSnapshot(getCollectionRef("users"), (snap) => { 
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; }); userDatabase = newData; renderLoginOptions(); 
                const listContainer = document.getElementById('user-list-container');
                if (listContainer && listContainer.offsetParent) window.app.renderUserList(); 
            });
            onSnapshot(getCollectionRef("equipment"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                equipmentDatabase = newData;
                window.app.renderEquipmentList();
                const checkHistoryEl = document.getElementById('admin-tab-content-checklistHistory');
                if (checkHistoryEl && checkHistoryEl.offsetParent) window.app.renderChecklistHistory(null, null, false);
                const maintHistoryEl = document.getElementById('admin-tab-content-maintenanceHistory');
                if (maintHistoryEl && maintHistoryEl.offsetParent) window.app.renderMaintenanceHistory(null, null, false);
                populateManualDropdown(); populateReportCategoryDropdown(); window.app.renderDashboard(); 
                if(window.app.pendingScanId && loggedInUser && equipmentDatabase[window.app.pendingScanId]) { window.app.handleScanResult(window.app.pendingScanId); window.app.pendingScanId = null; try { window.history.replaceState({}, document.title, window.location.pathname); } catch(e){} }
            });
            onSnapshot(getCollectionRef("checklist_templates"), (snap) => { 
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; }); templateDatabase = newData; 
                const tmplList = document.getElementById('template-list-section');
                if (tmplList && tmplList.offsetParent) window.app.renderTemplateList(); 
            });
            onSnapshot(getCollectionRef("check_history"), (snap) => { 
                checkHistory = snap.docs.map(d => ({id: d.id, ...d.data()})); 
                const checkHistoryEl = document.getElementById('admin-tab-content-checklistHistory');
                if(checkHistoryEl && checkHistoryEl.offsetParent) window.app.renderChecklistHistory(null, null, false); 
                window.app.renderDashboard(); 
            });
            onSnapshot(getCollectionRef("maintenance_history"), (snap) => { 
                maintenanceHistory = snap.docs.map(d => ({id: d.id, ...d.data()})); 
                const maintHistoryEl = document.getElementById('admin-tab-content-maintenanceHistory');
                if(maintHistoryEl && maintHistoryEl.offsetParent) window.app.renderMaintenanceHistory(null, null, false); 
                window.app.renderDashboard(); 
            });
        }

        function populateReportCategoryDropdown() { const sel = document.getElementById('report-category'); if(!sel) return; const currentVal = sel.value; const cats = new Set(['ALL']); Object.values(equipmentDatabase).forEach(e => { if(e.category) cats.add(e.category); else cats.add('æœªåˆ†é¡'); }); sel.innerHTML = ''; Array.from(cats).sort((a,b) => { if(a === 'ALL') return -1; if(b === 'ALL') return 1; return a.localeCompare(b, 'zh-TW'); }).forEach(c => { sel.add(new Option(c === 'ALL' ? 'å…¨éƒ¨åˆ†é¡' : c, c)); }); if(currentVal && Array.from(sel.options).some(o => o.value === currentVal)) sel.value = currentVal; else sel.value = 'ALL'; }
        function renderLoginOptions() { const select = document.getElementById('login-user-select'); if(!select) return; select.innerHTML = '<option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>'; Object.values(userDatabase).forEach(user => { const roleText = user.role === 'manager' ? 'ğŸ‘‘ ç®¡ç†å“¡' : 'ğŸ”§ æ“ä½œå“¡'; select.add(new Option(`${roleText} - ${user.name}`, user.id)); }); }
        window.app.handleLogin = function() { const select = document.getElementById('login-user-select'); const userId = select.value; if (userId === 'guest') { loggedInUser = { id: 'guest', name: 'è¨ªå®¢', role: 'guest' }; } else { loggedInUser = userDatabase[userId]; } if (!loggedInUser) return showToast("ç™»å…¥éŒ¯èª¤ï¼Œè«‹é‡è©¦", "error"); document.getElementById('user-switch-modal').classList.add('hidden'); updateUIState(); if(window.app.pendingScanId && equipmentDatabase[window.app.pendingScanId]) { window.app.handleScanResult(window.app.pendingScanId); window.app.pendingScanId = null; } };
        
        window.app.generateReport = function() {
            const type = document.getElementById('report-type').value; 
            const category = document.getElementById('report-category').value; 
            let start, end;

            if (type !== 'overdue' && type !== 'kt_weekly') {
                start = new Date(document.getElementById('report-start-date').value); 
                end = new Date(document.getElementById('report-end-date').value); 
                end.setHours(23,59,59);
            }
            if (type === 'kt_weekly') { 
                const monthVal = document.getElementById('report-month').value; 
                if (!monthVal) return showToast("è«‹é¸æ“‡æœˆä»½", "error"); 
                const [year, month] = monthVal.split('-'); 
                start = new Date(year, month - 1, 1); 
                end = new Date(year, month, 0, 23, 59, 59); 
            }

            const container = document.getElementById('report-preview-container'); 
            const content = document.getElementById('report-content'); 
            const title = document.getElementById('report-title'); 
            const subtitle = document.getElementById('report-subtitle');
            
            container.classList.remove('hidden'); 
            document.getElementById('report-actions').classList.remove('hidden');

            // --- é€¾æœŸå ±è¡¨ (Overdue Report) - Week Logic ---
            if (type === 'overdue') {
                title.textContent = "é€¾æœŸæœªåŸ·è¡Œå ±è¡¨ (é€±ç®¡ç†)";
                const now = new Date();
                subtitle.textContent = `çµ±è¨ˆæ™‚é–“: ${now.toLocaleString()}`;
                
                // å®šç¾©æœ¬é€±é–‹å§‹æ™‚é–“ï¼Œå‡¡æ˜¯å°æ–¼æ­¤æ™‚é–“çš„ "Next Date" æ‰ç®—é€¾æœŸ
                const { start: thisWeekStart } = window.app.getThisWeekRange();
                
                let html = '';
                const thStyle = 'border: 1px solid #94a3b8; padding: 8px; background-color: #f1f5f9; font-weight: bold;'; 
                const tdStyle = 'border: 1px solid #94a3b8; padding: 8px;';

                // --- Part 1: Overdue Check (é»æª¢é€¾æœŸ) ---
                html += '<h3 class="text-xl font-bold text-slate-700 mt-4 mb-2 border-l-4 border-indigo-600 pl-2">ğŸ“‹ é»æª¢é€¾æœŸæ¸…å–® (Check Overdue)</h3>';
                html += '<table style="width:100%; border-collapse: collapse; font-size: 14px; text-align: left; margin-bottom: 20px;">'; 
                html += `<thead><tr><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">åˆ†é¡</th><th style="${thStyle}">æœªåŸ·è¡Œé€±æ¬¡ (Missed Weeks)</th><th style="${thStyle}">è² è²¬äºº</th></tr></thead><tbody>`;

                let overdueCheckList = [];
                Object.values(equipmentDatabase).forEach(eq => {
                    if (category !== 'ALL' && (eq.category || 'æœªåˆ†é¡') !== category) return;
                    if (eq.status !== 'ä½¿ç”¨ä¸­') return;
                    
                    const missedDates = window.app.calculateOverdueDates(eq.nextCheckDate, eq.checkSchedule);
                    // Filter: Only strictly before this week
                    const realOverdue = missedDates.filter(d => d < thisWeekStart);

                    if (realOverdue.length > 0) {
                        const ownerName = eq.primaryOwnerId ? (userDatabase[eq.primaryOwnerId]?.name || 'æœªçŸ¥') : 'æœªè¨­å®š';
                        overdueCheckList.push({
                            name: eq.name,
                            category: eq.category || 'æœªåˆ†é¡',
                            // è½‰æ›æˆé€±æ¬¡å­—ä¸²
                            weeks: realOverdue.map(d => window.app.getWeekRangeString(d)).join('<br>'),
                            count: realOverdue.length,
                            owner: ownerName
                        });
                    }
                });
                
                if (overdueCheckList.length === 0) html += `<tr><td colspan="4" style="${tdStyle} text-align:center;">ç„¡é€¾æœŸé»æª¢é …ç›®</td></tr>`;
                else {
                    overdueCheckList.forEach(item => {
                        html += `<tr><td style="${tdStyle}">${item.name}</td><td style="${tdStyle}">${item.category}</td><td style="${tdStyle} color:#ef4444; font-weight:bold;">${item.weeks}</td><td style="${tdStyle}">${item.owner}</td></tr>`;
                    });
                }
                html += '</tbody></table>';

                // --- Part 2: Overdue Clean (æ¸…æ½”é€¾æœŸ) ---
                html += '<h3 class="text-xl font-bold text-slate-700 mt-4 mb-2 border-l-4 border-orange-500 pl-2">ğŸ§¹ æ¸…æ½”ä¿é¤Šé€¾æœŸæ¸…å–® (Clean Overdue)</h3>';
                html += '<table style="width:100%; border-collapse: collapse; font-size: 14px; text-align: left;">'; 
                html += `<thead><tr><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">åˆ†é¡</th><th style="${thStyle}">æœªåŸ·è¡Œé€±æ¬¡ (Missed Weeks)</th><th style="${thStyle}">è² è²¬äºº</th></tr></thead><tbody>`;

                let overdueCleanList = [];
                Object.values(equipmentDatabase).forEach(eq => {
                    if (category !== 'ALL' && (eq.category || 'æœªåˆ†é¡') !== category) return;
                    if (eq.status !== 'ä½¿ç”¨ä¸­') return;
                    
                    const missedDates = window.app.calculateOverdueDates(eq.nextCleaningDate, eq.cleaningSchedule);
                    const realOverdue = missedDates.filter(d => d < thisWeekStart);

                    if (realOverdue.length > 0) {
                        const ownerName = eq.primaryOwnerId ? (userDatabase[eq.primaryOwnerId]?.name || 'æœªçŸ¥') : 'æœªè¨­å®š';
                        overdueCleanList.push({
                            name: eq.name,
                            category: eq.category || 'æœªåˆ†é¡',
                            weeks: realOverdue.map(d => window.app.getWeekRangeString(d)).join('<br>'),
                            count: realOverdue.length,
                            owner: ownerName
                        });
                    }
                });

                if (overdueCleanList.length === 0) html += `<tr><td colspan="4" style="${tdStyle} text-align:center;">ç„¡é€¾æœŸæ¸…æ½”é …ç›®</td></tr>`;
                else {
                    overdueCleanList.forEach(item => {
                        html += `<tr><td style="${tdStyle}">${item.name}</td><td style="${tdStyle}">${item.category}</td><td style="${tdStyle} color:#c2410c; font-weight:bold;">${item.weeks}</td><td style="${tdStyle}">${item.owner}</td></tr>`;
                    });
                }
                html += '</tbody></table>';

                content.innerHTML = html;
                return;
            }

            // --- Retroactive Analysis Report (æ•ˆç‡åˆ†æ) ---
            if (type === 'analysis_retroactive') {
                title.textContent = "è£œç™»åˆ†æå ±è¡¨ (Efficiency Analysis)";
                const dateStr = `${window.app.formatDate(start)} ~ ${window.app.formatDate(end)}`;
                subtitle.textContent = `åˆ†æå€é–“: ${dateStr}`;
                
                let html = '<table style="width:100%; border-collapse: collapse; font-size: 14px; text-align: left;">'; 
                const thStyle = 'border: 1px solid #94a3b8; padding: 8px; background-color: #f1f5f9; font-weight: bold;'; 
                const tdStyle = 'border: 1px solid #94a3b8; padding: 8px;';
                html += `<thead><tr><th style="${thStyle}">æ‡‰åŸ·è¡Œæ—¥æœŸ (Selected Date)</th><th style="${thStyle}">å¯¦éš›é€å‡ºæ™‚é–“ (Actual Submit)</th><th style="${thStyle}">é¡å‹</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">äººå“¡</th><th style="${thStyle}">ç‹€æ…‹</th><th style="${thStyle}">å»¶é²å¤©æ•¸</th></tr></thead><tbody>`;

                let combinedRecords = [];
                
                // Add Check Records
                checkHistory.forEach(r => {
                    const selectedDate = r.checkTimestamp?.toDate();
                    const createdDate = r.createdTimestamp?.toDate() || selectedDate; // Fallback if old data
                    if (selectedDate >= start && selectedDate <= end) {
                        combinedRecords.push({
                            type: 'é»æª¢',
                            name: r.deviceName,
                            user: r.userName,
                            selectedDate: selectedDate,
                            createdDate: createdDate
                        });
                    }
                });

                // Add Maintenance Records
                maintenanceHistory.forEach(r => {
                    // Maintenance usually defaults to "now" unless backfilled with new feature
                    const selectedDate = r.timestamp?.toDate(); 
                    const createdDate = r.createdTimestamp?.toDate() || selectedDate;
                    if (selectedDate >= start && selectedDate <= end) {
                        combinedRecords.push({
                            type: r.type === 'cleaning' ? 'æ¸…æ½”' : 'æ›´æ›',
                            name: r.deviceName,
                            user: r.userName,
                            selectedDate: selectedDate,
                            createdDate: createdDate
                        });
                    }
                });

                combinedRecords.sort((a, b) => b.selectedDate - a.selectedDate);

                if (combinedRecords.length === 0) {
                    html += `<tr><td colspan="7" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`;
                } else {
                    combinedRecords.forEach(r => {
                        const selStr = window.app.formatDate(r.selectedDate);
                        const actStr = r.createdDate.toLocaleString();
                        
                        // Calculate Diff (ignoring hours for "Same Day" logic)
                        const selMidnight = new Date(r.selectedDate); selMidnight.setHours(0,0,0,0);
                        const actMidnight = new Date(r.createdDate); actMidnight.setHours(0,0,0,0);
                        
                        const diffTime = actMidnight - selMidnight;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        let statusHtml = '<span class="text-green-600 font-bold">æº–æ™‚</span>';
                        let delayStr = '-';
                        
                        if (diffDays > 0) {
                            statusHtml = '<span class="text-red-600 font-bold">è£œç™» (Retroactive)</span>';
                            delayStr = `${diffDays} å¤©`;
                        } else if (diffDays < 0) {
                             statusHtml = '<span class="text-blue-600 font-bold">æå‰</span>';
                        }

                        html += `<tr>
                            <td style="${tdStyle}">${selStr}</td>
                            <td style="${tdStyle}">${actStr}</td>
                            <td style="${tdStyle}">${r.type}</td>
                            <td style="${tdStyle}">${r.name}</td>
                            <td style="${tdStyle}">${r.user}</td>
                            <td style="${tdStyle}">${statusHtml}</td>
                            <td style="${tdStyle}">${delayStr}</td>
                        </tr>`;
                    });
                }
                html += '</tbody></table>';
                content.innerHTML = html;
                return;
            }
            
            // --- å»£æ³°å ±è¡¨ (Kuang Tai Report) ---
            if (type === 'kt_weekly') {
                 // ... (Keep existing complex logic) ...
                 title.textContent = "è¨­å‚™é»æª¢è¡¨(é€±) - é è¦½";
                content.innerHTML = '<div class="text-center py-4">æ­£åœ¨ç”¢ç”Ÿå ±è¡¨...</div>';
                const filteredHistory = checkHistory.filter(h => { const d = h.checkTimestamp?.toDate(); return d >= start && d <= end; });
                let devices = Object.values(equipmentDatabase).sort((a,b) => (a.category||'').localeCompare(b.category||''));
                if (category !== 'ALL') devices = devices.filter(eq => (eq.category || 'æœªåˆ†é¡') === category);
                devices = devices.filter(eq => eq.includeInKtReport === true);
                if (devices.length === 0) { content.innerHTML = '<div class="text-center py-4 text-gray-500">æ­¤ç¯„åœç„¡è¨­å‚™è³‡æ–™ï¼Œæˆ–è¨­å‚™æœªå‹¾é¸ã€Œåˆ—å°æ–¼å»£æ³°é€±é»æª¢è¡¨ã€ã€‚</div>'; return; }
                const supervisorName = document.getElementById('report-supervisor').value || '';
                const year = start.getFullYear(); const month = start.getMonth(); 
                const lastDayOfMonth = new Date(year, month + 1, 0); 
                let signDate = new Date(lastDayOfMonth);
                const dayOfWeek = signDate.getDay(); 
                if (dayOfWeek === 0) signDate.setDate(signDate.getDate() - 2); 
                else if (dayOfWeek === 6) signDate.setDate(signDate.getDate() - 1); 
                const signYear = signDate.getFullYear(); const signMonth = signDate.getMonth() + 1; const signDay = signDate.getDate();
                let reportHtml = '';
                devices.forEach(eq => {
                     const eqLogs = filteredHistory.filter(h => h.deviceId === eq.id);
                    const reportMonth = start.getMonth() + 1; const reportYear = start.getFullYear();
                    const groupedItems = {};
                    if(eq.items) { eq.items.forEach(cat => { if (!groupedItems[cat.category]) groupedItems[cat.category] = []; cat.subItems.forEach(sub => { groupedItems[cat.category].push({ text: sub.text, 1: '', 2: '', 3: '', 4: '', 5: '' }); }); }); }
                    const signatures = { 1: '', 2: '', 3: '', 4: '', 5: '' }; const dates = { 1: '', 2: '', 3: '', 4: '', 5: '' };
                    eqLogs.forEach(log => { const d = log.checkTimestamp.toDate(); const day = d.getDate(); let week = 0; if(day <= 7) week = 1; else if(day <= 14) week = 2; else if(day <= 21) week = 3; else if(day <= 28) week = 4; else week = 5; dates[week] = `${d.getMonth()+1}/${d.getDate()}`; signatures[week] = log.userName; log.items.forEach(item => { if (groupedItems[item.category]) { const found = groupedItems[item.category].find(i => i.text === item.text); if (found) { const symbol = item.status === 'æ­£å¸¸' ? 'âœ“' : (item.status === 'ç•°å¸¸' ? 'X' : '/'); found[week] = symbol; } } }); });
                    let tableRowsHtml = ''; const categories = Object.keys(groupedItems); let currentRowCount = 0; categories.forEach(cat => { currentRowCount += groupedItems[cat].length; }); const targetRowCount = 19; 
                    if (categories.length === 0) { tableRowsHtml = `<tr><td colspan="8">ç„¡è¨­å®šé»æª¢é …ç›®</td></tr>`; } else { categories.forEach(catName => { const items = groupedItems[catName]; items.forEach((item, index) => { tableRowsHtml += '<tr>'; if (index === 0) { tableRowsHtml += `<td rowspan="${items.length}" style="width: 15%; font-weight: bold;">${catName}</td>`; } tableRowsHtml += `<td style="text-align: left; padding-left: 10px;">${item.text}</td><td style="width: 2.5%; text-align: center;">â—‹</td><td style="width: 2.5%;"></td><td style="width: 8%;">${item[1]}</td><td style="width: 8%;">${item[2]}</td><td style="width: 8%;">${item[3]}</td><td style="width: 8%;">${item[4]}</td><td style="width: 8%;">${item[5]}</td></tr>`; }); }); if (currentRowCount < targetRowCount) { const emptyRowsNeeded = targetRowCount - currentRowCount; for (let i = 0; i < emptyRowsNeeded; i++) { tableRowsHtml += `<tr><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td><td style="border: 1px solid black;">&nbsp;</td></tr>`; } } }
                    reportHtml += `<div class="page-break" style="padding: 20px; max-width: 210mm; margin: 0 auto;"><div class="kt-header"><div class="kt-logo-container"><img src="https://www.kuangtai.com/wp-content/uploads/2024/05/logo1.png" class="kt-logo" alt="Kuang Tai Logo"><div class="kt-logo-text">KUANG TAI</div></div><div class="kt-company-name">å»£æ³°é‡‘å±¬å·¥æ¥­(è‚¡)å…¬å¸</div><div class="kt-title-main">è¨­å‚™é»æª¢è¡¨(é€±)</div></div><table class="kt-info-table"><tr><td style="width: 15%; font-weight: bold; text-align: center;">è¨­å‚™ç·¨è™Ÿ</td><td style="width: 25%; text-align: center;">${eq.assetNumber || eq.id}</td><td style="width: 15%; font-weight: bold; text-align: center;">è¨­å‚™åç¨±</td><td style="width: 25%; text-align: center;">${eq.name}</td><td style="width: 20%; text-align: center;">${reportYear} å¹´ ${reportMonth} æœˆ</td></tr></table><table class="kt-report-table"><thead><tr><th colspan="2" rowspan="2" style="width: 45%;">é»æª¢é …ç›®</th><th colspan="2" style="width: 5%;">é€±æœŸ</th><th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬ä¸€é€±<br><span style="font-size:9px">${dates[1]||'æœˆ æ—¥'}</span></th><th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬äºŒé€±<br><span style="font-size:9px">${dates[2]||'æœˆ æ—¥'}</span></th><th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬ä¸‰é€±<br><span style="font-size:9px">${dates[3]||'æœˆ æ—¥'}</span></th><th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬å››é€±<br><span style="font-size:9px">${dates[4]||'æœˆ æ—¥'}</span></th><th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬äº”é€±<br><span style="font-size:9px">${dates[5]||'æœˆ æ—¥'}</span></th></tr><tr><th style="font-size: 12px; height: 15px;">é€±</th><th style="font-size: 12px; height: 15px;">æœˆ</th></tr></thead><tbody>${tableRowsHtml}<tr style="height: 50px;"><td colspan="4">æª¢æŸ¥äººå“¡ç°½å</td><td style="font-size: 75%;">${signatures[1]}</td><td style="font-size: 75%;">${signatures[2]}</td><td style="font-size: 75%;">${signatures[3]}</td><td style="font-size: 75%;">${signatures[4]}</td><td style="font-size: 75%;">${signatures[5]}</td></tr><tr style="height: 25px;"><td colspan="4">å‚™è¨»</td><td colspan="5"></td></tr></tbody></table><div class="kt-footer-notes"><div>é™„è¨»ï¼š</div><ol style="padding-left: 20px; margin: 5px 0;"><li>æœ¬è¡¨ç”±æ©Ÿå™¨(å„€å™¨)è¨­å‚™æ—©ç­æ“ä½œäººå“¡æ¯é€±ç¢ºå¯¦æª¢æŸ¥ï¼Œé»æª¢å¾Œæª¢æŸ¥äººå“¡é ˆç°½ç« ã€‚</li><li>æª¢æŸ¥çµæœæ­£å¸¸æ‰“âœ“ï¼Œä¸æ­£å¸¸æ‰“Xï¼Œä¸é©ç”¨é …ç›®æ‰“/ã€‚</li><li>ç™¼ç”Ÿä¸æ­£å¸¸æ‰“Xæ™‚ï¼Œé™¤äº†è¨˜éŒ„å¤–ï¼Œæª¢æŸ¥äººæ‡‰å‘èª²é•·å ±å‘Šï¼Œåœ¨èƒ½åŠ›æ¢ä»¶ä¸‹ï¼Œé€²è¡Œä¸€ç´šä¿é¤Šç¶­è­·ï¼Œç„¡æ³•è™•ç†æ™‚ç”³è«‹ç¶­ä¿®ã€‚</li></ol></div><div class="kt-sign-area" style="justify-content: flex-end; gap: 40px; padding-right: 20px;"><div>ä¸»ç®¡ï¼š<span style="border-bottom: 1px solid black; padding: 0 10px; display: inline-block; min-width: 80px; text-align: center;">${supervisorName}</span></div><div>æ—¥æœŸï¼š<span style="border-bottom: 1px solid black; padding: 0 10px;">${signYear}</span>å¹´<span style="border-bottom: 1px solid black; padding: 0 10px;">${signMonth}</span>æœˆ<span style="border-bottom: 1px solid black; padding: 0 10px;">${signDay}</span>æ—¥</div></div></div>`;
                });
                content.innerHTML = reportHtml;
            } 
            
            else {
                // Regular Checklist or Maintenance Report
                let html = '<table style="width:100%; border-collapse: collapse; font-size: 14px; text-align: left;">'; const thStyle = 'border: 1px solid #94a3b8; padding: 8px; background-color: #f1f5f9; font-weight: bold;'; const tdStyle = 'border: 1px solid #94a3b8; padding: 8px;';
                if (type === 'checklist') { title.textContent = "è¨­å‚™é»æª¢ç´€éŒ„è¡¨"; html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é»æª¢äºº</th><th style="${thStyle}">çµæœ</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`; let filtered = checkHistory.filter(h => { const d = h.checkTimestamp?.toDate(); return d >= start && d <= end; }); if (category !== 'ALL') { filtered = filtered.filter(h => { const eq = equipmentDatabase[h.deviceId]; const eqCat = eq ? (eq.category || 'æœªåˆ†é¡') : 'æœªåˆ†é¡'; return eqCat === category; }); } filtered.sort((a,b) => b.checkTimestamp.seconds - a.checkTimestamp.seconds); if(filtered.length === 0) html += `<tr><td colspan="5" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`; filtered.forEach(r => { const date = r.checkTimestamp?.toDate().toLocaleString(); const abItems = r.items.filter(i => i.status === 'ç•°å¸¸'); const resultHtml = abItems.length > 0 ? `<span style="color:red; font-weight:bold;">ç•°å¸¸ (${abItems.length})</span><br><span style="font-size:12px; color:#64748b;">${abItems.map(i=>i.text).join(', ')}</span>` : '<span style="color:green;">æ­£å¸¸</span>'; html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${resultHtml}</td><td style="${tdStyle}">${r.summaryNotes || ''}</td></tr>`; }); } 
                else if (type === 'maintenance') { title.textContent = "è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„è¡¨"; html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é¡å‹</th><th style="${thStyle}">é …ç›®</th><th style="${thStyle}">åŸ·è¡Œäºº</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`; let filtered = maintenanceHistory.filter(h => { const d = h.timestamp?.toDate(); return d >= start && d <= end; }); if (category !== 'ALL') { filtered = filtered.filter(h => { const eq = equipmentDatabase[h.deviceId]; const eqCat = eq ? (eq.category || 'æœªåˆ†é¡') : 'æœªåˆ†é¡'; return eqCat === category; }); } filtered.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds); if(filtered.length === 0) html += `<tr><td colspan="6" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`; filtered.forEach(r => { const date = r.timestamp?.toDate().toLocaleString(); const typeStr = r.type === 'cleaning' ? 'æ¸…æ½”' : 'æ›´æ›'; html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${typeStr}</td><td style="${tdStyle}">${r.componentName || '-'}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${r.notes || ''}</td></tr>`; }); }
                html += '</tbody></table>'; content.innerHTML = html;
            }
        };

        window.app.logout = function() { window.app.showUserSwitchModal(); };
        function updateUIState() { const loggedInName = document.getElementById('logged-in-name'); const roleBadge = document.getElementById('role-badge'); const avatarText = document.getElementById('user-avatar-text'); const toggleBtn = document.getElementById('toggle-mode-btn'); const guestWarning = document.querySelector('.guest-warning'); loggedInName.textContent = loggedInUser.name; avatarText.textContent = loggedInUser.name.charAt(0); document.body.classList.remove('role-guest', 'role-operator', 'role-manager'); document.body.classList.add(`role-${loggedInUser.role}`); let roleName = 'è¨ªå®¢'; let roleClass = 'bg-gray-200 text-gray-700'; if (loggedInUser.role === 'manager') { roleName = 'ç®¡ç†å“¡'; roleClass = 'bg-purple-100 text-purple-800'; } else if (loggedInUser.role === 'operator') { roleName = 'æ“ä½œå“¡'; roleClass = 'bg-blue-100 text-blue-800'; } roleBadge.textContent = roleName; roleBadge.className = `ml-2 px-1.5 py-0.5 rounded text-[10px] ${roleClass}`; if (loggedInUser.role === 'guest') { if(guestWarning) guestWarning.classList.remove('hidden'); if(toggleBtn) toggleBtn.classList.remove('hidden'); } else { if(guestWarning) guestWarning.classList.add('hidden'); if(toggleBtn) { if (loggedInUser.role === 'operator') { toggleBtn.classList.add('hidden'); } else { toggleBtn.classList.remove('hidden'); } } } document.getElementById('main-content').classList.remove('hidden'); populateManualDropdown(); populateReportCategoryDropdown(); window.app.renderDashboard(); }
        
        function populateManualDropdown() { const sel = document.getElementById('manual-category-select'); const devSel = document.getElementById('manual-device-select'); const btnStart = document.getElementById('manual-start-button'); const btnMaint = document.getElementById('manual-maintenance-button'); const btnReplace = document.getElementById('manual-replace-button'); if (!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) return; const dbFilter = document.getElementById('dashboard-category-filter'); const currentDbFilter = dbFilter.value; dbFilter.innerHTML = '<option value="ALL">å…¨éƒ¨åˆ†é¡</option>'; const ownerFilter = document.getElementById('dashboard-owner-filter'); const currentOwnerFilter = ownerFilter.value; ownerFilter.innerHTML = '<option value="ALL">å…¨éƒ¨è² è²¬äºº</option>'; const owners = new Set(); Object.values(equipmentDatabase).forEach(eq => { if(eq.primaryOwnerId) owners.add(eq.primaryOwnerId); }); owners.forEach(uid => { const u = userDatabase[uid]; if(u) ownerFilter.add(new Option(u.name, uid)); }); if(currentOwnerFilter && owners.has(currentOwnerFilter)) ownerFilter.value = currentOwnerFilter; const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))]; const currentVal = sel.value; sel.innerHTML = '<option value="">è«‹é¸æ“‡å¤§é¡...</option>'; cats.sort((a,b)=>a.localeCompare(b,'zh-TW')).forEach(c => { sel.add(new Option(c, c)); dbFilter.add(new Option(c, c)); }); if (currentVal && cats.includes(currentVal)) sel.value = currentVal; if (currentDbFilter && (cats.includes(currentDbFilter) || currentDbFilter === 'ALL')) dbFilter.value = currentDbFilter; sel.onchange = () => { devSel.innerHTML = '<option value="">è«‹é¸æ“‡è¨­å‚™...</option>'; devSel.disabled = false; Object.values(equipmentDatabase).filter(e => (e.category || 'æœªåˆ†é¡') === sel.value).forEach(e => devSel.add(new Option(e.name, e.id))); btnStart.disabled = true; btnMaint.disabled = true; btnReplace.disabled = true; }; devSel.onchange = () => { const hasValue = !!devSel.value; const isGuest = loggedInUser && loggedInUser.role === 'guest'; btnStart.disabled = !hasValue || isGuest; btnMaint.disabled = !hasValue || isGuest; btnReplace.disabled = !hasValue || isGuest; }; }
        window.app.handleManualSelection = () => { const id = document.getElementById('manual-device-select').value; startChecklist(id); };
        window.app.handleManualMaintenance = () => { const id = document.getElementById('manual-device-select').value; window.app.showMaintenanceModal(id); };
        function startChecklist(id) { 
            if (loggedInUser.role === 'guest') return showToast("è¨ªå®¢ç„¡æ³•åŸ·è¡Œé»æª¢", "error"); 
            const eq = equipmentDatabase[id]; if (!eq) return; currentCheckId = id; 
            document.getElementById('main-content').classList.add('hidden'); 
            document.getElementById('checklist-section').classList.remove('hidden'); 
            document.getElementById('device-name').textContent = eq.name; 
            document.getElementById('device-asset-no').textContent = eq.assetNumber || 'ç„¡'; 
            const ownerName = eq.primaryOwnerId ? (userDatabase[eq.primaryOwnerId]?.name || 'æœªçŸ¥') : 'æœªè¨­å®š'; 
            document.getElementById('device-primary-owner').textContent = ownerName; 
            document.getElementById('user-name-display').textContent = loggedInUser.name; 
            const today = window.app.formatDate(new Date()); 
            const dateInput = document.getElementById('check-date-input'); 
            dateInput.value = today; 
            window.app.updateWeekDisplay(today);
            
            // --- Auto-Expand Calendar if Overdue ---
            const missedDates = window.app.calculateOverdueDates(eq.nextCheckDate, eq.checkSchedule);
            const { start: thisWeekStart } = window.app.getThisWeekRange();
            const realOverdue = missedDates.filter(d => d < thisWeekStart);
            const calendarContainer = document.getElementById('calendar-view-container');

            if (realOverdue.length > 0) {
                // è‡ªå‹•å±•é–‹æœˆæ›†
                calendarContainer.classList.remove('hidden');
                
                // è¨­å®šæœˆæ›†æœˆä»½ç‚ºæœ€è¿‘ä¸€å€‹é€¾æœŸé …ç›®çš„æœˆä»½
                const latestOverdue = realOverdue[realOverdue.length - 1];
                const yyyy = latestOverdue.getFullYear();
                const mm = String(latestOverdue.getMonth() + 1).padStart(2, '0');
                document.getElementById('calendar-month-select').value = `${yyyy}-${mm}`;
                
                window.app.renderCalendarView();
                // å¯ä»¥é¸æ“‡é¡¯ç¤ºä¸€å€‹æº«å’Œçš„æç¤ºï¼Œæˆ–å®Œå…¨ä¸é¡¯ç¤º
                // showToast("å·²è‡ªå‹•å±•é–‹æœˆæ›†ä¾›è£œç™»", "info");
            } else {
                calendarContainer.classList.add('hidden');
            }

            const container = document.getElementById('checklist-items-container'); 
            container.innerHTML = ''; 
            if (eq.items) { eq.items.forEach(cat => { const group = document.createElement('div'); group.innerHTML = `<h3 class="font-bold text-lg mb-2 text-slate-600 border-b pb-1">${cat.category}</h3>`; cat.subItems.forEach(item => { group.innerHTML += `<div class="card p-4 mb-3 item-row" data-cat="${cat.category}" data-text="${item.text}"><div class="flex justify-between items-center"><span class="text-slate-800 font-medium">${item.text}</span><div class="space-x-1 flex-shrink-0"><button onclick="window.app.setStatus(this, 'normal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">æ­£å¸¸</button><button onclick="window.app.setStatus(this, 'abnormal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">ç•°å¸¸</button></div></div><input type="text" class="abnormal-input hidden w-full mt-2 p-2 border rounded text-sm bg-red-50 text-red-700 placeholder-red-300" placeholder="è«‹èªªæ˜ç•°å¸¸åŸå› ..."></div>`; }); container.appendChild(group); }); } 
        }
        window.app.setStatus = function(btn, status) { const row = btn.closest('.item-row'); row.querySelectorAll('.status-btn').forEach(b => { b.classList.remove('selected', 'selected-normal', 'selected-abnormal', 'bg-green-500', 'bg-red-500', 'text-white'); }); btn.classList.add('selected'); if(status === 'normal') btn.classList.add('selected-normal', 'bg-green-500', 'text-white'); else btn.classList.add('selected-abnormal', 'bg-red-500', 'text-white'); const input = row.querySelector('.abnormal-input'); if(status === 'abnormal') input.classList.remove('hidden'); else input.classList.add('hidden'); row.dataset.status = status; };
        window.app.submitChecklist = async function(btn) { if (loggedInUser.role === 'guest') return; btn.disabled = true; btn.innerText = "æäº¤ä¸­..."; try { const dateStr = document.getElementById('check-date-input').value; const selectedDate = new Date(dateStr); const now = new Date(); selectedDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds()); const rows = document.querySelectorAll('.item-row'); const items = []; rows.forEach(r => { items.push({ category: r.dataset.cat, text: r.dataset.text, status: r.dataset.status === 'abnormal' ? 'ç•°å¸¸' : 'æ­£å¸¸', details: r.querySelector('.abnormal-input').value }); }); const record = { deviceId: currentCheckId, deviceName: equipmentDatabase[currentCheckId].name, userId: loggedInUser.id, userName: loggedInUser.name, checkTimestamp: Timestamp.fromDate(selectedDate), createdTimestamp: serverTimestamp(), summaryNotes: document.getElementById('summary-notes').value, items: items }; await setDoc(doc(getCollectionRef("check_history")), record); const eq = equipmentDatabase[currentCheckId]; if (eq && eq.checkSchedule) { const nextDate = window.app.calculateNextScheduleDate(eq.checkSchedule, selectedDate); if (nextDate) { await updateDoc(getDocRef("equipment", currentCheckId), { nextCheckDate: window.app.formatDate(nextDate) }); } } else { const cycle = parseInt(eq.checkCycleDays) || 7; const nextDate = new Date(); nextDate.setDate(nextDate.getDate() + cycle); await updateDoc(getDocRef("equipment", currentCheckId), { nextCheckDate: window.app.formatDate(nextDate) }); } showToast('æäº¤æˆåŠŸ', 'success'); window.app.resetApp(); } catch (e) { console.error(e); showToast('æäº¤å¤±æ•—: ' + e.message, 'error'); } finally { btn.disabled = false; btn.innerText = "æäº¤"; } };
        window.app.resetApp = function() { document.getElementById('checklist-section').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); currentCheckId = null; };
        window.app.toggleManagementMode = function() { const userMode = document.getElementById('user-mode'); const adminMode = document.getElementById('admin-mode'); const btn = document.getElementById('toggle-mode-btn'); if (loggedInUser.role === 'operator') { return showToast("æ¬Šé™ä¸è¶³ï¼šåƒ…ç®¡ç†å“¡å¯é€²å…¥ç®¡ç†å¾Œå°", "error"); } if (userMode.classList.contains('hidden')) { userMode.classList.remove('hidden'); adminMode.classList.add('hidden'); btn.textContent = "âš™ï¸ ç®¡ç†å¾Œå°"; } else { userMode.classList.add('hidden'); adminMode.classList.remove('hidden'); btn.textContent = "â¬…ï¸ è¿”å›é»æª¢"; window.app.renderEquipmentList(); } };
        window.app.switchAdminTab = function(tab) { document.querySelectorAll('[id^=admin-tab-content]').forEach(d => d.classList.add('hidden')); document.getElementById(`admin-tab-content-${tab}`).classList.remove('hidden'); document.querySelectorAll('#admin-mode nav button').forEach(b => b.classList.remove('admin-tab-active', 'text-indigo-600')); document.getElementById(`tab-${tab}`).classList.add('admin-tab-active'); if(tab === 'users') window.app.renderUserList(); if(tab === 'equipment') window.app.renderEquipmentList(); if(tab === 'templates') window.app.renderTemplateList(); if(tab === 'checklistHistory') window.app.renderChecklistHistory(null, null, true); if(tab === 'maintenanceHistory') window.app.renderMaintenanceHistory(null, null, true); };

        window.app.updateCheckHistoryFilter = function(type, value) { checkPageState[type] = value; checkPageState.page = 1; window.app.renderChecklistHistory(null, null, false); };
        window.app.changeCheckPage = function(delta) { checkPageState.page += delta; window.app.renderChecklistHistory(null, null, false); };
        window.app.renderChecklistHistory = function(_filter, _userFilter, reset = false) {
            const container = document.getElementById('checklist-history-log-container');
            if(!container) return;
            if(reset) { checkPageState = { eq: 'ALL', user: 'ALL', page: 1 }; }
            let filtered = checkHistory.sort((a,b) => (b.checkTimestamp?.seconds || 0) - (a.checkTimestamp?.seconds || 0));
            if(checkPageState.eq !== 'ALL') filtered = filtered.filter(h => h.deviceId === checkPageState.eq);
            if(checkPageState.user !== 'ALL') filtered = filtered.filter(h => h.userId === checkPageState.user);
            const totalItems = filtered.length; const totalPages = Math.ceil(totalItems / PAGE_SIZE) || 1;
            if(checkPageState.page > totalPages) checkPageState.page = totalPages; if(checkPageState.page < 1) checkPageState.page = 1;
            const startIndex = (checkPageState.page - 1) * PAGE_SIZE; const pageData = filtered.slice(startIndex, startIndex + PAGE_SIZE);
            const eqOptions = Object.values(equipmentDatabase).map(e => `<option value="${e.id}" ${checkPageState.eq===e.id?'selected':''}>${e.name}</option>`).join('');
            const userSet = new Set(); checkHistory.forEach(h => userSet.add(h.userId)); Object.keys(userDatabase).forEach(uid => userSet.add(uid));
            const userOptions = Array.from(userSet).map(uid => { const name = userDatabase[uid]?.name || (checkHistory.find(h=>h.userId===uid)?.userName) || 'æœªçŸ¥'; return `<option value="${uid}" ${checkPageState.user===uid?'selected':''}>${name}</option>`; }).join('');
            let html = `
                <div class="mb-4 flex gap-4 flex-wrap">
                    <div><label class="text-sm font-bold text-gray-700 block mb-1">è¨­å‚™ç¯©é¸</label><select onchange="window.app.updateCheckHistoryFilter('eq', this.value)" class="border rounded p-1 w-40 text-sm"><option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>${eqOptions}</select></div>
                    <div><label class="text-sm font-bold text-gray-700 block mb-1">äººå“¡ç¯©é¸</label><select onchange="window.app.updateCheckHistoryFilter('user', this.value)" class="border rounded p-1 w-40 text-sm"><option value="ALL">å…¨éƒ¨äººå“¡</option>${userOptions}</select></div>
                </div>
                <div class="overflow-x-auto min-h-[400px]"><table class="min-w-full bg-white border border-gray-200"><thead class="bg-gray-50"><tr><th class="py-2 px-4 border-b">æ—¥æœŸ</th><th class="py-2 px-4 border-b">è¨­å‚™</th><th class="py-2 px-4 border-b">äººå“¡</th><th class="py-2 px-4 border-b">ç‹€æ…‹</th><th class="py-2 px-4 border-b">æ“ä½œ</th></tr></thead><tbody>
            `;
            if(pageData.length === 0) { html += `<tr><td colspan="5" class="text-center py-4 text-gray-500">ç„¡ç´€éŒ„</td></tr>`; } else {
                pageData.forEach(h => { const date = h.checkTimestamp?.toDate().toLocaleString() || 'N/A'; const isAbnormal = h.items.some(i => i.status === 'ç•°å¸¸'); const statusBadge = isAbnormal ? `<span class="bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded">ç•°å¸¸</span>` : `<span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded">æ­£å¸¸</span>`; html += `<tr class="hover:bg-gray-50"><td class="py-2 px-4 border-b text-sm">${date}</td><td class="py-2 px-4 border-b text-sm">${h.deviceName}</td><td class="py-2 px-4 border-b text-sm">${h.userName}</td><td class="py-2 px-4 border-b">${statusBadge}</td><td class="py-2 px-4 border-b text-sm"><button onclick="window.app.deleteCheckHistory('${h.id}')" class="text-red-500 hover:text-red-700">åˆªé™¤</button></td></tr>`; });
            }
            html += `</tbody></table></div><div class="flex justify-between items-center mt-4 border-t pt-2"><div class="text-sm text-gray-500">é¡¯ç¤º ${startIndex + 1} - ${Math.min(startIndex + PAGE_SIZE, totalItems)} ç­†ï¼Œå…± ${totalItems} ç­†</div><div class="flex items-center"><button onclick="window.app.changeCheckPage(-1)" class="pagination-btn" ${checkPageState.page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é </button><span class="pagination-info">ç¬¬ ${checkPageState.page} / ${totalPages} é </span><button onclick="window.app.changeCheckPage(1)" class="pagination-btn" ${checkPageState.page >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button></div></div>`; container.innerHTML = html;
        };

        window.app.updateMaintHistoryFilter = function(type, value) { maintPageState[type] = value; maintPageState.page = 1; window.app.renderMaintenanceHistory(null, null, false); };
        window.app.changeMaintPage = function(delta) { maintPageState.page += delta; window.app.renderMaintenanceHistory(null, null, false); };
        window.app.renderMaintenanceHistory = function(_filter, _userFilter, reset = false) {
             const container = document.getElementById('maintenance-history-log-container'); if(!container) return;
             if(reset) { maintPageState = { eq: 'ALL', user: 'ALL', page: 1 }; }
             let filtered = maintenanceHistory.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
             if(maintPageState.eq !== 'ALL') filtered = filtered.filter(h => h.deviceId === maintPageState.eq);
             if(maintPageState.user !== 'ALL') filtered = filtered.filter(h => h.userId === maintPageState.user);
             const totalItems = filtered.length; const totalPages = Math.ceil(totalItems / PAGE_SIZE) || 1;
             if(maintPageState.page > totalPages) maintPageState.page = totalPages; if(maintPageState.page < 1) maintPageState.page = 1;
             const startIndex = (maintPageState.page - 1) * PAGE_SIZE; const pageData = filtered.slice(startIndex, startIndex + PAGE_SIZE);
             const eqOptions = Object.values(equipmentDatabase).map(e => `<option value="${e.id}" ${maintPageState.eq===e.id?'selected':''}>${e.name}</option>`).join('');
             const userSet = new Set(); maintenanceHistory.forEach(h => userSet.add(h.userId)); Object.keys(userDatabase).forEach(uid => userSet.add(uid));
             const userOptions = Array.from(userSet).map(uid => { const name = userDatabase[uid]?.name || (maintenanceHistory.find(h=>h.userId===uid)?.userName) || 'æœªçŸ¥'; return `<option value="${uid}" ${maintPageState.user===uid?'selected':''}>${name}</option>`; }).join('');
             let html = `
                <div class="mb-4 flex gap-4 flex-wrap">
                    <div><label class="text-sm font-bold text-gray-700 block mb-1">è¨­å‚™ç¯©é¸</label><select onchange="window.app.updateMaintHistoryFilter('eq', this.value)" class="border rounded p-1 w-40 text-sm"><option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>${eqOptions}</select></div>
                    <div><label class="text-sm font-bold text-gray-700 block mb-1">äººå“¡ç¯©é¸</label><select onchange="window.app.updateMaintHistoryFilter('user', this.value)" class="border rounded p-1 w-40 text-sm"><option value="ALL">å…¨éƒ¨äººå“¡</option>${userOptions}</select></div>
                </div>
                <div class="overflow-x-auto min-h-[400px]"><table class="min-w-full bg-white border border-gray-200"><thead class="bg-gray-50"><tr><th class="py-2 px-4 border-b">æ—¥æœŸ</th><th class="py-2 px-4 border-b">è¨­å‚™</th><th class="py-2 px-4 border-b">é¡å‹</th><th class="py-2 px-4 border-b">å…§å®¹</th><th class="py-2 px-4 border-b">äººå“¡</th><th class="py-2 px-4 border-b">æ“ä½œ</th></tr></thead><tbody>
             `;
             if(pageData.length === 0) { html += `<tr><td colspan="6" class="text-center py-4 text-gray-500">ç„¡ç´€éŒ„</td></tr>`; } else {
                 pageData.forEach(h => { const date = h.timestamp?.toDate().toLocaleString() || 'N/A'; const typeStr = h.type === 'cleaning' ? 'æ¸…æ½”' : 'æ›´æ›é›¶ä»¶'; const content = h.type === 'replacement' ? h.componentName : h.notes; html += `<tr class="hover:bg-gray-50"><td class="py-2 px-4 border-b text-sm">${date}</td><td class="py-2 px-4 border-b text-sm">${h.deviceName}</td><td class="py-2 px-4 border-b text-sm">${typeStr}</td><td class="py-2 px-4 border-b text-sm truncate max-w-xs" title="${content}">${content}</td><td class="py-2 px-4 border-b text-sm">${h.userName}</td><td class="py-2 px-4 border-b text-sm"><button onclick="window.app.deleteMaintenanceHistory('${h.id}')" class="text-red-500 hover:text-red-700">åˆªé™¤</button></td></tr>`; });
             }
             html += `</tbody></table></div><div class="flex justify-between items-center mt-4 border-t pt-2"><div class="text-sm text-gray-500">é¡¯ç¤º ${startIndex + 1} - ${Math.min(startIndex + PAGE_SIZE, totalItems)} ç­†ï¼Œå…± ${totalItems} ç­†</div><div class="flex items-center"><button onclick="window.app.changeMaintPage(-1)" class="pagination-btn" ${maintPageState.page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é </button><span class="pagination-info">ç¬¬ ${maintPageState.page} / ${totalPages} é </span><button onclick="window.app.changeMaintPage(1)" class="pagination-btn" ${maintPageState.page >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é </button></div></div>`; container.innerHTML = html;
        };

        window.app.deleteCheckHistory = async function(id) { window.app.confirmAction('ç¢ºå®šè¦åˆªé™¤é€™ç­†é»æª¢ç´€éŒ„å—ï¼Ÿ', async () => { try { await deleteDoc(getDocRef("check_history", id)); showToast('åˆªé™¤æˆåŠŸ', 'success'); } catch(e) { console.error(e); showToast('åˆªé™¤å¤±æ•—', 'error'); } }); };
        window.app.deleteMaintenanceHistory = async function(id) { window.app.confirmAction('ç¢ºå®šè¦åˆªé™¤é€™ç­†ä¿é¤Šç´€éŒ„å—ï¼Ÿ', async () => { try { await deleteDoc(getDocRef("maintenance_history", id)); showToast('åˆªé™¤æˆåŠŸ', 'success'); } catch(e) { console.error(e); showToast('åˆªé™¤å¤±æ•—', 'error'); } }); };

        window.app.renderEquipmentList = function() {
            const tabsContainer = document.getElementById('equipment-category-tabs');
            const listContainer = document.getElementById('equipment-list-container');
            if(!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) { listContainer.innerHTML = '<p class="text-center text-gray-400 py-4">ç„¡è³‡æ–™</p>'; tabsContainer.innerHTML = ''; return; }
            const groups = {}; Object.values(equipmentDatabase).forEach(eq => { const cat = eq.category || 'æœªåˆ†é¡'; if (!groups[cat]) groups[cat] = []; groups[cat].push(eq); });
            const categories = Object.keys(groups).sort((a, b) => a.localeCompare(b, 'zh-TW'));
            let selectHtml = `<div class="flex items-center bg-white p-3 rounded-lg border border-gray-200 shadow-sm"><label class="mr-3 font-bold text-slate-700 flex items-center whitespace-nowrap"><svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>åˆ†é¡åˆ‡æ›:</label><select id="eq-category-select" onchange="window.app.filterEquipmentCategory(this.value)" class="form-select w-full p-2 border border-gray-300 rounded text-slate-700 font-medium focus:ring-2 focus:ring-indigo-500 bg-slate-50"><option value="ALL">ğŸ“‹ å…¨éƒ¨é¡¯ç¤º (${Object.keys(equipmentDatabase).length} å°)</option>`;
            categories.forEach(cat => { selectHtml += `<option value="${cat}">${cat} (${groups[cat].length})</option>`; }); selectHtml += `</select></div>`; tabsContainer.innerHTML = selectHtml; 
            let listHtml = ''; categories.forEach((cat) => { listHtml += `<div id="cat-content-${cat}" class="eq-category-group space-y-3 mb-6"><h3 class="font-bold text-slate-500 text-sm border-b pb-1 mb-2 mt-4">${cat}</h3>`; groups[cat].forEach(eq => { const imgUrl = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; let statusClass = 'active'; if(eq.status==='ç¶­ä¿®ä¸­') statusClass='repair'; else if(eq.status==='æœªä½¿ç”¨') statusClass='unused'; const ownerName = eq.primaryOwnerId ? (userDatabase[eq.primaryOwnerId]?.name || 'æœªçŸ¥') : 'æœªè¨­å®š'; listHtml += `<div class="card p-4 flex flex-col sm:flex-row items-center gap-4 hover:shadow-md transition-shadow"><img src="${imgUrl}" class="w-24 h-24 object-cover rounded-md border flex-shrink-0 cursor-pointer" onclick="window.open('${imgUrl}')"><div class="flex-grow text-center sm:text-left w-full"><h3 class="font-bold text-lg text-slate-800 flex items-center justify-center sm:justify-start"><span class="status-dot ${statusClass}"></span>${eq.name}</h3><div class="text-sm text-slate-500 mt-1 space-y-1"><p>ğŸ†” ID: <span class="font-mono text-slate-700">${eq.id}</span></p><p>ğŸ“ åœ°é»: ${eq.location || 'æœªè¨­å®š'}</p><p>ğŸ‘¤ è² è²¬äºº: <span class="text-slate-700 font-medium">${ownerName}</span></p></div><div class="flex items-center gap-2 mt-2 text-xs text-gray-400 justify-center sm:justify-start flex-wrap"><span class="bg-slate-100 px-2 py-1 rounded">ä¸‹æ¬¡é»æª¢: ${eq.nextCheckDate || 'æœªè¨­å®š'}</span><span class="bg-slate-100 px-2 py-1 rounded">ä¸‹æ¬¡æ¸…æ½”: ${eq.nextCleaningDate || 'æœªè¨­å®š'}</span></div></div><div class="flex flex-col gap-2 w-full sm:w-auto mt-4 sm:mt-0 min-w-[200px]"><button onclick="window.app.showQRCode('${eq.id}', '${eq.name}')" class="w-full bg-white border border-green-500 text-green-600 font-bold px-3 py-3 rounded hover:bg-green-50 transition-colors flex items-center justify-center text-base"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>é¡¯ç¤º QR Code</button><div class="flex gap-2 justify-between"><button onclick="window.app.showMaintenanceModal('${eq.id}')" class="flex-1 bg-orange-100 text-orange-600 border border-orange-200 text-sm font-bold px-2 py-2 rounded hover:bg-orange-200 transition-colors action-edit">ä¿é¤Š</button><button onclick="window.app.showEditor('${eq.id}')" class="flex-1 bg-blue-100 text-blue-600 border border-blue-200 text-sm font-bold px-2 py-2 rounded hover:bg-blue-200 transition-colors action-edit">ç·¨è¼¯</button><button onclick="window.app.deleteEquipment('${eq.id}')" class="flex-1 bg-red-100 text-red-600 border border-red-200 text-sm font-bold px-2 py-2 rounded hover:bg-red-200 transition-colors action-delete">åˆªé™¤</button></div></div></div>`; }); listHtml += '</div>'; }); listContainer.innerHTML = listHtml;
        };
        window.app.filterEquipmentCategory = function(selectedCat) { const allGroups = document.querySelectorAll('.eq-category-group'); allGroups.forEach(group => { if (selectedCat === 'ALL') { group.classList.remove('hidden'); } else { if (group.id === `cat-content-${selectedCat}`) { group.classList.remove('hidden'); } else { group.classList.add('hidden'); } } }); };
        window.app.deleteEquipment = function(id) { window.app.confirmAction('ç¢ºå®šåˆªé™¤æ­¤è¨­å‚™ï¼Ÿç›¸é—œç´€éŒ„å¯èƒ½ç„¡æ³•æ­£ç¢ºé¡¯ç¤ºã€‚', async () => { try { await deleteDoc(getDocRef("equipment", id)); showToast("è¨­å‚™å·²åˆªé™¤", "success"); } catch(e) { console.error(e); showToast("åˆªé™¤å¤±æ•—: " + e.message, "error"); } }); };
        
        window.app.showQRCode = function(id, name) { currentQrId = id; const container = document.getElementById('qr-code-container'); container.innerHTML = ''; document.getElementById('qr-display-name').textContent = name; document.getElementById('qr-code-display-modal').classList.remove('hidden'); document.getElementById('qr-display-content').classList.remove('hidden'); const baseUrl = "https://saniltw.github.io/welddata/5.html"; const qrData = `${baseUrl}?id=${id}`; const hiddenDiv = document.createElement('div'); new QRCode(hiddenDiv, { text: qrData, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H }); const checkQrImage = setInterval(() => { const qrImg = hiddenDiv.querySelector('img'); if (qrImg && qrImg.src) { clearInterval(checkQrImage); const imgObj = new Image(); imgObj.onload = () => window.app.drawCompositeQRCode(imgObj, name, container); imgObj.src = qrImg.src; } else { const qrCanvas = hiddenDiv.querySelector('canvas'); if(qrCanvas) { clearInterval(checkQrImage); window.app.drawCompositeQRCode(qrCanvas, name, container); } } }, 50); };
        window.app.drawCompositeQRCode = function(sourceImage, text, container) { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const padding = 20; const qrSize = 200; const textBoxHeight = 50; const width = qrSize + (padding * 2); const height = qrSize + (padding * 2) + textBoxHeight; canvas.width = width; canvas.height = height; ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, width, height); ctx.drawImage(sourceImage, padding, padding, qrSize, qrSize); ctx.fillStyle = '#000000'; ctx.font = 'bold 18px "Noto Sans TC", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; let fontSize = 18; do { ctx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`; fontSize -= 1; } while (ctx.measureText(text).width > width - 20 && fontSize > 10); ctx.fillText(text, width / 2, height - (textBoxHeight / 2) - 5); ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.strokeRect(0, 0, width, height); canvas.style.maxWidth = '100%'; canvas.style.height = 'auto'; container.appendChild(canvas); };
        window.app.downloadQRCode = function() { const container = document.getElementById('qr-code-container'); const canvas = container.querySelector('canvas'); if(canvas) { const link = document.createElement('a'); const deviceName = document.getElementById('qr-display-name').textContent || 'device'; link.download = `QR-${deviceName}.png`; link.href = canvas.toDataURL("image/png"); document.body.appendChild(link); link.click(); document.body.removeChild(link); } else { showToast("QR Code å°šæœªç”¢ç”Ÿ", "error"); } };
        
        window.app.showMaintenanceModal = function(id) { 
            if (loggedInUser.role === 'guest') return showToast("è¨ªå®¢æ¬Šé™ä¸è¶³", "error"); 
            currentMaintEqId = id; 
            const eq = equipmentDatabase[id];
            document.getElementById('maint-device-name').textContent = eq.name; 
            const compSelect = document.getElementById('maintenance-component-name'); compSelect.innerHTML = ''; 
            document.getElementById('maintenance-notes').value = ''; 
            document.getElementById('maint-image-preview').src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; 
            document.getElementById('maint-image-preview').removeAttribute('data-image-data-url'); 
            document.getElementById('maint-image-upload').value = ''; 
            const comps = eq.components || []; 
            if(comps.length > 0) comps.forEach(c => compSelect.add(new Option(c.name, c.name))); 
            else compSelect.add(new Option('ç„¡é›¶ä»¶è³‡æ–™', '')); 
            window.app.toggleMaintType(); 
            
            // Set Today
            const today = window.app.formatDate(new Date());
            document.getElementById('maint-date-input').value = today;

            // --- ç§»é™¤äº†ç´…è‰²é€¾æœŸæ–‡å­—æé†’ (Option A) ---
            // ä¿é¤Šå½ˆçª—é€™è£¡æš«æ™‚ä¸å¯¦ä½œè‡ªå‹•å±•é–‹æœˆæ›†ï¼Œå› ç‚ºæ²’æœ‰æœˆæ›†å…ƒä»¶

            document.getElementById('maintenance-modal').classList.remove('hidden'); 
        };

        window.app.toggleMaintType = function() { const type = document.getElementById('maintenance-type').value; const selector = document.getElementById('maintenance-component-selector'); if(type === 'replacement') selector.classList.remove('hidden'); else selector.classList.add('hidden'); };
        window.app.closeMaintenanceModal = function() { document.getElementById('maintenance-modal').classList.add('hidden'); };
        
        // ä¿®æ”¹ 1: åŠ å¼·ä¿é¤Šåœ–ç‰‡å£“ç¸®
        window.app.handleMaintImageUpload = function(input) { 
            if(!input.files[0]) return; 
            const file = input.files[0]; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                const img = new Image(); 
                img.onload = function() { 
                    const canvas = document.createElement('canvas'); 
                    // å°‡æœ€å¤§å¯¬åº¦å¾ 800 æ”¹ç‚º 500ï¼Œå¤§å¹…æ¸›å°‘åƒç´ é‡
                    const MAX_WIDTH = 500; 
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    
                    canvas.width = width; 
                    canvas.height = height; 
                    const ctx = canvas.getContext('2d'); 
                    ctx.drawImage(img, 0, 0, width, height); 
                    
                    // å°‡å“è³ªå¾ 0.7 æ”¹ç‚º 0.5
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.5); 
                    const preview = document.getElementById('maint-image-preview'); 
                    preview.src = dataUrl; 
                    preview.dataset.imageDataUrl = dataUrl; 
                    
                    // å¯ä»¥åœ¨ Console é¡¯ç¤ºå£“ç¸®å¾Œçš„å¤§å°ï¼Œæ–¹ä¾¿é™¤éŒ¯
                    console.log(`ä¿é¤Šåœ–ç‰‡å£“ç¸®å¾Œå¤§å°: ~${Math.round(dataUrl.length / 1024)} KB`);
                }; 
                img.src = e.target.result; 
            }; 
            reader.readAsDataURL(file); 
        };
        
        window.app.logMaintenance = async function(btn) {
            if (loggedInUser.role === 'guest') return;
            btn.disabled = true;
            btn.innerText = "å„²å­˜ä¸­...";
            try {
                const dateStr = document.getElementById('maint-date-input').value;
                const selectedDate = new Date(dateStr);
                const now = new Date();
                selectedDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

                const type = document.getElementById('maintenance-type').value;
                const record = {
                    deviceId: currentMaintEqId,
                    deviceName: equipmentDatabase[currentMaintEqId].name,
                    userId: loggedInUser.id,
                    userName: loggedInUser.name,
                    type: type,
                    componentName: type === 'replacement' ? document.getElementById('maintenance-component-name').value : null,
                    notes: document.getElementById('maintenance-notes').value,
                    imageUrl: document.getElementById('maint-image-preview').dataset.imageDataUrl || null,
                    timestamp: Timestamp.fromDate(selectedDate), 
                    createdTimestamp: serverTimestamp()
                };
                
                await addDoc(getCollectionRef("maintenance_history"), record);
                
                if (type === 'cleaning') {
                    const eq = equipmentDatabase[currentMaintEqId];
                    if (eq) {
                        let nextDate;
                        if (eq.cleaningSchedule) {
                            nextDate = window.app.calculateNextScheduleDate(eq.cleaningSchedule, selectedDate);
                        } else {
                            const cycle = parseInt(eq.cleaningCycleDays) || 30;
                            nextDate = new Date(selectedDate);
                            nextDate.setDate(nextDate.getDate() + cycle);
                            nextDate = window.app.adjustForWeekend(nextDate); // ç¢ºä¿æ¸…æ½”æ—¥ä¹Ÿè·³éé€±æœ«
                        }
                        if (nextDate) {
                            await updateDoc(getDocRef("equipment", currentMaintEqId), { nextCleaningDate: window.app.formatDate(nextDate) });
                        }
                    }
                }
                
                showToast('ä¿é¤Šç´€éŒ„å·²å„²å­˜', 'success');
                window.app.closeMaintenanceModal();
            } catch (e) {
                console.error(e);
                showToast('å„²å­˜å¤±æ•—: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = "å„²å­˜ç´€éŒ„";
            }
        };

        window.app.toggleEditorSections = function() { const status = document.getElementById('edit-device-status').value; const isActive = status === 'ä½¿ç”¨ä¸­'; const sections = ['editor-section-check-schedule', 'editor-section-clean-schedule', 'editor-section-print-option', 'editor-section-auth-users', 'editor-section-checklist-items', 'editor-section-components']; sections.forEach(id => { const el = document.getElementById(id); if (el) { if (isActive) el.classList.remove('hidden'); else el.classList.add('hidden'); } }); };
        window.app.renderBackupList = function() { const container = document.getElementById('backup-user-list-container'); if(!container) return; container.innerHTML = ''; const list = window.app.currentBackupList || []; if(list.length === 0) { container.innerHTML = '<p class="text-xs text-gray-400 italic">ç„¡å‚™æ´äººå“¡</p>'; return; } list.forEach((uid, index) => { const user = userDatabase[uid]; const name = user ? user.name : 'æœªçŸ¥ç”¨æˆ¶'; const div = document.createElement('div'); div.className = 'backup-user-item'; div.innerHTML = `<span class="text-sm font-medium text-gray-700">${index + 1}. ${name}</span><div class="backup-user-actions"><button type="button" onclick="window.app.moveBackupUser(${index}, -1)" class="backup-action-btn" title="ä¸Šç§»">â¬†ï¸</button><button type="button" onclick="window.app.moveBackupUser(${index}, 1)" class="backup-action-btn" title="ä¸‹ç§»">â¬‡ï¸</button><button type="button" onclick="window.app.removeBackupUser(${index})" class="backup-action-btn text-red-500 hover:text-red-700" title="ç§»é™¤">âœ•</button></div>`; container.appendChild(div); }); };
        window.app.addBackupUser = function() { const select = document.getElementById('edit-backup-adder-select'); const uid = select.value; if(!uid) return; if(!window.app.currentBackupList) window.app.currentBackupList = []; if(window.app.currentBackupList.includes(uid)) { showToast("æ­¤äººå“¡å·²åœ¨æ¸…å–®ä¸­", "error"); return; } const primary = document.getElementById('edit-primary-owner').value; if(primary === uid) { showToast("æ­¤äººå“¡å·²æ˜¯ä¸»è¦è² è²¬äºº", "error"); return; } window.app.currentBackupList.push(uid); window.app.renderBackupList(); select.value = ""; };
        window.app.removeBackupUser = function(index) { if(!window.app.currentBackupList) return; window.app.currentBackupList.splice(index, 1); window.app.renderBackupList(); };
        window.app.moveBackupUser = function(index, direction) { if(!window.app.currentBackupList) return; const newIndex = index + direction; if(newIndex < 0 || newIndex >= window.app.currentBackupList.length) return; const temp = window.app.currentBackupList[index]; window.app.currentBackupList[index] = window.app.currentBackupList[newIndex]; window.app.currentBackupList[newIndex] = temp; window.app.renderBackupList(); };
        window.app.showEditor = function(id = null) { 
            document.getElementById('equipment-list-section').classList.add('hidden'); 
            document.getElementById('equipment-editor-section').classList.remove('hidden'); 
            document.getElementById('item-editor-container').innerHTML = ''; 
            document.getElementById('component-editor-container').innerHTML = ''; 
            const sel = document.getElementById('edit-device-category-select'); 
            const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))]; 
            sel.innerHTML = '<option value="__new__">ï¼‹ æ–°å¢åˆ†é¡</option>'; 
            cats.forEach(c => sel.add(new Option(c, c))); 
            const primarySel = document.getElementById('edit-primary-owner'); 
            const backupAdder = document.getElementById('edit-backup-adder-select'); 
            primarySel.innerHTML = '<option value="">è«‹é¸æ“‡è² è²¬äºº...</option>'; 
            backupAdder.innerHTML = '<option value="">é¸æ“‡äººå“¡åŠ å…¥...</option>'; 
            Object.values(userDatabase).forEach(u => { primarySel.add(new Option(u.name, u.id)); backupAdder.add(new Option(u.name, u.id)); }); 
            const imgPreview = document.getElementById('image-preview'); 
            document.getElementById('edit-device-image').value = ''; 
            window.app.currentBackupList = []; 
            
            // è™•ç†è¨­å‚™ç·¨è¼¯æ™‚çš„åœ–ç‰‡ä¸Šå‚³é‚è¼¯ (ä¿®æ”¹ 2: åŠ å¼·è¨­å‚™åœ–ç‰‡å£“ç¸®)
            document.getElementById('edit-device-image').onchange = function(e) {
                if(!this.files[0]) return;
                const file = this.files[0];
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        // å°‡æœ€å¤§å¯¬åº¦å¾ 800 æ”¹ç‚º 500
                        const MAX_WIDTH = 500;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // å°‡å“è³ªå¾ 0.7 æ”¹ç‚º 0.5
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.5);
                        imgPreview.src = dataUrl;
                        imgPreview.dataset.imageDataUrl = dataUrl;
                        console.log(`è¨­å‚™åœ–ç‰‡å£“ç¸®å¾Œå¤§å°: ~${Math.round(dataUrl.length / 1024)} KB`);
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            };

            if(id) { 
                const eq = equipmentDatabase[id]; 
                document.getElementById('edit-device-id').value = eq.id; 
                document.getElementById('edit-device-name').value = eq.name; 
                document.getElementById('edit-device-location').value = eq.location || ''; 
                document.getElementById('edit-device-asset').value = eq.assetNumber || ''; 
                document.getElementById('edit-device-status').value = eq.status || 'ä½¿ç”¨ä¸­'; 
                const checkSchedule = eq.checkSchedule || { mode: 'interval', interval: eq.checkCycleDays || 7, weekdays: [] }; 
                document.querySelector(`input[name="checkMode"][value="${checkSchedule.mode}"]`).checked = true; 
                document.getElementById('edit-check-interval').value = checkSchedule.interval || 7; 
                document.querySelectorAll('input[name="checkWeekday"]').forEach(cb => { cb.checked = checkSchedule.weekdays ? checkSchedule.weekdays.includes(parseInt(cb.value)) : false; }); 
                window.app.toggleScheduleMode('check'); 
                const cleaningSchedule = eq.cleaningSchedule || { mode: 'interval', interval: eq.cleaningCycleDays || 30, weekdays: [] }; 
                const savedCleanMode = cleaningSchedule.mode; 
                if(savedCleanMode && document.querySelector(`input[name="cleanMode"][value="${savedCleanMode}"]`)) { document.querySelector(`input[name="cleanMode"][value="${savedCleanMode}"]`).checked = true; } else { document.querySelector(`input[name="cleanMode"][value="interval"]`).checked = true; } 
                document.getElementById('edit-clean-interval').value = cleaningSchedule.interval || 30; 
                document.querySelectorAll('input[name="cleanWeekday"]').forEach(cb => { cb.checked = cleaningSchedule.weekdays ? cleaningSchedule.weekdays.includes(parseInt(cb.value)) : false; }); 
                window.app.toggleScheduleMode('clean'); 
                document.getElementById('edit-device-include-kt').checked = eq.includeInKtReport || false; 
                if(eq.category) sel.value = eq.category; 
                if(eq.items) eq.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container')); 
                if(eq.components) eq.components.forEach(c => window.app.addComponentEditor(c)); 
                if(eq.primaryOwnerId) primarySel.value = eq.primaryOwnerId; 
                if(eq.backupOwnerIds && Array.isArray(eq.backupOwnerIds)) { window.app.currentBackupList = [...eq.backupOwnerIds]; } 
                imgPreview.src = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; 
                imgPreview.dataset.imageDataUrl = eq.imageUrl || ''; 
            } else { 
                ['edit-device-id', 'edit-device-name', 'edit-device-location', 'edit-device-asset'].forEach(k=> { const el = document.getElementById(k); if(el) el.value=''; }); 
                document.querySelector('input[name="checkMode"][value="interval"]').checked = true; 
                document.querySelector('input[name="cleanMode"][value="interval"]').checked = true; 
                document.querySelectorAll('input[name="checkWeekday"]').forEach(cb => cb.checked = false); 
                document.querySelectorAll('input[name="cleanWeekday"]').forEach(cb => cb.checked = false); 
                document.getElementById('edit-check-interval').value = 7; 
                document.getElementById('edit-clean-interval').value = 30; 
                window.app.toggleScheduleMode('check'); 
                window.app.toggleScheduleMode('clean'); 
                document.getElementById('edit-device-include-kt').checked = false; 
                imgPreview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; 
                imgPreview.dataset.imageDataUrl = ''; 
            } 
            window.app.renderBackupList(); 
            window.app.toggleEditorSections(); 
        };
        window.app.showList = function() { document.getElementById('equipment-list-section').classList.remove('hidden'); document.getElementById('equipment-editor-section').classList.add('hidden'); window.app.renderEquipmentList(); };
        window.app.saveEquipment = async function(btn) { const originalText = 'å„²å­˜è®Šæ›´'; if (btn) { btn.disabled = true; btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>å„²å­˜ä¸­...`; } try { const id = document.getElementById('edit-device-id').value; const name = document.getElementById('edit-device-name').value; const catSelect = document.getElementById('edit-device-category-select'); const cat = catSelect.value === '__new__' ? (document.getElementById('edit-device-category-new').value || 'æœªåˆ†é¡') : catSelect.value; const items = []; document.querySelectorAll('#item-editor-container .editor-item').forEach(el => { const cName = el.querySelector('.cat-name').value; const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text); if(cName) items.push({ category: cName, subItems: subs }); }); const components = []; document.querySelectorAll('#component-editor-container .component-item').forEach(el => { const cName = el.querySelector('.comp-name').value; const cCycle = el.querySelector('.comp-cycle').value; if(cName) components.push({ name: cName, cycle: cCycle }); }); const primaryOwnerId = document.getElementById('edit-primary-owner').value; const backupOwnerIds = window.app.currentBackupList || []; const authorizedUsers = []; if(primaryOwnerId) authorizedUsers.push(primaryOwnerId); authorizedUsers.push(...backupOwnerIds); const imgPreview = document.getElementById('image-preview'); const includeInKtReport = document.getElementById('edit-device-include-kt').checked; const checkSchedule = { mode: document.querySelector('input[name="checkMode"]:checked').value, interval: parseInt(document.getElementById('edit-check-interval').value) || 7, weekdays: Array.from(document.querySelectorAll('input[name="checkWeekday"]:checked')).map(cb => parseInt(cb.value)) }; const cleaningSchedule = { mode: document.querySelector('input[name="cleanMode"]:checked').value, interval: parseInt(document.getElementById('edit-clean-interval').value) || 30, weekdays: Array.from(document.querySelectorAll('input[name="cleanWeekday"]:checked')).map(cb => parseInt(cb.value)) }; const nextCheckDate = window.app.calculateNextScheduleDate(checkSchedule, new Date()) || new Date(); const nextCleaningDate = window.app.calculateNextScheduleDate(cleaningSchedule, new Date()) || new Date(); const data = { name, category: cat, items, components, primaryOwnerId, backupOwnerIds, authorizedUsers, includeInKtReport, imageUrl: imgPreview.dataset.imageDataUrl || null, location: document.getElementById('edit-device-location').value, assetNumber: document.getElementById('edit-device-asset').value, status: document.getElementById('edit-device-status').value, checkCycleDays: checkSchedule.interval, checkSchedule, cleaningSchedule, nextCheckDate: window.app.formatDate(nextCheckDate), nextCleaningDate: window.app.formatDate(nextCleaningDate) }; await setDoc(getDocRef("equipment", id), data, { merge: true }); showToast('å„²å­˜æˆåŠŸ', 'success'); window.app.showList(); } catch (error) { console.error("Save failed:", error); showToast("å„²å­˜å¤±æ•—: " + error.message, "error"); } finally { if (btn) { btn.disabled = false; btn.innerHTML = originalText; } } };
        window.app.addCategoryEditor = function(data = null, containerId = 'item-editor-container') { const container = document.getElementById(containerId); const div = document.createElement('div'); div.className = 'editor-item border p-3 rounded bg-slate-50 mb-2'; div.innerHTML = `<div class="flex justify-between mb-2"><input type="text" class="cat-name p-1 border rounded w-1/2 font-bold" value="${data?.category || ''}" placeholder="åˆ†é¡åç¨± (å¦‚: å¤–è§€)"><button onclick="this.closest('.editor-item').remove()" class="text-red-500 text-xs">åˆªé™¤</button></div><textarea class="sub-items w-full p-2 border rounded text-sm h-20" placeholder="é …ç›® (ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚: ç•°éŸ³, æ¼æ²¹)">${data?.subItems?.map(s => s.text).join(',') || ''}</textarea>`; container.appendChild(div); };
        window.app.addComponentEditor = function(data = null) { const container = document.getElementById('component-editor-container'); const div = document.createElement('div'); div.className = 'component-item border p-2 rounded bg-white mb-2 flex space-x-2 items-center'; div.innerHTML = `<input type="text" class="comp-name w-1/2 p-1 border rounded text-sm" value="${data?.name || ''}" placeholder="é›¶ä»¶åç¨±"><input type="number" class="comp-cycle w-1/4 p-1 border rounded text-sm" value="${data?.cycle || ''}" placeholder="é€±æœŸ(å¤©)"><button onclick="this.closest('.component-item').remove()" class="text-red-500 text-xs px-2">âœ•</button>`; container.appendChild(div); };
        window.app.showScanner = function() { const modal = document.getElementById('qr-scanner-modal'); const content = document.getElementById('qr-scanner-content'); modal.classList.remove('hidden'); modal.classList.add('flex'); content.classList.remove('hidden'); html5QrCode = new Html5Qrcode("qr-reader"); const config = { fps: 10, qrbox: { width: 250, height: 250 } }; html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => { if (decodedText.includes("?id=")) { const id = decodedText.split("?id=")[1]; window.app.hideScanner(); window.app.handleScanResult(id); } else { if (equipmentDatabase[decodedText]) { window.app.hideScanner(); window.app.handleScanResult(decodedText); } } }, (errorMessage) => { }).catch(err => { console.error(err); alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™æˆ–ä½¿ç”¨ HTTPS é€£ç·šã€‚"); window.app.hideScanner(); }); };
        // åˆªé™¤äº†èˆŠçš„ window.app.handleImageUpload å®šç¾©ï¼Œå› ç‚ºå®ƒå·²ç¶“æ•´åˆåˆ° showEditor ä¸­äº†
        
        window.app.renderTemplateList = function() { const container = document.getElementById('template-list-container'); container.innerHTML = ''; if(Object.keys(templateDatabase).length === 0) { container.innerHTML = '<p class="text-center text-gray-400">å°šç„¡ç¯„æœ¬</p>'; return; } Object.values(templateDatabase).forEach(t => { container.innerHTML += `<div class="card p-4 flex justify-between items-center"><span class="font-bold">${t.name}</span><div class="flex gap-2"><button onclick="window.app.showTemplateEditor('${t.id}')" class="text-blue-600 text-sm border px-2 py-1 rounded">ç·¨è¼¯</button><button onclick="window.app.deleteTemplate('${t.id}')" class="text-red-600 text-sm border px-2 py-1 rounded">åˆªé™¤</button></div></div>`; }); };
        window.app.showTemplateEditor = function(id = null) { document.getElementById('template-list-section').classList.add('hidden'); document.getElementById('template-editor-section').classList.remove('hidden'); document.getElementById('template-item-editor-container').innerHTML = ''; if(id) { const t = templateDatabase[id]; document.getElementById('edit-template-id').value = t.id; document.getElementById('edit-template-name').value = t.name; if(t.items) t.items.forEach(i => window.app.addCategoryEditor(i, 'template-item-editor-container')); } else { document.getElementById('edit-template-id').value = ''; document.getElementById('edit-template-name').value = ''; } };
        window.app.showTemplateList = function() { document.getElementById('template-list-section').classList.remove('hidden'); document.getElementById('template-editor-section').classList.add('hidden'); };
        window.app.saveTemplate = async function() { const id = document.getElementById('edit-template-id').value || doc(getCollectionRef("checklist_templates")).id; const name = document.getElementById('edit-template-name').value; if(!name) return showToast("è«‹è¼¸å…¥ç¯„æœ¬åç¨±", "error"); const items = []; document.querySelectorAll('#template-item-editor-container .editor-item').forEach(el => { const cName = el.querySelector('.cat-name').value; const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text); if(cName) items.push({ category: cName, subItems: subs }); }); await setDoc(getDocRef("checklist_templates", id), { name, items }); showToast("ç¯„æœ¬å·²å„²å­˜", "success"); window.app.showTemplateList(); };
        window.app.deleteTemplate = function(id) { window.app.confirmAction('ç¢ºå®šåˆªé™¤æ­¤ç¯„æœ¬ï¼Ÿ', async () => { await deleteDoc(getDocRef("checklist_templates", id)); showToast("ç¯„æœ¬å·²åˆªé™¤", "success"); }); };
        window.app.showTemplateModal = function() { const container = document.getElementById('template-selection-container'); container.innerHTML = ''; if(Object.keys(templateDatabase).length === 0) { container.innerHTML = '<p class="text-center text-gray-400">ç„¡å¯ç”¨ç¯„æœ¬</p>'; } else { Object.values(templateDatabase).forEach(t => { container.innerHTML += `<button onclick="window.app.applyTemplate('${t.id}')" class="w-full text-left p-3 border rounded hover:bg-indigo-50 mb-2">${t.name}</button>`; }); } document.getElementById('template-modal').classList.remove('hidden'); document.getElementById('template-modal').classList.add('flex'); };
        window.app.closeTemplateModal = function() { document.getElementById('template-modal').classList.add('hidden'); document.getElementById('template-modal').classList.remove('flex'); };
        window.app.applyTemplate = function(id) { const t = templateDatabase[id]; if(t && t.items) { document.getElementById('item-editor-container').innerHTML = ''; t.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container')); showToast(`å·²å¥—ç”¨ç¯„æœ¬ï¼š${t.name}`, "success"); } window.app.closeTemplateModal(); };
        window.app.renderUserList = function() { const c = document.getElementById('user-list-container'); c.innerHTML = ''; Object.values(userDatabase).forEach(u => { c.innerHTML += `<div class="card p-3 flex justify-between items-center mb-2"><div><span class="font-bold">${u.name}</span> <span class="text-xs text-gray-500">(${u.role})</span></div><div class="space-x-2"><button onclick="window.app.showUserEditor('${u.id}')" class="text-blue-600 text-sm">ç·¨è¼¯</button><button onclick="window.app.deleteUser('${u.id}')" class="text-red-600 text-sm">åˆªé™¤</button></div></div>`; }); };
        window.app.showUserEditor = (id = null) => { document.getElementById('user-list-container').classList.add('hidden'); document.getElementById('user-editor-section').classList.remove('hidden'); const roleSelect = document.getElementById('edit-user-role'); roleSelect.onchange = (e) => { document.getElementById('edit-user-password').classList.toggle('hidden', e.target.value !== 'manager'); }; if (id && userDatabase[id]) { const user = userDatabase[id]; document.getElementById('edit-user-id').value = id; document.getElementById('edit-user-id').disabled = true; document.getElementById('edit-user-name').value = user.name; roleSelect.value = user.role; } else { document.getElementById('edit-user-id').value = ''; document.getElementById('edit-user-id').disabled = false; document.getElementById('edit-user-name').value = ''; } };
        window.app.saveUser = async function() { const id = document.getElementById('edit-user-id').value; const data = { name: document.getElementById('edit-user-name').value, role: document.getElementById('edit-user-role').value }; if(data.role === 'manager') data.password = document.getElementById('edit-user-password').value; await setDoc(getDocRef("users", id), data, { merge: true }); window.app.showUserList(); };
        window.app.showUserList = function() { document.getElementById('user-list-container').classList.remove('hidden'); document.getElementById('user-editor-section').classList.add('hidden'); };
        window.app.deleteUser = function(id) { window.app.confirmAction('ç¢ºå®šåˆªé™¤æ­¤ä½¿ç”¨è€…ï¼Ÿ', async () => { await deleteDoc(getDocRef("users", id)); showToast("ä½¿ç”¨è€…å·²åˆªé™¤", "success"); }); };
        
        init();
    </script>
</body>
</html>