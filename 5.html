<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備點檢表原型 (整合 Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- 引入 QR Code 掃描函式庫 -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- 引入 QR Code 產生函式庫 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- 引入 PDF 產生與 HTML 轉圖片函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 引入 EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc;
        }
        .status-btn.selected { 
            transform: scale(1.05); 
            box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
        }
        .status-btn.selected-normal { background-color: #22c55e; color: white; border-color: #22c55e; }
        .status-btn.selected-abnormal { background-color: #ef4444; color: white; border-color: #ef4444; }
        .status-btn.selected-na { background-color: #64748b; color: white; border-color: #64748b; }
        #qr-scanner-modal, #loading-overlay, #confirm-modal, #template-modal, #history-editor-modal, #password-modal, #qr-code-display-modal, #maintenance-modal, #image-viewer-modal, #action-selection-modal, #maintenance-editor-modal { transition: opacity 0.3s ease-in-out; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        .spinner-sm { border: 2px solid rgba(255, 255, 255, 0.3); width: 16px; height: 16px; border-radius: 50%; border-left-color: #ffffff; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { transition: all 0.3s ease-in-out; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        #qr-reader {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .image-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem; /* rounded-md */
        }
        /* 用於PDF匯出的隱藏式報表 */
        #printable-report-container {
            position: absolute;
            left: -9999px;
            top: auto;
        }
        .printable-report-page {
            width: 780px;  /* 直向A4寬度 */
            height: 1100px; /* 直向A4高度 */
            background: white;
            padding: 40px;
            font-size: 12px; /* 調整字體大小以適應較窄的寬度 */
            color: black;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
        }
        .printable-report-page table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid black;
        }
        .printable-report-page th, .printable-report-page td {
            border: 1px solid black;
            padding: 6px; /* 減少內邊距 */
            text-align: center;
            vertical-align: middle;
        }
        .printable-report-page .report-header {
            text-align: center;
            margin-bottom: 15px;
        }
        .printable-report-page .report-footer {
            margin-top: 15px;
            font-size: 10px;
        }
        .admin-tab-active {
            color: #4f46e5;
            border-color: #4f46e5;
        }
        .status-dot {
            display: inline-block;
            width: 0.65rem;
            height: 0.65rem;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- 讀取遮罩 -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-slate-600">資料載入中...</p>
    </div>

    <!-- 主容器 -->
    <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 md:p-8">
        
        <div class="flex justify-between items-center mb-6">
            <div id="user-status" class="text-sm flex items-center">
                <div id="logged-out-view" class="hidden flex items-center gap-2">
                    <select id="user-select" class="form-select border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                        <option value="">請選擇使用者...</option>
                    </select>
                    <button onclick="loginFromDropdown()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-xs hover:bg-indigo-700 transition-colors">登入</button>
                    <span class="text-slate-400 text-xs px-1">或</span>
                    <button onclick="loginGuest()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg text-xs hover:bg-gray-600 transition-colors">來賓模式</button>
                </div>
                <div id="logged-in-view" class="hidden">
                    <span>登入者: <strong id="logged-in-name" class="text-indigo-600 font-semibold"></strong></span>
                    <button onclick="logout()" class="ml-3 text-red-500 hover:underline text-xs font-medium">[登出]</button>
                </div>
            </div>
            <button id="toggle-mode-btn" onclick="toggleManagementMode()" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 text-sm hidden transition-colors">⚙️ 管理後台</button>
        </div>

        <!-- 使用者點檢模式 -->
        <div id="user-mode">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-slate-800">設備點檢</h1>
                <p id="header-subtitle" class="text-slate-500 mt-2">正在初始化應用程式...</p>
            </header>

            <div id="main-content" class="hidden space-y-6">
                <div id="notification-center" class="card p-6">
                     <h2 class="text-xl font-semibold text-slate-800 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
                        待辦事項與通知
                    </h2>
                    <div id="notification-list" class="space-y-3">
                        <p class="text-slate-400 text-center py-4">目前沒有任何通知</p>
                    </div>
                </div>

                <div id="scan-section" class="card text-center p-8">
                    <button onclick="showScanner()" class="bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-indigo-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-transform hover:scale-105">掃描 QR Code 開始點檢</button>
                </div>

                <div id="manual-select-section" class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">或手動選擇設備</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="manual-category-select" class="block text-sm font-medium text-slate-600 mb-1">1. 選擇設備大類</label>
                            <select id="manual-category-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">請先登入...</option>
                            </select>
                        </div>
                        <div>
                            <label for="manual-device-select" class="block text-sm font-medium text-slate-600 mb-1">2. 選擇設備</label>
                            <select id="manual-device-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" disabled>
                                <option value="">請先選擇大類...</option>
                            </select>
                        </div>
                        <div class="pt-2">
                            <button onclick="handleManualSelection()" id="manual-start-button" class="w-full bg-slate-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-slate-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>下一步</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checklist-section" class="hidden space-y-6">
                 <div class="card p-6"><h2 class="text-xl font-semibold text-slate-800 mb-4 border-b border-gray-200 pb-3">設備資訊</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4"><div><label class="block text-sm font-medium text-slate-500">設備區分</label><p id="device-category" class="mt-1 text-lg font-semibold text-slate-700"></p></div><div><label class="block text-sm font-medium text-slate-500">設備名稱</label><p id="device-name" class="mt-1 text-lg font-semibold text-slate-700"></p></div><div><label class="block text-sm font-medium text-slate-500">設備編號</label><p id="device-id" class="mt-1 text-lg font-semibold text-slate-700"></p></div><div id="asset-number-display-wrapper"><label class="block text-sm font-medium text-slate-500">資產編號</label><p id="asset-number-display" class="mt-1 text-lg font-semibold text-slate-700"></p></div><div><label class="block text-sm font-medium text-slate-500">點檢日期</label><p id="check-date" class="mt-1 text-lg font-semibold text-slate-700"></p></div><div><label class="block text-sm font-medium text-slate-500">點檢人員</label><p id="user-name-display" class="mt-1 text-lg font-semibold text-slate-700"></p></div></div></div>
                <div id="checklist-items-container" class="space-y-6"></div>
                <div class="card p-6"><h2 class="text-xl font-semibold text-slate-800 mb-4">總結備註</h2><textarea id="summary-notes" class="w-full p-2 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" rows="3"></textarea></div>
                <div class="mt-2 flex space-x-4"><button onclick="resetApp()" class="w-1/3 bg-slate-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-600 transition-colors">取消</button><button onclick="submitChecklist(this)" class="w-2/3 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">提交點檢表</button></div>
            </div>
        </div>

        <!-- 管理者模式 -->
        <div id="admin-mode" class="hidden">
            <header class="mb-6"><h1 class="text-4xl font-bold text-slate-800">管理後台</h1></header>
            <div class="mb-6 border-b border-gray-200"><nav class="flex -mb-px space-x-6 overflow-x-auto"><button onclick="switchAdminTab('equipment')" id="tab-equipment" class="px-1 py-3 font-semibold text-sm border-b-2 admin-tab-active">設備管理</button><button onclick="switchAdminTab('templates')" id="tab-templates" class="px-1 py-3 font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300">點檢範本</button><button onclick="switchAdminTab('users')" id="tab-users" class="px-1 py-3 font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300">人員管理</button><button onclick="switchAdminTab('summaryReports')" id="tab-summaryReports" class="px-1 py-3 font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300">綜合報表</button><button onclick="switchAdminTab('checklistHistory')" id="tab-checklistHistory" class="px-1 py-3 font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300">點檢記錄</button><button onclick="switchAdminTab('maintenance')" id="tab-maintenance" class="px-1 py-3 font-semibold text-sm border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-gray-300">保養記錄</button></nav></div>
            
            <div id="admin-tab-content-equipment">
                <div id="equipment-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">設備列表</h2>
                        <button onclick="showEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">新增設備</button>
                    </div>
                    <!-- 設備大類分頁標籤 -->
                    <div id="equipment-category-tabs" class="mb-4 border-b border-gray-200"></div>
                    <!-- 設備列表容器 -->
                    <div id="equipment-list-container"></div>
                </div>
                <div id="equipment-editor-section" class="hidden card p-6">
                    <h2 id="editor-title" class="text-2xl font-semibold mb-6 text-slate-800">編輯設備</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-slate-600">設備編號 (ID)</label><input type="text" id="edit-device-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                            <div><label class="block text-sm font-medium text-slate-600">設備名稱 (小類)</label><input type="text" id="edit-device-name" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600">設備區分 (大類)</label>
                                <select id="edit-device-category-select" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"></select>
                                <input type="text" id="edit-device-category-new" class="mt-2 hidden w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="請輸入新的區分名稱">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600">放置地點</label>
                                <select id="edit-device-location-select" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"></select>
                                <input type="text" id="edit-device-location-new" class="mt-2 hidden w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="請輸入新的地點">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600">資產編號</label>
                                <div class="mt-2 flex items-center space-x-4">
                                    <label class="flex items-center"><input type="radio" name="hasAssetNumber" value="no" class="form-radio text-indigo-600 focus:ring-indigo-500" onchange="toggleAssetNumberInput(false)"> <span class="ml-2">無</span></label>
                                    <label class="flex items-center"><input type="radio" name="hasAssetNumber" value="yes" class="form-radio text-indigo-600 focus:ring-indigo-500" onchange="toggleAssetNumberInput(true)"> <span class="ml-2">有</span></label>
                                </div>
                                <input type="text" id="edit-asset-number" class="mt-2 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 hidden" placeholder="請輸入財產編號">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-slate-600">現況</label>
                                <div id="edit-device-status" class="mt-2 flex items-center space-x-4">
                                    <label class="flex items-center"><input type="radio" name="status" value="使用中" class="form-radio text-indigo-600 focus:ring-indigo-500"> <span class="ml-2">使用中</span></label>
                                    <label class="flex items-center"><input type="radio" name="status" value="維修中" class="form-radio text-indigo-600 focus:ring-indigo-500"> <span class="ml-2">維修中</span></label>
                                    <label class="flex items-center"><input type="radio" name="status" value="未使用" class="form-radio text-indigo-600 focus:ring-indigo-500"> <span class="ml-2">未使用</span></label>
                                </div>
                            </div>
                        </div>
                        <div id="unused-reason-wrapper" class="hidden">
                            <label class="block text-sm font-medium text-slate-600">未使用原因說明</label>
                            <textarea id="edit-device-unused-reason" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" rows="2"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-600">下次預計點檢日</label><input type="date" id="edit-next-check-date" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div><div><label class="block text-sm font-medium text-slate-600">點檢週期 (天)</label><input type="number" id="edit-check-cycle" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div></div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-slate-600">下次預計清潔日</label><input type="date" id="edit-next-cleaning-date" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div><div><label class="block text-sm font-medium text-slate-600">清潔週期 (天)</label><input type="number" id="edit-cleaning-cycle" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div></div>
                        <div><label class="block text-sm font-medium text-slate-600">授權人員</label><div id="user-assignment-container" class="mt-2 space-y-2 max-h-40 overflow-y-auto border border-gray-300 p-3 rounded-md bg-slate-50"></div></div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600">圖片快照</label>
                            <div class="mt-2 flex items-center gap-4">
                                <div class="relative w-24 h-24">
                                    <img id="image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=無圖片" class="w-24 h-24 object-cover rounded-md border border-slate-200">
                                </div>
                                <div class="space-y-2">
                                    <button type="button" onclick="triggerImageInput(false)" class="w-full text-sm bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50">從檔案上傳</button>
                                    <button type="button" onclick="triggerImageInput(true)" class="w-full text-sm bg-indigo-500 text-white rounded-md px-4 py-2 hover:bg-indigo-600">直接拍照</button>
                                    <input type="file" id="edit-device-image" accept="image/*" class="hidden">
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-6 border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="text-xl font-semibold text-slate-800">點檢項目</h3>
                         <button onclick="showTemplateModal()" class="bg-teal-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-teal-600 text-sm transition-colors">從範本載入</button>
                    </div>
                    <div id="item-editor-container" class="space-y-6"></div>
                    <button onclick="addCategoryEditor()" class="mt-4 bg-indigo-100 text-indigo-800 font-semibold py-2 px-4 rounded-lg w-full hover:bg-indigo-200 transition-colors">＋ 新增大分類</button>
                    <hr class="my-6 border-gray-200">
                    <div>
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">可更換零件管理</h3>
                        <div id="component-editor-container" class="space-y-4"></div>
                        <button onclick="addComponentEditor()" class="mt-4 bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg w-full hover:bg-gray-200 transition-colors">＋ 新增零件</button>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3"><button onclick="showList()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button><button onclick="saveEquipment(this)" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">儲存變更</button></div>
                </div>
            </div>
            
            <div id="admin-tab-content-templates" class="hidden">
                <div id="template-list-section"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-slate-800">點檢範本列表</h2><button onclick="showTemplateEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">新增範本</button></div><div id="template-list-container" class="space-y-3"></div></div>
                <div id="template-editor-section" class="hidden card p-6">
                    <h2 id="template-editor-title" class="text-2xl font-semibold mb-6 text-slate-800">編輯範本</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-slate-600">範本名稱</label><input type="text" id="edit-template-name" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    </div>
                    <hr class="my-6 border-gray-200"><h3 class="text-xl font-semibold mb-4 text-slate-800">點檢項目</h3><div id="template-item-editor-container" class="space-y-6"></div>
                    <button onclick="addCategoryEditor(null, 'template-item-editor-container')" class="mt-4 bg-indigo-100 text-indigo-800 font-semibold py-2 px-4 rounded-lg w-full hover:bg-indigo-200 transition-colors">＋ 新增大分類</button>
                    <div class="mt-8 flex justify-end space-x-3"><button onclick="showTemplateList()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button><button onclick="saveTemplate(this)" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">儲存範本</button></div>
                </div>
            </div>

            <div id="admin-tab-content-users" class="hidden">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-slate-800">人員列表</h2><button onclick="showUserEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">新增人員</button></div>
                <div id="user-list-container" class="space-y-3"></div>
                <div id="user-editor-section" class="hidden card p-6">
                    <h2 id="user-editor-title" class="text-2xl font-semibold mb-6 text-slate-800">編輯人員</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-slate-600">員工編號 (ID)</label><input type="text" id="edit-user-id" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                        <div><label class="block text-sm font-medium text-slate-600">姓名</label><input type="text" id="edit-user-name" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                        <div><label class="block text-sm font-medium text-slate-600">Email</label><input type="email" id="edit-user-email" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                        <div><label class="block text-sm font-medium text-slate-600">角色</label><select id="edit-user-role" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"><option value="operator">操作員</option><option value="manager">主管</option></select></div>
                        <div id="password-field-wrapper" class="hidden"><label class="block text-sm font-medium text-slate-600">密碼</label><input type="password" id="edit-user-password" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3"><button onclick="showUserList()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button><button onclick="saveUser(this)" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">儲存</button></div>
                </div>
            </div>

            <div id="admin-tab-content-summaryReports" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">綜合報表輸出</h2>
                <div class="card p-6">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-600">報表類型</label>
                        <select id="report-type-select" onchange="toggleReportFilters()" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select">
                            <option value="checklist">點檢紀錄</option>
                            <option value="maintenance">保養與零件更換記錄</option>
                            <option value="equipment">設備資訊總覽</option>
                        </select>
                    </div>

                    <div id="checklist-filters">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            <div><label class="block text-sm font-medium text-slate-600">開始日期</label><input type="date" id="report-start-date" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                            <div><label class="block text-sm font-medium text-slate-600">結束日期</label><input type="date" id="report-end-date" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                            <div><label class="block text-sm font-medium text-slate-600">篩選設備區分</label><select id="report-category-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"><option value="all">所有區分</option></select></div>
                            <div><label class="block text-sm font-medium text-slate-600">篩選設備</label><select id="report-device-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"><option value="all">所有設備</option></select></div>
                            <div><label class="block text-sm font-medium text-slate-600">資產編號</label><select id="report-asset-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"><option value="all">全部</option><option value="yes">有</option><option value="no">無</option></select></div>
                        </div>
                    </div>

                    <div id="maintenance-filters" class="hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                           <div><label class="block text-sm font-medium text-slate-600">開始日期</label><input type="date" id="report-maint-start-date" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                           <div><label class="block text-sm font-medium text-slate-600">結束日期</label><input type="date" id="report-maint-end-date" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                           <div><label class="block text-sm font-medium text-slate-600">篩選設備區分</label><select id="report-maint-category-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"><option value="all">所有區分</option></select></div>
                           <div><label class="block text-sm font-medium text-slate-600">篩選設備</label><select id="report-maint-device-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select"><option value="all">所有設備</option></select></div>
                           <div>
                               <label class="block text-sm font-medium text-slate-600">保養類型</label>
                               <select id="report-maint-type-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select">
                                   <option value="all">全部</option>
                                   <option value="cleaning">機台清潔</option>
                                   <option value="replacement">零件更換</option>
                               </select>
                           </div>
                       </div>
                   </div>

                    <div id="equipment-filters" class="hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-600">篩選設備區分</label>
                                <select id="report-equip-category-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select">
                                    <option value="all">所有區分</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600">篩選放置地點</label>
                                <select id="report-equip-location-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select">
                                    <option value="all">所有地點</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600">篩選現況</label>
                                <select id="report-equip-status-filter" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 form-select">
                                    <option value="all">所有現況</option>
                                    <option value="使用中">使用中</option>
                                    <option value="維修中">維修中</option>
                                    <option value="未使用">未使用</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button onclick="generateSelectedReport()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">產生報表</button>
                        <button id="export-csv-btn" onclick="exportChecklistToCSV()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-400 hover:bg-green-700 transition-colors" disabled>匯出 CSV</button>
                        <button id="export-pdf-btn" onclick="exportChecklistToPDF()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-400 hover:bg-red-700 transition-colors" disabled>匯出 PDF</button>
                        <button id="export-weekly-pdf-btn" onclick="exportWeeklyPDF()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-400 hover:bg-blue-700 transition-colors" disabled>匯出週報表 (PDF)</button>
                    </div>
                    <div id="report-results-container" class="mt-6">
                        <p class="text-slate-500 text-center">請設定篩選條件並產生報表。</p>
                    </div>
                </div>
            </div>

            <div id="admin-tab-content-checklistHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">點檢歷史記錄</h2>
                <div class="card p-6">
                    <div id="checklist-history-log-container" class="mt-6">
                        <p class="text-slate-500 text-center">尚未有任何點檢記錄。</p>
                    </div>
                </div>
            </div>

            <div id="admin-tab-content-maintenance" class="hidden">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">保養與零件更換記錄</h2>
                <div class="card p-6">
                    <div id="maintenance-log-container" class="mt-6">
                        <p class="text-slate-500 text-center">尚未有任何保養記錄。</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4 text-slate-800">掃描設備 QR Code</h3>
            <div id="qr-reader" class="w-full"></div>
            <button onclick="hideScanner()" class="w-full bg-slate-500 text-white p-3 rounded-lg mt-4 hover:bg-slate-600 transition-colors">取消</button>
        </div>
    </div>

    <!-- QR Code Display Modal -->
    <div id="qr-code-display-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center" onclick="event.stopPropagation()">
            <h3 id="qr-code-modal-title" class="text-2xl font-bold mb-4 text-slate-800">設備 QR Code</h3>
            <div id="qr-code-printable-area" class="p-4 bg-white">
                <p id="qr-code-device-name" class="text-xl font-bold text-slate-900 mb-4"></p>
                <div class="flex justify-around items-center gap-4">
                    <div class="text-center">
                        <div id="qr-code-container-checklist" class="flex justify-center"></div>
                        <p class="mt-3 font-semibold text-slate-800 text-sm">掃描以進行點檢</p>
                    </div>
                    <div class="text-center">
                        <div id="qr-code-container-maintenance" class="flex justify-center"></div>
                        <p class="mt-3 font-semibold text-slate-800 text-sm">掃描以記錄保養</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex space-x-3">
                 <button onclick="closeQRCodeModal()" class="w-1/2 bg-slate-500 text-white p-3 rounded-lg hover:bg-slate-600 transition-colors">關閉</button>
                 <button onclick="downloadQRCodeImage()" class="w-1/2 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors">下載圖檔</button>
            </div>
        </div>
    </div>
    
    <!-- Template Modal -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
            <h3 class="text-xl font-semibold mb-4 text-slate-800">選擇要載入的範本</h3>
            <div id="template-selection-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="flex justify-end mt-6">
                <button onclick="closeTemplateModal()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">關閉</button>
            </div>
        </div>
    </div>

    <!-- History Editor Modal -->
    <div id="history-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <h2 id="history-editor-title" class="text-2xl font-semibold mb-4 text-slate-800 flex-shrink-0">編輯點檢紀錄</h2>
            <div id="history-editor-content" class="overflow-y-auto space-y-4">
                <!-- 編輯內容將動態生成於此 -->
            </div>
            <div class="mt-6 flex justify-end space-x-3 flex-shrink-0">
                <button onclick="closeHistoryEditor()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
                <button id="save-history-btn" onclick="" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Maintenance Editor Modal -->
    <div id="maintenance-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <h2 id="maintenance-editor-title" class="text-2xl font-semibold mb-4 text-slate-800 flex-shrink-0">編輯保養紀錄</h2>
            <div id="maintenance-editor-content" class="overflow-y-auto space-y-4">
                <!-- Dynamic content will be injected here -->
            </div>
            <div class="mt-6 flex justify-end space-x-3 flex-shrink-0">
                <button onclick="closeMaintenanceEditor()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
                <button id="save-maintenance-changes-btn" onclick="" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- 確認對話框 Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[130] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <p id="confirm-modal-text" class="text-lg mb-6 text-slate-700"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-modal-cancel" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
                <button id="confirm-modal-confirm" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">確定</button>
            </div>
        </div>
    </div>

    <!-- 密碼輸入 Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[130] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="password-modal-title" class="text-lg font-semibold mb-4 text-slate-800">請輸入密碼</h3>
            <input type="password" id="password-input" class="w-full p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closePasswordModal()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">取消</button>
                <button onclick="verifyPassword()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">登入</button>
            </div>
        </div>
    </div>

    <!-- Maintenance Log Modal -->
    <div id="maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h2 id="maintenance-modal-title" class="text-2xl font-semibold mb-4 text-slate-800">記錄保養活動</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600">保養類型</label>
                    <select id="maintenance-type" class="form-select w-full mt-1">
                        <option value="cleaning">機台清潔</option>
                        <option value="replacement">零件更換</option>
                    </select>
                </div>
                <div id="maintenance-component-selector" class="hidden">
                    <label class="block text-sm font-medium text-slate-600">選擇更換的零件</label>
                    <select id="maintenance-component-name" class="form-select w-full mt-1"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">執行人員</label>
                    <p id="maintenance-user-name" class="mt-1 font-semibold text-slate-700"></p>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-slate-600">保養備註</label>
                    <textarea id="maintenance-notes" class="w-full p-2 border-gray-300 rounded-md mt-1" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">上傳照片記錄</label>
                    <div class="mt-2 flex items-center gap-4">
                        <div class="relative w-24 h-24">
                           <img id="maintenance-image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=無圖片" class="w-24 h-24 object-cover rounded-md border border-slate-200">
                        </div>
                        <div class="space-y-2">
                            <button type="button" onclick="triggerMaintenanceImageInput(false)" class="w-full text-sm bg-white border border-slate-300 rounded-md px-4 py-2 hover:bg-slate-50">從檔案上傳</button>
                            <button type="button" onclick="triggerMaintenanceImageInput(true)" class="w-full text-sm bg-indigo-500 text-white rounded-md px-4 py-2 hover:bg-indigo-600">直接拍照</button>
                            <input type="file" id="maintenance-image-input" accept="image/*" class="hidden">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeMaintenanceModal()" class="bg-slate-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">取消</button>
                <button id="save-maintenance-btn" onclick="logMaintenance(this)" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">記錄存檔</button>
            </div>
        </div>
    </div>

    <!-- Action Selection Modal -->
    <div id="action-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[110] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold mb-2 text-slate-800">選擇操作</h2>
            <p id="action-device-name" class="text-lg text-slate-600 mb-6"></p>
            <div class="space-y-3">
                <button onclick="startChecklist()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">進行點檢</button>
                <button onclick="startMaintenance()" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors">記錄保養 (清潔/更換)</button>
            </div>
            <button onclick="closeActionSelectionModal()" class="mt-6 text-slate-500 hover:underline">取消</button>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[140] hidden" onclick="closeImageModal()">
        <img id="full-size-image" src="" class="max-w-full max-h-full object-contain rounded-lg">
    </div>

    <!-- 通知 Toast 容器 -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[110] space-y-3 w-full max-w-xs sm:max-w-sm"></div>

    <!-- 隱藏的週報表容器 -->
    <div id="printable-report-container"></div>


    <!-- Firebase SDK -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, writeBatch, serverTimestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const { jsPDF } = window.jspdf;

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPpMCssbitCn2wE7WEqefL2czjIsRuyBw",
            authDomain: "checklist-20250825.firebaseapp.com",
            databaseURL: "https://checklist-20250825-default-rtdb.firebaseio.com",
            projectId: "checklist-20250825",
            storageBucket: "checklist-20250825.appspot.com",
            messagingSenderId: "899658463753",
            appId: "1:899658463753:web:71819671db2cdf6bf4d6d8",
            measurementId: "G-FH3F97BZ7F"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 本地資料快取 ---
        let equipmentDatabase = {};
        let userDatabase = {};
        let templateDatabase = {};
        let notificationDatabase = [];
        let checkHistory = [];
        let maintenanceHistory = [];
        let reportData = [];
        let maintenanceReportData = [];
        let equipmentReportData = [];

        // --- 全域狀態 ---
        let loggedInUser = null;
        let userToLogin = null; // 用於密碼驗證
        let currentMode = 'user';
        let currentlyCheckingId = null; 
        let selectedDeviceId = null;
        let currentlyEditingId = null;
        let currentlyEditingUserId = null;
        let currentlyEditingTemplateId = null;
        let currentlyMaintainedEqId = null;
        let confirmCallback = null;
        let html5QrCode = null;
        let currentQRCodeInfo = { id: null, name: null };
        const MOCK_TODAY = new Date('2025-08-30T14:30:00');
        let startupAction = null; // 用於儲存從 URL 參數來的啟動指令
        
        // --- 進度提示函式 ---
        function showButtonLoading(button, text = '處理中...') {
            if (!button) return;
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<div class="flex items-center justify-center"><div class="spinner-sm mr-2"></div> ${text}</div>`;
        }

        function hideButtonLoading(button) {
            if (!button) return;
            button.disabled = false;
            if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
            }
        }

        // --- 圖片處理函式 ---
        async function handleImageSelection(file, previewElement) {
            if (!file) return;

            const overlay = document.createElement('div');
            overlay.className = 'image-loading-overlay';
            overlay.innerHTML = '<div class="spinner"></div>';
            previewElement.parentElement.style.position = 'relative';
            previewElement.parentElement.appendChild(overlay);

            try {
                const resizedDataUrl = await resizeImage(file);
                previewElement.src = resizedDataUrl;
                previewElement.dataset.imageDataUrl = resizedDataUrl;
            } catch (e) {
                showToast('圖片處理失敗', 'error');
            } finally {
                previewElement.parentElement.removeChild(overlay);
            }
        }

        function resizeImage(file, maxWidth = 1024, maxHeight = 1024) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                    };
                    img.onerror = (error) => {
                        console.error("Image load error:", error);
                        reject(new Error("圖片載入失敗，可能檔案已損毀。"));
                    };
                };
                reader.onerror = (error) => {
                    console.error("FileReader error:", error);
                    reject(new Error("讀取檔案時發生錯誤。"));
                };
            });
        }

        // --- 初始化 & 資料監聽 ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('check-date').textContent = MOCK_TODAY.toISOString().slice(0, 10);
            emailjs.init({ publicKey: "tl836o8pG4pjW2xPs" });

            // 檢查 URL 參數
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const id = urlParams.get('id');

            if (action && id) {
                startupAction = { action, id };
                // 清理 URL，避免重新整理時再次觸發
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            const unsubscribeUsers = onSnapshot(collection(db, "users"), (snapshot) => {
                unsubscribeUsers();
                
                let newUserData = {};
                snapshot.forEach(doc => { newUserData[doc.id] = doc.data(); });
                userDatabase = newUserData;
                console.log("Initial users data loaded successfully.");
                
                startRealtimeDataListeners();
                updateUIForAuthState();
                document.getElementById('loading-overlay').classList.add('hidden');

            }, (error) => {
                console.error("Critical Error: Cannot fetch initial user data. App cannot start.", error);
                showFatalError('無法載入使用者資料，請檢查網路連線或聯絡管理員。');
            });

            setupModalListeners();
        });

        function showFatalError(message) {
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = message;
            loadingText.classList.add('text-red-500', 'font-bold', 'px-4', 'text-center');
            document.querySelector('#loading-overlay .spinner').classList.add('hidden');
        }

        function setupModalListeners() {
            document.getElementById('confirm-modal-cancel').addEventListener('click', () => {
                document.getElementById('confirm-modal').classList.add('hidden');
                confirmCallback = null;
            });
            document.getElementById('confirm-modal-confirm').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                document.getElementById('confirm-modal').classList.add('hidden');
                confirmCallback = null;
            });
        }

        function startRealtimeDataListeners() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                let newUserData = {};
                snapshot.forEach(doc => { newUserData[doc.id] = doc.data(); });
                userDatabase = newUserData;
                populateUserDropdown();
                if (currentMode === 'admin' && loggedInUser?.role === 'manager') renderUserList();
            });

            onSnapshot(collection(db, "equipment"), (snapshot) => {
                let newEquipmentData = {};
                snapshot.forEach(doc => { newEquipmentData[doc.id] = { id: doc.id, ...doc.data() }; });
                equipmentDatabase = newEquipmentData;
                checkScheduledTasks();
                // 數據載入後，嘗試執行啟動指令
                executeStartupAction();
                if (currentMode === 'admin') {
                    if (loggedInUser?.role === 'manager' || loggedInUser?.role === 'guest') renderEquipmentList();
                    populateReportFilters();
                }
            });

            onSnapshot(collection(db, "checklist_templates"), (snapshot) => {
                let newTemplateData = {};
                snapshot.forEach(doc => { newTemplateData[doc.id] = { id: doc.id, ...doc.data() }; });
                templateDatabase = newTemplateData;
                if (currentMode === 'admin' && loggedInUser?.role === 'manager') renderTemplateList();
            });

            onSnapshot(collection(db, "check_history"), (snapshot) => {
                checkHistory = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if(currentMode === 'admin') {
                    if(document.getElementById('admin-tab-content-summaryReports').classList.contains('hidden') === false) {
                       if (document.getElementById('report-start-date').value && document.getElementById('report-end-date').value) {
                           generateChecklistReport();
                       }
                    }
                    if(document.getElementById('admin-tab-content-checklistHistory').classList.contains('hidden') === false) {
                       renderChecklistHistory();
                    }
                }
            });

            onSnapshot(collection(db, "maintenance_history"), (snapshot) => {
                maintenanceHistory = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                if(currentMode === 'admin') {
                    if(document.getElementById('admin-tab-content-maintenance').classList.contains('hidden') === false) {
                       renderMaintenanceLog();
                    }
                    if(document.getElementById('admin-tab-content-summaryReports').classList.contains('hidden') === false && document.getElementById('report-type-select').value === 'maintenance') {
                       if (document.getElementById('report-maint-start-date').value && document.getElementById('report-maint-end-date').value) {
                           generateMaintenanceReport();
                       }
                    }
                }
            });

            setInterval(checkScheduledTasks, 10000);
        }
        
        function checkScheduledTasks() {
            if (!loggedInUser || loggedInUser.role === 'guest') return;
            const today = MOCK_TODAY;
            const tomorrow = new Date(MOCK_TODAY);
            tomorrow.setDate(today.getDate() + 1);
            const todayStr = today.toISOString().slice(0, 10);
            const tomorrowStr = tomorrow.toISOString().slice(0, 10);

            for (const eqId in equipmentDatabase) {
                const eq = equipmentDatabase[eqId];
                if (eq.nextCheckDate) {
                    let message = '', level = 'info';
                    if (eq.nextCheckDate < todayStr) { message = `設備 [${eq.name}] 已逾期點檢 (應於 ${eq.nextCheckDate})。`; level = 'danger'; } 
                    else if (eq.nextCheckDate === todayStr) { message = `設備 [${eq.name}] 今天應進行點檢。`; level = 'warning'; } 
                    else if (eq.nextCheckDate === tomorrowStr) { message = `設備 [${eq.name}] 明天 (${eq.nextCheckDate}) 應進行點檢。`; level = 'info'; }
                    if (message) { const uniqueId = `task-${eqId}-${eq.nextCheckDate}`; if (!notificationDatabase.some(n => n.id === uniqueId)) createNotification(message, eq.authorizedUsers, level, uniqueId); }
                }
                if (eq.nextCleaningDate) {
                    let cleanMessage = '', cleanLevel = 'info';
                    if (eq.nextCleaningDate < todayStr) { cleanMessage = `設備 [${eq.name}] 已逾期清潔 (應於 ${eq.nextCleaningDate})。`; cleanLevel = 'danger'; } 
                    else if (eq.nextCleaningDate === todayStr) { cleanMessage = `設備 [${eq.name}] 今天應進行清潔。`; cleanLevel = 'warning'; }
                    if (cleanMessage) { const uniqueId = `clean-${eqId}-${eq.nextCleaningDate}`; if (!notificationDatabase.some(n => n.id === uniqueId)) createNotification(cleanMessage, eq.authorizedUsers, cleanLevel, uniqueId); }
                }
                if (eq.components && eq.components.length > 0) {
                    eq.components.forEach(comp => {
                        if (comp.nextReplacementDate) {
                            let compMessage = '', compLevel = 'info';
                            if (comp.nextReplacementDate < todayStr) { compMessage = `設備 [${eq.name}] 的零件 [${comp.componentName}] 已逾期更換 (應於 ${comp.nextReplacementDate})。`; compLevel = 'danger'; } 
                            else if (comp.nextReplacementDate === todayStr) { compMessage = `設備 [${eq.name}] 的零件 [${comp.componentName}] 今天應更換。`; compLevel = 'warning'; }
                            if (compMessage) { const uniqueId = `comp-${eqId}-${comp.componentName}-${comp.nextReplacementDate}`; if (!notificationDatabase.some(n => n.id === uniqueId)) createNotification(compMessage, eq.authorizedUsers, compLevel, uniqueId); }
                        }
                    });
                }
            }
            renderNotifications();
        }

        function createNotification(message, targetUsers, level = 'info', uniqueId = null) {
            if (uniqueId && notificationDatabase.some(n => n.id === uniqueId)) return;
            notificationDatabase.push({ id: uniqueId || Date.now(), message, targetUsers, level, timestamp: new Date().toISOString() });
        }

        function renderNotifications() {
            const container = document.getElementById('notification-list');
            if (!loggedInUser || loggedInUser.role === 'guest') { container.innerHTML = `<p class="text-slate-400 text-center py-4">請登入以查看通知</p>`; return; }
            container.innerHTML = '';
            const userNotifications = notificationDatabase.filter(n => (n.targetUsers === 'all' || n.targetUsers.includes(loggedInUser.id) || (loggedInUser.role === 'manager' && n.level === 'success'))).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (userNotifications.length === 0) { container.innerHTML = `<p class="text-slate-400 text-center py-4">目前沒有任何通知</p>`; return; }
            userNotifications.forEach(n => {
                let bgColor, textColor, icon;
                switch(n.level) {
                    case 'danger': bgColor = 'bg-red-50'; textColor = 'text-red-700'; icon = '🔥'; break;
                    case 'warning': bgColor = 'bg-yellow-50'; textColor = 'text-yellow-700'; icon = '⚠️'; break;
                    case 'success': bgColor = 'bg-green-50'; textColor = 'text-green-700'; icon = '✅'; break;
                    default: bgColor = 'bg-blue-50'; textColor = 'text-blue-700'; icon = 'ℹ️';
                }
                container.insertAdjacentHTML('beforeend', `<div class="${bgColor} ${textColor} p-3 rounded-lg flex items-start"><span class="mr-3 mt-1">${icon}</span><p>${n.message}</p></div>`);
            });
        }
        
        // --- 登入與UI狀態管理 ---
        function updateUIForAuthState() {
            const btn = document.getElementById('toggle-mode-btn');
            if (loggedInUser) {
                document.getElementById('logged-out-view').classList.add('hidden');
                document.getElementById('logged-in-name').textContent = loggedInUser.name;
                document.getElementById('logged-in-view').classList.remove('hidden');
                document.querySelector('#scan-section button').disabled = false;
                document.getElementById('header-subtitle').textContent = '請掃描設備 QR Code 或手動選擇';

                if (loggedInUser.role === 'guest') {
                    document.getElementById('main-content').classList.add('hidden');
                } else {
                    document.getElementById('main-content').classList.remove('hidden');
                }
                
                if (loggedInUser.role === 'manager' || loggedInUser.role === 'guest') {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            } else {
                document.getElementById('logged-in-view').classList.add('hidden');
                document.getElementById('logged-out-view').classList.remove('hidden');
                document.getElementById('user-select').value = '';
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('checklist-section').classList.add('hidden');
                document.querySelector('#scan-section button').disabled = true;
                document.getElementById('header-subtitle').textContent = '請先登入以開始作業';
                btn.classList.add('hidden');
                document.getElementById('notification-list').innerHTML = `<p class="text-slate-400 text-center py-4">請先登入查看通知</p>`;
            }
            populateManualSelectionDropdowns();
        }

        window.loginGuest = function() {
            loggedInUser = { id: 'guest', name: '來賓', role: 'guest' };
            updateUIForAuthState();
            
            currentMode = 'admin'; 
            document.getElementById('user-mode').classList.add('hidden'); 
            document.getElementById('admin-mode').classList.remove('hidden'); 
            
            const btn = document.getElementById('toggle-mode-btn');
            btn.innerHTML = '↩️ 登出'; 
            btn.classList.replace('bg-slate-700', 'bg-red-600');
            btn.classList.replace('bg-indigo-700', 'bg-red-600');
            
            setupGuestAdminView();
        }

        function setupGuestAdminView() {
            document.getElementById('tab-equipment').style.display = 'none';
            document.getElementById('tab-templates').style.display = 'none';
            document.getElementById('tab-users').style.display = 'none';
            document.querySelector('#admin-tab-content-equipment button[onclick="showEditor()"]').classList.add('hidden');
            document.querySelector('#template-list-section button').classList.add('hidden');
            document.querySelector('#admin-tab-content-users button[onclick="showUserEditor()"]').classList.add('hidden');
            switchAdminTab('summaryReports');
        }

        function resetAdminView() {
            document.getElementById('tab-equipment').style.display = '';
            document.getElementById('tab-templates').style.display = '';
            document.getElementById('tab-users').style.display = '';
            document.querySelector('#admin-tab-content-equipment button[onclick="showEditor()"]').classList.remove('hidden');
            document.querySelector('#template-list-section button').classList.remove('hidden');
            document.querySelector('#admin-tab-content-users button[onclick="showUserEditor()"]').classList.remove('hidden');
        }

        function populateUserDropdown() {
            const select = document.getElementById('user-select');
            select.innerHTML = '<option value="">請選擇使用者...</option>';
            const sortedUsers = Object.entries(userDatabase).sort(([,a],[,b]) => a.name.localeCompare(b.name, 'zh-Hant'));
            for(const [id, user] of sortedUsers) { select.insertAdjacentHTML('beforeend', `<option value="${id}">${user.name}</option>`); }
        }

        function isFirstManagerSetup() {
            return !Object.values(userDatabase).some(user => user.role === 'manager' && user.password);
        }

        window.loginFromDropdown = function() {
            const userId = document.getElementById('user-select').value;
            if (!userId) { showToast('請選擇一位使用者', 'error'); return; }
            const user = userDatabase[userId];
            const fullUser = { id: userId, ...user };

            if (user.role === 'manager') {
                if (isFirstManagerSetup()) {
                    completeLogin(fullUser);
                    showToast('首次主管登入，請立即設定您的密碼。', 'info');
                    toggleManagementMode(true);
                    switchAdminTab('users');
                    showUserEditor(userId);
                } else if (!user.password) {
                    showToast('此主管帳號尚未設定密碼，請聯繫已設定密碼的主管進行設定。', 'error');
                } else {
                    promptForPassword(fullUser);
                }
            } else {
                completeLogin(fullUser);
            }
        }

        function promptForPassword(user) {
            userToLogin = user;
            document.getElementById('password-modal-title').textContent = `主管 [${user.name}] 請輸入密碼`;
            document.getElementById('password-modal').classList.replace('hidden', 'flex');
            document.getElementById('password-input').focus();
        }

        window.closePasswordModal = function() {
            document.getElementById('password-modal').classList.replace('flex', 'hidden');
            document.getElementById('password-input').value = '';
            userToLogin = null;
        }

        window.verifyPassword = function() {
            const enteredPassword = document.getElementById('password-input').value;
            if (userToLogin && enteredPassword === userToLogin.password) {
                const user = userToLogin;
                closePasswordModal();
                completeLogin(user);
            } else {
                showToast('密碼錯誤！', 'error');
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }

        function completeLogin(user) {
            loggedInUser = user;
            updateUIForAuthState();
            checkScheduledTasks();
            executeStartupAction(); // 登入後執行啟動指令
        }

        window.logout = function() {
            if (currentMode === 'admin') {
                resetAdminView();
                currentMode = 'user';
                document.getElementById('admin-mode').classList.add('hidden');
                document.getElementById('user-mode').classList.remove('hidden');
                const btn = document.getElementById('toggle-mode-btn');
                btn.innerHTML = '⚙️ 管理後台'; 
                btn.classList.replace('bg-indigo-700', 'bg-slate-700');
                btn.classList.replace('bg-red-600', 'bg-slate-700');
            }
            loggedInUser = null;
            resetApp();
            updateUIForAuthState();
        }
        
        window.toggleManagementMode = function(isSetup = false) {
            if (loggedInUser && loggedInUser.role === 'guest') {
                logout();
                return;
            }
            if (!isSetup && (!loggedInUser || loggedInUser.role !== 'manager')) { 
                showToast('只有主管才能進入管理後台', 'warning'); 
                return; 
            }
            const userModeDiv = document.getElementById('user-mode'), adminModeDiv = document.getElementById('admin-mode'), btn = document.getElementById('toggle-mode-btn');
            if (currentMode === 'user') {
                currentMode = 'admin'; 
                userModeDiv.classList.add('hidden'); 
                adminModeDiv.classList.remove('hidden'); 
                btn.innerHTML = '👤 返回點檢模式'; 
                btn.classList.replace('bg-slate-700', 'bg-indigo-700');
                if (!isSetup) {
                    renderEquipmentList(); 
                    renderUserList(); 
                    populateReportFilters(); 
                    switchAdminTab('equipment');
                }
            } else {
                currentMode = 'user'; 
                adminModeDiv.classList.add('hidden'); 
                userModeDiv.classList.remove('hidden'); 
                btn.innerHTML = '⚙️ 管理後台'; 
                btn.classList.replace('bg-indigo-700', 'bg-slate-700');
                resetApp();
            }
        }

        window.switchAdminTab = function(tabName) {
            if (loggedInUser && loggedInUser.role === 'guest' && !['summaryReports', 'checklistHistory', 'maintenance'].includes(tabName)) {
                showToast('來賓帳號無此權限', 'warning');
                return;
            }
            document.querySelectorAll('[id^="admin-tab-content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => { el.classList.remove('admin-tab-active'); el.classList.add('border-transparent', 'text-gray-500', 'hover:text-indigo-600', 'hover:border-gray-300'); });
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('admin-tab-active');
            activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-indigo-600', 'hover:border-gray-300');
            document.getElementById(`admin-tab-content-${tabName}`).classList.remove('hidden');

            switch (tabName) {
                case 'maintenance': renderMaintenanceLog(); break;
                case 'checklistHistory': renderChecklistHistory(); break;
                case 'templates': renderTemplateList(); break;
            }
        }

        // --- 點檢流程 (含真實 QR 掃描) ---
        window.showScanner = function() {
            document.getElementById('qr-scanner-modal').classList.replace('hidden', 'flex');
            if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
            html5QrCode = new Html5Qrcode("qr-reader");
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                hideScanner();
                processQRCode(decodedText);
            };
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, qrCodeSuccessCallback)
                .catch(err => { console.error("無法啟動相機掃描。", err); showToast('無法啟動相機，請檢查權限設定。', 'error'); hideScanner(); });
        }

        window.hideScanner = function() {
            if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => {}); }
            document.getElementById('qr-scanner-modal').classList.replace('flex', 'hidden');
        }

        window.resetApp = function() { 
            document.getElementById('checklist-section').classList.add('hidden'); 
            if (loggedInUser && loggedInUser.role !== 'guest') {
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('header-subtitle').textContent = '請掃描設備 QR Code'; 
            }
            document.getElementById('summary-notes').value = ''; // 新增：清空總結備註欄位
            currentlyCheckingId = null; 
            selectedDeviceId = null;
        }

        function populateManualSelectionDropdowns() {
            const categorySelect = document.getElementById('manual-category-select'), deviceSelect = document.getElementById('manual-device-select'), startButton = document.getElementById('manual-start-button');
            categorySelect.innerHTML = '<option value="">請先登入...</option>';
            deviceSelect.innerHTML = '<option value="">請先選擇大類...</option>';
            deviceSelect.disabled = true;
            startButton.disabled = true;
            if (!loggedInUser || loggedInUser.role === 'guest') return;

            const authorizedEquipment = Object.values(equipmentDatabase).filter(eq => eq.authorizedUsers === 'all' || (Array.isArray(eq.authorizedUsers) && eq.authorizedUsers.includes(loggedInUser.id)));
            if (authorizedEquipment.length === 0) { categorySelect.innerHTML = '<option value="">無授權設備</option>'; return; }

            const categories = [...new Set(authorizedEquipment.map(eq => eq.category || '未分類'))].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
            categorySelect.innerHTML = '<option value="">請選擇大類...</option>';
            categories.forEach(category => categorySelect.appendChild(new Option(category, category)));

            categorySelect.onchange = () => {
                const selectedCategory = categorySelect.value;
                deviceSelect.innerHTML = '<option value="">請選擇設備...</option>';
                startButton.disabled = true;
                if (!selectedCategory) { deviceSelect.disabled = true; return; }
                const devicesInCategory = authorizedEquipment.filter(eq => (eq.category || '未分類') === selectedCategory).sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
                devicesInCategory.forEach(eq => deviceSelect.appendChild(new Option(`${eq.name} (${eq.id})`, eq.id)));
                deviceSelect.disabled = false;
            };

            deviceSelect.onchange = () => { startButton.disabled = !deviceSelect.value; };
        }

        window.handleManualSelection = function() {
            const deviceId = document.getElementById('manual-device-select').value;
            if (deviceId) handleDeviceSelection(deviceId);
            else showToast('請從下拉選單中選擇一個設備', 'error');
        }
        
        function processQRCode(data) {
            try {
                let params;
                if (data.startsWith('http')) {
                    const url = new URL(data);
                    params = url.searchParams;
                } else {
                    params = new URLSearchParams(data);
                }
                
                const action = params.get('action');
                const id = params.get('id');

                if (action && id) {
                    const eq = equipmentDatabase[id];
                    if (!eq) { showToast(`無效的設備 ID: "${id}"`, 'error'); return; }
                    if (eq.authorizedUsers !== 'all' && !eq.authorizedUsers.includes(loggedInUser.id)) { showToast('您沒有權限操作此設備', 'error'); return; }
                    selectedDeviceId = id;
                    if (action === 'start_checklist') { startChecklist(); } 
                    else if (action === 'start_maintenance') { startMaintenance(); } 
                    else { showToast('未知的操作指令', 'warning'); handleDeviceSelection(id); }
                } else {
                    handleDeviceSelection(data);
                }
            } catch (e) {
                handleDeviceSelection(data);
            }
        }

        window.handleDeviceSelection = function(equipmentId) {
            const eq = equipmentDatabase[equipmentId];
            if (!eq) { showToast(`找不到 ID 為 "${equipmentId}" 的設備`, 'error'); return; }
            if (eq.authorizedUsers !== 'all' && !eq.authorizedUsers.includes(loggedInUser.id)) { showToast('您沒有權限點檢此設備', 'error'); return; }
            selectedDeviceId = equipmentId;
            const modal = document.getElementById('action-selection-modal');
            document.getElementById('action-device-name').textContent = eq.name;
            modal.classList.replace('hidden', 'flex');
        }

        window.closeActionSelectionModal = function() {
            document.getElementById('action-selection-modal').classList.replace('flex', 'hidden');
            selectedDeviceId = null;
        }

        window.startChecklist = function() {
            if (!selectedDeviceId) return;
            const equipmentId = selectedDeviceId;
            const eq = equipmentDatabase[equipmentId];

            if (!eq) {
                showToast(`找不到 ID 為 "${equipmentId}" 的設備資料，請重新選擇。`, 'error');
                closeActionSelectionModal();
                return;
            }
            
            closeActionSelectionModal();
            const todayStr = MOCK_TODAY.toISOString().slice(0, 10);
            const todaysRecord = checkHistory.find(r => r.deviceId === equipmentId && r.checkTimestamp?.toDate().toISOString().slice(0, 10) === todayStr);

            if (todaysRecord) {
                showConfirm(`此設備今日已有由 [${todaysRecord.userName}] 建立的點檢紀錄。您要查看或編輯該筆紀錄嗎？`, () => showHistoryEditor(todaysRecord.id));
                document.getElementById('confirm-modal-confirm').textContent = '查看/編輯';
                selectedDeviceId = null;
                return; 
            }
            
            currentlyCheckingId = equipmentId;
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('checklist-section').classList.remove('hidden');
            document.getElementById('device-category').textContent = eq.category || 'N/A';
            document.getElementById('device-name').textContent = eq.name; 
            document.getElementById('device-id').textContent = equipmentId; 
            document.getElementById('user-name-display').textContent = loggedInUser.name;
            document.getElementById('asset-number-display').textContent = eq.assetNumber || '無';
            const container = document.getElementById('checklist-items-container'); 
            container.innerHTML = '';
            
            if (eq.items && Array.isArray(eq.items)) {
                eq.items.forEach(category => {
                    if (category.category && Array.isArray(category.subItems)) {
                        const categoryWrapper = document.createElement('div');
                        categoryWrapper.className = 'category-group space-y-4';
                        categoryWrapper.innerHTML = `<h3 class="text-lg font-semibold text-slate-600 border-b pb-2 mb-3">${category.category}</h3>`;
                        category.subItems.forEach(item => categoryWrapper.insertAdjacentHTML('beforeend', createChecklistItemHtml(item)));
                        container.appendChild(categoryWrapper);
                    }
                });
            }
        }

        window.startMaintenance = function() {
            if (!selectedDeviceId) return;
            const equipmentId = selectedDeviceId;
            closeActionSelectionModal();
            showMaintenanceModal(equipmentId);
            selectedDeviceId = null;
        }
        
        window.submitChecklist = async function(button) {
            if (!currentlyCheckingId) return;
            showButtonLoading(button, '提交中...');
            try {
                const eq = equipmentDatabase[currentlyCheckingId];
                const cycle = eq.checkCycleDays || 7;
                const newNextDate = new Date(MOCK_TODAY);
                newNextDate.setDate(MOCK_TODAY.getDate() + cycle);
                
                let itemResults = [], abnormalItems = [];
                document.querySelectorAll('.card[data-item-id]').forEach(itemDiv => {
                    const itemId = parseInt(itemDiv.dataset.itemId, 10);
                    const category = itemDiv.closest('.category-group').querySelector('h3').textContent;
                    const itemText = itemDiv.querySelector('span').textContent.split('. ')[1];
                    let status = 'unchecked', details = '';
                    const selectedBtn = itemDiv.querySelector('.status-btn.selected');
                    if (selectedBtn) {
                        if (selectedBtn.classList.contains('selected-normal')) status = '正常';
                        else if (selectedBtn.classList.contains('selected-abnormal')) { status = '異常'; details = itemDiv.querySelector('textarea').value; abnormalItems.push({ category, text: itemText, details }); }
                        else if (selectedBtn.classList.contains('selected-na')) status = 'N/A';
                    }
                    itemResults.push({ id: itemId, category, text: itemText, status, details });
                });

                const historyRecord = { deviceId: currentlyCheckingId, deviceName: eq.name, userId: loggedInUser.id, userName: loggedInUser.name, checkTimestamp: serverTimestamp(), summaryNotes: document.getElementById('summary-notes').value, items: itemResults };
                
                const batch = writeBatch(db);
                batch.update(doc(db, "equipment", currentlyCheckingId), { nextCheckDate: newNextDate.toISOString().slice(0, 10) });
                batch.set(doc(collection(db, "check_history")), historyRecord);
                await batch.commit();

                notificationDatabase = notificationDatabase.filter(n => !(String(n.id).startsWith(`task-${currentlyCheckingId}`)));
                createNotification(`[${loggedInUser.name}] 已於 ${MOCK_TODAY.toISOString().slice(0,10)} 完成 [${eq.name}] 的點檢。下次點檢日為 ${newNextDate.toISOString().slice(0, 10)}。`, Object.keys(userDatabase).filter(id => userDatabase[id].role === 'manager'), 'success');
                showToast('點檢表已成功提交！', 'success');
                
                if (abnormalItems.length > 0) sendAbnormalNotificationEmail(eq, abnormalItems, historyRecord.summaryNotes);
                resetApp();
            } catch (e) { 
                console.error("Error submitting checklist: ", e); 
                showToast('提交失敗，請檢查網路連線。', 'error'); 
            } finally {
                hideButtonLoading(button);
            }
        }

        function sendAbnormalNotificationEmail(equipment, abnormalItems, summaryNotes) {
            const managers = Object.values(userDatabase).filter(u => u.role === 'manager' && u.email);
            if (managers.length === 0) { console.log("No managers with email found."); return; }
            const abnormalDetails = abnormalItems.map(item => `分類: ${item.category}\n項目: ${item.text}\n說明: ${item.details || '(無)'}`).join('\n\n');
            const templateParams = { device_name: equipment.name, device_id: equipment.id, operator_name: loggedInUser.name, check_date: MOCK_TODAY.toLocaleString(), summary_notes: summaryNotes || '(無)', abnormal_details: abnormalDetails };
            managers.forEach(manager => {
                const params = { ...templateParams, manager_name: manager.name, to_email: manager.email };
                emailjs.send('service_ixj1nev', 'template_ylpqvov', params)
                    .then(res => showToast(`已寄送異常通知信給主管 ${manager.name}`, 'info'), err => showToast(`寄送通知信給 ${manager.name} 失敗`, 'error'));
            });
        }
        
        function executeStartupAction() {
            if (!startupAction || !loggedInUser || Object.keys(equipmentDatabase).length === 0) {
                return; // 還沒登入或資料還沒載入，稍後再說
            }

            const { action, id } = startupAction;
            const eq = equipmentDatabase[id];

            if (!eq) {
                showToast(`從連結啟動失敗：找不到設備 ID "${id}"`, 'error');
                startupAction = null;
                return;
            }

            if (eq.authorizedUsers !== 'all' && !eq.authorizedUsers.includes(loggedInUser.id)) {
                showToast(`您沒有權限操作此設備 [${eq.name}]`, 'error');
                startupAction = null;
                return;
            }

            selectedDeviceId = id;

            if (action === 'start_checklist') {
                startChecklist();
            } else if (action === 'start_maintenance') {
                startMaintenance();
            }

            startupAction = null; // 執行過後就清除
        }

        // --- 管理者: 設備管理 ---
        window.toggleAssetNumberInput = function(show) { const input = document.getElementById('edit-asset-number'); if (show) input.classList.remove('hidden'); else { input.classList.add('hidden'); input.value = ''; } }
        window.showList = function() { document.getElementById('equipment-list-section').classList.remove('hidden'); document.getElementById('equipment-editor-section').classList.add('hidden'); }
        
        window.triggerImageInput = function(useCamera) {
            const imageInput = document.getElementById('edit-device-image');
            if (useCamera) imageInput.setAttribute('capture', 'environment');
            else imageInput.removeAttribute('capture');
            imageInput.click();
        }

        window.showEditor = function(equipmentId = null) {
            document.getElementById('equipment-list-section').classList.add('hidden'); 
            document.getElementById('equipment-editor-section').classList.remove('hidden');
            currentlyEditingId = equipmentId;
            const editor = document.getElementById('equipment-editor-section');
            const catSelect = editor.querySelector('#edit-device-category-select'), catNewInput = editor.querySelector('#edit-device-category-new');
            const locSelect = editor.querySelector('#edit-device-location-select'), locNewInput = editor.querySelector('#edit-device-location-new');
            const imageInput = editor.querySelector('#edit-device-image');
            const imagePreview = editor.querySelector('#image-preview');

            editor.querySelector('#item-editor-container').innerHTML = ''; 
            editor.querySelector('#component-editor-container').innerHTML = '';
            imagePreview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=無圖片';
            delete imagePreview.dataset.imageDataUrl;
            imageInput.value = '';

            let userHtml = `<div><label class="flex items-center"><input type="checkbox" value="all" class="rounded text-indigo-600 focus:ring-indigo-500"> <span class="ml-2">所有人</span></label></div>`;
            Object.keys(userDatabase).forEach(uid => { userHtml += `<div><label class="flex items-center"><input type="checkbox" value="${uid}" class="rounded text-indigo-600 focus:ring-indigo-500"> <span class="ml-2">${userDatabase[uid].name}</span></label></div>`; });
            editor.querySelector('#user-assignment-container').innerHTML = userHtml;

            const setupDynamicSelect = (selectEl, newInEl, dataKey) => {
                const uniqueValues = [...new Set(Object.values(equipmentDatabase).map(eq => eq[dataKey]).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                selectEl.innerHTML = `<option value="">請選擇${dataKey === 'category' ? '區分' : '地點'}...</option>`;
                uniqueValues.forEach(val => selectEl.add(new Option(val, val)));
                selectEl.add(new Option('＋ 新增...', '__new__'));
                selectEl.onchange = () => { newInEl.classList.toggle('hidden', selectEl.value !== '__new__'); if (selectEl.value === '__new__') newInEl.focus(); };
                newInEl.classList.add('hidden'); newInEl.value = '';
            };
            setupDynamicSelect(catSelect, catNewInput, 'category');
            setupDynamicSelect(locSelect, locNewInput, 'location');
            
            imageInput.onchange = async () => { if (imageInput.files[0]) await handleImageSelection(imageInput.files[0], imagePreview); };
            editor.querySelectorAll('input[name="status"]').forEach(radio => radio.addEventListener('change', () => editor.querySelector('#unused-reason-wrapper').classList.toggle('hidden', editor.querySelector('input[name="status"]:checked').value !== '未使用')));

            if (equipmentId) {
                const eq = equipmentDatabase[equipmentId];
                editor.querySelector('#editor-title').textContent = '編輯設備'; 
                editor.querySelector('#edit-device-id').value = equipmentId; editor.querySelector('#edit-device-id').disabled = true; 
                editor.querySelector('#edit-device-name').value = eq.name; 
                editor.querySelector('#edit-next-check-date').value = eq.nextCheckDate || ''; editor.querySelector('#edit-check-cycle').value = eq.checkCycleDays || '';
                editor.querySelector('#edit-next-cleaning-date').value = eq.nextCleaningDate || ''; editor.querySelector('#edit-cleaning-cycle').value = eq.cleaningCycleDays || '';
                if (eq.components) eq.components.forEach(comp => addComponentEditor(comp));
                if (eq.category) catSelect.value = eq.category;
                if (eq.location) locSelect.value = eq.location;
                const statusRadio = editor.querySelector(`input[name="status"][value="${eq.status}"]`);
                if (statusRadio) statusRadio.checked = true;
                if (eq.status === '未使用') { editor.querySelector('#unused-reason-wrapper').classList.remove('hidden'); editor.querySelector('#edit-device-unused-reason').value = eq.unusedReason || ''; } 
                else { editor.querySelector('#unused-reason-wrapper').classList.add('hidden'); }
                if (eq.assetNumber) { editor.querySelector('input[name="hasAssetNumber"][value="yes"]').checked = true; toggleAssetNumberInput(true); editor.querySelector('#edit-asset-number').value = eq.assetNumber; }
                else { editor.querySelector('input[name="hasAssetNumber"][value="no"]').checked = true; toggleAssetNumberInput(false); }
                if (eq.imageUrl) imagePreview.src = eq.imageUrl;
                if (eq.items) eq.items.forEach(categoryData => addCategoryEditor(categoryData));
                if (eq.authorizedUsers === 'all') editor.querySelector('#user-assignment-container input[value="all"]').checked = true; 
                else if(Array.isArray(eq.authorizedUsers)) eq.authorizedUsers.forEach(uid => { const cb = editor.querySelector(`#user-assignment-container input[value="${uid}"]`); if (cb) cb.checked = true; });
            } else {
                editor.querySelector('#editor-title').textContent = '新增設備'; 
                ['edit-device-id', 'edit-device-name', 'edit-next-check-date', 'edit-check-cycle', 'edit-next-cleaning-date', 'edit-cleaning-cycle', 'edit-device-unused-reason'].forEach(id => editor.querySelector(`#${id}`).value = '');
                editor.querySelector('#edit-device-id').disabled = false;
                catSelect.value = ''; locSelect.value = '';
                editor.querySelector('#unused-reason-wrapper').classList.add('hidden');
                editor.querySelector('input[name="hasAssetNumber"][value="no"]').checked = true; toggleAssetNumberInput(false);
                const defaultStatus = editor.querySelector('input[name="status"][value="使用中"]');
                if (defaultStatus) defaultStatus.checked = true;
            }
        }

        window.addComponentEditor = function(componentData = null) {
            const container = document.getElementById('component-editor-container');
            const block = document.createElement('div');
            block.className = 'component-editor-block relative bg-slate-100 p-4 rounded-lg border border-slate-200';
            block.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-3"><div><label class="text-xs font-medium text-slate-500">零件名稱</label><input type="text" class="component-name mt-1 w-full p-2 border-gray-300 rounded-md text-sm" value="${componentData?.componentName || ''}"></div><div><label class="text-xs font-medium text-slate-500">更換週期(天)</label><input type="number" class="component-cycle mt-1 w-full p-2 border-gray-300 rounded-md text-sm" value="${componentData?.replacementCycleDays || ''}"></div><div><label class="text-xs font-medium text-slate-500">下次更換日期</label><input type="date" class="component-next-date mt-1 w-full p-2 border-gray-300 rounded-md text-sm" value="${componentData?.nextReplacementDate || ''}"></div></div><button onclick="this.closest('.component-editor-block').remove()" class="absolute top-2 right-2 text-red-500 hover:text-red-700 p-1">✕</button>`;
            container.appendChild(block);
        }

        window.saveEquipment = async function(button) {
            showButtonLoading(button, '儲存中...');
            try {
                const newId = document.getElementById('edit-device-id').value.trim(), newName = document.getElementById('edit-device-name').value.trim();
                if (!newId || !newName) { showToast('ID 和名稱不可為空', 'error'); return; }
                if (!currentlyEditingId && equipmentDatabase[newId]) { showToast('此設備ID已存在', 'error'); return; }
                const getSelectValue = (sel, inp) => sel.value === '__new__' ? inp.value.trim() : sel.value;
                const newCategory = getSelectValue(document.getElementById('edit-device-category-select'), document.getElementById('edit-device-category-new'));
                if (!newCategory) { showToast('設備區分不可為空', 'error'); return; }

                let itemsData = [], subItemIdCounter = 1;
                document.querySelectorAll('#item-editor-container .category-editor-block').forEach(catBlock => {
                    const categoryName = getSelectValue(catBlock.querySelector('.category-name-select'), catBlock.querySelector('.category-name-new-input'));
                    if (categoryName) {
                        const subItems = [];
                        catBlock.querySelectorAll('.sub-item-wrapper').forEach(wrapper => { const text = getSelectValue(wrapper.querySelector('.sub-item-select'), wrapper.querySelector('.sub-item-new-input')); if (text) subItems.push({ id: subItemIdCounter++, text }); });
                        itemsData.push({ category: categoryName, subItems: subItems });
                    }
                });

                let componentsData = [];
                document.querySelectorAll('#component-editor-container .component-editor-block').forEach(b => { const name = b.querySelector('.component-name').value.trim(); if(name) componentsData.push({ componentName: name, replacementCycleDays: parseInt(b.querySelector('.component-cycle').value, 10) || 0, nextReplacementDate: b.querySelector('.component-next-date').value }); });

                let finalUsers = document.querySelector('#user-assignment-container input[value="all"]').checked ? 'all' : [...document.querySelectorAll('#user-assignment-container input:checked')].map(cb => cb.value).filter(v => v !== 'all');
                const eqData = { 
                    name: newName, category: newCategory, 
                    location: getSelectValue(document.getElementById('edit-device-location-select'), document.getElementById('edit-device-location-new')), 
                    status: document.querySelector('input[name="status"]:checked')?.value || '未使用',
                    assetNumber: document.querySelector('input[name="hasAssetNumber"][value="yes"]').checked ? document.getElementById('edit-asset-number').value.trim() || null : null, 
                    unusedReason: document.querySelector('input[name="status"]:checked')?.value === '未使用' ? document.getElementById('edit-device-unused-reason').value.trim() : '',
                    items: itemsData, components: componentsData, authorizedUsers: finalUsers, 
                    nextCheckDate: document.getElementById('edit-next-check-date').value, checkCycleDays: parseInt(document.getElementById('edit-check-cycle').value, 10) || 0,
                    nextCleaningDate: document.getElementById('edit-next-cleaning-date').value, cleaningCycleDays: parseInt(document.getElementById('edit-cleaning-cycle').value, 10) || 0
                };
                
                const imagePreview = document.getElementById('image-preview');
                if (imagePreview.dataset.imageDataUrl) {
                    eqData.imageUrl = imagePreview.dataset.imageDataUrl;
                } else if (currentlyEditingId && equipmentDatabase[currentlyEditingId].imageUrl) {
                    eqData.imageUrl = equipmentDatabase[currentlyEditingId].imageUrl;
                }

                if (currentlyEditingId && currentlyEditingId !== newId) { const batch = writeBatch(db); batch.set(doc(db, "equipment", newId), eqData); batch.delete(doc(db, "equipment", currentlyEditingId)); await batch.commit(); } 
                else { await setDoc(doc(db, "equipment", newId), eqData, { merge: true }); }
                showToast('設備資料儲存成功', 'success'); showList();
            } catch (e) { 
                console.error("Error saving document: ", e); 
                showToast('儲存失敗', 'error'); 
            } finally {
                hideButtonLoading(button);
            }
        }

        window.deleteEquipment = function(id) { showConfirm(`確定要刪除設備 [${equipmentDatabase[id].name}] 嗎？此操作無法復原。`, async () => { try { await deleteDoc(doc(db, "equipment", id)); showToast('刪除成功', 'success'); } catch (e) { console.error("Error deleting document: ", e); showToast('刪除失敗', 'error'); } }, true); }
        
        window.showQRCodeModal = function(equipmentId, equipmentName) {
            currentQRCodeInfo = { id: equipmentId, name: equipmentName };
            
            const checklistContainer = document.getElementById('qr-code-container-checklist');
            const maintenanceContainer = document.getElementById('qr-code-container-maintenance');
            checklistContainer.innerHTML = '';
            maintenanceContainer.innerHTML = '';
            
            const APP_BASE_URL = 'https://saniltw.github.io/welddata/5.1.html';

            const checklistData = `${APP_BASE_URL}?action=start_checklist&id=${equipmentId}`;
            const maintenanceData = `${APP_BASE_URL}?action=start_maintenance&id=${equipmentId}`;

            new QRCode(checklistContainer, { text: checklistData, width: 128, height: 128 });
            new QRCode(maintenanceContainer, { text: maintenanceData, width: 128, height: 128 });

            document.getElementById('qr-code-modal-title').textContent = `設備 QR Code: ${equipmentName}`;
            document.getElementById('qr-code-device-name').textContent = equipmentName;
            document.getElementById('qr-code-display-modal').classList.replace('hidden', 'flex');
        }

        window.closeQRCodeModal = function() { document.getElementById('qr-code-display-modal').classList.replace('flex', 'hidden'); }
        window.downloadQRCodeImage = function() { if (!currentQRCodeInfo.id) return; html2canvas(document.getElementById('qr-code-printable-area'), { scale: 3 }).then(canvas => { const link = document.createElement('a'); link.download = `QRCode_${currentQRCodeInfo.id}_${currentQRCodeInfo.name}.png`; link.href = canvas.toDataURL("image/png"); link.click(); showToast('QR Code 已開始下載', 'success'); }).catch(err => showToast('QR Code 下載失敗', 'error')); }

        window.renderEquipmentList = function() {
            const tabContainer = document.getElementById('equipment-category-tabs'), listContainer = document.getElementById('equipment-list-container');
            tabContainer.innerHTML = ''; listContainer.innerHTML = '';
            if (Object.keys(equipmentDatabase).length === 0) { listContainer.innerHTML = `<div class="card text-center py-12"><p class="text-slate-500">尚未建立任何設備</p></div>`; return; }

            const groupedByCategory = Object.values(equipmentDatabase).reduce((acc, eq) => { (acc[eq.category || '未分類'] = acc[eq.category || '未分類'] || []).push(eq); return acc; }, {});
            const sortedCategories = Object.keys(groupedByCategory).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            const nav = document.createElement('nav'); nav.className = 'flex -mb-px space-x-6 overflow-x-auto';

            sortedCategories.forEach((category, index) => {
                const safeCategoryName = category.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '-');
                const tabButton = document.createElement('button');
                tabButton.textContent = category; tabButton.id = `tab-btn-${safeCategoryName}`;
                tabButton.className = 'px-1 py-3 font-semibold text-sm border-b-2 whitespace-nowrap';
                tabButton.setAttribute('onclick', `switchEquipmentCategoryTab('${safeCategoryName}')`);
                if (index === 0) tabButton.classList.add('admin-tab-active'); else tabButton.classList.add('border-transparent', 'text-gray-500');
                nav.appendChild(tabButton);

                const contentPanel = document.createElement('div'); contentPanel.id = `content-panel-${safeCategoryName}`;
                contentPanel.className = 'equipment-list-panel space-y-3 mt-4'; if (index !== 0) contentPanel.classList.add('hidden');
                
                const sortedEq = groupedByCategory[category].sort((a, b) => (a.name).localeCompare(b.name, 'zh-Hant'));
                sortedEq.forEach(eq => {
                    let statusColor = eq.status === '使用中' ? 'bg-green-500' : (eq.status === '維修中' ? 'bg-yellow-500' : 'bg-slate-400');
                    let maintenanceInfo = `<p class="text-xs text-gray-400 mt-1">下次清潔: ${eq.nextCleaningDate || '未設定'}</p>`;
                    const overdueComponents = eq.components?.filter(c => c.nextReplacementDate && c.nextReplacementDate < MOCK_TODAY.toISOString().slice(0, 10)).length || 0;
                    if (overdueComponents > 0) maintenanceInfo += `<p class="text-xs text-red-500 font-bold mt-1">⚠️ ${overdueComponents} 個零件更換逾期</p>`;
                    
                    contentPanel.insertAdjacentHTML('beforeend', `<div class="card p-4 flex items-center justify-between gap-4"><div class="flex items-center gap-4 flex-grow"><img src="${eq.imageUrl || 'https://placehold.co/64x64/e2e8f0/94a3b8?text=無圖片'}" class="w-16 h-16 object-cover rounded-md flex-shrink-0"><div class="flex-grow"><p class="font-bold text-slate-800 flex items-center"><span class="status-dot ${statusColor}"></span>${eq.name}</p><p class="text-sm text-slate-500">ID: ${eq.id} | 地點: ${eq.location || '未設定'}</p><p class="text-xs text-gray-400 mt-1">下次點檢: ${eq.nextCheckDate || '未設定'}</p>${maintenanceInfo}</div></div><div class="space-x-2 flex-shrink-0"><button onclick="showQRCodeModal('${eq.id}', '${eq.name}')" class="bg-green-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-green-600">QR Code</button><button onclick="showMaintenanceModal('${eq.id}')" class="bg-orange-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-orange-600">保養</button><button onclick="showEditor('${eq.id}')" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-blue-600">編輯</button><button onclick="deleteEquipment('${eq.id}')" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-red-600">刪除</button></div></div>`);
                });
                listContainer.appendChild(contentPanel);
            });
            tabContainer.appendChild(nav);
        }

        window.switchEquipmentCategoryTab = function(safeCategoryName) {
            document.querySelectorAll('#equipment-category-tabs button').forEach(b => {b.classList.remove('admin-tab-active'); b.classList.add('border-transparent', 'text-gray-500');});
            document.getElementById(`tab-btn-${safeCategoryName}`).classList.add('admin-tab-active');
            document.getElementById(`tab-btn-${safeCategoryName}`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelectorAll('.equipment-list-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(`content-panel-${safeCategoryName}`).classList.remove('hidden');
        }

        // --- 管理者: 人員管理 ---
        window.showUserList = function() { document.getElementById('user-list-container').classList.remove('hidden'); document.getElementById('user-editor-section').classList.add('hidden'); document.querySelector('#admin-tab-content-users button').classList.remove('hidden'); }
        window.showUserEditor = function(id = null) {
            document.getElementById('user-list-container').classList.add('hidden'); document.getElementById('user-editor-section').classList.remove('hidden'); document.querySelector('#admin-tab-content-users button').classList.add('hidden');
            currentlyEditingUserId = id;
            const editor = document.getElementById('user-editor-section'), roleSel = editor.querySelector('#edit-user-role'), passWrap = editor.querySelector('#password-field-wrapper');
            roleSel.onchange = () => passWrap.classList.toggle('hidden', roleSel.value !== 'manager');
            if (id) {
                const user = userDatabase[id]; editor.querySelector('#user-editor-title').textContent = '編輯人員'; 
                editor.querySelector('#edit-user-id').value = id; editor.querySelector('#edit-user-id').disabled = true; 
                editor.querySelector('#edit-user-name').value = user.name; editor.querySelector('#edit-user-email').value = user.email || ''; 
                roleSel.value = user.role;
                if (user.role === 'manager') { passWrap.classList.remove('hidden'); editor.querySelector('#edit-user-password').value = user.password || ''; } 
                else { passWrap.classList.add('hidden'); editor.querySelector('#edit-user-password').value = ''; }
            } else {
                editor.querySelector('#user-editor-title').textContent = '新增人員'; 
                ['edit-user-id', 'edit-user-name', 'edit-user-email', 'edit-user-password'].forEach(elId => editor.querySelector(`#${elId}`).value = '');
                editor.querySelector('#edit-user-id').disabled = false; roleSel.value = 'operator'; passWrap.classList.add('hidden');
            }
        }
        
        window.saveUser = async function(button) {
            showButtonLoading(button, '儲存中...');
            try {
                const newId = document.getElementById('edit-user-id').value.trim(), newName = document.getElementById('edit-user-name').value.trim(), email = document.getElementById('edit-user-email').value.trim();
                if (!newId || !newName) { showToast('ID和姓名不可為空', 'error'); return; }
                if (!currentlyEditingUserId && userDatabase[newId]) { showToast('此員工ID已存在', 'error'); return; }
                const role = document.getElementById('edit-user-role').value, password = document.getElementById('edit-user-password').value;
                if (role === 'manager' && !password) { showToast('主管角色必須設定密碼', 'error'); return; }
                const userData = { name: newName, role, email }; if (role === 'manager') userData.password = password;
                
                if (currentlyEditingUserId && currentlyEditingUserId !== newId) { const batch = writeBatch(db); batch.set(doc(db, "users", newId), userData); batch.delete(doc(db, "users", currentlyEditingUserId)); await batch.commit(); } 
                else { await setDoc(doc(db, "users", newId), userData); }
                showToast('人員資料儲存成功', 'success'); showUserList();
            } catch (e) { 
                console.error("Error saving user: ", e); 
                showToast('儲存失敗', 'error'); 
            } finally {
                hideButtonLoading(button);
            }
        }

        window.deleteUser = function(id) { showConfirm(`確定要刪除人員 [${userDatabase[id].name}] 嗎？`, async () => { try { await deleteDoc(doc(db, "users", id)); showToast('刪除成功', 'success'); } catch(e) { showToast('刪除失敗', 'error'); } }, true); }
        window.renderUserList = function() { 
            const c = document.getElementById('user-list-container'); c.innerHTML = ''; 
            if (Object.keys(userDatabase).length === 0) { c.innerHTML = `<div class="card text-center py-12"><p class="text-slate-500">尚未建立任何使用者</p></div>`; return; }
            const sortedUsers = Object.entries(userDatabase).sort(([,a],[,b]) => a.name.localeCompare(b.name, 'zh-Hant'));
            for (const [id, u] of sortedUsers) { c.insertAdjacentHTML('beforeend', `<div class="card p-4 flex justify-between items-center"><div><p class="font-bold text-slate-800">${u.name}</p><p class="text-sm text-slate-500">ID: ${id} (${u.role})</p><p class="text-xs text-gray-400 mt-1">${u.email || '無Email'}</p></div><div class="space-x-2"><button onclick="showUserEditor('${id}')" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-blue-600">編輯</button><button onclick="deleteUser('${id}')" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-red-600">刪除</button></div></div>`); } 
        }

        // --- 報表功能 ---
        function populateCategoryDeviceFilters(categorySelectId, deviceSelectId) {
            const catSel = document.getElementById(categorySelectId), devSel = document.getElementById(deviceSelectId);
            const categories = [...new Set(Object.values(equipmentDatabase).map(eq => eq.category || '未分類'))].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
            catSel.innerHTML = '<option value="all">所有區分</option>'; categories.forEach(cat => catSel.add(new Option(cat, cat)));
            catSel.onchange = () => {
                devSel.innerHTML = '<option value="all">所有設備</option>';
                const filtered = Object.values(equipmentDatabase).filter(eq => catSel.value === 'all' || (eq.category || '未分類') === catSel.value).sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
                filtered.forEach(eq => devSel.add(new Option(eq.name, eq.id)));
            }; catSel.dispatchEvent(new Event('change'));
        }

        function populateReportFilters() { 
            populateCategoryDeviceFilters('report-category-filter', 'report-device-filter'); 
            populateCategoryDeviceFilters('report-maint-category-filter', 'report-maint-device-filter');
            
            // For equipment filters
            const catSel = document.getElementById('report-equip-category-filter');
            const locSel = document.getElementById('report-equip-location-filter');
            
            const categories = [...new Set(Object.values(equipmentDatabase).map(eq => eq.category || '未分類'))].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
            catSel.innerHTML = '<option value="all">所有區分</option>'; 
            categories.forEach(cat => catSel.add(new Option(cat, cat)));

            const locations = [...new Set(Object.values(equipmentDatabase).map(eq => eq.location || '未設定'))].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
            locSel.innerHTML = '<option value="all">所有地點</option>';
            locations.forEach(loc => locSel.add(new Option(loc, loc)));
        }
        window.toggleReportFilters = function() {
            const reportType = document.getElementById('report-type-select').value;
            const isChecklist = reportType === 'checklist';
            const isMaintenance = reportType === 'maintenance';
            const isEquipment = reportType === 'equipment';

            document.getElementById('checklist-filters').classList.toggle('hidden', !isChecklist);
            document.getElementById('maintenance-filters').classList.toggle('hidden', !isMaintenance);
            document.getElementById('equipment-filters').classList.toggle('hidden', !isEquipment);

            document.getElementById('export-weekly-pdf-btn').classList.toggle('hidden', !isChecklist);
            
            if (isChecklist) {
                document.getElementById('export-csv-btn').onclick = exportChecklistToCSV;
                document.getElementById('export-pdf-btn').onclick = exportChecklistToPDF;
            } else if (isMaintenance) {
                document.getElementById('export-csv-btn').onclick = exportMaintenanceToCSV;
                document.getElementById('export-pdf-btn').onclick = exportMaintenanceToPDF;
            } else if (isEquipment) {
                document.getElementById('export-csv-btn').onclick = exportEquipmentToCSV;
                document.getElementById('export-pdf-btn').onclick = exportEquipmentToPDF;
            }

            document.getElementById('report-results-container').innerHTML = '<p class="text-slate-500 text-center">請設定篩選條件並產生報表。</p>';
            ['export-csv-btn', 'export-pdf-btn', 'export-weekly-pdf-btn'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) btn.disabled = true;
            });
        }

        window.generateSelectedReport = function() { 
            const reportType = document.getElementById('report-type-select').value;
            if (reportType === 'checklist') generateChecklistReport(); 
            else if (reportType === 'equipment') generateEquipmentReport();
            else generateMaintenanceReport(); 
        }

        function findOverdueTasks(endDateStr, categoryFilter, deviceFilter) {
            const overdue = []; if (!endDateStr) return overdue;
            Object.values(equipmentDatabase).filter(eq => (categoryFilter === 'all' || (eq.category || '未分類') === categoryFilter) && (deviceFilter === 'all' || eq.id === deviceFilter) && eq.status === '使用中').forEach(eq => {
                if (eq.nextCheckDate && eq.nextCheckDate < endDateStr) overdue.push({ type: '點檢', deviceName: eq.name, dueDate: eq.nextCheckDate, details: '' });
                if (eq.nextCleaningDate && eq.nextCleaningDate < endDateStr) overdue.push({ type: '清潔', deviceName: eq.name, dueDate: eq.nextCleaningDate, details: '' });
                eq.components?.forEach(comp => { if (comp.nextReplacementDate && comp.nextReplacementDate < endDateStr) overdue.push({ type: '零件更換', deviceName: eq.name, dueDate: comp.nextReplacementDate, details: comp.componentName }); });
            });
            return overdue.sort((a,b) => a.dueDate.localeCompare(b.dueDate));
        }

        function renderOverdueTasks(tasks) {
            if (tasks.length === 0) return '';
            let html = `<div class="mt-8 pt-6 border-t"><h3 class="text-xl font-semibold text-red-600 mb-4">未依排程完成項目清單</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-red-50"><tr><th class="px-4 py-3">類型</th><th class="px-4 py-3">設備</th><th class="px-4 py-3">應完成日</th><th class="px-4 py-3">細節</th></tr></thead><tbody>`;
            tasks.forEach(task => { html += `<tr class="border-b bg-red-50"><td class="px-4 py-2 font-medium">${task.type}</td><td class="px-4 py-2">${task.deviceName}</td><td class="px-4 py-2 text-red-700 font-bold">${task.dueDate}</td><td class="px-4 py-2">${task.details}</td></tr>`; });
            return html + `</tbody></table></div></div>`;
        }

        window.generateEquipmentReport = function() {
            const category = document.getElementById('report-equip-category-filter').value;
            const location = document.getElementById('report-equip-location-filter').value;
            const status = document.getElementById('report-equip-status-filter').value;

            equipmentReportData = Object.values(equipmentDatabase).filter(eq => {
                const categoryMatch = category === 'all' || (eq.category || '未分類') === category;
                const locationMatch = location === 'all' || (eq.location || '未設定') === location;
                const statusMatch = status === 'all' || eq.status === status;
                return categoryMatch && locationMatch && statusMatch;
            });

            const container = document.getElementById('report-results-container');
            if (equipmentReportData.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center">找不到符合條件的設備。</p>';
                ['export-csv-btn', 'export-pdf-btn'].forEach(id => document.getElementById(id).disabled = true);
            } else {
                let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-slate-50"><tr><th class="p-2"><input type="checkbox" onchange="toggleAllReportCheckboxes(this.checked)"></th><th>區分</th><th>ID</th><th>名稱</th><th>地點</th><th>資產編號</th><th>現況</th><th>下次點檢日</th><th>下次清潔日</th></tr></thead><tbody>`;
                equipmentReportData.forEach(eq => {
                    tableHTML += `<tr class="border-b" data-record-id="${eq.id}">
                        <td class="p-2"><input type="checkbox" class="report-checkbox" onchange="updateExportButtons()"></td>
                        <td>${eq.category || ''}</td>
                        <td>${eq.id}</td>
                        <td>${eq.name}</td>
                        <td>${eq.location || ''}</td>
                        <td>${eq.assetNumber || ''}</td>
                        <td>${eq.status || ''}</td>
                        <td>${eq.nextCheckDate || ''}</td>
                        <td>${eq.nextCleaningDate || ''}</td>
                    </tr>`;
                });
                container.innerHTML = tableHTML + '</tbody></table></div>';
                updateExportButtons();
            }
        }

        window.generateChecklistReport = function() {
            const start = document.getElementById('report-start-date').value, end = document.getElementById('report-end-date').value;
            if (!start || !end) { showToast('請選擇開始與結束日期', 'error'); return; }
            const category = document.getElementById('report-category-filter').value, deviceId = document.getElementById('report-device-filter').value, assetFilter = document.getElementById('report-asset-filter').value;
            const startDate = new Date(start), endDate = new Date(end); endDate.setHours(23, 59, 59, 999);

            reportData = checkHistory.filter(r => {
                const recordDate = r.checkTimestamp?.toDate(); if (!recordDate) return false;
                const device = equipmentDatabase[r.deviceId]; if (!device) return false;
                let assetMatch = assetFilter === 'all' || (assetFilter === 'yes' ? !!device.assetNumber : !device.assetNumber);
                return recordDate >= startDate && recordDate <= endDate && (deviceId === 'all' || r.deviceId === deviceId) && (category === 'all' || (device.category || '未分類') === category) && assetMatch;
            });

            const container = document.getElementById('report-results-container');
            let finalHtml = '';
            if (reportData.length === 0) {
                finalHtml += '<p class="text-slate-500 text-center">在此期間內找不到任何點檢紀錄。</p>';
                ['export-csv-btn', 'export-pdf-btn', 'export-weekly-pdf-btn'].forEach(id => document.getElementById(id).disabled = true);
            } else {
                let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-slate-50"><tr><th class="p-2"><input type="checkbox" onchange="toggleAllReportCheckboxes(this.checked)"></th><th>日期</th><th>設備</th><th>人員</th><th>摘要</th>`;
                if (loggedInUser.role === 'manager') tableHTML += `<th>操作</th>`;
                tableHTML += `</tr></thead><tbody>`;
                reportData.forEach(r => {
                    const abnormalCount = r.items.filter(i => i.status === '異常').length;
                    tableHTML += `<tr class="border-b" data-record-id="${r.id}"><td class="p-2"><input type="checkbox" class="report-checkbox" onchange="updateExportButtons()"></td><td>${r.checkTimestamp.toDate().toLocaleString()}</td><td>${r.deviceName}</td><td>${r.userName}</td><td>${abnormalCount > 0 ? `<span class="text-red-500 font-bold">${abnormalCount} 項異常</span>` : '<span class="text-green-600">全部正常</span>'}</td>`;
                    if (loggedInUser.role === 'manager') tableHTML += `<td><button onclick="showHistoryEditor('${r.id}')" class="text-blue-600 hover:underline text-xs">編輯</button><button onclick="deleteHistoryRecord('${r.id}')" class="text-red-600 hover:underline text-xs ml-2">刪除</button></td>`;
                    tableHTML += `</tr>`;
                });
                finalHtml += tableHTML + `</tbody></table></div>`;
                updateExportButtons();
            }
            finalHtml += renderOverdueTasks(findOverdueTasks(end.toISOString().slice(0,10), category, deviceId));
            container.innerHTML = finalHtml;
        }

        function renderChecklistHistory() {
            const container = document.getElementById('checklist-history-log-container'); container.innerHTML = '';
            if (checkHistory.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center py-8">尚未有任何點檢記錄。</p>`; return; }
            const sortedHistory = [...checkHistory].sort((a,b) => b.checkTimestamp.toDate() - a.checkTimestamp.toDate());
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-slate-50"><tr><th>日期</th><th>設備</th><th>人員</th><th>摘要</th>`;
            if (loggedInUser.role === 'manager') tableHTML += `<th>操作</th>`;
            tableHTML += `</tr></thead><tbody>`;
            sortedHistory.forEach(r => {
                const abnormalCount = r.items.filter(i => i.status === '異常').length;
                tableHTML += `<tr class="border-b"><td class="px-4 py-2">${r.checkTimestamp.toDate().toLocaleString()}</td><td class="px-4 py-2">${r.deviceName}</td><td class="px-4 py-2">${r.userName}</td><td class="px-4 py-2">${abnormalCount > 0 ? `<span class="text-red-500 font-bold">${abnormalCount} 項異常</span>` : '<span class="text-green-600">全部正常</span>'}</td>`;
                if (loggedInUser.role === 'manager') tableHTML += `<td class="px-4 py-2"><button onclick="showHistoryEditor('${r.id}')" class="text-blue-600">編輯</button><button onclick="deleteHistoryRecord('${r.id}')" class="text-red-600 ml-2">刪除</button></td>`;
                tableHTML += `</tr>`;
            });
            container.innerHTML = tableHTML + `</tbody></table></div>`;
        }

        window.generateMaintenanceReport = function() {
            const start = document.getElementById('report-maint-start-date').value, end = document.getElementById('report-maint-end-date').value;
            if (!start || !end) { showToast('請選擇開始與結束日期', 'error'); return; }
            const category = document.getElementById('report-maint-category-filter').value, deviceId = document.getElementById('report-maint-device-filter').value, maintType = document.getElementById('report-maint-type-filter').value;
            const startDate = new Date(start), endDate = new Date(end); endDate.setHours(23, 59, 59, 999);

            maintenanceReportData = maintenanceHistory.filter(r => {
                const recordDate = r.timestamp?.toDate(); if (!recordDate) return false;
                const device = equipmentDatabase[r.deviceId]; if (!device) return false;
                return recordDate >= startDate && recordDate <= endDate && (deviceId === 'all' || r.deviceId === deviceId) && (category === 'all' || (device.category || '未分類') === category) && (maintType === 'all' || r.type === maintType);
            });
            
            const container = document.getElementById('report-results-container'); let finalHtml = '';
            if (maintenanceReportData.length === 0) {
                finalHtml += '<p class="text-slate-500 text-center">在此期間內找不到任何保養紀錄。</p>';
                ['export-csv-btn', 'export-pdf-btn'].forEach(id => document.getElementById(id).disabled = true);
            } else {
                let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="text-xs text-gray-700 uppercase bg-slate-50"><tr><th class="p-2"><input type="checkbox" onchange="toggleAllReportCheckboxes(this.checked)"></th><th>日期</th><th>設備</th><th>類型</th><th>細節</th><th>人員</th><th>備註</th><th>照片</th>`;
                if (loggedInUser.role === 'manager') tableHTML += `<th>操作</th>`;
                tableHTML += `</tr></thead><tbody>`;
                maintenanceReportData.forEach(log => {
                    tableHTML += `<tr class="border-b" data-record-id="${log.id}"><td class="p-2"><input type="checkbox" class="report-checkbox" onchange="updateExportButtons()"></td><td>${log.timestamp.toDate().toLocaleString()}</td><td>${log.deviceName}</td><td>${log.type === 'cleaning' ? '機台清潔' : '零件更換'}</td><td>${log.componentName || '—'}</td><td>${log.userName}</td><td>${log.notes || ''}</td><td>${log.imageUrl ? `<img src="${log.imageUrl}" class="w-12 h-12 object-cover rounded cursor-pointer" onclick="showImageModal('${log.imageUrl}')">` : '—'}</td>`;
                    if (loggedInUser.role === 'manager') tableHTML += `<td><button onclick="showMaintenanceEditor('${log.id}')" class="text-blue-600">編輯</button><button onclick="deleteMaintenanceRecord('${log.id}')" class="text-red-600 ml-2">刪除</button></td>`;
                    tableHTML += `</tr>`;
                });
                finalHtml += tableHTML + `</tbody></table></div>`;
                updateExportButtons();
            }
            finalHtml += renderOverdueTasks(findOverdueTasks(endDate.toISOString().slice(0,10), category, deviceId));
            container.innerHTML = finalHtml;
        }

        window.toggleAllReportCheckboxes = function(checked) { document.querySelectorAll('#report-results-container .report-checkbox').forEach(cb => cb.checked = checked); updateExportButtons(); }
        window.updateExportButtons = function() {
            const disabled = document.querySelectorAll('#report-results-container .report-checkbox:checked').length === 0;
            document.getElementById('export-csv-btn').disabled = disabled; document.getElementById('export-pdf-btn').disabled = disabled;
            if (document.getElementById('report-type-select').value === 'checklist') document.getElementById('export-weekly-pdf-btn').disabled = disabled;
        }

        function getSelectedChecklistReportData() { const selectedIds = [...document.querySelectorAll('#report-results-container .report-checkbox:checked')].map(cb => cb.closest('tr').dataset.recordId); return reportData.filter(r => selectedIds.includes(r.id)); }
        function getSelectedMaintenanceReportData() { const selectedIds = [...document.querySelectorAll('#report-results-container .report-checkbox:checked')].map(cb => cb.closest('tr').dataset.recordId); return maintenanceReportData.filter(r => selectedIds.includes(r.id)); }
        function getSelectedEquipmentReportData() {
            const selectedIds = [...document.querySelectorAll('#report-results-container .report-checkbox:checked')].map(cb => cb.closest('tr').dataset.recordId);
            return equipmentReportData.filter(eq => selectedIds.includes(eq.id));
        }

        function appendOverdueTasksToCSV(csvContent) {
            const overdueTasksContainer = document.getElementById('report-results-container').querySelector('.mt-8');
            if (!overdueTasksContainer) return csvContent;
            const tasks = [];
            overdueTasksContainer.querySelectorAll('tbody tr').forEach(row => { const cells = row.querySelectorAll('td'); tasks.push({ type: `"${cells[0].textContent}"`, deviceName: `"${cells[1].textContent}"`, dueDate: `"${cells[2].textContent}"`, details: `"${cells[3].textContent}"` }); });
            if (tasks.length > 0) {
                csvContent += "\r\n\r\n未依排程完成項目清單\r\n";
                csvContent += ["類型", "設備名稱", "應完成日期", "細節"].join(",") + "\r\n";
                tasks.forEach(task => { csvContent += [task.type, task.deviceName, task.dueDate, task.details].join(",") + "\r\n"; });
            }
            return csvContent;
        }

        window.exportChecklistToCSV = function() {
            const selectedData = getSelectedChecklistReportData(); if (selectedData.length === 0) return;
            let csv = "data:text/csv;charset=utf-8,\uFEFF" + ["點檢日期", "設備區分", "設備名稱", "人員", "總結備註","分類", "項目", "狀態", "異常說明"].join(",") + "\r\n";
            selectedData.forEach(r => {
                const device = equipmentDatabase[r.deviceId] || {};
                const common = [r.checkTimestamp.toDate().toLocaleString(), `"${device.category || 'N/A'}"`, `"${r.deviceName}"`, `"${r.userName}"`, `"${r.summaryNotes.replace(/"/g, '""')}"`];
                if (r.items?.length > 0) r.items.forEach(item => { csv += [...common, `"${item.category}"`, `"${item.text}"`, `"${item.status}"`, `"${item.details ? item.details.replace(/"/g, '""') : ''}"`].join(",") + "\r\n"; });
                else csv += [...common, "", "", "", ""].join(",") + "\r\n";
            });
            const encodedUri = encodeURI(appendOverdueTasksToCSV(csv));
            const link = document.createElement("a"); link.href = encodedUri; link.download = `點檢報表_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        window.exportMaintenanceToCSV = function() {
            const selectedData = getSelectedMaintenanceReportData(); if (selectedData.length === 0) return;
            let csv = "data:text/csv;charset=utf-8,\uFEFF" + ["保養日期", "設備區分", "設備名稱", "類型", "零件", "人員", "備註"].join(",") + "\r\n";
            selectedData.forEach(r => { const device = equipmentDatabase[r.deviceId] || {}; csv += [r.timestamp.toDate().toLocaleString(), `"${device.category || 'N/A'}"`, `"${r.deviceName}"`, r.type === 'cleaning' ? "機台清潔" : "零件更換", `"${r.componentName || ''}"`, `"${r.userName}"`, `"${r.notes ? r.notes.replace(/"/g, '""') : ''}"`].join(",") + "\r\n"; });
            const encodedUri = encodeURI(appendOverdueTasksToCSV(csv));
            const link = document.createElement("a"); link.href = encodedUri; link.download = `保養報表_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        window.exportEquipmentToCSV = function() {
            const selectedData = getSelectedEquipmentReportData();
            if (selectedData.length === 0) return;
            let csv = "data:text/csv;charset=utf-8,\uFEFF" + ["設備區分", "設備ID", "設備名稱", "放置地點", "資產編號", "現況", "下次點檢日", "下次清潔日"].join(",") + "\r\n";
            selectedData.forEach(eq => {
                csv += [
                    `"${eq.category || ''}"`,
                    `"${eq.id}"`,
                    `"${eq.name}"`,
                    `"${eq.location || ''}"`,
                    `"${eq.assetNumber || ''}"`,
                    `"${eq.status || ''}"`,
                    `"${eq.nextCheckDate || ''}"`,
                    `"${eq.nextCleaningDate || ''}"`
                ].join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csv);
            const link = document.createElement("a");
            link.href = encodedUri;
            link.download = `設備資訊總覽_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportToPDF(reportName) {
            const btn = document.getElementById('export-pdf-btn'); const originalText = btn.textContent; btn.textContent = '產生中...'; btn.disabled = true;
            const reportEl = document.getElementById('report-results-container');
            const checkboxes = reportEl.querySelectorAll('th:first-child, td:first-child'); checkboxes.forEach(el => el.style.display = 'none');
            const editButtons = reportEl.querySelectorAll('th:last-child, td:last-child'); if(loggedInUser.role === 'manager') editButtons.forEach(el => el.style.display = 'none');
            
            try {
                const canvas = await html2canvas(reportEl, { scale: 2 });
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                const doc = new jsPDF({ orientation: 'l', unit: 'px', format: 'a4' });
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                doc.addImage(imgData, 'JPEG', 15, 15, pdfWidth-30, pdfHeight > 0 ? pdfHeight : 0);
                doc.save(`${reportName}_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (err) { showToast("產生 PDF 失敗", "error"); } 
            finally { 
                checkboxes.forEach(el => el.style.display = ''); 
                if(loggedInUser.role === 'manager') editButtons.forEach(el => el.style.display = '');
                btn.textContent = originalText; btn.disabled = document.querySelectorAll('#report-results-container .report-checkbox:checked').length === 0; 
            }
        }
 
        window.exportChecklistToPDF = function() { if (getSelectedChecklistReportData().length > 0) exportToPDF('點檢報告'); }
        window.exportMaintenanceToPDF = function() { if (getSelectedMaintenanceReportData().length > 0) exportToPDF('保養報告'); }
        window.exportEquipmentToPDF = function() { if (getSelectedEquipmentReportData().length > 0) exportToPDF('設備資訊總覽'); }
         
        async function exportWeeklyPDF() {
             const selectedData = getSelectedChecklistReportData(); if (selectedData.length === 0) { showToast("請先勾選要匯出的紀錄", "error"); return; }
            const btn = document.getElementById('export-weekly-pdf-btn'); const originalText = btn.textContent; btn.textContent = '產生中...'; btn.disabled = true;
            const doc = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
            const groupedData = selectedData.reduce((acc, r) => { (acc[r.deviceId] = acc[r.deviceId] || []).push(r); return acc; }, {});

            let isFirstPage = true;
            for (const deviceId in groupedData) {
                populatePrintableReport(groupedData[deviceId], deviceId);
                const reportEl = document.getElementById('printable-report-container').querySelector('.printable-report-page');
                const canvas = await html2canvas(reportEl, { scale: 2 });
                if (!isFirstPage) doc.addPage();
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                isFirstPage = false;
            }
            doc.save(`週點檢總覽_${new Date().toISOString().slice(0,10)}.pdf`);
            btn.textContent = originalText; btn.disabled = false;
        }
        window.exportWeeklyPDF = exportWeeklyPDF;

        function populatePrintableReport(data, deviceId) {
            const container = document.getElementById('printable-report-container');
            const device = equipmentDatabase[deviceId];
            const startDate = new Date(document.getElementById('report-start-date').value);
            const year = startDate.getFullYear(), month = startDate.getMonth() + 1;
            const firstDayOfMonth = new Date(year, month - 1, 1);
            
            const allItems = new Map();
            const weeklySummary = Array(5).fill(null).map(() => ({ dates: new Set(), inspectors: new Set() }));

            data.forEach(record => {
                const checkDate = record.checkTimestamp.toDate();
                const weekIndex = Math.floor((checkDate.getDate() - 1 + firstDayOfMonth.getDay()) / 7);
                if (weekIndex >= 0 && weekIndex < 5) {
                    weeklySummary[weekIndex].dates.add(`${checkDate.getMonth() + 1}/${checkDate.getDate()}`);
                    weeklySummary[weekIndex].inspectors.add(record.userName);
                }
                record.items?.forEach(item => {
                    const key = `${item.category}-${item.text}`;
                    if (!allItems.has(key)) allItems.set(key, { category: item.category, text: item.text, weeks: ['', '', '', '', ''] });
                    if (weekIndex >= 0 && weekIndex < 5) {
                        let statusSymbol = item.status === '正常' ? '○' : (item.status === '異常' ? '<span style="color:red; font-weight:bold;">Χ</span>' : '－');
                        allItems.get(key).weeks[weekIndex] += (allItems.get(key).weeks[weekIndex] ? `<br>${statusSymbol}` : statusSymbol);
                    }
                });
            });
            
            const weekDateHeaders = weeklySummary.map(w => [...w.dates].join('<br>'));
            const weekInspectorFooters = weeklySummary.map(w => [...w.inspectors].join('<br>'));
            let tableRows = '', currentCategory = '';
            const sortedItems = [...allItems.values()].sort((a, b) => a.category.localeCompare(b.category) || a.text.localeCompare(b.text));

            sortedItems.forEach(item => {
                if (item.category !== currentCategory) { currentCategory = item.category; tableRows += `<tr><td style="text-align: left;"><b>${currentCategory}</b></td><td colspan="7"></td></tr>`; }
                tableRows += `<tr><td style="text-align: left; padding-left: 20px;">${item.text}</td><td></td><td></td><td>${item.weeks[0]}</td><td>${item.weeks[1]}</td><td>${item.weeks[2]}</td><td>${item.weeks[3]}</td><td>${item.weeks[4]}</td></tr>`;
            });
            
            const inspectorRow = `<tr><td>檢查人員簽名</td><td colspan="2"></td><td style="height:40px;vertical-align:top;">${weekInspectorFooters[0]}</td><td style="vertical-align:top;">${weekInspectorFooters[1]}</td><td style="vertical-align:top;">${weekInspectorFooters[2]}</td><td style="vertical-align:top;">${weekInspectorFooters[3]}</td><td style="vertical-align:top;">${weekInspectorFooters[4]}</td></tr>`;
            container.innerHTML = `<div class="printable-report-page"><div><div class="report-header"><h2 style="font-size:24px;font-weight:bold;margin:0;">廣泰金屬工業(股)公司</h2><h3 style="font-size:20px;font-weight:bold;margin-top:5px;">設備點檢表(週)</h3></div><div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px;"><span>設備編號: ${device.id}</span><span>設備名稱: ${device.name}</span><span>${year}年 ${month}月</span></div><table><thead><tr><th rowspan="2">點檢項目</th><th colspan="2">週期</th><th>第一週</th><th>第二週</th><th>第三週</th><th>第四週</th><th>第五週</th></tr><tr><th>週</th><th>月</th><th>${weekDateHeaders[0] || '月 日'}</th><th>${weekDateHeaders[1] || '月 日'}</th><th>${weekDateHeaders[2] || '月 日'}</th><th>${weekDateHeaders[3] || '月 日'}</th><th>${weekDateHeaders[4] || '月 日'}</th></tr></thead><tbody>${tableRows}${inspectorRow}</tbody></table></div><div class="report-footer"><div style="text-align:left;"><p style="margin:2px 0;">附註：一、本表由機器(儀器)設備早班操作人員每週確實檢查，點檢後檢查人員須簽章。</p><p style="margin:2px 0;margin-left:28px;">二、檢查結果：正常打○，異常打Χ，不適用項目打－。</p><p style="margin:2px 0;margin-left:28px;">三、發生不正常打Χ時，除了記錄外，檢查人應向課長報告，在能力條件下，進行一級保養維護，無法處理時申請維修。</p></div><div style="margin-top:20px;display:flex;justify-content:space-between;align-items:center;font-size:14px;"><span>主管: ____________________</span><span>日期: ________年____月____日</span></div><div style="margin-top:10px;display:flex;justify-content:space-between;font-size:12px;"><span>表單編號: 0023-02-01</span><span>存放地點: 各設備使用單位</span><span>保存期限: 三年</span></div></div></div>`;
        }

        // --- UI 輔助與範本管理函式 ---
        window.createChecklistItemHtml = function(item) {
            return `
            <div class="card p-4" data-item-id="${item.id}">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <span class="font-medium text-slate-700 mb-3 sm:mb-0">${item.id}. ${item.text}</span>
                    <div class="flex-shrink-0 flex space-x-2">
                        <button onclick="setStatus(${item.id}, 'normal', this)" class="status-btn flex-1 sm:flex-initial py-2 px-4 border-2 border-slate-300 rounded-lg font-semibold text-slate-600 hover:bg-slate-100 transition-colors">正常</button>
                        <button onclick="setStatus(${item.id}, 'abnormal', this)" class="status-btn flex-1 sm:flex-initial py-2 px-4 border-2 border-slate-300 rounded-lg font-semibold text-slate-600 hover:bg-slate-100 transition-colors">異常</button>
                        <button onclick="setStatus(${item.id}, 'na', this)" class="status-btn flex-1 sm:flex-initial py-2 px-4 border-2 border-slate-300 rounded-lg font-semibold text-slate-600 hover:bg-slate-100 transition-colors">N/A</button>
                    </div>
                </div>
                <div class="abnormal-details hidden mt-3">
                    <textarea class="w-full p-2 border-gray-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500" placeholder="請說明異常狀況..." rows="2"></textarea>
                </div>
            </div>`;
        }

        window.setStatus = function(itemId, status, el) {
            const itemDiv = document.querySelector(`.card[data-item-id="${itemId}"]`);
            itemDiv.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('selected', 'selected-normal', 'selected-abnormal', 'selected-na');
            });
            el.classList.add('selected');
            el.classList.add(`selected-${status}`);
            const detailsDiv = itemDiv.querySelector('.abnormal-details');
            detailsDiv.classList.toggle('hidden', status !== 'abnormal');
            if (status === 'abnormal') {
                detailsDiv.querySelector('textarea').focus();
            }
        }

        window.showTemplateList = function() {
            document.getElementById('template-list-section').classList.remove('hidden');
            document.getElementById('template-editor-section').classList.add('hidden');
        }

        window.showTemplateEditor = function(templateId = null) {
            document.getElementById('template-list-section').classList.add('hidden');
            document.getElementById('template-editor-section').classList.remove('hidden');
            currentlyEditingTemplateId = templateId;
            const editor = document.getElementById('template-editor-section');
            const itemContainer = editor.querySelector('#template-item-editor-container');
            itemContainer.innerHTML = '';
            
            if (templateId) {
                const template = templateDatabase[templateId];
                editor.querySelector('#template-editor-title').textContent = '編輯範本';
                editor.querySelector('#edit-template-name').value = template.name;
                if (template.items) {
                    template.items.forEach(categoryData => addCategoryEditor(categoryData, 'template-item-editor-container'));
                }
            } else {
                editor.querySelector('#template-editor-title').textContent = '新增範本';
                editor.querySelector('#edit-template-name').value = '';
            }
        }

        window.saveTemplate = async function(button) {
            showButtonLoading(button, '儲存中...');
            try {
                const templateName = document.getElementById('edit-template-name').value.trim();
                if (!templateName) { showToast('範本名稱不可為空', 'error'); return; }
                let itemsData = [], subItemIdCounter = 1;
                const getSelectValue = (sel, inp) => sel.value === '__new__' ? inp.value.trim() : sel.value;
                
                document.querySelectorAll('#template-item-editor-container .category-editor-block').forEach(catBlock => {
                    const categoryName = getSelectValue(catBlock.querySelector('.category-name-select'), catBlock.querySelector('.category-name-new-input'));
                    if (categoryName) {
                        const subItems = [];
                        catBlock.querySelectorAll('.sub-item-wrapper').forEach(wrapper => {
                            const text = getSelectValue(wrapper.querySelector('.sub-item-select'), wrapper.querySelector('.sub-item-new-input'));
                            if (text) subItems.push({ id: subItemIdCounter++, text });
                        });
                        if (subItems.length > 0) itemsData.push({ category: categoryName, subItems });
                    }
                });
                const templateData = { name: templateName, items: itemsData };
                const docRef = currentlyEditingTemplateId ? doc(db, "checklist_templates", currentlyEditingTemplateId) : doc(collection(db, "checklist_templates"));
                await setDoc(docRef, templateData);
                showToast('範本儲存成功', 'success');
                showTemplateList();
            } catch (e) {
                console.error("Error saving template: ", e);
                showToast('儲存範本失敗', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        window.deleteTemplate = function(templateId) {
            showConfirm(`確定要刪除範本 [${templateDatabase[templateId].name}] 嗎？`, async () => {
                try {
                    await deleteDoc(doc(db, "checklist_templates", templateId));
                    showToast('範本刪除成功', 'success');
                } catch (e) {
                    console.error("Error deleting template: ", e);
                    showToast('刪除範本失敗', 'error');
                }
            }, true);
        }

        window.renderTemplateList = function() {
            const container = document.getElementById('template-list-container');
            container.innerHTML = '';
            if (Object.keys(templateDatabase).length === 0) {
                container.innerHTML = `<div class="card text-center py-12"><p class="text-slate-500">尚未建立任何範本</p></div>`;
                return;
            }
            const sortedTemplates = Object.values(templateDatabase).sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
            sortedTemplates.forEach(t => {
                const itemCount = t.items ? t.items.reduce((sum, cat) => sum + (cat.subItems?.length || 0), 0) : 0;
                container.insertAdjacentHTML('beforeend', `
                    <div class="card p-4 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-slate-800">${t.name}</p>
                            <p class="text-sm text-slate-500">${itemCount} 個點檢項目</p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="showTemplateEditor('${t.id}')" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-blue-600">編輯</button>
                            <button onclick="deleteTemplate('${t.id}')" class="bg-red-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-red-600">刪除</button>
                        </div>
                    </div>
                `);
            });
        }

        window.showTemplateModal = function() {
            const container = document.getElementById('template-selection-container');
            container.innerHTML = '';
            if (Object.keys(templateDatabase).length === 0) {
                container.innerHTML = `<p class="text-slate-400 text-center">沒有可用的範本</p>`;
            } else {
                const sortedTemplates = Object.values(templateDatabase).sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
                sortedTemplates.forEach(t => {
                    container.insertAdjacentHTML('beforeend', `
                        <button onclick="applyTemplate('${t.id}')" class="w-full text-left p-3 bg-slate-100 hover:bg-indigo-100 rounded-lg transition-colors">
                            ${t.name}
                        </button>
                    `);
                });
            }
            document.getElementById('template-modal').classList.replace('hidden', 'flex');
        }

        window.closeTemplateModal = function() {
            document.getElementById('template-modal').classList.replace('flex', 'hidden');
        }

        window.applyTemplate = function(templateId) {
            const template = templateDatabase[templateId];
            if (!template) { showToast('找不到指定的範本', 'error'); return; }
            const itemEditorContainer = document.getElementById('item-editor-container');
            itemEditorContainer.innerHTML = ''; // Clear existing items
            if (template.items) {
                template.items.forEach(categoryData => addCategoryEditor(categoryData));
            }
            showToast(`已成功載入 [${template.name}] 範本`, 'success');
            closeTemplateModal();
        }

        window.deleteHistoryRecord = function(recordId) {
            showConfirm('確定要刪除這筆點檢紀錄嗎？此操作無法復原。', async () => {
                try {
                    await deleteDoc(doc(db, "check_history", recordId));
                    showToast('點檢紀錄已刪除', 'success');
                    if(document.getElementById('history-editor-modal').classList.contains('flex')) closeHistoryEditor();
                } catch (e) {
                    console.error("Error deleting history record: ", e);
                    showToast('刪除紀錄失敗', 'error');
                }
            }, true);
        }

        window.showHistoryEditor = function(recordId) {
            const record = checkHistory.find(r => r.id === recordId);
            if (!record) { showToast('找不到該筆紀錄', 'error'); return; }
            const editor = document.getElementById('history-editor-content');
            editor.innerHTML = '';
            const timestamp = record.checkTimestamp.toDate();
            // Convert to local time for input
            const localTimestamp = new Date(timestamp.getTime() - timestamp.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            
            editor.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <p><strong>設備:</strong> ${record.deviceName}</p>
                    <p><strong>人員:</strong> ${record.userName}</p>
                    <p><strong>日期:</strong> <input type="datetime-local" id="edit-history-timestamp" value="${localTimestamp}" class="p-1 border rounded-md"></p>
                </div>
                <div class="mt-4"><label class="font-bold">總結備註:</label><textarea id="edit-history-summary" class="w-full p-2 border-gray-300 rounded-md mt-1" rows="2">${record.summaryNotes}</textarea></div>
                <hr class="my-4"><h3 class="font-bold mb-2">點檢項目詳情</h3>
            `;
            if (record.items && record.items.length > 0) {
                record.items.forEach(item => editor.insertAdjacentHTML('beforeend', createHistoryItemHtml(item)));
            }
            document.getElementById('save-history-btn').setAttribute('onclick', `saveHistoryChanges(this, '${recordId}')`);
            document.getElementById('history-editor-modal').classList.replace('hidden', 'flex');
        }
        
        window.closeHistoryEditor = function() { document.getElementById('history-editor-modal').classList.replace('flex', 'hidden'); }

        window.createHistoryItemHtml = function(item) {
            const isAbnormal = item.status === '異常';
            return `
            <div class="history-item-editor border p-3 rounded-md bg-slate-50" data-item-id="${item.id}">
                <p class="font-semibold">${item.category} - ${item.text}</p>
                <div class="flex items-center space-x-4 mt-2">
                    <label><input type="radio" name="status-${item.id}" value="正常" ${item.status === '正常' ? 'checked' : ''}> 正常</label>
                    <label><input type="radio" name="status-${item.id}" value="異常" ${isAbnormal ? 'checked' : ''}> 異常</label>
                    <label><input type="radio" name="status-${item.id}" value="N/A" ${item.status === 'N/A' ? 'checked' : ''}> N/A</label>
                </div>
                <textarea class="abnormal-details-editor w-full p-2 mt-2 border-gray-300 rounded-md ${isAbnormal ? '' : 'hidden'}" rows="2" placeholder="異常說明">${item.details || ''}</textarea>
            </div>`;
        }

        document.getElementById('history-editor-content').addEventListener('change', (e) => {
            if (e.target.type === 'radio' && e.target.name.startsWith('status-')) {
                const itemEditor = e.target.closest('.history-item-editor');
                const detailsTextarea = itemEditor.querySelector('.abnormal-details-editor');
                detailsTextarea.classList.toggle('hidden', e.target.value !== '異常');
            }
        });

        window.saveHistoryChanges = async function(button, recordId) {
            showButtonLoading(button, '更新中...');
            try {
                const originalRecord = checkHistory.find(r => r.id === recordId);
                const updatedItems = [];
                document.querySelectorAll('#history-editor-content .history-item-editor').forEach(editor => {
                    const itemId = parseInt(editor.dataset.itemId, 10);
                    const originalItem = originalRecord.items.find(i => i.id === itemId);
                    const status = editor.querySelector(`input[name="status-${itemId}"]:checked`).value;
                    const details = editor.querySelector('.abnormal-details-editor').value;
                    updatedItems.push({ ...originalItem, status, details });
                });
                const newTimestamp = new Date(document.getElementById('edit-history-timestamp').value);
                const updatedData = { items: updatedItems, summaryNotes: document.getElementById('edit-history-summary').value, checkTimestamp: newTimestamp };
                await updateDoc(doc(db, "check_history", recordId), updatedData);
                showToast('紀錄更新成功', 'success');
                closeHistoryEditor();
            } catch (e) {
                console.error("Error updating history: ", e);
                showToast('更新失敗', 'error');
            } finally {
                hideButtonLoading(button);
            }
        }

        window.deleteMaintenanceRecord = function(recordId) {
            showConfirm('確定要刪除這筆保養紀錄嗎？', async () => {
                try {
                    await deleteDoc(doc(db, "maintenance_history", recordId));
                    showToast('保養紀錄已刪除', 'success');
                } catch(e) { showToast('刪除紀錄失敗', 'error'); }
            }, true);
        }

        window.closeMaintenanceEditor = function() {
            const preview = document.getElementById('edit-maintenance-image-preview');
            if (preview) delete preview.dataset.imageDataUrl;
            document.getElementById('maintenance-editor-modal').classList.replace('flex', 'hidden');
        }

        window.triggerMaintenanceEditImageInput = function(useCamera) {
            const input = document.getElementById('edit-maintenance-image-input');
            if (useCamera) input.setAttribute('capture', 'environment'); else input.removeAttribute('capture');
            input.click();
        }

        window.showMaintenanceEditor = function(recordId) {
             const log = maintenanceHistory.find(l => l.id === recordId); if (!log) { showToast('找不到紀錄', 'error'); return; }
             const editor = document.getElementById('maintenance-editor-content');
             const timestamp = log.timestamp.toDate();
             const localTimestamp = new Date(timestamp.getTime() - timestamp.getTimezoneOffset() * 60000).toISOString().slice(0, 16);

             editor.innerHTML = `
                <p><strong>設備:</strong> ${log.deviceName}</p>
                <p><strong>執行人員:</strong> ${log.userName}</p>
                <div><label class="block font-medium">保養日期:</label><input type="datetime-local" id="edit-maintenance-timestamp" value="${localTimestamp}" class="p-1 border rounded-md"></div>
                <div><label class="block font-medium">備註:</label><textarea id="edit-maintenance-notes" class="w-full p-2 border-gray-300 rounded-md mt-1" rows="3">${log.notes || ''}</textarea></div>
                <div><label class="block font-medium">照片:</label>
                    <div class="mt-2 flex items-center gap-4">
                        <div class="relative w-24 h-24">
                           <img id="edit-maintenance-image-preview" src="${log.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=無圖片'}" class="w-24 h-24 object-cover rounded-md border">
                        </div>
                        <input type="file" id="edit-maintenance-image-input" accept="image/*" class="hidden">
                         <button type="button" onclick="triggerMaintenanceEditImageInput(true)" class="text-sm bg-indigo-500 text-white rounded-md px-4 py-2 hover:bg-indigo-600">更換照片</button>
                    </div>
                </div>`;
             
             const imageInput = document.getElementById('edit-maintenance-image-input');
             const imagePreview = document.getElementById('edit-maintenance-image-preview');
             imageInput.onchange = async (e) => { if(e.target.files[0]) await handleImageSelection(e.target.files[0], imagePreview); };
             document.getElementById('save-maintenance-changes-btn').onclick = (e) => saveMaintenanceChanges(e.target, recordId);
             document.getElementById('maintenance-editor-modal').classList.replace('hidden', 'flex');
        }

        window.saveMaintenanceChanges = async function(button, recordId) {
            showButtonLoading(button, '更新中...');
            try {
                const imagePreview = document.getElementById('edit-maintenance-image-preview');
                const updatedData = {
                    notes: document.getElementById('edit-maintenance-notes').value,
                    timestamp: new Date(document.getElementById('edit-maintenance-timestamp').value)
                };
                if(imagePreview.dataset.imageDataUrl) {
                    updatedData.imageUrl = imagePreview.dataset.imageDataUrl;
                }
                
                await updateDoc(doc(db, "maintenance_history", recordId), updatedData);
                showToast('保養紀錄更新成功', 'success');
                closeMaintenanceEditor();
            } catch(e) { 
                showToast('更新失敗', 'error'); 
            } finally {
                hideButtonLoading(button);
            }
        }

        window.showMaintenanceModal = function(equipmentId) {
            currentlyMaintainedEqId = equipmentId;
            const eq = equipmentDatabase[equipmentId];
            if (!eq) return;
            document.getElementById('maintenance-modal-title').textContent = `記錄保養 - ${eq.name}`;
            document.getElementById('maintenance-user-name').textContent = loggedInUser.name;
            const typeSelect = document.getElementById('maintenance-type'), compSelectorDiv = document.getElementById('maintenance-component-selector'), compSelect = document.getElementById('maintenance-component-name');
            typeSelect.onchange = () => compSelectorDiv.classList.toggle('hidden', typeSelect.value !== 'replacement');
            compSelect.innerHTML = '';
            if (eq.components && eq.components.length > 0) {
                eq.components.forEach(c => compSelect.add(new Option(c.componentName, c.componentName)));
            } else {
                compSelect.innerHTML = '<option value="">無可更換零件</option>';
            }
            typeSelect.dispatchEvent(new Event('change'));
            document.getElementById('maintenance-modal').classList.replace('hidden', 'flex');
        }

        window.closeMaintenanceModal = function() {
            document.getElementById('maintenance-modal').classList.replace('flex', 'hidden');
            ['maintenance-notes', 'maintenance-image-input'].forEach(id => document.getElementById(id).value = '');
            const preview = document.getElementById('maintenance-image-preview');
            preview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=無圖片';
            delete preview.dataset.imageDataUrl;
            currentlyMaintainedEqId = null;
        }

        window.triggerMaintenanceImageInput = function(useCamera) {
            const input = document.getElementById('maintenance-image-input');
            const preview = document.getElementById('maintenance-image-preview');
            if (useCamera) input.setAttribute('capture', 'environment'); else input.removeAttribute('capture');
            input.onchange = async (e) => { if(e.target.files[0]) await handleImageSelection(e.target.files[0], preview); };
            input.click();
        }

        window.logMaintenance = async function(button) {
            if (!currentlyMaintainedEqId) return;
            showButtonLoading(button, '記錄中...');
            
            try {
                const eq = equipmentDatabase[currentlyMaintainedEqId];
                const type = document.getElementById('maintenance-type').value;
                const imagePreview = document.getElementById('maintenance-image-preview');
                const logData = { 
                    deviceId: currentlyMaintainedEqId, 
                    deviceName: eq.name, 
                    userId: loggedInUser.id, 
                    userName: loggedInUser.name, 
                    type: type, 
                    timestamp: serverTimestamp(), 
                    notes: document.getElementById('maintenance-notes').value,
                    imageUrl: imagePreview.dataset.imageDataUrl || null
                };
                
                const batch = writeBatch(db);
                
                if (type === 'cleaning') {
                    const cycle = eq.cleaningCycleDays || 30;
                    const newNextDate = new Date(MOCK_TODAY); newNextDate.setDate(MOCK_TODAY.getDate() + cycle);
                    batch.update(doc(db, "equipment", currentlyMaintainedEqId), { nextCleaningDate: newNextDate.toISOString().slice(0, 10) });
                    notificationDatabase = notificationDatabase.filter(n => !(String(n.id).startsWith(`clean-${currentlyMaintainedEqId}`)));
                    createNotification(`[${loggedInUser.name}] 已完成 [${eq.name}] 的清潔。下次清潔日為 ${newNextDate.toISOString().slice(0, 10)}。`, 'all', 'success');
                } else if (type === 'replacement') {
                    const compName = document.getElementById('maintenance-component-name').value;
                    if (!compName) { showToast('請選擇更換的零件', 'error'); return; }
                    logData.componentName = compName;
                    const newComponents = eq.components.map(c => {
                        if (c.componentName === compName) {
                            const cycle = c.replacementCycleDays || 90;
                            const newNextDate = new Date(MOCK_TODAY); newNextDate.setDate(MOCK_TODAY.getDate() + cycle);
                            notificationDatabase = notificationDatabase.filter(n => !(String(n.id).startsWith(`comp-${currentlyMaintainedEqId}-${compName}`)));
                            createNotification(`[${loggedInUser.name}] 已更換 [${eq.name}] 的 [${compName}]。下次更換日為 ${newNextDate.toISOString().slice(0, 10)}。`, 'all', 'success');
                            return { ...c, nextReplacementDate: newNextDate.toISOString().slice(0, 10) };
                        }
                        return c;
                    });
                    batch.update(doc(db, "equipment", currentlyMaintainedEqId), { components: newComponents });
                }
                batch.set(doc(collection(db, "maintenance_history")), logData);
                await batch.commit();
                showToast('保養紀錄已儲存', 'success');
                closeMaintenanceModal();
            } catch(e) { 
                console.error(e);
                showToast('儲存失敗', 'error'); 
            } finally {
                hideButtonLoading(button);
            }
        }

        window.renderMaintenanceLog = function() {
            const container = document.getElementById('maintenance-log-container'); container.innerHTML = '';
            if (maintenanceHistory.length === 0) { container.innerHTML = '<p class="text-slate-500 text-center py-8">無保養紀錄</p>'; return; }
            const sorted = [...maintenanceHistory].sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate());
            let html = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="text-left text-xs text-gray-500 uppercase"><th>日期</th><th>設備</th><th>類型/零件</th><th>人員</th><th>操作</th></tr></thead><tbody>`;
            sorted.forEach(log => {
                html += `<tr class="border-b"><td class="py-2">${log.timestamp.toDate().toLocaleString()}</td><td>${log.deviceName}</td><td>${log.type === 'cleaning' ? '清潔' : `更換: ${log.componentName}`}</td><td>${log.userName}</td><td><button onclick="showMaintenanceEditor('${log.id}')" class="text-blue-600">編輯</button><button onclick="deleteMaintenanceRecord('${log.id}')" class="text-red-600 ml-2">刪除</button></td></tr>`;
            });
            container.innerHTML = html + '</tbody></table></div>';
        }

        window.showImageModal = function(imageUrl) { document.getElementById('full-size-image').src = imageUrl; document.getElementById('image-viewer-modal').classList.replace('hidden', 'flex'); }
        window.closeImageModal = function() { document.getElementById('image-viewer-modal').classList.replace('flex', 'hidden'); }

        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container'); const toast = document.createElement('div');
            let bgColor;
            switch(type) {
                case 'success': bgColor = 'bg-green-500'; break;
                case 'error':   bgColor = 'bg-red-500'; break;
                case 'warning': bgColor = 'bg-yellow-500'; break;
                default:        bgColor = 'bg-slate-700'; break;
            }
            toast.className = `toast ${bgColor} text-white p-4 rounded-lg shadow-lg transform translate-x-full opacity-0`;
            toast.innerHTML = `<p>${message}</p>`; container.appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); toast.classList.add('translate-x-0', 'opacity-100'); }, 100);
            setTimeout(() => { toast.classList.remove('translate-x-0', 'opacity-100'); toast.classList.add('opacity-0'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        }

        window.showConfirm = function(message, onConfirm, isDestructive = false) {
            document.getElementById('confirm-modal-text').textContent = message;
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            confirmBtn.className = `font-bold py-2 px-4 rounded-lg transition-colors`;
            if (isDestructive) { confirmBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700'); confirmBtn.textContent = '確定刪除'; } 
            else { confirmBtn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700'); confirmBtn.textContent = '確定'; }
            confirmCallback = onConfirm; document.getElementById('confirm-modal').classList.replace('hidden', 'flex');
        }

        window.getAllChecklistItemCategories = function() {
            const categories = new Set();
            Object.values(equipmentDatabase).forEach(eq => eq.items?.forEach(cat => categories.add(cat.category)));
            Object.values(templateDatabase).forEach(tmpl => tmpl.items?.forEach(cat => categories.add(cat.category)));
            return [...categories].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
        }

        window.getAllSubItemTexts = function() {
            const texts = new Set();
            Object.values(equipmentDatabase).forEach(eq => eq.items?.forEach(cat => cat.subItems.forEach(item => texts.add(item.text))));
            Object.values(templateDatabase).forEach(tmpl => tmpl.items?.forEach(cat => cat.subItems.forEach(item => texts.add(item.text))));
            return [...texts].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
        }

        window.addCategoryEditor = function(categoryData = null, containerId = 'item-editor-container') {
            const container = document.getElementById(containerId); const block = document.createElement('div');
            block.className = 'category-editor-block bg-slate-50 border border-slate-200 p-4 rounded-lg space-y-3';
            let categoryOptions = getAllChecklistItemCategories().map(c => `<option value="${c}">${c}</option>`).join('');
            block.innerHTML = `<div class="flex items-center justify-between"><div class="flex-grow"><select class="category-name-select w-full p-2 border-gray-300 rounded-md shadow-sm form-select"><option value="">選擇或新增大分類...</option>${categoryOptions}<option value="__new__">＋ 新增大分類</option></select><input type="text" class="category-name-new-input hidden w-full mt-2 p-2 border-gray-300 rounded-md" placeholder="請輸入新的大分類名稱"></div><button onclick="this.closest('.category-editor-block').remove()" class="ml-3 text-red-500 hover:text-red-700 p-1 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div><div class="sub-item-container ml-4 pl-4 border-l-2 border-slate-300 space-y-2"></div><button type="button" class="add-sub-item-btn w-full text-sm text-indigo-700 bg-indigo-100 hover:bg-indigo-200 rounded-md py-2 transition-colors">＋ 新增點檢項目</button>`;
            const categorySelect = block.querySelector('.category-name-select'), newCategoryInput = block.querySelector('.category-name-new-input');
            categorySelect.onchange = () => { newCategoryInput.classList.toggle('hidden', categorySelect.value !== '__new__'); if(categorySelect.value === '__new__') newCategoryInput.focus(); };
            const subItemContainer = block.querySelector('.sub-item-container');
            block.querySelector('.add-sub-item-btn').onclick = () => addSubItemEditor(subItemContainer);
            if (categoryData) { if(getAllChecklistItemCategories().includes(categoryData.category)) categorySelect.value = categoryData.category; else { categorySelect.value = '__new__'; newCategoryInput.value = categoryData.category; newCategoryInput.classList.remove('hidden'); } if (categoryData.subItems) categoryData.subItems.forEach(item => addSubItemEditor(subItemContainer, item)); }
            container.appendChild(block);
        }

        window.addSubItemEditor = function(container, item = null) {
            const wrapper = document.createElement('div'); wrapper.className = 'sub-item-wrapper flex items-center space-x-2';
            let subItemOptions = getAllSubItemTexts().map(s => `<option value="${s}">${s}</option>`).join('');
            wrapper.innerHTML = `<div class="flex-grow"><select class="sub-item-select w-full p-2 border-gray-300 rounded-md shadow-sm text-sm form-select"><option value="">選擇或新增項目...</option>${subItemOptions}<option value="__new__">＋ 新增項目</option></select><input type="text" class="sub-item-new-input hidden w-full mt-1 p-2 border-gray-300 rounded-md text-sm" placeholder="請輸入新的項目文字"></div><button type="button" onclick="this.closest('.sub-item-wrapper').remove()" class="text-slate-400 hover:text-red-600 p-1">✕</button>`;
            const subItemSelect = wrapper.querySelector('.sub-item-select'), newSubItemInput = wrapper.querySelector('.sub-item-new-input');
            subItemSelect.onchange = () => { newSubItemInput.classList.toggle('hidden', subItemSelect.value !== '__new__'); if(subItemSelect.value === '__new__') newSubItemInput.focus(); };
            if (item) { if(getAllSubItemTexts().includes(item.text)) subItemSelect.value = item.text; else { subItemSelect.value = '__new__'; newSubItemInput.value = item.text; newSubItemInput.classList.remove('hidden'); } }
            container.appendChild(wrapper);
        }

    </script>
</body>
</html>