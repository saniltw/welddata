<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å‚™é»æª¢è¡¨ (å®Œç¾å¾©åˆ»ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .status-btn.selected { transform: scale(1.05); box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39); }
        .status-btn.selected-normal { background-color: #22c55e; color: white; border-color: #22c55e; }
        .status-btn.selected-abnormal { background-color: #ef4444; color: white; border-color: #ef4444; }
        .status-btn.selected-na { background-color: #64748b; color: white; border-color: #64748b; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); border: 1px solid #e5e7eb; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none; appearance: none;
        }
        .admin-tab-active { color: #4f46e5; border-color: #4f46e5; }
        .eq-tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .eq-tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        .eq-tab-inactive:hover { color: #374151; border-color: #d1d5db; }
        .status-dot { height: 0.6rem; width: 0.6rem; border-radius: 50%; display: inline-block; margin-right: 0.3rem; }
        .status-dot.active { background-color: #22c55e; }
        .status-dot.repair { background-color: #eab308; }
        .status-dot.unused { background-color: #9ca3af; }
        
        /* æ¬Šé™æ§åˆ¶æ¨£å¼ */
        .role-guest .action-edit, 
        .role-guest .action-delete, 
        .role-guest .action-add,
        .role-guest .action-submit { display: none !important; }
        
        /* å»£æ³°å ±è¡¨å°ˆç”¨æ¨£å¼ (é€™äº›æ¨£å¼æœƒè¢«è¤‡è£½åˆ°åˆ—å°è¦–çª—) */
        .kt-report-table { width: 100%; border-collapse: collapse; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif; }
        .kt-report-table th, .kt-report-table td { border: 1px solid black; padding: 4px; text-align: center; vertical-align: middle; height: 35px; font-size: 14px; }
        .kt-header { text-align: center; font-weight: bold; margin-bottom: 10px; position: relative; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .kt-logo-container { position: absolute; left: 0; top: 0; text-align: left; }
        .kt-logo { height: 40px; display: block; margin-bottom: 2px; }
        .kt-logo-text { font-family: sans-serif; font-weight: bold; font-size: 14px; }
        .kt-company-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .kt-title-main { font-size: 26px; text-decoration: underline; font-weight: bold; }
        /* æ›´æ–°: è¡¨é ­è³‡è¨Šæ”¹ç‚ºè¡¨æ ¼æ¨£å¼ï¼Œä¸å†ä½¿ç”¨ flex */
        .kt-info-table { width: 100%; border-collapse: collapse; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif; margin-bottom: 5px; }
        .kt-info-table td { border: 1px solid black; padding: 5px 10px; font-size: 16px; vertical-align: middle; }
        
        .kt-footer-notes { font-size: 12px; margin-top: 10px; line-height: 1.5; text-align: left; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif;}
        .kt-sign-area { display: flex; justify-content: space-between; margin-top: 20px; font-size: 14px; font-family: "æ ‡æ¥·ä½“", "DFKai-SB", "Noto Sans TC", sans-serif;}
        .page-break { page-break-after: always; display: block; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100]">
        <div class="spinner"></div>
        <p id="loading-text" class="mt-4 text-slate-600">ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <!-- ç™»å…¥ Modal -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center p-4 z-[150] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">æ­¡è¿ä½¿ç”¨</h1>
                <p class="text-slate-500 mt-2">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†ä»¥é€²å…¥ç³»çµ±</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">ä½¿ç”¨è€…</label>
                    <select id="login-user-select" class="form-select w-full p-3 border border-gray-300 rounded-xl text-lg bg-slate-50 focus:ring-2 focus:ring-indigo-500">
                        <option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>
                        <!-- ä½¿ç”¨è€…åˆ—è¡¨å°‡ç”± JS å‹•æ…‹è¼‰å…¥ -->
                    </select>
                </div>
                
                <button onclick="window.app.handleLogin()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl text-lg hover:bg-indigo-700 shadow-lg transform transition hover:scale-[1.02]">
                    é€²å…¥ç³»çµ±
                </button>
            </div>
            
            <p class="text-center text-xs text-slate-400 mt-6">ç³»çµ±ç‰ˆæœ¬ v3.8 (Table Header Fix)</p>
        </div>
    </div>

    <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 md:p-8 hidden">
        <!-- Main Content Omitted for Brevity (Same as before) -->
        <div class="flex justify-between items-center mb-6">
            <div id="user-status" class="text-sm flex items-center">
                <div id="logged-in-view">
                    <span>Hi, <strong id="logged-in-name" class="text-indigo-600 font-semibold"></strong> 
                    <span id="role-badge" class="ml-2 px-2 py-0.5 rounded text-xs bg-gray-200 text-gray-700"></span></span>
                    <button onclick="window.app.logout()" class="ml-3 text-xs text-red-500 underline">ç™»å‡º</button>
                </div>
            </div>
            <button id="toggle-mode-btn" onclick="window.app.toggleManagementMode()" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-800 text-sm hidden">âš™ï¸ ç®¡ç†å¾Œå°</button>
        </div>

        <div id="user-mode">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-slate-800">è¨­å‚™é»æª¢</h1>
                <p id="header-subtitle" class="text-slate-500 mt-2">ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæ QR Code æˆ–æ‰‹å‹•é¸æ“‡</p>
            </header>

            <div id="main-content" class="space-y-6">
                <div id="scan-section" class="card text-center p-8">
                    <button onclick="window.app.showScanner()" class="bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-indigo-700 transition-transform hover:scale-105 flex items-center justify-center mx-auto action-submit">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                        é–‹å•Ÿç¶²é æƒæå™¨
                    </button>
                    <p class="text-sm text-gray-500 mt-3 action-submit">ğŸ’¡ æç¤ºï¼šæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæè¨­å‚™ä¸Šçš„ QR Code</p>
                    <p class="text-red-500 font-bold hidden guest-warning mt-2">è¨ªå®¢åƒ…ä¾›æª¢è¦–ï¼Œç„¡æ³•åŸ·è¡Œé»æª¢æ“ä½œ</p>
                </div>

                <div id="manual-select-section" class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">æ‰‹å‹•é¸æ“‡è¨­å‚™</h2>
                    <div class="space-y-4">
                        <select id="manual-category-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm"><option value="">è¼‰å…¥ä¸­...</option></select>
                        <select id="manual-device-select" class="form-select w-full border-gray-300 rounded-lg shadow-sm" disabled><option value="">è«‹å…ˆé¸æ“‡å¤§é¡...</option></select>
                        <div class="flex space-x-3 action-submit">
                            <button onclick="window.app.handleManualSelection()" id="manual-start-button" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>
                                ğŸ“‹ é–‹å§‹é»æª¢
                            </button>
                            <button onclick="window.app.handleManualMaintenance()" id="manual-maintenance-button" class="flex-1 bg-orange-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-orange-600 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors" disabled>
                                ğŸ”§ è¨˜éŒ„ä¿é¤Š
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="checklist-section" class="hidden space-y-6">
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4 border-b pb-3">è¨­å‚™è³‡è¨Š</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                        <div><label class="text-slate-500">è¨­å‚™åç¨±</label><p id="device-name" class="font-bold text-slate-700 text-lg"></p></div>
                        <div><label class="text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><p id="device-asset-no" class="font-semibold text-slate-700"></p></div>
                        <div><label class="text-slate-500">é»æª¢äººå“¡</label><p id="user-name-display" class="font-semibold text-slate-700"></p></div>
                        <div>
                            <label class="text-slate-500 block mb-1">é»æª¢æ—¥æœŸ (å¯è£œç™»)</label>
                            <div class="flex items-center gap-2">
                                <input type="date" id="check-date-input" class="border border-slate-300 rounded p-1.5 text-slate-700 font-semibold bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="window.app.updateWeekDisplay(this.value)">
                                <span id="week-display" class="text-sm font-medium text-indigo-600 bg-indigo-50 px-2.5 py-1.5 rounded-full border border-indigo-100"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="checklist-items-container" class="space-y-6"></div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-slate-800 mb-4">ç¸½çµå‚™è¨»</h2>
                    <textarea id="summary-notes" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea>
                </div>
                <div class="mt-4 flex space-x-4">
                    <button onclick="window.app.resetApp()" class="w-1/3 bg-slate-500 text-white font-bold py-3 px-4 rounded-lg">å–æ¶ˆ</button>
                    <button onclick="window.app.submitChecklist(this)" class="w-2/3 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg action-submit">æäº¤</button>
                </div>
            </div>
        </div>

        <div id="admin-mode" class="hidden">
            <header class="mb-6"><h1 class="text-4xl font-bold text-slate-800">ç®¡ç†å¾Œå°</h1></header>
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex -mb-px space-x-4 overflow-x-auto text-sm font-medium">
                    <button onclick="window.app.switchAdminTab('equipment')" id="tab-equipment" class="px-1 py-3 border-b-2 admin-tab-active">è¨­å‚™ç®¡ç†</button>
                    <button onclick="window.app.switchAdminTab('templates')" id="tab-templates" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600 action-delete">é»æª¢ç¯„æœ¬</button>
                    <button onclick="window.app.switchAdminTab('users')" id="tab-users" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600 action-delete">äººå“¡ç®¡ç†</button>
                    <button onclick="window.app.switchAdminTab('checklistHistory')" id="tab-checklistHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">é»æª¢ç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('maintenanceHistory')" id="tab-maintenanceHistory" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">ä¿é¤Šç´€éŒ„</button>
                    <button onclick="window.app.switchAdminTab('reports')" id="tab-reports" class="px-1 py-3 border-b-2 border-transparent hover:text-indigo-600">å ±è¡¨è¼¸å‡º</button>
                </nav>
            </div>
            
            <div id="admin-tab-content-equipment">
                <div id="equipment-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">è¨­å‚™åˆ—è¡¨</h2>
                        <button onclick="window.app.showEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm action-add">æ–°å¢è¨­å‚™</button>
                    </div>
                    <div id="equipment-category-tabs" class="mb-6"></div>
                    <div id="equipment-list-container"></div>
                </div>
                
                <div id="equipment-editor-section" class="hidden card p-6">
                    <!-- Equipment Editor Content -->
                    <h2 id="editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯è¨­å‚™</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™ç·¨è™Ÿ (ID)</label><input type="text" id="edit-device-id" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™åç¨±</label><input type="text" id="edit-device-name" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è¨­å‚™å€åˆ†</label><select id="edit-device-category-select" class="w-full p-2 border rounded mb-2"></select><input type="text" id="edit-device-category-new" class="w-full p-2 border rounded hidden" placeholder="è¼¸å…¥æ–°åˆ†é¡..."></div>
                            <div><label class="block text-xs font-medium text-slate-500">æ”¾ç½®åœ°é»</label><input type="text" id="edit-device-location" class="w-full p-2 border rounded"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">è³‡ç”¢ç·¨è™Ÿ</label><input type="text" id="edit-device-asset" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">ç¾æ³</label><select id="edit-device-status" class="w-full p-2 border rounded form-select"><option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option><option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option><option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option></select></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-medium text-slate-500">é»æª¢é€±æœŸ (å¤©)</label><input type="number" id="edit-device-cycle" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500">ä¸‹æ¬¡é»æª¢æ—¥</label><input type="date" id="edit-device-next-date" class="w-full p-2 border rounded"></div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-indigo-50 border border-indigo-100 rounded-lg">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="edit-device-include-kt" class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                                <span class="font-bold text-indigo-700">åˆ—å°æ–¼ã€Œå»£æ³°é‡‘å±¬-é€±é»æª¢è¡¨ã€</span>
                            </label>
                            <p class="text-xs text-indigo-500 mt-1 ml-8">å‹¾é¸æ­¤é …ç›®å¾Œï¼Œæ­¤è¨­å‚™æ‰æœƒå‡ºç¾åœ¨ã€Œå»£æ³°é‡‘å±¬-é€±é»æª¢è¡¨ã€å ±è¡¨ä¸­ã€‚</p>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-2">æˆæ¬Šäººå“¡</label>
                            <div id="user-assignment-container" class="w-full p-3 border rounded h-32 overflow-y-auto bg-slate-50 grid grid-cols-2 gap-2"></div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-2">è¨­å‚™åœ–ç‰‡</label>
                            <div class="flex items-center gap-4">
                                <img id="image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border">
                                <button type="button" onclick="document.getElementById('edit-device-image').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ğŸ“· æ‹ç…§ / ä¸Šå‚³</button>
                                <input type="file" id="edit-device-image" accept="image/*" class="hidden" onchange="window.app.handleImageUpload(this)">
                            </div>
                        </div>

                        <hr class="my-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700">é»æª¢é …ç›®è¨­å®š</h3>
                            <button onclick="window.app.showTemplateModal()" class="text-sm bg-teal-500 text-white px-3 py-1 rounded hover:bg-teal-600">ğŸ“‘ å¾ç¯„æœ¬è¼‰å…¥</button>
                        </div>
                        <div id="item-editor-container" class="space-y-4"></div>
                        <button onclick="window.app.addCategoryEditor(null, 'item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button>

                        <hr class="my-4">
                        <h3 class="font-bold text-slate-700">å¯æ›´æ›é›¶ä»¶ç®¡ç† (è€—æ)</h3>
                        <div id="component-editor-container" class="space-y-2"></div>
                        <button onclick="window.app.addComponentEditor()" class="w-full bg-gray-100 text-gray-700 py-2 rounded border border-gray-300 hover:bg-gray-200">ï¼‹ æ–°å¢é›¶ä»¶</button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveEquipment(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜è®Šæ›´</button>
                    </div>
                </div>
            </div>

            <div id="admin-tab-content-templates" class="hidden">
                <!-- Templates Content -->
                <div id="template-list-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">é»æª¢ç¯„æœ¬ç®¡ç†</h2>
                        <button onclick="window.app.showTemplateEditor()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-sm action-add">æ–°å¢ç¯„æœ¬</button>
                    </div>
                    <div id="template-list-container" class="space-y-3"></div>
                </div>
                <div id="template-editor-section" class="hidden card p-6">
                    <h2 id="template-editor-title" class="text-2xl font-semibold mb-6 text-slate-800">ç·¨è¼¯ç¯„æœ¬</h2>
                    <div class="space-y-4">
                        <input type="hidden" id="edit-template-id">
                        <div><label class="block text-xs font-medium text-slate-500">ç¯„æœ¬åç¨±</label><input type="text" id="edit-template-name" class="w-full p-2 border rounded" placeholder="ä¾‹å¦‚ï¼šå †é«˜æ©Ÿé€šç”¨æª¢æŸ¥è¡¨"></div>
                        <hr class="my-4">
                        <h3 class="font-bold text-slate-700">ç¯„æœ¬é …ç›®è¨­å®š</h3>
                        <div id="template-item-editor-container" class="space-y-4"></div>
                        <button onclick="window.app.addCategoryEditor(null, 'template-item-editor-container')" class="w-full bg-indigo-50 text-indigo-700 py-2 rounded border border-indigo-200">ï¼‹ æ–°å¢æª¢æŸ¥åˆ†é¡</button>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="window.app.showTemplateList()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                        <button onclick="window.app.saveTemplate(this)" class="bg-indigo-600 text-white py-2 px-4 rounded">å„²å­˜ç¯„æœ¬</button>
                    </div>
                </div>
            </div>
            
            <div id="admin-tab-content-users" class="hidden">
                <!-- Users Content -->
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold">äººå“¡åˆ—è¡¨</h2><button onclick="window.app.showUserEditor()" class="bg-indigo-600 text-white px-4 py-2 rounded action-add">æ–°å¢</button></div>
                <div id="user-list-container" class="space-y-2"></div>
                <div id="user-editor-section" class="hidden card p-6">
                    <h2 id="user-editor-title" class="text-xl font-bold mb-4">ç·¨è¼¯äººå“¡</h2>
                    <div class="space-y-3">
                        <input type="text" id="edit-user-id" placeholder="ID" class="w-full p-2 border rounded">
                        <input type="text" id="edit-user-name" placeholder="å§“å" class="w-full p-2 border rounded">
                        <select id="edit-user-role" class="w-full p-2 border rounded">
                            <option value="operator">æ“ä½œå“¡</option>
                            <option value="manager">ç®¡ç†å“¡</option>
                        </select>
                        <input type="password" id="edit-user-password" placeholder="å¯†ç¢¼ (ç®¡ç†å“¡å¿…å¡«)" class="w-full p-2 border rounded hidden">
                    </div>
                    <div class="flex justify-end gap-2 mt-4"><button onclick="window.app.showUserList()" class="bg-gray-200 px-4 py-2 rounded">å–æ¶ˆ</button><button onclick="window.app.saveUser(this)" class="bg-indigo-600 text-white px-4 py-2 rounded">å„²å­˜</button></div>
                </div>
            </div>

             <div id="admin-tab-content-reports" class="hidden">
                 <h2 class="text-2xl font-semibold mb-4 text-slate-800">å ±è¡¨è¼¸å‡ºä¸­å¿ƒ</h2>
                 <div class="card p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">å ±è¡¨é¡å‹</label>
                            <select id="report-type" class="w-full p-2 border rounded bg-white">
                                <option value="checklist">è¨­å‚™é»æª¢ç´€éŒ„è¡¨ (æ¸…å–®å¼)</option>
                                <option value="kt_weekly">å»£æ³°é‡‘å±¬-é€±é»æª¢è¡¨ (æ ¼å¼åŒ–)</option>
                                <option value="maintenance">ä¿é¤Šç¶­ä¿®ç´€éŒ„è¡¨</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">è¨­å‚™åˆ†é¡</label>
                            <select id="report-category" class="w-full p-2 border rounded bg-white">
                                <option value="ALL">å…¨éƒ¨åˆ†é¡</option>
                            </select>
                        </div>
                        
                        <div id="date-range-container" class="contents">
                            <div><label class="block text-xs font-medium text-slate-500 mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date" id="report-start-date" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-xs font-medium text-slate-500 mb-1">çµæŸæ—¥æœŸ</label><input type="date" id="report-end-date" class="w-full p-2 border rounded"></div>
                        </div>
                        
                        <div id="kt-report-options" class="hidden md:col-span-2 flex gap-4">
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-slate-500 mb-1">å ±è¡¨æœˆä»½</label>
                                <input type="month" id="report-month" class="w-full p-2 border rounded">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-slate-500 mb-1">ä¸»ç®¡</label>
                                <input type="text" id="report-supervisor" class="w-full p-2 border rounded" placeholder="ç°½æ ¸ä¸»ç®¡">
                            </div>
                        </div>

                        <div class="flex items-end"><button onclick="window.app.generateReport()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700">ç”¢ç”Ÿå ±è¡¨</button></div>
                    </div>
                 </div>
                 <div id="report-preview-container" class="bg-white p-8 shadow-lg rounded-lg min-h-[500px] hidden">
                     <div class="text-center border-b-2 border-slate-800 pb-4 mb-6">
                         <h1 class="text-3xl font-bold text-slate-900 mb-2" id="report-title">è¨­å‚™ç´€éŒ„å ±è¡¨</h1>
                         <p class="text-slate-600" id="report-subtitle">æŸ¥è©¢å€é–“: </p>
                     </div>
                     <div id="report-content" class="overflow-x-auto"></div>
                 </div>
                 <div id="report-actions" class="mt-4 flex justify-end gap-3 hidden">
                     <button onclick="window.app.printReport()" class="bg-slate-700 text-white font-bold py-2 px-6 rounded hover:bg-slate-800 flex items-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>åˆ—å° / å¦å­˜ PDF</button>
                 </div>
             </div>

             <div id="admin-tab-content-checklistHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™é»æª¢æ­·å²ç´€éŒ„</h2>
                <div id="checklist-history-log-container"></div>
             </div>
             <div id="admin-tab-content-maintenanceHistory" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„</h2>
                <div id="maintenance-history-log-container"></div>
             </div>
        </div>
    </div>

    <!-- Modals (Omitted for brevity, same as previous) -->
    <!-- Scan Action Modal -->
    <div id="scan-action-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[140] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center hidden" id="scan-action-content">
             <h3 class="text-xl font-bold mb-2 text-slate-800">æƒææˆåŠŸ</h3>
             <p id="scan-match-name" class="text-lg text-indigo-600 font-bold mb-6">è¨­å‚™åç¨±</p>
             <div class="space-y-3">
                 <button id="btn-scan-checklist" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 shadow-md flex items-center justify-center gap-2 action-submit">ğŸ“‹ é–‹å§‹é»æª¢</button>
                 <button id="btn-scan-maintenance" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 shadow-md flex items-center justify-center gap-2 action-submit">ğŸ”§ è¨˜éŒ„ä¿é¤Š</button>
                 <button onclick="document.getElementById('scan-action-modal').classList.add('hidden')" class="w-full bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-lg hover:bg-slate-300">å–æ¶ˆ</button>
             </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">é¸æ“‡ç¯„æœ¬</h3>
            <div id="template-selection-container" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button onclick="window.app.closeTemplateModal()" class="mt-4 w-full bg-slate-200 py-2 rounded">é—œé–‰</button>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div id="maintenance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[120] hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full">
            <h2 class="text-2xl font-semibold mb-4 text-slate-800">æ–°å¢ä¿é¤Šç´€éŒ„</h2>
            <p id="maint-device-name" class="mb-4 text-slate-600"></p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600">ä¿é¤Šé¡å‹</label>
                    <select id="maintenance-type" class="w-full p-2 border rounded mt-1" onchange="window.app.toggleMaintType()">
                        <option value="cleaning">æ©Ÿå°æ¸…æ½”</option>
                        <option value="replacement">é›¶ä»¶æ›´æ›</option>
                    </select>
                </div>
                <div id="maintenance-component-selector" class="hidden">
                    <label class="block text-sm font-medium text-slate-600">æ›´æ›é›¶ä»¶</label>
                    <select id="maintenance-component-name" class="w-full p-2 border rounded mt-1"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600">å‚™è¨»èªªæ˜</label>
                    <textarea id="maintenance-notes" class="w-full p-2 border rounded mt-1" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-2">ä¿é¤Šç…§ç‰‡ (é¸å¡«)</label>
                    <div class="flex items-center gap-4">
                        <img id="maint-image-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡" class="w-24 h-24 object-cover rounded-md border">
                        <button type="button" onclick="document.getElementById('maint-image-upload').click()" class="text-sm bg-white border px-3 py-1 rounded hover:bg-slate-50">ğŸ“· æ‹ç…§ / ä¸Šå‚³</button>
                        <input type="file" id="maint-image-upload" accept="image/*" class="hidden" onchange="window.app.handleMaintImageUpload(this)">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="window.app.closeMaintenanceModal()" class="bg-slate-200 py-2 px-4 rounded">å–æ¶ˆ</button>
                <button onclick="window.app.logMaintenance(this)" class="bg-orange-500 text-white py-2 px-4 rounded font-bold">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <!-- QR Code Display Modal -->
    <div id="qr-code-display-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-[130] flex">
        <div class="bg-white rounded-xl shadow-2xl p-6 text-center max-w-sm w-full hidden" id="qr-display-content">
            <h3 class="text-xl font-bold mb-2">è¨­å‚™ QR Code</h3>
            <p id="qr-display-name" class="text-gray-600 mb-4"></p>
            <div id="qr-code-container" class="flex justify-center mb-4 border p-2 rounded bg-white"></div>
            <p class="text-xs text-gray-400 mb-4">ä½¿ç”¨æ‰‹æ©Ÿç›¸æ©Ÿæƒæå³å¯ç›´æ¥é–‹å•Ÿ</p>
            <div class="space-y-2">
                <button onclick="window.app.downloadQRCode()" class="w-full bg-indigo-600 text-white font-bold px-4 py-2 rounded hover:bg-indigo-700 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    ä¸‹è¼‰åœ–ç‰‡
                </button>
                <button onclick="document.getElementById('qr-code-display-modal').classList.add('hidden')" class="w-full bg-slate-200 text-gray-700 font-bold px-4 py-2 rounded hover:bg-slate-300">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 hidden z-50 flex">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center hidden" id="qr-scanner-content">
            <h3 class="text-2xl font-bold mb-4">æƒæè¨­å‚™ QR Code</h3>
            <div id="qr-reader" class="w-full"></div>
            <button onclick="window.app.hideScanner()" class="w-full bg-slate-500 text-white p-3 rounded-lg mt-4">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-[110] space-y-3 w-full max-w-xs"></div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, serverTimestamp, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let equipmentDatabase = {}, userDatabase = {}, templateDatabase = {}, checkHistory = [], maintenanceHistory = [];
        let loggedInUser = null, currentCheckId = null, html5QrCode = null, currentMaintEqId = null;
        let currentQrId = null;

        window.app = {}; 
        window.app.printReport = function() {
            const reportContent = document.getElementById('report-content').innerHTML;
            if (!reportContent.trim()) {
                showToast("ç„¡å ±è¡¨å…§å®¹å¯åˆ—å°", "error");
                return;
            }
            const title = document.getElementById('report-title').textContent;
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert("ç€è¦½å™¨æ””æˆªäº†å½ˆè·³è¦–çª—ï¼Œè«‹å…è¨±æœ¬ç¶²ç«™çš„å½ˆè·³è¦–çª—ä»¥é€²è¡Œåˆ—å°ã€‚");
                return;
            }

            printWindow.document.write('<html><head><title>' + title + '</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">');
            
            const styles = document.querySelectorAll('style');
            styles.forEach(style => {
                printWindow.document.write(style.outerHTML);
            });
            
            // åŠ å…¥å¼·åˆ¶åˆ—å°æ¨£å¼
            printWindow.document.write(`
                <style>
                    body { background-color: white !important; margin: 0; padding: 20px; -webkit-print-color-adjust: exact; }
                    .page-break { page-break-after: always; display: block; position: relative; }
                    @media print {
                        .page-break { break-after: page; }
                        body { padding: 0; }
                    }
                </style>
            `);

            printWindow.document.write('</head><body>');
            printWindow.document.write(reportContent);
            printWindow.document.write('</body></html>');
            
            printWindow.document.close();
            
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 1000);
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDPpMCssbitCn2wE7WEqefL2czjIsRuyBw",
            authDomain: "checklist-20250825.firebaseapp.com",
            databaseURL: "https://checklist-20250825-default-rtdb.firebaseio.com",
            projectId: "checklist-20250825",
            storageBucket: "checklist-20250825.appspot.com",
            messagingSenderId: "899658463753",
            appId: "1:899658463753:web:71819671db2cdf6bf4d6d8",
            measurementId: "G-FH3F97BZ7F"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function getCollectionRef(name) { return collection(db, name); }
        function getDocRef(colName, docId) { return doc(db, colName, docId); }

        const init = () => {
            console.log("åˆå§‹åŒ– Firebase...");
            const urlParams = new URLSearchParams(window.location.search);
            const scanId = urlParams.get('id');
            if(scanId) window.app.pendingScanId = scanId;

            startListeners();
            
            const today = new Date().toISOString().slice(0,10);
            const currentMonth = new Date().toISOString().slice(0,7);
            
            const startDateEl = document.getElementById('report-start-date');
            if(startDateEl) {
                startDateEl.value = today;
                document.getElementById('report-end-date').value = today;
                document.getElementById('report-month').value = currentMonth;
            }

            const reportTypeSelect = document.getElementById('report-type');
            if(reportTypeSelect) {
                reportTypeSelect.addEventListener('change', window.app.handleReportTypeChange);
            }
        };

        // --- Utils for Week Calculation ---
        window.app.updateWeekDisplay = function(dateStr) {
            if(!dateStr) return;
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            let week = 0;
            if(day <= 7) week = 1;
            else if(day <= 14) week = 2;
            else if(day <= 21) week = 3;
            else if(day <= 28) week = 4;
            else week = 5;
            
            const display = document.getElementById('week-display');
            if(display) display.textContent = `${month}æœˆ ç¬¬ ${week} é€±`;
        }

        window.app.handleReportTypeChange = function() {
            const type = document.getElementById('report-type').value;
            const dateContainer = document.getElementById('date-range-container');
            const ktOptionsContainer = document.getElementById('kt-report-options');
            
            if (type === 'kt_weekly') {
                dateContainer.classList.add('hidden');
                dateContainer.classList.remove('contents');
                ktOptionsContainer.classList.remove('hidden');
            } else {
                dateContainer.classList.remove('hidden');
                dateContainer.classList.add('contents');
                ktOptionsContainer.classList.add('hidden');
            }
        };

        function startListeners() {
            const onError = (error) => {
                console.error("Listener Error:", error);
                if (error.code === 'permission-denied') showToast("æ¬Šé™ä¸è¶³", 'error');
            };

            onSnapshot(getCollectionRef("users"), (snap) => {
                let newData = {}; 
                snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                userDatabase = newData;
                renderLoginOptions();
                if (!loggedInUser && !document.getElementById('login-modal').classList.contains('hidden') && !document.getElementById('app-container').classList.contains('hidden')) {
                } else if(!loggedInUser) {
                     document.getElementById('loading-overlay').classList.add('hidden');
                     document.getElementById('login-modal').classList.remove('hidden');
                }
                if (document.getElementById('user-list-container').offsetParent) window.app.renderUserList();
            }, onError);

            onSnapshot(getCollectionRef("equipment"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                equipmentDatabase = newData;
                if (document.getElementById('equipment-list-section').offsetParent) window.app.renderEquipmentList();
                if (document.getElementById('admin-tab-content-checklistHistory').offsetParent) window.app.renderChecklistHistory(document.getElementById('check-filter-select')?.value || 'ALL');
                if (document.getElementById('admin-tab-content-maintenanceHistory').offsetParent) window.app.renderMaintenanceHistory(document.getElementById('maint-filter-select')?.value || 'ALL');
                
                populateManualDropdown();
                populateReportCategoryDropdown();
                
                if(window.app.pendingScanId && loggedInUser) { 
                    if(equipmentDatabase[window.app.pendingScanId]) {
                        window.app.handleScanResult(window.app.pendingScanId);
                        window.app.pendingScanId = null; 
                        try { window.history.replaceState({}, document.title, window.location.pathname); } catch(e){}
                    }
                }
            }, onError);

            onSnapshot(getCollectionRef("checklist_templates"), (snap) => {
                let newData = {}; snap.forEach(d => { newData[d.id] = { id: d.id, ...d.data() }; });
                templateDatabase = newData;
                if (document.getElementById('template-list-section').offsetParent) window.app.renderTemplateList();
            }, onError);

            onSnapshot(getCollectionRef("check_history"), (snap) => {
                checkHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('admin-tab-content-checklistHistory').offsetParent) window.app.renderChecklistHistory(document.getElementById('check-filter-select')?.value || 'ALL');
            }, onError);

            onSnapshot(getCollectionRef("maintenance_history"), (snap) => {
                maintenanceHistory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(document.getElementById('admin-tab-content-maintenanceHistory').offsetParent) window.app.renderMaintenanceHistory(document.getElementById('maint-filter-select')?.value || 'ALL');
            }, onError);
        }

        function populateReportCategoryDropdown() {
            const sel = document.getElementById('report-category');
            if(!sel) return;
            const currentVal = sel.value;
            const cats = new Set(['ALL']);
            Object.values(equipmentDatabase).forEach(e => {
                if(e.category) cats.add(e.category);
                else cats.add('æœªåˆ†é¡');
            });
            
            sel.innerHTML = '';
            Array.from(cats).sort((a,b) => {
                if(a === 'ALL') return -1;
                if(b === 'ALL') return 1;
                return a.localeCompare(b, 'zh-TW');
            }).forEach(c => {
                sel.add(new Option(c === 'ALL' ? 'å…¨éƒ¨åˆ†é¡' : c, c));
            });
            
            if(currentVal && Array.from(sel.options).some(o => o.value === currentVal)) {
                sel.value = currentVal;
            } else {
                sel.value = 'ALL';
            }
        }

        function renderLoginOptions() {
            const select = document.getElementById('login-user-select');
            if(!select) return;
            select.innerHTML = '<option value="guest" selected>ğŸ‘¤ è¨ªå®¢ (åƒ…ä¾›æª¢è¦–)</option>';
            Object.values(userDatabase).forEach(user => {
                const roleText = user.role === 'manager' ? 'ğŸ‘‘ ç®¡ç†å“¡' : 'ğŸ”§ æ“ä½œå“¡';
                select.add(new Option(`${roleText} - ${user.name}`, user.id));
            });
        }
        
        window.app.handleLogin = function() {
            const select = document.getElementById('login-user-select');
            const userId = select.value;
            if (userId === 'guest') { loggedInUser = { id: 'guest', name: 'è¨ªå®¢', role: 'guest' }; } 
            else { loggedInUser = userDatabase[userId]; }
            if (!loggedInUser) return showToast("ç™»å…¥éŒ¯èª¤ï¼Œè«‹é‡è©¦", "error");
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            updateUIState();
            if(window.app.pendingScanId && equipmentDatabase[window.app.pendingScanId]) {
                window.app.handleScanResult(window.app.pendingScanId); window.app.pendingScanId = null;
            }
        };

        window.app.generateReport = function() {
            const type = document.getElementById('report-type').value;
            const category = document.getElementById('report-category').value;
            
            let start, end;
            
            if (type === 'kt_weekly') {
                const monthVal = document.getElementById('report-month').value; 
                if (!monthVal) return showToast("è«‹é¸æ“‡æœˆä»½", "error");
                const [year, month] = monthVal.split('-');
                start = new Date(year, month - 1, 1);
                end = new Date(year, month, 0, 23, 59, 59); 
            } else {
                start = new Date(document.getElementById('report-start-date').value);
                end = new Date(document.getElementById('report-end-date').value); end.setHours(23,59,59);
            }

            const container = document.getElementById('report-preview-container'); 
            const content = document.getElementById('report-content'); 
            const title = document.getElementById('report-title'); 
            const subtitle = document.getElementById('report-subtitle');
            
            container.classList.remove('hidden'); 
            document.getElementById('report-actions').classList.remove('hidden');
            
            const dateStr = type === 'kt_weekly' 
                ? `${start.getFullYear()}å¹´ ${start.getMonth()+1}æœˆ` 
                : `${start.toISOString().slice(0,10)} ~ ${end.toISOString().slice(0,10)}`;
            
            subtitle.textContent = `æŸ¥è©¢å€é–“: ${dateStr}${category !== 'ALL' ? ' (åˆ†é¡: ' + category + ')' : ''}`; 
            
            let html = '';
            
            if (type === 'kt_weekly') {
                title.textContent = "è¨­å‚™é»æª¢è¡¨(é€±) - é è¦½";
                content.innerHTML = '<div class="text-center py-4">æ­£åœ¨ç”¢ç”Ÿå ±è¡¨...</div>';
                
                const filteredHistory = checkHistory.filter(h => { 
                    const d = h.checkTimestamp?.toDate(); 
                    return d >= start && d <= end; 
                });

                let devices = Object.values(equipmentDatabase).sort((a,b) => (a.category||'').localeCompare(b.category||''));
                
                if (category !== 'ALL') {
                    devices = devices.filter(eq => (eq.category || 'æœªåˆ†é¡') === category);
                }

                devices = devices.filter(eq => eq.includeInKtReport === true);

                if (devices.length === 0) {
                    content.innerHTML = '<div class="text-center py-4 text-gray-500">æ­¤ç¯„åœç„¡è¨­å‚™è³‡æ–™ï¼Œæˆ–è¨­å‚™æœªå‹¾é¸ã€Œåˆ—å°æ–¼å»£æ³°é€±é»æª¢è¡¨ã€ã€‚</div>';
                    return;
                }

                // Prepare Data for Footer
                const supervisorName = document.getElementById('report-supervisor').value || '';
                
                // Calculate Last Working Day
                // start is 1st of month.
                // Find last day of month
                const year = start.getFullYear();
                const month = start.getMonth(); // 0-based
                const lastDayOfMonth = new Date(year, month + 1, 0); // Day 0 of next month is last day of current
                
                // Adjust for weekend
                let signDate = new Date(lastDayOfMonth);
                const dayOfWeek = signDate.getDay(); // 0=Sun, 6=Sat
                if (dayOfWeek === 0) { // Sunday
                    signDate.setDate(signDate.getDate() - 2); // Friday
                } else if (dayOfWeek === 6) { // Saturday
                    signDate.setDate(signDate.getDate() - 1); // Friday
                }
                
                const signYear = signDate.getFullYear();
                const signMonth = signDate.getMonth() + 1;
                const signDay = signDate.getDate();

                let reportHtml = '';

                devices.forEach(eq => {
                    const eqLogs = filteredHistory.filter(h => h.deviceId === eq.id);
                    const reportMonth = start.getMonth() + 1;
                    const reportYear = start.getFullYear();

                    const itemMatrix = {};
                    // Group Items by Category
                    // Structure: { "CategoryName": [ {text: "Item1", week1: "V", ...} ] }
                    const groupedItems = {};

                    if(eq.items) {
                        eq.items.forEach(cat => {
                            if (!groupedItems[cat.category]) groupedItems[cat.category] = [];
                            cat.subItems.forEach(sub => {
                                // Initialize
                                groupedItems[cat.category].push({
                                    text: sub.text,
                                    1: '', 2: '', 3: '', 4: '', 5: ''
                                });
                            });
                        });
                    }

                    const signatures = { 1: '', 2: '', 3: '', 4: '', 5: '' };
                    const dates = { 1: '', 2: '', 3: '', 4: '', 5: '' };

                    eqLogs.forEach(log => {
                        const d = log.checkTimestamp.toDate();
                        const day = d.getDate();
                        let week = 0;
                        if(day <= 7) week = 1;
                        else if(day <= 14) week = 2;
                        else if(day <= 21) week = 3;
                        else if(day <= 28) week = 4;
                        else week = 5;

                        dates[week] = `${d.getMonth()+1}/${d.getDate()}`;
                        signatures[week] = log.userName;

                        log.items.forEach(item => {
                            // Find item in groupedItems structure
                            // item.category matches key, item.text matches subitem text
                            if (groupedItems[item.category]) {
                                const found = groupedItems[item.category].find(i => i.text === item.text);
                                if (found) {
                                    const symbol = item.status === 'æ­£å¸¸' ? 'âœ“' : (item.status === 'ç•°å¸¸' ? 'X' : '/');
                                    found[week] = symbol;
                                }
                            }
                        });
                    });

                    // Build Table Rows
                    let tableRowsHtml = '';
                    const categories = Object.keys(groupedItems);
                    
                    // --- å›ºå®šè¡¨æ ¼é‚è¼¯ï¼šè¨ˆç®—ç¸½åˆ—æ•¸ ---
                    let currentRowCount = 0;
                    categories.forEach(cat => { currentRowCount += groupedItems[cat].length; });
                    const targetRowCount = 19; // Target rows reduced to 19 to prevent overflow
                    
                    if (categories.length === 0) {
                        tableRowsHtml = `<tr><td colspan="8">ç„¡è¨­å®šé»æª¢é …ç›®</td></tr>`;
                    } else {
                        categories.forEach(catName => {
                            const items = groupedItems[catName];
                            items.forEach((item, index) => {
                                tableRowsHtml += '<tr>';
                                // Category Column (with Rowspan)
                                if (index === 0) {
                                    tableRowsHtml += `<td rowspan="${items.length}" style="width: 15%; font-weight: bold;">${catName}</td>`;
                                }
                                // Item Column
                                tableRowsHtml += `<td style="text-align: left; padding-left: 10px;">${item.text}</td>`;
                                // Cycle Columns: Week (â—‹) and Month (Empty)
                                tableRowsHtml += `<td style="width: 2.5%; text-align: center;">â—‹</td>`; // é€±æ¬„ä½å¡«å…¥ç©ºå¿ƒåœ“åœˆ
                                tableRowsHtml += `<td style="width: 2.5%;"></td>`; // æœˆæ¬„ä½ç©ºç™½
                                // Week Columns
                                tableRowsHtml += `<td style="width: 8%;">${item[1]}</td>`;
                                tableRowsHtml += `<td style="width: 8%;">${item[2]}</td>`;
                                tableRowsHtml += `<td style="width: 8%;">${item[3]}</td>`;
                                tableRowsHtml += `<td style="width: 8%;">${item[4]}</td>`;
                                tableRowsHtml += `<td style="width: 8%;">${item[5]}</td>`;
                                tableRowsHtml += '</tr>';
                            });
                        });
                        
                        // --- å¡«å……ç©ºç™½åˆ— ---
                        if (currentRowCount < targetRowCount) {
                            const emptyRowsNeeded = targetRowCount - currentRowCount;
                            for (let i = 0; i < emptyRowsNeeded; i++) {
                                tableRowsHtml += `
                                <tr>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                    <td style="border: 1px solid black;">&nbsp;</td>
                                </tr>`;
                            }
                        }
                    }

                    // Report Layout Construction
                    reportHtml += `
                    <div class="page-break" style="padding: 20px; max-width: 210mm; margin: 0 auto;">
                        <div class="kt-header">
                            <div class="kt-logo-container">
                                <img src="https://www.kuangtai.com/wp-content/uploads/2024/05/logo1.png" class="kt-logo" alt="Kuang Tai Logo">
                                <div class="kt-logo-text">KUANG TAI</div>
                            </div>
                            <div class="kt-company-name">å»£æ³°é‡‘å±¬å·¥æ¥­(è‚¡)å…¬å¸</div>
                            <div class="kt-title-main">è¨­å‚™é»æª¢è¡¨(é€±)</div>
                        </div>

                        <table class="kt-info-table">
                            <tr>
                                <td style="width: 15%; font-weight: bold; text-align: center;">è¨­å‚™ç·¨è™Ÿ</td>
                                <td style="width: 25%; text-align: center;">${eq.assetNumber || eq.id}</td>
                                <td style="width: 15%; font-weight: bold; text-align: center;">è¨­å‚™åç¨±</td>
                                <td style="width: 25%; text-align: center;">${eq.name}</td>
                                <td style="width: 20%; text-align: center;">${reportYear} å¹´ ${reportMonth} æœˆ</td>
                            </tr>
                        </table>

                        <table class="kt-report-table">
                            <thead>
                                <tr>
                                    <th colspan="2" rowspan="2" style="width: 45%;">é»æª¢é …ç›®</th>
                                    <th colspan="2" style="width: 5%;">é€±æœŸ</th>
                                    <th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬ä¸€é€±<br><span style="font-size:9px">${dates[1]||'æœˆ æ—¥'}</span></th>
                                    <th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬äºŒé€±<br><span style="font-size:9px">${dates[2]||'æœˆ æ—¥'}</span></th>
                                    <th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬ä¸‰é€±<br><span style="font-size:9px">${dates[3]||'æœˆ æ—¥'}</span></th>
                                    <th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬å››é€±<br><span style="font-size:9px">${dates[4]||'æœˆ æ—¥'}</span></th>
                                    <th rowspan="2" style="width: 8%; font-size: 10px;">ç¬¬äº”é€±<br><span style="font-size:9px">${dates[5]||'æœˆ æ—¥'}</span></th>
                                </tr>
                                <tr>
                                    <th style="font-size: 12px; height: 15px;">é€±</th>
                                    <th style="font-size: 12px; height: 15px;">æœˆ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRowsHtml}
                                <tr style="height: 50px;">
                                    <td colspan="4">æª¢æŸ¥äººå“¡ç°½å</td>
                                    <td style="font-size: 75%;">${signatures[1]}</td>
                                    <td style="font-size: 75%;">${signatures[2]}</td>
                                    <td style="font-size: 75%;">${signatures[3]}</td>
                                    <td style="font-size: 75%;">${signatures[4]}</td>
                                    <td style="font-size: 75%;">${signatures[5]}</td>
                                </tr>
                                <tr style="height: 25px;">
                                    <td colspan="4">å‚™è¨»</td>
                                    <td colspan="5"></td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="kt-footer-notes">
                            <div>é™„è¨»ï¼š</div>
                            <ol style="padding-left: 20px; margin: 5px 0;">
                                <li>æœ¬è¡¨ç”±æ©Ÿå™¨(å„€å™¨)è¨­å‚™æ—©ç­æ“ä½œäººå“¡æ¯é€±ç¢ºå¯¦æª¢æŸ¥ï¼Œé»æª¢å¾Œæª¢æŸ¥äººå“¡é ˆç°½ç« ã€‚</li>
                                <li>æª¢æŸ¥çµæœæ­£å¸¸æ‰“âœ“ï¼Œä¸æ­£å¸¸æ‰“Xï¼Œä¸é©ç”¨é …ç›®æ‰“/ã€‚</li>
                                <li>ç™¼ç”Ÿä¸æ­£å¸¸æ‰“Xæ™‚ï¼Œé™¤äº†è¨˜éŒ„å¤–ï¼Œæª¢æŸ¥äººæ‡‰å‘èª²é•·å ±å‘Šï¼Œåœ¨èƒ½åŠ›æ¢ä»¶ä¸‹ï¼Œé€²è¡Œä¸€ç´šä¿é¤Šç¶­è­·ï¼Œç„¡æ³•è™•ç†æ™‚ç”³è«‹ç¶­ä¿®ã€‚</li>
                            </ol>
                        </div>

                        <div class="kt-sign-area" style="justify-content: flex-end; gap: 40px; padding-right: 20px;">
                            <div>ä¸»ç®¡ï¼š<span style="border-bottom: 1px solid black; padding: 0 10px; display: inline-block; min-width: 80px; text-align: center;">${supervisorName}</span></div>
                            <div>æ—¥æœŸï¼š<span style="border-bottom: 1px solid black; padding: 0 10px;">${signYear}</span>å¹´<span style="border-bottom: 1px solid black; padding: 0 10px;">${signMonth}</span>æœˆ<span style="border-bottom: 1px solid black; padding: 0 10px;">${signDay}</span>æ—¥</div>
                        </div>
                        <div class="kt-sign-area" style="margin-top: 5px; justify-content: space-between;">
                            <div>è¡¨å–®ç·¨è™Ÿï¼š0023-02-01</div>
                            <div>å­˜æ”¾åœ°é»ï¼šå„è¨­å‚™ä½¿ç”¨å–®ä½</div>
                            <div>ä¿å­˜æœŸé™ï¼šä¸‰å¹´</div>
                        </div>
                    </div>
                    `;
                });
                
                content.innerHTML = reportHtml;
            } else {
                // ... (Other report types remain unchanged) ...
                let html = '<table style="width:100%; border-collapse: collapse; font-size: 14px; text-align: left;">'; const thStyle = 'border: 1px solid #94a3b8; padding: 8px; background-color: #f1f5f9; font-weight: bold;'; const tdStyle = 'border: 1px solid #94a3b8; padding: 8px;';
                if (type === 'checklist') {
                    title.textContent = "è¨­å‚™é»æª¢ç´€éŒ„è¡¨";
                    html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é»æª¢äºº</th><th style="${thStyle}">çµæœ</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`;
                    
                    let filtered = checkHistory.filter(h => { const d = h.checkTimestamp?.toDate(); return d >= start && d <= end; });
                    
                    if (category !== 'ALL') {
                        filtered = filtered.filter(h => {
                            const eq = equipmentDatabase[h.deviceId];
                            const eqCat = eq ? (eq.category || 'æœªåˆ†é¡') : 'æœªåˆ†é¡';
                            return eqCat === category;
                        });
                    }

                    filtered.sort((a,b) => b.checkTimestamp.seconds - a.checkTimestamp.seconds);

                    if(filtered.length === 0) html += `<tr><td colspan="5" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`;
                    filtered.forEach(r => {
                        const date = r.checkTimestamp?.toDate().toLocaleString(); const abItems = r.items.filter(i => i.status === 'ç•°å¸¸'); const resultHtml = abItems.length > 0 ? `<span style="color:red; font-weight:bold;">ç•°å¸¸ (${abItems.length})</span><br><span style="font-size:12px; color:#64748b;">${abItems.map(i=>i.text).join(', ')}</span>` : '<span style="color:green;">æ­£å¸¸</span>';
                        html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${resultHtml}</td><td style="${tdStyle}">${r.summaryNotes || ''}</td></tr>`;
                    });
                } else if (type === 'maintenance') {
                    title.textContent = "è¨­å‚™ä¿é¤Š/ç¶­ä¿®ç´€éŒ„è¡¨";
                    html += `<thead><tr><th style="${thStyle}">æ—¥æœŸ</th><th style="${thStyle}">è¨­å‚™åç¨±</th><th style="${thStyle}">é¡å‹</th><th style="${thStyle}">é …ç›®</th><th style="${thStyle}">åŸ·è¡Œäºº</th><th style="${thStyle}">å‚™è¨»</th></tr></thead><tbody>`;
                    
                    let filtered = maintenanceHistory.filter(h => { const d = h.timestamp?.toDate(); return d >= start && d <= end; });
                    
                    if (category !== 'ALL') {
                        filtered = filtered.filter(h => {
                            const eq = equipmentDatabase[h.deviceId];
                            const eqCat = eq ? (eq.category || 'æœªåˆ†é¡') : 'æœªåˆ†é¡';
                            return eqCat === category;
                        });
                    }
                    
                    filtered.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

                    if(filtered.length === 0) html += `<tr><td colspan="6" style="${tdStyle} text-align:center;">ç„¡è³‡æ–™</td></tr>`;
                    filtered.forEach(r => {
                        const date = r.timestamp?.toDate().toLocaleString(); const typeStr = r.type === 'cleaning' ? 'æ¸…æ½”' : 'æ›´æ›';
                        html += `<tr><td style="${tdStyle}">${date}</td><td style="${tdStyle}">${r.deviceName}</td><td style="${tdStyle}">${typeStr}</td><td style="${tdStyle}">${r.componentName || '-'}</td><td style="${tdStyle}">${r.userName}</td><td style="${tdStyle}">${r.notes || ''}</td></tr>`;
                    });
                }
                html += '</tbody></table>'; content.innerHTML = html;
            }
        };

        // ... (remaining functions stay the same) ...
        window.app.logout = function() {
            loggedInUser = null;
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('admin-mode').classList.add('hidden');
            document.getElementById('user-mode').classList.remove('hidden');
            document.getElementById('toggle-mode-btn').textContent = "âš™ï¸ ç®¡ç†å¾Œå°";
        };

        function updateUIState() {
            document.getElementById('logged-in-view').classList.remove('hidden');
            document.getElementById('logged-in-name').textContent = loggedInUser.name;
            const roleBadge = document.getElementById('role-badge');
            const body = document.body;
            body.classList.remove('role-guest', 'role-operator', 'role-manager');
            body.classList.add(`role-${loggedInUser.role}`);
            let roleName = '';
            if (loggedInUser.role === 'manager') roleName = 'ç®¡ç†å“¡';
            else if (loggedInUser.role === 'operator') roleName = 'æ“ä½œå“¡';
            else roleName = 'è¨ªå®¢';
            roleBadge.textContent = roleName;
            roleBadge.className = `ml-2 px-2 py-0.5 rounded text-xs font-bold ${loggedInUser.role === 'manager' ? 'bg-purple-100 text-purple-800' : loggedInUser.role === 'operator' ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-600'}`;
            const guestWarning = document.querySelector('.guest-warning');
            if (loggedInUser.role === 'guest') {
                guestWarning.classList.remove('hidden');
                document.getElementById('toggle-mode-btn').classList.remove('hidden');
            } else {
                guestWarning.classList.add('hidden');
                if (loggedInUser.role === 'operator') { document.getElementById('toggle-mode-btn').classList.add('hidden'); } else { document.getElementById('toggle-mode-btn').classList.remove('hidden'); }
            }
            document.getElementById('main-content').classList.remove('hidden');
            populateManualDropdown();
        }
        
        function populateManualDropdown() {
            const sel = document.getElementById('manual-category-select');
            const devSel = document.getElementById('manual-device-select');
            const btnStart = document.getElementById('manual-start-button');
            const btnMaint = document.getElementById('manual-maintenance-button');
            if (!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) return;
            const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))];
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">è«‹é¸æ“‡å¤§é¡...</option>';
            cats.forEach(c => sel.add(new Option(c, c)));
            if (currentVal && cats.includes(currentVal)) sel.value = currentVal;
            sel.onchange = () => {
                devSel.innerHTML = '<option value="">è«‹é¸æ“‡è¨­å‚™...</option>'; devSel.disabled = false;
                Object.values(equipmentDatabase).filter(e => (e.category || 'æœªåˆ†é¡') === sel.value).forEach(e => devSel.add(new Option(e.name, e.id)));
                btnStart.disabled = true; btnMaint.disabled = true;
            };
            devSel.onchange = () => {
                const hasValue = !!devSel.value; const isGuest = loggedInUser && loggedInUser.role === 'guest';
                btnStart.disabled = !hasValue || isGuest; btnMaint.disabled = !hasValue || isGuest;
            };
        }

        window.app.handleManualSelection = () => { const id = document.getElementById('manual-device-select').value; startChecklist(id); };
        window.app.handleManualMaintenance = () => { const id = document.getElementById('manual-device-select').value; window.app.showMaintenanceModal(id); };

        function startChecklist(id) {
            if (loggedInUser.role === 'guest') return showToast("è¨ªå®¢ç„¡æ³•åŸ·è¡Œé»æª¢", "error");
            const eq = equipmentDatabase[id]; if (!eq) return;
            currentCheckId = id;
            document.getElementById('main-content').classList.add('hidden'); document.getElementById('checklist-section').classList.remove('hidden');
            document.getElementById('device-name').textContent = eq.name; document.getElementById('device-asset-no').textContent = eq.assetNumber || 'ç„¡';
            document.getElementById('user-name-display').textContent = loggedInUser.name;
            
            // Set date to today and update week
            const today = new Date().toISOString().slice(0,10);
            const dateInput = document.getElementById('check-date-input');
            dateInput.value = today;
            window.app.updateWeekDisplay(today);

            const container = document.getElementById('checklist-items-container'); container.innerHTML = '';
            if (eq.items) {
                eq.items.forEach(cat => {
                    const group = document.createElement('div'); group.innerHTML = `<h3 class="font-bold text-lg mb-2 text-slate-600 border-b pb-1">${cat.category}</h3>`;
                    cat.subItems.forEach(item => {
                        group.innerHTML += `<div class="card p-4 mb-3 item-row" data-cat="${cat.category}" data-text="${item.text}"><div class="flex justify-between items-center"><span class="text-slate-800 font-medium">${item.text}</span><div class="space-x-1 flex-shrink-0"><button onclick="window.app.setStatus(this, 'normal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">æ­£å¸¸</button><button onclick="window.app.setStatus(this, 'abnormal')" class="status-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-100">ç•°å¸¸</button></div></div><input type="text" class="abnormal-input hidden w-full mt-2 p-2 border rounded text-sm bg-red-50 text-red-700 placeholder-red-300" placeholder="è«‹èªªæ˜ç•°å¸¸åŸå› ..."></div>`;
                    }); container.appendChild(group);
                });
            }
        }

        window.app.setStatus = function(btn, status) {
            const row = btn.closest('.item-row');
            row.querySelectorAll('.status-btn').forEach(b => { b.classList.remove('selected', 'selected-normal', 'selected-abnormal', 'bg-green-500', 'bg-red-500', 'text-white'); });
            btn.classList.add('selected');
            if(status === 'normal') btn.classList.add('selected-normal', 'bg-green-500', 'text-white'); else btn.classList.add('selected-abnormal', 'bg-red-500', 'text-white');
            const input = row.querySelector('.abnormal-input'); if(status === 'abnormal') input.classList.remove('hidden'); else input.classList.add('hidden');
            row.dataset.status = status;
        };

        window.app.submitChecklist = async function(btn) {
            if (loggedInUser.role === 'guest') return;
            btn.disabled = true; btn.innerText = "æäº¤ä¸­...";
            try {
                // Get selected date
                const dateStr = document.getElementById('check-date-input').value;
                const selectedDate = new Date(dateStr);
                // Add current time to preserve submission hour, or set to noon if strict date based
                // Here we keep current hour/min to avoid timezone shift causing previous day
                const now = new Date();
                selectedDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

                const rows = document.querySelectorAll('.item-row'); const items = [];
                rows.forEach(r => { items.push({ category: r.dataset.cat, text: r.dataset.text, status: r.dataset.status === 'abnormal' ? 'ç•°å¸¸' : 'æ­£å¸¸', details: r.querySelector('.abnormal-input').value }); });
                
                const record = { 
                    deviceId: currentCheckId, 
                    deviceName: equipmentDatabase[currentCheckId].name, 
                    userId: loggedInUser.id, 
                    userName: loggedInUser.name, 
                    checkTimestamp: Timestamp.fromDate(selectedDate), // Use selected date for history 
                    createdTimestamp: serverTimestamp(), // Keep track of actual creation time
                    summaryNotes: document.getElementById('summary-notes').value, 
                    items: items 
                };
                
                await setDoc(doc(getCollectionRef("check_history")), record);
                
                // Only update "Next Check Date" if the submitted date is TODAY or FUTURE
                // If backfilling old records, we probably shouldn't mess up the schedule for next week
                const isBackfill = selectedDate < new Date(new Date().setHours(0,0,0,0));
                
                if (!isBackfill) {
                    const cycle = parseInt(equipmentDatabase[currentCheckId].checkCycleDays) || 7; 
                    const nextDate = new Date(); 
                    nextDate.setDate(nextDate.getDate() + cycle);
                    await updateDoc(getDocRef("equipment", currentCheckId), { nextCheckDate: nextDate.toISOString().slice(0,10) });
                }

                showToast('æäº¤æˆåŠŸ', 'success'); window.app.resetApp();
            } catch (e) { console.error(e); showToast('æäº¤å¤±æ•—: ' + e.message, 'error'); } finally { btn.disabled = false; btn.innerText = "æäº¤"; }
        };

        window.app.resetApp = function() { document.getElementById('checklist-section').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); currentCheckId = null; };

        window.app.toggleManagementMode = function() {
            const userMode = document.getElementById('user-mode'); const adminMode = document.getElementById('admin-mode'); const btn = document.getElementById('toggle-mode-btn');
            if (loggedInUser.role === 'operator') { return showToast("æ¬Šé™ä¸è¶³ï¼šåƒ…ç®¡ç†å“¡å¯é€²å…¥ç®¡ç†å¾Œå°", "error"); }
            if (userMode.classList.contains('hidden')) { userMode.classList.remove('hidden'); adminMode.classList.add('hidden'); btn.textContent = "âš™ï¸ ç®¡ç†å¾Œå°"; } 
            else { userMode.classList.add('hidden'); adminMode.classList.remove('hidden'); btn.textContent = "â¬…ï¸ è¿”å›é»æª¢"; window.app.renderEquipmentList(); }
        };

        window.app.switchAdminTab = function(tab) {
            document.querySelectorAll('[id^=admin-tab-content]').forEach(d => d.classList.add('hidden'));
            document.getElementById(`admin-tab-content-${tab}`).classList.remove('hidden');
            document.querySelectorAll('#admin-mode nav button').forEach(b => b.classList.remove('admin-tab-active', 'text-indigo-600'));
            document.getElementById(`tab-${tab}`).classList.add('admin-tab-active');
            if(tab === 'users') window.app.renderUserList();
            if(tab === 'equipment') window.app.renderEquipmentList();
            if(tab === 'templates') window.app.renderTemplateList();
            
            if(tab === 'checklistHistory') window.app.renderChecklistHistory('ALL');
            if(tab === 'maintenanceHistory') window.app.renderMaintenanceHistory('ALL');
        };

        // --- NEW FUNCTIONS FOR HISTORY TAB ---
        window.app.renderChecklistHistory = function(filter = 'ALL') {
            const container = document.getElementById('checklist-history-log-container');
            if(!container) return;
            
            let filtered = checkHistory.sort((a,b) => (b.checkTimestamp?.seconds || 0) - (a.checkTimestamp?.seconds || 0));
            if(filter !== 'ALL') {
                filtered = filtered.filter(h => h.deviceId === filter);
            }

            let html = `
                <div class="mb-4">
                    <label class="text-sm font-bold text-gray-700">ç¯©é¸è¨­å‚™: </label>
                    <select id="check-filter-select" onchange="window.app.renderChecklistHistory(this.value)" class="border rounded p-1">
                        <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
                        ${Object.values(equipmentDatabase).map(e => `<option value="${e.id}" ${filter===e.id?'selected':''}>${e.name}</option>`).join('')}
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-4 border-b">æ—¥æœŸ</th>
                                <th class="py-2 px-4 border-b">è¨­å‚™</th>
                                <th class="py-2 px-4 border-b">äººå“¡</th>
                                <th class="py-2 px-4 border-b">ç‹€æ…‹</th>
                                <th class="py-2 px-4 border-b">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if(filtered.length === 0) {
                html += `<tr><td colspan="5" class="text-center py-4 text-gray-500">ç„¡ç´€éŒ„</td></tr>`;
            } else {
                filtered.forEach(h => {
                    const date = h.checkTimestamp?.toDate().toLocaleString() || 'N/A';
                    const isAbnormal = h.items.some(i => i.status === 'ç•°å¸¸');
                    const statusBadge = isAbnormal 
                        ? `<span class="bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded">ç•°å¸¸</span>` 
                        : `<span class="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded">æ­£å¸¸</span>`;
                        
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b text-sm">${date}</td>
                            <td class="py-2 px-4 border-b text-sm">${h.deviceName}</td>
                            <td class="py-2 px-4 border-b text-sm">${h.userName}</td>
                            <td class="py-2 px-4 border-b">${statusBadge}</td>
                            <td class="py-2 px-4 border-b text-sm">
                                <button onclick="window.app.deleteCheckHistory('${h.id}')" class="text-red-500 hover:text-red-700">åˆªé™¤</button>
                            </td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        };

        window.app.renderMaintenanceHistory = function(filter = 'ALL') {
             const container = document.getElementById('maintenance-history-log-container');
             if(!container) return;
             
             let filtered = maintenanceHistory.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
             if(filter !== 'ALL') {
                 filtered = filtered.filter(h => h.deviceId === filter);
             }
             
             let html = `
                <div class="mb-4">
                    <label class="text-sm font-bold text-gray-700">ç¯©é¸è¨­å‚™: </label>
                    <select id="maint-filter-select" onchange="window.app.renderMaintenanceHistory(this.value)" class="border rounded p-1">
                        <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
                        ${Object.values(equipmentDatabase).map(e => `<option value="${e.id}" ${filter===e.id?'selected':''}>${e.name}</option>`).join('')}
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                         <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-4 border-b">æ—¥æœŸ</th>
                                <th class="py-2 px-4 border-b">è¨­å‚™</th>
                                <th class="py-2 px-4 border-b">é¡å‹</th>
                                <th class="py-2 px-4 border-b">å…§å®¹</th>
                                <th class="py-2 px-4 border-b">äººå“¡</th>
                                <th class="py-2 px-4 border-b">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
             `;
             
             if(filtered.length === 0) {
                 html += `<tr><td colspan="6" class="text-center py-4 text-gray-500">ç„¡ç´€éŒ„</td></tr>`;
             } else {
                 filtered.forEach(h => {
                     const date = h.timestamp?.toDate().toLocaleString() || 'N/A';
                     const typeStr = h.type === 'cleaning' ? 'æ¸…æ½”' : 'æ›´æ›é›¶ä»¶';
                     const content = h.type === 'replacement' ? h.componentName : h.notes;
                     
                     html += `
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 border-b text-sm">${date}</td>
                            <td class="py-2 px-4 border-b text-sm">${h.deviceName}</td>
                            <td class="py-2 px-4 border-b text-sm">${typeStr}</td>
                            <td class="py-2 px-4 border-b text-sm truncate max-w-xs" title="${content}">${content}</td>
                            <td class="py-2 px-4 border-b text-sm">${h.userName}</td>
                            <td class="py-2 px-4 border-b text-sm">
                                <button onclick="window.app.deleteMaintenanceHistory('${h.id}')" class="text-red-500 hover:text-red-700">åˆªé™¤</button>
                            </td>
                        </tr>
                     `;
                 });
             }
             html += `</tbody></table></div>`;
             container.innerHTML = html;
        };

        window.app.deleteCheckHistory = async function(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é»æª¢ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                try {
                    await deleteDoc(getDocRef("check_history", id));
                    showToast('åˆªé™¤æˆåŠŸ', 'success');
                } catch(e) {
                    console.error(e);
                    showToast('åˆªé™¤å¤±æ•—', 'error');
                }
            }
        };

        window.app.deleteMaintenanceHistory = async function(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ä¿é¤Šç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                try {
                    await deleteDoc(getDocRef("maintenance_history", id));
                    showToast('åˆªé™¤æˆåŠŸ', 'success');
                } catch(e) {
                    console.error(e);
                    showToast('åˆªé™¤å¤±æ•—', 'error');
                }
            }
        };

        window.app.renderEquipmentList = function() {
            const tabsContainer = document.getElementById('equipment-category-tabs');
            const listContainer = document.getElementById('equipment-list-container');
            
            if(!equipmentDatabase || Object.keys(equipmentDatabase).length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-400 py-4">ç„¡è³‡æ–™</p>'; 
                tabsContainer.innerHTML = ''; 
                return;
            }

            const groups = {};
            Object.values(equipmentDatabase).forEach(eq => {
                const cat = eq.category || 'æœªåˆ†é¡';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(eq);
            });
            const categories = Object.keys(groups).sort((a, b) => a.localeCompare(b, 'zh-TW'));

            let selectHtml = `
                <div class="flex items-center bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                    <label class="mr-3 font-bold text-slate-700 flex items-center whitespace-nowrap">
                        <svg class="w-4 h-4 mr-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        åˆ†é¡åˆ‡æ›:
                    </label>
                    <select id="eq-category-select" onchange="window.app.filterEquipmentCategory(this.value)" class="form-select w-full p-2 border border-gray-300 rounded text-slate-700 font-medium focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                        <option value="ALL">ğŸ“‹ å…¨éƒ¨é¡¯ç¤º (${Object.keys(equipmentDatabase).length} å°)</option>
            `;
            
            categories.forEach(cat => {
                selectHtml += `<option value="${cat}">${cat} (${groups[cat].length})</option>`;
            });
            selectHtml += `</select></div>`;
            
            tabsContainer.innerHTML = selectHtml; 

            let listHtml = '';
            categories.forEach((cat) => {
                listHtml += `<div id="cat-content-${cat}" class="eq-category-group space-y-3 mb-6">`;
                
                listHtml += `<h3 class="font-bold text-slate-500 text-sm border-b pb-1 mb-2 mt-4">${cat}</h3>`;
                
                groups[cat].forEach(eq => {
                    const imgUrl = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡';
                    let statusClass = 'active'; 
                    if(eq.status==='ç¶­ä¿®ä¸­') statusClass='repair'; 
                    else if(eq.status==='æœªä½¿ç”¨') statusClass='unused';
                    
                    listHtml += `
                    <div class="card p-4 flex flex-col sm:flex-row items-center gap-4 hover:shadow-md transition-shadow">
                        <img src="${imgUrl}" class="w-24 h-24 object-cover rounded-md border flex-shrink-0 cursor-pointer" onclick="window.open('${imgUrl}')">
                        <div class="flex-grow text-center sm:text-left w-full">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center justify-center sm:justify-start">
                                <span class="status-dot ${statusClass}"></span>${eq.name}
                            </h3>
                            <div class="text-sm text-slate-500 mt-1 space-y-1">
                                <p>ğŸ†” ID: <span class="font-mono text-slate-700">${eq.id}</span></p>
                                <p>ğŸ“ åœ°é»: ${eq.location || 'æœªè¨­å®š'}</p>
                            </div>
                            <div class="flex items-center gap-2 mt-2 text-xs text-gray-400 justify-center sm:justify-start">
                                <span class="bg-slate-100 px-2 py-1 rounded">ä¸‹æ¬¡é»æª¢: ${eq.nextCheckDate || 'æœªè¨­å®š'}</span>
                                <span class="bg-slate-100 px-2 py-1 rounded">ä¸‹æ¬¡æ¸…æ½”: ${eq.nextCleaningDate || 'æœªè¨­å®š'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto mt-2 sm:mt-0">
                            <button onclick="window.app.showQRCode('${eq.id}', '${eq.name}')" class="bg-white border border-green-500 text-green-600 text-sm font-bold px-3 py-2 rounded hover:bg-green-50 transition-colors flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>QR</button>
                            <button onclick="window.app.showMaintenanceModal('${eq.id}')" class="bg-orange-100 text-orange-600 border border-orange-200 text-sm font-bold px-3 py-2 rounded hover:bg-orange-200 transition-colors action-edit">ä¿é¤Š</button>
                            <button onclick="window.app.showEditor('${eq.id}')" class="bg-blue-100 text-blue-600 border border-blue-200 text-sm font-bold px-3 py-2 rounded hover:bg-blue-200 transition-colors action-edit">ç·¨è¼¯</button>
                            <button onclick="window.app.deleteEquipment('${eq.id}')" class="bg-red-100 text-red-600 border border-red-200 text-sm font-bold px-3 py-2 rounded hover:bg-red-200 transition-colors action-delete">åˆªé™¤</button>
                        </div>
                    </div>`;
                });
                listHtml += '</div>';
            });
            listContainer.innerHTML = listHtml;
        };

        window.app.filterEquipmentCategory = function(selectedCat) {
            const allGroups = document.querySelectorAll('.eq-category-group');
            allGroups.forEach(group => {
                if (selectedCat === 'ALL') {
                    group.classList.remove('hidden');
                } else {
                    if (group.id === `cat-content-${selectedCat}`) {
                        group.classList.remove('hidden');
                    } else {
                        group.classList.add('hidden');
                    }
                }
            });
        };

        window.app.deleteEquipment = async function(id) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¨­å‚™ï¼Ÿ')) await deleteDoc(getDocRef("equipment", id));
        };
        
        window.app.showQRCode = function(id, name) {
            currentQrId = id; const container = document.getElementById('qr-code-container'); container.innerHTML = '';
            document.getElementById('qr-display-name').textContent = name;
            document.getElementById('qr-code-display-modal').classList.remove('hidden'); document.getElementById('qr-display-content').classList.remove('hidden');
            const baseUrl = "https://saniltw.github.io/welddata/5.html"; const qrData = `${baseUrl}?id=${id}`; const hiddenDiv = document.createElement('div');
            new QRCode(hiddenDiv, { text: qrData, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.H });
            const checkQrImage = setInterval(() => { const qrImg = hiddenDiv.querySelector('img'); if (qrImg && qrImg.src) { clearInterval(checkQrImage); const imgObj = new Image(); imgObj.onload = () => window.app.drawCompositeQRCode(imgObj, name, container); imgObj.src = qrImg.src; } else { const qrCanvas = hiddenDiv.querySelector('canvas'); if(qrCanvas) { clearInterval(checkQrImage); window.app.drawCompositeQRCode(qrCanvas, name, container); } } }, 50);
        };
        window.app.drawCompositeQRCode = function(sourceImage, text, container) { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const padding = 20; const qrSize = 200; const textBoxHeight = 50; const width = qrSize + (padding * 2); const height = qrSize + (padding * 2) + textBoxHeight; canvas.width = width; canvas.height = height; ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, width, height); ctx.drawImage(sourceImage, padding, padding, qrSize, qrSize); ctx.fillStyle = '#000000'; ctx.font = 'bold 18px "Noto Sans TC", sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; let fontSize = 18; do { ctx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`; fontSize -= 1; } while (ctx.measureText(text).width > width - 20 && fontSize > 10); ctx.fillText(text, width / 2, height - (textBoxHeight / 2) - 5); ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.strokeRect(0, 0, width, height); canvas.style.maxWidth = '100%'; canvas.style.height = 'auto'; container.appendChild(canvas); };
        window.app.downloadQRCode = function() { const container = document.getElementById('qr-code-container'); const canvas = container.querySelector('canvas'); if(canvas) { const link = document.createElement('a'); const deviceName = document.getElementById('qr-display-name').textContent || 'device'; link.download = `QR-${deviceName}.png`; link.href = canvas.toDataURL("image/png"); document.body.appendChild(link); link.click(); document.body.removeChild(link); } else { showToast("QR Code å°šæœªç”¢ç”Ÿ", "error"); } };
        window.app.showMaintenanceModal = function(id) { if (loggedInUser.role === 'guest') return showToast("è¨ªå®¢æ¬Šé™ä¸è¶³", "error"); currentMaintEqId = id; document.getElementById('maint-device-name').textContent = equipmentDatabase[id].name; const compSelect = document.getElementById('maintenance-component-name'); compSelect.innerHTML = ''; document.getElementById('maintenance-notes').value = ''; document.getElementById('maint-image-preview').src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; document.getElementById('maint-image-preview').removeAttribute('data-image-data-url'); document.getElementById('maint-image-upload').value = ''; const comps = equipmentDatabase[id].components || []; if(comps.length > 0) comps.forEach(c => compSelect.add(new Option(c.name, c.name))); else compSelect.add(new Option('ç„¡é›¶ä»¶è³‡æ–™', '')); window.app.toggleMaintType(); document.getElementById('maintenance-modal').classList.remove('hidden'); };
        window.app.toggleMaintType = function() { const type = document.getElementById('maintenance-type').value; const selector = document.getElementById('maintenance-component-selector'); if(type === 'replacement') selector.classList.remove('hidden'); else selector.classList.add('hidden'); };
        window.app.closeMaintenanceModal = function() { document.getElementById('maintenance-modal').classList.add('hidden'); };
        window.app.handleMaintImageUpload = function(input) { if(!input.files[0]) return; const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); const preview = document.getElementById('maint-image-preview'); preview.src = dataUrl; preview.dataset.imageDataUrl = dataUrl; }; img.src = e.target.result; }; reader.readAsDataURL(file); };
        window.app.logMaintenance = async function(btn) { if(!currentMaintEqId) return; btn.disabled = true; const type = document.getElementById('maintenance-type').value; const notes = document.getElementById('maintenance-notes').value; const componentName = type === 'replacement' ? document.getElementById('maintenance-component-name').value : null; const imageUrl = document.getElementById('maint-image-preview').dataset.imageDataUrl || null; try { const record = { deviceId: currentMaintEqId, deviceName: equipmentDatabase[currentMaintEqId].name, userId: loggedInUser.id, userName: loggedInUser.name, timestamp: serverTimestamp(), type, notes, componentName, imageUrl }; await setDoc(doc(getCollectionRef("maintenance_history")), record); const updates = {}; if(type === 'cleaning') { const nextClean = new Date(); nextClean.setDate(nextClean.getDate() + 30); updates.nextCleaningDate = nextClean.toISOString().slice(0,10); } await updateDoc(getDocRef("equipment", currentMaintEqId), updates); showToast("ä¿é¤Šç´€éŒ„å·²å„²å­˜", "success"); window.app.closeMaintenanceModal(); } catch(e) { console.error(e); showToast("å„²å­˜å¤±æ•—", "error"); } finally { btn.disabled = false; } };
        window.app.handleImageUpload = function(input) { if(!input.files[0]) return; const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width; canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); const dataUrl = canvas.toDataURL('image/jpeg', 0.7); const preview = document.getElementById('image-preview'); preview.src = dataUrl; preview.dataset.imageDataUrl = dataUrl; }; img.src = e.target.result; }; reader.readAsDataURL(file); };
        window.app.showEditor = function(id = null) { document.getElementById('equipment-list-section').classList.add('hidden'); document.getElementById('equipment-editor-section').classList.remove('hidden'); document.getElementById('item-editor-container').innerHTML = ''; document.getElementById('component-editor-container').innerHTML = ''; const sel = document.getElementById('edit-device-category-select'); const cats = [...new Set(Object.values(equipmentDatabase).map(e => e.category || 'æœªåˆ†é¡'))]; sel.innerHTML = '<option value="__new__">ï¼‹ æ–°å¢åˆ†é¡</option>'; cats.forEach(c => sel.add(new Option(c, c))); const imgPreview = document.getElementById('image-preview'); document.getElementById('edit-device-image').value = ''; const userContainer = document.getElementById('user-assignment-container'); userContainer.innerHTML = ''; Object.values(userDatabase).forEach(u => { userContainer.innerHTML += `<label class="flex items-center space-x-2 text-sm p-1"><input type="checkbox" class="auth-user-cb rounded" value="${u.id}"><span class="text-gray-700">${u.name}</span></label>`; }); if(id) { const eq = equipmentDatabase[id]; document.getElementById('edit-device-id').value = eq.id; document.getElementById('edit-device-name').value = eq.name; document.getElementById('edit-device-location').value = eq.location || ''; document.getElementById('edit-device-asset').value = eq.assetNumber || ''; document.getElementById('edit-device-status').value = eq.status || 'ä½¿ç”¨ä¸­'; document.getElementById('edit-device-cycle').value = eq.checkCycleDays || ''; document.getElementById('edit-device-next-date').value = eq.nextCheckDate || ''; document.getElementById('edit-device-include-kt').checked = eq.includeInKtReport || false; if(eq.category) sel.value = eq.category; if(eq.items) eq.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container')); if(eq.components) eq.components.forEach(c => window.app.addComponentEditor(c)); if(Array.isArray(eq.authorizedUsers)) { eq.authorizedUsers.forEach(uid => { const cb = userContainer.querySelector(`input[value="${uid}"]`); if(cb) cb.checked = true; }); } imgPreview.src = eq.imageUrl || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; imgPreview.dataset.imageDataUrl = eq.imageUrl || ''; } else { ['edit-device-id', 'edit-device-name', 'edit-device-location', 'edit-device-asset', 'edit-device-cycle', 'edit-device-next-date'].forEach(k=>document.getElementById(k).value=''); document.getElementById('edit-device-include-kt').checked = false; imgPreview.src = 'https://placehold.co/100x100/e2e8f0/94a3b8?text=ç„¡åœ–ç‰‡'; imgPreview.dataset.imageDataUrl = ''; } };
        window.app.addCategoryEditor = function(data = null, containerId = 'item-editor-container') { const container = document.getElementById(containerId); const div = document.createElement('div'); div.className = 'editor-item border p-3 rounded bg-slate-50 mb-2'; div.innerHTML = `<div class="flex justify-between mb-2"><input type="text" class="cat-name p-1 border rounded w-1/2 font-bold" value="${data?.category || ''}" placeholder="åˆ†é¡åç¨± (å¦‚: å¤–è§€)"><button onclick="this.closest('.editor-item').remove()" class="text-red-500 text-xs">åˆªé™¤</button></div><textarea class="sub-items w-full p-2 border rounded text-sm h-20" placeholder="é …ç›® (ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚: ç•°éŸ³, æ¼æ²¹)">${data?.subItems?.map(s => s.text).join(',') || ''}</textarea>`; container.appendChild(div); };
        window.app.addComponentEditor = function(data = null) { const container = document.getElementById('component-editor-container'); const div = document.createElement('div'); div.className = 'component-item border p-2 rounded bg-white mb-2 flex space-x-2 items-center'; div.innerHTML = `<input type="text" class="comp-name w-1/2 p-1 border rounded text-sm" value="${data?.name || ''}" placeholder="é›¶ä»¶åç¨±"><input type="number" class="comp-cycle w-1/4 p-1 border rounded text-sm" value="${data?.cycle || ''}" placeholder="é€±æœŸ(å¤©)"><button onclick="this.closest('.component-item').remove()" class="text-red-500 text-xs px-2">âœ•</button>`; container.appendChild(div); };
        window.app.saveEquipment = async function() { const id = document.getElementById('edit-device-id').value; const name = document.getElementById('edit-device-name').value; const catSelect = document.getElementById('edit-device-category-select'); const cat = catSelect.value === '__new__' ? (document.getElementById('edit-device-category-new').value || 'æœªåˆ†é¡') : catSelect.value; const items = []; document.querySelectorAll('#item-editor-container .editor-item').forEach(el => { const cName = el.querySelector('.cat-name').value; const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text); if(cName) items.push({ category: cName, subItems: subs }); }); const components = []; document.querySelectorAll('#component-editor-container .component-item').forEach(el => { const cName = el.querySelector('.comp-name').value; const cCycle = el.querySelector('.comp-cycle').value; if(cName) components.push({ name: cName, cycle: cCycle }); }); const authorizedUsers = []; document.querySelectorAll('.auth-user-cb:checked').forEach(cb => authorizedUsers.push(cb.value)); const imgPreview = document.getElementById('image-preview'); const includeInKtReport = document.getElementById('edit-device-include-kt').checked; const data = { name, category: cat, items, components, authorizedUsers, includeInKtReport, imageUrl: imgPreview.dataset.imageDataUrl || null, location: document.getElementById('edit-device-location').value, assetNumber: document.getElementById('edit-device-asset').value, status: document.getElementById('edit-device-status').value, checkCycleDays: parseInt(document.getElementById('edit-device-cycle').value) || 0, nextCheckDate: document.getElementById('edit-device-next-date').value }; await setDoc(getDocRef("equipment", id), data, { merge: true }); showToast('å„²å­˜æˆåŠŸ', 'success'); window.app.showList(); };
        window.app.showList = function() { document.getElementById('equipment-list-section').classList.remove('hidden'); document.getElementById('equipment-editor-section').classList.add('hidden'); };
        window.app.renderTemplateList = function() { const container = document.getElementById('template-list-container'); container.innerHTML = ''; if(Object.keys(templateDatabase).length === 0) { container.innerHTML = '<p class="text-center text-gray-400">å°šç„¡ç¯„æœ¬</p>'; return; } Object.values(templateDatabase).forEach(t => { container.innerHTML += `<div class="card p-4 flex justify-between items-center"><span class="font-bold">${t.name}</span><div class="flex gap-2"><button onclick="window.app.showTemplateEditor('${t.id}')" class="text-blue-600 text-sm border px-2 py-1 rounded">ç·¨è¼¯</button><button onclick="window.app.deleteTemplate('${t.id}')" class="text-red-600 text-sm border px-2 py-1 rounded">åˆªé™¤</button></div></div>`; }); };
        window.app.showTemplateEditor = function(id = null) { document.getElementById('template-list-section').classList.add('hidden'); document.getElementById('template-editor-section').classList.remove('hidden'); document.getElementById('template-item-editor-container').innerHTML = ''; if(id) { const t = templateDatabase[id]; document.getElementById('edit-template-id').value = t.id; document.getElementById('edit-template-name').value = t.name; if(t.items) t.items.forEach(i => window.app.addCategoryEditor(i, 'template-item-editor-container')); } else { document.getElementById('edit-template-id').value = ''; document.getElementById('edit-template-name').value = ''; } };
        window.app.showTemplateList = function() { document.getElementById('template-list-section').classList.remove('hidden'); document.getElementById('template-editor-section').classList.add('hidden'); };
        window.app.saveTemplate = async function() { const id = document.getElementById('edit-template-id').value || doc(getCollectionRef("checklist_templates")).id; const name = document.getElementById('edit-template-name').value; if(!name) return showToast("è«‹è¼¸å…¥ç¯„æœ¬åç¨±", "error"); const items = []; document.querySelectorAll('#template-item-editor-container .editor-item').forEach(el => { const cName = el.querySelector('.cat-name').value; const subs = el.querySelector('.sub-items').value.split(',').map(s => ({ text: s.trim() })).filter(s => s.text); if(cName) items.push({ category: cName, subItems: subs }); }); await setDoc(getDocRef("checklist_templates", id), { name, items }); showToast("ç¯„æœ¬å·²å„²å­˜", "success"); window.app.showTemplateList(); };
        window.app.deleteTemplate = async function(id) { if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç¯„æœ¬ï¼Ÿ')) await deleteDoc(getDocRef("checklist_templates", id)); };
        window.app.showTemplateModal = function() { const container = document.getElementById('template-selection-container'); container.innerHTML = ''; if(Object.keys(templateDatabase).length === 0) { container.innerHTML = '<p class="text-center text-gray-400">ç„¡å¯ç”¨ç¯„æœ¬</p>'; } else { Object.values(templateDatabase).forEach(t => { container.innerHTML += `<button onclick="window.app.applyTemplate('${t.id}')" class="w-full text-left p-3 border rounded hover:bg-indigo-50 mb-2">${t.name}</button>`; }); } document.getElementById('template-modal').classList.remove('hidden'); document.getElementById('template-modal').classList.add('flex'); };
        window.app.closeTemplateModal = function() { document.getElementById('template-modal').classList.add('hidden'); document.getElementById('template-modal').classList.remove('flex'); };
        window.app.applyTemplate = function(id) { const t = templateDatabase[id]; if(t && t.items) { document.getElementById('item-editor-container').innerHTML = ''; t.items.forEach(i => window.app.addCategoryEditor(i, 'item-editor-container')); showToast(`å·²å¥—ç”¨ç¯„æœ¬ï¼š${t.name}`, "success"); } window.app.closeTemplateModal(); };
        window.app.renderUserList = function() { const c = document.getElementById('user-list-container'); c.innerHTML = ''; Object.values(userDatabase).forEach(u => { c.innerHTML += `<div class="card p-3 flex justify-between items-center mb-2"><div><span class="font-bold">${u.name}</span> <span class="text-xs text-gray-500">(${u.role})</span></div><div class="space-x-2"><button onclick="window.app.showUserEditor('${u.id}')" class="text-blue-600 text-sm">ç·¨è¼¯</button><button onclick="window.app.deleteUser('${u.id}')" class="text-red-600 text-sm">åˆªé™¤</button></div></div>`; }); };
        window.app.showUserEditor = (id = null) => { document.getElementById('user-list-container').classList.add('hidden'); document.getElementById('user-editor-section').classList.remove('hidden'); const roleSelect = document.getElementById('edit-user-role'); roleSelect.onchange = (e) => { document.getElementById('edit-user-password').classList.toggle('hidden', e.target.value !== 'manager'); }; if (id && userDatabase[id]) { const user = userDatabase[id]; document.getElementById('edit-user-id').value = id; document.getElementById('edit-user-id').disabled = true; document.getElementById('edit-user-name').value = user.name; roleSelect.value = user.role; } else { document.getElementById('edit-user-id').value = ''; document.getElementById('edit-user-id').disabled = false; document.getElementById('edit-user-name').value = ''; } };
        window.app.saveUser = async function() { const id = document.getElementById('edit-user-id').value; const data = { name: document.getElementById('edit-user-name').value, role: document.getElementById('edit-user-role').value }; if(data.role === 'manager') data.password = document.getElementById('edit-user-password').value; await setDoc(getDocRef("users", id), data, { merge: true }); window.app.showUserList(); };
        window.app.showUserList = function() { document.getElementById('user-list-container').classList.remove('hidden'); document.getElementById('user-editor-section').classList.add('hidden'); };
        window.app.deleteUser = async (id) => { if(confirm('åˆªé™¤?')) await deleteDoc(getDocRef("users", id)); };

        init();
    </script>
</body>
</html>